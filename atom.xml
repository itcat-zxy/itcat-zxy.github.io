<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>JONIğŸ¥</title>
  <icon>https://www.gravatar.com/avatar/11593203cc8bec868408e23e73b18a0f</icon>
  <subtitle>ç”Ÿæ´»æ˜æœ— ä¸‡ç‰©å¯çˆ±</subtitle>
  <link href="https://www.jodio.cc/atom.xml" rel="self"/>
  
  <link href="https://www.jodio.cc/"/>
  <updated>2023-04-21T02:16:29.126Z</updated>
  <id>https://www.jodio.cc/</id>
  
  <author>
    <name>JOğŸ¥</name>
    <email>2642322081@qq.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>JavaScript åŸºç¡€(ä¸€)</title>
    <link href="https://www.jodio.cc/posts/javaScript.html"/>
    <id>https://www.jodio.cc/posts/javaScript.html</id>
    <published>2023-04-21T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JavaScript-åŸºç¡€ï¼ˆä¸€ï¼‰"><a href="#JavaScript-åŸºç¡€ï¼ˆä¸€ï¼‰" class="headerlink" title="JavaScript åŸºç¡€ï¼ˆä¸€ï¼‰"></a>JavaScript åŸºç¡€ï¼ˆä¸€ï¼‰</h1><blockquote><p>äº†è§£å˜é‡ã€æ•°æ®ç±»å‹ã€è¿ç®—ç¬¦ç­‰åŸºç¡€æ¦‚å¿µï¼Œèƒ½å¤Ÿå®ç°æ•°æ®ç±»å‹çš„è½¬æ¢ï¼Œç»“åˆå››åˆ™è¿ç®—ä½“ä¼šå¦‚ä½•ç¼–ç¨‹ã€‚</p></blockquote><ul><li>ä½“ä¼šç°å®ä¸–ç•Œä¸­çš„äº‹ç‰©ä¸è®¡ç®—æœºçš„å…³ç³»</li><li>ç†è§£ä»€ä¹ˆæ˜¯æ•°æ®å¹¶çŸ¥é“æ•°æ®çš„åˆ†ç±»</li><li>ç†è§£å˜é‡å­˜å‚¨æ•°æ®çš„â€œå®¹å™¨â€</li><li>æŒæ¡å¸¸è§è¿ç®—ç¬¦çš„ä½¿ç”¨ï¼Œäº†è§£ä¼˜å…ˆçº§å…³ç³»</li><li>çŸ¥é“ JavaScript æ•°æ®ç±»å‹éšå¼è½¬æ¢çš„ç‰¹å¾</li></ul><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><blockquote><p>æŒæ¡ JavaScript çš„å¼•å…¥æ–¹å¼ï¼Œåˆæ­¥è®¤è¯† JavaScript çš„ä½œç”¨</p></blockquote><h3 id="å¼•å…¥æ–¹å¼"><a href="#å¼•å…¥æ–¹å¼" class="headerlink" title="å¼•å…¥æ–¹å¼"></a>å¼•å…¥æ–¹å¼</h3><p>JavaScript ç¨‹åºä¸èƒ½ç‹¬ç«‹è¿è¡Œï¼Œå®ƒéœ€è¦è¢«åµŒå…¥ HTML ä¸­ï¼Œç„¶åæµè§ˆå™¨æ‰èƒ½æ‰§è¡Œ JavaScript ä»£ç ã€‚é€šè¿‡ <code>script</code> æ ‡ç­¾å°† JavaScript ä»£ç å¼•å…¥åˆ° HTML ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><h4 id="å†…éƒ¨æ–¹å¼"><a href="#å†…éƒ¨æ–¹å¼" class="headerlink" title="å†…éƒ¨æ–¹å¼"></a>å†…éƒ¨æ–¹å¼</h4><p>é€šè¿‡ <code>script</code> æ ‡ç­¾åŒ…è£¹ JavaScript ä»£ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å¼•å…¥æ–¹å¼<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å†…è”å½¢å¼ï¼šé€šè¿‡ script æ ‡ç­¾åŒ…è£¹ JavaScript ä»£ç  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="string">&#x27;å—¨ï¼Œæ¬¢è¿æ¥ä¼ æ™ºæ’­å­¦ä¹ å‰ç«¯æŠ€æœ¯ï¼&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å¤–éƒ¨å½¢å¼"><a href="#å¤–éƒ¨å½¢å¼" class="headerlink" title="å¤–éƒ¨å½¢å¼"></a>å¤–éƒ¨å½¢å¼</h4><p>ä¸€èˆ¬å°† JavaScript ä»£ç å†™åœ¨ç‹¬ç«‹çš„ä»¥ .js ç»“å°¾çš„æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡ <code>script</code> æ ‡ç­¾çš„ <code>src</code> å±æ€§å¼•å…¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.js</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;å—¨ï¼Œæ¬¢è¿æ¥ä¼ æ™ºæ’­å­¦ä¹ å‰ç«¯æŠ€æœ¯ï¼&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å¼•å…¥æ–¹å¼<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å¤–éƒ¨å½¢å¼ï¼šé€šè¿‡ script çš„ src å±æ€§å¼•å…¥ç‹¬ç«‹çš„ .js æ–‡ä»¶ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;demo.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ script æ ‡ç­¾ä½¿ç”¨ src å±æ€§å¼•å…¥äº†æŸ .js æ–‡ä»¶ï¼Œé‚£ä¹ˆ æ ‡ç­¾çš„ä»£ç ä¼šè¢«å¿½ç•¥ï¼ï¼ï¼å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å¼•å…¥æ–¹å¼<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å¤–éƒ¨å½¢å¼ï¼šé€šè¿‡ script çš„ src å±æ€§å¼•å…¥ç‹¬ç«‹çš„ .js æ–‡ä»¶ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;demo.js&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// æ­¤å¤„çš„ä»£ç ä¼šè¢«å¿½ç•¥æ‰ï¼ï¼ï¼ï¼</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">alert</span>(<span class="number">666</span>);  </span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ³¨é‡Šå’Œç»“æŸç¬¦"><a href="#æ³¨é‡Šå’Œç»“æŸç¬¦" class="headerlink" title="æ³¨é‡Šå’Œç»“æŸç¬¦"></a>æ³¨é‡Šå’Œç»“æŸç¬¦</h3><p>é€šè¿‡æ³¨é‡Šå¯ä»¥å±è”½ä»£ç è¢«æ‰§è¡Œæˆ–è€…æ·»åŠ å¤‡æ³¨ä¿¡æ¯ï¼ŒJavaScript æ”¯æŒä¸¤ç§å½¢å¼æ³¨é‡Šè¯­æ³•ï¼š</p><h4 id="å•è¡Œæ³¨é‡Š"><a href="#å•è¡Œæ³¨é‡Š" class="headerlink" title="å•è¡Œæ³¨é‡Š"></a>å•è¡Œæ³¨é‡Š</h4><p>ä½¿ç”¨ <code>//</code> æ³¨é‡Šå•è¡Œä»£ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ³¨é‡Š<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// è¿™ç§æ˜¯å•è¡Œæ³¨é‡Šçš„è¯­æ³•</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ä¸€æ¬¡åªèƒ½æ³¨é‡Šä¸€è¡Œ</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å¯ä»¥é‡å¤æ³¨é‡Š</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;å—¨ï¼Œæ¬¢è¿æ¥ä¼ æ™ºæ’­å­¦ä¹ å‰ç«¯æŠ€æœ¯ï¼&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å¤šè¡Œæ³¨é‡Š"><a href="#å¤šè¡Œæ³¨é‡Š" class="headerlink" title="å¤šè¡Œæ³¨é‡Š"></a>å¤šè¡Œæ³¨é‡Š</h4><p>ä½¿ç”¨ <code>/* */</code> æ³¨é‡Šå¤šè¡Œä»£ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ³¨é‡Š<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* è¿™ç§çš„æ˜¯å¤šè¡Œæ³¨é‡Šçš„è¯­æ³• */</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    æ›´å¸¸è§çš„å¤šè¡Œæ³¨é‡Šæ˜¯è¿™ç§å†™æ³•</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    åœ¨äº›å¯ä»¥ä»»æ„æ¢è¡Œ</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    å¤šå°‘è¡Œéƒ½å¯ä»¥</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">      */</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;å—¨ï¼Œæ¬¢è¿æ¥ä¼ æ™ºæ’­å­¦ä¹ å‰ç«¯æŠ€æœ¯ï¼&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨ï¼šç¼–è¾‘å™¨ä¸­å•è¡Œæ³¨é‡Šçš„å¿«æ·é”®ä¸º <code>ctrl + /</code></strong></p><h3 id="ç»“æŸç¬¦"><a href="#ç»“æŸç¬¦" class="headerlink" title="ç»“æŸç¬¦"></a>ç»“æŸç¬¦</h3><p>åœ¨ JavaScript ä¸­ <code>;</code> ä»£è¡¨ä¸€æ®µä»£ç çš„ç»“æŸï¼Œå¤šæ•°æƒ…å†µä¸‹å¯ä»¥çœç•¥ <code>;</code> ä½¿ç”¨å›è½¦ï¼ˆenterï¼‰æ›¿ä»£ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - ç»“æŸç¬¦<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line">    alert(1);</span><br><span class="line">    alert(2);</span><br><span class="line">    alert(1)</span><br><span class="line">    alert(2)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®é™…å¼€å‘ä¸­æœ‰è®¸å¤šäººä¸»å¼ ä¹¦å†™ JavaScript ä»£ç æ—¶çœç•¥ç»“æŸç¬¦ <code>;</code></p><h3 id="è¾“å…¥å’Œè¾“å‡º"><a href="#è¾“å…¥å’Œè¾“å‡º" class="headerlink" title="è¾“å…¥å’Œè¾“å‡º"></a>è¾“å…¥å’Œè¾“å‡º</h3><p>è¾“å‡ºå’Œè¾“å…¥ä¹Ÿå¯ç†è§£ä¸ºäººå’Œè®¡ç®—æœºçš„äº¤äº’ï¼Œç”¨æˆ·é€šè¿‡é”®ç›˜ã€é¼ æ ‡ç­‰å‘è®¡ç®—æœºè¾“å…¥ä¿¡æ¯ï¼Œè®¡ç®—æœºå¤„ç†åå†å±•ç¤ºç»“æœç»™ç”¨æˆ·ï¼Œè¿™ä¾¿æ˜¯ä¸€æ¬¡è¾“å…¥å’Œè¾“å‡ºçš„è¿‡ç¨‹ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼šå¦‚æŒ‰é”®ç›˜ä¸Šçš„æ–¹å‘é”®ï¼Œå‘ä¸Š/ä¸‹é”®å¯ä»¥æ»šåŠ¨é¡µé¢ï¼ŒæŒ‰å‘ä¸Š/ä¸‹é”®è¿™ä¸ªåŠ¨ä½œå«ä½œè¾“å…¥ï¼Œé¡µé¢å‘ç”Ÿäº†æ»šåŠ¨äº†è¿™ä¾¿å«è¾“å‡ºã€‚</p><h4 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h4><p>JavaScript å¯ä»¥æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œç„¶åå†å°†è¾“å…¥çš„ç»“æœè¾“å‡ºï¼š</p><p><code>alert()</code>ã€<code>document.wirte()</code></p><p>ä»¥æ•°å­—ä¸ºä¾‹ï¼Œå‘ <code>alert()</code> æˆ– <code>document.write()</code>è¾“å…¥ä»»æ„æ•°å­—ï¼Œä»–éƒ½ä¼šä»¥å¼¹çª—å½¢å¼å±•ç¤ºï¼ˆè¾“å‡ºï¼‰ç»™ç”¨æˆ·ã€‚</p><h4 id="è¾“å…¥"><a href="#è¾“å…¥" class="headerlink" title="è¾“å…¥"></a>è¾“å…¥</h4><p>å‘ <code>prompt()</code> è¾“å…¥ä»»æ„å†…å®¹ä¼šä»¥å¼¹çª—å½¢å¼å‡ºç°åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸€èˆ¬æç¤ºç”¨æˆ·è¾“å…¥ä¸€äº›å†…å®¹ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - è¾“å…¥è¾“å‡º<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 1. è¾“å…¥çš„ä»»æ„æ•°å­—ï¼Œéƒ½ä¼šä»¥å¼¹çª—å½¢å¼å±•ç¤º</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;è¦è¾“å‡ºçš„å†…å®¹&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="string">&#x27;è¦è¾“å‡ºçš„å†…å®¹&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 2. ä»¥å¼¹çª—å½¢å¼æç¤ºç”¨æˆ·è¾“å…¥å§“åï¼Œæ³¨æ„è¿™é‡Œçš„æ–‡å­—ä½¿ç”¨è‹±æ–‡çš„å¼•å·</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥æ‚¨çš„å§“å:&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><blockquote><p>ç†è§£å˜é‡æ˜¯è®¡ç®—æœºå­˜å‚¨æ•°æ®çš„â€œå®¹å™¨â€ï¼ŒæŒæ¡å˜é‡çš„å£°æ˜æ–¹å¼</p></blockquote><p>å˜é‡æ˜¯è®¡ç®—æœºä¸­ç”¨æ¥å­˜å‚¨æ•°æ®çš„â€œå®¹å™¨â€ï¼Œå®ƒå¯ä»¥è®©è®¡ç®—æœºå˜å¾—æœ‰è®°å¿†ï¼Œé€šä¿—çš„ç†è§£å˜é‡å°±æ˜¯ä½¿ç”¨ã€æŸä¸ªç¬¦å·ã€‘æ¥ä»£è¡¨ã€æŸä¸ªå…·ä½“çš„æ•°å€¼ã€‘ï¼ˆæ•°æ®ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// x ç¬¦å·ä»£è¡¨äº† 5 è¿™ä¸ªæ•°å€¼</span></span></span><br><span class="line"><span class="language-javascript">  x = <span class="number">5</span></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// y ç¬¦å·ä»£è¡¨äº† 6 è¿™ä¸ªæ•°å€¼</span></span></span><br><span class="line"><span class="language-javascript">  y = <span class="number">6</span></span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">  <span class="comment">//ä¸¾ä¾‹ï¼š åœ¨ JavaScript ä¸­ä½¿ç”¨å˜é‡å¯ä»¥å°†æŸä¸ªæ•°æ®ï¼ˆæ•°å€¼ï¼‰è®°å½•ä¸‹æ¥ï¼</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¿å­˜åœ¨ num è¿™ä¸ªå˜é‡ï¼ˆå®¹å™¨ï¼‰ä¸­</span></span></span><br><span class="line"><span class="language-javascript">  num = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥ä¸€æ•°å­—!&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// é€šè¿‡ num å˜é‡ï¼ˆå®¹å™¨ï¼‰å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹è¾“å‡ºå‡ºæ¥</span></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">alert</span>(num)</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span>.<span class="title function_">write</span>(num)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h3><p>å£°æ˜(å®šä¹‰)å˜é‡æœ‰ä¸¤éƒ¨åˆ†æ„æˆï¼šå£°æ˜å…³é”®å­—ã€å˜é‡åï¼ˆæ ‡è¯†ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å£°æ˜å’Œèµ‹å€¼<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let å˜é‡å</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å£°æ˜(å®šä¹‰)å˜é‡æœ‰ä¸¤éƒ¨åˆ†æ„æˆï¼šå£°æ˜å…³é”®å­—ã€å˜é‡åï¼ˆæ ‡è¯†ï¼‰</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let å³å…³é”®å­—ï¼Œæ‰€è°“å…³é”®å­—æ˜¯ç³»ç»Ÿæä¾›çš„ä¸“é—¨ç”¨æ¥å£°æ˜ï¼ˆå®šä¹‰ï¼‰å˜é‡çš„è¯è¯­</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// age å³å˜é‡çš„åç§°ï¼Œä¹Ÿå«æ ‡è¯†ç¬¦</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> age</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…³é”®å­—æ˜¯ JavaScript ä¸­å†…ç½®çš„ä¸€äº›è‹±æ–‡è¯æ±‡ï¼ˆå•è¯æˆ–ç¼©å†™ï¼‰ï¼Œå®ƒä»¬ä»£è¡¨æŸäº›ç‰¹å®šçš„å«ä¹‰ï¼Œå¦‚ <code>let</code> çš„å«ä¹‰æ˜¯å£°æ˜å˜é‡çš„ï¼Œçœ‹åˆ° <code>let</code>  åå°±å¯æƒ³åˆ°è¿™è¡Œä»£ç çš„æ„æ€æ˜¯åœ¨å£°æ˜å˜é‡ï¼Œå¦‚ <code>let age;</code> </p><p><code>let</code> å’Œ <code>var</code> éƒ½æ˜¯ JavaScript ä¸­çš„å£°æ˜å˜é‡çš„å…³é”®å­—ï¼Œæ¨èä½¿ç”¨ <code>let</code> å£°æ˜å˜é‡ï¼ï¼ï¼</p><h3 id="èµ‹å€¼"><a href="#èµ‹å€¼" class="headerlink" title="èµ‹å€¼"></a>èµ‹å€¼</h3><p>å£°æ˜ï¼ˆå®šä¹‰ï¼‰å˜é‡ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªç©ºçš„â€œå®¹å™¨â€ï¼Œé€šè¿‡èµ‹å€¼å‘è¿™ä¸ªå®¹å™¨ä¸­æ·»åŠ æ•°æ®ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å£°æ˜å’Œèµ‹å€¼<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å£°æ˜(å®šä¹‰)å˜é‡æœ‰ä¸¤éƒ¨åˆ†æ„æˆï¼šå£°æ˜å…³é”®å­—ã€å˜é‡åï¼ˆæ ‡è¯†ï¼‰</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let å³å…³é”®å­—ï¼Œæ‰€è°“å…³é”®å­—æ˜¯ç³»ç»Ÿæä¾›çš„ä¸“é—¨ç”¨æ¥å£°æ˜ï¼ˆå®šä¹‰ï¼‰å˜é‡çš„è¯è¯­</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// age å³å˜é‡çš„åç§°ï¼Œä¹Ÿå«æ ‡è¯†ç¬¦</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> age</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// èµ‹å€¼ï¼Œå°† 18 è¿™ä¸ªæ•°æ®å­˜å…¥äº† age è¿™ä¸ªâ€œå®¹å™¨â€ä¸­</span></span></span><br><span class="line"><span class="language-javascript">    age = <span class="number">18</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// è¿™æ · age çš„å€¼å°±æˆäº† 18</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(age)</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ä¹Ÿå¯ä»¥å£°æ˜å’Œèµ‹å€¼åŒæ—¶è¿›è¡Œ</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> str = <span class="string">&#x27;hello world!&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(str);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h3><p>JavaScript ä½¿ç”¨ä¸“é—¨çš„å…³é”®å­— <code>let</code> å’Œ <code>var</code> æ¥å£°æ˜ï¼ˆå®šä¹‰ï¼‰å˜é‡ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ä¸€äº›ç»†èŠ‚ï¼š</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>let</code> æ—¶çš„æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>å…è®¸å£°æ˜å’Œèµ‹å€¼åŒæ—¶è¿›è¡Œ</li><li>ä¸å…è®¸é‡å¤å£°æ˜</li><li>å…è®¸åŒæ—¶å£°æ˜å¤šä¸ªå˜é‡å¹¶èµ‹å€¼</li><li>JavaScript ä¸­å†…ç½®çš„ä¸€äº›å…³é”®å­—ä¸èƒ½è¢«å½“åšå˜é‡å</li></ol><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>var</code> æ—¶çš„æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>å…è®¸å£°æ˜å’Œèµ‹å€¼åŒæ—¶è¿›è¡Œ</li><li>å…è®¸é‡å¤å£°æ˜</li><li>å…è®¸åŒæ—¶å£°æ˜å¤šä¸ªå˜é‡å¹¶èµ‹å€¼</li></ol><p>å¤§éƒ¨åˆ†æƒ…å†µä½¿ç”¨ <code>let</code> å’Œ <code>var</code> åŒºåˆ«ä¸å¤§ï¼Œä½†æ˜¯ <code>let</code> ç›¸è¾ƒ <code>var</code> æ›´ä¸¥è°¨ï¼Œå› æ­¤æ¨èä½¿ç”¨ <code>let</code>ï¼ŒåæœŸä¼šæ›´è¿›ä¸€æ­¥ä»‹ç»äºŒè€…é—´çš„åŒºåˆ«ã€‚</p><h3 id="å˜é‡åå‘½åè§„åˆ™"><a href="#å˜é‡åå‘½åè§„åˆ™" class="headerlink" title="å˜é‡åå‘½åè§„åˆ™"></a>å˜é‡åå‘½åè§„åˆ™</h3><p>å…³äºå˜é‡çš„åç§°ï¼ˆæ ‡è¯†ç¬¦ï¼‰æœ‰ä¸€ç³»åˆ—çš„è§„åˆ™éœ€è¦éµå®ˆï¼š</p><ol><li>åªèƒ½æ˜¯å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€$ï¼Œä¸”ä¸èƒ½èƒ½æ•°å­—å¼€å¤´</li><li>å­—æ¯åŒºåˆ†å¤§å°å†™ï¼Œå¦‚ Age å’Œ age æ˜¯ä¸åŒçš„å˜é‡</li><li>JavaScript å†…éƒ¨å·²å ç”¨äºå•è¯ï¼ˆå…³é”®å­—æˆ–ä¿ç•™å­—ï¼‰ä¸å…è®¸ä½¿ç”¨</li><li>å°½é‡ä¿è¯å˜é‡å…·æœ‰ä¸€å®šçš„è¯­ä¹‰ï¼Œè§å­—çŸ¥ä¹‰</li></ol><p>æ³¨ï¼šæ‰€è°“å…³é”®å­—æ˜¯æŒ‡ JavaScript å†…éƒ¨ä½¿ç”¨çš„è¯è¯­ï¼Œå¦‚ <code>let</code> å’Œ<code>var</code>ï¼Œä¿ç•™å­—æ˜¯æŒ‡ JavaScript å†…éƒ¨ç›®å‰æ²¡æœ‰ä½¿ç”¨çš„è¯è¯­ï¼Œä½†æ˜¯å°†æ¥å¯èƒ½ä¼šä½¿ç”¨è¯è¯­ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - å˜é‡åå‘½åè§„åˆ™<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> age = <span class="number">18</span> <span class="comment">// æ­£ç¡®</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> age1 = <span class="number">18</span> <span class="comment">// æ­£ç¡®</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> _age = <span class="number">18</span> <span class="comment">// æ­£ç¡®</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let 1age = 18; // é”™è¯¯ï¼Œä¸å¯ä»¥æ•°å­—å¼€å¤´</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> $age = <span class="number">18</span> <span class="comment">// æ­£ç¡®</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> <span class="title class_">Age</span> = <span class="number">24</span> <span class="comment">// æ­£ç¡®ï¼Œå®ƒä¸å°å†™çš„ age æ˜¯ä¸åŒçš„å˜é‡</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let let = 18; // é”™è¯¯ï¼Œlet æ˜¯å…³é”®å­—</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> int = <span class="number">123</span> <span class="comment">// ä¸æ¨èï¼Œint æ˜¯ä¿ç•™å­—</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h2><p>æ¦‚å¿µï¼šä½¿ç”¨ const å£°æ˜çš„å˜é‡ç§°ä¸ºâ€œå¸¸é‡â€ã€‚</p><p>ä½¿ç”¨åœºæ™¯ï¼šå½“æŸä¸ªå˜é‡æ°¸è¿œä¸ä¼šæ”¹å˜çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨ const æ¥å£°æ˜ï¼Œè€Œä¸æ˜¯letã€‚</p><p>å‘½åè§„èŒƒï¼šå’Œå˜é‡ä¸€è‡´</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PI</span> = <span class="number">3.14</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š å¸¸é‡ä¸å…è®¸é‡æ–°èµ‹å€¼,å£°æ˜çš„æ—¶å€™å¿…é¡»èµ‹å€¼ï¼ˆåˆå§‹åŒ–ï¼‰</p></blockquote><h2 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h2><blockquote><p>è®¡ç®—æœºä¸–ç•Œä¸­çš„ä¸‡äº‹æˆç‰©éƒ½æ˜¯æ•°æ®ã€‚</p></blockquote><p>è®¡ç®—æœºç¨‹åºå¯ä»¥å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æ•°æ®çš„ç®¡ç†ï¼Œå°†æ•°æ®åˆ†æˆäº†ä¸åŒçš„ç±»å‹ï¼š</p><p>æ³¨ï¼šé€šè¿‡ typeof å…³é”®å­—æ£€æµ‹æ•°æ®ç±»å‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ•°æ®ç±»å‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// æ£€æµ‹ 1 æ˜¯ä»€ä¹ˆç±»å‹æ•°æ®ï¼Œç»“æœä¸º number</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> <span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ•°å€¼ç±»å‹"><a href="#æ•°å€¼ç±»å‹" class="headerlink" title="æ•°å€¼ç±»å‹"></a>æ•°å€¼ç±»å‹</h3><p>å³æˆ‘ä»¬æ•°å­¦ä¸­å­¦ä¹ åˆ°çš„æ•°å­—ï¼Œå¯ä»¥æ˜¯æ•´æ•°ã€å°æ•°ã€æ­£æ•°ã€è´Ÿæ•°</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ•°æ®ç±»å‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> score = <span class="number">100</span> <span class="comment">// æ­£æ•´æ•°</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> price = <span class="number">12.345</span> <span class="comment">// å°æ•°</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> temperature = -<span class="number">40</span> <span class="comment">// è´Ÿæ•°</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> score) <span class="comment">// ç»“æœä¸º number</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> price) <span class="comment">// ç»“æœä¸º number</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> temperature) <span class="comment">// ç»“æœä¸º number</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>JavaScript ä¸­çš„æ•°å€¼ç±»å‹ä¸æ•°å­¦ä¸­çš„æ•°å­—æ˜¯ä¸€æ ·çš„ï¼Œåˆ†ä¸ºæ­£æ•°ã€è´Ÿæ•°ã€å°æ•°ç­‰ã€‚</p><h3 id="å­—ç¬¦ä¸²ç±»å‹"><a href="#å­—ç¬¦ä¸²ç±»å‹" class="headerlink" title="å­—ç¬¦ä¸²ç±»å‹"></a>å­—ç¬¦ä¸²ç±»å‹</h3><p>é€šè¿‡å•å¼•å·ï¼ˆ <code>&#39;&#39;</code>ï¼‰ ã€åŒå¼•å·ï¼ˆ <code>&quot;&quot;</code>ï¼‰æˆ–åå¼•å·åŒ…è£¹çš„æ•°æ®éƒ½å«å­—ç¬¦ä¸²ï¼Œå•å¼•å·å’ŒåŒå¼•å·æ²¡æœ‰æœ¬è´¨ä¸Šçš„åŒºåˆ«ï¼Œæ¨èä½¿ç”¨å•å¼•å·ã€‚</p><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>æ— è®ºå•å¼•å·æˆ–æ˜¯åŒå¼•å·å¿…é¡»æˆå¯¹ä½¿ç”¨</li><li>å•å¼•å·/åŒå¼•å·å¯ä»¥äº’ç›¸åµŒå¥—ï¼Œä½†æ˜¯ä¸ä»¥è‡ªå·²åµŒå¥—è‡ªå·²</li><li>å¿…è¦æ—¶å¯ä»¥ä½¿ç”¨è½¬ä¹‰ç¬¦ <code>\</code>ï¼Œè¾“å‡ºå•å¼•å·æˆ–åŒå¼•å·</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ•°æ®ç±»å‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> user_name = <span class="string">&#x27;å°æ˜&#x27;</span> <span class="comment">// ä½¿ç”¨å•å¼•å·</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> gender = <span class="string">&quot;ç”·&quot;</span> <span class="comment">// ä½¿ç”¨åŒå¼•å·</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> str = <span class="string">&#x27;123&#x27;</span> <span class="comment">// çœ‹ä¸Šå»æ˜¯æ•°å­—ï¼Œä½†æ˜¯ç”¨å¼•å·åŒ…è£¹äº†å°±æˆäº†å­—ç¬¦ä¸²äº†</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> str1 = <span class="string">&#x27;&#x27;</span> <span class="comment">// è¿™ç§æƒ…å†µå«ç©ºå­—ç¬¦ä¸²</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    documeent.<span class="title function_">write</span>(<span class="keyword">typeof</span> user_name) <span class="comment">// ç»“æœä¸º string</span></span></span><br><span class="line"><span class="language-javascript">    documeent.<span class="title function_">write</span>(<span class="keyword">typeof</span> gender) <span class="comment">// ç»“æœä¸º string</span></span></span><br><span class="line"><span class="language-javascript">    documeent.<span class="title function_">write</span>(<span class="keyword">typeof</span> str) <span class="comment">// ç»“æœä¸º string</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¸ƒå°”ç±»å‹"><a href="#å¸ƒå°”ç±»å‹" class="headerlink" title="å¸ƒå°”ç±»å‹"></a>å¸ƒå°”ç±»å‹</h3><p>è¡¨ç¤ºè‚¯å®šæˆ–å¦å®šæ—¶åœ¨è®¡ç®—æœºä¸­å¯¹åº”çš„æ˜¯å¸ƒå°”ç±»å‹æ•°æ®ï¼Œå®ƒæœ‰ä¸¤ä¸ªå›ºå®šçš„å€¼ <code>true</code> å’Œ <code>false</code>ï¼Œè¡¨ç¤ºè‚¯å®šçš„æ•°æ®ç”¨ <code>true</code>ï¼Œè¡¨ç¤ºå¦å®šçš„æ•°æ®ç”¨ <code>false</code>ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ•°æ®ç±»å‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  pinkè€å¸ˆå¸…ä¸å¸…ï¼Ÿå›ç­” æ˜¯ æˆ– å¦</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> isCool = <span class="literal">true</span> <span class="comment">// æ˜¯çš„ï¼Œæ‘”æ­»äº†ï¼</span></span></span><br><span class="line"><span class="language-javascript">    isCool = <span class="literal">false</span> <span class="comment">// ä¸ï¼Œå¥—é©¬æ†çš„æ±‰å­ï¼</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> isCool) <span class="comment">// ç»“æœä¸º boolean</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="undefined"><a href="#undefined" class="headerlink" title="undefined"></a>undefined</h3><p>æœªå®šä¹‰æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ï¼Œåªæœ‰ä¸€ä¸ªå€¼ undefinedï¼Œåªå£°æ˜å˜é‡ï¼Œä¸èµ‹å€¼çš„æƒ…å†µä¸‹ï¼Œå˜é‡çš„é»˜è®¤å€¼ä¸º undefinedï¼Œä¸€èˆ¬å¾ˆå°‘ã€ç›´æ¥ã€‘ä¸ºæŸä¸ªå˜é‡èµ‹å€¼ä¸º undefinedã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - æ•°æ®ç±»å‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// åªå£°æ˜äº†å˜é‡ï¼Œå¹¶æœ«èµ‹å€¼</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> tmp;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">typeof</span> tmp) <span class="comment">// ç»“æœä¸º undefined</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨ï¼šJavaScript ä¸­å˜é‡çš„å€¼å†³å®šäº†å˜é‡çš„æ•°æ®ç±»å‹ã€‚</strong></p><h2 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h2><blockquote><p>ç†è§£å¼±ç±»å‹è¯­è¨€çš„ç‰¹å¾ï¼ŒæŒæ¡æ˜¾å¼ç±»å‹è½¬æ¢çš„æ–¹æ³•</p></blockquote><p>åœ¨ JavaScript ä¸­æ•°æ®è¢«åˆ†æˆäº†ä¸åŒçš„ç±»å‹ï¼Œå¦‚æ•°å€¼ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€undefinedï¼Œåœ¨å®é™…ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸åŒæ•°æ®ç±»å‹ä¹‹é—´å­˜åœ¨ç€è½¬æ¢çš„å…³ç³»ã€‚</p><h3 id="éšå¼è½¬æ¢"><a href="#éšå¼è½¬æ¢" class="headerlink" title="éšå¼è½¬æ¢"></a>éšå¼è½¬æ¢</h3><p>æŸäº›è¿ç®—ç¬¦è¢«æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿå†…éƒ¨è‡ªåŠ¨å°†æ•°æ®ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œè¿™ç§è½¬æ¢ç§°ä¸ºéšå¼è½¬æ¢ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - éšå¼è½¬æ¢<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> num = <span class="number">13</span> <span class="comment">// æ•°å€¼</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> num2 = <span class="string">&#x27;2&#x27;</span> <span class="comment">// å­—ç¬¦ä¸²</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ç»“æœä¸º 132</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// åŸå› æ˜¯å°†æ•°å€¼ num è½¬æ¢æˆäº†å­—ç¬¦ä¸²ï¼Œç›¸å½“äº &#x27;13&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ç„¶å + å°†ä¸¤ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥åˆ°äº†ä¸€èµ·</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num + num2)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ç»“æœä¸º 11</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// åŸå› æ˜¯å°†å­—ç¬¦ä¸² num2 è½¬æ¢æˆäº†æ•°å€¼ï¼Œç›¸å½“äº 2</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ç„¶åæ•°å€¼ 13 å‡å» æ•°å€¼ 2</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num - num2)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> a = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥ä¸€ä¸ªæ•°å­—&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> b = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·å†è¾“å…¥ä¸€ä¸ªæ•°å­—&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(a + b);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨ï¼šæ•°æ®ç±»å‹çš„éšå¼è½¬æ¢æ˜¯ JavaScript çš„ç‰¹å¾ï¼Œåç»­å­¦ä¹ ä¸­è¿˜ä¼šé‡åˆ°ï¼Œç›®å‰å…ˆéœ€è¦ç†è§£ä»€ä¹ˆæ˜¯éšå¼è½¬æ¢ã€‚</p><p>è¡¥å……ä»‹ç»æ¨¡æ¿å­—ç¬¦ä¸²çš„æ‹¼æ¥çš„ä½¿ç”¨</p><h3 id="æ˜¾å¼è½¬æ¢"><a href="#æ˜¾å¼è½¬æ¢" class="headerlink" title="æ˜¾å¼è½¬æ¢"></a>æ˜¾å¼è½¬æ¢</h3><p>ç¼–å†™ç¨‹åºæ—¶è¿‡åº¦ä¾é ç³»ç»Ÿå†…éƒ¨çš„éšå¼è½¬æ¢æ˜¯ä¸ä¸¥ç¦çš„ï¼Œå› ä¸ºéšå¼è½¬æ¢è§„å¾‹å¹¶ä¸æ¸…æ™°ï¼Œå¤§å¤šæ˜¯é ç»éªŒæ€»ç»“çš„è§„å¾‹ã€‚ä¸ºäº†é¿å…å› éšå¼è½¬æ¢å¸¦æ¥çš„é—®é¢˜ï¼Œé€šå¸¸æ ¹é€»è¾‘éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ˜¾ç¤ºè½¬æ¢ã€‚</p><h4 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h4><p>é€šè¿‡ <code>Number</code> æ˜¾ç¤ºè½¬æ¢æˆæ•°å€¼ç±»å‹ï¼Œå½“è½¬æ¢å¤±è´¥æ—¶ç»“æœä¸º <code>NaN</code>ï¼ˆNot a Numberï¼‰å³ä¸æ˜¯ä¸€ä¸ªæ•°å­—ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScript åŸºç¡€ - éšå¼è½¬æ¢<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> t = <span class="string">&#x27;12&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> f = <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// æ˜¾å¼å°†å­—ç¬¦ä¸² 12 è½¬æ¢æˆæ•°å€¼ 12</span></span></span><br><span class="line"><span class="language-javascript">    t = <span class="title class_">Number</span>(t)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// æ£€æµ‹è½¬æ¢åçš„ç±»å‹</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// console.log(typeof t);</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(t + f) <span class="comment">// ç»“æœä¸º 20</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å¹¶ä¸æ˜¯æ‰€æœ‰çš„å€¼éƒ½å¯ä»¥è¢«è½¬æˆæ•°å€¼ç±»å‹</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> str = <span class="string">&#x27;hello&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// å°† hello è½¬æˆæ•°å€¼æ˜¯ä¸ç°å®çš„ï¼Œå½“æ— æ³•è½¬æ¢æˆ</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// æ•°å€¼æ—¶ï¼Œå¾—åˆ°çš„ç»“æœä¸º NaN ï¼ˆNot a Numberï¼‰</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(str))</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="JavaScript-åŸºç¡€ï¼ˆäºŒï¼‰"><a href="#JavaScript-åŸºç¡€ï¼ˆäºŒï¼‰" class="headerlink" title="JavaScript åŸºç¡€ï¼ˆäºŒï¼‰"></a>JavaScript åŸºç¡€ï¼ˆäºŒï¼‰</h1><blockquote><p>ç†è§£ä»€ä¹ˆæ˜¯æµç¨‹æ§åˆ¶ï¼ŒçŸ¥é“æ¡ä»¶æ§åˆ¶çš„ç§ç±»å¹¶æŒæ¡å…¶å¯¹åº”çš„è¯­æ³•è§„åˆ™ï¼Œå…·å¤‡åˆ©ç”¨å¾ªç¯ç¼–å†™ç®€æ˜“ATMå–æ¬¾æœºç¨‹åºèƒ½åŠ›</p></blockquote><ul><li>è¿ç®—ç¬¦</li><li>è¯­å¥</li><li>ç»¼åˆæ¡ˆä¾‹</li></ul><h2 id="è¿ç®—ç¬¦"><a href="#è¿ç®—ç¬¦" class="headerlink" title="è¿ç®—ç¬¦"></a>è¿ç®—ç¬¦</h2><h3 id="ç®—æœ¯è¿ç®—ç¬¦"><a href="#ç®—æœ¯è¿ç®—ç¬¦" class="headerlink" title="ç®—æœ¯è¿ç®—ç¬¦"></a>ç®—æœ¯è¿ç®—ç¬¦</h3><p>æ•°å­—æ˜¯ç”¨æ¥è®¡ç®—çš„ï¼Œæ¯”å¦‚ï¼šä¹˜æ³• * ã€é™¤æ³• / ã€åŠ æ³• + ã€å‡æ³• - ç­‰ç­‰ï¼Œæ‰€ä»¥ç»å¸¸å’Œç®—æœ¯è¿ç®—ç¬¦ä¸€èµ·ã€‚</p><p>ç®—æœ¯è¿ç®—ç¬¦ï¼šä¹Ÿå«æ•°å­¦è¿ç®—ç¬¦ï¼Œä¸»è¦åŒ…æ‹¬åŠ ã€å‡ã€ä¹˜ã€é™¤ã€å–ä½™ï¼ˆæ±‚æ¨¡ï¼‰ç­‰</p><div class="table-container"><table><thead><tr><th>è¿ç®—ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>+</td><td>æ±‚å’Œ</td></tr><tr><td>-</td><td>æ±‚å·®</td></tr><tr><td>*</td><td>æ±‚ç§¯</td></tr><tr><td>/</td><td>æ±‚å•†</td></tr><tr><td><strong>%</strong></td><td>å–æ¨¡ï¼ˆå–ä½™æ•°ï¼‰ï¼Œå¼€å‘ä¸­ç»å¸¸ç”¨äºä½œä¸ºæŸä¸ªæ•°å­—æ˜¯å¦è¢«æ•´é™¤</td></tr></tbody></table></div><blockquote><p>æ³¨æ„ï¼šåœ¨è®¡ç®—å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºçš„ç»“æœæ˜¯ NaN ï¼ˆnot a numberï¼‰</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®—æœ¯è¿ç®—ç¬¦</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span> / <span class="number">2</span>) <span class="comment">//  4 </span></span><br><span class="line"><span class="keyword">let</span> num = <span class="number">10</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num + <span class="number">10</span>)  <span class="comment">// 20</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num + num)  <span class="comment">// 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å–æ¨¡(å–ä½™æ•°)  ä½¿ç”¨åœºæ™¯ï¼š  ç”¨æ¥åˆ¤æ–­æŸä¸ªæ•°æ˜¯å¦èƒ½å¤Ÿè¢«æ•´é™¤</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span> % <span class="number">2</span>) <span class="comment">//  0  </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span> % <span class="number">3</span>) <span class="comment">//  0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span> % <span class="number">3</span>) <span class="comment">//  2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> % <span class="number">5</span>) <span class="comment">//  3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ³¨æ„äº‹é¡¹ : å¦‚æœæˆ‘ä»¬è®¡ç®—å¤±è´¥ï¼Œåˆ™è¿”å›çš„ç»“æœæ˜¯ NaN (not a number)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pinkè€å¸ˆ&#x27;</span> - <span class="number">2</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pinkè€å¸ˆ&#x27;</span> * <span class="number">2</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pinkè€å¸ˆ&#x27;</span> + <span class="number">2</span>)   <span class="comment">// pinkè€å¸ˆ2</span></span><br></pre></td></tr></table></figure><h3 id="èµ‹å€¼è¿ç®—ç¬¦"><a href="#èµ‹å€¼è¿ç®—ç¬¦" class="headerlink" title="èµ‹å€¼è¿ç®—ç¬¦"></a>èµ‹å€¼è¿ç®—ç¬¦</h3><p>èµ‹å€¼è¿ç®—ç¬¦ï¼šå¯¹å˜é‡è¿›è¡Œèµ‹å€¼çš„è¿ç®—ç¬¦</p><p> =     å°†ç­‰å·å³è¾¹çš„å€¼èµ‹äºˆç»™å·¦è¾¹, è¦æ±‚å·¦è¾¹å¿…é¡»æ˜¯ä¸€ä¸ªå®¹å™¨</p><div class="table-container"><table><thead><tr><th>è¿ç®—ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>+=</td><td>åŠ æ³•èµ‹å€¼</td></tr><tr><td>-+</td><td>å‡æ³•èµ‹å€¼</td></tr><tr><td>*=</td><td>ä¹˜æ³•èµ‹å€¼</td></tr><tr><td>/=</td><td>é™¤æ³•èµ‹å€¼</td></tr><tr><td>%=</td><td>å–ä½™èµ‹å€¼</td></tr></tbody></table></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">let</span> num = <span class="number">1</span></span><br><span class="line"><span class="comment">// num = num + 1</span></span><br><span class="line"><span class="comment">// é‡‡å–èµ‹å€¼è¿ç®—ç¬¦</span></span><br><span class="line"><span class="comment">// num += 1</span></span><br><span class="line">num += <span class="number">3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="è‡ªå¢-è‡ªå‡è¿ç®—ç¬¦"><a href="#è‡ªå¢-è‡ªå‡è¿ç®—ç¬¦" class="headerlink" title="è‡ªå¢/è‡ªå‡è¿ç®—ç¬¦"></a>è‡ªå¢/è‡ªå‡è¿ç®—ç¬¦</h3><div class="table-container"><table><thead><tr><th>ç¬¦å·</th><th>ä½œç”¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>++</td><td>è‡ªå¢</td><td>å˜é‡è‡ªèº«çš„å€¼åŠ 1ï¼Œä¾‹å¦‚: x++</td></tr><tr><td>â€”</td><td>è‡ªå‡</td><td>å˜é‡è‡ªèº«çš„å€¼å‡1ï¼Œä¾‹å¦‚: xâ€”</td></tr></tbody></table></div><ol><li>++åœ¨å‰å’Œ++åœ¨ååœ¨å•ç‹¬ä½¿ç”¨æ—¶äºŒè€…å¹¶æ²¡æœ‰å·®åˆ«ï¼Œè€Œä¸”ä¸€èˆ¬å¼€å‘ä¸­æˆ‘ä»¬éƒ½æ˜¯ç‹¬ç«‹ä½¿ç”¨</li><li>++åœ¨åï¼ˆåç¼€å¼ï¼‰æˆ‘ä»¬ä¼šä½¿ç”¨æ›´å¤š</li></ol><blockquote><p>æ³¨æ„ï¼š</p><ol><li>åªæœ‰å˜é‡èƒ½å¤Ÿä½¿ç”¨è‡ªå¢å’Œè‡ªå‡è¿ç®—ç¬¦</li><li>++ã€â€” å¯ä»¥åœ¨å˜é‡å‰é¢ä¹Ÿå¯ä»¥åœ¨å˜é‡åé¢ï¼Œæ¯”å¦‚: x++  æˆ–è€…  ++x </li></ol></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// let num = 10</span></span><br><span class="line">    <span class="comment">// num = num + 1</span></span><br><span class="line">    <span class="comment">// num += 1</span></span><br><span class="line">    <span class="comment">// // 1. å‰ç½®è‡ªå¢</span></span><br><span class="line">    <span class="comment">// let i = 1</span></span><br><span class="line">    <span class="comment">// ++i</span></span><br><span class="line">    <span class="comment">// console.log(i)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// let i = 1</span></span><br><span class="line">    <span class="comment">// console.log(++i + 1)</span></span><br><span class="line">    <span class="comment">// 2. åç½®è‡ªå¢</span></span><br><span class="line">    <span class="comment">// let i = 1</span></span><br><span class="line">    <span class="comment">// i++</span></span><br><span class="line">    <span class="comment">// console.log(i)</span></span><br><span class="line">    <span class="comment">// let i = 1</span></span><br><span class="line">    <span class="comment">// console.log(i++ + 1)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº†è§£ </span></span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">1</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i++ + ++i + i)</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="æ¯”è¾ƒè¿ç®—ç¬¦"><a href="#æ¯”è¾ƒè¿ç®—ç¬¦" class="headerlink" title="æ¯”è¾ƒè¿ç®—ç¬¦"></a>æ¯”è¾ƒè¿ç®—ç¬¦</h3><p>ä½¿ç”¨åœºæ™¯ï¼šæ¯”è¾ƒä¸¤ä¸ªæ•°æ®å¤§å°ã€æ˜¯å¦ç›¸ç­‰ï¼Œæ ¹æ®æ¯”è¾ƒç»“æœè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆtrue / falseï¼‰</p><div class="table-container"><table><thead><tr><th>è¿ç®—ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>&gt;</td><td>å·¦è¾¹æ˜¯å¦å¤§äºå³è¾¹</td></tr><tr><td>&lt;</td><td>å·¦è¾¹æ˜¯å¦å°äºå³è¾¹</td></tr><tr><td>&gt;=</td><td>å·¦è¾¹æ˜¯å¦å¤§äºæˆ–ç­‰äºå³è¾¹</td></tr><tr><td>&lt;=</td><td>å·¦è¾¹æ˜¯å¦å°äºæˆ–ç­‰äºå³è¾¹</td></tr><tr><td>===</td><td>å·¦å³ä¸¤è¾¹æ˜¯å¦<code>ç±»å‹</code>å’Œ<code>å€¼</code>éƒ½ç›¸ç­‰ï¼ˆé‡ç‚¹ï¼‰</td></tr><tr><td>==</td><td>å·¦å³ä¸¤è¾¹<code>å€¼</code>æ˜¯å¦ç›¸ç­‰</td></tr><tr><td>!=</td><td>å·¦å³å€¼ä¸ç›¸ç­‰</td></tr><tr><td>!==</td><td>å·¦å³ä¸¤è¾¹æ˜¯å¦ä¸å…¨ç­‰</td></tr></tbody></table></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> &gt; <span class="number">5</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> &gt;= <span class="number">3</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> == <span class="number">2</span>)</span><br><span class="line">  <span class="comment">// æ¯”è¾ƒè¿ç®—ç¬¦æœ‰éšå¼è½¬æ¢ æŠŠ&#x27;2&#x27; è½¬æ¢ä¸º 2  åŒç­‰å· åªåˆ¤æ–­å€¼</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> == <span class="string">&#x27;2&#x27;</span>)  <span class="comment">// true</span></span><br><span class="line">  <span class="comment">// console.log(undefined === null)</span></span><br><span class="line">  <span class="comment">// === å…¨ç­‰ åˆ¤æ–­ å€¼ å’Œ æ•°æ®ç±»å‹éƒ½ä¸€æ ·æ‰è¡Œ</span></span><br><span class="line">  <span class="comment">// ä»¥ååˆ¤æ–­æ˜¯å¦ç›¸ç­‰ è¯·ç”¨ ===  </span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> === <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> === <span class="title class_">NaN</span>) <span class="comment">// NaN ä¸ç­‰äºä»»ä½•äººï¼ŒåŒ…æ‹¬ä»–è‡ªå·±</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> !== <span class="string">&#x27;2&#x27;</span>)  <span class="comment">// true  </span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> != <span class="string">&#x27;2&#x27;</span>) <span class="comment">// false </span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-------------------------&#x27;</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a&#x27;</span> &lt; <span class="string">&#x27;b&#x27;</span>) <span class="comment">// true</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;aa&#x27;</span> &lt; <span class="string">&#x27;ab&#x27;</span>) <span class="comment">// true</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;aa&#x27;</span> &lt; <span class="string">&#x27;aac&#x27;</span>) <span class="comment">// true</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-------------------------&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="é€»è¾‘è¿ç®—ç¬¦"><a href="#é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå¯ä»¥æŠŠå¤šä¸ªå¸ƒå°”å€¼æ”¾åˆ°ä¸€èµ·è¿ç®—ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼</p><div class="table-container"><table><thead><tr><th>ç¬¦å·</th><th>åç§°</th><th>æ—¥å¸¸è¯»æ³•</th><th>ç‰¹ç‚¹</th><th>å£è¯€</th></tr></thead><tbody><tr><td>&amp;&amp;</td><td>é€»è¾‘ä¸</td><td>å¹¶ä¸”</td><td>ç¬¦å·ä¸¤è¾¹æœ‰ä¸€ä¸ªå‡çš„ç»“æœä¸ºå‡</td><td>ä¸€å‡åˆ™å‡</td></tr><tr><td>\</td><td>\</td><td></td><td>é€»è¾‘æˆ–</td><td>æˆ–è€…</td><td>ç¬¦å·ä¸¤è¾¹æœ‰ä¸€ä¸ªçœŸçš„ç»“æœä¸ºçœŸ</td><td>ä¸€çœŸåˆ™çœŸ</td></tr><tr><td>!</td><td>é€»è¾‘é</td><td>å–å</td><td>trueå˜false  falseå˜true</td><td>çœŸå˜å‡ï¼Œå‡å˜çœŸ</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th>A</th><th>B</th><th>A &amp;&amp; B</th><th>A \</th><th>\</th><th>B</th><th>!A</th></tr></thead><tbody><tr><td>false</td><td>false</td><td>false</td><td>false</td><td>true</td></tr><tr><td>false</td><td>true</td><td>false</td><td>true</td><td>true</td></tr><tr><td>true</td><td>false</td><td>false</td><td>true</td><td>false</td></tr><tr><td>true</td><td>true</td><td>true</td><td>true</td><td>false</td></tr></tbody></table></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// é€»è¾‘ä¸ ä¸€å‡åˆ™å‡</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">true</span> &amp;&amp; <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> &amp;&amp; <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> &lt; <span class="number">5</span> &amp;&amp; <span class="number">3</span> &gt; <span class="number">2</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> &lt; <span class="number">5</span> &amp;&amp; <span class="number">3</span> &lt; <span class="number">2</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----------------&#x27;</span>)</span><br><span class="line">    <span class="comment">// é€»è¾‘æˆ– ä¸€çœŸåˆ™çœŸ</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">true</span> || <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> || <span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> || <span class="literal">false</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----------------&#x27;</span>)</span><br><span class="line">    <span class="comment">// é€»è¾‘é  å–å</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(!<span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(!<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> num = <span class="number">6</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num &gt; <span class="number">5</span> &amp;&amp; num &lt; <span class="number">10</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----------------&#x27;</span>)</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="è¿ç®—ç¬¦ä¼˜å…ˆçº§"><a href="#è¿ç®—ç¬¦ä¼˜å…ˆçº§" class="headerlink" title="è¿ç®—ç¬¦ä¼˜å…ˆçº§"></a>è¿ç®—ç¬¦ä¼˜å…ˆçº§</h3><p> <img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/javaScript/1671016521031.png" alt=""></p><blockquote><p>é€»è¾‘è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼š ï¼&gt; &amp;&amp; &gt;  ||  </p></blockquote><h2 id="è¯­å¥"><a href="#è¯­å¥" class="headerlink" title="è¯­å¥"></a>è¯­å¥</h2><h3 id="è¡¨è¾¾å¼å’Œè¯­å¥"><a href="#è¡¨è¾¾å¼å’Œè¯­å¥" class="headerlink" title="è¡¨è¾¾å¼å’Œè¯­å¥"></a>è¡¨è¾¾å¼å’Œè¯­å¥</h3><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/javaScript/1671017924981.png" alt=""></p><h3 id="åˆ†æ”¯è¯­å¥"><a href="#åˆ†æ”¯è¯­å¥" class="headerlink" title="åˆ†æ”¯è¯­å¥"></a>åˆ†æ”¯è¯­å¥</h3><p>åˆ†æ”¯è¯­å¥å¯ä»¥æ ¹æ®æ¡ä»¶åˆ¤å®šçœŸå‡ï¼Œæ¥é€‰æ‹©æ€§çš„æ‰§è¡Œæƒ³è¦çš„ä»£ç </p><p>åˆ†æ”¯è¯­å¥åŒ…å«ï¼š</p><ol><li>ifåˆ†æ”¯è¯­å¥ï¼ˆé‡ç‚¹ï¼‰</li><li>ä¸‰å…ƒè¿ç®—ç¬¦</li><li>switchè¯­å¥</li></ol><h4 id="if-åˆ†æ”¯è¯­å¥"><a href="#if-åˆ†æ”¯è¯­å¥" class="headerlink" title="if åˆ†æ”¯è¯­å¥"></a>if åˆ†æ”¯è¯­å¥</h4><p>è¯­æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(æ¡ä»¶è¡¨è¾¾å¼) &#123;</span><br><span class="line">  <span class="comment">// æ»¡è¶³æ¡ä»¶è¦æ‰§è¡Œçš„è¯­å¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°æ‹¬å·å†…çš„æ¡ä»¶ç»“æœæ˜¯å¸ƒå°”å€¼ï¼Œä¸º true æ—¶ï¼Œè¿›å…¥å¤§æ‹¬å·é‡Œæ‰§è¡Œä»£ç ï¼›ä¸ºfalseï¼Œåˆ™ä¸æ‰§è¡Œå¤§æ‹¬å·é‡Œé¢ä»£ç </p><p>å°æ‹¬å·å†…çš„ç»“æœè‹¥ä¸æ˜¯å¸ƒå°”ç±»å‹æ—¶ï¼Œä¼šå‘ç”Ÿç±»å‹è½¬æ¢ä¸ºå¸ƒå°”å€¼ï¼Œç±»ä¼¼Boolean()</p><p>å¦‚æœå¤§æ‹¬å·åªæœ‰ä¸€ä¸ªè¯­å¥ï¼Œå¤§æ‹¬å·å¯ä»¥çœç•¥ï¼Œä½†æ˜¯ï¼Œä¿ºä»¬ä¸æå€¡è¿™ä¹ˆåš~</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// å•åˆ†æ”¯è¯­å¥</span></span><br><span class="line">    <span class="comment">// if (false) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (3 &gt; 5) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (2 === &#x27;2&#x27;) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//  1. é™¤äº†0 æ‰€æœ‰çš„æ•°å­—éƒ½ä¸ºçœŸ</span></span><br><span class="line">    <span class="comment">//   if (0) &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// 2.é™¤äº† &#x27;&#x27; æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½ä¸ºçœŸ true</span></span><br><span class="line">    <span class="comment">// if (&#x27;pinkè€å¸ˆ&#x27;) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (&#x27;&#x27;) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// // if (&#x27;&#x27;) console.log(&#x27;æ‰§è¡Œè¯­å¥&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. ç”¨æˆ·è¾“å…¥</span></span><br><span class="line">    <span class="keyword">let</span> score = +<span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥æˆç»©&#x27;</span>)</span><br><span class="line">    <span class="comment">// 2. è¿›è¡Œåˆ¤æ–­è¾“å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">700</span>) &#123;</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;æ­å–œè€ƒå…¥é»‘é©¬ç¨‹åºå‘˜&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="ifåŒåˆ†æ”¯è¯­å¥"><a href="#ifåŒåˆ†æ”¯è¯­å¥" class="headerlink" title="ifåŒåˆ†æ”¯è¯­å¥"></a>ifåŒåˆ†æ”¯è¯­å¥</h4><p>å¦‚æœæœ‰ä¸¤ä¸ªæ¡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ if else åŒåˆ†æ”¯è¯­å¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (æ¡ä»¶è¡¨è¾¾å¼)&#123;</span><br><span class="line">  <span class="comment">// æ»¡è¶³æ¡ä»¶è¦æ‰§è¡Œçš„è¯­å¥</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ä¸æ»¡è¶³æ¡ä»¶è¦æ‰§è¡Œçš„è¯­å¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="comment">// 1. ç”¨æˆ·è¾“å…¥</span></span><br><span class="line">   <span class="keyword">let</span> uname = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥ç”¨æˆ·å:&#x27;</span>)</span><br><span class="line">   <span class="keyword">let</span> pwd = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥å¯†ç :&#x27;</span>)</span><br><span class="line">   <span class="comment">// 2. åˆ¤æ–­è¾“å‡º</span></span><br><span class="line">   <span class="keyword">if</span> (uname === <span class="string">&#x27;pink&#x27;</span> &amp;&amp; pwd === <span class="string">&#x27;123456&#x27;</span>) &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;æ­å–œç™»å½•æˆåŠŸ&#x27;</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;ç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line"> &lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="if-å¤šåˆ†æ”¯è¯­å¥"><a href="#if-å¤šåˆ†æ”¯è¯­å¥" class="headerlink" title="if å¤šåˆ†æ”¯è¯­å¥"></a>if å¤šåˆ†æ”¯è¯­å¥</h4><p>ä½¿ç”¨åœºæ™¯ï¼š é€‚åˆäºæœ‰å¤šä¸ªæ¡ä»¶çš„æ—¶å€™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="comment">// 1. ç”¨æˆ·è¾“å…¥</span></span><br><span class="line">   <span class="keyword">let</span> score = +<span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥æˆç»©ï¼š&#x27;</span>)</span><br><span class="line">   <span class="comment">// 2. åˆ¤æ–­è¾“å‡º</span></span><br><span class="line">   <span class="keyword">if</span> (score &gt;= <span class="number">90</span>) &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;æˆç»©ä¼˜ç§€ï¼Œå®è´ï¼Œä½ æ˜¯æˆ‘çš„éª„å‚²&#x27;</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (score &gt;= <span class="number">70</span>) &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;æˆç»©è‰¯å¥½ï¼Œå®è´ï¼Œä½ è¦åŠ æ²¹å“¦~~&#x27;</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (score &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;æˆç»©åŠæ ¼ï¼Œå®è´ï¼Œä½ å¾ˆå±é™©~&#x27;</span>)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="title function_">alert</span>(<span class="string">&#x27;æˆç»©ä¸åŠæ ¼ï¼Œå®è´ï¼Œæˆ‘ä¸æƒ³å’Œä½ è¯´è¯ï¼Œæˆ‘åªæƒ³ç”¨é­å­å’Œä½ è¯´è¯~&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line"> &lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰"><a href="#ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰" class="headerlink" title="ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰"></a>ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰</h4><p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š ä¸€äº›ç®€å•çš„åŒåˆ†æ”¯ï¼Œå¯ä»¥ä½¿ç”¨  ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰ï¼Œå†™èµ·æ¥æ¯” if  elseåŒåˆ†æ”¯ æ›´ç®€å•</p><p><strong>ç¬¦å·</strong>ï¼š? ä¸ : é…åˆä½¿ç”¨</p><p>è¯­æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ¡ä»¶ ? è¡¨è¾¾å¼<span class="number">1</span> ï¼š è¡¨è¾¾å¼<span class="number">2</span></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‰å…ƒè¿ç®—ç¬¦ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰</span></span><br><span class="line"><span class="comment">// 1. è¯­æ³•æ ¼å¼</span></span><br><span class="line"><span class="comment">// æ¡ä»¶ ? è¡¨è¾¾å¼1 : è¡¨è¾¾å¼2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ‰§è¡Œè¿‡ç¨‹ </span></span><br><span class="line"><span class="comment">// 2.1 å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œåˆ™æ‰§è¡Œè¡¨è¾¾å¼1</span></span><br><span class="line"><span class="comment">// 2.2 å¦‚æœæ¡ä»¶ä¸ºå‡ï¼Œåˆ™æ‰§è¡Œè¡¨è¾¾å¼2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. éªŒè¯</span></span><br><span class="line"><span class="comment">// 5 &gt; 3 ? &#x27;çœŸçš„&#x27; : &#x27;å‡çš„&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span> &lt; <span class="number">3</span> ? <span class="string">&#x27;çœŸçš„&#x27;</span> : <span class="string">&#x27;å‡çš„&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// let age = 18 </span></span><br><span class="line"><span class="comment">// age = age + 1</span></span><br><span class="line"><span class="comment">//  age++</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. ç”¨æˆ·è¾“å…¥ </span></span><br><span class="line"><span class="keyword">let</span> num = <span class="title function_">prompt</span>(<span class="string">&#x27;è¯·æ‚¨è¾“å…¥ä¸€ä¸ªæ•°å­—:&#x27;</span>)</span><br><span class="line"><span class="comment">// 2. åˆ¤æ–­è¾“å‡º- å°äº10æ‰è¡¥0</span></span><br><span class="line"><span class="comment">// num = num &lt; 10 ? 0 + num : num</span></span><br><span class="line">num = num &gt;= <span class="number">10</span> ? num : <span class="number">0</span> + num</span><br><span class="line"><span class="title function_">alert</span>(num)</span><br></pre></td></tr></table></figure><h4 id="switchè¯­å¥ï¼ˆäº†è§£ï¼‰"><a href="#switchè¯­å¥ï¼ˆäº†è§£ï¼‰" class="headerlink" title="switchè¯­å¥ï¼ˆäº†è§£ï¼‰"></a>switchè¯­å¥ï¼ˆäº†è§£ï¼‰</h4><p>ä½¿ç”¨åœºæ™¯ï¼š é€‚åˆäºæœ‰å¤šä¸ªæ¡ä»¶çš„æ—¶å€™ï¼Œä¹Ÿå±äºåˆ†æ”¯è¯­å¥ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹å’Œ ifå¤šåˆ†æ”¯è¯­å¥ åŠŸèƒ½ç›¸åŒ</p><p>æ³¨æ„ï¼š</p><ol><li>switch caseè¯­å¥ä¸€èˆ¬ç”¨äºç­‰å€¼åˆ¤æ–­, ifé€‚åˆäºåŒºé—´åˆ¤æ–­</li><li>switchcaseä¸€èˆ¬éœ€è¦é…åˆbreakå…³é”®å­—ä½¿ç”¨ æ²¡æœ‰breakä¼šé€ æˆcaseç©¿é€</li><li>if å¤šåˆ†æ”¯è¯­å¥å¼€å‘è¦æ¯”switchæ›´é‡è¦ï¼Œä½¿ç”¨ä¹Ÿæ›´å¤š</li></ol><p>ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// switchåˆ†æ”¯è¯­å¥</span></span><br><span class="line"><span class="comment">// 1. è¯­æ³•</span></span><br><span class="line"><span class="comment">// switch (è¡¨è¾¾å¼) &#123;</span></span><br><span class="line"><span class="comment">//   case å€¼1:</span></span><br><span class="line"><span class="comment">//     ä»£ç 1</span></span><br><span class="line"><span class="comment">//     break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   case å€¼2:</span></span><br><span class="line"><span class="comment">//     ä»£ç 2</span></span><br><span class="line"><span class="comment">//     break</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">//   default:</span></span><br><span class="line"><span class="comment">//     ä»£ç n</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‚¨é€‰æ‹©çš„æ˜¯1&#x27;</span>)</span><br><span class="line">    <span class="keyword">break</span>  <span class="comment">// é€€å‡ºswitch</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‚¨é€‰æ‹©çš„æ˜¯2&#x27;</span>)</span><br><span class="line">    <span class="keyword">break</span>  <span class="comment">// é€€å‡ºswitch</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‚¨é€‰æ‹©çš„æ˜¯3&#x27;</span>)</span><br><span class="line">    <span class="keyword">break</span>  <span class="comment">// é€€å‡ºswitch</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="æ–­ç‚¹è°ƒè¯•"><a href="#æ–­ç‚¹è°ƒè¯•" class="headerlink" title="æ–­ç‚¹è°ƒè¯•"></a>æ–­ç‚¹è°ƒè¯•</h4><p><strong>ä½œç”¨ï¼š</strong>å­¦ä¹ æ—¶å¯ä»¥å¸®åŠ©æ›´å¥½çš„ç†è§£ä»£ç è¿è¡Œï¼Œå·¥ä½œæ—¶å¯ä»¥æ›´å¿«æ‰¾åˆ°bug</p><p>æµè§ˆå™¨æ‰“å¼€è°ƒè¯•ç•Œé¢</p><ol><li>æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·</li><li>ç‚¹åˆ°æºä»£ç ä¸€æ  ï¼ˆ sources ï¼‰</li><li>é€‰æ‹©ä»£ç æ–‡ä»¶</li></ol><p><strong>æ–­ç‚¹ï¼š</strong>åœ¨æŸå¥ä»£ç ä¸ŠåŠ çš„æ ‡è®°å°±å«æ–­ç‚¹ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°è¿™å¥æœ‰æ ‡è®°çš„ä»£ç æ—¶ä¼šæš‚åœä¸‹æ¥</p><h3 id="å¾ªç¯è¯­å¥"><a href="#å¾ªç¯è¯­å¥" class="headerlink" title="å¾ªç¯è¯­å¥"></a>å¾ªç¯è¯­å¥</h3><p>ä½¿ç”¨åœºæ™¯ï¼šé‡å¤æ‰§è¡Œ æŒ‡å®šçš„ä¸€æ®µä»£ç ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦è¾“å‡º10æ¬¡ â€˜æˆ‘å­¦çš„å¾ˆæ£’â€™</p><p>å­¦ä¹ è·¯å¾„ï¼š</p><p>1.whileå¾ªç¯</p><p>2.for å¾ªç¯ï¼ˆé‡ç‚¹ï¼‰</p><h4 id="whileå¾ªç¯"><a href="#whileå¾ªç¯" class="headerlink" title="whileå¾ªç¯"></a>whileå¾ªç¯</h4><p>while :  åœ¨â€¦. æœŸé—´ï¼Œ æ‰€ä»¥ whileå¾ªç¯ å°±æ˜¯åœ¨æ»¡è¶³æ¡ä»¶æœŸé—´ï¼Œé‡å¤æ‰§è¡ŒæŸäº›ä»£ç ã€‚</p><p><strong>è¯­æ³•ï¼š</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (æ¡ä»¶è¡¨è¾¾å¼) &#123;</span><br><span class="line">   <span class="comment">// å¾ªç¯ä½“    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// whileå¾ªç¯: é‡å¤æ‰§è¡Œä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. éœ€æ±‚: åˆ©ç”¨å¾ªç¯é‡å¤æ‰“å°3æ¬¡ &#x27;æœˆè–ªè¿‡ä¸‡ä¸æ˜¯æ¢¦ï¼Œæ¯•ä¸šæ—¶å€™è§è‹±é›„&#x27;</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;æœˆè–ªè¿‡ä¸‡ä¸æ˜¯æ¢¦ï¼Œæ¯•ä¸šæ—¶å€™è§è‹±é›„~&lt;br&gt;&#x27;</span>)</span><br><span class="line">  i++   <span class="comment">// è¿™é‡Œåƒä¸‡ä¸è¦å¿˜äº†å˜é‡è‡ªå¢å¦åˆ™é€ æˆæ­»å¾ªç¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ªç¯ä¸‰è¦ç´ ï¼š</p><p>1.åˆå§‹å€¼ ï¼ˆç»å¸¸ç”¨å˜é‡ï¼‰</p><p>2.ç»ˆæ­¢æ¡ä»¶</p><p>3.å˜é‡çš„å˜åŒ–é‡</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="comment">// // 1. å˜é‡çš„èµ·å§‹å€¼</span></span><br><span class="line">  <span class="comment">// let i = 1</span></span><br><span class="line">  <span class="comment">// // 2. ç»ˆæ­¢æ¡ä»¶</span></span><br><span class="line">  <span class="comment">// while (i &lt;= 3) &#123;</span></span><br><span class="line">  <span class="comment">//   document.write(&#x27;æˆ‘è¦å¾ªç¯ä¸‰æ¬¡ &lt;br&gt;&#x27;)</span></span><br><span class="line">  <span class="comment">//   // 3. å˜é‡çš„å˜åŒ–é‡</span></span><br><span class="line">  <span class="comment">//   i++</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// 1. å˜é‡çš„èµ·å§‹å€¼</span></span><br><span class="line">  <span class="keyword">let</span> end = +<span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥æ¬¡æ•°:&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> i = <span class="number">1</span></span><br><span class="line"><span class="comment">// 2. ç»ˆæ­¢æ¡ä»¶</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= end) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;æˆ‘è¦å¾ªç¯ä¸‰æ¬¡ &lt;br&gt;&#x27;</span>)</span><br><span class="line">  <span class="comment">// 3. å˜é‡çš„å˜åŒ–é‡</span></span><br><span class="line">  i++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="ä¸­æ­¢å¾ªç¯"><a href="#ä¸­æ­¢å¾ªç¯" class="headerlink" title="ä¸­æ­¢å¾ªç¯"></a>ä¸­æ­¢å¾ªç¯</h4><p><code>break</code>   ä¸­æ­¢æ•´ä¸ªå¾ªç¯ï¼Œä¸€èˆ¬ç”¨äºç»“æœå·²ç»å¾—åˆ°, åç»­çš„å¾ªç¯ä¸éœ€è¦çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼ˆæé«˜æ•ˆç‡ï¼‰  </p><p><code>continue</code>  ä¸­æ­¢æœ¬æ¬¡å¾ªç¯ï¼Œä¸€èˆ¬ç”¨äºæ’é™¤æˆ–è€…è·³è¿‡æŸä¸€ä¸ªé€‰é¡¹çš„æ—¶å€™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// let i = 1</span></span><br><span class="line">    <span class="comment">// while (i &lt;= 5) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(i)</span></span><br><span class="line">    <span class="comment">//   if (i === 3) &#123;</span></span><br><span class="line">    <span class="comment">//     break  // é€€å‡ºå¾ªç¯</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">//   i++</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (i === <span class="number">3</span>) &#123;</span><br><span class="line">        i++</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">      i++</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="æ— é™å¾ªç¯"><a href="#æ— é™å¾ªç¯" class="headerlink" title="æ— é™å¾ªç¯"></a>æ— é™å¾ªç¯</h4><p>1.while(true) æ¥æ„é€ â€œæ— é™â€å¾ªç¯ï¼Œéœ€è¦ä½¿ç”¨breaké€€å‡ºå¾ªç¯ã€‚ï¼ˆå¸¸ç”¨ï¼‰</p><p>2.for(;;) ä¹Ÿå¯ä»¥æ¥æ„é€ â€œæ— é™â€å¾ªç¯ï¼ŒåŒæ ·éœ€è¦ä½¿ç”¨breaké€€å‡ºå¾ªç¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ— é™å¾ªç¯  </span></span><br><span class="line"><span class="comment">// éœ€æ±‚ï¼š é¡µé¢ä¼šä¸€ç›´å¼¹çª—è¯¢é—®ä½ çˆ±æˆ‘å—ï¼Ÿ</span></span><br><span class="line"><span class="comment">// (1). å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ &#x27;çˆ±&#x27;ï¼Œåˆ™é€€å‡ºå¼¹çª—</span></span><br><span class="line"><span class="comment">// (2). å¦åˆ™ä¸€ç›´å¼¹çª—è¯¢é—®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. while(true) æ— é™å¾ªç¯</span></span><br><span class="line"><span class="comment">// while (true) &#123;</span></span><br><span class="line"><span class="comment">//   let love = prompt(&#x27;ä½ çˆ±æˆ‘å—?&#x27;)</span></span><br><span class="line"><span class="comment">//   if (love === &#x27;çˆ±&#x27;) &#123;</span></span><br><span class="line"><span class="comment">//     break</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. for(;;) æ— é™å¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> (; ;) &#123;</span><br><span class="line">  <span class="keyword">let</span> love = <span class="title function_">prompt</span>(<span class="string">&#x27;ä½ çˆ±æˆ‘å—?&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (love === <span class="string">&#x27;çˆ±&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»¼åˆæ¡ˆä¾‹-ATMå­˜å–æ¬¾æœº"><a href="#ç»¼åˆæ¡ˆä¾‹-ATMå­˜å–æ¬¾æœº" class="headerlink" title="ç»¼åˆæ¡ˆä¾‹-ATMå­˜å–æ¬¾æœº"></a>ç»¼åˆæ¡ˆä¾‹-ATMå­˜å–æ¬¾æœº</h2><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/javaScript/1671018781557.png" alt=""></p><p>åˆ†æï¼š</p><p>â‘ ï¼šæç¤ºè¾“å…¥æ¡†å†™åˆ°å¾ªç¯é‡Œé¢ï¼ˆæ— é™å¾ªç¯ï¼‰</p><p>â‘¡ï¼šç”¨æˆ·è¾“å…¥4åˆ™é€€å‡ºå¾ªç¯ break</p><p>â‘¢ï¼šæå‰å‡†å¤‡ä¸€ä¸ªé‡‘é¢é¢„å…ˆå­˜å‚¨ä¸€ä¸ªæ•°é¢ money</p><p>â‘£ï¼šæ ¹æ®è¾“å…¥ä¸åŒçš„å€¼ï¼Œåšä¸åŒçš„æ“ä½œ</p><p>â€‹     (1)  å–é’±åˆ™æ˜¯å‡æ³•æ“ä½œï¼Œ å­˜é’±åˆ™æ˜¯åŠ æ³•æ“ä½œï¼ŒæŸ¥çœ‹ä½™é¢åˆ™æ˜¯ç›´æ¥æ˜¾ç¤ºé‡‘é¢</p><p>â€‹     (2) å¯ä»¥ä½¿ç”¨ if else if å¤šåˆ†æ”¯ æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œ</p><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="comment">// 1. å¼€å§‹å¾ªç¯ è¾“å…¥æ¡†å†™åˆ° å¾ªç¯é‡Œé¢</span></span><br><span class="line">  <span class="comment">// 3. å‡†å¤‡ä¸€ä¸ªæ€»çš„é‡‘é¢</span></span><br><span class="line">  <span class="keyword">let</span> money = <span class="number">100</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> re = +<span class="title function_">prompt</span>(<span class="string">`</span></span><br><span class="line"><span class="string">è¯·æ‚¨é€‰æ‹©æ“ä½œï¼š</span></span><br><span class="line"><span class="string">1.å­˜é’±</span></span><br><span class="line"><span class="string">2.å–é’±</span></span><br><span class="line"><span class="string">3.æŸ¥çœ‹ä½™é¢</span></span><br><span class="line"><span class="string">4.é€€å‡º</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line">  <span class="comment">// 2. å¦‚æœç”¨æˆ·è¾“å…¥çš„ 4 åˆ™é€€å‡ºå¾ªç¯ï¼Œ break  å†™åˆ°if é‡Œé¢ï¼Œæ²¡æœ‰å†™åˆ°switché‡Œé¢ï¼Œ å› ä¸º4éœ€è¦breaké€€å‡ºå¾ªç¯</span></span><br><span class="line">  <span class="keyword">if</span> (re === <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 4. æ ¹æ®è¾“å…¥åšæ“ä½œ</span></span><br><span class="line">  <span class="keyword">switch</span> (re) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="comment">// å­˜é’±</span></span><br><span class="line">      <span class="keyword">let</span> cun = +<span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥å­˜æ¬¾é‡‘é¢&#x27;</span>)</span><br><span class="line">      money = money + cun</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="comment">// å­˜é’±</span></span><br><span class="line">      <span class="keyword">let</span> qu = +<span class="title function_">prompt</span>(<span class="string">&#x27;è¯·è¾“å…¥å–æ¬¾é‡‘é¢&#x27;</span>)</span><br><span class="line">      money = money - qu</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      <span class="comment">// å­˜é’±</span></span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">`æ‚¨çš„é“¶è¡Œå¡ä½™é¢æ˜¯<span class="subst">$&#123;money&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å­¦ä¹ å‰ç«¯ javaScriptçš„åŸºç¡€çŸ¥è¯†</summary>
    
    
    
    <category term="javaScript" scheme="https://www.jodio.cc/categories/javaScript/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="javaScript" scheme="https://www.jodio.cc/tags/javaScript/"/>
    
  </entry>
  
  <entry>
    <title>Netty(ä¸‰) -- è¿›é˜¶ç¯‡</title>
    <link href="https://www.jodio.cc/posts/netty-advanced.html"/>
    <id>https://www.jodio.cc/posts/netty-advanced.html</id>
    <published>2023-04-21T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸‰-Netty-è¿›é˜¶"><a href="#ä¸‰-Netty-è¿›é˜¶" class="headerlink" title="ä¸‰. Netty è¿›é˜¶"></a>ä¸‰. Netty è¿›é˜¶</h1><h2 id="1-ç²˜åŒ…ä¸åŠåŒ…"><a href="#1-ç²˜åŒ…ä¸åŠåŒ…" class="headerlink" title="1. ç²˜åŒ…ä¸åŠåŒ…"></a>1. ç²˜åŒ…ä¸åŠåŒ…</h2><h3 id="1-1-ç²˜åŒ…ç°è±¡"><a href="#1-1-ç²˜åŒ…ç°è±¡" class="headerlink" title="1.1 ç²˜åŒ…ç°è±¡"></a>1.1 ç²˜åŒ…ç°è±¡</h3><p>æœåŠ¡ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldServer</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldServer.class);</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            serverBootstrap.group(boss, worker);</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;connected &#123;&#125;&quot;</span>, ctx.channel());</span><br><span class="line">                            <span class="built_in">super</span>.channelActive(ctx);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;disconnect &#123;&#125;&quot;</span>, ctx.channel());</span><br><span class="line">                            <span class="built_in">super</span>.channelInactive(ctx);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; binding...&quot;</span>, channelFuture.channel());</span><br><span class="line">            channelFuture.sync();</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; bound...&quot;</span>, channelFuture.channel());</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">            log.debug(<span class="string">&quot;stoped&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HelloWorldServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 10 ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯ 16 å­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldClient.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;connetted...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;sending...&quot;</span>);</span><br><span class="line">                            <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                                <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                                buffer.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>&#125;);</span><br><span class="line">                                ctx.writeAndFlush(buffer);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€æ¬¡å°±æ¥æ”¶äº† 160 ä¸ªå­—èŠ‚ï¼Œè€Œéåˆ† 10 æ¬¡æ¥æ”¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...</span><br><span class="line">08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...</span><br><span class="line">08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED</span><br><span class="line">08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE</span><br><span class="line">08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]</span><br><span class="line">08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE</span><br></pre></td></tr></table></figure><h3 id="1-2-åŠåŒ…ç°è±¡"><a href="#1-2-åŠåŒ…ç°è±¡" class="headerlink" title="1.2 åŠåŒ…ç°è±¡"></a>1.2 åŠåŒ…ç°è±¡</h3><p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 1 ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ 160 å­—èŠ‚ï¼Œä»£ç æ”¹ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    buffer.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line">ctx.writeAndFlush(buffer);</span><br></pre></td></tr></table></figure><p>ä¸ºç°è±¡æ˜æ˜¾ï¼ŒæœåŠ¡ç«¯ä¿®æ”¹ä¸€ä¸‹æ¥æ”¶ç¼“å†²åŒºï¼Œå…¶å®ƒä»£ç ä¸å˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serverBootstrap.option(ChannelOption.SO_RCVBUF, <span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ¥æ”¶çš„æ¶ˆæ¯è¢«åˆ†ä¸ºä¸¤èŠ‚ï¼Œç¬¬ä¸€æ¬¡ 20 å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 140 å­—èŠ‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...</span><br><span class="line">08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...</span><br><span class="line">08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED</span><br><span class="line">08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE</span><br><span class="line">08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]</span><br><span class="line">08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|</span><br><span class="line">|00000010| 00 01 02 03                                     |....            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE</span><br><span class="line">08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|</span><br><span class="line">|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong></p><p>serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) å½±å“çš„åº•å±‚æ¥æ”¶ç¼“å†²åŒºï¼ˆå³æ»‘åŠ¨çª—å£ï¼‰å¤§å°ï¼Œä»…å†³å®šäº† netty è¯»å–çš„æœ€å°å•ä½ï¼Œnetty å®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€</p></blockquote><h3 id="1-3-ç°è±¡åˆ†æ"><a href="#1-3-ç°è±¡åˆ†æ" class="headerlink" title="1.3 ç°è±¡åˆ†æ"></a>1.3 ç°è±¡åˆ†æ</h3><p>ç²˜åŒ…</p><ul><li>ç°è±¡ï¼Œå‘é€ abc defï¼Œæ¥æ”¶ abcdef</li><li>åŸå› <ul><li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf è®¾ç½®å¤ªå¤§ï¼ˆNetty é»˜è®¤ 1024ï¼‰</li><li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾å‘é€æ–¹ 256 bytes è¡¨ç¤ºä¸€ä¸ªå®Œæ•´æŠ¥æ–‡ï¼Œä½†ç”±äºæ¥æ”¶æ–¹å¤„ç†ä¸åŠæ—¶ä¸”çª—å£å¤§å°è¶³å¤Ÿå¤§ï¼Œè¿™ 256 bytes å­—èŠ‚å°±ä¼šç¼“å†²åœ¨æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£ä¸­ï¼Œå½“æ»‘åŠ¨çª—å£ä¸­ç¼“å†²äº†å¤šä¸ªæŠ¥æ–‡å°±ä¼šç²˜åŒ…</li><li>Nagle ç®—æ³•ï¼šä¼šé€ æˆç²˜åŒ…</li></ul></li></ul><p>åŠåŒ…</p><ul><li>ç°è±¡ï¼Œå‘é€ abcdefï¼Œæ¥æ”¶ abc def</li><li>åŸå› <ul><li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf å°äºå®é™…å‘é€æ•°æ®é‡</li><li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾æ¥æ”¶æ–¹çš„çª—å£åªå‰©äº† 128 bytesï¼Œå‘é€æ–¹çš„æŠ¥æ–‡å¤§å°æ˜¯ 256 bytesï¼Œè¿™æ—¶æ”¾ä¸ä¸‹äº†ï¼Œåªèƒ½å…ˆå‘é€å‰ 128 bytesï¼Œç­‰å¾… ack åæ‰èƒ½å‘é€å‰©ä½™éƒ¨åˆ†ï¼Œè¿™å°±é€ æˆäº†åŠåŒ…</li><li>MSS é™åˆ¶ï¼šå½“å‘é€çš„æ•°æ®è¶…è¿‡ MSS é™åˆ¶åï¼Œä¼šå°†æ•°æ®åˆ‡åˆ†å‘é€ï¼Œå°±ä¼šé€ æˆåŠåŒ…</li></ul></li></ul><p>æœ¬è´¨æ˜¯å› ä¸º TCP æ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œ</p><blockquote><p>æ»‘åŠ¨çª—å£</p><ul><li><p>TCP ä»¥ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰ä¸ºå•ä½ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µå°±éœ€è¦è¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ï¼ˆackï¼‰å¤„ç†ï¼Œä½†å¦‚æœè¿™ä¹ˆåšï¼Œç¼ºç‚¹æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿æ€§èƒ½å°±è¶Šå·®</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0049.png" alt=""></p></li></ul><ul><li><p>ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œå¼•å…¥äº†çª—å£æ¦‚å¿µï¼Œçª—å£å¤§å°å³å†³å®šäº†æ— éœ€ç­‰å¾…åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€çš„æ•°æ®æœ€å¤§å€¼</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0051.png" alt=""></p></li><li><p>çª—å£å®é™…å°±èµ·åˆ°ä¸€ä¸ªç¼“å†²åŒºçš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½èµ·åˆ°æµé‡æ§åˆ¶çš„ä½œç”¨</p><ul><li>å›¾ä¸­æ·±è‰²çš„éƒ¨åˆ†å³è¦å‘é€çš„æ•°æ®ï¼Œé«˜äº®çš„éƒ¨åˆ†å³çª—å£</li><li>çª—å£å†…çš„æ•°æ®æ‰å…è®¸è¢«å‘é€ï¼Œå½“åº”ç­”æœªåˆ°è¾¾å‰ï¼Œçª—å£å¿…é¡»åœæ­¢æ»‘åŠ¨</li><li>å¦‚æœ 1001~2000 è¿™ä¸ªæ®µçš„æ•°æ® ack å›æ¥äº†ï¼Œçª—å£å°±å¯ä»¥å‘å‰æ»‘åŠ¨</li><li>æ¥æ”¶æ–¹ä¹Ÿä¼šç»´æŠ¤ä¸€ä¸ªçª—å£ï¼Œåªæœ‰è½åœ¨çª—å£å†…çš„æ•°æ®æ‰èƒ½å…è®¸æ¥æ”¶</li></ul></li></ul><p> MSS é™åˆ¶</p><ul><li><p>é“¾è·¯å±‚å¯¹ä¸€æ¬¡èƒ½å¤Ÿå‘é€çš„æœ€å¤§æ•°æ®æœ‰é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶ç§°ä¹‹ä¸º MTUï¼ˆmaximum transmission unitï¼‰ï¼Œä¸åŒçš„é“¾è·¯è®¾å¤‡çš„ MTU å€¼ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚</p><ul><li>ä»¥å¤ªç½‘çš„ MTU æ˜¯ 1500</li><li>FDDIï¼ˆå…‰çº¤åˆ†å¸ƒå¼æ•°æ®æ¥å£ï¼‰çš„ MTU æ˜¯ 4352</li><li>æœ¬åœ°å›ç¯åœ°å€çš„ MTU æ˜¯ 65535 - æœ¬åœ°æµ‹è¯•ä¸èµ°ç½‘å¡</li></ul></li><li><p>MSS æ˜¯æœ€å¤§æ®µé•¿åº¦ï¼ˆmaximum segment sizeï¼‰ï¼Œå®ƒæ˜¯ MTU åˆ¨å» tcp å¤´å’Œ ip å¤´åå‰©ä½™èƒ½å¤Ÿä½œä¸ºæ•°æ®ä¼ è¾“çš„å­—èŠ‚æ•°</p><ul><li>ipv4 tcp å¤´å ç”¨ 20 bytesï¼Œip å¤´å ç”¨ 20 bytesï¼Œå› æ­¤ä»¥å¤ªç½‘ MSS çš„å€¼ä¸º 1500 - 40 = 1460</li><li>TCP åœ¨ä¼ é€’å¤§é‡æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§ MSS å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€</li><li>MSS çš„å€¼åœ¨ä¸‰æ¬¡æ¡æ‰‹æ—¶é€šçŸ¥å¯¹æ–¹è‡ªå·± MSS çš„å€¼ï¼Œç„¶ååœ¨ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªå°å€¼ä½œä¸º MSS</li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0031.jpg" style="zoom:50%;" /></p></li></ul><p>Nagle ç®—æ³•</p><ul><li>å³ä½¿å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿéœ€è¦åŠ å…¥ tcp å¤´å’Œ ip å¤´ï¼Œä¹Ÿå°±æ˜¯æ€»å­—èŠ‚æ•°ä¼šä½¿ç”¨ 41 bytesï¼Œéå¸¸ä¸ç»æµã€‚å› æ­¤ä¸ºäº†æé«˜ç½‘ç»œåˆ©ç”¨ç‡ï¼Œtcp å¸Œæœ›å°½å¯èƒ½å‘é€è¶³å¤Ÿå¤§çš„æ•°æ®ï¼Œè¿™å°±æ˜¯ Nagle ç®—æ³•äº§ç”Ÿçš„ç¼˜ç”±</li><li>è¯¥ç®—æ³•æ˜¯æŒ‡å‘é€ç«¯å³ä½¿è¿˜æœ‰åº”è¯¥å‘é€çš„æ•°æ®ï¼Œä½†å¦‚æœè¿™éƒ¨åˆ†æ•°æ®å¾ˆå°‘çš„è¯ï¼Œåˆ™è¿›è¡Œå»¶è¿Ÿå‘é€<ul><li>å¦‚æœ SO_SNDBUF çš„æ•°æ®è¾¾åˆ° MSSï¼Œåˆ™éœ€è¦å‘é€</li><li>å¦‚æœ SO_SNDBUF ä¸­å«æœ‰ FINï¼ˆè¡¨ç¤ºéœ€è¦è¿æ¥å…³é—­ï¼‰è¿™æ—¶å°†å‰©ä½™æ•°æ®å‘é€ï¼Œå†å…³é—­</li><li>å¦‚æœ TCP_NODELAY = trueï¼Œåˆ™éœ€è¦å‘é€</li><li>å·²å‘é€çš„æ•°æ®éƒ½æ”¶åˆ° ack æ—¶ï¼Œåˆ™éœ€è¦å‘é€</li><li>ä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œä½†å‘ç”Ÿè¶…æ—¶ï¼ˆä¸€èˆ¬ä¸º 200msï¼‰åˆ™éœ€è¦å‘é€</li><li>é™¤ä¸Šè¿°æƒ…å†µï¼Œå»¶è¿Ÿå‘é€</li></ul></li></ul></blockquote><h3 id="1-4-è§£å†³æ–¹æ¡ˆ"><a href="#1-4-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="1.4 è§£å†³æ–¹æ¡ˆ"></a>1.4 è§£å†³æ–¹æ¡ˆ</h3><ol><li>çŸ­é“¾æ¥ï¼Œå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹æ•ˆç‡å¤ªä½</li><li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ï¼Œç¼ºç‚¹æµªè´¹ç©ºé—´</li><li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \nï¼Œç¼ºç‚¹éœ€è¦è½¬ä¹‰</li><li>æ¯ä¸€æ¡æ¶ˆæ¯åˆ†ä¸º head å’Œ bodyï¼Œhead ä¸­åŒ…å« body çš„é•¿åº¦</li></ol><h4 id="æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥"><a href="#æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥" class="headerlink" title="æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥"></a>æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥</h4><p>ä»¥è§£å†³ç²˜åŒ…ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ† 10 æ¬¡å‘é€</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            send();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;conneted...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;sending...&quot;</span>);</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                            buffer.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>&#125;);</span><br><span class="line">                            ctx.writeAndFlush(buffer);</span><br><span class="line">                            <span class="comment">// å‘å®Œå³å…³</span></span><br><span class="line">                            ctx.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼Œç•¥</p><blockquote><p>åŠåŒ…ç”¨è¿™ç§åŠæ³•è¿˜æ˜¯ä¸å¥½è§£å†³ï¼Œå› ä¸ºæ¥æ”¶æ–¹çš„ç¼“å†²åŒºå¤§å°æ˜¯æœ‰é™çš„</p></blockquote><h4 id="æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦"><a href="#æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦" class="headerlink" title="æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦"></a>æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦</h4><p>è®©æ‰€æœ‰æ•°æ®åŒ…é•¿åº¦å›ºå®šï¼ˆå‡è®¾é•¿åº¦ä¸º 8 å­—èŠ‚ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŠ å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">8</span>));</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ï¼Œæ³¨æ„, é‡‡ç”¨è¿™ç§æ–¹æ³•åï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ flush éƒ½å¯ä»¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;connetted...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;sending...&quot;</span>);</span><br><span class="line">                            <span class="comment">// å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…</span></span><br><span class="line">                            <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>];</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; r.nextInt(<span class="number">8</span>); j++) &#123;</span><br><span class="line">                                    bytes[j] = (<span class="type">byte</span>) c;</span><br><span class="line">                                &#125;</span><br><span class="line">                                c++;</span><br><span class="line">                                buffer.writeBytes(bytes);</span><br><span class="line">                            &#125;</span><br><span class="line">                            ctx.writeAndFlush(buffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;192.168.0.103&quot;</span>, <span class="number">9090</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|</span><br><span class="line">|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|</span><br><span class="line">|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|</span><br><span class="line">|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|</span><br><span class="line">|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...</span><br><span class="line">12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 62 00 00 00 00 00 00 00                         |b.......        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 63 63 00 00 00 00 00 00                         |cc......        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 64 00 00 00 00 00 00 00                         |d.......        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 00 00 00 00 00 00 00                         |........        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 68 00 00 00 00 00 00 00                         |h.......        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE</span><br></pre></td></tr></table></figure><p>ç¼ºç‚¹æ˜¯ï¼Œæ•°æ®åŒ…çš„å¤§å°ä¸å¥½æŠŠæ¡</p><ul><li>é•¿åº¦å®šçš„å¤ªå¤§ï¼Œæµªè´¹</li><li>é•¿åº¦å®šçš„å¤ªå°ï¼Œå¯¹æŸäº›æ•°æ®åŒ…åˆæ˜¾å¾—ä¸å¤Ÿ</li></ul><h4 id="æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦"><a href="#æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦" class="headerlink" title="æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦"></a>æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦</h4><p>æœåŠ¡ç«¯åŠ å…¥ï¼Œé»˜è®¤ä»¥ \n æˆ– \r\n ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LineBasedFrameDecoder</span>(<span class="number">1024</span>));</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ \n åˆ†éš”ç¬¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;connetted...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;sending...&quot;</span>);</span><br><span class="line">                            <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= r.nextInt(<span class="number">16</span>)+<span class="number">1</span>; j++) &#123;</span><br><span class="line">                                    buffer.writeByte((<span class="type">byte</span>) c);</span><br><span class="line">                                &#125;</span><br><span class="line">                                buffer.writeByte(<span class="number">10</span>);</span><br><span class="line">                                c++;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ctx.writeAndFlush(buffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;192.168.0.103&quot;</span>, <span class="number">9090</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|</span><br><span class="line">|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|</span><br><span class="line">|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|</span><br><span class="line">|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61                                              |a               |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 62 62 62                                        |bbb             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 63 63 63                                        |ccc             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 64 64                                           |dd              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 66 66                                           |ff              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 67 67 67 67 67 67 67                            |ggggggg         |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 68 68 68 68                                     |hhhh            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE</span><br></pre></td></tr></table></figure><p>ç¼ºç‚¹ï¼Œå¤„ç†å­—ç¬¦æ•°æ®æ¯”è¾ƒåˆé€‚ï¼Œä½†å¦‚æœå†…å®¹æœ¬èº«åŒ…å«äº†åˆ†éš”ç¬¦ï¼ˆå­—èŠ‚æ•°æ®å¸¸å¸¸ä¼šæœ‰æ­¤æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè§£æé”™è¯¯</p><h4 id="æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦"><a href="#æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦" class="headerlink" title="æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦"></a>æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦</h4><p>åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆçº¦å®šç”¨å®šé•¿å­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥æ•°æ®çš„é•¿åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ€å¤§é•¿åº¦ï¼Œé•¿åº¦åç§»ï¼Œé•¿åº¦å ç”¨å­—èŠ‚ï¼Œé•¿åº¦è°ƒæ•´ï¼Œå‰¥ç¦»å­—èŠ‚æ•°</span></span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HelloWorldClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(worker);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;connetted...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;sending...&quot;</span>);</span><br><span class="line">                            <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                                <span class="type">byte</span> <span class="variable">length</span> <span class="operator">=</span> (<span class="type">byte</span>) (r.nextInt(<span class="number">16</span>) + <span class="number">1</span>);</span><br><span class="line">                                <span class="comment">// å…ˆå†™å…¥é•¿åº¦</span></span><br><span class="line">                                buffer.writeByte(length);</span><br><span class="line">                                <span class="comment">// å†</span></span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= length; j++) &#123;</span><br><span class="line">                                    buffer.writeByte((<span class="type">byte</span>) c);</span><br><span class="line">                                &#125;</span><br><span class="line">                                c++;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ctx.writeAndFlush(buffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;192.168.0.103&quot;</span>, <span class="number">9090</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|</span><br><span class="line">|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|</span><br><span class="line">|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|</span><br><span class="line">|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|</span><br><span class="line">|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|</span><br><span class="line">|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|</span><br><span class="line">|00000060| 6a                                              |j               |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...</span><br><span class="line">14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 63 63 63 63 63 63                               |cccccc          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 67 67                                           |gg              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 68 68                                           |hh              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2-åè®®è®¾è®¡ä¸è§£æ"><a href="#2-åè®®è®¾è®¡ä¸è§£æ" class="headerlink" title="2. åè®®è®¾è®¡ä¸è§£æ"></a>2. åè®®è®¾è®¡ä¸è§£æ</h2><h3 id="2-1-ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ"><a href="#2-1-ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ"></a>2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</h3><p>TCP/IP ä¸­æ¶ˆæ¯ä¼ è¾“åŸºäºæµçš„æ–¹å¼ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚</p><p>åè®®çš„ç›®çš„å°±æ˜¯åˆ’å®šæ¶ˆæ¯çš„è¾¹ç•Œï¼Œåˆ¶å®šé€šä¿¡åŒæ–¹è¦å…±åŒéµå®ˆçš„é€šä¿¡è§„åˆ™</p><p>ä¾‹å¦‚ï¼šåœ¨ç½‘ç»œä¸Šä¼ è¾“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹é›¨å¤©ç•™å®¢å¤©ç•™æˆ‘ä¸ç•™</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸­æ–‡ä¸€å¥è‘—åçš„æ— æ ‡ç‚¹ç¬¦å·å¥å­ï¼Œåœ¨æ²¡æœ‰æ ‡ç‚¹ç¬¦å·æƒ…å†µä¸‹ï¼Œè¿™å¥è¯æœ‰æ•°ç§æ‹†è§£æ–¹å¼ï¼Œè€Œæ„æ€å´æ˜¯å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥å¸¸è¢«ç”¨ä½œè®²è¿°æ ‡ç‚¹ç¬¦å·çš„é‡è¦æ€§</p><p>ä¸€ç§è§£è¯»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹é›¨å¤©ç•™å®¢ï¼Œå¤©ç•™ï¼Œæˆ‘ä¸ç•™</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§è§£è¯»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹é›¨å¤©ï¼Œç•™å®¢å¤©ï¼Œç•™æˆ‘ä¸ï¼Ÿç•™</span><br></pre></td></tr></table></figure><p>å¦‚ä½•è®¾è®¡åè®®å‘¢ï¼Ÿå…¶å®å°±æ˜¯ç»™ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯åŠ ä¸Šâ€œæ ‡ç‚¹ç¬¦å·â€ã€‚ä½†é€šè¿‡åˆ†éš”ç¬¦æ¥æ–­å¥ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºåˆ†éš”ç¬¦æœ¬èº«å¦‚æœç”¨äºä¼ è¾“ï¼Œé‚£ä¹ˆå¿…é¡»åŠ ä»¥åŒºåˆ†ã€‚å› æ­¤ï¼Œä¸‹é¢ä¸€ç§åè®®è¾ƒä¸ºå¸¸ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®šé•¿å­—èŠ‚è¡¨ç¤ºå†…å®¹é•¿åº¦ + å®é™…å†…å®¹</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é•¿åº¦ä¸º 3ï¼ŒæŒ‰ç…§ä¸Šè¿°åè®®çš„è§„åˆ™ï¼Œå‘é€ä¿¡æ¯æ–¹å¼å¦‚ä¸‹ï¼Œå°±ä¸ä¼šè¢«æ¥æ”¶æ–¹å¼„é”™æ„æ€äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0fä¸‹é›¨å¤©ç•™å®¢06å¤©ç•™09æˆ‘ä¸ç•™</span><br></pre></td></tr></table></figure><blockquote><p>å°æ•…äº‹</p><p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œä¸€ä½ç§å¡¾å…ˆç”Ÿåˆ°ä¸€å®¶ä»»æ•™ã€‚åŒæ–¹ç­¾è®¢äº†ä¸€çº¸åè®®ï¼šâ€œæ— é¸¡é¸­äº¦å¯æ— é±¼è‚‰äº¦å¯ç™½èœè±†è…ä¸å¯å°‘ä¸å¾—æŸä¿®é‡‘â€ã€‚æ­¤åï¼Œç§å¡¾å…ˆç”Ÿè™½ç„¶è®¤çœŸæ•™è¯¾ï¼Œä½†ä¸»äººå®¶åˆ™æ€»æ˜¯ç»™ç§å¡¾å…ˆç”Ÿä»¥ç™½èœè±†è…ä¸ºèœï¼Œä¸æ¯«æœªè§é¸¡é¸­é±¼è‚‰çš„æ¬¾å¾…ã€‚ç§å¡¾å…ˆç”Ÿå…ˆæ˜¯å¾ˆä¸è§£ï¼Œå¯æ˜¯åæ¥ä¹Ÿå°±æƒ³é€šäº†ï¼šä¸»äººæŠŠé¸¡é¸­é±¼è‚‰çš„é’±éƒ½ä¼šæ¢ä¸ºæŸä¿®é‡‘çš„ï¼Œä¹Ÿç½¢ã€‚è‡³æ­¤åŒæ–¹ç›¸å®‰æ— äº‹ã€‚</p><p>å¹´å…³å°†è‡³ï¼Œä¸€ä¸ªå­¦å¹´æ®µäº¦å‘Šç»“æŸã€‚ç§å¡¾å…ˆç”Ÿä¸´è¡Œæ—¶ï¼Œä¹Ÿä¸è§ä¸»äººå®¶ä¸ºä»–äº¤ä»˜æŸä¿®é‡‘ï¼Œé‚ä¸ä¸»å®¶ç†è®ºã€‚ç„¶ä¸»å®¶äº¦æŒ¯æŒ¯æœ‰è¯ï¼šâ€œæœ‰åè®®ä¸ºè¯â€”â€”æ— é¸¡é¸­äº¦å¯ï¼Œæ— é±¼è‚‰äº¦å¯ï¼Œç™½èœè±†è…ä¸å¯å°‘ï¼Œä¸å¾—æŸä¿®é‡‘ã€‚è¿™ç™½çº¸é»‘å­—æ˜æ‘†ç€çš„ï¼Œä½ æœ‰ä»€ä¹ˆè¦è¯´çš„å‘¢ï¼Ÿâ€</p><p>ç§å¡¾å…ˆç”Ÿæ®ç†åŠ›äº‰ï¼šâ€œåè®®æ˜¯è¿™æ ·çš„â€”â€”æ— é¸¡ï¼Œé¸­äº¦å¯ï¼›æ— é±¼ï¼Œè‚‰äº¦å¯ï¼›ç™½èœè±†è…ä¸å¯ï¼Œå°‘ä¸å¾—æŸä¿®é‡‘ã€‚â€</p><p>åŒæ–¹å”‡æªèˆŒæˆ˜ï¼Œä½ æ¥æˆ‘å¾€ï¼ŒçœŸä¸ªæ˜¯ä¸äº¦ä¹ä¹ï¼</p><p>è¿™é‡Œçš„æŸä¿®é‡‘ï¼Œä¹Ÿä½œâ€œæŸè„©â€ï¼Œåº”å½“æ˜¯æ³›æŒ‡æ•™å¸ˆåº”å½“å¾—åˆ°çš„æŠ¥é…¬</p></blockquote><h3 id="2-2-redis-åè®®ä¸¾ä¾‹"><a href="#2-2-redis-åè®®ä¸¾ä¾‹" class="headerlink" title="2.2 redis åè®®ä¸¾ä¾‹"></a>2.2 redis åè®®ä¸¾ä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="type">byte</span>[] LINE = &#123;<span class="number">13</span>, <span class="number">10</span>&#125;;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">    bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">    bootstrap.group(worker);</span><br><span class="line">    bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>());</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                <span class="comment">// ä¼šåœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active äº‹ä»¶</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">                    set(ctx);</span><br><span class="line">                    get(ctx);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;*2&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;$3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;get&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;$3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;aaa&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    ctx.writeAndFlush(buf);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;*3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;$3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;set&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;$3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;aaa&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;$3&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    buf.writeBytes(<span class="string">&quot;bbb&quot;</span>.getBytes());</span><br><span class="line">                    buf.writeBytes(LINE);</span><br><span class="line">                    ctx.writeAndFlush(buf);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(buf.toString(Charset.defaultCharset()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>).sync();</span><br><span class="line">    channelFuture.channel().closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    worker.shutdownGracefully();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-http-åè®®ä¸¾ä¾‹"><a href="#2-3-http-åè®®ä¸¾ä¾‹" class="headerlink" title="2.3 http åè®®ä¸¾ä¾‹"></a>2.3 http åè®®ä¸¾ä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">    serverBootstrap.group(boss, worker);</span><br><span class="line">    serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpRequest&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="comment">// è·å–è¯·æ±‚</span></span><br><span class="line">                    log.debug(msg.uri());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿”å›å“åº”</span></span><br><span class="line">                    <span class="type">DefaultFullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span></span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(msg.protocolVersion(), HttpResponseStatus.OK);</span><br><span class="line"></span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="string">&quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;</span>.getBytes();</span><br><span class="line"></span><br><span class="line">                    response.headers().setInt(CONTENT_LENGTH, bytes.length);</span><br><span class="line">                    response.content().writeBytes(bytes);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å†™å›å“åº”</span></span><br><span class="line">                    ctx.writeAndFlush(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</span></span><br><span class="line"><span class="comment">                    log.debug(&quot;&#123;&#125;&quot;, msg.getClass());</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    if (msg instanceof HttpRequest) &#123; // è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125; else if (msg instanceof HttpContent) &#123; //è¯·æ±‚ä½“</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;);*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync();</span><br><span class="line">    channelFuture.channel().closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    boss.shutdownGracefully();</span><br><span class="line">    worker.shutdownGracefully();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-è‡ªå®šä¹‰åè®®è¦ç´ "><a href="#2-4-è‡ªå®šä¹‰åè®®è¦ç´ " class="headerlink" title="2.4 è‡ªå®šä¹‰åè®®è¦ç´ "></a>2.4 è‡ªå®šä¹‰åè®®è¦ç´ </h3><ul><li>é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…</li><li>ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§</li><li>åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdk</li><li>æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠâ€¦ è·Ÿä¸šåŠ¡ç›¸å…³</li><li>è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œæä¾›å¼‚æ­¥èƒ½åŠ›</li><li>æ­£æ–‡é•¿åº¦</li><li>æ¶ˆæ¯æ­£æ–‡</li></ul><h4 id="ç¼–è§£ç å™¨"><a href="#ç¼–è§£ç å™¨" class="headerlink" title="ç¼–è§£ç å™¨"></a>ç¼–è§£ç å™¨</h4><p>æ ¹æ®ä¸Šé¢çš„è¦ç´ ï¼Œè®¾è®¡ä¸€ä¸ªç™»å½•è¯·æ±‚æ¶ˆæ¯å’Œç™»å½•å“åº”æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ Netty å®Œæˆæ”¶å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodec</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageCodec</span>&lt;Message&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="comment">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span></span><br><span class="line">        out.writeByte(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span></span><br><span class="line">        out.writeByte(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span></span><br><span class="line">        out.writeByte(msg.getMessageType());</span><br><span class="line">        <span class="comment">// 5. 4 ä¸ªå­—èŠ‚</span></span><br><span class="line">        out.writeInt(msg.getSequenceId());</span><br><span class="line">        <span class="comment">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span></span><br><span class="line">        out.writeByte(<span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(msg);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">        <span class="comment">// 7. é•¿åº¦</span></span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        <span class="comment">// 8. å†™å…¥å†…å®¹</span></span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magicNum</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">serializerType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        in.readBytes(bytes, <span class="number">0</span>, length);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, magicNum, version, serializerType, messageType, sequenceId, length);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, message);</span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(</span><br><span class="line">        <span class="number">1024</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MessageCodec</span>()</span><br><span class="line">);</span><br><span class="line"><span class="comment">// encode</span></span><br><span class="line"><span class="type">LoginRequestMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginRequestMessage</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;123&quot;</span>, <span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="comment">//        channel.writeOutbound(message);</span></span><br><span class="line"><span class="comment">// decode</span></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">MessageCodec</span>().encode(<span class="literal">null</span>, message, buf);</span><br><span class="line"></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">s1</span> <span class="operator">=</span> buf.slice(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">s2</span> <span class="operator">=</span> buf.slice(<span class="number">100</span>, buf.readableBytes() - <span class="number">100</span>);</span><br><span class="line">s1.retain(); <span class="comment">// å¼•ç”¨è®¡æ•° 2</span></span><br><span class="line">channel.writeInbound(s1); <span class="comment">// release 1</span></span><br><span class="line">channel.writeInbound(s2);</span><br></pre></td></tr></table></figure><p>è§£è¯»</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0013.png" alt=""></p><h4 id="ğŸ’¡-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -Sharable"><a href="#ğŸ’¡-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -Sharable" class="headerlink" title="ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable"></a>ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable</h4><ul><li>å½“ handler ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«</li><li>ä½†è¦æ³¨æ„å¯¹äºç¼–è§£ç å™¨ç±»ï¼Œä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandler çˆ¶ç±»ï¼Œä»–ä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶</li><li>å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodecSharable</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageCodec</span>&lt;ByteBuf, Message&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">out</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">        <span class="comment">// 1. 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="comment">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span></span><br><span class="line">        out.writeByte(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span></span><br><span class="line">        out.writeByte(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span></span><br><span class="line">        out.writeByte(msg.getMessageType());</span><br><span class="line">        <span class="comment">// 5. 4 ä¸ªå­—èŠ‚</span></span><br><span class="line">        out.writeInt(msg.getSequenceId());</span><br><span class="line">        <span class="comment">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span></span><br><span class="line">        out.writeByte(<span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(msg);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">        <span class="comment">// 7. é•¿åº¦</span></span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        <span class="comment">// 8. å†™å…¥å†…å®¹</span></span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">        outList.add(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magicNum</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">serializerType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        in.readBytes(bytes, <span class="number">0</span>, length);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, magicNum, version, serializerType, messageType, sequenceId, length);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, message);</span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-èŠå¤©å®¤æ¡ˆä¾‹"><a href="#3-èŠå¤©å®¤æ¡ˆä¾‹" class="headerlink" title="3. èŠå¤©å®¤æ¡ˆä¾‹"></a>3. èŠå¤©å®¤æ¡ˆä¾‹</h2><h3 id="3-1-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»"><a href="#3-1-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»" class="headerlink" title="3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»"></a>3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ç®¡ç†æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç™»å½•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password å¯†ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç™»å½•æˆåŠŸè¿”å› true, å¦åˆ™è¿”å› false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">login</span><span class="params">(String username, String password)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼šè¯ç®¡ç†æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Session</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç»‘å®šä¼šè¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel å“ªä¸ª channel è¦ç»‘å®šä¼šè¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username ä¼šè¯ç»‘å®šç”¨æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(Channel channel, String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§£ç»‘ä¼šè¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel å“ªä¸ª channel è¦è§£ç»‘ä¼šè¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unbind</span><span class="params">(Channel channel)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å±æ€§</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel å“ªä¸ª channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name å±æ€§å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å±æ€§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getAttribute</span><span class="params">(Channel channel, String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®å±æ€§</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel å“ªä¸ª channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name å±æ€§å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å±æ€§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setAttribute</span><span class="params">(Channel channel, String name, Object value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç”¨æˆ·åè·å– channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Channel <span class="title function_">getChannel</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠå¤©ç»„ä¼šè¯ç®¡ç†æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GroupSession</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºä¸€ä¸ªèŠå¤©ç»„, å¦‚æœä¸å­˜åœ¨æ‰èƒ½åˆ›å»ºæˆåŠŸ, å¦åˆ™è¿”å› null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> members æˆå‘˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆåŠŸæ—¶è¿”å›ç»„å¯¹è±¡, å¤±è´¥è¿”å› null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Group <span class="title function_">createGroup</span><span class="params">(String name, Set&lt;String&gt; members)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ å…¥èŠå¤©ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member æˆå‘˜å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Group <span class="title function_">joinMember</span><span class="params">(String name, String member)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤ç»„æˆå‘˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member æˆå‘˜å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Group <span class="title function_">removeMember</span><span class="params">(String name, String member)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤èŠå¤©ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Group <span class="title function_">removeGroup</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç»„æˆå‘˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆå‘˜é›†åˆ, æ²¡æœ‰æˆå‘˜ä¼šè¿”å› empty set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Set&lt;String&gt; <span class="title function_">getMembers</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç»„æˆå‘˜çš„ channel é›†åˆ, åªæœ‰åœ¨çº¿çš„ channel æ‰ä¼šè¿”å›</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç»„å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆå‘˜ channel é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Channel&gt; <span class="title function_">getMembersChannel</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•"><a href="#3-2-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•" class="headerlink" title="3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•"></a>3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            serverBootstrap.group(boss, worker);</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line">                    ch.pipeline().addLast(LOGGING_HANDLER);</span><br><span class="line">                    ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;LoginRequestMessage&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, LoginRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> msg.getUsername();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> msg.getPassword();</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">login</span> <span class="operator">=</span> UserServiceFactory.getUserService().login(username, password);</span><br><span class="line">                            LoginResponseMessage message;</span><br><span class="line">                            <span class="keyword">if</span>(login) &#123;</span><br><span class="line">                                message = <span class="keyword">new</span> <span class="title class_">LoginResponseMessage</span>(<span class="literal">true</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                message = <span class="keyword">new</span> <span class="title class_">LoginResponseMessage</span>(<span class="literal">false</span>, <span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            ctx.writeAndFlush(message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync().channel();</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">WAIT_FOR_LOGIN</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">AtomicBoolean</span> <span class="variable">LOGIN</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(group);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line"><span class="comment">//                    ch.pipeline().addLast(LOGGING_HANDLER);</span></span><br><span class="line">                    ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                    ch.pipeline().addLast(<span class="string">&quot;client handler&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                        <span class="comment">// æ¥æ”¶å“åº”æ¶ˆæ¯</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;msg: &#123;&#125;&quot;</span>, msg);</span><br><span class="line">                            <span class="keyword">if</span> ((msg <span class="keyword">instanceof</span> LoginResponseMessage)) &#123;</span><br><span class="line">                                <span class="type">LoginResponseMessage</span> <span class="variable">response</span> <span class="operator">=</span> (LoginResponseMessage) msg;</span><br><span class="line">                                <span class="keyword">if</span> (response.isSuccess()) &#123;</span><br><span class="line">                                    <span class="comment">// å¦‚æœç™»å½•æˆåŠŸ</span></span><br><span class="line">                                    LOGIN.set(<span class="literal">true</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// å”¤é†’ system in çº¿ç¨‹</span></span><br><span class="line">                                WAIT_FOR_LOGIN.countDown();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// åœ¨è¿æ¥å»ºç«‹åè§¦å‘ active äº‹ä»¶</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="comment">// è´Ÿè´£æ¥æ”¶ç”¨æˆ·åœ¨æ§åˆ¶å°çš„è¾“å…¥ï¼Œè´Ÿè´£å‘æœåŠ¡å™¨å‘é€å„ç§æ¶ˆæ¯</span></span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                                <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">                                System.out.println(<span class="string">&quot;è¯·è¾“å…¥ç”¨æˆ·å:&quot;</span>);</span><br><span class="line">                                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                                System.out.println(<span class="string">&quot;è¯·è¾“å…¥å¯†ç :&quot;</span>);</span><br><span class="line">                                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                                <span class="comment">// æ„é€ æ¶ˆæ¯å¯¹è±¡</span></span><br><span class="line">                                <span class="type">LoginRequestMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginRequestMessage</span>(username, password);</span><br><span class="line">                                <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                                ctx.writeAndFlush(message);</span><br><span class="line">                                System.out.println(<span class="string">&quot;ç­‰å¾…åç»­æ“ä½œ...&quot;</span>);</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    WAIT_FOR_LOGIN.await();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// å¦‚æœç™»å½•å¤±è´¥</span></span><br><span class="line">                                <span class="keyword">if</span> (!LOGIN.get()) &#123;</span><br><span class="line">                                    ctx.channel().close();</span><br><span class="line">                                    <span class="keyword">return</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                                    System.out.println(<span class="string">&quot;==================================&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;send [username] [content]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;gsend [group name] [content]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;gcreate [group name] [m1,m2,m3...]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;gmembers [group name]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;gjoin [group name]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;gquit [group name]&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;quit&quot;</span>);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;==================================&quot;</span>);</span><br><span class="line">                                    <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                                    String[] s = command.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                                    <span class="keyword">switch</span> (s[<span class="number">0</span>])&#123;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;send&quot;</span>:</span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">ChatRequestMessage</span>(username, s[<span class="number">1</span>], s[<span class="number">2</span>]));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;gsend&quot;</span>:</span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupChatRequestMessage</span>(username, s[<span class="number">1</span>], s[<span class="number">2</span>]));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;gcreate&quot;</span>:</span><br><span class="line">                                            Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(s[<span class="number">2</span>].split(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">                                            set.add(username); <span class="comment">// åŠ å…¥è‡ªå·±</span></span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupCreateRequestMessage</span>(s[<span class="number">1</span>], set));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;gmembers&quot;</span>:</span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupMembersRequestMessage</span>(s[<span class="number">1</span>]));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;gjoin&quot;</span>:</span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupJoinRequestMessage</span>(username, s[<span class="number">1</span>]));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;gquit&quot;</span>:</span><br><span class="line">                                            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupQuitRequestMessage</span>(username, s[<span class="number">1</span>]));</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        <span class="keyword">case</span> <span class="string">&quot;quit&quot;</span>:</span><br><span class="line">                                            ctx.channel().close();</span><br><span class="line">                                            <span class="keyword">return</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;, <span class="string">&quot;system in&quot;</span>).start();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>).sync().channel();</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ"><a href="#3-3-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ" class="headerlink" title="3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ"></a>3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</h3><p>æœåŠ¡å™¨ç«¯å°† handler ç‹¬ç«‹å‡ºæ¥</p><p>ç™»å½• handler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;LoginRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, LoginRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> msg.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> msg.getPassword();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">login</span> <span class="operator">=</span> UserServiceFactory.getUserService().login(username, password);</span><br><span class="line">        LoginResponseMessage message;</span><br><span class="line">        <span class="keyword">if</span>(login) &#123;</span><br><span class="line">            SessionFactory.getSession().bind(ctx.channel(), username);</span><br><span class="line">            message = <span class="keyword">new</span> <span class="title class_">LoginResponseMessage</span>(<span class="literal">true</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            message = <span class="keyword">new</span> <span class="title class_">LoginResponseMessage</span>(<span class="literal">false</span>, <span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.writeAndFlush(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å•èŠ handler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;ChatRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ChatRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">to</span> <span class="operator">=</span> msg.getTo();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> SessionFactory.getSession().getChannel(to);</span><br><span class="line">        <span class="comment">// åœ¨çº¿</span></span><br><span class="line">        <span class="keyword">if</span>(channel != <span class="literal">null</span>) &#123;</span><br><span class="line">            channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">ChatResponseMessage</span>(msg.getFrom(), msg.getContent()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸åœ¨çº¿</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">ChatResponseMessage</span>(<span class="literal">false</span>, <span class="string">&quot;å¯¹æ–¹ç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ä¸åœ¨çº¿&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ"><a href="#3-4-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ" class="headerlink" title="3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ"></a>3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</h3><p>åˆ›å»ºç¾¤èŠ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupCreateRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;GroupCreateRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, GroupCreateRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">groupName</span> <span class="operator">=</span> msg.getGroupName();</span><br><span class="line">        Set&lt;String&gt; members = msg.getMembers();</span><br><span class="line">        <span class="comment">// ç¾¤ç®¡ç†å™¨</span></span><br><span class="line">        <span class="type">GroupSession</span> <span class="variable">groupSession</span> <span class="operator">=</span> GroupSessionFactory.getGroupSession();</span><br><span class="line">        <span class="type">Group</span> <span class="variable">group</span> <span class="operator">=</span> groupSession.createGroup(groupName, members);</span><br><span class="line">        <span class="keyword">if</span> (group == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å‘ç”ŸæˆåŠŸæ¶ˆæ¯</span></span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupCreateResponseMessage</span>(<span class="literal">true</span>, groupName + <span class="string">&quot;åˆ›å»ºæˆåŠŸ&quot;</span>));</span><br><span class="line">            <span class="comment">// å‘é€æ‹‰ç¾¤æ¶ˆæ¯</span></span><br><span class="line">            List&lt;Channel&gt; channels = groupSession.getMembersChannel(groupName);</span><br><span class="line">            <span class="keyword">for</span> (Channel channel : channels) &#123;</span><br><span class="line">                channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupCreateResponseMessage</span>(<span class="literal">true</span>, <span class="string">&quot;æ‚¨å·²è¢«æ‹‰å…¥&quot;</span> + groupName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupCreateResponseMessage</span>(<span class="literal">false</span>, groupName + <span class="string">&quot;å·²ç»å­˜åœ¨&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¾¤èŠ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;GroupChatRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, GroupChatRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;Channel&gt; channels = GroupSessionFactory.getGroupSession()</span><br><span class="line">                .getMembersChannel(msg.getGroupName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Channel channel : channels) &#123;</span><br><span class="line">            channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupChatResponseMessage</span>(msg.getFrom(), msg.getContent()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ å…¥ç¾¤èŠ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupJoinRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;GroupJoinRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, GroupJoinRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Group</span> <span class="variable">group</span> <span class="operator">=</span> GroupSessionFactory.getGroupSession().joinMember(msg.getGroupName(), msg.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (group != <span class="literal">null</span>) &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupJoinResponseMessage</span>(<span class="literal">true</span>, msg.getGroupName() + <span class="string">&quot;ç¾¤åŠ å…¥æˆåŠŸ&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupJoinResponseMessage</span>(<span class="literal">true</span>, msg.getGroupName() + <span class="string">&quot;ç¾¤ä¸å­˜åœ¨&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€€å‡ºç¾¤èŠ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupQuitRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;GroupQuitRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, GroupQuitRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Group</span> <span class="variable">group</span> <span class="operator">=</span> GroupSessionFactory.getGroupSession().removeMember(msg.getGroupName(), msg.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (group != <span class="literal">null</span>) &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupJoinResponseMessage</span>(<span class="literal">true</span>, <span class="string">&quot;å·²é€€å‡ºç¾¤&quot;</span> + msg.getGroupName()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupJoinResponseMessage</span>(<span class="literal">true</span>, msg.getGroupName() + <span class="string">&quot;ç¾¤ä¸å­˜åœ¨&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æˆå‘˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupMembersRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;GroupMembersRequestMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, GroupMembersRequestMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Set&lt;String&gt; members = GroupSessionFactory.getGroupSession()</span><br><span class="line">                .getMembers(msg.getGroupName());</span><br><span class="line">        ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">GroupMembersResponseMessage</span>(members));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º"><a href="#3-5-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º" class="headerlink" title="3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º"></a>3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@ChannelHandler.Sharable</span><br><span class="line">public class QuitHandler extends ChannelInboundHandlerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    // å½“è¿æ¥æ–­å¼€æ—¶è§¦å‘ inactive äº‹ä»¶</span><br><span class="line">    @Override</span><br><span class="line">    public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">        SessionFactory.getSession().unbind(ctx.channel());</span><br><span class="line">        log.debug(&quot;&#123;&#125; å·²ç»æ–­å¼€&quot;, ctx.channel());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// å½“å‡ºç°å¼‚å¸¸æ—¶è§¦å‘</span><br><span class="line">    @Override</span><br><span class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</span><br><span class="line">        SessionFactory.getSession().unbind(ctx.channel());</span><br><span class="line">        log.debug(&quot;&#123;&#125; å·²ç»å¼‚å¸¸æ–­å¼€ å¼‚å¸¸æ˜¯&#123;&#125;&quot;, ctx.channel(), cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-6-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹"><a href="#3-6-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹" class="headerlink" title="3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹"></a>3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</h3><h4 id="è¿æ¥å‡æ­»"><a href="#è¿æ¥å‡æ­»" class="headerlink" title="è¿æ¥å‡æ­»"></a>è¿æ¥å‡æ­»</h4><p>åŸå› </p><ul><li>ç½‘ç»œè®¾å¤‡å‡ºç°æ•…éšœï¼Œä¾‹å¦‚ç½‘å¡ï¼Œæœºæˆ¿ç­‰ï¼Œåº•å±‚çš„ TCP è¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä½†åº”ç”¨ç¨‹åºæ²¡æœ‰æ„ŸçŸ¥åˆ°ï¼Œä»ç„¶å ç”¨ç€èµ„æºã€‚</li><li>å…¬ç½‘ç½‘ç»œä¸ç¨³å®šï¼Œå‡ºç°ä¸¢åŒ…ã€‚å¦‚æœè¿ç»­å‡ºç°ä¸¢åŒ…ï¼Œè¿™æ—¶ç°è±¡å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œå°±è¿™ä¹ˆä¸€ç›´è€—ç€</li><li>åº”ç”¨ç¨‹åºçº¿ç¨‹é˜»å¡ï¼Œæ— æ³•è¿›è¡Œæ•°æ®è¯»å†™</li></ul><p>é—®é¢˜</p><ul><li>å‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾</li><li>å‘å‡æ­»çš„è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶</li></ul><p>æœåŠ¡å™¨ç«¯è§£å†³</p><ul><li>æ€ä¹ˆåˆ¤æ–­å®¢æˆ·ç«¯è¿æ¥æ˜¯å¦å‡æ­»å‘¢ï¼Ÿå¦‚æœèƒ½æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œè¯´æ˜æ²¡æœ‰å‡æ­»ã€‚å› æ­¤ç­–ç•¥å°±å¯ä»¥å®šä¸ºï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿</span></span><br><span class="line"><span class="comment">// 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶</span></span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨</span></span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelDuplexHandler</span>() &#123;</span><br><span class="line">    <span class="comment">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">        <span class="comment">// è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (event.state() == IdleState.READER_IDLE) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†&quot;</span>);</span><br><span class="line">            ctx.channel().close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³</p><ul><li>å®¢æˆ·ç«¯å¯ä»¥å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶é—´é—´éš”å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”ï¼Œé‚£ä¹ˆå°±èƒ½é˜²æ­¢å‰é¢æåˆ°çš„è¯¯åˆ¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥å®šä¹‰å¦‚ä¸‹å¿ƒè·³å¤„ç†å™¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿</span></span><br><span class="line"><span class="comment">// 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶</span></span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨</span></span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelDuplexHandler</span>() &#123;</span><br><span class="line">    <span class="comment">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">        <span class="comment">// è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (event.state() == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">            <span class="comment">//                                log.debug(&quot;3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œå‘é€ä¸€ä¸ªå¿ƒè·³åŒ…&quot;);</span></span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">PingMessage</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">RPCæ¡†æ¶ï¼ŒNettyå®æˆ˜</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="netty" scheme="https://www.jodio.cc/tags/netty/"/>
    
  </entry>
  
  <entry>
    <title>Netty(äºŒ) -- å…¥é—¨ç¯‡</title>
    <link href="https://www.jodio.cc/posts/netty.html"/>
    <id>https://www.jodio.cc/posts/netty.html</id>
    <published>2023-04-21T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="äºŒ-Netty-å…¥é—¨"><a href="#äºŒ-Netty-å…¥é—¨" class="headerlink" title="äºŒ. Netty å…¥é—¨"></a>äºŒ. Netty å…¥é—¨</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><h3 id="1-1-Netty-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-1-Netty-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Netty is an asynchronous event-driven network application framework</span><br><span class="line">for rapid development of maintainable high performance protocol servers &amp; clients.</span><br></pre></td></tr></table></figure><p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p><h3 id="1-2-Netty-çš„ä½œè€…"><a href="#1-2-Netty-çš„ä½œè€…" class="headerlink" title="1.2 Netty çš„ä½œè€…"></a>1.2 Netty çš„ä½œè€…</h3><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0005.png" alt=""></p><p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…</p><h3 id="1-3-Netty-çš„åœ°ä½"><a href="#1-3-Netty-çš„åœ°ä½" class="headerlink" title="1.3 Netty çš„åœ°ä½"></a>1.3 Netty çš„åœ°ä½</h3><p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p><p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p><ul><li>Cassandra - nosql æ•°æ®åº“</li><li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</li><li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶</li><li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li><li>ElasticSearch - æœç´¢å¼•æ“</li><li>gRPC - rpc æ¡†æ¶</li><li>Dubbo - rpc æ¡†æ¶</li><li>Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li><li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li></ul><h3 id="1-4-Netty-çš„ä¼˜åŠ¿"><a href="#1-4-Netty-çš„ä¼˜åŠ¿" class="headerlink" title="1.4 Netty çš„ä¼˜åŠ¿"></a>1.4 Netty çš„ä¼˜åŠ¿</h3><ul><li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š<ul><li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li><li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li><li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li><li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal =&gt; ThreadLocalï¼ŒByteBuf =&gt; ByteBuffer</li></ul></li><li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶<ul><li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li><li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬<ul><li>2.x 2004</li><li>3.x 2008</li><li>4.x 2013</li><li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li></ul></li></ul></li></ul><h2 id="2-Hello-World"><a href="#2-Hello-World" class="headerlink" title="2. Hello World"></a>2. Hello World</h2><h3 id="2-1-ç›®æ ‡"><a href="#2-1-ç›®æ ‡" class="headerlink" title="2.1 ç›®æ ‡"></a>2.1 ç›®æ ‡</h3><p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p><ul><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li><li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li></ul><p>åŠ å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.39.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-æœåŠ¡å™¨ç«¯"><a href="#2-2-æœåŠ¡å™¨ç«¯" class="headerlink" title="2.2 æœåŠ¡å™¨ç«¯"></a>2.2 æœåŠ¡å™¨ç«¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>()) <span class="comment">// 1</span></span><br><span class="line">    .channel(NioServerSocketChannel.class) <span class="comment">// 2</span></span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123; <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>()); <span class="comment">// 5</span></span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;String&gt;() &#123; <span class="comment">// 6</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> &#123;</span><br><span class="line">                    System.out.println(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .bind(<span class="number">8080</span>); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure><p>ä»£ç è§£è¯»</p><ul><li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code>çº¿ç¨‹æ±  + Selector</code> åé¢ä¼šè¯¦ç»†å±•å¼€</p></li><li><p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0006.png" alt=""></p></li><li><p>3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p></li><li><p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£</p></li><li><p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf =&gt; String</p></li><li><p>6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ</p></li></ul><h3 id="2-3-å®¢æˆ·ç«¯"><a href="#2-3-å®¢æˆ·ç«¯" class="headerlink" title="2.3 å®¢æˆ·ç«¯"></a>2.3 å®¢æˆ·ç«¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>()) <span class="comment">// 1</span></span><br><span class="line">    .channel(NioSocketChannel.class) <span class="comment">// 2</span></span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123; <span class="comment">// 3</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>()); <span class="comment">// 8</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>) <span class="comment">// 4</span></span><br><span class="line">    .sync() <span class="comment">// 5</span></span><br><span class="line">    .channel() <span class="comment">// 6</span></span><br><span class="line">    .writeAndFlush(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;: hello world!&quot;</span>); <span class="comment">// 7</span></span><br></pre></td></tr></table></figure><p>ä»£ç è§£è¯»</p><ul><li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p></li><li><p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0007.png" alt=""></p></li><li><p>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p></li><li>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</li><li>5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</li><li>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</li><li>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</li><li>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String =&gt; ByteBuf å‘å‡º</li><li>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</li></ul><h3 id="2-4-æµç¨‹æ¢³ç†"><a href="#2-4-æµç¨‹æ¢³ç†" class="headerlink" title="2.4 æµç¨‹æ¢³ç†"></a>2.4 æµç¨‹æ¢³ç†</h3><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0040.png" alt=""></p><h4 id="ğŸ’¡-æç¤º"><a href="#ğŸ’¡-æç¤º" class="headerlink" title="ğŸ’¡ æç¤º"></a>ğŸ’¡ æç¤º</h4><blockquote><p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p><ul><li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li><li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li><li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº<ul><li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li><li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li></ul></li><li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº<ul><li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li><li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li><li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li></ul></li></ul></blockquote><h2 id="3-ç»„ä»¶"><a href="#3-ç»„ä»¶" class="headerlink" title="3. ç»„ä»¶"></a>3. ç»„ä»¶</h2><h3 id="3-1-EventLoop"><a href="#3-1-EventLoop" class="headerlink" title="3.1 EventLoop"></a>3.1 EventLoop</h3><p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p><p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚</p><p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚</p><ul><li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li><li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ<ul><li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop</li><li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup</li></ul></li></ul><p>äº‹ä»¶å¾ªç¯ç»„</p><p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰</p><ul><li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup<ul><li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li><li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li></ul></li></ul><p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="type">DefaultEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line">System.out.println(group.next());</span><br><span class="line">System.out.println(group.next());</span><br><span class="line">System.out.println(group.next());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io.netty.channel.DefaultEventLoop@60f82f98</span><br><span class="line">io.netty.channel.DefaultEventLoop@35f983a6</span><br><span class="line">io.netty.channel.DefaultEventLoop@60f82f98</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">for</span> (EventExecutor eventLoop : group) &#123;</span><br><span class="line">    System.out.println(eventLoop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io.netty.channel.DefaultEventLoop@60f82f98</span><br><span class="line">io.netty.channel.DefaultEventLoop@35f983a6</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-ä¼˜é›…å…³é—­"><a href="#ğŸ’¡-ä¼˜é›…å…³é—­" class="headerlink" title="ğŸ’¡ ä¼˜é›…å…³é—­"></a>ğŸ’¡ ä¼˜é›…å…³é—­</h4><p>ä¼˜é›…å…³é—­ <code>shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ <code>EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p><h4 id="æ¼”ç¤º-NioEventLoop-å¤„ç†-io-äº‹ä»¶"><a href="#æ¼”ç¤º-NioEventLoop-å¤„ç†-io-äº‹ä»¶" class="headerlink" title="æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶"></a>æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4><p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>))</span><br><span class="line">    .channel(NioServerSocketChannel.class)</span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> msg <span class="keyword">instanceof</span> ByteBuf ? ((ByteBuf) msg) : <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (byteBuf != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];</span><br><span class="line">                        <span class="type">ByteBuf</span> <span class="variable">len</span> <span class="operator">=</span> byteBuf.readBytes(buf, <span class="number">0</span>, byteBuf.readableBytes());</span><br><span class="line">                        log.debug(<span class="keyword">new</span> <span class="title class_">String</span>(buf));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).bind(<span class="number">8080</span>).sync();</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">            .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>))</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .channel(NioSocketChannel.class).connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>)</span><br><span class="line">            .sync()</span><br><span class="line">            .channel();</span><br><span class="line"></span><br><span class="line">    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(<span class="string">&quot;wangwu&quot;</span>.getBytes()));</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(<span class="string">&quot;wangwu&quot;</span>.getBytes()));</span><br></pre></td></tr></table></figure><p>æœ€åè¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       </span><br><span class="line">22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       </span><br><span class="line">22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           </span><br><span class="line">22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           </span><br><span class="line">22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        </span><br><span class="line">22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0042.png" alt=""></p><p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoopGroup</span> <span class="variable">normalWorkers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>), <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>))</span><br><span class="line">    .channel(NioServerSocketChannel.class)</span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span>  &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">            ch.pipeline().addLast(normalWorkers,<span class="string">&quot;myhandler&quot;</span>,</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> msg <span class="keyword">instanceof</span> ByteBuf ? ((ByteBuf) msg) : <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (byteBuf != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];</span><br><span class="line">                        <span class="type">ByteBuf</span> <span class="variable">len</span> <span class="operator">=</span> byteBuf.readBytes(buf, <span class="number">0</span>, byteBuf.readableBytes());</span><br><span class="line">                        log.debug(<span class="keyword">new</span> <span class="title class_">String</span>(buf));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).bind(<span class="number">8080</span>).sync();</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] REGISTERED</span><br><span class="line">22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] ACTIVE</span><br><span class="line">22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE</span><br><span class="line">22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        </span><br><span class="line">22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE</span><br><span class="line">22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        </span><br><span class="line">22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] REGISTERED</span><br><span class="line">22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] ACTIVE</span><br><span class="line">22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6c 69 73 69                                     |lisi            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE</span><br><span class="line">22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            </span><br><span class="line">22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6c 69 73 69                                     |lisi            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE</span><br><span class="line">22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            </span><br><span class="line">22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] REGISTERED</span><br><span class="line">22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] ACTIVE</span><br><span class="line">22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 77 61 6e 67 77 75                               |wangwu          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE</span><br><span class="line">22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          </span><br><span class="line">22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 77 61 6e 67 77 75                               |wangwu          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE</span><br><span class="line">22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0041.png" alt=""></p><h4 id="ğŸ’¡-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ"><a href="#ğŸ’¡-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ" class="headerlink" title="ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ"></a>ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeChannelRead</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next, Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> next.pipeline.touch(ObjectUtil.checkNotNull(msg, <span class="string">&quot;msg&quot;</span>), next);</span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> next.executor();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜¯ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        next.invokeChannelRead(m);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                next.invokeChannelRead(m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</li><li>å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</li></ul><h4 id="æ¼”ç¤º-NioEventLoop-å¤„ç†æ™®é€šä»»åŠ¡"><a href="#æ¼”ç¤º-NioEventLoop-å¤„ç†æ™®é€šä»»åŠ¡" class="headerlink" title="æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡"></a>æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4><p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">nioWorkers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;server start...&quot;</span>);</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">nioWorkers.execute(()-&gt;&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;normal task...&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...</span><br><span class="line">22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...</span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p></blockquote><h4 id="æ¼”ç¤º-NioEventLoop-å¤„ç†å®šæ—¶ä»»åŠ¡"><a href="#æ¼”ç¤º-NioEventLoop-å¤„ç†å®šæ—¶ä»»åŠ¡" class="headerlink" title="æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡"></a>æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">nioWorkers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;server start...&quot;</span>);</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">nioWorkers.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running...&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...</span><br><span class="line">22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...</span><br><span class="line">22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...</span><br><span class="line">22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...</span><br><span class="line">22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p></blockquote><h3 id="3-2-Channel"><a href="#3-2-Channel" class="headerlink" title="3.2 Channel"></a>3.2 Channel</h3><p>channel çš„ä¸»è¦ä½œç”¨</p><ul><li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li><li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­<ul><li>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</li><li>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</li></ul></li><li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li><li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li><li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º</li></ul><h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a>ChannelFuture</h4><p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span><br><span class="line">    .sync()</span><br><span class="line">    .channel()</span><br><span class="line">    .writeAndFlush(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;: hello world!&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">channelFuture.sync().channel().writeAndFlush(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot;: hello world!&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</li></ul><p><strong>æ³¨æ„</strong> connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡</p><p>å®éªŒå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(channelFuture.channel()); <span class="comment">// 1</span></span><br><span class="line">channelFuture.sync(); <span class="comment">// 2</span></span><br><span class="line">System.out.println(channelFuture.channel()); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x2e1884dd]</code></li><li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ</li><li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li></ul><p>é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">System.out.println(channelFuture.channel()); <span class="comment">// 1</span></span><br><span class="line">channelFuture.addListener((ChannelFutureListener) future -&gt; &#123;</span><br><span class="line">    System.out.println(future.channel()); <span class="comment">// 2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x749124ba]</code></li><li>ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li></ul><h4 id="CloseFuture"><a href="#CloseFuture" class="headerlink" title="CloseFuture"></a>CloseFuture</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CloseFutureClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        NioEventLoopGroup group <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                .group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span> <span class="comment">// åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG));</span><br><span class="line">                        ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.sync().channel();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, channel);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;q&quot;</span>.equals(line)) &#123;</span><br><span class="line">                    channel.close(); <span class="comment">// close å¼‚æ­¥æ“ä½œ 1s ä¹‹å</span></span><br><span class="line"><span class="comment">//                    log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;); // ä¸èƒ½åœ¨è¿™é‡Œå–„å</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                channel.writeAndFlush(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;input&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">closeFuture</span> <span class="operator">=</span> channel.closeFuture();</span><br><span class="line">        <span class="comment">/*log.debug(&quot;waiting close...&quot;);</span></span><br><span class="line"><span class="comment">        closeFuture.sync();</span></span><br><span class="line"><span class="comment">        log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;);*/</span></span><br><span class="line">        closeFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;</span>);</span><br><span class="line">                group.shutdownGracefully();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ"><a href="#ğŸ’¡-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ" class="headerlink" title="ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ"></a>ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ</h4><ul><li><p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</p></li><li><p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p></li></ul><p>æ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š<code>4 * 8 * 3 = 96</code></p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0044.png" alt=""></p><p>ç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0048.png" alt=""></p><p>å› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† <code>4 * 8 * 12</code> æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0047.png" alt=""></p><p>è¦ç‚¹</p><ul><li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</li><li>å¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ </li><li>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li></ul><h3 id="3-3-Future-amp-Promise"><a href="#3-3-Future-amp-Promise" class="headerlink" title="3.3 Future &amp; Promise"></a>3.3 Future &amp; Promise</h3><p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p><p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</p><ul><li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li><li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ</li><li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</li></ul><div class="table-container"><table><thead><tr><th>åŠŸèƒ½/åç§°</th><th>jdk Future</th><th>netty Future</th><th>Promise</th></tr></thead><tbody><tr><td>cancel</td><td>å–æ¶ˆä»»åŠ¡</td><td>-</td><td>-</td></tr><tr><td>isCanceled</td><td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td><td>-</td><td>-</td></tr><tr><td>isDone</td><td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td><td>-</td><td>-</td></tr><tr><td>get</td><td>è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…</td><td>-</td><td>-</td></tr><tr><td>getNow</td><td>-</td><td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</td><td>-</td></tr><tr><td>await</td><td>-</td><td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­</td><td>-</td></tr><tr><td>sync</td><td>-</td><td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</td><td>-</td></tr><tr><td>isSuccess</td><td>-</td><td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td><td>-</td></tr><tr><td>cause</td><td>-</td><td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null</td><td>-</td></tr><tr><td>addLinstener</td><td>-</td><td>æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</td><td>-</td></tr><tr><td>setSuccess</td><td>-</td><td>-</td><td>è®¾ç½®æˆåŠŸç»“æœ</td></tr><tr><td>setFailure</td><td>-</td><td>-</td><td>è®¾ç½®å¤±è´¥ç»“æœ</td></tr></tbody></table></div><h4 id="ä¾‹1"><a href="#ä¾‹1" class="headerlink" title="ä¾‹1"></a>ä¾‹1</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line">eventExecutors.execute(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;set success, &#123;&#125;&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    promise.setSuccess(<span class="number">10</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,promise.getNow()); <span class="comment">// è¿˜æ²¡æœ‰ç»“æœ</span></span><br><span class="line">log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,promise.get());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...</span><br><span class="line">11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null</span><br><span class="line">11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10</span><br><span class="line">11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10</span><br></pre></td></tr></table></figure><h4 id="ä¾‹2"><a href="#ä¾‹2" class="headerlink" title="ä¾‹2"></a>ä¾‹2</h4><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</span></span><br><span class="line">promise.addListener(future -&gt; &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise</span></span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,future.getNow());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ</span></span><br><span class="line">eventExecutors.execute(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;set success, &#123;&#125;&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    promise.setSuccess(<span class="number">10</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...</span><br><span class="line">11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10</span><br><span class="line">11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10</span><br></pre></td></tr></table></figure><h4 id="ä¾‹3"><a href="#ä¾‹3" class="headerlink" title="ä¾‹3"></a>ä¾‹3</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">        DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line">        eventExecutors.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;error...&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;set failure, &#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">            promise.setFailure(e);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, promise.getNow());</span><br><span class="line">        promise.get(); <span class="comment">// sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...</span><br><span class="line">12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null</span><br><span class="line">12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...</span><br><span class="line">Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...</span><br><span class="line">at io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)</span><br><span class="line">at com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)</span><br><span class="line">Caused by: java.lang.RuntimeException: error...</span><br><span class="line">at com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)</span><br><span class="line">at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)</span><br><span class="line">at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure><h4 id="ä¾‹4"><a href="#ä¾‹4" class="headerlink" title="ä¾‹4"></a>ä¾‹4</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line">eventExecutors.execute(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;error...&quot;</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;set failure, &#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">    promise.setFailure(e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, promise.getNow());</span><br><span class="line">promise.await(); <span class="comment">// ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸</span></span><br><span class="line">log.debug(<span class="string">&quot;result &#123;&#125;&quot;</span>, (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...</span><br><span class="line">12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null</span><br><span class="line">12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...</span><br><span class="line">12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...</span><br></pre></td></tr></table></figure><h4 id="ä¾‹5"><a href="#ä¾‹5" class="headerlink" title="ä¾‹5"></a>ä¾‹5</h4><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line">promise.addListener(future -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;result &#123;&#125;&quot;</span>, (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">eventExecutors.execute(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;error...&quot;</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;set failure, &#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">    promise.setFailure(e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;start...&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...</span><br><span class="line">12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...</span><br><span class="line">12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...</span><br></pre></td></tr></table></figure><h4 id="ä¾‹6"><a href="#ä¾‹6" class="headerlink" title="ä¾‹6"></a>ä¾‹6</h4><p>await æ­»é”æ£€æŸ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultEventLoop</span> <span class="variable">eventExecutors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>();</span><br><span class="line">DefaultPromise&lt;Integer&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(eventExecutors);</span><br><span class="line"></span><br><span class="line">eventExecutors.submit(()-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        promise.await();</span><br><span class="line">        <span class="comment">// æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­</span></span><br><span class="line">        <span class="comment">// è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">eventExecutors.submit(()-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        promise.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)</span><br><span class="line">at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)</span><br><span class="line">at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)</span><br><span class="line">at com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)</span><br><span class="line">at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)</span><br><span class="line">at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)</span><br><span class="line">at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)</span><br><span class="line">at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br><span class="line">io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)</span><br><span class="line">at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)</span><br><span class="line">at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)</span><br><span class="line">at com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)</span><br><span class="line">at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)</span><br><span class="line">at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)</span><br><span class="line">at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)</span><br><span class="line">at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)</span><br><span class="line">at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)</span><br><span class="line">at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-4-Handler-amp-Pipeline"><a href="#3-4-Handler-amp-Pipeline" class="headerlink" title="3.4 Handler &amp; Pipeline"></a>3.4 Handler &amp; Pipeline</h3><p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p><ul><li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li><li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</li></ul><p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p><p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioServerSocketChannel.class)</span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">1</span>);</span><br><span class="line">                    ctx.fireChannelRead(msg); <span class="comment">// 1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">2</span>);</span><br><span class="line">                    ctx.fireChannelRead(msg); <span class="comment">// 2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">3</span>);</span><br><span class="line">                    ctx.channel().write(msg); <span class="comment">// 3</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, </span></span><br><span class="line"><span class="params">                                  ChannelPromise promise)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">4</span>);</span><br><span class="line">                    ctx.write(msg, promise); <span class="comment">// 4</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, </span></span><br><span class="line"><span class="params">                                  ChannelPromise promise)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">5</span>);</span><br><span class="line">                    ctx.write(msg, promise); <span class="comment">// 5</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, </span></span><br><span class="line"><span class="params">                                  ChannelPromise promise)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="number">6</span>);</span><br><span class="line">                    ctx.write(msg, promise); <span class="comment">// 6</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .bind(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span><br><span class="line">    .addListener((ChannelFutureListener) future -&gt; &#123;</span><br><span class="line">        future.channel().writeAndFlush(<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">6</span><br><span class="line">5</span><br><span class="line">4</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0008.png" alt=""></p><ul><li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong><ul><li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li><li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li></ul></li><li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ<ul><li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li></ul></li><li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong><ul><li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li></ul></li><li>ctx.channel().write(msg) vs ctx.write(msg)<ul><li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li><li>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</li><li>ctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</li><li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li><li>6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6â€¦ å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</li></ul></li></ul><p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0009.png" alt=""></p><h3 id="3-5-ByteBuf"><a href="#3-5-ByteBuf" class="headerlink" title="3.5 ByteBuf"></a>3.5 ByteBuf</h3><p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p><h4 id="1ï¼‰åˆ›å»º"><a href="#1ï¼‰åˆ›å»º" class="headerlink" title="1ï¼‰åˆ›å»º"></a>1ï¼‰åˆ›å»º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">10</span>);</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read index:0 write index:0 capacity:10</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(ByteBuf buffer)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> buffer.readableBytes();</span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> length / <span class="number">16</span> + (length % <span class="number">15</span> == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>) + <span class="number">4</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(rows * <span class="number">80</span> * <span class="number">2</span>)</span><br><span class="line">        .append(<span class="string">&quot;read index:&quot;</span>).append(buffer.readerIndex())</span><br><span class="line">        .append(<span class="string">&quot; write index:&quot;</span>).append(buffer.writerIndex())</span><br><span class="line">        .append(<span class="string">&quot; capacity:&quot;</span>).append(buffer.capacity())</span><br><span class="line">        .append(NEWLINE);</span><br><span class="line">    appendPrettyHexDump(buf, buffer);</span><br><span class="line">    System.out.println(buf.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2ï¼‰ç›´æ¥å†…å­˜-vs-å †å†…å­˜"><a href="#2ï¼‰ç›´æ¥å†…å­˜-vs-å †å†…å­˜" class="headerlink" title="2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜"></a>2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.heapBuffer(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.directBuffer(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><ul><li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li><li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</li></ul><h4 id="3ï¼‰æ± åŒ–-vs-éæ± åŒ–"><a href="#3ï¼‰æ± åŒ–-vs-éæ± åŒ–" class="headerlink" title="3ï¼‰æ± åŒ– vs éæ± åŒ–"></a>3ï¼‰æ± åŒ– vs éæ± åŒ–</h4><p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p><ul><li>æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›</li><li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li><li>é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li></ul><p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dio.netty.allocator.type=&#123;unpooled|pooled&#125;</span><br></pre></td></tr></table></figure><ul><li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li><li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li></ul><h4 id="4ï¼‰ç»„æˆ"><a href="#4ï¼‰ç»„æˆ" class="headerlink" title="4ï¼‰ç»„æˆ"></a>4ï¼‰ç»„æˆ</h4><p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0010.png" alt=""></p><p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®</p><h4 id="5ï¼‰å†™å…¥"><a href="#5ï¼‰å†™å…¥" class="headerlink" title="5ï¼‰å†™å…¥"></a>5ï¼‰å†™å…¥</h4><p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p><div class="table-container"><table><thead><tr><th>æ–¹æ³•ç­¾å</th><th>å«ä¹‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>writeBoolean(boolean value)</td><td>å†™å…¥ boolean å€¼</td><td>ç”¨ä¸€å­—èŠ‚ 01\</td><td>00 ä»£è¡¨ true\</td><td>false</td></tr><tr><td>writeByte(int value)</td><td>å†™å…¥ byte å€¼</td><td></td></tr><tr><td>writeShort(int value)</td><td>å†™å…¥ short å€¼</td><td></td></tr><tr><td>writeInt(int value)</td><td>å†™å…¥ int å€¼</td><td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td></tr><tr><td>writeIntLE(int value)</td><td>å†™å…¥ int å€¼</td><td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td></tr><tr><td>writeLong(long value)</td><td>å†™å…¥ long å€¼</td><td></td></tr><tr><td>writeChar(int value)</td><td>å†™å…¥ char å€¼</td><td></td></tr><tr><td>writeFloat(float value)</td><td>å†™å…¥ float å€¼</td><td></td></tr><tr><td>writeDouble(double value)</td><td>å†™å…¥ double å€¼</td><td></td></tr><tr><td>writeBytes(ByteBuf src)</td><td>å†™å…¥ netty çš„ ByteBuf</td><td></td></tr><tr><td>writeBytes(byte[] src)</td><td>å†™å…¥ byte[]</td><td></td></tr><tr><td>writeBytes(ByteBuffer src)</td><td>å†™å…¥ nio çš„ ByteBuffer</td><td></td></tr><tr><td>int writeCharSequence(CharSequence sequence, Charset charset)</td><td>å†™å…¥å­—ç¬¦ä¸²</td></tr></tbody></table></div><blockquote><p>æ³¨æ„</p><ul><li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</li><li>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</li></ul></blockquote><p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buffer.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read index:0 write index:4 capacity:10</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04                                     |....            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buffer.writeInt(<span class="number">5</span>);</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read index:0 write index:8 capacity:10</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 00 00 00 05                         |........        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</p><h4 id="6ï¼‰æ‰©å®¹"><a href="#6ï¼‰æ‰©å®¹" class="headerlink" title="6ï¼‰æ‰©å®¹"></a>6ï¼‰æ‰©å®¹</h4><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buffer.writeInt(<span class="number">6</span>);</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>æ‰©å®¹è§„åˆ™æ˜¯</p><ul><li>å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li><li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li><li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li></ul><p>ç»“æœæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read index:0 write index:12 capacity:16</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h4 id="7ï¼‰è¯»å–"><a href="#7ï¼‰è¯»å–" class="headerlink" title="7ï¼‰è¯»å–"></a>7ï¼‰è¯»å–</h4><p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(buffer.readByte());</span><br><span class="line">System.out.println(buffer.readByte());</span><br><span class="line">System.out.println(buffer.readByte());</span><br><span class="line">System.out.println(buffer.readByte());</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">read index:4 write index:12 capacity:16</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 00 00 05 00 00 00 06                         |........        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ</p><p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° mark</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buffer.markReaderIndex();</span><br><span class="line">System.out.println(buffer.readInt());</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">read index:8 write index:12 capacity:16</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 00 00 06                                     |....            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buffer.resetReaderIndex();</span><br><span class="line">log(buffer);</span><br></pre></td></tr></table></figure><p>è¿™æ—¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read index:4 write index:12 capacity:16</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 00 00 00 05 00 00 00 06                         |........        |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</p><h4 id="8ï¼‰retain-amp-release"><a href="#8ï¼‰retain-amp-release" class="headerlink" title="8ï¼‰retain &amp; release"></a>8ï¼‰retain &amp; release</h4><p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p><ul><li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯</li><li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li><li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li></ul><blockquote><p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°</p><p><code>protected abstract void deallocate()</code></p></blockquote><p>Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</p><ul><li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li><li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li><li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li><li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li></ul><p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p><p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> ...</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    buf.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p><p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ<strong>è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release</strong>ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p><ul><li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li><li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™<ul><li>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release</li><li>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</li><li>å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</li><li>æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li><li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</li></ul></li><li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™<ul><li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release</li></ul></li><li>å¼‚å¸¸å¤„ç†åŸåˆ™<ul><li>æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</li></ul></li></ul><p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onUnhandledInboundMessage</span><span class="params">(Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        logger.debug(</span><br><span class="line">            <span class="string">&quot;Discarded inbound message &#123;&#125; that reached at the tail of the pipeline. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;Please check your pipeline configuration.&quot;</span>, msg);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ReferenceCountUtil.release(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.netty.util.ReferenceCountUtil#release(java.lang.Object)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(Object msg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ReferenceCounted) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ReferenceCounted) msg).release();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9ï¼‰slice"><a href="#9ï¼‰slice" class="headerlink" title="9ï¼‰slice"></a>9ï¼‰slice</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0011.png" alt=""></p><p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">origin</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">10</span>);</span><br><span class="line">origin.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">origin.readByte();</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(origin));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 02 03 04                                        |...             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">slice</span> <span class="operator">=</span> origin.slice();</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(slice));</span><br><span class="line"><span class="comment">// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 02 03 04                                        |...             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">origin.readByte();</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(origin));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 03 04                                           |..              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ByteBufUtil.prettyHexDump(slice));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 02 03 04                                        |...             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slice.setByte(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(slice));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 02 03 05                                        |...             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ByteBufUtil.prettyHexDump(origin));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 03 05                                           |..              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h4 id="10ï¼‰duplicate"><a href="#10ï¼‰duplicate" class="headerlink" title="10ï¼‰duplicate"></a>10ï¼‰duplicate</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0012.png" alt=""></p><h4 id="11ï¼‰copy"><a href="#11ï¼‰copy" class="headerlink" title="11ï¼‰copy"></a>11ï¼‰copy</h4><p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</p><h4 id="12ï¼‰CompositeByteBuf"><a href="#12ï¼‰CompositeByteBuf" class="headerlink" title="12ï¼‰CompositeByteBuf"></a>12ï¼‰CompositeByteBuf</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p><p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf1</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf1.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;);</span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf2</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf2.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;);</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(buf1));</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(buf2));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 05                                  |.....           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 06 07 08 09 0a                                  |.....           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p><p>æ–¹æ³•1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf3</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT</span><br><span class="line">    .buffer(buf1.readableBytes()+buf2.readableBytes());</span><br><span class="line">buf3.writeBytes(buf1);</span><br><span class="line">buf3.writeBytes(buf2);</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(buf3));</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ</p><p>æ–¹æ³•2ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CompositeByteBuf</span> <span class="variable">buf3</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.compositeBuffer();</span><br><span class="line"><span class="comment">// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0</span></span><br><span class="line">buf3.addComponents(<span class="literal">true</span>, buf1, buf2);</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯ä¸€æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</p><ul><li>ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li><li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li></ul><h4 id="13ï¼‰Unpooled"><a href="#13ï¼‰Unpooled" class="headerlink" title="13ï¼‰Unpooled"></a>13ï¼‰Unpooled</h4><p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p><p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf1</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf1.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;);</span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf2</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</span><br><span class="line">buf2.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf</span></span><br><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf3</span> <span class="operator">=</span> Unpooled.wrappedBuffer(buf1, buf2);</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(buf3));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuf</span> <span class="variable">buf4</span> <span class="operator">=</span> Unpooled.wrappedBuffer(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;, <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;);</span><br><span class="line">System.out.println(buf4.getClass());</span><br><span class="line">System.out.println(ByteBufUtil.prettyHexDump(buf4));</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class io.netty.buffer.CompositeByteBuf</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 01 02 03 04 05 06                               |......          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-ByteBuf-ä¼˜åŠ¿"><a href="#ğŸ’¡-ByteBuf-ä¼˜åŠ¿" class="headerlink" title="ğŸ’¡ ByteBuf ä¼˜åŠ¿"></a>ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4><ul><li>æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li><li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li><li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li><li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li><li>å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li></ul><h2 id="4-åŒå‘é€šä¿¡"><a href="#4-åŒå‘é€šä¿¡" class="headerlink" title="4. åŒå‘é€šä¿¡"></a>4. åŒå‘é€šä¿¡</h2><h3 id="4-1-ç»ƒä¹ "><a href="#4-1-ç»ƒä¹ " class="headerlink" title="4.1 ç»ƒä¹ "></a>4.1 ç»ƒä¹ </h3><p>å®ç°ä¸€ä¸ª echo server</p><p>ç¼–å†™ server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>()</span><br><span class="line">    .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">    .channel(NioServerSocketChannel.class)</span><br><span class="line">    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(buffer.toString(Charset.defaultCharset()));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf</span></span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">response</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">                    response.writeBytes(buffer);</span><br><span class="line">                    ctx.writeAndFlush(response);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span></span><br><span class="line">                    <span class="comment">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).bind(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><p>ç¼–å†™ client</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"><span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">    .group(group)</span><br><span class="line">    .channel(NioSocketChannel.class)</span><br><span class="line">    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(buffer.toString(Charset.defaultCharset()));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).sync().channel();</span><br><span class="line"></span><br><span class="line">channel.closeFuture().addListener(future -&gt; &#123;</span><br><span class="line">    group.shutdownGracefully();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;q&quot;</span>.equals(line)) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        channel.writeAndFlush(line);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><h3 id="ğŸ’¡-è¯»å’Œå†™çš„è¯¯è§£"><a href="#ğŸ’¡-è¯»å’Œå†™çš„è¯¯è§£" class="headerlink" title="ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£"></a>ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3><p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code>A åˆ° B</code> å’Œ <code>B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p><p>ä¾‹å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8888</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> ss.accept();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    System.out.println(reader.readLine());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(s.getOutputStream()));</span><br><span class="line">                <span class="comment">// ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    writer.write(String.valueOf(i));</span><br><span class="line">                    writer.newLine();</span><br><span class="line">                    writer.flush();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8888</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    System.out.println(reader.readLine());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(s.getOutputStream()));</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    writer.write(String.valueOf(i));</span><br><span class="line">                    writer.newLine();</span><br><span class="line">                    writer.flush();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">RPCæ¡†æ¶ï¼ŒNettyå®æˆ˜</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="netty" scheme="https://www.jodio.cc/tags/netty/"/>
    
  </entry>
  
  <entry>
    <title>Netty(ä¸€) -- NIOç¯‡</title>
    <link href="https://www.jodio.cc/posts/netty.html"/>
    <id>https://www.jodio.cc/posts/netty.html</id>
    <published>2023-04-21T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€-NIO-åŸºç¡€"><a href="#ä¸€-NIO-åŸºç¡€" class="headerlink" title="ä¸€. NIO åŸºç¡€"></a>ä¸€. NIO åŸºç¡€</h1><p>non-blocking io éé˜»å¡ IO</p><h2 id="1-ä¸‰å¤§ç»„ä»¶"><a href="#1-ä¸‰å¤§ç»„ä»¶" class="headerlink" title="1. ä¸‰å¤§ç»„ä»¶"></a>1. ä¸‰å¤§ç»„ä»¶</h2><h3 id="1-1-Channel-amp-Buffer"><a href="#1-1-Channel-amp-Buffer" class="headerlink" title="1.1 Channel &amp; Buffer"></a>1.1 Channel &amp; Buffer</h3><p>channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„<strong>åŒå‘é€šé“</strong>ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">channel --&gt; buffer</span><br><span class="line">buffer --&gt; channel</span><br></pre></td></tr></table></figure><p>å¸¸è§çš„ Channel æœ‰</p><ul><li>FileChannel</li><li>DatagramChannel</li><li>SocketChannel</li><li>ServerSocketChannel</li></ul><p>buffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰</p><ul><li>ByteBuffer<ul><li>MappedByteBuffer</li><li>DirectByteBuffer</li><li>HeapByteBuffer</li></ul></li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li><li>CharBuffer</li></ul><h3 id="1-2-Selector"><a href="#1-2-Selector" class="headerlink" title="1.2 Selector"></a>1.2 Selector</h3><p>selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”</p><h4 id="å¤šçº¿ç¨‹ç‰ˆè®¾è®¡"><a href="#å¤šçº¿ç¨‹ç‰ˆè®¾è®¡" class="headerlink" title="å¤šçº¿ç¨‹ç‰ˆè®¾è®¡"></a>å¤šçº¿ç¨‹ç‰ˆè®¾è®¡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">subgraph å¤šçº¿ç¨‹ç‰ˆ</span><br><span class="line">t1(thread) --&gt; s1(socket1)</span><br><span class="line">t2(thread) --&gt; s2(socket2)</span><br><span class="line">t3(thread) --&gt; s3(socket3)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹"><a href="#âš ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹" class="headerlink" title="âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹"></a>âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹</h4><ul><li>å†…å­˜å ç”¨é«˜</li><li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜</li><li>åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯</li></ul><h4 id="çº¿ç¨‹æ± ç‰ˆè®¾è®¡"><a href="#çº¿ç¨‹æ± ç‰ˆè®¾è®¡" class="headerlink" title="çº¿ç¨‹æ± ç‰ˆè®¾è®¡"></a>çº¿ç¨‹æ± ç‰ˆè®¾è®¡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">subgraph çº¿ç¨‹æ± ç‰ˆ</span><br><span class="line">t4(thread) --&gt; s4(socket1)</span><br><span class="line">t5(thread) --&gt; s5(socket2)</span><br><span class="line">t4(thread) -.-&gt; s6(socket3)</span><br><span class="line">t5(thread) -.-&gt; s7(socket4)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹"><a href="#âš ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹" class="headerlink" title="âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹"></a>âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹</h4><ul><li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥</li><li>ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯</li></ul><h4 id="selector-ç‰ˆè®¾è®¡"><a href="#selector-ç‰ˆè®¾è®¡" class="headerlink" title="selector ç‰ˆè®¾è®¡"></a>selector ç‰ˆè®¾è®¡</h4><p>selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œè¿™äº› channel å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">subgraph selector ç‰ˆ</span><br><span class="line">thread --&gt; selector</span><br><span class="line">selector --&gt; c1(channel)</span><br><span class="line">selector --&gt; c2(channel)</span><br><span class="line">selector --&gt; c3(channel)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ selector çš„ select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†</p><h2 id="2-ByteBuffer"><a href="#2-ByteBuffer" class="headerlink" title="2. ByteBuffer"></a>2. ByteBuffer</h2><p>æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1234567890abcd</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ FileChannel æ¥è¯»å–æ–‡ä»¶å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;helloword/data.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> file.getChannel();</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">// å‘ buffer å†™å…¥</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">                log.debug(<span class="string">&quot;è¯»åˆ°å­—èŠ‚æ•°ï¼š&#123;&#125;&quot;</span>, len);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢ buffer è¯»æ¨¡å¼</span></span><br><span class="line">                buffer.flip();</span><br><span class="line">                <span class="keyword">while</span>(buffer.hasRemaining()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, (<span class="type">char</span>)buffer.get());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢ buffer å†™æ¨¡å¼</span></span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d</span><br><span class="line">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1</span><br></pre></td></tr></table></figure><h3 id="2-1-ByteBuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿"><a href="#2-1-ByteBuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿" class="headerlink" title="2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿"></a>2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h3><ol><li>å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)</li><li>è°ƒç”¨ flip() åˆ‡æ¢è‡³<strong>è¯»æ¨¡å¼</strong></li><li>ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()</li><li>è°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³<strong>å†™æ¨¡å¼</strong></li><li>é‡å¤ 1~4 æ­¥éª¤</li></ol><h3 id="2-2-ByteBuffer-ç»“æ„"><a href="#2-2-ByteBuffer-ç»“æ„" class="headerlink" title="2.2 ByteBuffer ç»“æ„"></a>2.2 ByteBuffer ç»“æ„</h3><p>ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§</p><ul><li>capacity</li><li>position</li><li>limit</li></ul><p>ä¸€å¼€å§‹</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0021.png" alt=""></p><p>å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0018.png" alt=""></p><p>flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0019.png" alt=""></p><p>è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0020.png" alt=""></p><p>clear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0021.png" alt=""></p><p>compact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0022.png" alt=""></p><h4 id="ğŸ’¡-è°ƒè¯•å·¥å…·ç±»"><a href="#ğŸ’¡-è°ƒè¯•å·¥å…·ç±»" class="headerlink" title="ğŸ’¡ è°ƒè¯•å·¥å…·ç±»"></a>ğŸ’¡ è°ƒè¯•å·¥å…·ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteBufferUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span>[] BYTE2CHAR = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span>[] HEXDUMP_TABLE = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">256</span> * <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] HEXPADDING = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] HEXDUMP_ROWPREFIXES = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">65536</span> &gt;&gt;&gt; <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] BYTE2HEX = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] BYTEPADDING = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">char</span>[] DIGITS = <span class="string">&quot;0123456789abcdef&quot;</span>.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">            HEXDUMP_TABLE[i &lt;&lt; <span class="number">1</span>] = DIGITS[i &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0x0F</span>];</span><br><span class="line">            HEXDUMP_TABLE[(i &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>] = DIGITS[i &amp; <span class="number">0x0F</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the lookup table for hex dump paddings</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; HEXPADDING.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">padding</span> <span class="operator">=</span> HEXPADDING.length - i;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(padding * <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; padding; j++) &#123;</span><br><span class="line">                buf.append(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            HEXPADDING[i] = buf.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the lookup table for the start-offset header in each row (up to 64KiB).</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; HEXDUMP_ROWPREFIXES.length; i++) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">12</span>);</span><br><span class="line">            buf.append(NEWLINE);</span><br><span class="line">            buf.append(Long.toHexString(i &lt;&lt; <span class="number">4</span> &amp; <span class="number">0xFFFFFFFFL</span> | <span class="number">0x100000000L</span>));</span><br><span class="line">            buf.setCharAt(buf.length() - <span class="number">9</span>, <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">            buf.append(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">            HEXDUMP_ROWPREFIXES[i] = buf.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the lookup table for byte-to-hex-dump conversion</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BYTE2HEX.length; i++) &#123;</span><br><span class="line">            BYTE2HEX[i] = <span class="string">&#x27; &#x27;</span> + StringUtil.byteToHexStringPadded(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the lookup table for byte dump paddings</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BYTEPADDING.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">padding</span> <span class="operator">=</span> BYTEPADDING.length - i;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(padding);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; padding; j++) &#123;</span><br><span class="line">                buf.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            BYTEPADDING[i] = buf.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the lookup table for byte-to-char conversion</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; BYTE2CHAR.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt;= <span class="number">0x1f</span> || i &gt;= <span class="number">0x7f</span>) &#123;</span><br><span class="line">                BYTE2CHAR[i] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                BYTE2CHAR[i] = (<span class="type">char</span>) i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰“å°æ‰€æœ‰å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">debugAll</span><span class="params">(ByteBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">oldlimit</span> <span class="operator">=</span> buffer.limit();</span><br><span class="line">        buffer.limit(buffer.capacity());</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">origin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">        appendPrettyHexDump(origin, buffer, <span class="number">0</span>, buffer.capacity());</span><br><span class="line">        System.out.println(<span class="string">&quot;+--------+-------------------- all ------------------------+----------------+&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;position: [%d], limit: [%d]\n&quot;</span>, buffer.position(), oldlimit);</span><br><span class="line">        System.out.println(origin);</span><br><span class="line">        buffer.limit(oldlimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰“å°å¯è¯»å–å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">debugRead</span><span class="params">(ByteBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;+--------+-------------------- read -----------------------+----------------+&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;position: [%d], limit: [%d]\n&quot;</span>, buffer.position(), buffer.limit());</span><br><span class="line">        System.out.println(builder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">appendPrettyHexDump</span><span class="params">(StringBuilder dump, ByteBuffer buf, <span class="type">int</span> offset, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isOutOfBounds(offset, length, buf.capacity())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(</span><br><span class="line">                    <span class="string">&quot;expected: &quot;</span> + <span class="string">&quot;0 &lt;= offset(&quot;</span> + offset + <span class="string">&quot;) &lt;= offset + length(&quot;</span> + length</span><br><span class="line">                            + <span class="string">&quot;) &lt;= &quot;</span> + <span class="string">&quot;buf.capacity(&quot;</span> + buf.capacity() + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dump.append(</span><br><span class="line">                <span class="string">&quot;         +-------------------------------------------------+&quot;</span> +</span><br><span class="line">                        NEWLINE + <span class="string">&quot;         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |&quot;</span> +</span><br><span class="line">                        NEWLINE + <span class="string">&quot;+--------+-------------------------------------------------+----------------+&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> offset;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">fullRows</span> <span class="operator">=</span> length &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">remainder</span> <span class="operator">=</span> length &amp; <span class="number">0xF</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Dump the rows which have 16 bytes.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>; row &lt; fullRows; row++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rowStartIndex</span> <span class="operator">=</span> (row &lt;&lt; <span class="number">4</span>) + startIndex;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Per-row prefix.</span></span><br><span class="line">            appendHexDumpRowPrefix(dump, row, rowStartIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hex dump</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rowEndIndex</span> <span class="operator">=</span> rowStartIndex + <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> rowStartIndex; j &lt; rowEndIndex; j++) &#123;</span><br><span class="line">                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);</span><br><span class="line">            &#125;</span><br><span class="line">            dump.append(<span class="string">&quot; |&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ASCII dump</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> rowStartIndex; j &lt; rowEndIndex; j++) &#123;</span><br><span class="line">                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);</span><br><span class="line">            &#125;</span><br><span class="line">            dump.append(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Dump the last row which has less than 16 bytes.</span></span><br><span class="line">        <span class="keyword">if</span> (remainder != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rowStartIndex</span> <span class="operator">=</span> (fullRows &lt;&lt; <span class="number">4</span>) + startIndex;</span><br><span class="line">            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hex dump</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rowEndIndex</span> <span class="operator">=</span> rowStartIndex + remainder;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> rowStartIndex; j &lt; rowEndIndex; j++) &#123;</span><br><span class="line">                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);</span><br><span class="line">            &#125;</span><br><span class="line">            dump.append(HEXPADDING[remainder]);</span><br><span class="line">            dump.append(<span class="string">&quot; |&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ascii dump</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> rowStartIndex; j &lt; rowEndIndex; j++) &#123;</span><br><span class="line">                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);</span><br><span class="line">            &#125;</span><br><span class="line">            dump.append(BYTEPADDING[remainder]);</span><br><span class="line">            dump.append(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dump.append(NEWLINE +</span><br><span class="line">                <span class="string">&quot;+--------+-------------------------------------------------+----------------+&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">appendHexDumpRowPrefix</span><span class="params">(StringBuilder dump, <span class="type">int</span> row, <span class="type">int</span> rowStartIndex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (row &lt; HEXDUMP_ROWPREFIXES.length) &#123;</span><br><span class="line">            dump.append(HEXDUMP_ROWPREFIXES[row]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dump.append(NEWLINE);</span><br><span class="line">            dump.append(Long.toHexString(rowStartIndex &amp; <span class="number">0xFFFFFFFFL</span> | <span class="number">0x100000000L</span>));</span><br><span class="line">            dump.setCharAt(dump.length() - <span class="number">9</span>, <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">            dump.append(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">getUnsignedByte</span><span class="params">(ByteBuffer buffer, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">short</span>) (buffer.get(index) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-ByteBuffer-å¸¸è§æ–¹æ³•"><a href="#2-3-ByteBuffer-å¸¸è§æ–¹æ³•" class="headerlink" title="2.3 ByteBuffer å¸¸è§æ–¹æ³•"></a>2.3 ByteBuffer å¸¸è§æ–¹æ³•</h3><h4 id="åˆ†é…ç©ºé—´"><a href="#åˆ†é…ç©ºé—´" class="headerlink" title="åˆ†é…ç©ºé—´"></a>åˆ†é…ç©ºé—´</h4><p>å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Bytebuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">16</span>);</span><br></pre></td></tr></table></figure><h4 id="å‘-buffer-å†™å…¥æ•°æ®"><a href="#å‘-buffer-å†™å…¥æ•°æ®" class="headerlink" title="å‘ buffer å†™å…¥æ•°æ®"></a>å‘ buffer å†™å…¥æ•°æ®</h4><p>æœ‰ä¸¤ç§åŠæ³•</p><ul><li>è°ƒç”¨ channel çš„ read æ–¹æ³•</li><li>è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">readBytes</span> <span class="operator">=</span> channel.read(buf);</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf.put((<span class="type">byte</span>)<span class="number">127</span>);</span><br></pre></td></tr></table></figure><h4 id="ä»-buffer-è¯»å–æ•°æ®"><a href="#ä»-buffer-è¯»å–æ•°æ®" class="headerlink" title="ä» buffer è¯»å–æ•°æ®"></a>ä» buffer è¯»å–æ•°æ®</h4><p>åŒæ ·æœ‰ä¸¤ç§åŠæ³•</p><ul><li>è°ƒç”¨ channel çš„ write æ–¹æ³•</li><li>è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">writeBytes</span> <span class="operator">=</span> channel.write(buf);</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> buf.get();</span><br></pre></td></tr></table></figure><p>get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®</p><ul><li>å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0</li><li>æˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ</li></ul><h4 id="mark-å’Œ-reset"><a href="#mark-å’Œ-reset" class="headerlink" title="mark å’Œ reset"></a>mark å’Œ reset</h4><p>mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®</p><blockquote><p><strong>æ³¨æ„</strong></p><p>rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®</p></blockquote><h4 id="å­—ç¬¦ä¸²ä¸-ByteBuffer-äº’è½¬"><a href="#å­—ç¬¦ä¸²ä¸-ByteBuffer-äº’è½¬" class="headerlink" title="å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬"></a>å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer1</span> <span class="operator">=</span> StandardCharsets.UTF_8.encode(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer2</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;utf-8&quot;</span>).encode(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line"></span><br><span class="line">debug(buffer1);</span><br><span class="line">debug(buffer2);</span><br><span class="line"></span><br><span class="line"><span class="type">CharBuffer</span> <span class="variable">buffer3</span> <span class="operator">=</span> StandardCharsets.UTF_8.decode(buffer1);</span><br><span class="line">System.out.println(buffer3.getClass());</span><br><span class="line">System.out.println(buffer3.toString());</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| e4 bd a0 e5 a5 bd                               |......          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| e4 bd a0 e5 a5 bd                               |......          |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">class java.nio.HeapCharBuffer</span><br><span class="line">ä½ å¥½</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-Buffer-çš„çº¿ç¨‹å®‰å…¨"><a href="#âš ï¸-Buffer-çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨"></a>âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨</h4><blockquote><p>Buffer æ˜¯<strong>éçº¿ç¨‹å®‰å…¨çš„</strong></p></blockquote><h3 id="2-4-Scattering-Reads"><a href="#2-4-Scattering-Reads" class="headerlink" title="2.4 Scattering Reads"></a>2.4 Scattering Reads</h3><p>åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onetwothree</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®å¡«å……è‡³å¤šä¸ª buffer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;helloword/3parts.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> file.getChannel();</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">a</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">3</span>);</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">b</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">3</span>);</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">c</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">    channel.read(<span class="keyword">new</span> <span class="title class_">ByteBuffer</span>[]&#123;a, b, c&#125;);</span><br><span class="line">    a.flip();</span><br><span class="line">    b.flip();</span><br><span class="line">    c.flip();</span><br><span class="line">    debug(a);</span><br><span class="line">    debug(b);</span><br><span class="line">    debug(c);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 6f 6e 65                                        |one             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 74 77 6f                                        |two             |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 74 68 72 65 65                                  |three           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h3 id="2-5-Gathering-Writes"><a href="#2-5-Gathering-Writes" class="headerlink" title="2.5 Gathering Writes"></a>2.5 Gathering Writes</h3><p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;helloword/3parts.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> file.getChannel();</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">d</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">e</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">    channel.position(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">    d.put(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;r&#x27;</span>&#125;);</span><br><span class="line">    e.put(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;e&#x27;</span>&#125;);</span><br><span class="line">    d.flip();</span><br><span class="line">    e.flip();</span><br><span class="line">    debug(d);</span><br><span class="line">    debug(e);</span><br><span class="line">    channel.write(<span class="keyword">new</span> <span class="title class_">ByteBuffer</span>[]&#123;d, e&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 66 6f 75 72                                     |four            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 66 69 76 65                                     |five            |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onetwothreefourfive</span><br></pre></td></tr></table></figure><h3 id="2-6-ç»ƒä¹ "><a href="#2-6-ç»ƒä¹ " class="headerlink" title="2.6 ç»ƒä¹ "></a>2.6 ç»ƒä¹ </h3><p>ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \n è¿›è¡Œåˆ†éš”<br>ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º</p><ul><li>Hello,world\n</li><li>Iâ€™m zhangsan\n</li><li>How are you?\n</li></ul><p>å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (é»åŒ…ï¼ŒåŠåŒ…)</p><ul><li>Hello,world\nIâ€™m zhangsan\nHo</li><li>w are you?\n</li></ul><p>ç°åœ¨è¦æ±‚ä½ ç¼–å†™ç¨‹åºï¼Œå°†é”™ä¹±çš„æ•°æ®æ¢å¤æˆåŸå§‹çš„æŒ‰ \n åˆ†éš”çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">source</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">32</span>);</span><br><span class="line">    <span class="comment">//                     11            24</span></span><br><span class="line">    source.put(<span class="string">&quot;Hello,world\nI&#x27;m zhangsan\nHo&quot;</span>.getBytes());</span><br><span class="line">    split(source);</span><br><span class="line"></span><br><span class="line">    source.put(<span class="string">&quot;w are you?\nhaha!\n&quot;</span>.getBytes());</span><br><span class="line">    split(source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">split</span><span class="params">(ByteBuffer source)</span> &#123;</span><br><span class="line">    source.flip();</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLimit</span> <span class="operator">=</span> source.limit();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldLimit; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.get(i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">target</span> <span class="operator">=</span> ByteBuffer.allocate(i + <span class="number">1</span> - source.position());</span><br><span class="line">            <span class="comment">// 0 ~ limit</span></span><br><span class="line">            source.limit(i + <span class="number">1</span>);</span><br><span class="line">            target.put(source); <span class="comment">// ä»source è¯»ï¼Œå‘ target å†™</span></span><br><span class="line">            debugAll(target);</span><br><span class="line">            source.limit(oldLimit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    source.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-æ–‡ä»¶ç¼–ç¨‹"><a href="#3-æ–‡ä»¶ç¼–ç¨‹" class="headerlink" title="3. æ–‡ä»¶ç¼–ç¨‹"></a>3. æ–‡ä»¶ç¼–ç¨‹</h2><h3 id="3-1-FileChannel"><a href="#3-1-FileChannel" class="headerlink" title="3.1 FileChannel"></a>3.1 FileChannel</h3><h4 id="âš ï¸-FileChannel-å·¥ä½œæ¨¡å¼"><a href="#âš ï¸-FileChannel-å·¥ä½œæ¨¡å¼" class="headerlink" title="âš ï¸ FileChannel å·¥ä½œæ¨¡å¼"></a>âš ï¸ FileChannel å·¥ä½œæ¨¡å¼</h4><blockquote><p>FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹</p></blockquote><h4 id="è·å–"><a href="#è·å–" class="headerlink" title="è·å–"></a>è·å–</h4><p>ä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰ getChannel æ–¹æ³•</p><ul><li>é€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»</li><li>é€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™</li><li>é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š</li></ul><h4 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h4><p>ä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">readBytes</span> <span class="operator">=</span> channel.read(buffer);</span><br></pre></td></tr></table></figure><h4 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a>å†™å…¥</h4><p>å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ SocketChannel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ...;</span><br><span class="line">buffer.put(...); <span class="comment">// å­˜å…¥æ•°æ®</span></span><br><span class="line">buffer.flip();   <span class="comment">// åˆ‡æ¢è¯»æ¨¡å¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(buffer.hasRemaining()) &#123;</span><br><span class="line">    channel.write(buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel</p><h4 id="å…³é—­"><a href="#å…³é—­" class="headerlink" title="å…³é—­"></a>å…³é—­</h4><p>channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•</p><h4 id="ä½ç½®"><a href="#ä½ç½®" class="headerlink" title="ä½ç½®"></a>ä½ç½®</h4><p>è·å–å½“å‰ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">pos</span> <span class="operator">=</span> channel.position();</span><br></pre></td></tr></table></figure><p>è®¾ç½®å½“å‰ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">newPos</span> <span class="operator">=</span> ...;</span><br><span class="line">channel.position(newPos);</span><br></pre></td></tr></table></figure><p>è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾</p><ul><li>è¿™æ—¶è¯»å–ä¼šè¿”å› -1 </li><li>è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰</li></ul><h4 id="å¤§å°"><a href="#å¤§å°" class="headerlink" title="å¤§å°"></a>å¤§å°</h4><p>ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°</p><h4 id="å¼ºåˆ¶å†™å…¥"><a href="#å¼ºåˆ¶å†™å…¥" class="headerlink" title="å¼ºåˆ¶å†™å…¥"></a>å¼ºåˆ¶å†™å…¥</h4><p>æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ force(true)  æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜</p><h3 id="3-2-ä¸¤ä¸ª-Channel-ä¼ è¾“æ•°æ®"><a href="#3-2-ä¸¤ä¸ª-Channel-ä¼ è¾“æ•°æ®" class="headerlink" title="3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®"></a>3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">FROM</span> <span class="operator">=</span> <span class="string">&quot;helloword/data.txt&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">TO</span> <span class="operator">=</span> <span class="string">&quot;helloword/to.txt&quot;</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"><span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FROM).getChannel();</span><br><span class="line">     <span class="type">FileChannel</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(TO).getChannel();</span><br><span class="line">    ) &#123;</span><br><span class="line">    from.transferTo(<span class="number">0</span>, from.size(), to);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">System.out.println(<span class="string">&quot;transferTo ç”¨æ—¶ï¼š&quot;</span> + (end - start) / <span class="number">1000_000.0</span>);</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transferTo ç”¨æ—¶ï¼š8.2011</span><br></pre></td></tr></table></figure><p>è¶…è¿‡ 2g å¤§å°çš„æ–‡ä»¶ä¼ è¾“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFileChannelTransferTo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">FileChannel</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data.txt&quot;</span>).getChannel();</span><br><span class="line">                <span class="type">FileChannel</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;to.txt&quot;</span>).getChannel();</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> from.size();</span><br><span class="line">            <span class="comment">// left å˜é‡ä»£è¡¨è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">left</span> <span class="operator">=</span> size; left &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;position:&quot;</span> + (size - left) + <span class="string">&quot; left:&quot;</span> + left);</span><br><span class="line">                left -= from.transferTo((size - left), left, to);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¼ è¾“ä¸€ä¸ªè¶…å¤§æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">position:0 left:7769948160</span><br><span class="line">position:2147483647 left:5622464513</span><br><span class="line">position:4294967294 left:3474980866</span><br><span class="line">position:6442450941 left:1327497219</span><br></pre></td></tr></table></figure><h3 id="3-3-Path"><a href="#3-3-Path" class="headerlink" title="3.3 Path"></a>3.3 Path</h3><p>jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»</p><ul><li>Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„</li><li>Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">source</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;1.txt&quot;</span>); <span class="comment">// ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt</span></span><br><span class="line"></span><br><span class="line"><span class="type">Path</span> <span class="variable">source</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;d:\\1.txt&quot;</span>); <span class="comment">// ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt</span></span><br><span class="line"></span><br><span class="line"><span class="type">Path</span> <span class="variable">source</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;d:/1.txt&quot;</span>); <span class="comment">// ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt</span></span><br><span class="line"></span><br><span class="line"><span class="type">Path</span> <span class="variable">projects</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;d:\\data&quot;</span>, <span class="string">&quot;projects&quot;</span>); <span class="comment">// ä»£è¡¨äº†  d:\data\projects</span></span><br></pre></td></tr></table></figure><ul><li><code>.</code> ä»£è¡¨äº†å½“å‰è·¯å¾„</li><li><code>..</code> ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„</li></ul><p>ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d:</span><br><span class="line">|- data</span><br><span class="line">|- projects</span><br><span class="line">|- a</span><br><span class="line">|- b</span><br></pre></td></tr></table></figure><p>ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;d:\\data\\projects\\a\\..\\b&quot;</span>);</span><br><span class="line">System.out.println(path);</span><br><span class="line">System.out.println(path.normalize()); <span class="comment">// æ­£å¸¸åŒ–è·¯å¾„</span></span><br></pre></td></tr></table></figure><p>ä¼šè¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d:\data\projects\a\..\b</span><br><span class="line">d:\data\projects\b</span><br></pre></td></tr></table></figure><h3 id="3-4-Files"><a href="#3-4-Files" class="headerlink" title="3.4 Files"></a>3.4 Files</h3><p>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/data.txt&quot;</span>);</span><br><span class="line">System.out.println(Files.exists(path));</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€çº§ç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/d1&quot;</span>);</span><br><span class="line">Files.createDirectory(path);</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li><li>ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li></ul><p>åˆ›å»ºå¤šçº§ç›®å½•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/d1/d2&quot;</span>);</span><br><span class="line">Files.createDirectories(path);</span><br></pre></td></tr></table></figure><p>æ‹·è´æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">source</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/data.txt&quot;</span>);</span><br><span class="line"><span class="type">Path</span> <span class="variable">target</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/target.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">Files.copy(source, target);</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li></ul><p>å¦‚æœå¸Œæœ›ç”¨ source è¦†ç›–æ‰ targetï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);</span><br></pre></td></tr></table></figure><p>ç§»åŠ¨æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">source</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/data.txt&quot;</span>);</span><br><span class="line"><span class="type">Path</span> <span class="variable">target</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/data.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);</span><br></pre></td></tr></table></figure><ul><li>StandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§</li></ul><p>åˆ é™¤æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">target</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/target.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">Files.delete(target);</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li></ul><p>åˆ é™¤ç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">target</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;helloword/d1&quot;</span>);</span><br><span class="line"></span><br><span class="line">Files.delete(target);</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException</li></ul><p>éå†ç›®å½•æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;</span>);</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">dirCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">fileCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    Files.walkFileTree(path, <span class="keyword">new</span> <span class="title class_">SimpleFileVisitor</span>&lt;Path&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> FileVisitResult <span class="title function_">preVisitDirectory</span><span class="params">(Path dir, BasicFileAttributes attrs)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(dir);</span><br><span class="line">            dirCount.incrementAndGet();</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.preVisitDirectory(dir, attrs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> FileVisitResult <span class="title function_">visitFile</span><span class="params">(Path file, BasicFileAttributes attrs)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(file);</span><br><span class="line">            fileCount.incrementAndGet();</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(dirCount); <span class="comment">// 133</span></span><br><span class="line">    System.out.println(fileCount); <span class="comment">// 1479</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»Ÿè®¡ jar çš„æ•°ç›®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;C:\\Program Files\\Java\\jdk1.8.0_91&quot;</span>);</span><br><span class="line"><span class="type">AtomicInteger</span> <span class="variable">fileCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">Files.walkFileTree(path, <span class="keyword">new</span> <span class="title class_">SimpleFileVisitor</span>&lt;Path&gt;()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileVisitResult <span class="title function_">visitFile</span><span class="params">(Path file, BasicFileAttributes attrs)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.toFile().getName().endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">            fileCount.incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(fileCount); <span class="comment">// 724</span></span><br></pre></td></tr></table></figure><p>åˆ é™¤å¤šçº§ç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;d:\\a&quot;</span>);</span><br><span class="line">Files.walkFileTree(path, <span class="keyword">new</span> <span class="title class_">SimpleFileVisitor</span>&lt;Path&gt;()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileVisitResult <span class="title function_">visitFile</span><span class="params">(Path file, BasicFileAttributes attrs)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Files.delete(file);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileVisitResult <span class="title function_">postVisitDirectory</span><span class="params">(Path dir, IOException exc)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Files.delete(dir);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.postVisitDirectory(dir, exc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-åˆ é™¤å¾ˆå±é™©"><a href="#âš ï¸-åˆ é™¤å¾ˆå±é™©" class="headerlink" title="âš ï¸ åˆ é™¤å¾ˆå±é™©"></a>âš ï¸ åˆ é™¤å¾ˆå±é™©</h4><blockquote><p>åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹</p></blockquote><p>æ‹·è´å¤šçº§ç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> <span class="string">&quot;D:\\Snipaste-1.16.2-x64&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="string">&quot;D:\\Snipaste-1.16.2-x64aaa&quot;</span>;</span><br><span class="line"></span><br><span class="line">Files.walk(Paths.get(source)).forEach(path -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetName</span> <span class="operator">=</span> path.toString().replace(source, target);</span><br><span class="line">        <span class="comment">// æ˜¯ç›®å½•</span></span><br><span class="line">        <span class="keyword">if</span> (Files.isDirectory(path)) &#123;</span><br><span class="line">            Files.createDirectory(Paths.get(targetName));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ˜¯æ™®é€šæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Files.isRegularFile(path)) &#123;</span><br><span class="line">            Files.copy(path, Paths.get(targetName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">System.out.println(end - start);</span><br></pre></td></tr></table></figure><h2 id="4-ç½‘ç»œç¼–ç¨‹"><a href="#4-ç½‘ç»œç¼–ç¨‹" class="headerlink" title="4. ç½‘ç»œç¼–ç¨‹"></a>4. ç½‘ç»œç¼–ç¨‹</h2><h3 id="4-1-éé˜»å¡-vs-é˜»å¡"><a href="#4-1-éé˜»å¡-vs-é˜»å¡" class="headerlink" title="4.1 éé˜»å¡ vs é˜»å¡"></a>4.1 éé˜»å¡ vs é˜»å¡</h3><h4 id="é˜»å¡"><a href="#é˜»å¡" class="headerlink" title="é˜»å¡"></a>é˜»å¡</h4><ul><li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ<ul><li>ServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ</li><li>SocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ</li><li>é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®</li></ul></li><li>å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ</li><li>ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢<ul><li>32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½</li><li>å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥</li></ul></li></ul><p>æœåŠ¡å™¨ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// 0. ByteBuffer</span></span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">16</span>);</span><br><span class="line"><span class="comment">// 1. åˆ›å»ºäº†æœåŠ¡å™¨</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ç»‘å®šç›‘å¬ç«¯å£</span></span><br><span class="line">ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è¿æ¥é›†åˆ</span></span><br><span class="line">List&lt;SocketChannel&gt; channels = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡</span></span><br><span class="line">    log.debug(<span class="string">&quot;connecting...&quot;</span>);</span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> ssc.accept(); <span class="comment">// é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ</span></span><br><span class="line">    log.debug(<span class="string">&quot;connected... &#123;&#125;&quot;</span>, sc);</span><br><span class="line">    channels.add(sc);</span><br><span class="line">    <span class="keyword">for</span> (SocketChannel channel : channels) &#123;</span><br><span class="line">        <span class="comment">// 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">        log.debug(<span class="string">&quot;before read... &#123;&#125;&quot;</span>, channel);</span><br><span class="line">        channel.read(buffer); <span class="comment">// é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        debugRead(buffer);</span><br><span class="line">        buffer.clear();</span><br><span class="line">        log.debug(<span class="string">&quot;after read...&#123;&#125;&quot;</span>, channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">sc.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;waiting...&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="éé˜»å¡"><a href="#éé˜»å¡" class="headerlink" title="éé˜»å¡"></a>éé˜»å¡</h4><ul><li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ<ul><li>åœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ</li><li>SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept </li><li>å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»</li></ul></li><li>ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu</li><li>æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰</li></ul><p>æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// 0. ByteBuffer</span></span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">16</span>);</span><br><span class="line"><span class="comment">// 1. åˆ›å»ºäº†æœåŠ¡å™¨</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">ssc.configureBlocking(<span class="literal">false</span>); <span class="comment">// éé˜»å¡æ¨¡å¼</span></span><br><span class="line"><span class="comment">// 2. ç»‘å®šç›‘å¬ç«¯å£</span></span><br><span class="line">ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"><span class="comment">// 3. è¿æ¥é›†åˆ</span></span><br><span class="line">List&lt;SocketChannel&gt; channels = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡</span></span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> ssc.accept(); <span class="comment">// éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null</span></span><br><span class="line">    <span class="keyword">if</span> (sc != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;connected... &#123;&#125;&quot;</span>, sc);</span><br><span class="line">        sc.configureBlocking(<span class="literal">false</span>); <span class="comment">// éé˜»å¡æ¨¡å¼</span></span><br><span class="line">        channels.add(sc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (SocketChannel channel : channels) &#123;</span><br><span class="line">        <span class="comment">// 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(buffer);<span class="comment">// éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0</span></span><br><span class="line">        <span class="keyword">if</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            buffer.flip();</span><br><span class="line">            debugRead(buffer);</span><br><span class="line">            buffer.clear();</span><br><span class="line">            log.debug(<span class="string">&quot;after read...&#123;&#125;&quot;</span>, channel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤šè·¯å¤ç”¨"><a href="#å¤šè·¯å¤ç”¨" class="headerlink" title="å¤šè·¯å¤ç”¨"></a>å¤šè·¯å¤ç”¨</h4><p>å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨</p><ul><li>å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IOã€æ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨</li><li>å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯<ul><li>æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥</li><li>æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–</li><li>æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥<ul><li>é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶</li></ul></li></ul></li></ul><h3 id="4-2-Selector"><a href="#4-2-Selector" class="headerlink" title="4.2 Selector"></a>4.2 Selector</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">subgraph selector ç‰ˆ</span><br><span class="line">thread --&gt; selector</span><br><span class="line">selector --&gt; c1(channel)</span><br><span class="line">selector --&gt; c2(channel)</span><br><span class="line">selector --&gt; c3(channel)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>å¥½å¤„</p><ul><li>ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ</li><li>è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨</li><li>èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡</li><li>å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li></ul><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br></pre></td></tr></table></figure><h4 id="ç»‘å®š-Channel-äº‹ä»¶"><a href="#ç»‘å®š-Channel-äº‹ä»¶" class="headerlink" title="ç»‘å®š Channel äº‹ä»¶"></a>ç»‘å®š Channel äº‹ä»¶</h4><p>ä¹Ÿç§°ä¹‹ä¸ºæ³¨å†Œäº‹ä»¶ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> channel.register(selector, ç»‘å®šäº‹ä»¶);</span><br></pre></td></tr></table></figure><ul><li>channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼</li><li>FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨</li><li>ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰<ul><li>connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘</li><li>accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘</li><li>read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ</li><li>write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ</li></ul></li></ul><h4 id="ç›‘å¬-Channel-äº‹ä»¶"><a href="#ç›‘å¬-Channel-äº‹ä»¶" class="headerlink" title="ç›‘å¬ Channel äº‹ä»¶"></a>ç›‘å¬ Channel äº‹ä»¶</h4><p>å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶</p><p>æ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br></pre></td></tr></table></figure><p>æ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select(<span class="type">long</span> timeout);</span><br></pre></td></tr></table></figure><p>æ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.selectNow();</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-select-ä½•æ—¶ä¸é˜»å¡"><a href="#ğŸ’¡-select-ä½•æ—¶ä¸é˜»å¡" class="headerlink" title="ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡"></a>ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡</h4><blockquote><ul><li>äº‹ä»¶å‘ç”Ÿæ—¶<ul><li>å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶</li><li>å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶</li><li>channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶</li><li>åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶</li></ul></li><li>è°ƒç”¨ selector.wakeup()</li><li>è°ƒç”¨ selector.close()</li><li>selector æ‰€åœ¨çº¿ç¨‹ interrupt</li></ul></blockquote><h3 id="4-3-å¤„ç†-accept-äº‹ä»¶"><a href="#4-3-å¤„ç†-accept-äº‹ä»¶" class="headerlink" title="4.3 å¤„ç† accept äº‹ä»¶"></a>4.3 å¤„ç† accept äº‹ä»¶</h3><p>å®¢æˆ·ç«¯ä»£ç ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>)) &#123;</span><br><span class="line">            System.out.println(socket);</span><br><span class="line">            socket.getOutputStream().write(<span class="string">&quot;world&quot;</span>.getBytes());</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯ä»£ç ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelDemo6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ServerSocketChannel.open()) &#123;</span><br><span class="line">            channel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">            System.out.println(channel);</span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">            channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            channel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line"><span class="comment">//                int count = selector.selectNow();</span></span><br><span class="line">                log.debug(<span class="string">&quot;select count: &#123;&#125;&quot;</span>, count);</span><br><span class="line"><span class="comment">//                if(count &lt;= 0) &#123;</span></span><br><span class="line"><span class="comment">//                    continue;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// è·å–æ‰€æœ‰äº‹ä»¶</span></span><br><span class="line">                Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iter = keys.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­äº‹ä»¶ç±»å‹</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">c</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                        <span class="comment">// å¿…é¡»å¤„ç†</span></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> c.accept();</span><br><span class="line">                        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, sc);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤</span></span><br><span class="line">                    iter.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†"><a href="#ğŸ’¡-äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†" class="headerlink" title="ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†"></a>ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†</h4><blockquote><p>äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘</p></blockquote><h3 id="4-4-å¤„ç†-read-äº‹ä»¶"><a href="#4-4-å¤„ç†-read-äº‹ä»¶" class="headerlink" title="4.4 å¤„ç† read äº‹ä»¶"></a>4.4 å¤„ç† read äº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelDemo6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ServerSocketChannel.open()) &#123;</span><br><span class="line">            channel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">            System.out.println(channel);</span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">            channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            channel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line"><span class="comment">//                int count = selector.selectNow();</span></span><br><span class="line">                log.debug(<span class="string">&quot;select count: &#123;&#125;&quot;</span>, count);</span><br><span class="line"><span class="comment">//                if(count &lt;= 0) &#123;</span></span><br><span class="line"><span class="comment">//                    continue;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// è·å–æ‰€æœ‰äº‹ä»¶</span></span><br><span class="line">                Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iter = keys.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­äº‹ä»¶ç±»å‹</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">c</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                        <span class="comment">// å¿…é¡»å¤„ç†</span></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> c.accept();</span><br><span class="line">                        sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                        log.debug(<span class="string">&quot;è¿æ¥å·²å»ºç«‹: &#123;&#125;&quot;</span>, sc);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">                        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> sc.read(buffer);</span><br><span class="line">                        <span class="keyword">if</span>(read == -<span class="number">1</span>) &#123;</span><br><span class="line">                            key.cancel();</span><br><span class="line">                            sc.close();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            buffer.flip();</span><br><span class="line">                            debug(buffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤</span></span><br><span class="line">                    iter.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]</span><br><span class="line">21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1</span><br><span class="line">21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]</span><br><span class="line">21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 68 65 6c 6c 6f                                  |hello           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1</span><br><span class="line">21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]</span><br><span class="line">21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 77 6f 72 6c 64                                  |world           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-ä¸ºä½•è¦-iter-remove"><a href="#ğŸ’¡-ä¸ºä½•è¦-iter-remove" class="headerlink" title="ğŸ’¡ ä¸ºä½•è¦ iter.remove()"></a>ğŸ’¡ ä¸ºä½•è¦ iter.remove()</h4><blockquote><p>å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤ã€‚ä¾‹å¦‚</p><ul><li>ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey </li><li>ç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸</li></ul></blockquote><h4 id="ğŸ’¡-cancel-çš„ä½œç”¨"><a href="#ğŸ’¡-cancel-çš„ä½œç”¨" class="headerlink" title="ğŸ’¡ cancel çš„ä½œç”¨"></a>ğŸ’¡ cancel çš„ä½œç”¨</h4><blockquote><p>cancel ä¼šå–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶</p></blockquote><h4 id="âš ï¸-ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜"><a href="#âš ï¸-ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜" class="headerlink" title="âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜"></a>âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜</h4><p>ä»¥å‰æœ‰åŒå­¦å†™è¿‡è¿™æ ·çš„ä»£ç ï¼Œæ€è€ƒæ³¨é‡Šä¸­ä¸¤ä¸ªé—®é¢˜ï¼Œä»¥ bio ä¸ºä¾‹ï¼Œå…¶å® nio é“ç†æ˜¯ä¸€æ ·çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ServerSocket ss=<span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">9000</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> ss.accept();</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> s.getInputStream();</span><br><span class="line">            <span class="comment">// è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">            <span class="type">byte</span>[] arr = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> in.read(arr);</span><br><span class="line">                <span class="comment">// è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">                <span class="keyword">if</span>(read == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(arr, <span class="number">0</span>, read));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">max</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> max.getOutputStream();</span><br><span class="line">        out.write(<span class="string">&quot;hello&quot;</span>.getBytes());</span><br><span class="line">        out.write(<span class="string">&quot;world&quot;</span>.getBytes());</span><br><span class="line">        out.write(<span class="string">&quot;ä½ å¥½&quot;</span>.getBytes());</span><br><span class="line">        max.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hell</span><br><span class="line">owor</span><br><span class="line">ldï¿½</span><br><span class="line">ï¿½å¥½</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆï¼Ÿ</p><h4 id="å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ"><a href="#å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ" class="headerlink" title="å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ"></a>å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ</h4><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0023.png" alt=""></p><ul><li>ä¸€ç§æ€è·¯æ˜¯å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½</li><li>å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½</li><li>TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡<ul><li>Http 1.1 æ˜¯ TLV æ ¼å¼</li><li>Http 2.0 æ˜¯ LTV æ ¼å¼</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram </span><br><span class="line">participant c1 as å®¢æˆ·ç«¯1</span><br><span class="line">participant s as æœåŠ¡å™¨</span><br><span class="line">participant b1 as ByteBuffer1</span><br><span class="line">participant b2 as ByteBuffer2</span><br><span class="line">c1 -&gt;&gt; s: å‘é€ 01234567890abcdef3333\r</span><br><span class="line">s -&gt;&gt; b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef</span><br><span class="line">s -&gt;&gt; b2: æ‰©å®¹</span><br><span class="line">b1 -&gt;&gt; b2: æ‹·è´ 01234567890abcdef</span><br><span class="line">s -&gt;&gt; b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\r</span><br><span class="line">b2 -&gt;&gt; b2: 01234567890abcdef3333\r</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">split</span><span class="params">(ByteBuffer source)</span> &#123;</span><br><span class="line">    source.flip();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; source.limit(); i++) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">if</span> (source.get(i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> i + <span class="number">1</span> - source.position();</span><br><span class="line">            <span class="comment">// æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">target</span> <span class="operator">=</span> ByteBuffer.allocate(length);</span><br><span class="line">            <span class="comment">// ä» source è¯»ï¼Œå‘ target å†™</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; length; j++) &#123;</span><br><span class="line">                target.put(source.get());</span><br><span class="line">            &#125;</span><br><span class="line">            debugAll(target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    source.compact(); <span class="comment">// 0123456789abcdef  position 16 limit 16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel</span></span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">    <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">    ssc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰</span></span><br><span class="line">    <span class="comment">// SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶</span></span><br><span class="line">    <span class="type">SelectionKey</span> <span class="variable">sscKey</span> <span class="operator">=</span> ssc.register(selector, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// key åªå…³æ³¨ accept äº‹ä»¶</span></span><br><span class="line">    sscKey.interestOps(SelectionKey.OP_ACCEPT);</span><br><span class="line">    log.debug(<span class="string">&quot;sscKey:&#123;&#125;&quot;</span>, sscKey);</span><br><span class="line">    ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ</span></span><br><span class="line">        <span class="comment">// select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†</span></span><br><span class="line">        selector.select();</span><br><span class="line">        <span class="comment">// 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶</span></span><br><span class="line">        Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator(); <span class="comment">// accept, read</span></span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">            <span class="comment">// å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜</span></span><br><span class="line">            iter.remove();</span><br><span class="line">            log.debug(<span class="string">&quot;key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="comment">// 5. åŒºåˆ†äº‹ä»¶ç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (key.isAcceptable()) &#123; <span class="comment">// å¦‚æœæ˜¯ accept</span></span><br><span class="line">                <span class="type">ServerSocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> channel.accept();</span><br><span class="line">                sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">16</span>); <span class="comment">// attachment</span></span><br><span class="line">                <span class="comment">// å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š</span></span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">scKey</span> <span class="operator">=</span> sc.register(selector, <span class="number">0</span>, buffer);</span><br><span class="line">                scKey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, sc);</span><br><span class="line">                log.debug(<span class="string">&quot;scKey:&#123;&#125;&quot;</span>, scKey);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123; <span class="comment">// å¦‚æœæ˜¯ read</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel(); <span class="comment">// æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel</span></span><br><span class="line">                    <span class="comment">// è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶</span></span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(buffer); <span class="comment">// å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1</span></span><br><span class="line">                    <span class="keyword">if</span>(read == -<span class="number">1</span>) &#123;</span><br><span class="line">                        key.cancel();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        split(buffer);</span><br><span class="line">                        <span class="comment">// éœ€è¦æ‰©å®¹</span></span><br><span class="line">                        <span class="keyword">if</span> (buffer.position() == buffer.limit()) &#123;</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">newBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(buffer.capacity() * <span class="number">2</span>);</span><br><span class="line">                            buffer.flip();</span><br><span class="line">                            newBuffer.put(buffer); <span class="comment">// 0123456789abcdef3333\n</span></span><br><span class="line">                            key.attach(newBuffer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    key.cancel();  <span class="comment">// å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">sc.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line"><span class="type">SocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> sc.getLocalAddress();</span><br><span class="line"><span class="comment">// sc.write(Charset.defaultCharset().encode(&quot;hello\nworld\n&quot;));</span></span><br><span class="line">sc.write(Charset.defaultCharset().encode(<span class="string">&quot;0123\n456789abcdef&quot;</span>));</span><br><span class="line">sc.write(Charset.defaultCharset().encode(<span class="string">&quot;0123456789abcdef3333\n&quot;</span>));</span><br><span class="line">System.in.read();</span><br></pre></td></tr></table></figure><h4 id="ByteBuffer-å¤§å°åˆ†é…"><a href="#ByteBuffer-å¤§å°åˆ†é…" class="headerlink" title="ByteBuffer å¤§å°åˆ†é…"></a>ByteBuffer å¤§å°åˆ†é…</h4><ul><li>æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer</li><li>ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer<ul><li>ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° <a href="http://tutorials.jenkov.com/java-performance/resizable-array.html">http://tutorials.jenkov.com/java-performance/resizable-array.html</a></li><li>å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—</li></ul></li></ul><h3 id="4-5-å¤„ç†-write-äº‹ä»¶"><a href="#4-5-å¤„ç†-write-äº‹ä»¶" class="headerlink" title="4.5 å¤„ç† write äº‹ä»¶"></a>4.5 å¤„ç† write äº‹ä»¶</h3><h4 id="ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­"><a href="#ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­" class="headerlink" title="ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­"></a>ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­</h4><ul><li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰</li><li>ç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤šï¼Œå°±æœ‰ä¸¤é˜¶æ®µç­–ç•¥<ul><li>å½“æ¶ˆæ¯å¤„ç†å™¨ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œåˆ° selector ä¸Š</li><li>selector æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ channel çš„æ³¨å†Œ</li><li>å¦‚æœä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        ssc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        ssc.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line"></span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                iter.remove();</span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> ssc.accept();</span><br><span class="line">                    sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">sckey</span> <span class="operator">=</span> sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    <span class="comment">// 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹</span></span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3000000</span>; i++) &#123;</span><br><span class="line">                        sb.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> Charset.defaultCharset().encode(sb.toString());</span><br><span class="line">                    <span class="type">int</span> <span class="variable">write</span> <span class="operator">=</span> sc.write(buffer);</span><br><span class="line">                    <span class="comment">// 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;å®é™…å†™å…¥å­—èŠ‚:&quot;</span> + write);</span><br><span class="line">                    <span class="comment">// 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶</span></span><br><span class="line">                    <span class="keyword">if</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">                        <span class="comment">// read 1  write 4</span></span><br><span class="line">                        <span class="comment">// åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶</span></span><br><span class="line">                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);</span><br><span class="line">                        <span class="comment">// æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey</span></span><br><span class="line">                        sckey.attach(buffer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">write</span> <span class="operator">=</span> sc.write(buffer);</span><br><span class="line">                    System.out.println(<span class="string">&quot;å®é™…å†™å…¥å­—èŠ‚:&quot;</span> + write);</span><br><span class="line">                    <span class="keyword">if</span> (!buffer.hasRemaining()) &#123; <span class="comment">// å†™å®Œäº†</span></span><br><span class="line">                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);</span><br><span class="line">                        key.attach(<span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);</span><br><span class="line">        sc.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                iter.remove();</span><br><span class="line">                <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">                    System.out.println(sc.finishConnect());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">                    count += sc.read(buffer);</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                    System.out.println(count);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-write-ä¸ºä½•è¦å–æ¶ˆ"><a href="#ğŸ’¡-write-ä¸ºä½•è¦å–æ¶ˆ" class="headerlink" title="ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ"></a>ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ</h4><p>åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨</p><h3 id="4-6-æ›´è¿›ä¸€æ­¥"><a href="#4-6-æ›´è¿›ä¸€æ­¥" class="headerlink" title="4.6 æ›´è¿›ä¸€æ­¥"></a>4.6 æ›´è¿›ä¸€æ­¥</h3><h4 id="ğŸ’¡-åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–"><a href="#ğŸ’¡-åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–" class="headerlink" title="ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–"></a>ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–</h4><blockquote><p>ç°åœ¨éƒ½æ˜¯å¤šæ ¸ cpuï¼Œè®¾è®¡æ—¶è¦å……åˆ†è€ƒè™‘åˆ«è®© cpu çš„åŠ›é‡è¢«ç™½ç™½æµªè´¹</p></blockquote><p>å‰é¢çš„ä»£ç åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ cpuï¼Œå¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿ</p><p>åˆ†ä¸¤ç»„é€‰æ‹©å™¨</p><ul><li>å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶</li><li>åˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelDemo7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">BossEventLoop</span>().register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Slf4j</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BossEventLoop</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Selector boss;</span><br><span class="line">        <span class="keyword">private</span> WorkerEventLoop[] workers;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">start</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (!start) &#123;</span><br><span class="line">                <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">                ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">                ssc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                boss = Selector.open();</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">ssckey</span> <span class="operator">=</span> ssc.register(boss, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">                ssckey.interestOps(SelectionKey.OP_ACCEPT);</span><br><span class="line">                workers = initEventLoops();</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>, <span class="string">&quot;boss&quot;</span>).start();</span><br><span class="line">                log.debug(<span class="string">&quot;boss start...&quot;</span>);</span><br><span class="line">                start = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> WorkerEventLoop[] initEventLoops() &#123;</span><br><span class="line"><span class="comment">//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];</span></span><br><span class="line">            WorkerEventLoop[] workerEventLoops = <span class="keyword">new</span> <span class="title class_">WorkerEventLoop</span>[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; workerEventLoops.length; i++) &#123;</span><br><span class="line">                workerEventLoops[i] = <span class="keyword">new</span> <span class="title class_">WorkerEventLoop</span>(i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> workerEventLoops;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    boss.select();</span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iter = boss.selectedKeys().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                        iter.remove();</span><br><span class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                            <span class="type">ServerSocketChannel</span> <span class="variable">c</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                            <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> c.accept();</span><br><span class="line">                            sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                            log.debug(<span class="string">&quot;&#123;&#125; connected&quot;</span>, sc.getRemoteAddress());</span><br><span class="line">                            workers[index.getAndIncrement() % workers.length].register(sc);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Slf4j</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WorkerEventLoop</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Selector worker;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">start</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> index;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentLinkedQueue&lt;Runnable&gt; tasks = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">WorkerEventLoop</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.index = index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (!start) &#123;</span><br><span class="line">                worker = Selector.open();</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>, <span class="string">&quot;worker-&quot;</span> + index).start();</span><br><span class="line">                start = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tasks.add(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">sckey</span> <span class="operator">=</span> sc.register(worker, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">                    sckey.interestOps(SelectionKey.OP_READ);</span><br><span class="line">                    worker.selectNow();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            worker.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    worker.select();</span><br><span class="line">                    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> tasks.poll();</span><br><span class="line">                    <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">                        task.run();</span><br><span class="line">                    &#125;</span><br><span class="line">                    Set&lt;SelectionKey&gt; keys = worker.selectedKeys();</span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iter = keys.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                        <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                            <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> sc.read(buffer);</span><br><span class="line">                                <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                                    key.cancel();</span><br><span class="line">                                    sc.close();</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    buffer.flip();</span><br><span class="line">                                    log.debug(<span class="string">&quot;&#123;&#125; message:&quot;</span>, sc.getRemoteAddress());</span><br><span class="line">                                    debugAll(buffer);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                                key.cancel();</span><br><span class="line">                                sc.close();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        iter.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ğŸ’¡-å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°"><a href="#ğŸ’¡-å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°" class="headerlink" title="ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°"></a>ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°</h4><blockquote><ul><li>Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°</li><li>è¿™ä¸ªé—®é¢˜ç›´åˆ° jdk 10 æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯</li></ul></blockquote><h3 id="4-7-UDP"><a href="#4-7-UDP" class="headerlink" title="4.7 UDP"></a>4.7 UDP</h3><ul><li>UDP æ˜¯æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯</li><li>server è¿™è¾¹çš„ receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ</li></ul><p>é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UdpServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">DatagramChannel</span> <span class="variable">channel</span> <span class="operator">=</span> DatagramChannel.open()) &#123;</span><br><span class="line">            channel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">32</span>);</span><br><span class="line">            channel.receive(buffer);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            debug(buffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">waiting...</span><br></pre></td></tr></table></figure><p>è¿è¡Œå®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UdpClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">DatagramChannel</span> <span class="variable">channel</span> <span class="operator">=</span> DatagramChannel.open()) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> StandardCharsets.UTF_8.encode(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">            <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">            channel.send(buffer, address);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æœåŠ¡å™¨ç«¯è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 68 65 6c 6c 6f                                  |hello           |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><h2 id="5-NIO-vs-BIO"><a href="#5-NIO-vs-BIO" class="headerlink" title="5. NIO vs BIO"></a>5. NIO vs BIO</h2><h3 id="5-1-stream-vs-channel"><a href="#5-1-stream-vs-channel" class="headerlink" title="5.1 stream vs channel"></a>5.1 stream vs channel</h3><ul><li>stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰</li><li>stream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨</li><li>äºŒè€…å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ</li></ul><h3 id="5-2-IO-æ¨¡å‹"><a href="#5-2-IO-æ¨¡å‹" class="headerlink" title="5.2 IO æ¨¡å‹"></a>5.2 IO æ¨¡å‹</h3><p>åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡</p><ul><li>åŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰</li><li>å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰</li></ul><p>å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š</p><ul><li>ç­‰å¾…æ•°æ®é˜¶æ®µ</li><li>å¤åˆ¶æ•°æ®é˜¶æ®µ</li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0033.png" alt=""></p><ul><li><p>é˜»å¡ IO</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0039.png" alt=""></p></li><li><p>éé˜»å¡  IO</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0035.png" alt=""></p></li><li><p>å¤šè·¯å¤ç”¨</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0038.png" alt=""></p></li><li><p>ä¿¡å·é©±åŠ¨</p></li><li><p>å¼‚æ­¥ IO</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0037.png" alt=""></p></li><li><p>é˜»å¡ IO vs å¤šè·¯å¤ç”¨</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0034.png" alt=""></p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0036.png" alt=""></p></li></ul><h4 id="ğŸ”–-å‚è€ƒ"><a href="#ğŸ”–-å‚è€ƒ" class="headerlink" title="ğŸ”– å‚è€ƒ"></a>ğŸ”– å‚è€ƒ</h4><p>UNIX ç½‘ç»œç¼–ç¨‹ - å· I</p><h3 id="5-3-é›¶æ‹·è´"><a href="#5-3-é›¶æ‹·è´" class="headerlink" title="5.3 é›¶æ‹·è´"></a>5.3 é›¶æ‹·è´</h3><h4 id="ä¼ ç»Ÿ-IO-é—®é¢˜"><a href="#ä¼ ç»Ÿ-IO-é—®é¢˜" class="headerlink" title="ä¼ ç»Ÿ IO é—®é¢˜"></a>ä¼ ç»Ÿ IO é—®é¢˜</h4><p>ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;helloword/data.txt&quot;</span>);</span><br><span class="line"><span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>)f.length()];</span><br><span class="line">file.read(buf);</span><br><span class="line"></span><br><span class="line"><span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> ...;</span><br><span class="line">socket.getOutputStream().write(buf);</span><br></pre></td></tr></table></figure><p>å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0024.png" alt=""></p><ol><li><p>java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu</p><blockquote><p>DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO</p></blockquote></li><li><p>ä»<strong>å†…æ ¸æ€</strong>åˆ‡æ¢å›<strong>ç”¨æˆ·æ€</strong>ï¼Œå°†æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>è¯»å…¥<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA</p></li><li><p>è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆbyte[] bufï¼‰å†™å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</p></li><li><p>æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</p></li></ol><p>å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„</p><ul><li>ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§</li><li>æ•°æ®æ‹·è´äº†å…± 4 æ¬¡</li></ul><h4 id="NIO-ä¼˜åŒ–"><a href="#NIO-ä¼˜åŒ–" class="headerlink" title="NIO ä¼˜åŒ–"></a>NIO ä¼˜åŒ–</h4><p>é€šè¿‡ DirectByteBuf </p><ul><li>ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜</li><li>ByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜</li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0025.png" alt=""></p><p>å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨</p><ul><li>è¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™</li><li>java ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥<ul><li>DirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—</li><li>é€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜</li></ul></li><li>å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘</li></ul><p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ transferTo/transferFrom æ–¹æ³•æ‹·è´æ•°æ®</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0026.png" alt=""></p><ol><li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li><li>æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>ä¼ è¾“åˆ° <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</li><li>æœ€åä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li></ol><p>å¯ä»¥çœ‹åˆ°</p><ul><li>åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li><li>æ•°æ®æ‹·è´äº† 3 æ¬¡</li></ul><p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆlinux 2.4ï¼‰</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0027.png" alt=""></p><ol><li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li><li>åªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œå‡ ä¹æ— æ¶ˆè€—</li><li>ä½¿ç”¨ DMA å°† <strong>å†…æ ¸ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li></ol><p>æ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯åœ¨ä¸ä¼šæ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰</p><ul><li>æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li><li>ä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«</li><li>é›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“</li></ul><h3 id="5-3-AIO"><a href="#5-3-AIO" class="headerlink" title="5.3 AIO"></a>5.3 AIO</h3><p>AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜</p><ul><li>åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®</li><li>å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ</li></ul><blockquote><p>å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ</p><ul><li>Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO</li><li>Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿</li></ul></blockquote><h4 id="æ–‡ä»¶-AIO"><a href="#æ–‡ä»¶-AIO" class="headerlink" title="æ–‡ä»¶ AIO"></a>æ–‡ä»¶ AIO</h4><p>å…ˆæ¥çœ‹çœ‹ AsynchronousFileChannel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AioDemo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">AsynchronousFileChannel</span> <span class="variable">s</span> <span class="operator">=</span> </span><br><span class="line">                AsynchronousFileChannel.open(</span><br><span class="line">                Paths.get(<span class="string">&quot;1.txt&quot;</span>), StandardOpenOption.READ);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">2</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">            s.read(buffer, <span class="number">0</span>, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;read completed...&#123;&#125;&quot;</span>, result);</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    debug(buffer);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;read failed...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;do other things...&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...</span><br><span class="line">13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...</span><br><span class="line">13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2</span><br><span class="line">         +-------------------------------------------------+</span><br><span class="line">         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br><span class="line">|00000000| 61 0d                                           |a.              |</span><br><span class="line">+--------+-------------------------------------------------+----------------+</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°</p><ul><li>å“åº”æ–‡ä»¶è¯»å–æˆåŠŸçš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ Thread-5</li><li>ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ IO æ“ä½œé˜»å¡</li></ul><h4 id="ğŸ’¡-å®ˆæŠ¤çº¿ç¨‹"><a href="#ğŸ’¡-å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹"></a>ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹</h4><p>é»˜è®¤æ–‡ä»¶ AIO ä½¿ç”¨çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åè¦æ‰§è¡Œ <code>System.in.read()</code> ä»¥é¿å…å®ˆæŠ¤çº¿ç¨‹æ„å¤–ç»“æŸ</p><h4 id="ç½‘ç»œ-AIO"><a href="#ç½‘ç»œ-AIO" class="headerlink" title="ç½‘ç»œ AIO"></a>ç½‘ç»œ AIO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AioServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">AsynchronousServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> AsynchronousServerSocketChannel.open();</span><br><span class="line">        ssc.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        ssc.accept(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">AcceptHandler</span>(ssc));</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeChannel</span><span class="params">(AsynchronousSocketChannel sc)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;[%s] %s close\n&quot;</span>, Thread.currentThread().getName(), sc.getRemoteAddress());</span><br><span class="line">            sc.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReadHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AsynchronousSocketChannel sc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ReadHandler</span><span class="params">(AsynchronousSocketChannel sc)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.sc = sc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (result == -<span class="number">1</span>) &#123;</span><br><span class="line">                    closeChannel(sc);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.printf(<span class="string">&quot;[%s] %s read\n&quot;</span>, Thread.currentThread().getName(), sc.getRemoteAddress());</span><br><span class="line">                attachment.flip();</span><br><span class="line">                System.out.println(Charset.defaultCharset().decode(attachment));</span><br><span class="line">                attachment.clear();</span><br><span class="line">                <span class="comment">// å¤„ç†å®Œç¬¬ä¸€ä¸ª read æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ read æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª read äº‹ä»¶</span></span><br><span class="line">                sc.read(attachment, attachment, <span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">            closeChannel(sc);</span><br><span class="line">            exc.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WriteHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AsynchronousSocketChannel sc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">WriteHandler</span><span class="params">(AsynchronousSocketChannel sc)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.sc = sc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä½œä¸ºé™„ä»¶çš„ buffer è¿˜æœ‰å†…å®¹ï¼Œéœ€è¦å†æ¬¡ write å†™å‡ºå‰©ä½™å†…å®¹</span></span><br><span class="line">            <span class="keyword">if</span> (attachment.hasRemaining()) &#123;</span><br><span class="line">                sc.write(attachment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">            exc.printStackTrace();</span><br><span class="line">            closeChannel(sc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AcceptHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, Object&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AsynchronousServerSocketChannel ssc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AcceptHandler</span><span class="params">(AsynchronousServerSocketChannel ssc)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.ssc = ssc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel sc, Object attachment)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;[%s] %s connected\n&quot;</span>, Thread.currentThread().getName(), sc.getRemoteAddress());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">16</span>);</span><br><span class="line">            <span class="comment">// è¯»äº‹ä»¶ç”± ReadHandler å¤„ç†</span></span><br><span class="line">            sc.read(buffer, buffer, <span class="keyword">new</span> <span class="title class_">ReadHandler</span>(sc));</span><br><span class="line">            <span class="comment">// å†™äº‹ä»¶ç”± WriteHandler å¤„ç†</span></span><br><span class="line">            sc.write(Charset.defaultCharset().encode(<span class="string">&quot;server hello!&quot;</span>), ByteBuffer.allocate(<span class="number">16</span>), <span class="keyword">new</span> <span class="title class_">WriteHandler</span>(sc));</span><br><span class="line">            <span class="comment">// å¤„ç†å®Œç¬¬ä¸€ä¸ª accpet æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ accept æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª accept äº‹ä»¶</span></span><br><span class="line">            ssc.accept(<span class="literal">null</span>, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, Object attachment)</span> &#123;</span><br><span class="line">            exc.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">RPCæ¡†æ¶ï¼ŒNettyå®æˆ˜</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="netty" scheme="https://www.jodio.cc/tags/netty/"/>
    
  </entry>
  
  <entry>
    <title>Netty(å››) -- ä¼˜åŒ–ä¸æºç ç¯‡</title>
    <link href="https://www.jodio.cc/posts/netty-source.html"/>
    <id>https://www.jodio.cc/posts/netty-source.html</id>
    <published>2023-04-21T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å››-ä¼˜åŒ–ä¸æºç "><a href="#å››-ä¼˜åŒ–ä¸æºç " class="headerlink" title="å››. ä¼˜åŒ–ä¸æºç "></a>å››. ä¼˜åŒ–ä¸æºç </h1><h2 id="1-ä¼˜åŒ–"><a href="#1-ä¼˜åŒ–" class="headerlink" title="1. ä¼˜åŒ–"></a>1. ä¼˜åŒ–</h2><h3 id="1-1-æ‰©å±•åºåˆ—åŒ–ç®—æ³•"><a href="#1-1-æ‰©å±•åºåˆ—åŒ–ç®—æ³•" class="headerlink" title="1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•"></a>1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</h3><p>åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š</p><ul><li>åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰</li><li>ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†</li></ul><p>ç›®å‰çš„ä»£ç ä»…æ”¯æŒ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line"><span class="type">byte</span>[] body = <span class="keyword">new</span> <span class="title class_">byte</span>[bodyLength];</span><br><span class="line">byteByf.readBytes(body);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(body));</span><br><span class="line"><span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) in.readObject();</span><br><span class="line">message.setSequenceId(sequenceId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out).writeObject(message);</span><br><span class="line"><span class="type">byte</span>[] bytes = out.toByteArray();</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ”¯æŒæ›´å¤šåºåˆ—åŒ–ç®—æ³•ï¼ŒæŠ½è±¡ä¸€ä¸ª Serializer æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–æ–¹æ³•</span></span><br><span class="line">    &lt;T&gt; <span class="type">byte</span>[] serialize(T object);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æä¾›ä¸¤ä¸ªå®ç°ï¼Œæˆ‘è¿™é‡Œç›´æ¥å°†å®ç°åŠ å…¥äº†æšä¸¾ç±» Serializer.Algorithm ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">SerializerAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line"><span class="comment">// Java å®ç°</span></span><br><span class="line">    Java &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> in.readObject();</span><br><span class="line">                <span class="keyword">return</span> (T) object;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T object) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out).writeObject(object);</span><br><span class="line">                <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="comment">// Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)</span></span><br><span class="line">    Json &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(Class&lt;T&gt; clazz, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8), clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T object) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(object).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SerializerAlgorithm <span class="title function_">getByInt</span><span class="params">(<span class="type">int</span> type)</span> &#123;</span><br><span class="line">        SerializerAlgorithm[] array = SerializerAlgorithm.values();</span><br><span class="line">        <span class="keyword">if</span> (type &lt; <span class="number">0</span> || type &gt; array.length - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;è¶…è¿‡ SerializerAlgorithm èŒƒå›´&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> array[type];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¢åŠ é…ç½®ç±»å’Œé…ç½®æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Properties properties;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Config.class.getResourceAsStream(<span class="string">&quot;/application.properties&quot;</span>)) &#123;</span><br><span class="line">            properties = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(in);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExceptionInInitializerError</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getServerPort</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;server.port&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">8080</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Serializer.Algorithm <span class="title function_">getSerializerAlgorithm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;serializer.algorithm&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Serializer.Algorithm.Java;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Serializer.Algorithm.valueOf(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">serializer.algorithm</span>=<span class="string">Json</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ç¼–è§£ç å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageCodecSharable</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageCodec</span>&lt;ByteBuf, Message&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">out</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">        <span class="comment">// 1. 4 å­—èŠ‚çš„é­”æ•°</span></span><br><span class="line">        out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="comment">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span></span><br><span class="line">        out.writeByte(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span></span><br><span class="line">        out.writeByte(Config.getSerializerAlgorithm().ordinal());</span><br><span class="line">        <span class="comment">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span></span><br><span class="line">        out.writeByte(msg.getMessageType());</span><br><span class="line">        <span class="comment">// 5. 4 ä¸ªå­—èŠ‚</span></span><br><span class="line">        out.writeInt(msg.getSequenceId());</span><br><span class="line">        <span class="comment">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span></span><br><span class="line">        out.writeByte(<span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = Config.getSerializerAlgorithm().serialize(msg);</span><br><span class="line">        <span class="comment">// 7. é•¿åº¦</span></span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        <span class="comment">// 8. å†™å…¥å†…å®¹</span></span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">        outList.add(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magicNum</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> in.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">serializerAlgorithm</span> <span class="operator">=</span> in.readByte(); <span class="comment">// 0 æˆ– 1</span></span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> in.readByte(); <span class="comment">// 0,1,2...</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        in.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        in.readBytes(bytes, <span class="number">0</span>, length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°ååºåˆ—åŒ–ç®—æ³•</span></span><br><span class="line">        Serializer.<span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Serializer.Algorithm.values()[serializerAlgorithm];</span><br><span class="line">        <span class="comment">// ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">Message</span>&gt; messageClass = Message.getMessageClass(messageType);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> algorithm.deserialize(messageClass, bytes);</span><br><span class="line"><span class="comment">//        log.debug(&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;, magicNum, version, serializerType, messageType, sequenceId, length);</span></span><br><span class="line"><span class="comment">//        log.debug(&quot;&#123;&#125;&quot;, message);</span></span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥æ ¹æ® <code>æ¶ˆæ¯ç±»å‹å­—èŠ‚</code> è·å–åˆ°å¯¹åº”çš„ <code>æ¶ˆæ¯ class</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®æ¶ˆæ¯ç±»å‹å­—èŠ‚ï¼Œè·å¾—å¯¹åº”çš„æ¶ˆæ¯ class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType æ¶ˆæ¯ç±»å‹å­—èŠ‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ¶ˆæ¯ class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Message</span>&gt; getMessageClass(<span class="type">int</span> messageType) &#123;</span><br><span class="line">        <span class="keyword">return</span> messageClasses.get(messageType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sequenceId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> messageType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">getMessageType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LoginRequestMessage</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LoginResponseMessage</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ChatRequestMessage</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ChatResponseMessage</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupCreateRequestMessage</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupCreateResponseMessage</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupJoinRequestMessage</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupJoinResponseMessage</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupQuitRequestMessage</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupQuitResponseMessage</span> <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupChatRequestMessage</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupChatResponseMessage</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupMembersRequestMessage</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GroupMembersResponseMessage</span> <span class="operator">=</span> <span class="number">13</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PingMessage</span> <span class="operator">=</span> <span class="number">14</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PongMessage</span> <span class="operator">=</span> <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, Class&lt;? <span class="keyword">extends</span> <span class="title class_">Message</span>&gt;&gt; messageClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        messageClasses.put(LoginRequestMessage, LoginRequestMessage.class);</span><br><span class="line">        messageClasses.put(LoginResponseMessage, LoginResponseMessage.class);</span><br><span class="line">        messageClasses.put(ChatRequestMessage, ChatRequestMessage.class);</span><br><span class="line">        messageClasses.put(ChatResponseMessage, ChatResponseMessage.class);</span><br><span class="line">        messageClasses.put(GroupCreateRequestMessage, GroupCreateRequestMessage.class);</span><br><span class="line">        messageClasses.put(GroupCreateResponseMessage, GroupCreateResponseMessage.class);</span><br><span class="line">        messageClasses.put(GroupJoinRequestMessage, GroupJoinRequestMessage.class);</span><br><span class="line">        messageClasses.put(GroupJoinResponseMessage, GroupJoinResponseMessage.class);</span><br><span class="line">        messageClasses.put(GroupQuitRequestMessage, GroupQuitRequestMessage.class);</span><br><span class="line">        messageClasses.put(GroupQuitResponseMessage, GroupQuitResponseMessage.class);</span><br><span class="line">        messageClasses.put(GroupChatRequestMessage, GroupChatRequestMessage.class);</span><br><span class="line">        messageClasses.put(GroupChatResponseMessage, GroupChatResponseMessage.class);</span><br><span class="line">        messageClasses.put(GroupMembersRequestMessage, GroupMembersRequestMessage.class);</span><br><span class="line">        messageClasses.put(GroupMembersResponseMessage, GroupMembersResponseMessage.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-å‚æ•°è°ƒä¼˜"><a href="#1-2-å‚æ•°è°ƒä¼˜" class="headerlink" title="1.2 å‚æ•°è°ƒä¼˜"></a>1.2 å‚æ•°è°ƒä¼˜</h3><h4 id="1ï¼‰CONNECT-TIMEOUT-MILLIS"><a href="#1ï¼‰CONNECT-TIMEOUT-MILLIS" class="headerlink" title="1ï¼‰CONNECT_TIMEOUT_MILLIS"></a>1ï¼‰CONNECT_TIMEOUT_MILLIS</h4><ul><li>å±äº SocketChannal å‚æ•°</li><li><p>ç”¨åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸</p></li><li><p>SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œä½¿ç”¨å®ƒè°ƒæ•´è¶…æ—¶æ—¶é—´</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestConnectionTimeout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                    .group(group)</span><br><span class="line">                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">300</span>)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>());</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">            future.sync().channel().closeFuture().sync(); <span class="comment">// æ–­ç‚¹1</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.debug(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–æºç éƒ¨åˆ† <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Schedule connect timeout.</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">connectTimeoutMillis</span> <span class="operator">=</span> config().getConnectTimeoutMillis();</span><br><span class="line">    <span class="keyword">if</span> (connectTimeoutMillis &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        connectTimeoutFuture = eventLoop().schedule(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;                </span><br><span class="line">                <span class="type">ChannelPromise</span> <span class="variable">connectPromise</span> <span class="operator">=</span> AbstractNioChannel.<span class="built_in">this</span>.connectPromise;</span><br><span class="line">                <span class="type">ConnectTimeoutException</span> <span class="variable">cause</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConnectTimeoutException</span>(<span class="string">&quot;connection timed out: &quot;</span> + remoteAddress); <span class="comment">// æ–­ç‚¹2</span></span><br><span class="line">                <span class="keyword">if</span> (connectPromise != <span class="literal">null</span> &amp;&amp; connectPromise.tryFailure(cause)) &#123;</span><br><span class="line">                    close(voidPromise());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, connectTimeoutMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2ï¼‰SO-BACKLOG"><a href="#2ï¼‰SO-BACKLOG" class="headerlink" title="2ï¼‰SO_BACKLOG"></a>2ï¼‰SO_BACKLOG</h4><ul><li>å±äº ServerSocketChannal å‚æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line"></span><br><span class="line">participant c as client</span><br><span class="line">participant s as server</span><br><span class="line">participant sq as syns queue</span><br><span class="line">participant aq as accept queue</span><br><span class="line"></span><br><span class="line">s -&gt;&gt; s : bind()</span><br><span class="line">s -&gt;&gt; s : listen()</span><br><span class="line">c -&gt;&gt; c : connect()</span><br><span class="line">c -&gt;&gt; s : 1. SYN</span><br><span class="line">Note left of c : SYN_SEND</span><br><span class="line">s -&gt;&gt; sq : put</span><br><span class="line">Note right of s : SYN_RCVD</span><br><span class="line">s -&gt;&gt; c : 2. SYN + ACK</span><br><span class="line">Note left of c : ESTABLISHED</span><br><span class="line">c -&gt;&gt; s : 3. ACK</span><br><span class="line">sq -&gt;&gt; aq : put</span><br><span class="line">Note right of s : ESTABLISHED</span><br><span class="line">aq --&gt;&gt; s : </span><br><span class="line">s -&gt;&gt; s : accept()</span><br></pre></td></tr></table></figure><ol><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œclient å‘é€ SYN åˆ° serverï¼ŒçŠ¶æ€ä¿®æ”¹ä¸º SYN_SENDï¼Œserver æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º SYN_REVDï¼Œå¹¶å°†è¯¥è¯·æ±‚æ”¾å…¥ sync queue é˜Ÿåˆ—</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œserver å›å¤ SYN + ACK ç»™ clientï¼Œclient æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå¹¶å‘é€ ACK ç»™ server</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œserver æ”¶åˆ° ACKï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå°†è¯¥è¯·æ±‚ä» sync queue æ”¾å…¥ accept queue</li></ol><p>å…¶ä¸­</p><ul><li><p>åœ¨ linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶</p></li><li><p>sync queue - åŠè¿æ¥é˜Ÿåˆ—</p><ul><li>å¤§å°é€šè¿‡ /proc/sys/net/ipv4/tcp_max_syn_backlog æŒ‡å®šï¼Œåœ¨ <code>syncookies</code> å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ï¼Œè¿™ä¸ªè®¾ç½®ä¾¿è¢«å¿½ç•¥</li></ul></li><li>accept queue - å…¨è¿æ¥é˜Ÿåˆ—<ul><li>å…¶å¤§å°é€šè¿‡ /proc/sys/net/core/somaxconn æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼</li><li>å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯åˆ° client</li></ul></li></ul><p>netty ä¸­</p><p>å¯ä»¥é€šè¿‡  option(ChannelOption.SO_BACKLOG, å€¼) æ¥è®¾ç½®å¤§å°</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢æºç æŸ¥çœ‹é»˜è®¤å¤§å°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultServerSocketChannelConfig</span> <span class="keyword">extends</span> <span class="title class_">DefaultChannelConfig</span></span><br><span class="line">                                              <span class="keyword">implements</span> <span class="title class_">ServerSocketChannelConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">backlog</span> <span class="operator">=</span> NetUtil.SOMAXCONN;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¾å ‚è°ƒè¯•å…³é”®æ–­ç‚¹ä¸ºï¼š<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><p>oio ä¸­æ›´å®¹æ˜“è¯´æ˜ï¼Œä¸ç”¨ debug æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8888</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">accept</span> <span class="operator">=</span> ss.accept();</span><br><span class="line">        System.out.println(accept);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å¯åŠ¨ 4 ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>();</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>()+<span class="string">&quot; connecting...&quot;</span>);</span><br><span class="line">            s.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8888</span>),<span class="number">1000</span>);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>()+<span class="string">&quot; connected...&quot;</span>);</span><br><span class="line">            s.getOutputStream().write(<span class="number">1</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>()+<span class="string">&quot; connecting timeout...&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 1ï¼Œ2ï¼Œ3 ä¸ªå®¢æˆ·ç«¯éƒ½æ‰“å°ï¼Œä½†é™¤äº†ç¬¬ä¸€ä¸ªå¤„äº accpet å¤–ï¼Œå…¶å®ƒä¸¤ä¸ªéƒ½å¤„äº accept queue ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tue Apr <span class="number">21</span> <span class="number">20</span>:<span class="number">30</span>:<span class="number">28</span> CST <span class="number">2020</span> connecting...</span><br><span class="line">Tue Apr <span class="number">21</span> <span class="number">20</span>:<span class="number">30</span>:<span class="number">28</span> CST <span class="number">2020</span> connected...</span><br></pre></td></tr></table></figure><p>ç¬¬ 4 ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Tue Apr 21 20:53:58 CST 2020 connecting...</span><br><span class="line">Tue Apr 21 20:53:59 CST 2020 connecting timeout...</span><br><span class="line">java.net.SocketTimeoutException: connect timed out</span><br></pre></td></tr></table></figure><h4 id="3ï¼‰ulimit-n"><a href="#3ï¼‰ulimit-n" class="headerlink" title="3ï¼‰ulimit -n"></a>3ï¼‰ulimit -n</h4><ul><li>å±äºæ“ä½œç³»ç»Ÿå‚æ•°</li></ul><h4 id="4ï¼‰TCP-NODELAY"><a href="#4ï¼‰TCP-NODELAY" class="headerlink" title="4ï¼‰TCP_NODELAY"></a>4ï¼‰TCP_NODELAY</h4><ul><li>å±äº SocketChannal å‚æ•°</li></ul><h4 id="5ï¼‰SO-SNDBUF-amp-SO-RCVBUF"><a href="#5ï¼‰SO-SNDBUF-amp-SO-RCVBUF" class="headerlink" title="5ï¼‰SO_SNDBUF &amp; SO_RCVBUF"></a>5ï¼‰SO_SNDBUF &amp; SO_RCVBUF</h4><ul><li>SO_SNDBUF å±äº SocketChannal å‚æ•°</li><li>SO_RCVBUF æ—¢å¯ç”¨äº SocketChannal å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äº ServerSocketChannal å‚æ•°ï¼ˆå»ºè®®è®¾ç½®åˆ° ServerSocketChannal ä¸Šï¼‰</li></ul><h4 id="6ï¼‰ALLOCATOR"><a href="#6ï¼‰ALLOCATOR" class="headerlink" title="6ï¼‰ALLOCATOR"></a>6ï¼‰ALLOCATOR</h4><ul><li>å±äº SocketChannal å‚æ•°</li><li>ç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()</li></ul><h4 id="7ï¼‰RCVBUF-ALLOCATOR"><a href="#7ï¼‰RCVBUF-ALLOCATOR" class="headerlink" title="7ï¼‰RCVBUF_ALLOCATOR"></a>7ï¼‰RCVBUF_ALLOCATOR</h4><ul><li>å±äº SocketChannal å‚æ•°</li><li>æ§åˆ¶ netty æ¥æ”¶ç¼“å†²åŒºå¤§å°</li><li>è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š</li></ul><h3 id="1-3-RPC-æ¡†æ¶"><a href="#1-3-RPC-æ¡†æ¶" class="headerlink" title="1.3 RPC æ¡†æ¶"></a>1.3 RPC æ¡†æ¶</h3><h4 id="1ï¼‰å‡†å¤‡å·¥ä½œ"><a href="#1ï¼‰å‡†å¤‡å·¥ä½œ" class="headerlink" title="1ï¼‰å‡†å¤‡å·¥ä½œ"></a>1ï¼‰å‡†å¤‡å·¥ä½œ</h4><p>è¿™äº›ä»£ç å¯ä»¥è®¤ä¸ºæ˜¯ç°æˆçš„ï¼Œæ— éœ€ä»å¤´ç¼–å†™ç»ƒä¹ </p><p>ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œåœ¨åŸæ¥èŠå¤©é¡¹ç›®çš„åŸºç¡€ä¸Šæ–°å¢ Rpc è¯·æ±‚å’Œå“åº”æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥æ—§çš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RPC_MESSAGE_TYPE_REQUEST</span> <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span>  <span class="variable">RPC_MESSAGE_TYPE_RESPONSE</span> <span class="operator">=</span> <span class="number">102</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        messageClasses.put(RPC_MESSAGE_TYPE_REQUEST, RpcRequestMessage.class);</span><br><span class="line">        messageClasses.put(RPC_MESSAGE_TYPE_RESPONSE, RpcResponseMessage.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequestMessage</span> <span class="keyword">extends</span> <span class="title class_">Message</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è°ƒç”¨çš„æ¥å£å…¨é™å®šåï¼ŒæœåŠ¡ç«¯æ ¹æ®å®ƒæ‰¾åˆ°å®ç°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•è¿”å›ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; returnType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class[] parameterTypes;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°å€¼æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[] parameterValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcRequestMessage</span><span class="params">(<span class="type">int</span> sequenceId, String interfaceName, String methodName, Class&lt;?&gt; returnType, Class[] parameterTypes, Object[] parameterValue)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.setSequenceId(sequenceId);</span><br><span class="line">        <span class="built_in">this</span>.interfaceName = interfaceName;</span><br><span class="line">        <span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.returnType = returnType;</span><br><span class="line">        <span class="built_in">this</span>.parameterTypes = parameterTypes;</span><br><span class="line">        <span class="built_in">this</span>.parameterValue = parameterValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMessageType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RPC_MESSAGE_TYPE_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“åº”æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponseMessage</span> <span class="keyword">extends</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object returnValue;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼‚å¸¸å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Exception exceptionValue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMessageType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RPC_MESSAGE_TYPE_RESPONSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨æ¶å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// rpc è¯·æ±‚æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°</span></span><br><span class="line">        <span class="type">RpcRequestMessageHandler</span> <span class="variable">RPC_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcRequestMessageHandler</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">            serverBootstrap.group(boss, worker);</span><br><span class="line">            serverBootstrap.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line">                    ch.pipeline().addLast(LOGGING_HANDLER);</span><br><span class="line">                    ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                    ch.pipeline().addLast(RPC_HANDLER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8080</span>).sync().channel();</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;server error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯æ¶å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// rpc å“åº”æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°</span></span><br><span class="line">        <span class="type">RpcResponseMessageHandler</span> <span class="variable">RPC_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponseMessageHandler</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(group);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line">                    ch.pipeline().addLast(LOGGING_HANDLER);</span><br><span class="line">                    ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                    ch.pipeline().addLast(RPC_HANDLER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>).sync().channel();</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨ç«¯çš„ service è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServicesFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Properties properties;</span><br><span class="line">    <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Object&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Config.class.getResourceAsStream(<span class="string">&quot;/application.properties&quot;</span>)) &#123;</span><br><span class="line">            properties = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(in);</span><br><span class="line">            Set&lt;String&gt; names = properties.stringPropertyNames();</span><br><span class="line">            <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">                <span class="keyword">if</span> (name.endsWith(<span class="string">&quot;Service&quot;</span>)) &#123;</span><br><span class="line">                    Class&lt;?&gt; interfaceClass = Class.forName(name);</span><br><span class="line">                    Class&lt;?&gt; instanceClass = Class.forName(properties.getProperty(name));</span><br><span class="line">                    map.put(interfaceClass, instanceClass.newInstance());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExceptionInInitializerError</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getService</span><span class="params">(Class&lt;T&gt; interfaceClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) map.get(interfaceClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³é…ç½® application.properties</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serializer.algorithm=Json</span><br><span class="line">cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl</span><br></pre></td></tr></table></figure><h4 id="2ï¼‰æœåŠ¡å™¨-handler"><a href="#2ï¼‰æœåŠ¡å™¨-handler" class="headerlink" title="2ï¼‰æœåŠ¡å™¨ handler"></a>2ï¼‰æœåŠ¡å™¨ handler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequestMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcRequestMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcRequestMessage message)</span> &#123;</span><br><span class="line">        <span class="type">RpcResponseMessage</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponseMessage</span>();</span><br><span class="line">        response.setSequenceId(message.getSequenceId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–çœŸæ­£çš„å®ç°å¯¹è±¡</span></span><br><span class="line">            <span class="type">HelloService</span> <span class="variable">service</span> <span class="operator">=</span> (HelloService)</span><br><span class="line">                    ServicesFactory.getService(Class.forName(message.getInterfaceName()));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–è¦è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> service.getClass().getMethod(message.getMethodName(), message.getParameterTypes());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">invoke</span> <span class="operator">=</span> method.invoke(service, message.getParameterValue());</span><br><span class="line">            <span class="comment">// è°ƒç”¨æˆåŠŸ</span></span><br><span class="line">            response.setReturnValue(invoke);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// è°ƒç”¨å¼‚å¸¸</span></span><br><span class="line">            response.setExceptionValue(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">        ctx.writeAndFlush(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ"><a href="#3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ" class="headerlink" title="3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ"></a>3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ</h4><p>åªå‘æ¶ˆæ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        <span class="type">RpcResponseMessageHandler</span> <span class="variable">RPC_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponseMessageHandler</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">            bootstrap.group(group);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line">                    ch.pipeline().addLast(LOGGING_HANDLER);</span><br><span class="line">                    ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                    ch.pipeline().addLast(RPC_HANDLER);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>).sync().channel();</span><br><span class="line"></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">RpcRequestMessage</span>(</span><br><span class="line">                    <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;cn.itcast.server.service.HelloService&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;sayHello&quot;</span>,</span><br><span class="line">                    String.class,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;å¼ ä¸‰&quot;</span>&#125;</span><br><span class="line">            )).addListener(promise -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!promise.isSuccess()) &#123;</span><br><span class="line">                    <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> promise.cause();</span><br><span class="line">                    log.error(<span class="string">&quot;error&quot;</span>, cause);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ"><a href="#4ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ" class="headerlink" title="4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ"></a>4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponseMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcResponseMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcResponseMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5ï¼‰å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆ"><a href="#5ï¼‰å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆ" class="headerlink" title="5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆ"></a>5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆ</h4><p>åŒ…æ‹¬ channel ç®¡ç†ï¼Œä»£ç†ï¼Œæ¥æ”¶ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClientManager</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">service</span> <span class="operator">=</span> getProxyService(HelloService.class);</span><br><span class="line">        System.out.println(service.sayHello(<span class="string">&quot;zhangsan&quot;</span>));</span><br><span class="line"><span class="comment">//        System.out.println(service.sayHello(&quot;lisi&quot;));</span></span><br><span class="line"><span class="comment">//        System.out.println(service.sayHello(&quot;wangwu&quot;));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä»£ç†ç±»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxyService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> serviceClass.getClassLoader();</span><br><span class="line">        Class&lt;?&gt;[] interfaces = <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceClass&#125;;</span><br><span class="line">        <span class="comment">//                                                            sayHello  &quot;å¼ ä¸‰&quot;</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> Proxy.newProxyInstance(loader, interfaces, (proxy, method, args) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 1. å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º æ¶ˆæ¯å¯¹è±¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">sequenceId</span> <span class="operator">=</span> SequenceIdGenerator.nextId();</span><br><span class="line">            <span class="type">RpcRequestMessage</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcRequestMessage</span>(</span><br><span class="line">                    sequenceId,</span><br><span class="line">                    serviceClass.getName(),</span><br><span class="line">                    method.getName(),</span><br><span class="line">                    method.getReturnType(),</span><br><span class="line">                    method.getParameterTypes(),</span><br><span class="line">                    args</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 2. å°†æ¶ˆæ¯å¯¹è±¡å‘é€å‡ºå»</span></span><br><span class="line">            getChannel().writeAndFlush(msg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. å‡†å¤‡ä¸€ä¸ªç©º Promise å¯¹è±¡ï¼Œæ¥æ¥æ”¶ç»“æœ             æŒ‡å®š promise å¯¹è±¡å¼‚æ­¥æ¥æ”¶ç»“æœçº¿ç¨‹</span></span><br><span class="line">            DefaultPromise&lt;Object&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(getChannel().eventLoop());</span><br><span class="line">            RpcResponseMessageHandler.PROMISES.put(sequenceId, promise);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            promise.addListener(future -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                // çº¿ç¨‹</span></span><br><span class="line"><span class="comment">//            &#125;);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. ç­‰å¾… promise ç»“æœ</span></span><br><span class="line">            promise.await();</span><br><span class="line">            <span class="keyword">if</span>(promise.isSuccess()) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨æ­£å¸¸</span></span><br><span class="line">                <span class="keyword">return</span> promise.getNow();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨å¤±è´¥</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(promise.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å”¯ä¸€çš„ channel å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title function_">getChannel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> channel;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123; <span class="comment">//  t2</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span>) &#123; <span class="comment">// t1</span></span><br><span class="line">                <span class="keyword">return</span> channel;</span><br><span class="line">            &#125;</span><br><span class="line">            initChannel();</span><br><span class="line">            <span class="keyword">return</span> channel;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– channel æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">LoggingHandler</span> <span class="variable">LOGGING_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG);</span><br><span class="line">        <span class="type">MessageCodecSharable</span> <span class="variable">MESSAGE_CODEC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCodecSharable</span>();</span><br><span class="line">        <span class="type">RpcResponseMessageHandler</span> <span class="variable">RPC_HANDLER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponseMessageHandler</span>();</span><br><span class="line">        <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">        bootstrap.group(group);</span><br><span class="line">        bootstrap.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ProcotolFrameDecoder</span>());</span><br><span class="line">                ch.pipeline().addLast(LOGGING_HANDLER);</span><br><span class="line">                ch.pipeline().addLast(MESSAGE_CODEC);</span><br><span class="line">                ch.pipeline().addLast(RPC_HANDLER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = bootstrap.connect(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>).sync().channel();</span><br><span class="line">            channel.closeFuture().addListener(future -&gt; &#123;</span><br><span class="line">                group.shutdownGracefully();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;client error&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ"><a href="#6ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ" class="headerlink" title="6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ"></a>6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponseMessageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcResponseMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//                       åºå·      ç”¨æ¥æ¥æ”¶ç»“æœçš„ promise å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, Promise&lt;Object&gt;&gt; PROMISES = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcResponseMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, msg);</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°ç©ºçš„ promise</span></span><br><span class="line">        Promise&lt;Object&gt; promise = PROMISES.remove(msg.getSequenceId());</span><br><span class="line">        <span class="keyword">if</span> (promise != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> msg.getReturnValue();</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">exceptionValue</span> <span class="operator">=</span> msg.getExceptionValue();</span><br><span class="line">            <span class="keyword">if</span>(exceptionValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                promise.setFailure(exceptionValue);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                promise.setSuccess(returnValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-æºç åˆ†æ"><a href="#2-æºç åˆ†æ" class="headerlink" title="2. æºç åˆ†æ"></a>2. æºç åˆ†æ</h2><h3 id="2-1-å¯åŠ¨å‰–æ"><a href="#2-1-å¯åŠ¨å‰–æ" class="headerlink" title="2.1 å¯åŠ¨å‰–æ"></a>2.1 å¯åŠ¨å‰–æ</h3><p>æˆ‘ä»¬å°±æ¥çœ‹çœ‹ netty ä¸­å¯¹ä¸‹é¢çš„ä»£ç æ˜¯æ€æ ·è¿›è¡Œå¤„ç†çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1 netty ä¸­ä½¿ç”¨ NioEventLoopGroup ï¼ˆç®€ç§° nio boss çº¿ç¨‹ï¼‰æ¥å°è£…çº¿ç¨‹å’Œ selector</span></span><br><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//2 åˆ›å»º NioServerSocketChannelï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒå…³è”çš„ handlerï¼Œä»¥åŠä¸ºåŸç”Ÿ ssc å­˜å‚¨ config</span></span><br><span class="line"><span class="type">NioServerSocketChannel</span> <span class="variable">attachment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioServerSocketChannel</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3 åˆ›å»º NioServerSocketChannel æ—¶ï¼Œåˆ›å»ºäº† java åŸç”Ÿçš„ ServerSocketChannel</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open(); </span><br><span class="line">serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//4 å¯åŠ¨ nio boss çº¿ç¨‹æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//5 æ³¨å†Œï¼ˆä»…å…³è” selector å’Œ NioServerSocketChannelï¼‰ï¼Œæœªå…³æ³¨äº‹ä»¶</span></span><br><span class="line"><span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> serverSocketChannel.register(selector, <span class="number">0</span>, attachment);</span><br><span class="line"></span><br><span class="line"><span class="comment">//6 head -&gt; åˆå§‹åŒ–å™¨ -&gt; ServerBootstrapAcceptor -&gt; tailï¼Œåˆå§‹åŒ–å™¨æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåªä¸ºæ·»åŠ  acceptor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//7 ç»‘å®šç«¯å£</span></span><br><span class="line">serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//8 è§¦å‘ channel active äº‹ä»¶ï¼Œåœ¨ head ä¸­å…³æ³¨ op_accept äº‹ä»¶</span></span><br><span class="line">selectionKey.interestOps(SelectionKey.OP_ACCEPT);</span><br></pre></td></tr></table></figure><p>å…¥å£ <code>io.netty.bootstrap.ServerBootstrap#bind</code></p><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> &#123;</span><br><span class="line"><span class="comment">// 1. æ‰§è¡Œåˆå§‹åŒ–å’Œæ³¨å†Œ regFuture ä¼šç”± initAndRegister è®¾ç½®å…¶æ˜¯å¦å®Œæˆï¼Œä»è€Œå›è°ƒ 3.2 å¤„ä»£ç </span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> initAndRegister();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> regFuture.channel();</span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> regFuture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å› ä¸ºæ˜¯ initAndRegister å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µæ¥çœ‹ï¼Œè°ƒè¯•æ—¶ä¹Ÿéœ€è¦é€šè¿‡ suspend æ–­ç‚¹ç±»å‹åŠ ä»¥åŒºåˆ†</span></span><br><span class="line">    <span class="comment">// 2.1 å¦‚æœå·²ç»å®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</span><br><span class="line">        <span class="type">ChannelPromise</span> <span class="variable">promise</span> <span class="operator">=</span> channel.newPromise();</span><br><span class="line">        <span class="comment">// 3.1 ç«‹åˆ»è°ƒç”¨ doBind0</span></span><br><span class="line">        doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 2.2 è¿˜æ²¡æœ‰å®Œæˆ</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">PendingRegistrationPromise</span> <span class="variable">promise</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PendingRegistrationPromise</span>(channel);</span><br><span class="line">        <span class="comment">// 3.2 å›è°ƒ doBind0</span></span><br><span class="line">        regFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> future.cause();</span><br><span class="line">                <span class="keyword">if</span> (cause != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å¤„ç†å¼‚å¸¸...</span></span><br><span class="line">                    promise.setFailure(cause);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    promise.registered();</span><br><span class="line"><span class="comment">// 3. ç”±æ³¨å†Œçº¿ç¨‹å»æ‰§è¡Œ doBind0</span></span><br><span class="line">                    doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel = channelFactory.newChannel();</span><br><span class="line">        <span class="comment">// 1.1 åˆå§‹åŒ– - åšçš„äº‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ–å™¨ ChannelInitializer</span></span><br><span class="line">        init(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†å¼‚å¸¸...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelPromise</span>(<span class="keyword">new</span> <span class="title class_">FailedChannel</span>(), GlobalEventExecutor.INSTANCE).setFailure(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.2 æ³¨å†Œ - åšçš„äº‹å°±æ˜¯å°†åŸç”Ÿ channel æ³¨å†Œåˆ° selector ä¸Š</span></span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> config().group().register(channel);</span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†å¼‚å¸¸...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap#init</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œ channel å®é™…ä¸Šæ˜¯ NioServerSocketChannel</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> Map&lt;ChannelOption&lt;?&gt;, Object&gt; options = options0();</span><br><span class="line">    <span class="keyword">synchronized</span> (options) &#123;</span><br><span class="line">        setChannelOptions(channel, options, logger);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Map&lt;AttributeKey&lt;?&gt;, Object&gt; attrs = attrs0();</span><br><span class="line">    <span class="keyword">synchronized</span> (attrs) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: attrs.entrySet()) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            AttributeKey&lt;Object&gt; key = (AttributeKey&lt;Object&gt;) e.getKey();</span><br><span class="line">            channel.attr(key).set(e.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> channel.pipeline();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">EventLoopGroup</span> <span class="variable">currentChildGroup</span> <span class="operator">=</span> childGroup;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelHandler</span> <span class="variable">currentChildHandler</span> <span class="operator">=</span> childHandler;</span><br><span class="line">    <span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</span><br><span class="line">    <span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;</span><br><span class="line">    <span class="keyword">synchronized</span> (childOptions) &#123;</span><br><span class="line">        currentChildOptions = childOptions.entrySet().toArray(newOptionArray(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (childAttrs) &#123;</span><br><span class="line">        currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º NioServerSocketChannel æ·»åŠ åˆå§‹åŒ–å™¨</span></span><br><span class="line">    p.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">            <span class="type">ChannelHandler</span> <span class="variable">handler</span> <span class="operator">=</span> config.handler();</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                pipeline.addLast(handler);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–å™¨çš„èŒè´£æ˜¯å°† ServerBootstrapAcceptor åŠ å…¥è‡³ NioServerSocketChannel</span></span><br><span class="line">            ch.eventLoop().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ServerBootstrapAcceptor</span>(</span><br><span class="line">                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...</span></span><br><span class="line"></span><br><span class="line">    AbstractChannel.<span class="built_in">this</span>.eventLoop = eventLoop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</span><br><span class="line">        register0(promise);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é¦–æ¬¡æ‰§è¡Œ execute æ–¹æ³•æ—¶ï¼Œä¼šå¯åŠ¨ nio çº¿ç¨‹ï¼Œä¹‹åæ³¨å†Œç­‰æ“ä½œåœ¨ nio çº¿ç¨‹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">            <span class="comment">// å› ä¸ºåªæœ‰ä¸€ä¸ª NioServerSocketChannel å› æ­¤ï¼Œä¹Ÿåªä¼šæœ‰ä¸€ä¸ª boss nio çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ main -&gt; nio boss çº¿ç¨‹çš„åˆ‡æ¢</span></span><br><span class="line">            eventLoop.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    register0(promise);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—è®°å½•...</span></span><br><span class="line">            closeForcibly();</span><br><span class="line">            closeFuture.setClosed();</span><br><span class="line">            safeSetFailure(promise, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register0</span><span class="params">(ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">firstRegistration</span> <span class="operator">=</span> neverRegistered;</span><br><span class="line">        <span class="comment">// 1.2.1 åŸç”Ÿçš„ nio channel ç»‘å®šåˆ° selector ä¸Šï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰æ³¨å†Œ selector å…³æ³¨äº‹ä»¶ï¼Œé™„ä»¶ä¸º NioServerSocketChannel</span></span><br><span class="line">        doRegister();</span><br><span class="line">        neverRegistered = <span class="literal">false</span>;</span><br><span class="line">        registered = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.2.2 æ‰§è¡Œ NioServerSocketChannel åˆå§‹åŒ–å™¨çš„ initChannel</span></span><br><span class="line">        pipeline.invokeHandlerAddedIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å›è°ƒ 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0</span></span><br><span class="line">        safeSetSuccess(promise);</span><br><span class="line">        pipeline.fireChannelRegistered();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹åº” server socket channel è¿˜æœªç»‘å®šï¼ŒisActive ä¸º false</span></span><br><span class="line">        <span class="keyword">if</span> (isActive()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</span><br><span class="line">                pipeline.fireChannelActive();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</span><br><span class="line">                beginRead();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// Close the channel directly to avoid FD leak.</span></span><br><span class="line">        closeForcibly();</span><br><span class="line">        closeFuture.setClosed();</span><br><span class="line">        safeSetFailure(promise, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.channel.ChannelInitializer#initChannel</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">initChannel</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (initMap.add(ctx)) &#123; <span class="comment">// Guard against re-entrance.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.2.2.1 æ‰§è¡Œåˆå§‹åŒ–</span></span><br><span class="line">            initChannel((C) ctx.channel());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</span><br><span class="line">            exceptionCaught(ctx, cause);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 1.2.2.2 ç§»é™¤åˆå§‹åŒ–å™¨</span></span><br><span class="line">            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ctx.pipeline();</span><br><span class="line">            <span class="keyword">if</span> (pipeline.context(<span class="built_in">this</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                pipeline.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 æˆ– 3.2 æ‰§è¡Œ doBind0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doBind0</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line"></span><br><span class="line">    channel.eventLoop().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</span><br><span class="line">                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                promise.setFailure(regFuture.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    assertEventLoop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(config().getOption(ChannelOption.SO_BROADCAST)) &amp;&amp;</span><br><span class="line">        localAddress <span class="keyword">instanceof</span> InetSocketAddress &amp;&amp;</span><br><span class="line">        !((InetSocketAddress) localAddress).getAddress().isAnyLocalAddress() &amp;&amp;</span><br><span class="line">        !PlatformDependent.isWindows() &amp;&amp; !PlatformDependent.maybeSuperUser()) &#123;</span><br><span class="line">        <span class="comment">// è®°å½•æ—¥å¿—...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">wasActive</span> <span class="operator">=</span> isActive();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 3.3 æ‰§è¡Œç«¯å£ç»‘å®š</span></span><br><span class="line">        doBind(localAddress);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        safeSetFailure(promise, t);</span><br><span class="line">        closeIfClosed();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wasActive &amp;&amp; isActive()) &#123;</span><br><span class="line">        invokeLater(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// 3.4 è§¦å‘ active äº‹ä»¶</span></span><br><span class="line">                pipeline.fireChannelActive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    safeSetSuccess(promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.3 å…³é”®ä»£ç  <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">        javaChannel().bind(localAddress, config.getBacklog());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        javaChannel().socket().bind(localAddress, config.getBacklog());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.4 å…³é”®ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">    ctx.fireChannelActive();</span><br><span class="line"><span class="comment">// è§¦å‘ read (NioServerSocketChannel ä¸Šçš„ read ä¸æ˜¯è¯»å–æ•°æ®ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œ)</span></span><br><span class="line">    readIfIsAutoRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// Channel.read() or ChannelHandlerContext.read() was called</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> <span class="built_in">this</span>.selectionKey;</span><br><span class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    readPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interestOps</span> <span class="operator">=</span> selectionKey.interestOps();</span><br><span class="line">    <span class="comment">// readInterestOp å–å€¼æ˜¯ 16ï¼Œåœ¨ NioServerSocketChannel åˆ›å»ºæ—¶åˆå§‹åŒ–å¥½ï¼Œä»£è¡¨å…³æ³¨ accept äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;</span><br><span class="line">        selectionKey.interestOps(interestOps | readInterestOp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-NioEventLoop-å‰–æ"><a href="#2-2-NioEventLoop-å‰–æ" class="headerlink" title="2.2 NioEventLoop å‰–æ"></a>2.2 NioEventLoop å‰–æ</h3><p>NioEventLoop çº¿ç¨‹ä¸ä»…è¦å¤„ç† IO äº‹ä»¶ï¼Œè¿˜è¦å¤„ç† Taskï¼ˆåŒ…æ‹¬æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼‰ï¼Œ</p><p>æäº¤ä»»åŠ¡ä»£ç  <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;task&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">inEventLoop</span> <span class="operator">=</span> inEventLoop();</span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡ï¼Œå…¶ä¸­é˜Ÿåˆ—ä½¿ç”¨äº† jctools æä¾›çš„ mpsc æ— é”é˜Ÿåˆ—</span></span><br><span class="line">    addTask(task);</span><br><span class="line">    <span class="keyword">if</span> (!inEventLoop) &#123;</span><br><span class="line">        <span class="comment">// inEventLoop å¦‚æœä¸º false è¡¨ç¤ºç”±å…¶å®ƒçº¿ç¨‹æ¥è°ƒç”¨ executeï¼Œå³é¦–æ¬¡è°ƒç”¨ï¼Œè¿™æ—¶éœ€è¦å‘ eventLoop æäº¤é¦–ä¸ªä»»åŠ¡ï¼Œå¯åŠ¨æ­»å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ°ä¸‹é¢çš„ doStartThread</span></span><br><span class="line">        startThread();</span><br><span class="line">        <span class="keyword">if</span> (isShutdown()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå·²ç» shutdownï¼Œåšæ‹’ç»é€»è¾‘ï¼Œä»£ç ç•¥...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹ç”±äº IO select é˜»å¡äº†ï¼Œæ·»åŠ çš„ä»»åŠ¡çš„çº¿ç¨‹éœ€è¦è´Ÿè´£å”¤é†’ NioEventLoop çº¿ç¨‹</span></span><br><span class="line">        wakeup(inEventLoop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å”¤é†’ select é˜»å¡çº¿ç¨‹<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">wakeup</span><span class="params">(<span class="type">boolean</span> inEventLoop)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!inEventLoop &amp;&amp; wakenUp.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ EventLoop ä¸»å¾ªç¯ <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doStartThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> thread == <span class="literal">null</span>;</span><br><span class="line">    executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// å°†çº¿ç¨‹æ± çš„å½“å‰çº¿ç¨‹ä¿å­˜åœ¨æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨</span></span><br><span class="line">            thread = Thread.currentThread();</span><br><span class="line">            <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                thread.interrupt();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            updateLastExecutionTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨å¤–éƒ¨ç±» SingleThreadEventExecutor çš„ run æ–¹æ³•ï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œrun æ–¹æ³•è§ä¸‹</span></span><br><span class="line">                SingleThreadEventExecutor.<span class="built_in">this</span>.run();</span><br><span class="line">                success = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Unexpected exception from an event executor: &quot;</span>, t);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// æ¸…ç†å·¥ä½œï¼Œä»£ç ç•¥...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.nio.NioEventLoop#run</code> ä¸»è¦ä»»åŠ¡æ˜¯æ‰§è¡Œæ­»å¾ªç¯ï¼Œä¸æ–­çœ‹æœ‰æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæœ‰æ²¡æœ‰ IO äº‹ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// calculateStrategy çš„é€»è¾‘å¦‚ä¸‹ï¼š</span></span><br><span class="line">                <span class="comment">// æœ‰ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡ selectNowï¼Œæ¸…é™¤ä¸Šä¸€æ¬¡çš„ wakeup ç»“æœï¼Œæ— è®ºæœ‰æ²¡æœ‰ IO äº‹ä»¶ï¼Œéƒ½ä¼šè·³è¿‡ switch</span></span><br><span class="line">                <span class="comment">// æ²¡æœ‰ä»»åŠ¡ï¼Œä¼šåŒ¹é… SelectStrategy.SELECTï¼Œçœ‹æ˜¯å¦åº”å½“é˜»å¡</span></span><br><span class="line">                <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</span><br><span class="line">                    <span class="keyword">case</span> SelectStrategy.CONTINUE:</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> SelectStrategy.BUSY_WAIT:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> SelectStrategy.SELECT:</span><br><span class="line">                        <span class="comment">// å› ä¸º IO çº¿ç¨‹å’Œæäº¤ä»»åŠ¡çº¿ç¨‹éƒ½æœ‰å¯èƒ½æ‰§è¡Œ wakeupï¼Œè€Œ wakeup å±äºæ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ä¸ªåŸå­å¸ƒå°”å¯¹è±¡ wakenUpï¼Œå®ƒå–å€¼ä¸º true æ—¶ï¼Œè¡¨ç¤ºè¯¥ç”±å½“å‰çº¿ç¨‹å”¤é†’</span></span><br><span class="line">                        <span class="comment">// è¿›è¡Œ select é˜»å¡ï¼Œå¹¶è®¾ç½®å”¤é†’çŠ¶æ€ä¸º false</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">oldWakenUp</span> <span class="operator">=</span> wakenUp.getAndSet(<span class="literal">false</span>);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// å¦‚æœåœ¨è¿™ä¸ªä½ç½®ï¼Œé EventLoop çº¿ç¨‹æŠ¢å…ˆå°† wakenUp ç½®ä¸º trueï¼Œå¹¶ wakeup</span></span><br><span class="line">                        <span class="comment">// ä¸‹é¢çš„ select æ–¹æ³•ä¸ä¼šé˜»å¡</span></span><br><span class="line">                        <span class="comment">// ç­‰ runAllTasks å¤„ç†å®Œæˆåï¼Œåˆ°å†å¾ªç¯è¿›æ¥è¿™ä¸ªé˜¶æ®µæ–°å¢çš„ä»»åŠ¡ä¼šä¸ä¼šåŠæ—¶æ‰§è¡Œå‘¢?</span></span><br><span class="line">                        <span class="comment">// å› ä¸º oldWakenUp ä¸º trueï¼Œå› æ­¤ä¸‹é¢çš„ select æ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°è¶…æ—¶</span></span><br><span class="line">                        <span class="comment">// æ‰èƒ½æ‰§è¡Œï¼Œè®© select æ–¹æ³•æ— è°“é˜»å¡</span></span><br><span class="line">                        select(oldWakenUp);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (wakenUp.get()) &#123;</span><br><span class="line">                            selector.wakeup();</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                rebuildSelector0();</span><br><span class="line">                handleLoopException(e);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cancelledKeys = <span class="number">0</span>;</span><br><span class="line">            needsToSelectAgain = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// ioRatio é»˜è®¤æ˜¯ 50</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ioRatio</span> <span class="operator">=</span> <span class="built_in">this</span>.ioRatio;</span><br><span class="line">            <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// ioRatio ä¸º 100 æ—¶ï¼Œæ€»æ˜¯è¿è¡Œå®Œæ‰€æœ‰é IO ä»»åŠ¡</span></span><br><span class="line">                    runAllTasks();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                </span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ioStartTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è®°å½• io äº‹ä»¶å¤„ç†è€—æ—¶</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ioTime</span> <span class="operator">=</span> System.nanoTime() - ioStartTime;</span><br><span class="line">                    <span class="comment">// è¿è¡Œé IO ä»»åŠ¡ï¼Œä¸€æ—¦è¶…æ—¶ä¼šé€€å‡º runAllTasks</span></span><br><span class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleLoopException(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isShuttingDown()) &#123;</span><br><span class="line">                closeAll();</span><br><span class="line">                <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleLoopException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-æ³¨æ„"><a href="#âš ï¸-æ³¨æ„" class="headerlink" title="âš ï¸ æ³¨æ„"></a>âš ï¸ æ³¨æ„</h4><blockquote><p>è¿™é‡Œæœ‰ä¸ªè´¹è§£çš„åœ°æ–¹å°±æ˜¯ wakeupï¼Œå®ƒæ—¢å¯ä»¥ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒå¥½ç†è§£ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”± EventLoop çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒè´¹è§£ï¼‰ï¼Œè¿™é‡Œè¦çŸ¥é“ wakeup æ–¹æ³•çš„æ•ˆæœï¼š</p><ul><li>ç”±é EventLoop çº¿ç¨‹è°ƒç”¨ï¼Œä¼šå”¤é†’å½“å‰åœ¨æ‰§è¡Œ select é˜»å¡çš„ EventLoop çº¿ç¨‹</li><li>ç”± EventLoop è‡ªå·±è°ƒç”¨ï¼Œä¼šæœ¬æ¬¡çš„ wakeup ä¼šå–æ¶ˆä¸‹ä¸€æ¬¡çš„ select æ“ä½œ</li></ul></blockquote><p>å‚è€ƒä¸‹å›¾</p><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Netty/0032.png"  /></p><p><code>io.netty.channel.nio.NioEventLoop#select</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(<span class="type">boolean</span> oldWakenUp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> <span class="built_in">this</span>.selector;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">selectCnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeNanos</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="comment">// è®¡ç®—ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        <span class="comment">// * æ²¡æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º 1s</span></span><br><span class="line">        <span class="comment">// * æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º `ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´`</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">selectDeadLineNanos</span> <span class="operator">=</span> currentTimeNanos + delayNanos(currentTimeNanos);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">timeoutMillis</span> <span class="operator">=</span> (selectDeadLineNanos - currentTimeNanos + <span class="number">500000L</span>) / <span class="number">1000000L</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœè¶…æ—¶ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (timeoutMillis &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (selectCnt == <span class="number">0</span>) &#123;</span><br><span class="line">                    selector.selectNow();</span><br><span class="line">                    selectCnt = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœæœŸé—´åˆæœ‰ task é€€å‡ºå¾ªç¯ï¼Œå¦‚æœæ²¡è¿™ä¸ªåˆ¤æ–­ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šç­‰åˆ°ä¸‹æ¬¡ select è¶…æ—¶æ—¶æ‰èƒ½è¢«æ‰§è¡Œ</span></span><br><span class="line">            <span class="comment">// wakenUp.compareAndSet(false, true) æ˜¯è®©é NioEventLoop ä¸å¿…å†æ‰§è¡Œ wakeup</span></span><br><span class="line">            <span class="keyword">if</span> (hasTasks() &amp;&amp; wakenUp.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                selector.selectNow();</span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// select æœ‰é™æ—¶é˜»å¡</span></span><br><span class="line">            <span class="comment">// æ³¨æ„ nio æœ‰ bugï¼Œå½“ bug å‡ºç°æ—¶ï¼Œselect æ–¹æ³•å³ä½¿æ²¡æœ‰æ—¶é—´å‘ç”Ÿï¼Œä¹Ÿä¸ä¼šé˜»å¡ä½ï¼Œå¯¼è‡´ä¸æ–­ç©ºè½®è¯¢ï¼Œcpu å ç”¨ 100%</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">selectedKeys</span> <span class="operator">=</span> selector.select(timeoutMillis);</span><br><span class="line">            <span class="comment">// è®¡æ•°åŠ  1</span></span><br><span class="line">            selectCnt ++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é†’æ¥åï¼Œå¦‚æœæœ‰ IO äº‹ä»¶ã€æˆ–æ˜¯ç”±é EventLoop çº¿ç¨‹å”¤é†’ï¼Œæˆ–è€…æœ‰ä»»åŠ¡ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (selectedKeys != <span class="number">0</span> || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">               <span class="comment">// çº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="comment">// è®°å½•æ—¥å¿—</span></span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¶…æ—¶ï¼Œè®¡æ•°é‡ç½®ä¸º 1ï¼Œä¸‹æ¬¡å¾ªç¯å°±ä¼š break</span></span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// è®¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œç”± io.netty.selectorAutoRebuildThreshold æŒ‡å®šï¼Œé»˜è®¤ 512</span></span><br><span class="line">            <span class="comment">// è¿™æ˜¯ä¸ºäº†è§£å†³ nio ç©ºè½®è¯¢ bug</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) &#123;</span><br><span class="line">                <span class="comment">// é‡å»º selector</span></span><br><span class="line">                selector = selectRebuildSelector(selectCnt);</span><br><span class="line">                selectCnt = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentTimeNanos = time;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;</span><br><span class="line">            <span class="comment">// è®°å½•æ—¥å¿—</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">        <span class="comment">// è®°å½•æ—¥å¿—</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç† keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processSelectedKeys</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (selectedKeys != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„å°† Selector å®ç°ç±»ä¸­çš„å°±ç»ªäº‹ä»¶é›†åˆæ›¿æ¢ä¸º SelectedSelectionKeySet </span></span><br><span class="line">        <span class="comment">// SelectedSelectionKeySet åº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œå¯ä»¥æé«˜éå†æ€§èƒ½ï¼ˆåŸæœ¬ä¸º HashSetï¼‰</span></span><br><span class="line">        processSelectedKeysOptimized();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        processSelectedKeysPlain(selector.selectedKeys());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processSelectedKey</span><span class="params">(SelectionKey k, AbstractNioChannel ch)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> AbstractNioChannel.<span class="type">NioUnsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> ch.unsafe();</span><br><span class="line">    <span class="comment">// å½“ key å–æ¶ˆæˆ–å…³é—­æ—¶ä¼šå¯¼è‡´è¿™ä¸ª key æ— æ•ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (!k.isValid()) &#123;</span><br><span class="line">        <span class="comment">// æ— æ•ˆæ—¶å¤„ç†...</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">readyOps</span> <span class="operator">=</span> k.readyOps();</span><br><span class="line">        <span class="comment">// è¿æ¥äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ops</span> <span class="operator">=</span> k.interestOps();</span><br><span class="line">            ops &amp;= ~SelectionKey.OP_CONNECT;</span><br><span class="line">            k.interestOps(ops);</span><br><span class="line"></span><br><span class="line">            unsafe.finishConnect();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯å†™äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">            ch.unsafe().forceFlush();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯è¯»æˆ–å¯æ¥å…¥äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯å¯æ¥å…¥ io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</span></span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯å¯è¯» io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</span></span><br><span class="line">            unsafe.read();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException ignored) &#123;</span><br><span class="line">        unsafe.close(unsafe.voidPromise());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-accept-å‰–æ"><a href="#2-3-accept-å‰–æ" class="headerlink" title="2.3 accept å‰–æ"></a>2.3 accept å‰–æ</h3><p>nio ä¸­å¦‚ä¸‹ä»£ç ï¼Œåœ¨ netty ä¸­çš„æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1 é˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿ</span></span><br><span class="line">selector.select();</span><br><span class="line"></span><br><span class="line">Iterator&lt;SelectionKey&gt; iter = selector.selectedKeys().iterator();</span><br><span class="line"><span class="keyword">while</span> (iter.hasNext()) &#123;    </span><br><span class="line">    <span class="comment">//2 æ‹¿åˆ°ä¸€ä¸ªäº‹ä»¶</span></span><br><span class="line">    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3 å¦‚æœæ˜¯ accept äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//4 æ‰§è¡Œ accept</span></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">        channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//5 å…³æ³¨ read äº‹ä»¶</span></span><br><span class="line">        channel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹å¯æ¥å…¥äº‹ä»¶å¤„ç†ï¼ˆacceptï¼‰</p><p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> <span class="title function_">eventLoop</span><span class="params">()</span>.inEventLoop();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelConfig</span> <span class="variable">config</span> <span class="operator">=</span> config();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> pipeline();    </span><br><span class="line">    <span class="keyword">final</span> RecvByteBufAllocator.<span class="type">Handle</span> <span class="variable">allocHandle</span> <span class="operator">=</span> unsafe().recvBufAllocHandle();</span><br><span class="line">    allocHandle.reset(config);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">closed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="comment">// doReadMessages ä¸­æ‰§è¡Œäº† accept å¹¶åˆ›å»º NioSocketChannel ä½œä¸ºæ¶ˆæ¯æ”¾å…¥ readBuf</span></span><br><span class="line">                <span class="comment">// readBuf æ˜¯ä¸€ä¸ª ArrayList ç”¨æ¥ç¼“å­˜æ¶ˆæ¯</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">localRead</span> <span class="operator">=</span> doReadMessages(readBuf);</span><br><span class="line">                <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    closed = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">// localRead ä¸º 1ï¼Œå°±ä¸€æ¡æ¶ˆæ¯ï¼Œå³æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">                allocHandle.incMessagesRead(localRead);</span><br><span class="line">            &#125; <span class="keyword">while</span> (allocHandle.continueReading());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            exception = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> readBuf.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i ++) &#123;</span><br><span class="line">            readPending = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç†</span></span><br><span class="line">            <span class="comment">// io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</span></span><br><span class="line">            pipeline.fireChannelRead(readBuf.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        readBuf.clear();</span><br><span class="line">        allocHandle.readComplete();</span><br><span class="line">        pipeline.fireChannelReadComplete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (exception != <span class="literal">null</span>) &#123;</span><br><span class="line">            closed = closeOnReadError(exception);</span><br><span class="line"></span><br><span class="line">            pipeline.fireExceptionCaught(exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">            inputShutdown = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (isOpen()) &#123;</span><br><span class="line">                close(voidPromise());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) &#123;</span><br><span class="line">            removeReadOp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™æ—¶çš„ msg æ˜¯ NioSocketChannel</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">child</span> <span class="operator">=</span> (Channel) msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NioSocketChannel æ·»åŠ   childHandler å³åˆå§‹åŒ–å™¨</span></span><br><span class="line">    child.pipeline().addLast(childHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é€‰é¡¹</span></span><br><span class="line">    setChannelOptions(child, childOptions, logger);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) &#123;</span><br><span class="line">        child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œ NioSocketChannel åˆ° nio worker çº¿ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å¤„ç†ä¹Ÿç§»äº¤è‡³ nio worker çº¿ç¨‹</span></span><br><span class="line">        childGroup.register(child).addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">if</span> (!future.isSuccess()) &#123;</span><br><span class="line">                    forceClose(child, future.cause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        forceClose(child, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå›åˆ°äº†ç†Ÿæ‚‰çš„ <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code>  æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...</span></span><br><span class="line"></span><br><span class="line">    AbstractChannel.<span class="built_in">this</span>.eventLoop = eventLoop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</span><br><span class="line">        register0(promise);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ nio boss -&gt; nio worker çº¿ç¨‹çš„åˆ‡æ¢</span></span><br><span class="line">            eventLoop.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    register0(promise);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// æ—¥å¿—è®°å½•...</span></span><br><span class="line">            closeForcibly();</span><br><span class="line">            closeFuture.setClosed();</span><br><span class="line">            safeSetFailure(promise, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register0</span><span class="params">(ChannelPromise promise)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">firstRegistration</span> <span class="operator">=</span> neverRegistered;</span><br><span class="line">        doRegister();</span><br><span class="line">        neverRegistered = <span class="literal">false</span>;</span><br><span class="line">        registered = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–å™¨ï¼Œæ‰§è¡Œå‰ pipeline ä¸­åªæœ‰ head -&gt; åˆå§‹åŒ–å™¨ -&gt; tail</span></span><br><span class="line">        pipeline.invokeHandlerAddedIfNeeded();</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåå°±æ˜¯ head -&gt; logging handler -&gt; my handler -&gt; tail</span></span><br><span class="line"></span><br><span class="line">        safeSetSuccess(promise);</span><br><span class="line">        pipeline.fireChannelRegistered();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isActive()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</span><br><span class="line">                <span class="comment">// è§¦å‘ pipeline ä¸Š active äº‹ä»¶</span></span><br><span class="line">                pipeline.fireChannelActive();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</span><br><span class="line">                beginRead();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        closeForcibly();</span><br><span class="line">        closeFuture.setClosed();</span><br><span class="line">        safeSetFailure(promise, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">    ctx.fireChannelActive();</span><br><span class="line"><span class="comment">// è§¦å‘ read (NioSocketChannel è¿™é‡Œ readï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œï¼Œè¿˜æœªæ¶‰åŠæ•°æ®è¯»å–)</span></span><br><span class="line">    readIfIsAutoRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// Channel.read() or ChannelHandlerContext.read() was called</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> <span class="built_in">this</span>.selectionKey;</span><br><span class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    readPending = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// è¿™æ—¶å€™ interestOps æ˜¯ 0</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interestOps</span> <span class="operator">=</span> selectionKey.interestOps();</span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å…³æ³¨ read äº‹ä»¶</span></span><br><span class="line">        selectionKey.interestOps(interestOps | readInterestOp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-read-å‰–æ"><a href="#2-4-read-å‰–æ" class="headerlink" title="2.4 read å‰–æ"></a>2.4 read å‰–æ</h3><p>å†æ¥çœ‹å¯è¯»äº‹ä»¶ <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>ï¼Œæ³¨æ„å‘é€çš„æ•°æ®æœªå¿…èƒ½å¤Ÿä¸€æ¬¡è¯»å®Œï¼Œå› æ­¤ä¼šè§¦å‘å¤šæ¬¡ nio read äº‹ä»¶ï¼Œä¸€æ¬¡äº‹ä»¶å†…ä¼šè§¦å‘å¤šæ¬¡ pipeline readï¼Œä¸€æ¬¡äº‹ä»¶ä¼šè§¦å‘ä¸€æ¬¡ pipeline read complete</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelConfig</span> <span class="variable">config</span> <span class="operator">=</span> config();</span><br><span class="line">    <span class="keyword">if</span> (shouldBreakReadReady(config)) &#123;</span><br><span class="line">        clearReadPending();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> pipeline();</span><br><span class="line">    <span class="comment">// io.netty.allocator.type å†³å®š allocator çš„å®ç°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ByteBufAllocator</span> <span class="variable">allocator</span> <span class="operator">=</span> config.getAllocator();</span><br><span class="line">    <span class="comment">// ç”¨æ¥åˆ†é… byteBufï¼Œç¡®å®šå•æ¬¡è¯»å–å¤§å°</span></span><br><span class="line">    <span class="keyword">final</span> RecvByteBufAllocator.<span class="type">Handle</span> <span class="variable">allocHandle</span> <span class="operator">=</span> recvBufAllocHandle();</span><br><span class="line">    allocHandle.reset(config);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">close</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            byteBuf = allocHandle.allocate(allocator);</span><br><span class="line">            <span class="comment">// è¯»å–</span></span><br><span class="line">            allocHandle.lastBytesRead(doReadBytes(byteBuf));</span><br><span class="line">            <span class="keyword">if</span> (allocHandle.lastBytesRead() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                byteBuf.release();</span><br><span class="line">                byteBuf = <span class="literal">null</span>;</span><br><span class="line">                close = allocHandle.lastBytesRead() &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                    readPending = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            allocHandle.incMessagesRead(<span class="number">1</span>);</span><br><span class="line">            readPending = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç† NioSocketChannel ä¸Šçš„ handler</span></span><br><span class="line">            pipeline.fireChannelRead(byteBuf);</span><br><span class="line">            byteBuf = <span class="literal">null</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// æ˜¯å¦è¦ç»§ç»­å¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span> (allocHandle.continueReading());</span><br><span class="line"></span><br><span class="line">        allocHandle.readComplete();</span><br><span class="line">        <span class="comment">// è§¦å‘ read complete äº‹ä»¶</span></span><br><span class="line">        pipeline.fireChannelReadComplete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close) &#123;</span><br><span class="line">            closeOnRead(pipeline);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleReadException(pipeline, byteBuf, t, close, allocHandle);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) &#123;</span><br><span class="line">            removeReadOp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">continueReading</span><span class="params">(UncheckedBooleanSupplier maybeMoreDataSupplier)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">           <span class="comment">// ä¸€èˆ¬ä¸º true</span></span><br><span class="line">           config.isAutoRead() &amp;&amp;</span><br><span class="line">           <span class="comment">// respectMaybeMoreData é»˜è®¤ä¸º true</span></span><br><span class="line">           <span class="comment">// maybeMoreDataSupplier çš„é€»è¾‘æ˜¯å¦‚æœé¢„æœŸè¯»å–å­—èŠ‚ä¸å®é™…è¯»å–å­—èŠ‚ç›¸ç­‰ï¼Œè¿”å› true</span></span><br><span class="line">           (!respectMaybeMoreData || maybeMoreDataSupplier.get()) &amp;&amp;</span><br><span class="line">           <span class="comment">// å°äºæœ€å¤§æ¬¡æ•°ï¼ŒmaxMessagePerRead é»˜è®¤ 16</span></span><br><span class="line">           totalMessages &lt; maxMessagePerRead &amp;&amp;</span><br><span class="line">           <span class="comment">// å®é™…è¯»åˆ°äº†æ•°æ®</span></span><br><span class="line">           totalBytesRead &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">RPCæ¡†æ¶ï¼ŒNettyå®æˆ˜</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="netty" scheme="https://www.jodio.cc/tags/netty/"/>
    
  </entry>
  
  <entry>
    <title>Kafkaæ¶ˆæ¯é˜Ÿåˆ—</title>
    <link href="https://www.jodio.cc/posts/kafka.html"/>
    <id>https://www.jodio.cc/posts/kafka.html</id>
    <published>2023-04-20T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kafka-ä¸€"><a href="#Kafka-ä¸€" class="headerlink" title="Kafka(ä¸€)"></a>Kafka(ä¸€)</h1><h2 id="Kafkaç®€ä»‹"><a href="#Kafkaç®€ä»‹" class="headerlink" title="Kafkaç®€ä»‹"></a>Kafkaç®€ä»‹</h2><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h3><ul><li>æ¶ˆæ¯é˜Ÿåˆ—â€”â€”ç”¨äºå­˜æ”¾æ¶ˆæ¯çš„ç»„ä»¶</li><li>ç¨‹åºå‘˜å¯ä»¥å°†æ¶ˆæ¯æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯</li><li>å¾ˆå¤šæ—¶å€™æ¶ˆæ¯é˜Ÿåˆ—ä¸æ˜¯ä¸€ä¸ªæ°¸ä¹…æ€§çš„å­˜å‚¨ï¼Œæ˜¯ä½œä¸ºä¸´æ—¶å­˜å‚¨å­˜åœ¨çš„ï¼ˆè®¾å®šä¸€ä¸ªæœŸé™ï¼šè®¾ç½®æ¶ˆæ¯åœ¨MQä¸­ä¿å­˜10å¤©ï¼‰</li><li>æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„ç»„ä»¶ï¼Œä¾‹å¦‚ï¼šKafkaã€Active MQã€RabbitMQã€RocketMQã€ZeroMQ</li></ul><h3 id="Kafkaçš„åº”ç”¨åœºæ™¯"><a href="#Kafkaçš„åº”ç”¨åœºæ™¯" class="headerlink" title="Kafkaçš„åº”ç”¨åœºæ™¯"></a>Kafkaçš„åº”ç”¨åœºæ™¯</h3><ul><li>å¼‚æ­¥å¤„ç†<ul><li>å¯ä»¥å°†ä¸€äº›æ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ”¾åœ¨å…¶ä»–ç³»ç»Ÿä¸­ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å°†éœ€è¦è¿›è¡Œå¤„ç†çš„æ¶ˆæ¯è¿›è¡Œå­˜å‚¨ï¼Œå…¶ä»–ç³»ç»Ÿå¯ä»¥æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®</li><li>æ¯”è¾ƒå¸¸è§çš„ï¼šå‘é€çŸ­ä¿¡éªŒè¯ç ã€å‘é€é‚®ä»¶</li></ul></li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Kafka-zookeeper/image-20200916093856262.jpg" alt=""></p><ul><li>ç³»ç»Ÿè§£è€¦<ul><li>åŸå…ˆä¸€ä¸ªå¾®æœåŠ¡æ˜¯é€šè¿‡æ¥å£ï¼ˆHTTPï¼‰è°ƒç”¨å¦ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™æ—¶å€™è€¦åˆå¾ˆä¸¥é‡ï¼Œåªè¦æ¥å£å‘ç”Ÿå˜åŒ–å°±ä¼šå¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨</li><li>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å°†ç³»ç»Ÿè¿›è¡Œè§£è€¦åˆï¼Œç°åœ¨ç¬¬ä¸€ä¸ªå¾®æœåŠ¡å¯ä»¥å°†æ¶ˆæ¯æ”¾å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¦ä¸€ä¸ªå¾®æœåŠ¡å¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æŠŠæ¶ˆæ¯å–å‡ºæ¥è¿›è¡Œå¤„ç†ã€‚è¿›è¡Œç³»ç»Ÿè§£è€¦</li></ul></li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Kafka-zookeeper/image-20200916093908261.jpg" alt=""></p><ul><li>æµé‡å‰Šå³°<ul><li>å› ä¸ºæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä½å»¶è¿Ÿã€é«˜å¯é ã€é«˜ååçš„ï¼Œå¯ä»¥åº”å¯¹å¤§é‡å¹¶å‘</li></ul></li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Kafka-zookeeper/image-20200916093919754.jpg" alt=""></p><ul><li>æ—¥å¿—å¤„ç†<ul><li>å¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºä¸´æ—¶å­˜å‚¨ï¼Œæˆ–è€…ä¸€ç§é€šä¿¡ç®¡é“</li></ul></li></ul><p><img src="https://cdn.staticaly.com/gh/itcat-zxy/Image@main/Kafka-zookeeper/image-20200916093933994.jpg" alt=""></p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å‹"><a href="#æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å‹" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å‹"></a>æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å‹</h3><ul><li>ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…æ¨¡å‹<ul><li>ç”Ÿäº§è€…è´Ÿè´£å°†æ¶ˆæ¯ç”Ÿäº§åˆ°MQä¸­</li><li>æ¶ˆè´¹è€…è´Ÿè´£ä»MQä¸­è·å–æ¶ˆæ¯</li><li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ˜¯è§£è€¦çš„ï¼Œå¯èƒ½æ˜¯ç”Ÿäº§è€…ä¸€ä¸ªç¨‹åºã€æ¶ˆè´¹è€…æ˜¯å¦å¤–ä¸€ä¸ªç¨‹åº</li></ul></li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„æ¨¡å¼<ul><li>ç‚¹å¯¹ç‚¹ï¼šä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯</li><li>å‘å¸ƒè®¢é˜…ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯</li></ul></li></ul><h2 id="Kafkaé›†ç¾¤æ­å»º"><a href="#Kafkaé›†ç¾¤æ­å»º" class="headerlink" title="Kafkaé›†ç¾¤æ­å»º"></a>Kafkaé›†ç¾¤æ­å»º</h2><p>æ³¨æ„ï¼š</p><ul><li>æ¯ä¸€ä¸ªKafkaçš„èŠ‚ç‚¹éƒ½éœ€è¦ä¿®æ”¹broker.idï¼ˆæ¯ä¸ªèŠ‚ç‚¹çš„æ ‡è¯†ï¼Œä¸èƒ½é‡å¤ï¼‰</li><li>log.diræ•°æ®å­˜å‚¨ç›®å½•éœ€è¦é…ç½®</li></ul><h3 id="Kafkaçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…-å·¥å…·"><a href="#Kafkaçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…-å·¥å…·" class="headerlink" title="Kafkaçš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…/å·¥å…·"></a>Kafkaçš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…/å·¥å…·</h3><ul><li>å®‰è£…Kafkaé›†ç¾¤ï¼Œå¯ä»¥æµ‹è¯•ä»¥ä¸‹<ul><li>åˆ›å»ºä¸€ä¸ªtopicä¸»é¢˜ï¼ˆæ¶ˆæ¯éƒ½æ˜¯å­˜æ”¾åœ¨topicä¸­ï¼Œç±»ä¼¼mysqlå»ºè¡¨çš„è¿‡ç¨‹ï¼‰</li><li>åŸºäºkafkaçš„å†…ç½®æµ‹è¯•ç”Ÿäº§è€…è„šæœ¬æ¥è¯»å–æ ‡å‡†è¾“å…¥ï¼ˆé”®ç›˜è¾“å…¥ï¼‰çš„æ•°æ®ï¼Œå¹¶æ”¾å…¥åˆ°topicä¸­</li><li>åŸºäºkafkaçš„å†…ç½®æµ‹è¯•æ¶ˆè´¹è€…è„šæœ¬æ¥æ¶ˆè´¹topicä¸­çš„æ•°æ®</li></ul></li><li>æ¨èå¤§å®¶å¼€å‘çš„ä½¿ç”¨Kafka Tool<ul><li>æµè§ˆKafkaé›†ç¾¤èŠ‚ç‚¹ã€å¤šå°‘ä¸ªtopicã€å¤šå°‘ä¸ªåˆ†åŒº</li><li>åˆ›å»ºtopic/åˆ é™¤topic</li><li>æµè§ˆZooKeeperä¸­çš„æ•°æ®</li></ul></li></ul><h3 id="Kafkaçš„åŸºå‡†æµ‹è¯•å·¥å…·"><a href="#Kafkaçš„åŸºå‡†æµ‹è¯•å·¥å…·" class="headerlink" title="Kafkaçš„åŸºå‡†æµ‹è¯•å·¥å…·"></a>Kafkaçš„åŸºå‡†æµ‹è¯•å·¥å…·</h3><ul><li><p>Kafkaä¸­æä¾›äº†å†…ç½®çš„æ€§èƒ½æµ‹è¯•å·¥å…·</p><ul><li><p>ç”Ÿäº§è€…ï¼šæµ‹è¯•ç”Ÿäº§æ¯ç§’ä¼ è¾“çš„æ•°æ®é‡ï¼ˆå¤šå°‘æ¡æ•°æ®ã€å¤šå°‘Mçš„æ•°æ®ï¼‰</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5000000 records sent, 11825.446943 records/sec (11.28 MB/sec), 2757.61 ms avg latency</span><br></pre></td></tr></table></figure></li><li><p>æ¶ˆè´¹è€…ï¼šæµ‹è¯•æ¶ˆè´¹æ¯æ¡æ‹‰å–çš„æ•°æ®é‡</p></li></ul></li><li><p>å¯¹æ¯”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼šæ¶ˆè´¹è€…çš„é€Ÿåº¦æ›´å¿«</p></li></ul><h2 id="Kafka-Java-APIå¼€å‘"><a href="#Kafka-Java-APIå¼€å‘" class="headerlink" title="Kafka Java APIå¼€å‘"></a>Kafka Java APIå¼€å‘</h2><h3 id="ç”Ÿäº§è€…ç¨‹åºå¼€å‘"><a href="#ç”Ÿäº§è€…ç¨‹åºå¼€å‘" class="headerlink" title="ç”Ÿäº§è€…ç¨‹åºå¼€å‘"></a>ç”Ÿäº§è€…ç¨‹åºå¼€å‘</h3><ol><li>åˆ›å»ºè¿æ¥<ul><li>bootstrap.serversï¼šKafkaçš„æœåŠ¡å™¨åœ°å€</li><li>acksï¼šè¡¨ç¤ºå½“ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®åˆ°Kafkaä¸­ï¼ŒKafkaä¸­ä¼šä»¥ä»€ä¹ˆæ ·çš„ç­–ç•¥è¿”å›</li><li>key.serializerï¼šKafkaä¸­çš„æ¶ˆæ¯æ˜¯ä»¥keyã€valueé”®å€¼å¯¹å­˜å‚¨çš„ï¼Œè€Œä¸”ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯æ˜¯éœ€è¦åœ¨ç½‘ç»œä¸Šä¼ åˆ°çš„ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯StringSerializeræ–¹å¼ï¼Œå°±æ˜¯ä»¥å­—ç¬¦ä¸²æ–¹å¼å‘é€ï¼ˆå°†æ¥è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–çš„ä¸€äº›åºåˆ—åŒ–æ¡†æ¶ï¼šGoogle ProtoBufã€Avroï¼‰</li><li>value.serializerï¼šåŒä¸Š</li></ul></li><li>åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…å¯¹è±¡KafkaProducer</li><li>è°ƒç”¨sendæ–¹æ³•å‘é€æ¶ˆæ¯ï¼ˆProducerRecorï¼Œå°è£…æ˜¯key-valueé”®å€¼å¯¹ï¼‰</li><li>è°ƒç”¨Future.getè¡¨ç¤ºç­‰å¸¦æœåŠ¡ç«¯çš„å“åº”</li><li>å…³é—­ç”Ÿäº§è€…</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaProducerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºç”¨äºè¿æ¥Kafkaçš„Propertiesé…ç½®</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;node1.itcast.cn:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;acks&quot;</span>, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…å¯¹è±¡KafkaProducer</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; kafkaProducer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å‘é€1-100çš„æ¶ˆæ¯åˆ°æŒ‡å®šçš„topicä¸­</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">            <span class="comment">// æ„å»ºä¸€æ¡æ¶ˆæ¯ï¼Œç›´æ¥new ProducerRecord</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;test&quot;</span>, <span class="literal">null</span>, i + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            Future&lt;RecordMetadata&gt; future = kafkaProducer.send(producerRecord);</span><br><span class="line">            <span class="comment">// è°ƒç”¨Futureçš„getæ–¹æ³•ç­‰å¾…å“åº”</span></span><br><span class="line">            future.get();</span><br><span class="line">            System.out.println(<span class="string">&quot;ç¬¬&quot;</span> + i + <span class="string">&quot;æ¡æ¶ˆæ¯å†™å…¥æˆåŠŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.å…³é—­ç”Ÿäº§è€…</span></span><br><span class="line">        kafkaProducer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆè´¹è€…ç¨‹åºå¼€å‘"><a href="#æ¶ˆè´¹è€…ç¨‹åºå¼€å‘" class="headerlink" title="æ¶ˆè´¹è€…ç¨‹åºå¼€å‘"></a>æ¶ˆè´¹è€…ç¨‹åºå¼€å‘</h3><ul><li>group.idï¼šæ¶ˆè´¹è€…ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­åŒ…å«å¤šä¸ªæ¶ˆè´¹è€…ã€‚å¦‚æœè‹¥å¹²ä¸ªæ¶ˆè´¹è€…çš„group.idæ˜¯ä¸€æ ·çš„ï¼Œè¡¨ç¤ºå®ƒä»¬å°±åœ¨ä¸€ä¸ªç»„ä¸­ï¼Œä¸€ä¸ªç»„ä¸­çš„æ¶ˆè´¹è€…æ˜¯å…±åŒæ¶ˆè´¹Kafkaä¸­topicçš„æ•°æ®ã€‚</li><li>Kafkaæ˜¯ä¸€ç§æ‹‰æ¶ˆæ¯æ¨¡å¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨æ¶ˆè´¹è€…ä¸­ä¼šæœ‰ä¸€ä¸ªoffsetï¼Œè¡¨ç¤ºä»å“ªæ¡æ¶ˆæ¯å¼€å§‹æ‹‰å–æ•°æ®</li><li>kafkaConsumer.pollï¼šKafkaçš„æ¶ˆè´¹è€…APIæ˜¯ä¸€æ‰¹ä¸€æ‰¹æ•°æ®çš„æ‹‰å–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆè´¹è€…ç¨‹åº</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1.åˆ›å»ºKafkaæ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line"><span class="comment"> * Properties props = new Properties();</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;bootstrap.servers&quot;, &quot;node1.itcast.cn:9092&quot;);</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;group.id&quot;, &quot;test&quot;);</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;enable.auto.commit&quot;, &quot;true&quot;);</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;auto.commit.interval.ms&quot;, &quot;1000&quot;);</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span></span><br><span class="line"><span class="comment"> * props.setProperty(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.åˆ›å»ºKafkaæ¶ˆè´¹è€…</span></span><br><span class="line"><span class="comment"> * 3.è®¢é˜…è¦æ¶ˆè´¹çš„ä¸»é¢˜</span></span><br><span class="line"><span class="comment"> * 4.ä½¿ç”¨ä¸€ä¸ªwhileå¾ªç¯ï¼Œä¸æ–­ä»Kafkaçš„topicä¸­æ‹‰å–æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> * 5.å°†å°†è®°å½•ï¼ˆrecordï¼‰çš„offsetã€keyã€valueéƒ½æ‰“å°å‡ºæ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConsumerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ›å»ºKafkaæ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;node1.itcast.cn:9092&quot;</span>);</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹è€…ç»„ï¼ˆå¯ä»¥ä½¿ç”¨æ¶ˆè´¹è€…ç»„å°†è‹¥å¹²ä¸ªæ¶ˆè´¹è€…ç»„ç»‡åˆ°ä¸€èµ·ï¼‰ï¼Œå…±åŒæ¶ˆè´¹Kafkaä¸­topicçš„æ•°æ®</span></span><br><span class="line">        <span class="comment">// æ¯ä¸€ä¸ªæ¶ˆè´¹è€…éœ€è¦æŒ‡å®šä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå¦‚æœæ¶ˆè´¹è€…çš„ç»„åæ˜¯ä¸€æ ·çš„ï¼Œè¡¨ç¤ºè¿™å‡ ä¸ªæ¶ˆè´¹è€…æ˜¯ä¸€ä¸ªç»„ä¸­çš„</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æäº¤offset</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æäº¤offsetçš„æ—¶é—´é—´éš”</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;auto.commit.interval.ms&quot;</span>, <span class="string">&quot;1000&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‹‰å–çš„keyã€valueæ•°æ®çš„</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.åˆ›å»ºKafkaæ¶ˆè´¹è€…</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; kafkaConsumer = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. è®¢é˜…è¦æ¶ˆè´¹çš„ä¸»é¢˜</span></span><br><span class="line">        <span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ä»å“ªä¸ªtopicä¸­æ‹‰å–æ•°æ®</span></span><br><span class="line">        kafkaConsumer.subscribe(Arrays.asList(<span class="string">&quot;test&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.ä½¿ç”¨ä¸€ä¸ªwhileå¾ªç¯ï¼Œä¸æ–­ä»Kafkaçš„topicä¸­æ‹‰å–æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// Kafkaçš„æ¶ˆè´¹è€…ä¸€æ¬¡æ‹‰å–ä¸€æ‰¹çš„æ•°æ®</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = kafkaConsumer.poll(Duration.ofSeconds(<span class="number">5</span>));</span><br><span class="line">            <span class="comment">// 5.å°†å°†è®°å½•ï¼ˆrecordï¼‰çš„offsetã€keyã€valueéƒ½æ‰“å°å‡ºæ¥</span></span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">                <span class="comment">// ä¸»é¢˜</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> consumerRecord.topic();</span><br><span class="line">                <span class="comment">// offsetï¼šè¿™æ¡æ¶ˆæ¯å¤„äºKafkaåˆ†åŒºä¸­çš„å“ªä¸ªä½ç½®</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> consumerRecord.offset();</span><br><span class="line">                <span class="comment">// key\value</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> consumerRecord.key();</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> consumerRecord.value();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;topic: &quot;</span> + topic + <span class="string">&quot; offset:&quot;</span> + offset + <span class="string">&quot; key:&quot;</span> + key + <span class="string">&quot; value:&quot;</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥æ–¹å¼ç”Ÿäº§æ¶ˆæ¯"><a href="#ç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥æ–¹å¼ç”Ÿäº§æ¶ˆæ¯" class="headerlink" title="ç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥æ–¹å¼ç”Ÿäº§æ¶ˆæ¯"></a>ç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥æ–¹å¼ç”Ÿäº§æ¶ˆæ¯</h3><ul><li>ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç°Callbackæ¥å£ï¼Œè¯¥æ¥å£ä¸­è¡¨ç¤ºKafkaæœåŠ¡å™¨å“åº”ç»™å®¢æˆ·ç«¯ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨onCompletionæ–¹æ³•<ul><li>metadataï¼šæ¶ˆæ¯çš„å…ƒæ•°æ®ï¼ˆå±äºå“ªä¸ªtopicã€å±äºå“ªä¸ªpartitionã€å¯¹åº”çš„offsetæ˜¯ä»€ä¹ˆï¼‰</li><li>exceptionï¼šè¿™ä¸ªå¯¹è±¡Kafkaç”Ÿäº§æ¶ˆæ¯å°è£…äº†å‡ºç°çš„å¼‚å¸¸ï¼Œå¦‚æœä¸ºnullï¼Œè¡¨ç¤ºå‘é€æˆåŠŸï¼Œå¦‚æœä¸ä¸ºnullï¼Œè¡¨ç¤ºå‡ºç°å¼‚å¸¸ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äºŒã€ä½¿ç”¨å¼‚æ­¥å›è°ƒçš„æ–¹å¼å‘é€æ¶ˆæ¯</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;test&quot;</span>, <span class="literal">null</span>, i + <span class="string">&quot;&quot;</span>);</span><br><span class="line">kafkaProducer.send(producerRecord, <span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ¤æ–­å‘é€æ¶ˆæ¯æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span>(exception == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å‘é€æˆåŠŸ</span></span><br><span class="line">            <span class="comment">// ä¸»é¢˜</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> metadata.topic();</span><br><span class="line">            <span class="comment">// åˆ†åŒºid</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> metadata.partition();</span><br><span class="line">            <span class="comment">// åç§»é‡</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> metadata.offset();</span><br><span class="line">            System.out.println(<span class="string">&quot;topic:&quot;</span> + topic + <span class="string">&quot; åˆ†åŒºidï¼š&quot;</span> + partition + <span class="string">&quot; åç§»é‡ï¼š&quot;</span> + offset);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å‘é€å‡ºç°é”™è¯¯</span></span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§æ¶ˆæ¯å‡ºç°å¼‚å¸¸ï¼&quot;</span>);</span><br><span class="line">            <span class="comment">// æ‰“å°å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(exception.getMessage());</span><br><span class="line">            <span class="comment">// æ‰“å°è°ƒç”¨æ ˆ</span></span><br><span class="line">            System.out.println(exception.getStackTrace());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Kafkaä¸­çš„é‡è¦æ¦‚å¿µ"><a href="#Kafkaä¸­çš„é‡è¦æ¦‚å¿µ" class="headerlink" title="Kafkaä¸­çš„é‡è¦æ¦‚å¿µ"></a>Kafkaä¸­çš„é‡è¦æ¦‚å¿µ</h2><ul><li>broker<ul><li>KafkaæœåŠ¡å™¨è¿›ç¨‹ï¼Œç”Ÿäº§è€…ã€æ¶ˆè´¹è€…éƒ½è¦è¿æ¥broker</li><li>ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ªbrokerç»„æˆï¼ŒåŠŸèƒ½å®ç°Kafkaé›†ç¾¤çš„è´Ÿè½½å‡è¡¡ã€å®¹é”™</li></ul></li><li>producerï¼šç”Ÿäº§è€…</li><li>consumerï¼šæ¶ˆè´¹è€…</li><li>topicï¼šä¸»é¢˜ï¼Œä¸€ä¸ªKafkaé›†ç¾¤ä¸­ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªtopicã€‚ä¸€ä¸ªtopicå¯ä»¥åŒ…å«å¤šä¸ªåˆ†åŒº<ul><li>æ˜¯ä¸€ä¸ªé€»è¾‘ç»“æ„ï¼Œç”Ÿäº§ã€æ¶ˆè´¹æ¶ˆæ¯éƒ½éœ€è¦æŒ‡å®štopic</li></ul></li><li>partitionï¼šKafkaé›†ç¾¤çš„åˆ†å¸ƒå¼å°±æ˜¯ç”±åˆ†åŒºæ¥å®ç°çš„ã€‚ä¸€ä¸ªtopicä¸­çš„æ¶ˆæ¯å¯ä»¥åˆ†å¸ƒåœ¨topicä¸­çš„ä¸åŒpartitionä¸­</li><li>replicaï¼šå‰¯æœ¬ï¼Œå®ç°Kafkafé›†ç¾¤çš„å®¹é”™ï¼Œå®ç°partitionçš„å®¹é”™ã€‚ä¸€ä¸ªtopicè‡³å°‘åº”è¯¥åŒ…å«å¤§äº1ä¸ªçš„å‰¯æœ¬</li><li>consumer groupï¼šæ¶ˆè´¹è€…ç»„ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…å¯ä»¥å…±åŒæ¶ˆè´¹topicä¸­çš„åˆ†åŒºæ•°æ®ã€‚æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„éƒ½ä¸€ä¸ªå”¯ä¸€çš„åå­—ã€‚é…ç½®group.idä¸€æ ·çš„æ¶ˆè´¹è€…æ˜¯å±äºåŒä¸€ä¸ªç»„ä¸­</li><li>offsetï¼šåç§»é‡ã€‚ç›¸å¯¹æ¶ˆè´¹è€…ã€partitionæ¥è¯´ï¼Œå¯ä»¥é€šè¿‡offsetæ¥æ‹‰å–æ•°æ®</li></ul><h3 id="æ¶ˆè´¹è€…ç»„"><a href="#æ¶ˆè´¹è€…ç»„" class="headerlink" title="æ¶ˆè´¹è€…ç»„"></a>æ¶ˆè´¹è€…ç»„</h3><ul><li>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå…±åŒæ¥æ¶ˆè´¹topicä¸­çš„æ•°æ®</li><li>ä¸€ä¸ªtopicä¸­å¦‚æœåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†åŒºåªèƒ½è¢«æŸä¸ªç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</li><li>æœ‰å¤šå°‘ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆå°±å¯ä»¥è¢«åŒä¸€ä¸ªç»„å†…çš„å¤šå°‘ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</li></ul><h3 id="å¹‚ç­‰æ€§"><a href="#å¹‚ç­‰æ€§" class="headerlink" title="å¹‚ç­‰æ€§"></a>å¹‚ç­‰æ€§</h3><ul><li><p>ç”Ÿäº§è€…æ¶ˆæ¯é‡å¤é—®é¢˜</p><ul><li>Kafkaç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯åˆ°partitionï¼Œå¦‚æœç›´æ¥å‘é€æ¶ˆæ¯ï¼Œkafkaä¼šå°†æ¶ˆæ¯ä¿å­˜åˆ°åˆ†åŒºä¸­ï¼Œä½†Kafkaä¼šè¿”å›ä¸€ä¸ªackç»™ç”Ÿäº§è€…ï¼Œè¡¨ç¤ºå½“å‰æ“ä½œæ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦å·²ç»ä¿å­˜äº†è¿™æ¡æ¶ˆæ¯ã€‚å¦‚æœackå“åº”çš„è¿‡ç¨‹å¤±è´¥äº†ï¼Œæ­¤æ—¶ç”Ÿäº§è€…ä¼šé‡è¯•ï¼Œç»§ç»­å‘é€æ²¡æœ‰å‘é€æˆåŠŸçš„æ¶ˆæ¯ï¼ŒKafkaåˆä¼šä¿å­˜ä¸€æ¡ä¸€æ¨¡ä¸€æ ·çš„æ¶ˆæ¯</li></ul></li><li><p>åœ¨Kafkaä¸­å¯ä»¥å¼€å¯å¹‚ç­‰æ€§</p><ul><li>å½“Kafkaçš„ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯æ—¶ï¼Œä¼šå¢åŠ ä¸€ä¸ªpidï¼ˆç”Ÿäº§è€…çš„å”¯ä¸€ç¼–å·ï¼‰å’Œsequence numberï¼ˆé’ˆå¯¹æ¶ˆæ¯çš„ä¸€ä¸ªé€’å¢åºåˆ—ï¼‰</li><li>å‘é€æ¶ˆæ¯ï¼Œä¼šè¿ç€pidå’Œsequence numberä¸€å—å‘é€</li><li>kafkaæ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œä¼šå°†æ¶ˆæ¯å’Œpidã€sequence numberä¸€å¹¶ä¿å­˜ä¸‹æ¥</li><li>å¦‚æœackå“åº”å¤±è´¥ï¼Œç”Ÿäº§è€…é‡è¯•ï¼Œå†æ¬¡å‘é€æ¶ˆæ¯æ—¶ï¼ŒKafkaä¼šæ ¹æ®pidã€sequence numberæ˜¯å¦éœ€è¦å†ä¿å­˜ä¸€æ¡æ¶ˆæ¯</li><li>åˆ¤æ–­æ¡ä»¶ï¼šç”Ÿäº§è€…å‘é€è¿‡æ¥çš„sequence number æ˜¯å¦å°äºç­‰äº partitionä¸­æ¶ˆæ¯å¯¹åº”çš„sequence</li></ul></li></ul><h2 id="äº‹åŠ¡ç¼–ç¨‹"><a href="#äº‹åŠ¡ç¼–ç¨‹" class="headerlink" title="äº‹åŠ¡ç¼–ç¨‹"></a>äº‹åŠ¡ç¼–ç¨‹</h2><ul><li><p>å¼€å¯äº‹åŠ¡çš„æ¡ä»¶</p><ul><li><p>ç”Ÿäº§è€…</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯äº‹åŠ¡å¿…é¡»è¦é…ç½®äº‹åŠ¡çš„ID</span></span><br><span class="line">props.put(<span class="string">&quot;transactional.id&quot;</span>, <span class="string">&quot;dwd_user&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>æ¶ˆè´¹è€…</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é…ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line">props.put(<span class="string">&quot;isolation.level&quot;</span>,<span class="string">&quot;read_committed&quot;</span>);</span><br><span class="line"><span class="comment">// å…³é—­è‡ªåŠ¨æäº¤ï¼Œä¸€ä¼šæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¥æäº¤offsetï¼Œé€šè¿‡äº‹åŠ¡æ¥ç»´æŠ¤offset</span></span><br><span class="line">props.setProperty(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿäº§è€…</p><ul><li>åˆå§‹åŒ–äº‹åŠ¡</li><li>å¼€å¯äº‹åŠ¡</li><li>éœ€è¦ä½¿ç”¨produceræ¥å°†æ¶ˆè´¹è€…çš„offsetæäº¤åˆ°äº‹åŠ¡ä¸­</li><li>æäº¤äº‹åŠ¡</li><li>å¦‚æœå‡ºç°å¼‚å¸¸å›æ»šäº‹åŠ¡</li></ul></li></ul></li></ul><blockquote><p>å¦‚æœä½¿ç”¨äº†äº‹åŠ¡ï¼Œä¸è¦ä½¿ç”¨å¼‚æ­¥å‘é€</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionProgram</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è°ƒç”¨ä¹‹å‰å®ç°çš„æ–¹æ³•ï¼Œåˆ›å»ºæ¶ˆè´¹è€…ã€ç”Ÿäº§è€…å¯¹è±¡</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = createConsumer();</span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = createProducer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. ç”Ÿäº§è€…è°ƒç”¨initTransactionsåˆå§‹åŒ–äº‹åŠ¡</span></span><br><span class="line">        producer.initTransactions();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. ç¼–å†™ä¸€ä¸ªwhileæ­»å¾ªç¯ï¼Œåœ¨whileå¾ªç¯ä¸­ä¸æ–­æ‹‰å–æ•°æ®ï¼Œè¿›è¡Œå¤„ç†åï¼Œå†å†™å…¥åˆ°æŒ‡å®šçš„topic</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// (1)ç”Ÿäº§è€…å¼€å¯äº‹åŠ¡</span></span><br><span class="line">                producer.beginTransaction();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è¿™ä¸ªMapä¿å­˜äº†topicå¯¹åº”çš„partitionçš„åç§»é‡</span></span><br><span class="line">                Map&lt;TopicPartition, OffsetAndMetadata&gt; offsetMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»topicä¸­æ‹‰å–ä¸€æ‰¹çš„æ•°æ®</span></span><br><span class="line">                <span class="comment">// (2)æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯</span></span><br><span class="line">                ConsumerRecords&lt;String, String&gt; concumserRecordArray = consumer.poll(Duration.ofSeconds(<span class="number">5</span>));</span><br><span class="line">                <span class="comment">// (3)éå†æ‹‰å–åˆ°çš„æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œé¢„å¤„ç†</span></span><br><span class="line">                <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; cr : concumserRecordArray) &#123;</span><br><span class="line">                    <span class="comment">// å°†1è½¬æ¢ä¸ºç”·ï¼Œ0è½¬æ¢ä¸ºå¥³</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> cr.value();</span><br><span class="line">                    String[] fieldArray = msg.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å°†æ¶ˆæ¯çš„åç§»é‡ä¿å­˜</span></span><br><span class="line">                    <span class="comment">// æ¶ˆè´¹çš„æ˜¯ods_userä¸­çš„æ•°æ®</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> cr.topic();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> cr.partition();</span><br><span class="line">                    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> cr.offset();</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// offset + 1ï¼šoffsetæ˜¯å½“å‰æ¶ˆè´¹çš„è®°å½•ï¼ˆæ¶ˆæ¯ï¼‰å¯¹åº”åœ¨partitionä¸­çš„offsetï¼Œè€Œæˆ‘ä»¬å¸Œæœ›ä¸‹ä¸€æ¬¡èƒ½ç»§ç»­ä»ä¸‹ä¸€ä¸ªæ¶ˆæ¯æ¶ˆæ¯</span></span><br><span class="line">                    <span class="comment">// å¿…é¡»è¦+1ï¼Œä»èƒ½æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯</span></span><br><span class="line">                    offsetMap.put(<span class="keyword">new</span> <span class="title class_">TopicPartition</span>(topic, partition), <span class="keyword">new</span> <span class="title class_">OffsetAndMetadata</span>(offset + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å°†å­—æ®µè¿›è¡Œæ›¿æ¢</span></span><br><span class="line">                    <span class="keyword">if</span>(fieldArray != <span class="literal">null</span> &amp;&amp; fieldArray.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">sexField</span> <span class="operator">=</span> fieldArray[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">if</span>(sexField.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                            fieldArray[<span class="number">1</span>] = <span class="string">&quot;ç”·&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(sexField.equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">                            fieldArray[<span class="number">1</span>] = <span class="string">&quot;å¥³&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// é‡æ–°æ‹¼æ¥å­—æ®µ</span></span><br><span class="line">                    msg = fieldArray[<span class="number">0</span>] + <span class="string">&quot;,&quot;</span> + fieldArray[<span class="number">1</span>] + <span class="string">&quot;,&quot;</span> + fieldArray[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// (4)ç”Ÿäº§æ¶ˆæ¯åˆ°dwd_user topicä¸­</span></span><br><span class="line">                    ProducerRecord&lt;String, String&gt; dwdMsg = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;dwd_user&quot;</span>, msg);</span><br><span class="line">                    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                    Future&lt;RecordMetadata&gt; future = producer.send(dwdMsg);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        future.get();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        producer.abortTransaction();</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                            new Callback()</span></span><br><span class="line"><span class="comment">//                    &#123;</span></span><br><span class="line"><span class="comment">//                        @Override</span></span><br><span class="line"><span class="comment">//                        public void onCompletion(RecordMetadata metadata, Exception exception) &#123;</span></span><br><span class="line"><span class="comment">//                            // ç”Ÿäº§æ¶ˆæ¯æ²¡æœ‰é—®é¢˜</span></span><br><span class="line"><span class="comment">//                            if(exception == null) &#123;</span></span><br><span class="line"><span class="comment">//                                System.out.println(&quot;å‘é€æˆåŠŸ:&quot; + dwdMsg);</span></span><br><span class="line"><span class="comment">//                            &#125;</span></span><br><span class="line"><span class="comment">//                            else &#123;</span></span><br><span class="line"><span class="comment">//                                System.out.println(&quot;ç”Ÿäº§æ¶ˆæ¯å¤±è´¥:&quot;);</span></span><br><span class="line"><span class="comment">//                                System.out.println(exception.getMessage());</span></span><br><span class="line"><span class="comment">//                                System.out.println(exception.getStackTrace());</span></span><br><span class="line"><span class="comment">//                            &#125;</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;);</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                producer.sendOffsetsToTransaction(offsetMap, <span class="string">&quot;ods_user&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// (6)æäº¤äº‹åŠ¡</span></span><br><span class="line">                producer.commitTransaction();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">// (7)æ•è·å¼‚å¸¸ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™å–æ¶ˆäº‹åŠ¡</span></span><br><span class="line">                producer.abortTransaction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ã€åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ¶ˆè´¹ods_userä¸­çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> KafkaConsumer&lt;String, String&gt; <span class="title function_">createConsumer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é…ç½®æ¶ˆè´¹è€…çš„å±æ€§ï¼ˆæ·»åŠ å¯¹äº‹åŠ¡çš„æ”¯æŒï¼‰</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;node1.itcast.cn:9092&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;ods_user&quot;</span>);</span><br><span class="line">        <span class="comment">// é…ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line">        props.put(<span class="string">&quot;isolation.level&quot;</span>,<span class="string">&quot;read_committed&quot;</span>);</span><br><span class="line">        <span class="comment">// å…³é—­è‡ªåŠ¨æäº¤ï¼Œä¸€ä¼šæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¥æäº¤offsetï¼Œé€šè¿‡äº‹åŠ¡æ¥ç»´æŠ¤offset</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–å™¨</span></span><br><span class="line">        props.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ„å»ºæ¶ˆè´¹è€…å¯¹è±¡</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; kafkaConsumer = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. è®¢é˜…ä¸€ä¸ªtopic</span></span><br><span class="line">        kafkaConsumer.subscribe(Arrays.asList(<span class="string">&quot;ods_user&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> kafkaConsumer;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äºŒã€ç¼–å†™createProduceræ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰äº‹åŠ¡é…ç½®çš„ç”Ÿäº§è€…</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> KafkaProducer&lt;String, String&gt; <span class="title function_">createProducer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é…ç½®ç”Ÿäº§è€…å¸¦æœ‰äº‹åŠ¡é…ç½®çš„å±æ€§</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;node1.itcast.cn:9092&quot;</span>);</span><br><span class="line">        <span class="comment">// å¼€å¯äº‹åŠ¡å¿…é¡»è¦é…ç½®äº‹åŠ¡çš„ID</span></span><br><span class="line">        props.put(<span class="string">&quot;transactional.id&quot;</span>, <span class="string">&quot;dwd_user&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ„å»ºç”Ÿäº§è€…</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; kafkaProducer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> kafkaProducer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Kafkaä¸­çš„åˆ†åŒºå‰¯æœ¬æœºåˆ¶"><a href="#Kafkaä¸­çš„åˆ†åŒºå‰¯æœ¬æœºåˆ¶" class="headerlink" title="Kafkaä¸­çš„åˆ†åŒºå‰¯æœ¬æœºåˆ¶"></a>Kafkaä¸­çš„åˆ†åŒºå‰¯æœ¬æœºåˆ¶</h2><h3 id="ç”Ÿäº§è€…çš„åˆ†åŒºå†™å…¥ç­–ç•¥"><a href="#ç”Ÿäº§è€…çš„åˆ†åŒºå†™å…¥ç­–ç•¥" class="headerlink" title="ç”Ÿäº§è€…çš„åˆ†åŒºå†™å…¥ç­–ç•¥"></a>ç”Ÿäº§è€…çš„åˆ†åŒºå†™å…¥ç­–ç•¥</h3><ul><li>è½®è¯¢ï¼ˆæŒ‰ç…§æ¶ˆæ¯å°½é‡ä¿è¯æ¯ä¸ªåˆ†åŒºçš„è´Ÿè½½ï¼‰ç­–ç•¥ï¼Œæ¶ˆæ¯ä¼šå‡åŒ€åœ°åˆ†å¸ƒåˆ°æ¯ä¸ªpartition<ul><li>å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œkeyä¸ºnullçš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯è½®è¯¢ç­–ç•¥</li></ul></li><li>éšæœºç­–ç•¥ï¼ˆä¸ä½¿ç”¨ï¼‰</li><li>æŒ‰keyå†™å…¥ç­–ç•¥ï¼Œkey.hash() % åˆ†åŒºçš„æ•°é‡</li><li>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼ˆç±»ä¼¼äºMapReduceæŒ‡å®šåˆ†åŒºï¼‰</li></ul><blockquote><p>ä¹±åºé—®é¢˜</p><ul><li>åœ¨Kafkaä¸­ç”Ÿäº§è€…æ˜¯æœ‰å†™å…¥ç­–ç•¥ï¼Œå¦‚æœtopicæœ‰å¤šä¸ªåˆ†åŒºï¼Œå°±ä¼šå°†æ•°æ®åˆ†æ•£åœ¨ä¸åŒçš„partitionä¸­å­˜å‚¨</li><li>å½“partitionæ•°é‡å¤§äº1çš„æ—¶å€™ï¼Œæ•°æ®ï¼ˆæ¶ˆæ¯ï¼‰ä¼šæ‰“æ•£åˆ†å¸ƒåœ¨ä¸åŒçš„partitionä¸­</li><li>å¦‚æœåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ¶ˆæ¯æ˜¯æœ‰åºçš„</li></ul></blockquote><h3 id="æ¶ˆè´¹ç»„Consumer-Group-Rebalanceæœºåˆ¶"><a href="#æ¶ˆè´¹ç»„Consumer-Group-Rebalanceæœºåˆ¶" class="headerlink" title="æ¶ˆè´¹ç»„Consumer Group Rebalanceæœºåˆ¶"></a>æ¶ˆè´¹ç»„Consumer Group Rebalanceæœºåˆ¶</h3><ul><li>å†å‡è¡¡ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…æ¶ˆè´¹çš„åˆ†åŒºä¼šäº§ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…åˆ†é…ä¸å‡åŒ€ï¼ˆä¾‹å¦‚ï¼šæœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹3ä¸ªï¼Œå› ä¸ºæŸä¸ªpartitionå´©æºƒäº†ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å½“å‰æ²¡æœ‰åˆ†åŒºè¦å‰Šå³°ï¼‰ï¼ŒKafka Consumer Groupå°±ä¼šå¯ç”¨rebalanceæœºåˆ¶ï¼Œé‡æ–°å¹³è¡¡è¿™ä¸ªConsumer Groupå†…çš„æ¶ˆè´¹è€…æ¶ˆè´¹çš„åˆ†åŒºåˆ†é…ã€‚</li><li>è§¦å‘æ—¶æœº<ul><li>æ¶ˆè´¹è€…æ•°é‡å‘ç”Ÿå˜åŒ–<ul><li>æŸä¸ªæ¶ˆè´¹è€…crash</li><li>æ–°å¢æ¶ˆè´¹è€…</li></ul></li><li>topicçš„æ•°é‡å‘ç”Ÿå˜åŒ–<ul><li>æŸä¸ªtopicè¢«åˆ é™¤</li></ul></li><li>partitionçš„æ•°é‡å‘ç”Ÿå˜åŒ–<ul><li>åˆ é™¤partition</li><li>æ–°å¢partition</li></ul></li></ul></li><li>ä¸è‰¯å½±å“<ul><li>å‘ç”Ÿrebalanceï¼Œæ‰€æœ‰çš„consumerå°†ä¸å†å·¥ä½œï¼Œå…±åŒæ¥å‚ä¸å†å‡è¡¡ï¼Œç›´åˆ°æ¯ä¸ªæ¶ˆè´¹è€…éƒ½å·²ç»è¢«æˆåŠŸåˆ†é…æ‰€éœ€è¦æ¶ˆè´¹çš„åˆ†åŒºä¸ºæ­¢ï¼ˆrebalanceç»“æŸï¼‰</li></ul></li></ul><h3 id="æ¶ˆè´¹è€…çš„åˆ†åŒºåˆ†é…ç­–ç•¥"><a href="#æ¶ˆè´¹è€…çš„åˆ†åŒºåˆ†é…ç­–ç•¥" class="headerlink" title="æ¶ˆè´¹è€…çš„åˆ†åŒºåˆ†é…ç­–ç•¥"></a>æ¶ˆè´¹è€…çš„åˆ†åŒºåˆ†é…ç­–ç•¥</h3><p>åˆ†åŒºåˆ†é…ç­–ç•¥ï¼šä¿éšœæ¯ä¸ªæ¶ˆè´¹è€…å°½é‡èƒ½å¤Ÿå‡è¡¡åœ°æ¶ˆè´¹åˆ†åŒºçš„æ•°æ®ï¼Œä¸èƒ½å‡ºç°æŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åˆ†åŒºçš„æ•°é‡ç‰¹åˆ«å¤šï¼ŒæŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„åˆ†åŒºç‰¹åˆ«å°‘</p><ul><li>Rangeåˆ†é…ç­–ç•¥ï¼ˆèŒƒå›´åˆ†é…ç­–ç•¥ï¼‰ï¼šKafkaé»˜è®¤çš„åˆ†é…ç­–ç•¥<ul><li>nï¼šåˆ†åŒºçš„æ•°é‡ / æ¶ˆè´¹è€…æ•°é‡</li><li>mï¼šåˆ†åŒºçš„æ•°é‡ % æ¶ˆè´¹è€…æ•°é‡</li><li>å‰mä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹n+1ä¸ªåˆ†åŒº</li><li>å‰©ä½™çš„æ¶ˆè´¹è€…æ¶ˆè´¹nä¸ªåˆ†åŒº</li></ul></li><li>RoundRobinåˆ†é…ç­–ç•¥ï¼ˆè½®è¯¢åˆ†é…ç­–ç•¥ï¼‰<ul><li>æ¶ˆè´¹è€…æŒ¨ä¸ªåˆ†é…æ¶ˆè´¹çš„åˆ†åŒº</li></ul></li><li>Strikyç²˜æ€§åˆ†é…ç­–ç•¥<ul><li>åœ¨æ²¡æœ‰å‘ç”Ÿrebalanceè·Ÿè½®è¯¢åˆ†é…ç­–ç•¥æ˜¯ä¸€è‡´çš„</li><li>å‘ç”Ÿäº†rebalanceï¼Œè½®è¯¢åˆ†é…ç­–ç•¥ï¼Œé‡æ–°èµ°ä¸€éè½®è¯¢åˆ†é…çš„è¿‡ç¨‹ã€‚è€Œç²˜æ€§ä¼šä¿è¯è·Ÿä¸Šä¸€æ¬¡çš„å°½é‡ä¸€è‡´ï¼Œåªæ˜¯å°†æ–°çš„éœ€è¦åˆ†é…çš„åˆ†åŒºï¼Œå‡åŒ€çš„åˆ†é…åˆ°ç°æœ‰å¯ç”¨çš„æ¶ˆè´¹è€…ä¸­å³å¯</li><li>å‡å°‘ä¸Šä¸‹æ–‡çš„åˆ‡æ¢</li></ul></li></ul><h3 id="å‰¯æœ¬çš„ACKæœºåˆ¶"><a href="#å‰¯æœ¬çš„ACKæœºåˆ¶" class="headerlink" title="å‰¯æœ¬çš„ACKæœºåˆ¶"></a>å‰¯æœ¬çš„ACKæœºåˆ¶</h3><p>produceræ˜¯ä¸æ–­åœ°å¾€Kafkaä¸­å†™å…¥æ•°æ®ï¼Œå†™å…¥æ•°æ®ä¼šæœ‰ä¸€ä¸ªè¿”å›ç»“æœï¼Œè¡¨ç¤ºæ˜¯å¦å†™å…¥æˆåŠŸã€‚è¿™é‡Œå¯¹åº”æœ‰ä¸€ä¸ªACKsçš„é…ç½®ã€‚</p><ul><li>acks = 0ï¼šç”Ÿäº§è€…åªç®¡å†™å…¥ï¼Œä¸ç®¡æ˜¯å¦å†™å…¥æˆåŠŸï¼Œå¯èƒ½ä¼šæ•°æ®ä¸¢å¤±ã€‚æ€§èƒ½æ˜¯æœ€å¥½çš„</li><li>acks = 1ï¼šç”Ÿäº§è€…ä¼šç­‰åˆ°leaderåˆ†åŒºå†™å…¥æˆåŠŸåï¼Œè¿”å›æˆåŠŸï¼Œæ¥ç€å‘é€ä¸‹ä¸€æ¡</li><li>acks = -1/allï¼šç¡®ä¿æ¶ˆæ¯å†™å…¥åˆ°leaderåˆ†åŒºã€è¿˜ç¡®ä¿æ¶ˆæ¯å†™å…¥åˆ°å¯¹åº”å‰¯æœ¬éƒ½æˆåŠŸåï¼Œæ¥ç€å‘é€ä¸‹ä¸€æ¡ï¼Œæ€§èƒ½æ˜¯æœ€å·®çš„</li></ul><p>æ ¹æ®ä¸šåŠ¡æƒ…å†µæ¥é€‰æ‹©ackæœºåˆ¶ï¼Œæ˜¯è¦æ±‚æ€§èƒ½æœ€é«˜ï¼Œä¸€éƒ¨åˆ†æ•°æ®ä¸¢å¤±å½±å“ä¸å¤§ï¼Œå¯ä»¥é€‰æ‹©0/1ã€‚å¦‚æœè¦æ±‚æ•°æ®ä¸€å®šä¸èƒ½ä¸¢å¤±ï¼Œå°±å¾—é…ç½®ä¸º-1/allã€‚</p><p>åˆ†åŒºä¸­æ˜¯æœ‰leaderå’Œfollowerçš„æ¦‚å¿µï¼Œä¸ºäº†ç¡®ä¿æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œåªèƒ½ä»åˆ†åŒºleaderå»è¯»å†™æ¶ˆæ¯ï¼Œfolloweråšçš„äº‹æƒ…å°±æ˜¯åŒæ­¥æ•°æ®ï¼ŒBackupã€‚</p><h3 id="é«˜çº§APIï¼ˆHigh-Level-APIï¼‰ã€ä½çº§APIï¼ˆLow-Level-APIï¼‰"><a href="#é«˜çº§APIï¼ˆHigh-Level-APIï¼‰ã€ä½çº§APIï¼ˆLow-Level-APIï¼‰" class="headerlink" title="é«˜çº§APIï¼ˆHigh-Level APIï¼‰ã€ä½çº§APIï¼ˆLow-Level APIï¼‰"></a>é«˜çº§APIï¼ˆHigh-Level APIï¼‰ã€ä½çº§APIï¼ˆLow-Level APIï¼‰</h3><ul><li>é«˜çº§APIå°±æ˜¯ç›´æ¥è®©Kafkaå¸®åŠ©ç®¡ç†ã€å¤„ç†åˆ†é…ã€æ•°æ®<ul><li>offsetå­˜å‚¨åœ¨ZKä¸­</li><li>ç”±kafkaçš„rebalanceæ¥æ§åˆ¶æ¶ˆè´¹è€…åˆ†é…çš„åˆ†åŒº</li><li>å¼€å‘èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œæ— éœ€å¼€å‘è€…å…³æ³¨åº•å±‚ç»†èŠ‚</li><li>æ— æ³•åšåˆ°ç»†ç²’åº¦çš„æ§åˆ¶</li></ul></li><li>ä½çº§APIï¼šç”±ç¼–å†™çš„ç¨‹åºè‡ªå·±æ§åˆ¶é€»è¾‘<ul><li>è‡ªå·±æ¥ç®¡ç†Offsetï¼Œå¯ä»¥å°†offsetå­˜å‚¨åœ¨ZKã€MySQLã€Redisã€HBaseã€Flinkçš„çŠ¶æ€å­˜å‚¨</li><li>æŒ‡å®šæ¶ˆè´¹è€…æ‹‰å–æŸä¸ªåˆ†åŒºçš„æ•°æ®</li><li>å¯ä»¥åšåˆ°ç»†ç²’åº¦çš„æ§åˆ¶</li><li>åŸæœ‰çš„Kafkaçš„ç­–ç•¥ä¼šå¤±æ•ˆï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥å®ç°æ¶ˆè´¹æœºåˆ¶</li></ul></li></ul><h2 id="KafkaåŸç†"><a href="#KafkaåŸç†" class="headerlink" title="KafkaåŸç†"></a>KafkaåŸç†</h2><h3 id="leaderå’Œfollower"><a href="#leaderå’Œfollower" class="headerlink" title="leaderå’Œfollower"></a>leaderå’Œfollower</h3><ul><li>Kafkaä¸­çš„leaderå’Œfolloweræ˜¯ç›¸å¯¹åˆ†åŒºæœ‰æ„ä¹‰ï¼Œä¸æ˜¯ç›¸å¯¹broker</li><li>Kafkaåœ¨åˆ›å»ºtopicçš„æ—¶å€™ï¼Œä¼šå°½é‡åˆ†é…åˆ†åŒºçš„leaderåœ¨ä¸åŒçš„brokerä¸­ï¼Œå…¶å®å°±æ˜¯è´Ÿè½½å‡è¡¡</li><li>leaderèŒè´£ï¼šè¯»å†™æ•°æ®</li><li>followerèŒè´£ï¼šåŒæ­¥æ•°æ®ã€å‚ä¸é€‰ä¸¾ï¼ˆleader crashä¹‹åï¼Œä¼šé€‰ä¸¾ä¸€ä¸ªfolloweré‡æ–°æˆä¸ºåˆ†åŒºçš„leader</li><li>æ³¨æ„å’ŒZooKeeperåŒºåˆ†<ul><li>ZKçš„leaderè´Ÿè´£è¯»ã€å†™ï¼Œfollowerå¯ä»¥è¯»å–</li><li>Kafkaçš„leaderè´Ÿè´£è¯»å†™ã€followerä¸èƒ½è¯»å†™æ•°æ®ï¼ˆç¡®ä¿æ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼‰ï¼ŒKafkaä¸€ä¸ªtopicæœ‰å¤šä¸ªåˆ†åŒºleaderï¼Œä¸€æ ·å¯ä»¥å®ç°æ•°æ®æ“ä½œçš„è´Ÿè½½å‡è¡¡</li></ul></li></ul><h3 id="AR-ISR-OSR"><a href="#AR-ISR-OSR" class="headerlink" title="AR\ISR\OSR"></a>AR\ISR\OSR</h3><ul><li>ARè¡¨ç¤ºä¸€ä¸ªtopicä¸‹çš„æ‰€æœ‰å‰¯æœ¬</li><li>ISRï¼šIn Sync Replicasï¼Œæ­£åœ¨åŒæ­¥çš„å‰¯æœ¬ï¼ˆå¯ä»¥ç†è§£ä¸ºå½“å‰æœ‰å‡ ä¸ªfolloweræ˜¯å­˜æ´»çš„ï¼‰</li><li>OSRï¼šOut of Sync Replicasï¼Œä¸å†åŒæ­¥çš„å‰¯æœ¬</li><li>AR = ISR + OSR</li></ul><h3 id="leaderé€‰ä¸¾"><a href="#leaderé€‰ä¸¾" class="headerlink" title="leaderé€‰ä¸¾"></a>leaderé€‰ä¸¾</h3><ul><li>Controllerï¼šcontrolleræ˜¯kafkaé›†ç¾¤çš„è€å¤§ï¼Œæ˜¯é’ˆå¯¹Brokerçš„ä¸€ä¸ªè§’è‰²<ul><li>Controlleræ˜¯é«˜å¯ç”¨çš„ï¼Œæ˜¯ç”¨è¿‡ZKæ¥è¿›è¡Œé€‰ä¸¾</li></ul></li><li>Leaderï¼šæ˜¯é’ˆå¯¹partitionçš„ä¸€ä¸ªè§’è‰²<ul><li>Leaderæ˜¯é€šè¿‡ISRæ¥è¿›è¡Œå¿«é€Ÿé€‰ä¸¾</li></ul></li><li><p>å¦‚æœKafkaæ˜¯åŸºäºZKæ¥è¿›è¡Œé€‰ä¸¾ï¼ŒZKçš„å‹åŠ›å¯èƒ½ä¼šæ¯”è¾ƒå¤§ã€‚ä¾‹å¦‚ï¼šæŸä¸ªèŠ‚ç‚¹å´©æºƒï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸Šä¸ä»…ä»…åªæœ‰ä¸€ä¸ªleaderï¼Œæ˜¯æœ‰ä¸å°‘çš„leaderéœ€è¦é€‰ä¸¾ã€‚é€šè¿‡ISRå¿«é€Ÿè¿›è¡Œé€‰ä¸¾ã€‚</p></li><li><p>leaderçš„è´Ÿè½½å‡è¡¡</p><ul><li>å¦‚æœæŸä¸ªbroker crashä¹‹åï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´partitionçš„leaderåˆ†å¸ƒä¸å‡åŒ€ï¼Œå°±æ˜¯ä¸€ä¸ªbrokerä¸Šå­˜åœ¨ä¸€ä¸ªtopicä¸‹ä¸åŒpartitionçš„leader</li><li><p>é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤ï¼Œå¯ä»¥å°†leaderåˆ†é…åˆ°ä¼˜å…ˆçš„leaderå¯¹åº”çš„brokerï¼Œç¡®ä¿leaderæ˜¯å‡åŒ€åˆ†é…çš„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-leader-election.sh --bootstrap-server node1.itcast.cn:9092 --topic test --partition=2 --election-type preferred</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="Kafkaè¯»å†™æµç¨‹"><a href="#Kafkaè¯»å†™æµç¨‹" class="headerlink" title="Kafkaè¯»å†™æµç¨‹"></a>Kafkaè¯»å†™æµç¨‹</h3><ul><li>å†™æµç¨‹<ul><li>é€šè¿‡ZooKeeperæ‰¾partitionå¯¹åº”çš„leaderï¼Œleaderæ˜¯è´Ÿè´£å†™çš„</li><li>producerå¼€å§‹å†™å…¥æ•°æ®</li><li>ISRé‡Œé¢çš„followerå¼€å§‹åŒæ­¥æ•°æ®ï¼Œå¹¶è¿”å›ç»™leader ACK</li><li>è¿”å›ç»™producer ACK</li></ul></li><li>è¯»æµç¨‹<ul><li>é€šè¿‡ZooKeeperæ‰¾partitionå¯¹åº”çš„leaderï¼Œleaderæ˜¯è´Ÿè´£è¯»çš„</li><li>é€šè¿‡ZooKeeperæ‰¾åˆ°æ¶ˆè´¹è€…å¯¹åº”çš„offset</li><li>ç„¶åå¼€å§‹ä»offsetå¾€åé¡ºåºæ‹‰å–æ•°æ®</li><li>æäº¤offsetï¼ˆè‡ªåŠ¨æäº¤â€”â€”æ¯éš”å¤šå°‘ç§’æäº¤ä¸€æ¬¡offsetã€æ‰‹åŠ¨æäº¤â€”â€”æ”¾å…¥åˆ°äº‹åŠ¡ä¸­æäº¤ï¼‰</li></ul></li></ul><h3 id="Kafkaçš„ç‰©ç†å­˜å‚¨"><a href="#Kafkaçš„ç‰©ç†å­˜å‚¨" class="headerlink" title="Kafkaçš„ç‰©ç†å­˜å‚¨"></a>Kafkaçš„ç‰©ç†å­˜å‚¨</h3><ul><li>Kafkaçš„æ•°æ®ç»„ç»‡ç»“æ„<ul><li>topic</li><li>partition</li><li>segment<ul><li>.logæ•°æ®æ–‡ä»¶</li><li>.indexï¼ˆç¨€ç–ç´¢å¼•ï¼‰</li><li>.timeindexï¼ˆæ ¹æ®æ—¶é—´åšçš„ç´¢å¼•ï¼‰</li></ul></li></ul></li><li>æ·±å…¥äº†è§£è¯»æ•°æ®çš„æµç¨‹<ul><li>æ¶ˆè´¹è€…çš„offsetæ˜¯ä¸€ä¸ªé’ˆå¯¹partitionå…¨å±€offset</li><li>å¯ä»¥æ ¹æ®è¿™ä¸ªoffsetæ‰¾åˆ°segmentæ®µ</li><li>æ¥ç€éœ€è¦å°†å…¨å±€çš„offsetè½¬æ¢æˆsegmentçš„å±€éƒ¨offset</li><li>æ ¹æ®å±€éƒ¨çš„offsetï¼Œå°±å¯ä»¥ä»ï¼ˆ.indexç¨€ç–ç´¢å¼•ï¼‰æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ä½ç½®</li><li>å¼€å§‹é¡ºåºè¯»å–</li></ul></li></ul><h3 id="æ¶ˆæ¯ä¼ é€’çš„è¯­ä¹‰æ€§"><a href="#æ¶ˆæ¯ä¼ é€’çš„è¯­ä¹‰æ€§" class="headerlink" title="æ¶ˆæ¯ä¼ é€’çš„è¯­ä¹‰æ€§"></a>æ¶ˆæ¯ä¼ é€’çš„è¯­ä¹‰æ€§</h3><p>Flinké‡Œé¢æœ‰å¯¹åº”çš„æ¯ç§ä¸åŒæœºåˆ¶çš„ä¿è¯ï¼Œæä¾›Exactly-Onceä¿éšœï¼ˆäºŒé˜¶æ®µäº‹åŠ¡æäº¤æ–¹å¼ï¼‰</p><ul><li>At-most onceï¼šæœ€å¤šä¸€æ¬¡ï¼ˆåªç®¡æŠŠæ•°æ®æ¶ˆè´¹åˆ°ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æˆåŠŸï¼Œå¯èƒ½ä¼šæœ‰æ•°æ®ä¸¢å¤±ï¼‰</li><li>At-least onceï¼šæœ€å°‘ä¸€æ¬¡ï¼ˆæœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤æ¶ˆè´¹ï¼‰</li><li>Exactly-Onceï¼šä»…æœ‰ä¸€æ¬¡ï¼ˆäº‹åŠ¡æ€§æ€§çš„ä¿éšœï¼Œä¿è¯æ¶ˆæ¯æœ‰ä¸”ä»…è¢«å¤„ç†ä¸€æ¬¡ï¼‰</li></ul><h3 id="Kafkaçš„æ¶ˆæ¯ä¸ä¸¢å¤±"><a href="#Kafkaçš„æ¶ˆæ¯ä¸ä¸¢å¤±" class="headerlink" title="Kafkaçš„æ¶ˆæ¯ä¸ä¸¢å¤±"></a>Kafkaçš„æ¶ˆæ¯ä¸ä¸¢å¤±</h3><ul><li>brokeræ¶ˆæ¯ä¸ä¸¢å¤±ï¼šå› ä¸ºæœ‰å‰¯æœ¬relicasçš„å­˜åœ¨ï¼Œä¼šä¸æ–­åœ°ä»leaderä¸­åŒæ­¥å‰¯æœ¬ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªbroker crashï¼Œä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œé™¤éæ˜¯åªæœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚</li><li>ç”Ÿäº§è€…æ¶ˆæ¯ä¸ä¸¢å¤±ï¼šACKæœºåˆ¶ï¼ˆé…ç½®æˆALL/-1ï¼‰ã€é…ç½®0æˆ–è€…1æœ‰å¯èƒ½ä¼šå­˜åœ¨ä¸¢å¤±</li><li>æ¶ˆè´¹è€…æ¶ˆè´¹ä¸ä¸¢å¤±ï¼šé‡ç‚¹æ§åˆ¶offset<ul><li>At-least onceï¼šä¸€ç§æ•°æ®å¯èƒ½ä¼šé‡å¤æ¶ˆè´¹</li><li>Exactly-Onceï¼šä»…è¢«ä¸€æ¬¡æ¶ˆè´¹</li></ul></li></ul><h3 id="æ•°æ®ç§¯å‹"><a href="#æ•°æ®ç§¯å‹" class="headerlink" title="æ•°æ®ç§¯å‹"></a>æ•°æ®ç§¯å‹</h3><ul><li>æ•°æ®ç§¯å‹æŒ‡çš„æ˜¯æ¶ˆè´¹è€…å› ä¸ºæœ‰ä¸€äº›å¤–éƒ¨çš„IOã€ä¸€äº›æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼ˆFull GCâ€”â€”Stop the worldï¼‰ï¼Œå°±ä¼šé€ æˆæ¶ˆæ¯åœ¨partitionä¸­ä¸€ç›´å­˜åœ¨å¾—ä¸åˆ°æ¶ˆè´¹ï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®ç§¯å‹</li><li>åœ¨ä¼ä¸šä¸­ï¼Œæˆ‘ä»¬è¦æœ‰ç›‘æ§ç³»ç»Ÿï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µï¼Œéœ€è¦å°½å¿«å¤„ç†ã€‚è™½ç„¶åç»­çš„Spark Streaming/Flinkå¯ä»¥å®ç°èƒŒå‹æœºåˆ¶ï¼Œä½†æ˜¯æ•°æ®ç´¯ç§¯å¤ªå¤šä¸€å®šå¯¹å®æ—¶ç³»ç»Ÿå®ƒçš„å®æ—¶æ€§æ˜¯æœ‰è¯´å½±å“çš„</li></ul><h3 id="æ•°æ®æ¸…ç†-amp-é…é¢é™é€Ÿ"><a href="#æ•°æ®æ¸…ç†-amp-é…é¢é™é€Ÿ" class="headerlink" title="æ•°æ®æ¸…ç†&amp;é…é¢é™é€Ÿ"></a>æ•°æ®æ¸…ç†&amp;é…é¢é™é€Ÿ</h3><ul><li>æ•°æ®æ¸…ç†<ul><li>Log Deletionï¼ˆæ—¥å¿—åˆ é™¤ï¼‰ï¼šå¦‚æœæ¶ˆæ¯è¾¾åˆ°ä¸€å®šçš„æ¡ä»¶ï¼ˆæ—¶é—´ã€æ—¥å¿—å¤§å°ã€offsetå¤§å°ï¼‰ï¼ŒKafkaå°±ä¼šè‡ªåŠ¨å°†æ—¥å¿—è®¾ç½®ä¸ºå¾…åˆ é™¤ï¼ˆsegmentç«¯çš„åç¼€åä¼šä»¥ .deleteç»“å°¾ï¼‰ï¼Œæ—¥å¿—ç®¡ç†ç¨‹åºä¼šå®šæœŸæ¸…ç†è¿™äº›æ—¥å¿—<ul><li>é»˜è®¤æ˜¯7å¤©è¿‡æœŸ</li></ul></li><li>Log Compactionï¼ˆæ—¥å¿—åˆå¹¶ï¼‰<ul><li>å¦‚æœåœ¨ä¸€äº›key-valueæ•°æ®ä¸­ï¼Œä¸€ä¸ªkeyå¯ä»¥å¯¹åº”å¤šä¸ªä¸åŒç‰ˆæœ¬çš„value</li><li>ç»è¿‡æ—¥å¿—åˆå¹¶ï¼Œå°±ä¼šåªä¿ç•™æœ€æ–°çš„ä¸€ä¸ªç‰ˆæœ¬</li></ul></li></ul></li><li>é…é¢é™é€Ÿ<ul><li>å¯ä»¥é™åˆ¶Producerã€Consumerçš„é€Ÿç‡</li><li>é˜²æ­¢Kafkaçš„é€Ÿåº¦è¿‡å¿«ï¼Œå ç”¨æ•´ä¸ªæœåŠ¡å™¨ï¼ˆbrokerï¼‰çš„æ‰€æœ‰IOèµ„æº</li></ul></li></ul>]]></content>
    
    
    <summary type="html">å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„é›†ç¾¤æ­å»º</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="kafka" scheme="https://www.jodio.cc/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>Zookeeper åˆ†å¸ƒå¼é”</title>
    <link href="https://www.jodio.cc/posts/zookeeper.html"/>
    <id>https://www.jodio.cc/posts/zookeeper.html</id>
    <published>2023-04-20T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-1-ä¸‹è½½å®‰è£…"><a href="#1-1-ä¸‹è½½å®‰è£…" class="headerlink" title="1.1 ä¸‹è½½å®‰è£…"></a>1.1 ä¸‹è½½å®‰è£…</h2><p><strong>1ã€ç¯å¢ƒå‡†å¤‡</strong></p><p>ZooKeeperæœåŠ¡å™¨æ˜¯ç”¨Javaåˆ›å»ºçš„ï¼Œå®ƒè¿è¡Œåœ¨JVMä¹‹ä¸Šã€‚éœ€è¦å®‰è£…JDK 7æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><p><strong>2ã€ä¸Šä¼ </strong></p><p>å°†ä¸‹è½½çš„ZooKeeperæ”¾åˆ°/opt/ZooKeeperç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸Šä¼ zookeeper alt+p</span></span><br><span class="line">put f:/setup/apache-zookeeper-3.5.6-bin.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ‰“å¼€ optç›®å½•</span></span><br><span class="line">cd /opt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ›å»ºzooKeeperç›®å½•</span></span><br><span class="line">mkdir  zooKeeper</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å°†zookeeperå®‰è£…åŒ…ç§»åŠ¨åˆ° /opt/zooKeeper</span></span><br><span class="line">mv apache-zookeeper-3.5.6-bin.tar.gz /opt/zookeeper/</span><br></pre></td></tr></table></figure><p><strong>3ã€è§£å‹</strong></p><p>å°†taråŒ…è§£å‹åˆ°/opt/zookeeperç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf apache-ZooKeeper-3.5.6-bin.tar.gz </span><br></pre></td></tr></table></figure><h2 id="1-2-é…ç½®å¯åŠ¨"><a href="#1-2-é…ç½®å¯åŠ¨" class="headerlink" title="1.2 é…ç½®å¯åŠ¨"></a>1.2 é…ç½®å¯åŠ¨</h2><p><strong>1ã€é…ç½®zoo.cfg</strong></p><p>è¿›å…¥åˆ°confç›®å½•æ‹·è´ä¸€ä¸ªzoo_sample.cfgå¹¶å®Œæˆé…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¿›å…¥åˆ°confç›®å½•</span></span><br><span class="line">cd /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ‹·è´</span></span><br><span class="line">cp  zoo_sample.cfg  zoo.cfg</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ‰“å¼€ç›®å½•</span></span><br><span class="line">cd /opt/zooKeeper/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ›å»ºzooKeeperå­˜å‚¨ç›®å½•</span></span><br><span class="line">mkdir  zkdata</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¿®æ”¹zoo.cfg</span></span><br><span class="line">vim /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/zoo.cfg</span><br></pre></td></tr></table></figure><p><img src="images\1577548250377.png" alt="1577548250377"></p><p>ä¿®æ”¹å­˜å‚¨ç›®å½•ï¼šdataDir=/opt/zookeeper/zkdata</p><p><strong>2ã€å¯åŠ¨ZooKeeper</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/bin/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¯åŠ¨</span></span><br><span class="line"> ./zkServer.sh  start</span><br></pre></td></tr></table></figure><p><img src="images\1577548052037.png" alt="1577548052037"></p><p>çœ‹åˆ°ä¸Šå›¾è¡¨ç¤ºZooKeeperæˆåŠŸå¯åŠ¨</p><p><strong>3ã€æŸ¥çœ‹ZooKeeperçŠ¶æ€</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zkServer.sh status</span><br></pre></td></tr></table></figure><p>zookeeperå¯åŠ¨æˆåŠŸã€‚standaloneä»£è¡¨zkæ²¡æœ‰æ­å»ºé›†ç¾¤ï¼Œç°åœ¨æ˜¯å•èŠ‚ç‚¹</p><p><img src="images\1577548175232.png" alt="1577548175232"></p><p>zookeeperæ²¡æœ‰å¯åŠ¨</p><p><img src="images\1577548112773.png" alt="1577548112773"></p><h2 id="æ­å»ºZookeeperé›†ç¾¤"><a href="#æ­å»ºZookeeperé›†ç¾¤" class="headerlink" title="æ­å»ºZookeeperé›†ç¾¤"></a><strong>æ­å»ºZookeeperé›†ç¾¤</strong></h2><h3 id="1-1-æ­å»ºè¦æ±‚"><a href="#1-1-æ­å»ºè¦æ±‚" class="headerlink" title="1.1 æ­å»ºè¦æ±‚"></a><strong>1.1 æ­å»ºè¦æ±‚</strong></h3><p>çœŸå®çš„é›†ç¾¤æ˜¯éœ€è¦éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šçš„ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬æµ‹è¯•æ—¶åŒæ—¶å¯åŠ¨å¾ˆå¤šä¸ªè™šæ‹Ÿæœºå†…å­˜ä¼šåƒä¸æ¶ˆï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸ä¼šæ­å»º<strong>ä¼ªé›†ç¾¤</strong>ï¼Œä¹Ÿå°±æ˜¯æŠŠæ‰€æœ‰çš„æœåŠ¡éƒ½æ­å»ºåœ¨ä¸€å°è™šæ‹Ÿæœºä¸Šï¼Œç”¨ç«¯å£è¿›è¡ŒåŒºåˆ†ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œè¦æ±‚æ­å»ºä¸€ä¸ªä¸‰ä¸ªèŠ‚ç‚¹çš„Zookeeperé›†ç¾¤ï¼ˆä¼ªé›†ç¾¤ï¼‰ã€‚</p><h3 id="1-2-å‡†å¤‡å·¥ä½œ"><a href="#1-2-å‡†å¤‡å·¥ä½œ" class="headerlink" title="1.2 å‡†å¤‡å·¥ä½œ"></a><strong>1.2 å‡†å¤‡å·¥ä½œ</strong></h3><p>é‡æ–°éƒ¨ç½²ä¸€å°è™šæ‹Ÿæœºä½œä¸ºæˆ‘ä»¬æ­å»ºé›†ç¾¤çš„æµ‹è¯•æœåŠ¡å™¨ã€‚</p><p>ï¼ˆ1ï¼‰å®‰è£…JDK  ã€æ­¤æ­¥éª¤çœç•¥ã€‘ã€‚</p><p>ï¼ˆ2ï¼‰Zookeeperå‹ç¼©åŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨<br>ï¼ˆ3ï¼‰å°†Zookeeperè§£å‹ ï¼Œå»ºç«‹/usr/local/zookeeper-clusterç›®å½•ï¼Œå°†è§£å‹åçš„Zookeeperå¤åˆ¶åˆ°ä»¥ä¸‹ä¸‰ä¸ªç›®å½•</p><p>/usr/local/zookeeper-cluster/zookeeper-1</p><p>/usr/local/zookeeper-cluster/zookeeper-2</p><p>/usr/local/zookeeper-cluster/zookeeper-3</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /usr/local/zookeeper-cluster</span><br><span class="line">[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-1</span><br><span class="line">[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-2</span><br><span class="line">[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-3</span><br></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰åˆ›å»ºdataç›®å½• ï¼Œå¹¶ä¸”å°† confä¸‹zoo_sample.cfg æ–‡ä»¶æ”¹åä¸º zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/zookeeper-cluster/zookeeper-1/data</span><br><span class="line">mkdir /usr/local/zookeeper-cluster/zookeeper-2/data</span><br><span class="line">mkdir /usr/local/zookeeper-cluster/zookeeper-3/data</span><br><span class="line"></span><br><span class="line">mv  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</span><br><span class="line">mv  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</span><br><span class="line">mv  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</span><br></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰ é…ç½®æ¯ä¸€ä¸ªZookeeper çš„dataDir å’Œ clientPort åˆ†åˆ«ä¸º2181  2182  2183</p><p>ä¿®æ”¹/usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">clientPort=2181</span><br><span class="line">dataDir=/usr/local/zookeeper-cluster/zookeeper-1/data</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹/usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">clientPort=2182</span><br><span class="line">dataDir=/usr/local/zookeeper-cluster/zookeeper-2/data</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹/usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">clientPort=2183</span><br><span class="line">dataDir=/usr/local/zookeeper-cluster/zookeeper-3/data</span><br></pre></td></tr></table></figure><h3 id="1-3-é…ç½®é›†ç¾¤"><a href="#1-3-é…ç½®é›†ç¾¤" class="headerlink" title="1.3 é…ç½®é›†ç¾¤"></a><strong>1.3 é…ç½®é›†ç¾¤</strong></h3><p>ï¼ˆ1ï¼‰åœ¨æ¯ä¸ªzookeeperçš„ data ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª myid æ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«æ˜¯1ã€2ã€3 ã€‚è¿™ä¸ªæ–‡ä»¶å°±æ˜¯è®°å½•æ¯ä¸ªæœåŠ¡å™¨çš„ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt;/usr/local/zookeeper-cluster/zookeeper-1/data/myid</span><br><span class="line">echo 2 &gt;/usr/local/zookeeper-cluster/zookeeper-2/data/myid</span><br><span class="line">echo 3 &gt;/usr/local/zookeeper-cluster/zookeeper-3/data/myid</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åœ¨æ¯ä¸€ä¸ªzookeeper çš„ zoo.cfgé…ç½®å®¢æˆ·ç«¯è®¿é—®ç«¯å£ï¼ˆclientPortï¼‰å’Œé›†ç¾¤æœåŠ¡å™¨IPåˆ—è¡¨ã€‚</p><p>é›†ç¾¤æœåŠ¡å™¨IPåˆ—è¡¨å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</span><br><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</span><br><span class="line">vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">server.1=192.168.149.135:2881:3881</span><br><span class="line">server.2=192.168.149.135:2882:3882</span><br><span class="line">server.3=192.168.149.135:2883:3883</span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼šserver.æœåŠ¡å™¨ID=æœåŠ¡å™¨IPåœ°å€ï¼šæœåŠ¡å™¨ä¹‹é—´é€šä¿¡ç«¯å£ï¼šæœåŠ¡å™¨ä¹‹é—´æŠ•ç¥¨é€‰ä¸¾ç«¯å£</p><h3 id="1-4-å¯åŠ¨é›†ç¾¤"><a href="#1-4-å¯åŠ¨é›†ç¾¤" class="headerlink" title="1.4 å¯åŠ¨é›†ç¾¤"></a><strong>1.4 å¯åŠ¨é›†ç¾¤</strong></h3><p>å¯åŠ¨é›†ç¾¤å°±æ˜¯åˆ†åˆ«å¯åŠ¨æ¯ä¸ªå®ä¾‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start</span><br></pre></td></tr></table></figure><p><img src="images/wps11.jpg" alt="img"> </p><p>å¯åŠ¨åæˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸‹æ¯ä¸ªå®ä¾‹çš„è¿è¡ŒçŠ¶æ€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p>å…ˆæŸ¥è¯¢ç¬¬ä¸€ä¸ªæœåŠ¡</p><p><img src="images\wps12.jpg" alt="img"> </p><p>Modeä¸ºfollowerè¡¨ç¤ºæ˜¯<strong>è·Ÿéšè€…</strong>ï¼ˆä»ï¼‰</p><p>å†æŸ¥è¯¢ç¬¬äºŒä¸ªæœåŠ¡Mod ä¸ºleaderè¡¨ç¤ºæ˜¯<strong>é¢†å¯¼è€…</strong>ï¼ˆä¸»ï¼‰</p><p><img src="images/\wps13.jpg" alt="img"> </p><p>æŸ¥è¯¢ç¬¬ä¸‰ä¸ªä¸ºè·Ÿéšè€…ï¼ˆä»ï¼‰</p><p><img src="images/\wps14.jpg" alt="img"> </p><h3 id="1-5-æ¨¡æ‹Ÿé›†ç¾¤å¼‚å¸¸"><a href="#1-5-æ¨¡æ‹Ÿé›†ç¾¤å¼‚å¸¸" class="headerlink" title="1.5 æ¨¡æ‹Ÿé›†ç¾¤å¼‚å¸¸"></a><strong>1.5 æ¨¡æ‹Ÿé›†ç¾¤å¼‚å¸¸</strong></h3><p>ï¼ˆ1ï¼‰é¦–å…ˆæˆ‘ä»¬å…ˆæµ‹è¯•å¦‚æœæ˜¯ä»æœåŠ¡å™¨æŒ‚æ‰ï¼Œä¼šæ€ä¹ˆæ ·</p><p>æŠŠ3å·æœåŠ¡å™¨åœæ‰ï¼Œè§‚å¯Ÿ1å·å’Œ2å·ï¼Œå‘ç°çŠ¶æ€å¹¶æ²¡æœ‰å˜åŒ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh stop</span><br><span class="line"></span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p><img src="images/\wps15.jpg" alt="img"> </p><p>ç”±æ­¤å¾—å‡ºç»“è®ºï¼Œ3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä»æœåŠ¡å™¨æŒ‚æ‰ï¼Œé›†ç¾¤æ­£å¸¸</p><p>ï¼ˆ2ï¼‰æˆ‘ä»¬å†æŠŠ1å·æœåŠ¡å™¨ï¼ˆä»æœåŠ¡å™¨ï¼‰ä¹Ÿåœæ‰ï¼ŒæŸ¥çœ‹2å·ï¼ˆä¸»æœåŠ¡å™¨ï¼‰çš„çŠ¶æ€ï¼Œå‘ç°å·²ç»åœæ­¢è¿è¡Œäº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh stop</span><br><span class="line"></span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p><img src="images/\wps16.jpg" alt="img"> </p><p>ç”±æ­¤å¾—å‡ºç»“è®ºï¼Œ3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œ2ä¸ªä»æœåŠ¡å™¨éƒ½æŒ‚æ‰ï¼Œä¸»æœåŠ¡å™¨ä¹Ÿæ— æ³•è¿è¡Œã€‚å› ä¸ºå¯è¿è¡Œçš„æœºå™¨æ²¡æœ‰è¶…è¿‡é›†ç¾¤æ€»æ•°é‡çš„åŠæ•°ã€‚</p><p>ï¼ˆ3ï¼‰æˆ‘ä»¬å†æ¬¡æŠŠ1å·æœåŠ¡å™¨å¯åŠ¨èµ·æ¥ï¼Œå‘ç°2å·æœåŠ¡å™¨åˆå¼€å§‹æ­£å¸¸å·¥ä½œäº†ã€‚è€Œä¸”ä¾ç„¶æ˜¯é¢†å¯¼è€…ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p><img src="images/\wps17.jpg" alt="img"> </p><p>ï¼ˆ4ï¼‰æˆ‘ä»¬æŠŠ3å·æœåŠ¡å™¨ä¹Ÿå¯åŠ¨èµ·æ¥ï¼ŒæŠŠ2å·æœåŠ¡å™¨åœæ‰,åœæ‰åè§‚å¯Ÿ1å·å’Œ3å·çš„çŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh stop</span><br><span class="line"></span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p><img src="images/\wps18.jpg" alt="img"> </p><p>å‘ç°æ–°çš„leaderäº§ç”Ÿäº†~  </p><p>ç”±æ­¤æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå½“é›†ç¾¤ä¸­çš„ä¸»æœåŠ¡å™¨æŒ‚äº†ï¼Œé›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨ä¼šè‡ªåŠ¨è¿›è¡Œé€‰ä¸¾çŠ¶æ€ï¼Œç„¶åäº§ç”Ÿæ–°å¾—leader </p><p>ï¼ˆ5ï¼‰æˆ‘ä»¬å†æ¬¡æµ‹è¯•ï¼Œå½“æˆ‘ä»¬æŠŠ2å·æœåŠ¡å™¨é‡æ–°å¯åŠ¨èµ·æ¥å¯åŠ¨åï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ2å·æœåŠ¡å™¨ä¼šå†æ¬¡æˆä¸ºæ–°çš„é¢†å¯¼å—ï¼Ÿæˆ‘ä»¬çœ‹ç»“æœ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br><span class="line">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><p><img src="images/\wps19.jpg" alt="img"><img src="images/\wps20.jpg" alt="img"> </p><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œ2å·æœåŠ¡å™¨å¯åŠ¨åä¾ç„¶æ˜¯è·Ÿéšè€…ï¼ˆä»æœåŠ¡å™¨ï¼‰ï¼Œ3å·æœåŠ¡å™¨ä¾ç„¶æ˜¯é¢†å¯¼è€…ï¼ˆä¸»æœåŠ¡å™¨ï¼‰ï¼Œæ²¡æœ‰æ’¼åŠ¨3å·æœåŠ¡å™¨çš„é¢†å¯¼åœ°ä½ã€‚</p><p>ç”±æ­¤æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå½“é¢†å¯¼è€…äº§ç”Ÿåï¼Œå†æ¬¡æœ‰æ–°æœåŠ¡å™¨åŠ å…¥é›†ç¾¤ï¼Œä¸ä¼šå½±å“åˆ°ç°ä»»é¢†å¯¼è€…ã€‚</p>]]></content>
    
    
    <summary type="html">åˆ†å¸ƒå¼é”çš„çŸ¥è¯†</summary>
    
    
    
    <category term="zookeeper" scheme="https://www.jodio.cc/categories/zookeeper/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="zookeeper" scheme="https://www.jodio.cc/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>Shellç¼–ç¨‹</title>
    <link href="https://www.jodio.cc/posts/shell.html"/>
    <id>https://www.jodio.cc/posts/shell.html</id>
    <published>2023-04-19T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èµ°è¿›-Shell-ç¼–ç¨‹çš„å¤§é—¨"><a href="#èµ°è¿›-Shell-ç¼–ç¨‹çš„å¤§é—¨" class="headerlink" title="èµ°è¿› Shell ç¼–ç¨‹çš„å¤§é—¨"></a>èµ°è¿› Shell ç¼–ç¨‹çš„å¤§é—¨</h2><h3 id="ä¸ºä»€ä¹ˆè¦å­¦-Shellï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦å­¦-Shellï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å­¦ Shellï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦å­¦ Shellï¼Ÿ</h3><p>Shell ç¼–ç¨‹åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å¼€å‘å·¥ä½œä¸­éå¸¸å®ç”¨ï¼Œç›®å‰ Linux ç³»ç»Ÿä¸‹æœ€æµè¡Œçš„è¿ç»´è‡ªåŠ¨åŒ–è¯­è¨€å°±æ˜¯ Shell å’Œ Python äº†ã€‚</p><p>å­¦ä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯å¾€å®ç”¨æ€§æ–¹å‘ç€æƒ³ã€‚ä»å·¥ä½œè§’åº¦æ¥è®²ï¼Œå­¦ä¹  Shell æ˜¯ä¸ºäº†æé«˜æˆ‘ä»¬è‡ªå·±å·¥ä½œæ•ˆç‡ï¼Œæé«˜äº§å‡ºï¼Œè®©æˆ‘ä»¬åœ¨æ›´å°‘çš„æ—¶é—´å®Œæˆæ›´å¤šçš„äº‹æƒ…ã€‚</p><p>å¾ˆå¤šäººä¼šè¯´ Shell ç¼–ç¨‹å±äºè¿ç»´æ–¹é¢çš„çŸ¥è¯†äº†ï¼Œåº”è¯¥æ˜¯è¿ç»´äººå‘˜æ¥åšï¼Œæˆ‘ä»¬åšåç«¯å¼€å‘çš„æ²¡å¿…è¦å­¦ã€‚æˆ‘è§‰å¾—è¿™ç§è¯´æ³•å¤§é”™ç‰¹é”™ï¼Œç›¸æ¯”äºä¸“é—¨åš Linux è¿ç»´çš„äººå‘˜æ¥è¯´ï¼Œæˆ‘ä»¬å¯¹ Shell ç¼–ç¨‹æŒæ¡ç¨‹åº¦çš„è¦æ±‚è¦æ¯”ä»–ä»¬ä½ï¼Œä½†æ˜¯ Shell ç¼–ç¨‹ä¹Ÿæ˜¯æˆ‘ä»¬å¿…é¡»è¦æŒæ¡çš„ï¼</p><p>ç›®å‰ Linux ç³»ç»Ÿä¸‹æœ€æµè¡Œçš„è¿ç»´è‡ªåŠ¨åŒ–è¯­è¨€å°±æ˜¯ Shell å’Œ Python äº†ã€‚</p><p>ä¸¤è€…ä¹‹é—´ï¼ŒShell å‡ ä¹æ˜¯ IT ä¼ä¸šå¿…é¡»ä½¿ç”¨çš„è¿ç»´è‡ªåŠ¨åŒ–ç¼–ç¨‹è¯­è¨€ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿ç»´å·¥ä½œä¸­çš„æœåŠ¡ç›‘æ§ã€ä¸šåŠ¡å¿«é€Ÿéƒ¨ç½²ã€æœåŠ¡å¯åŠ¨åœæ­¢ã€æ•°æ®å¤‡ä»½åŠå¤„ç†ã€æ—¥å¿—åˆ†æç­‰ç¯èŠ‚é‡Œï¼Œshell æ˜¯ä¸å¯ç¼ºçš„ã€‚Python æ›´é€‚åˆå¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»¥åŠå¼€å‘å¤æ‚çš„è¿ç»´è½¯ä»¶å·¥å…·ï¼Œå®ç°é€šè¿‡ web è®¿é—®ç­‰ã€‚Shell æ˜¯ä¸€ä¸ªå‘½ä»¤è§£é‡Šå™¨ï¼Œè§£é‡Šæ‰§è¡Œç”¨æˆ·æ‰€è¾“å…¥çš„å‘½ä»¤å’Œç¨‹åºã€‚ä¸€è¾“å…¥å‘½ä»¤ï¼Œå°±ç«‹å³å›åº”çš„äº¤äº’çš„å¯¹è¯æ–¹å¼ã€‚</p><p>å¦å¤–ï¼Œäº†è§£ shell ç¼–ç¨‹ä¹Ÿæ˜¯å¤§éƒ¨åˆ†äº’è”ç½‘å…¬å¸æ‹›è˜åç«¯å¼€å‘äººå‘˜çš„è¦æ±‚ã€‚ä¸‹å›¾æ˜¯æˆ‘æˆªå–çš„ä¸€äº›çŸ¥åäº’è”ç½‘å…¬å¸å¯¹äº Shell ç¼–ç¨‹çš„è¦æ±‚ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-16/60190220.jpg" alt="å¤§å‹äº’è”ç½‘å…¬å¸å¯¹äºshellç¼–ç¨‹æŠ€èƒ½çš„è¦æ±‚"></p><h3 id="ä»€ä¹ˆæ˜¯-Shellï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Shellï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Shellï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Shellï¼Ÿ</h3><p>ç®€å•æ¥è¯´â€œShell ç¼–ç¨‹å°±æ˜¯å¯¹ä¸€å † Linux å‘½ä»¤çš„é€»è¾‘åŒ–å¤„ç†â€ã€‚</p><p>W3Cschool ä¸Šçš„ä¸€ç¯‡æ–‡ç« æ˜¯è¿™æ ·ä»‹ç» Shell çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-26/19456505.jpg" alt="ä»€ä¹ˆæ˜¯ Shellï¼Ÿ"></p><h3 id="Shell-ç¼–ç¨‹çš„-Hello-World"><a href="#Shell-ç¼–ç¨‹çš„-Hello-World" class="headerlink" title="Shell ç¼–ç¨‹çš„ Hello World"></a>Shell ç¼–ç¨‹çš„ Hello World</h3><p>å­¦ä¹ ä»»ä½•ä¸€é—¨ç¼–ç¨‹è¯­è¨€ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è¾“å‡º HelloWorld äº†ï¼ä¸‹é¢æˆ‘ä¼šä»æ–°å»ºæ–‡ä»¶åˆ° shell ä»£ç ç¼–å†™æ¥è¯´ä¸‹ Shell ç¼–ç¨‹å¦‚ä½•è¾“å‡º Hello Worldã€‚</p><p>(1)æ–°å»ºä¸€ä¸ªæ–‡ä»¶ helloworld.sh :<code>touch helloworld.sh</code>ï¼Œæ‰©å±•åä¸º shï¼ˆsh ä»£è¡¨ Shellï¼‰ï¼ˆæ‰©å±•åå¹¶ä¸å½±å“è„šæœ¬æ‰§è¡Œï¼Œè§åçŸ¥æ„å°±å¥½ï¼Œå¦‚æœä½ ç”¨ php å†™ shell è„šæœ¬ï¼Œæ‰©å±•åå°±ç”¨ php å¥½äº†ï¼‰</p><p>(2) ä½¿è„šæœ¬å…·æœ‰æ‰§è¡Œæƒé™ï¼š<code>chmod +x helloworld.sh</code></p><p>(3) ä½¿ç”¨ vim å‘½ä»¤ä¿®æ”¹ helloworld.sh æ–‡ä»¶ï¼š<code>vim helloworld.sh</code>(vim æ–‡ä»¶â€”â€”â€”&gt;è¿›å…¥æ–‡ä»¶â€”â€”-&gt;å‘½ä»¤æ¨¡å¼â€”â€”â€”&gt;æŒ‰ i è¿›å…¥ç¼–è¾‘æ¨¡å¼â€”â€”-&gt;ç¼–è¾‘æ–‡ä»¶ â€”â€”â€”-&gt;æŒ‰ Esc è¿›å…¥åº•è¡Œæ¨¡å¼â€”â€”-&gt;è¾“å…¥:wq/q! ï¼ˆè¾“å…¥ wq ä»£è¡¨å†™å…¥å†…å®¹å¹¶é€€å‡ºï¼Œå³ä¿å­˜ï¼›è¾“å…¥ q!ä»£è¡¨å¼ºåˆ¶é€€å‡ºä¸ä¿å­˜ã€‚ï¼‰)</p><p>helloworld.sh å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç¬¬ä¸€ä¸ªshellå°ç¨‹åº,<span class="built_in">echo</span> æ˜¯linuxä¸­çš„è¾“å‡ºå‘½ä»¤ã€‚</span></span><br><span class="line">echo  &quot;helloworld!&quot;</span><br></pre></td></tr></table></figure><p>shell ä¸­ # ç¬¦å·è¡¨ç¤ºæ³¨é‡Šã€‚<strong>shell çš„ç¬¬ä¸€è¡Œæ¯”è¾ƒç‰¹æ®Šï¼Œä¸€èˆ¬éƒ½ä¼šä»¥#!å¼€å§‹æ¥æŒ‡å®šä½¿ç”¨çš„ shell ç±»å‹ã€‚åœ¨ linux ä¸­ï¼Œé™¤äº† bash shell ä»¥å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šç‰ˆæœ¬çš„ shellï¼Œ ä¾‹å¦‚ zshã€dash ç­‰ç­‰â€¦ä¸è¿‡ bash shell è¿˜æ˜¯æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ã€‚</strong></p><p>(4) è¿è¡Œè„šæœ¬:<code>./helloworld.sh</code> ã€‚ï¼ˆæ³¨æ„ï¼Œä¸€å®šè¦å†™æˆ <code>./helloworld.sh</code> ï¼Œè€Œä¸æ˜¯ <code>helloworld.sh</code> ï¼Œè¿è¡Œå…¶å®ƒäºŒè¿›åˆ¶çš„ç¨‹åºä¹Ÿä¸€æ ·ï¼Œç›´æ¥å†™ <code>helloworld.sh</code> ï¼Œlinux ç³»ç»Ÿä¼šå» PATH é‡Œå¯»æ‰¾æœ‰æ²¡æœ‰å« helloworld.sh çš„ï¼Œè€Œåªæœ‰ /bin, /sbin, /usr/binï¼Œ/usr/sbin ç­‰åœ¨ PATH é‡Œï¼Œä½ çš„å½“å‰ç›®å½•é€šå¸¸ä¸åœ¨ PATH é‡Œï¼Œæ‰€ä»¥å†™æˆ <code>helloworld.sh</code> æ˜¯ä¼šæ‰¾ä¸åˆ°å‘½ä»¤çš„ï¼Œè¦ç”¨<code>./helloworld.sh</code> å‘Šè¯‰ç³»ç»Ÿè¯´ï¼Œå°±åœ¨å½“å‰ç›®å½•æ‰¾ã€‚ï¼‰</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-16/55296212.jpg" alt="shell ç¼–ç¨‹Hello World"></p><h2 id="Shell-å˜é‡"><a href="#Shell-å˜é‡" class="headerlink" title="Shell å˜é‡"></a>Shell å˜é‡</h2><h3 id="Shell-ç¼–ç¨‹ä¸­çš„å˜é‡ä»‹ç»"><a href="#Shell-ç¼–ç¨‹ä¸­çš„å˜é‡ä»‹ç»" class="headerlink" title="Shell ç¼–ç¨‹ä¸­çš„å˜é‡ä»‹ç»"></a>Shell ç¼–ç¨‹ä¸­çš„å˜é‡ä»‹ç»</h3><p><strong>Shell ç¼–ç¨‹ä¸­ä¸€èˆ¬åˆ†ä¸ºä¸‰ç§å˜é‡ï¼š</strong></p><ol><li><strong>æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å˜é‡ï¼ˆè‡ªå®šä¹‰å˜é‡ï¼‰:</strong> ä»…åœ¨å½“å‰ Shell å®ä¾‹ä¸­æœ‰æ•ˆï¼Œå…¶ä»– Shell å¯åŠ¨çš„ç¨‹åºä¸èƒ½è®¿é—®å±€éƒ¨å˜é‡ã€‚</li><li><strong>Linux å·²å®šä¹‰çš„ç¯å¢ƒå˜é‡</strong>ï¼ˆç¯å¢ƒå˜é‡ï¼Œ ä¾‹å¦‚ï¼š<code>PATH</code>, â€‹<code>HOME</code> ç­‰â€¦, è¿™ç±»å˜é‡æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼‰ï¼Œä½¿ç”¨ <code>env</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„ç¯å¢ƒå˜é‡ï¼Œè€Œ set å‘½ä»¤æ—¢å¯ä»¥æŸ¥çœ‹ç¯å¢ƒå˜é‡ä¹Ÿå¯ä»¥æŸ¥çœ‹è‡ªå®šä¹‰å˜é‡ã€‚</li><li><strong>Shell å˜é‡</strong> ï¼šShell å˜é‡æ˜¯ç”± Shell ç¨‹åºè®¾ç½®çš„ç‰¹æ®Šå˜é‡ã€‚Shell å˜é‡ä¸­æœ‰ä¸€éƒ¨åˆ†æ˜¯ç¯å¢ƒå˜é‡ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡ä¿è¯äº† Shell çš„æ­£å¸¸è¿è¡Œ</li></ol><p><strong>å¸¸ç”¨çš„ç¯å¢ƒå˜é‡:</strong></p><blockquote><p>PATH å†³å®šäº† shell å°†åˆ°å“ªäº›ç›®å½•ä¸­å¯»æ‰¾å‘½ä»¤æˆ–ç¨‹åº<br>HOME å½“å‰ç”¨æˆ·ä¸»ç›®å½•<br>HISTSIZE ã€€å†å²è®°å½•æ•°<br>LOGNAME å½“å‰ç”¨æˆ·çš„ç™»å½•å<br>HOSTNAME ã€€æŒ‡ä¸»æœºçš„åç§°<br>SHELL å½“å‰ç”¨æˆ· Shell ç±»å‹<br>LANGUAGE ã€€è¯­è¨€ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œå¤šè¯­è¨€å¯ä»¥ä¿®æ”¹æ­¤ç¯å¢ƒå˜é‡<br>MAIL ã€€å½“å‰ç”¨æˆ·çš„é‚®ä»¶å­˜æ”¾ç›®å½•<br>PS1 ã€€åŸºæœ¬æç¤ºç¬¦ï¼Œå¯¹äº root ç”¨æˆ·æ˜¯#ï¼Œå¯¹äºæ™®é€šç”¨æˆ·æ˜¯$</p></blockquote><p><strong>ä½¿ç”¨ Linux å·²å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼š</strong></p><p>æ¯”å¦‚æˆ‘ä»¬è¦çœ‹å½“å‰ç”¨æˆ·ç›®å½•å¯ä»¥ä½¿ç”¨ï¼š<code>echo $HOME</code>å‘½ä»¤ï¼›å¦‚æœæˆ‘ä»¬è¦çœ‹å½“å‰ç”¨æˆ· Shell ç±»å‹ å¯ä»¥ä½¿ç”¨<code>echo $SHELL</code>å‘½ä»¤ã€‚å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•ã€‚</p><p><strong>ä½¿ç”¨è‡ªå·±å®šä¹‰çš„å˜é‡ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è‡ªå®šä¹‰å˜é‡hello</span></span><br><span class="line">hello=&quot;hello world&quot;</span><br><span class="line">echo $hello</span><br><span class="line">echo  &quot;helloworld!&quot;</span><br></pre></td></tr></table></figure><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-17/19835037.jpg" alt="ä½¿ç”¨è‡ªå·±å®šä¹‰çš„å˜é‡"></p><p><strong>Shell ç¼–ç¨‹ä¸­çš„å˜é‡åçš„å‘½åçš„æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li>å‘½ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ï¼Œæ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé¦–ä¸ªå­—ç¬¦ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰å¼€å¤´ã€‚</li><li>ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰ã€‚</li><li>ä¸èƒ½ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ã€‚</li><li>ä¸èƒ½ä½¿ç”¨ bash é‡Œçš„å…³é”®å­—ï¼ˆå¯ç”¨ help å‘½ä»¤æŸ¥çœ‹ä¿ç•™å…³é”®å­—ï¼‰ã€‚</li></ul><h3 id="Shell-å­—ç¬¦ä¸²å…¥é—¨"><a href="#Shell-å­—ç¬¦ä¸²å…¥é—¨" class="headerlink" title="Shell å­—ç¬¦ä¸²å…¥é—¨"></a>Shell å­—ç¬¦ä¸²å…¥é—¨</h3><p>å­—ç¬¦ä¸²æ˜¯ shell ç¼–ç¨‹ä¸­æœ€å¸¸ç”¨æœ€æœ‰ç”¨çš„æ•°æ®ç±»å‹ï¼ˆé™¤äº†æ•°å­—å’Œå­—ç¬¦ä¸²ï¼Œä¹Ÿæ²¡å•¥å…¶å®ƒç±»å‹å¥½ç”¨äº†ï¼‰ï¼Œå­—ç¬¦ä¸²å¯ä»¥ç”¨å•å¼•å·ï¼Œä¹Ÿå¯ä»¥ç”¨åŒå¼•å·ã€‚è¿™ç‚¹å’Œ Java ä¸­æœ‰æ‰€ä¸åŒã€‚</p><p>åœ¨å•å¼•å·ä¸­æ‰€æœ‰çš„ç‰¹æ®Šç¬¦å·ï¼Œå¦‚$å’Œåå¼•å·éƒ½æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ã€‚åœ¨åŒå¼•å·ä¸­ï¼Œé™¤äº†â€$â€,â€\â€å’Œåå¼•å·ï¼Œå…¶ä»–çš„å­—ç¬¦æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ã€‚</p><p><strong>å•å¼•å·å­—ç¬¦ä¸²ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">name=&#x27;SnailClimb&#x27;</span><br><span class="line">hello=&#x27;Hello, I  am &#x27;$name&#x27;!&#x27;</span><br><span class="line">echo $hello</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, I  am &#x27;$name&#x27;!</span><br></pre></td></tr></table></figure><p><strong>åŒå¼•å·å­—ç¬¦ä¸²ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">name=&#x27;SnailClimb&#x27;</span><br><span class="line">hello=&quot;Hello, I  am &quot;$name&quot;!&quot;</span><br><span class="line">echo $hello</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, I am SnailClimb!</span><br></pre></td></tr></table></figure><h3 id="Shell-å­—ç¬¦ä¸²å¸¸è§æ“ä½œ"><a href="#Shell-å­—ç¬¦ä¸²å¸¸è§æ“ä½œ" class="headerlink" title="Shell å­—ç¬¦ä¸²å¸¸è§æ“ä½œ"></a>Shell å­—ç¬¦ä¸²å¸¸è§æ“ä½œ</h3><p><strong>æ‹¼æ¥å­—ç¬¦ä¸²ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">name=&quot;SnailClimb&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨åŒå¼•å·æ‹¼æ¥</span></span><br><span class="line">greeting=&quot;hello, &quot;$name&quot; !&quot;</span><br><span class="line">greeting_1=&quot;hello, $&#123;name&#125; !&quot;</span><br><span class="line">echo $greeting  $greeting_1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨å•å¼•å·æ‹¼æ¥</span></span><br><span class="line">greeting_2=&#x27;hello, &#x27;$name&#x27; !&#x27;</span><br><span class="line">greeting_3=&#x27;hello, $&#123;name&#125; !&#x27;</span><br><span class="line">echo $greeting_2  $greeting_3</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-17/51148933.jpg" alt="è¾“å‡ºç»“æœ"></p><p><strong>è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">name=&quot;SnailClimb&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¬¬ä¸€ç§æ–¹å¼</span></span><br><span class="line">echo $&#123;#name&#125; #è¾“å‡º 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¬¬äºŒç§æ–¹å¼</span></span><br><span class="line">expr length &quot;$name&quot;;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">10</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ expr å‘½ä»¤æ—¶ï¼Œè¡¨è¾¾å¼ä¸­çš„è¿ç®—ç¬¦å·¦å³å¿…é¡»åŒ…å«ç©ºæ ¼ï¼Œå¦‚æœä¸åŒ…å«ç©ºæ ¼ï¼Œå°†ä¼šè¾“å‡ºè¡¨è¾¾å¼æœ¬èº«:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expr 5+6    // ç›´æ¥è¾“å‡º 5+6</span><br><span class="line">expr 5 + 6       // è¾“å‡º 11</span><br></pre></td></tr></table></figure><p>å¯¹äºæŸäº›è¿ç®—ç¬¦ï¼Œè¿˜éœ€è¦æˆ‘ä»¬ä½¿ç”¨ç¬¦å·<code>\</code>è¿›è¡Œè½¬ä¹‰ï¼Œå¦åˆ™å°±ä¼šæç¤ºè¯­æ³•é”™è¯¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expr 5 * 6       // è¾“å‡ºé”™è¯¯</span><br><span class="line">expr 5 \* 6      // è¾“å‡º30</span><br></pre></td></tr></table></figure><p><strong>æˆªå–å­å­—ç¬¦ä¸²:</strong></p><p>ç®€å•çš„å­—ç¬¦ä¸²æˆªå–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä»å­—ç¬¦ä¸²ç¬¬ 1 ä¸ªå­—ç¬¦å¼€å§‹å¾€åæˆªå– 10 ä¸ªå­—ç¬¦</span></span><br><span class="line">str=&quot;SnailClimb is a great man&quot;</span><br><span class="line">echo $&#123;str:0:10&#125; #è¾“å‡º:SnailClimb</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¡¨è¾¾å¼æˆªå–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">author:amau</span></span><br><span class="line"></span><br><span class="line">var=&quot;https://www.runoob.com/linux/linux-shell-variable.html&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">%è¡¨ç¤ºåˆ é™¤ä»ååŒ¹é…, æœ€çŸ­ç»“æœ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">%%è¡¨ç¤ºåˆ é™¤ä»ååŒ¹é…, æœ€é•¿åŒ¹é…ç»“æœ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment">#è¡¨ç¤ºåˆ é™¤ä»å¤´åŒ¹é…, æœ€çŸ­ç»“æœ</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment">##è¡¨ç¤ºåˆ é™¤ä»å¤´åŒ¹é…, æœ€é•¿åŒ¹é…ç»“æœ</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ³¨: *ä¸ºé€šé…ç¬¦, æ„ä¸ºåŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„å­—ç¬¦</span></span><br><span class="line">s1=$&#123;var%%t*&#125; #h</span><br><span class="line">s2=$&#123;var%t*&#125;  #https://www.runoob.com/linux/linux-shell-variable.h</span><br><span class="line">s3=$&#123;var%%.*&#125; #http://www</span><br><span class="line">s4=$&#123;var#*/&#125;  #/www.runoob.com/linux/linux-shell-variable.html</span><br><span class="line">s5=$&#123;var##*/&#125; #linux-shell-variable.html</span><br></pre></td></tr></table></figure><h3 id="Shell-æ•°ç»„"><a href="#Shell-æ•°ç»„" class="headerlink" title="Shell æ•°ç»„"></a>Shell æ•°ç»„</h3><p>bash æ”¯æŒä¸€ç»´æ•°ç»„ï¼ˆä¸æ”¯æŒå¤šç»´æ•°ç»„ï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰é™å®šæ•°ç»„çš„å¤§å°ã€‚æˆ‘ä¸‹é¢ç»™äº†å¤§å®¶ä¸€ä¸ªå…³äºæ•°ç»„æ“ä½œçš„ Shell ä»£ç ç¤ºä¾‹ï¼Œé€šè¿‡è¯¥ç¤ºä¾‹å¤§å®¶å¯ä»¥çŸ¥é“å¦‚ä½•åˆ›å»ºæ•°ç»„ã€è·å–æ•°ç»„é•¿åº¦ã€è·å–/åˆ é™¤ç‰¹å®šä½ç½®çš„æ•°ç»„å…ƒç´ ã€åˆ é™¤æ•´ä¸ªæ•°ç»„ä»¥åŠéå†æ•°ç»„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">array=(1 2 3 4 5);</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–æ•°ç»„é•¿åº¦</span></span><br><span class="line">length=$&#123;#array[@]&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">length2=$&#123;#array[*]&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¾“å‡ºæ•°ç»„é•¿åº¦</span></span><br><span class="line">echo $length #è¾“å‡ºï¼š5</span><br><span class="line">echo $length2 #è¾“å‡ºï¼š5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºæ•°ç»„ç¬¬ä¸‰ä¸ªå…ƒç´ </span></span><br><span class="line">echo $&#123;array[2]&#125; #è¾“å‡ºï¼š3</span><br><span class="line">unset array[1]# åˆ é™¤ä¸‹æ ‡ä¸º1çš„å…ƒç´ ä¹Ÿå°±æ˜¯åˆ é™¤ç¬¬äºŒä¸ªå…ƒç´ </span><br><span class="line">for i in $&#123;array[@]&#125;;do echo $i ;done # éå†æ•°ç»„ï¼Œè¾“å‡ºï¼š 1 3 4 5</span><br><span class="line">unset array; # åˆ é™¤æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ </span><br><span class="line">for i in $&#123;array[@]&#125;;do echo $i ;done # éå†æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡ºå†…å®¹</span><br></pre></td></tr></table></figure><h2 id="Shell-åŸºæœ¬è¿ç®—ç¬¦"><a href="#Shell-åŸºæœ¬è¿ç®—ç¬¦" class="headerlink" title="Shell åŸºæœ¬è¿ç®—ç¬¦"></a>Shell åŸºæœ¬è¿ç®—ç¬¦</h2><blockquote><p>è¯´æ˜ï¼šå›¾ç‰‡æ¥è‡ªã€Šèœé¸Ÿæ•™ç¨‹ã€‹</p></blockquote><p>Shell ç¼–ç¨‹æ”¯æŒä¸‹é¢å‡ ç§è¿ç®—ç¬¦</p><ul><li>ç®—æ•°è¿ç®—ç¬¦</li><li>å…³ç³»è¿ç®—ç¬¦</li><li>å¸ƒå°”è¿ç®—ç¬¦</li><li>å­—ç¬¦ä¸²è¿ç®—ç¬¦</li><li>æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦</li></ul><h3 id="ç®—æ•°è¿ç®—ç¬¦"><a href="#ç®—æ•°è¿ç®—ç¬¦" class="headerlink" title="ç®—æ•°è¿ç®—ç¬¦"></a>ç®—æ•°è¿ç®—ç¬¦</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/4937342.jpg" alt="ç®—æ•°è¿ç®—ç¬¦"></p><p>æˆ‘ä»¥åŠ æ³•è¿ç®—ç¬¦åšä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼ˆæ³¨æ„ï¼šä¸æ˜¯å•å¼•å·ï¼Œæ˜¯åå¼•å·ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">a=3;b=3;</span><br><span class="line">val=`expr $a + $b`</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¾“å‡ºï¼šTotal value : 6</span></span><br><span class="line">echo &quot;Total value : $val&quot;</span><br></pre></td></tr></table></figure><h3 id="å…³ç³»è¿ç®—ç¬¦"><a href="#å…³ç³»è¿ç®—ç¬¦" class="headerlink" title="å…³ç³»è¿ç®—ç¬¦"></a>å…³ç³»è¿ç®—ç¬¦</h3><p>å…³ç³»è¿ç®—ç¬¦åªæ”¯æŒæ•°å­—ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²ï¼Œé™¤éå­—ç¬¦ä¸²çš„å€¼æ˜¯æ•°å­—ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/64391380.jpg" alt="shellå…³ç³»è¿ç®—ç¬¦"></p><p>é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¼”ç¤ºå…³ç³»è¿ç®—ç¬¦çš„ä½¿ç”¨ï¼Œä¸‹é¢ shell ç¨‹åºçš„ä½œç”¨æ˜¯å½“ score=100 çš„æ—¶å€™è¾“å‡º A å¦åˆ™è¾“å‡º Bã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">score=90;</span><br><span class="line">maxscore=100;</span><br><span class="line">if [ $score -eq $maxscore ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;A&quot;</span><br><span class="line">else</span><br><span class="line">   echo &quot;B&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B</span><br></pre></td></tr></table></figure><h3 id="é€»è¾‘è¿ç®—ç¬¦"><a href="#é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/60545848.jpg" alt="é€»è¾‘è¿ç®—ç¬¦"></p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">a=$(( 1 &amp;&amp; 0))</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºï¼š0ï¼›é€»è¾‘ä¸è¿ç®—åªæœ‰ç›¸ä¸çš„ä¸¤è¾¹éƒ½æ˜¯1ï¼Œä¸çš„ç»“æœæ‰æ˜¯1ï¼›å¦åˆ™ä¸çš„ç»“æœæ˜¯0</span></span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure><h3 id="å¸ƒå°”è¿ç®—ç¬¦"><a href="#å¸ƒå°”è¿ç®—ç¬¦" class="headerlink" title="å¸ƒå°”è¿ç®—ç¬¦"></a>å¸ƒå°”è¿ç®—ç¬¦</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/93961425.jpg" alt="å¸ƒå°”è¿ç®—ç¬¦"></p><p>è¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†ï¼Œåº”è¯¥æŒºç®€å•çš„ã€‚</p><h3 id="å­—ç¬¦ä¸²è¿ç®—ç¬¦"><a href="#å­—ç¬¦ä¸²è¿ç®—ç¬¦" class="headerlink" title="å­—ç¬¦ä¸²è¿ç®—ç¬¦"></a>å­—ç¬¦ä¸²è¿ç®—ç¬¦</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/309094.jpg" alt=" å­—ç¬¦ä¸²è¿ç®—ç¬¦"></p><p>ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">a=&quot;abc&quot;;</span><br><span class="line">b=&quot;efg&quot;;</span><br><span class="line">if [ $a = $b ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;a ç­‰äº b&quot;</span><br><span class="line">else</span><br><span class="line">   echo &quot;a ä¸ç­‰äº b&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a ä¸ç­‰äº b</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ç›¸å…³è¿ç®—ç¬¦"><a href="#æ–‡ä»¶ç›¸å…³è¿ç®—ç¬¦" class="headerlink" title="æ–‡ä»¶ç›¸å…³è¿ç®—ç¬¦"></a>æ–‡ä»¶ç›¸å…³è¿ç®—ç¬¦</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/18-11-22/60359774.jpg" alt="æ–‡ä»¶ç›¸å…³è¿ç®—ç¬¦"></p><p>ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œæ¯”å¦‚æˆ‘ä»¬å®šä¹‰å¥½äº†ä¸€ä¸ªæ–‡ä»¶è·¯å¾„<code>file=&quot;/usr/learnshell/test.sh&quot;</code> å¦‚æœæˆ‘ä»¬æƒ³åˆ¤æ–­è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å¯è¯»ï¼Œå¯ä»¥è¿™æ ·<code>if [ -r $file ]</code> å¦‚æœæƒ³åˆ¤æ–­è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å¯å†™ï¼Œå¯ä»¥è¿™æ ·<code>-w $file</code>ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚</p><h2 id="shell-æµç¨‹æ§åˆ¶"><a href="#shell-æµç¨‹æ§åˆ¶" class="headerlink" title="shell æµç¨‹æ§åˆ¶"></a>shell æµç¨‹æ§åˆ¶</h2><h3 id="if-æ¡ä»¶è¯­å¥"><a href="#if-æ¡ä»¶è¯­å¥" class="headerlink" title="if æ¡ä»¶è¯­å¥"></a>if æ¡ä»¶è¯­å¥</h3><p>ç®€å•çš„ if else-if else çš„æ¡ä»¶è¯­å¥ç¤ºä¾‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">a=3;</span><br><span class="line">b=9;</span><br><span class="line">if [ $a -eq $b ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;a ç­‰äº b&quot;</span><br><span class="line">elif [ $a -gt $b ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;a å¤§äº b&quot;</span><br><span class="line">else</span><br><span class="line">   echo &quot;a å°äº b&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a å°äº b</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å¤§å®¶é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹å°±å·²ç»æŒæ¡äº† shell ç¼–ç¨‹ä¸­çš„ if æ¡ä»¶è¯­å¥ã€‚ä¸è¿‡ï¼Œè¿˜è¦æåˆ°çš„ä¸€ç‚¹æ˜¯ï¼Œä¸åŒäºæˆ‘ä»¬å¸¸è§çš„ Java ä»¥åŠ PHP ä¸­çš„ if æ¡ä»¶è¯­å¥ï¼Œshell if æ¡ä»¶è¯­å¥ä¸­ä¸èƒ½åŒ…å«ç©ºè¯­å¥ä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸åšçš„è¯­å¥ã€‚</p><h3 id="for-å¾ªç¯è¯­å¥"><a href="#for-å¾ªç¯è¯­å¥" class="headerlink" title="for å¾ªç¯è¯­å¥"></a>for å¾ªç¯è¯­å¥</h3><p>é€šè¿‡ä¸‹é¢ä¸‰ä¸ªç®€å•çš„ç¤ºä¾‹è®¤è¯† for å¾ªç¯è¯­å¥æœ€åŸºæœ¬çš„ä½¿ç”¨ï¼Œå®é™…ä¸Š for å¾ªç¯è¯­å¥çš„åŠŸèƒ½æ¯”ä¸‹é¢ä½ çœ‹åˆ°çš„ç¤ºä¾‹å±•ç°çš„è¦å¤§å¾—å¤šã€‚</p><p><strong>è¾“å‡ºå½“å‰åˆ—è¡¨ä¸­çš„æ•°æ®ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for loop in 1 2 3 4 5</span><br><span class="line">do</span><br><span class="line">    echo &quot;The value is: $loop&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><strong>äº§ç”Ÿ 10 ä¸ªéšæœºæ•°ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for i in &#123;0..9&#125;;</span><br><span class="line">do</span><br><span class="line">   echo $RANDOM;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡º 1 åˆ° 5:</strong></p><p>é€šå¸¸æƒ…å†µä¸‹ shell å˜é‡è°ƒç”¨éœ€è¦åŠ  $,ä½†æ˜¯ for çš„ (()) ä¸­ä¸éœ€è¦,ä¸‹é¢æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for((i=1;i&lt;=5;i++));do</span><br><span class="line">    echo $i;</span><br><span class="line">done;</span><br></pre></td></tr></table></figure><h3 id="while-è¯­å¥"><a href="#while-è¯­å¥" class="headerlink" title="while è¯­å¥"></a>while è¯­å¥</h3><p><strong>åŸºæœ¬çš„ while å¾ªç¯è¯­å¥ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">int=1</span><br><span class="line">while(( $int&lt;=5 ))</span><br><span class="line">do</span><br><span class="line">    echo $int</span><br><span class="line">    let &quot;int++&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><strong>while å¾ªç¯å¯ç”¨äºè¯»å–é”®ç›˜ä¿¡æ¯ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;æŒ‰ä¸‹ &lt;CTRL-D&gt; é€€å‡º&#x27;</span><br><span class="line">echo -n &#x27;è¾“å…¥ä½ æœ€å–œæ¬¢çš„ç”µå½±: &#x27;</span><br><span class="line">while read FILM</span><br><span class="line">do</span><br><span class="line">    echo &quot;æ˜¯çš„ï¼$FILM æ˜¯ä¸€ä¸ªå¥½ç”µå½±&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå†…å®¹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æŒ‰ä¸‹ &lt;CTRL-D&gt; é€€å‡º</span><br><span class="line">è¾“å…¥ä½ æœ€å–œæ¬¢çš„ç”µå½±: å˜å½¢é‡‘åˆš</span><br><span class="line">æ˜¯çš„ï¼å˜å½¢é‡‘åˆš æ˜¯ä¸€ä¸ªå¥½ç”µå½±</span><br></pre></td></tr></table></figure><p><strong>æ— é™å¾ªç¯ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    command</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="shell-å‡½æ•°"><a href="#shell-å‡½æ•°" class="headerlink" title="shell å‡½æ•°"></a>shell å‡½æ•°</h2><h3 id="ä¸å¸¦å‚æ•°æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°"><a href="#ä¸å¸¦å‚æ•°æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°" class="headerlink" title="ä¸å¸¦å‚æ•°æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°"></a>ä¸å¸¦å‚æ•°æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">hello()&#123;</span><br><span class="line">    echo &quot;è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ª shell å‡½æ•°!&quot;</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;-----å‡½æ•°å¼€å§‹æ‰§è¡Œ-----&quot;</span><br><span class="line">hello</span><br><span class="line">echo &quot;-----å‡½æ•°æ‰§è¡Œå®Œæ¯•-----&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-----å‡½æ•°å¼€å§‹æ‰§è¡Œ-----</span><br><span class="line">è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ª shell å‡½æ•°!</span><br><span class="line">-----å‡½æ•°æ‰§è¡Œå®Œæ¯•-----</span><br></pre></td></tr></table></figure><h3 id="æœ‰è¿”å›å€¼çš„å‡½æ•°"><a href="#æœ‰è¿”å›å€¼çš„å‡½æ•°" class="headerlink" title="æœ‰è¿”å›å€¼çš„å‡½æ•°"></a>æœ‰è¿”å›å€¼çš„å‡½æ•°</h3><p><strong>è¾“å…¥ä¸¤ä¸ªæ•°å­—ä¹‹åç›¸åŠ å¹¶è¿”å›ç»“æœï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">funWithReturn()&#123;</span><br><span class="line">    echo &quot;è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—: &quot;</span><br><span class="line">    read aNum</span><br><span class="line">    echo &quot;è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—: &quot;</span><br><span class="line">    read anotherNum</span><br><span class="line">    echo &quot;ä¸¤ä¸ªæ•°å­—åˆ†åˆ«ä¸º $aNum å’Œ $anotherNum !&quot;</span><br><span class="line">    return $(($aNum+$anotherNum))</span><br><span class="line">&#125;</span><br><span class="line">funWithReturn</span><br><span class="line">echo &quot;è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—ä¹‹å’Œä¸º $?&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—:</span><br><span class="line">1</span><br><span class="line">è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—:</span><br><span class="line">2</span><br><span class="line">ä¸¤ä¸ªæ•°å­—åˆ†åˆ«ä¸º 1 å’Œ 2 !</span><br><span class="line">è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—ä¹‹å’Œä¸º 3</span><br></pre></td></tr></table></figure><h3 id="å¸¦å‚æ•°çš„å‡½æ•°"><a href="#å¸¦å‚æ•°çš„å‡½æ•°" class="headerlink" title="å¸¦å‚æ•°çš„å‡½æ•°"></a>å¸¦å‚æ•°çš„å‡½æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">funWithParam()&#123;</span><br><span class="line">    echo &quot;ç¬¬ä¸€ä¸ªå‚æ•°ä¸º $1 !&quot;</span><br><span class="line">    echo &quot;ç¬¬äºŒä¸ªå‚æ•°ä¸º $2 !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º $10 !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º $&#123;10&#125; !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸€ä¸ªå‚æ•°ä¸º $&#123;11&#125; !&quot;</span><br><span class="line">    echo &quot;å‚æ•°æ€»æ•°æœ‰ $# ä¸ª!&quot;</span><br><span class="line">    echo &quot;ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° $* !&quot;</span><br><span class="line">&#125;</span><br><span class="line">funWithParam 1 2 3 4 5 6 7 8 9 34 73</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 1 !</span><br><span class="line">ç¬¬äºŒä¸ªå‚æ•°ä¸º 2 !</span><br><span class="line">ç¬¬åä¸ªå‚æ•°ä¸º 10 !</span><br><span class="line">ç¬¬åä¸ªå‚æ•°ä¸º 34 !</span><br><span class="line">ç¬¬åä¸€ä¸ªå‚æ•°ä¸º 73 !</span><br><span class="line">å‚æ•°æ€»æ•°æœ‰ 11 ä¸ª!</span><br><span class="line">ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° 1 2 3 4 5 6 7 8 9 34 73 !</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å¯¹shellç¼–ç¨‹çš„å­¦ä¹ </summary>
    
    
    
    <category term="shell" scheme="https://www.jodio.cc/categories/shell/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="shell" scheme="https://www.jodio.cc/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>InterView(å››) -- å¾®æœåŠ¡ç¯‡</title>
    <link href="https://www.jodio.cc/posts/spring.html"/>
    <id>https://www.jodio.cc/posts/spring.html</id>
    <published>2023-04-18T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¾®æœåŠ¡é¢è¯•é¢˜"><a href="#å¾®æœåŠ¡é¢è¯•é¢˜" class="headerlink" title="å¾®æœåŠ¡é¢è¯•é¢˜"></a>å¾®æœåŠ¡é¢è¯•é¢˜</h2><h3 id="é¢è¯•å®˜ï¼šSpring-Cloud-5å¤§ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šSpring-Cloud-5å¤§ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šSpring Cloud 5å¤§ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>Spring Cloud 5å¤§ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æ—©æœŸæˆ‘ä»¬ä¸€èˆ¬è®¤ä¸ºçš„Spring Cloudäº”å¤§ç»„ä»¶æ˜¯ </p><ul><li>Eureka   : æ³¨å†Œä¸­å¿ƒ</li><li>Ribbon  : è´Ÿè½½å‡è¡¡</li><li>Feign     : è¿œç¨‹è°ƒç”¨</li><li>Hystrix :  æœåŠ¡ç†”æ–­</li><li>Zuul/Gateway  : ç½‘å…³</li></ul><p>éšç€SpringCloudAlibbaåœ¨å›½å†…å…´èµ· , æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†ä¸€äº›é˜¿é‡Œå·´å·´çš„ç»„ä»¶ </p><ul><li>æ³¨å†Œä¸­å¿ƒ/é…ç½®ä¸­å¿ƒ Nacos</li><li>è´Ÿè½½å‡è¡¡ Ribbon</li><li>æœåŠ¡è°ƒç”¨ Feign</li><li>æœåŠ¡ä¿æŠ¤ sentinel</li><li>æœåŠ¡ç½‘å…³ Gateway</li></ul><blockquote><h3 id="é¢è¯•å®˜ï¼šæœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸSpring-Cloud-å¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œå‘ç°ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šæœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸSpring-Cloud-å¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œå‘ç°ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šæœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸSpring Cloud å¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œå‘ç°ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸSpring Cloud å¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œå‘ç°ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘ç†è§£çš„æ˜¯ä¸»è¦ä¸‰å—å¤§åŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯æœåŠ¡æ³¨å†Œ ã€æœåŠ¡å‘ç°ã€æœåŠ¡çŠ¶æ€ç›‘æ§</p><p>æˆ‘ä»¬å½“æ—¶é¡¹ç›®é‡‡ç”¨çš„eurekaä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè¿™ä¸ªä¹Ÿæ˜¯spring cloudä½“ç³»ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶</p><p><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼šæœåŠ¡æä¾›è€…éœ€è¦æŠŠè‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ°eurekaï¼Œç”±eurekaæ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æœåŠ¡åç§°ã€ipã€ç«¯å£ç­‰ç­‰</p><p><strong>æœåŠ¡å‘ç°</strong>ï¼šæ¶ˆè´¹è€…å‘eurekaæ‹‰å–æœåŠ¡åˆ—è¡¨ä¿¡æ¯ï¼Œå¦‚æœæœåŠ¡æä¾›è€…æœ‰é›†ç¾¤ï¼Œåˆ™æ¶ˆè´¹è€…ä¼šåˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‰æ‹©ä¸€ä¸ªå‘èµ·è°ƒç”¨</p><p><strong>æœåŠ¡ç›‘æ§</strong>ï¼šæœåŠ¡æä¾›è€…ä¼šæ¯éš”30ç§’å‘eurekaå‘é€å¿ƒè·³ï¼ŒæŠ¥å‘Šå¥åº·çŠ¶æ€ï¼Œå¦‚æœeurekaæœåŠ¡90ç§’æ²¡æ¥æ”¶åˆ°å¿ƒè·³ï¼Œä»eurekaä¸­å‰”é™¤</p><h3 id="é¢è¯•å®˜ï¼šæˆ‘çœ‹ä½ ä¹‹å‰ä¹Ÿç”¨è¿‡nacosã€ä½ èƒ½è¯´ä¸‹nacosä¸eurekaçš„åŒºåˆ«ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šæˆ‘çœ‹ä½ ä¹‹å‰ä¹Ÿç”¨è¿‡nacosã€ä½ èƒ½è¯´ä¸‹nacosä¸eurekaçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šæˆ‘çœ‹ä½ ä¹‹å‰ä¹Ÿç”¨è¿‡nacosã€ä½ èƒ½è¯´ä¸‹nacosä¸eurekaçš„åŒºåˆ«ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>æˆ‘çœ‹ä½ ä¹‹å‰ä¹Ÿç”¨è¿‡nacosã€ä½ èƒ½è¯´ä¸‹nacosä¸eurekaçš„åŒºåˆ«ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘ä»¬å½“æ—¶xxé¡¹ç›®å°±æ˜¯é‡‡ç”¨çš„nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé€‰æ‹©nacosè¿˜è¦ä¸€ä¸ªé‡è¦åŸå› å°±æ˜¯å®ƒæ”¯æŒé…ç½®ä¸­å¿ƒï¼Œä¸è¿‡nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿæ¯”eurekaè¦æ–¹ä¾¿å¥½ç”¨ä¸€äº›ï¼Œä¸»è¦ç›¸åŒä¸åŒç‚¹åœ¨äºå‡ ç‚¹ï¼š</p><ul><li>å…±åŒç‚¹</li></ul><p>Nacosä¸eurekaéƒ½æ”¯æŒæœåŠ¡æ³¨å†Œå’ŒæœåŠ¡æ‹‰å–ï¼Œéƒ½æ”¯æŒæœåŠ¡æä¾›è€…å¿ƒè·³æ–¹å¼åšå¥åº·æ£€æµ‹</p><ul><li>Nacosä¸Eurekaçš„åŒºåˆ«</li></ul><p>â‘ Nacosæ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨æ£€æµ‹æä¾›è€…çŠ¶æ€ï¼šä¸´æ—¶å®ä¾‹é‡‡ç”¨å¿ƒè·³æ¨¡å¼ï¼Œéä¸´æ—¶å®ä¾‹é‡‡ç”¨ä¸»åŠ¨æ£€æµ‹æ¨¡å¼</p><p>â‘¡ä¸´æ—¶å®ä¾‹å¿ƒè·³ä¸æ­£å¸¸ä¼šè¢«å‰”é™¤ï¼Œéä¸´æ—¶å®ä¾‹åˆ™ä¸ä¼šè¢«å‰”é™¤</p><p>â‘¢Nacosæ”¯æŒæœåŠ¡åˆ—è¡¨å˜æ›´çš„æ¶ˆæ¯æ¨é€æ¨¡å¼ï¼ŒæœåŠ¡åˆ—è¡¨æ›´æ–°æ›´åŠæ—¶</p><p>â‘£Nacosé›†ç¾¤é»˜è®¤é‡‡ç”¨APæ–¹å¼ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œé‡‡ç”¨CPæ¨¡å¼ï¼›Eurekaé‡‡ç”¨APæ–¹å¼</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„ ?"></a><strong>é¢è¯•å®˜ï¼š</strong>ä½ ä»¬é¡¹ç›®è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„ ?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æ˜¯è¿™æ ·~~</p><p>åœ¨æœåŠ¡è°ƒç”¨è¿‡ç¨‹ä¸­çš„è´Ÿè½½å‡è¡¡ä¸€èˆ¬ä½¿ç”¨SpringCloudçš„Ribbon ç»„ä»¶å®ç°  , Feignçš„åº•å±‚å·²ç»è‡ªåŠ¨é›†æˆäº†Ribbon  , ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•</p><p>å½“å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶ï¼Œribbonå…ˆä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„è·¯ç”±ç­–ç•¥é€‰æ‹©ä¸€ä¸ªå‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œä¸€èˆ¬çš„è°ƒç”¨ç­–ç•¥æ˜¯è½®è¯¢</p><h3 id="é¢è¯•å®˜ï¼šRibbonè´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰å“ªäº›"><a href="#é¢è¯•å®˜ï¼šRibbonè´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰å“ªäº›" class="headerlink" title="é¢è¯•å®˜ï¼šRibbonè´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰å“ªäº› ?"></a><strong>é¢è¯•å®˜ï¼š</strong>Ribbonè´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰å“ªäº› ?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘æƒ³æƒ³å•Šï¼Œæœ‰å¾ˆå¤šç§ï¼Œæˆ‘è®°å¾—å‡ ä¸ªï¼š</p><ul><li><p>RoundRobinRuleï¼šç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨</p></li><li><p>WeightedResponseTimeRuleï¼šæŒ‰ç…§æƒé‡æ¥é€‰æ‹©æœåŠ¡å™¨ï¼Œå“åº”æ—¶é—´è¶Šé•¿ï¼Œæƒé‡è¶Šå°</p></li><li><p>RandomRuleï¼šéšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨</p></li><li><p>ZoneAvoidanceRuleï¼šåŒºåŸŸæ•æ„Ÿç­–ç•¥ï¼Œä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢(é»˜è®¤)</p></li></ul><h3 id="é¢è¯•å®˜ï¼šå¦‚æœæƒ³è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä½•å®ç°"><a href="#é¢è¯•å®˜ï¼šå¦‚æœæƒ³è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä½•å®ç°" class="headerlink" title="é¢è¯•å®˜ï¼šå¦‚æœæƒ³è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä½•å®ç° ?"></a><strong>é¢è¯•å®˜ï¼š</strong>å¦‚æœæƒ³è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä½•å®ç° ?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æä¾›äº†ä¸¤ç§æ–¹å¼ï¼š</p><p>1ï¼Œåˆ›å»ºç±»å®ç°IRuleæ¥å£ï¼Œå¯ä»¥æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè¿™ä¸ªæ˜¯å…¨å±€çš„ï¼Œå¯¹æ‰€æœ‰çš„è¿œç¨‹è°ƒç”¨éƒ½èµ·ä½œç”¨</p><p>2ï¼Œåœ¨å®¢æˆ·ç«¯çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é…ç½®æŸä¸€ä¸ªæœåŠ¡è°ƒç”¨çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œåªæ˜¯å¯¹é…ç½®çš„è¿™ä¸ªæœåŠ¡ç”Ÿæ•ˆè¿œç¨‹è°ƒç”¨</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯æœåŠ¡é›ªå´©ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯æœåŠ¡é›ªå´©ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯æœåŠ¡é›ªå´©ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>ä»€ä¹ˆæ˜¯æœåŠ¡é›ªå´©ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æœåŠ¡é›ªå´©æ˜¯æŒ‡ä¸€ä¸ªæœåŠ¡å¤±è´¥ï¼Œå¯¼è‡´æ•´æ¡é“¾è·¯çš„æœåŠ¡éƒ½å¤±è´¥çš„æƒ…å½¢ï¼Œä¸€èˆ¬æˆ‘ä»¬åœ¨é¡¹ç›®è§£å†³çš„è¯å°±æ˜¯ä¸¤ç§æ–¹æ¡ˆï¼Œç¬¬ä¸€ä¸ªæ˜¯æœåŠ¡é™çº§ï¼Œç¬¬äºŒä¸ªæ˜¯æœåŠ¡ç†”æ–­ï¼Œå¦‚æœæµé‡å¤ªå¤§çš„è¯ï¼Œå¯ä»¥è€ƒè™‘é™æµ</p><p>æœåŠ¡é™çº§ï¼šæœåŠ¡è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ï¼Œæˆ–è€…ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºç¡®ä¿æœåŠ¡ä¸ä¼šå—è¯·æ±‚çªå¢å½±å“å˜å¾—ä¸å¯ç”¨ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå´©æºƒï¼Œä¸€èˆ¬åœ¨å®é™…å¼€å‘ä¸­ä¸feignæ¥å£æ•´åˆï¼Œç¼–å†™é™çº§é€»è¾‘</p><p>æœåŠ¡ç†”æ–­ï¼šé»˜è®¤å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨æ‰“å¼€ï¼Œå¦‚æœæ£€æµ‹åˆ° 10 ç§’å†…è¯·æ±‚çš„å¤±è´¥ç‡è¶…è¿‡ 50%ï¼Œå°±è§¦å‘ç†”æ–­æœºåˆ¶ã€‚ä¹‹åæ¯éš” 5 ç§’é‡æ–°å°è¯•è¯·æ±‚å¾®æœåŠ¡ï¼Œå¦‚æœå¾®æœåŠ¡ä¸èƒ½å“åº”ï¼Œç»§ç»­èµ°ç†”æ–­æœºåˆ¶ã€‚å¦‚æœå¾®æœåŠ¡å¯è¾¾ï¼Œåˆ™å…³é—­ç†”æ–­æœºåˆ¶ï¼Œæ¢å¤æ­£å¸¸è¯·æ±‚</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬çš„å¾®æœåŠ¡æ˜¯æ€ä¹ˆç›‘æ§çš„ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬çš„å¾®æœåŠ¡æ˜¯æ€ä¹ˆç›‘æ§çš„ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬çš„å¾®æœåŠ¡æ˜¯æ€ä¹ˆç›‘æ§çš„ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>ä½ ä»¬çš„å¾®æœåŠ¡æ˜¯æ€ä¹ˆç›‘æ§çš„ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘ä»¬é¡¹ç›®ä¸­é‡‡ç”¨çš„skywalkingè¿›è¡Œç›‘æ§çš„</p><p>1ï¼Œskywalkingä¸»è¦å¯ä»¥ç›‘æ§æ¥å£ã€æœåŠ¡ã€ç‰©ç†å®ä¾‹çš„ä¸€äº›çŠ¶æ€ã€‚ç‰¹åˆ«æ˜¯åœ¨å‹æµ‹çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ä¼—å¤šæœåŠ¡ä¸­å“ªäº›æœåŠ¡å’Œæ¥å£æ¯”è¾ƒæ…¢ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ€§çš„åˆ†æå’Œä¼˜åŒ–ã€‚</p><p>2ï¼Œæˆ‘ä»¬è¿˜åœ¨skywalkingè®¾ç½®äº†å‘Šè­¦è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯åœ¨é¡¹ç›®ä¸Šçº¿ä»¥åï¼Œå¦‚æœæŠ¥é”™ï¼Œæˆ‘ä»¬åˆ†åˆ«è®¾ç½®äº†å¯ä»¥ç»™ç›¸å…³è´Ÿè´£äººå‘çŸ­ä¿¡å’Œå‘é‚®ä»¶ï¼Œç¬¬ä¸€æ—¶é—´çŸ¥é“é¡¹ç›®çš„bugæƒ…å†µï¼Œç¬¬ä¸€æ—¶é—´ä¿®å¤</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰åšè¿‡é™æµ-æ€ä¹ˆåšçš„"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰åšè¿‡é™æµ-æ€ä¹ˆåšçš„" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰åšè¿‡é™æµ ? æ€ä¹ˆåšçš„ ?"></a><strong>é¢è¯•å®˜ï¼š</strong>ä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰åšè¿‡é™æµ ? æ€ä¹ˆåšçš„ ?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘å½“æ—¶åšçš„xxé¡¹ç›®ï¼Œé‡‡ç”¨å°±æ˜¯å¾®æœåŠ¡çš„æ¶æ„ï¼Œå› ä¸ºxxå› ä¸ºï¼Œåº”è¯¥ä¼šæœ‰çªå‘æµé‡ï¼Œæœ€å¤§QPSå¯ä»¥è¾¾åˆ°2000ï¼Œä½†æ˜¯æœåŠ¡æ”¯æ’‘ä¸ä½ï¼Œæˆ‘ä»¬é¡¹ç›®éƒ½é€šè¿‡å‹æµ‹æœ€å¤šå¯ä»¥æ”¯æ’‘1200QPSã€‚å› ä¸ºæˆ‘ä»¬å¹³æ—¶çš„QPSä¹Ÿå°±ä¸åˆ°100ï¼Œä¸ºäº†è§£å†³è¿™äº›çªå‘æµé‡ï¼Œæ‰€ä»¥é‡‡ç”¨äº†é™æµã€‚</p><p>ã€ç‰ˆæœ¬1ã€‘</p><p>æˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„nginxé™æµæ“ä½œï¼Œnginxä½¿ç”¨çš„æ¼æ¡¶ç®—æ³•æ¥å®ç°è¿‡æ»¤ï¼Œè®©è¯·æ±‚ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå¯ä»¥åº”å¯¹çªå‘æµé‡ï¼Œæˆ‘ä»¬æ§åˆ¶çš„é€Ÿç‡æ˜¯æŒ‰ç…§ipè¿›è¡Œé™æµï¼Œé™åˆ¶çš„æµé‡æ˜¯æ¯ç§’20</p><p>ã€ç‰ˆæœ¬2ã€‘</p><p>æˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„æ˜¯spring cloud gatewayä¸­æ”¯æŒå±€éƒ¨è¿‡æ»¤å™¨RequestRateLimiteræ¥åšé™æµï¼Œä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå¯ä»¥æ ¹æ®ipæˆ–è·¯å¾„è¿›è¡Œé™æµï¼Œå¯ä»¥è®¾ç½®æ¯ç§’å¡«å……å¹³å‡é€Ÿç‡ï¼Œå’Œä»¤ç‰Œæ¡¶æ€»å®¹é‡</p><h3 id="é¢è¯•å®˜ï¼šé™æµå¸¸è§çš„ç®—æ³•æœ‰å“ªäº›å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé™æµå¸¸è§çš„ç®—æ³•æœ‰å“ªäº›å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé™æµå¸¸è§çš„ç®—æ³•æœ‰å“ªäº›å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>é™æµå¸¸è§çš„ç®—æ³•æœ‰å“ªäº›å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æ¯”è¾ƒå¸¸è§çš„é™æµç®—æ³•æœ‰æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•</p><p>æ¼æ¡¶ç®—æ³•æ˜¯æŠŠè¯·æ±‚å­˜å…¥åˆ°æ¡¶ä¸­ï¼Œä»¥å›ºå®šé€Ÿç‡ä»æ¡¶ä¸­æµå‡ºï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æœåŠ¡åšåˆ°ç»å¯¹çš„å¹³å‡ï¼Œèµ·åˆ°å¾ˆå¥½çš„é™æµæ•ˆæœ</p><p>ä»¤ç‰Œæ¡¶ç®—æ³•åœ¨æ¡¶ä¸­å­˜å‚¨çš„æ˜¯ä»¤ç‰Œï¼ŒæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œæ¯ä¸ªè¯·æ±‚éƒ½è¦å…ˆç”³è¯·ä»¤ç‰Œï¼Œç”³è¯·åˆ°ä»¤ç‰Œä»¥åæ‰èƒ½æ­£å¸¸è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥èµ·åˆ°å¾ˆå¥½çš„é™æµä½œç”¨</p><p>å®ƒä»¬çš„åŒºåˆ«æ˜¯ï¼Œæ¼æ¡¶å’Œä»¤ç‰Œæ¡¶éƒ½å¯ä»¥å¤„ç†çªå‘æµé‡ï¼Œå…¶ä¸­æ¼æ¡¶å¯ä»¥åšåˆ°ç»å¯¹çš„å¹³æ»‘ï¼Œä»¤ç‰Œæ¡¶æœ‰å¯èƒ½ä¼šäº§ç”Ÿçªå‘å¤§é‡è¯·æ±‚çš„æƒ…å†µï¼Œä¸€èˆ¬nginxé™æµé‡‡ç”¨çš„æ¼æ¡¶ï¼Œspring cloud gatewayä¸­å¯ä»¥æ”¯æŒä»¤ç‰Œæ¡¶ç®—æ³•</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯CAPç†è®ºï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯CAPç†è®ºï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯CAPç†è®ºï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šä»€ä¹ˆæ˜¯CAPç†è®ºï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>CAPä¸»è¦æ˜¯åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸‹çš„ä¸€ä¸ªç†è®ºã€‚åŒ…å«äº†ä¸‰é¡¹ï¼Œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§</p><ul><li><p>ä¸€è‡´æ€§(Consistency)æ˜¯æŒ‡æ›´æ–°æ“ä½œæˆåŠŸå¹¶è¿”å›å®¢æˆ·ç«¯å®Œæˆåï¼Œæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çš„æ•°æ®å®Œå…¨ä¸€è‡´(å¼ºä¸€è‡´æ€§)ï¼Œä¸èƒ½å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚</p></li><li><p>å¯ç”¨æ€§(Availability) æ˜¯æŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœã€‚</p></li><li><p>åˆ†åŒºå®¹é”™æ€§(Partition tolerance) æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ï¼Œä»ç„¶éœ€è¦èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ï¼Œé™¤éæ˜¯æ•´ä¸ªç½‘ç»œç¯å¢ƒéƒ½å‘ç”Ÿäº†æ•…éšœã€‚</p></li></ul><h3 id="é¢è¯•å®˜ï¼šä¸ºä»€ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•åŒæ—¶ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä¸ºä»€ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•åŒæ—¶ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä¸ºä»€ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•åŒæ—¶ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šä¸ºä»€ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•åŒæ—¶ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œæ˜¯è¿™æ ·çš„~~</p><p>é¦–å…ˆä¸€ä¸ªå‰æï¼Œå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå› æ­¤åŸºæœ¬ä¸Šæˆ‘ä»¬åœ¨è®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶å€™åªèƒ½ä»ä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰ä¹‹é—´è¿›è¡Œå–èˆã€‚</p><p>å¦‚æœä¿è¯äº†ä¸€è‡´æ€§ï¼ˆCï¼‰ï¼šå¯¹äºèŠ‚ç‚¹N1å’ŒN2ï¼Œå½“å¾€N1é‡Œå†™æ•°æ®æ—¶ï¼ŒN2ä¸Šçš„æ“ä½œå¿…é¡»è¢«æš‚åœï¼Œåªæœ‰å½“N1åŒæ­¥æ•°æ®åˆ°N2æ—¶æ‰èƒ½å¯¹N2è¿›è¡Œè¯»å†™è¯·æ±‚ï¼Œåœ¨N2è¢«æš‚åœæ“ä½œæœŸé—´å®¢æˆ·ç«¯æäº¤çš„è¯·æ±‚ä¼šæ”¶åˆ°å¤±è´¥æˆ–è¶…æ—¶ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸å¯ç”¨æ€§æ˜¯ç›¸æ‚–çš„ã€‚</p><p>å¦‚æœä¿è¯äº†å¯ç”¨æ€§ï¼ˆAï¼‰ï¼šé‚£å°±ä¸èƒ½æš‚åœN2çš„è¯»å†™æ“ä½œï¼Œä½†åŒæ—¶N1åœ¨å†™æ•°æ®çš„è¯ï¼Œè¿™å°±è¿èƒŒäº†ä¸€è‡´æ€§çš„è¦æ±‚ã€‚</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯BASEç†è®ºï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯BASEç†è®ºï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯BASEç†è®ºï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šä»€ä¹ˆæ˜¯BASEç†è®ºï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªä¹Ÿæ˜¯CAPåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ç†è®º</p><p>BASEæ˜¯CAPç†è®ºä¸­APæ–¹æ¡ˆçš„å»¶ä¼¸ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrongConsistencyï¼ŒCAPçš„ä¸€è‡´æ€§å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰ï¼Œä½†åº”ç”¨å¯ä»¥é‡‡ç”¨é€‚åˆçš„æ–¹å¼è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consitencyï¼‰ã€‚å®ƒçš„æ€æƒ³åŒ…å«ä¸‰æ–¹é¢ï¼š</p><p>1ã€Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ï¼šåŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥çš„æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œä½†ä¸ç­‰äºç³»ç»Ÿä¸å¯ç”¨ã€‚</p><p>2ã€Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰ï¼šå³æ˜¯æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</p><p>3ã€Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ï¼šå¼ºè°ƒç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å…¶æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬é‡‡ç”¨å“ªç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬é‡‡ç”¨å“ªç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬é‡‡ç”¨å“ªç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>ä½ ä»¬é‡‡ç”¨å“ªç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘ä»¬å½“æ—¶æ˜¯xxé¡¹ç›®ï¼Œä¸»è¦ä½¿ç”¨åˆ°çš„seataçš„atæ¨¡å¼è§£å†³çš„åˆ†å¸ƒå¼äº‹åŠ¡</p><p>seataçš„ATæ¨¡å‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><p>1ã€é˜¶æ®µä¸€RMçš„å·¥ä½œï¼šâ‘  æ³¨å†Œåˆ†æ”¯äº‹åŠ¡  â‘¡ è®°å½•undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰â‘¢ æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤ â‘£æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€</p><p>2ã€é˜¶æ®µäºŒæäº¤æ—¶RMçš„å·¥ä½œï¼šåˆ é™¤undo-logå³å¯</p><p>3ã€é˜¶æ®µäºŒå›æ»šæ—¶RMçš„å·¥ä½œï¼šæ ¹æ®undo-logæ¢å¤æ•°æ®åˆ°æ›´æ–°å‰</p><p>atæ¨¡å¼ç‰ºç‰²äº†ä¸€è‡´æ€§ï¼Œä¿è¯äº†å¯ç”¨æ€§ï¼Œä¸è¿‡ï¼Œå®ƒä¿è¯çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§</p><h3 id="é¢è¯•å®˜ï¼šåˆ†å¸ƒå¼æœåŠ¡çš„æ¥å£å¹‚ç­‰æ€§å¦‚ä½•è®¾è®¡ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šåˆ†å¸ƒå¼æœåŠ¡çš„æ¥å£å¹‚ç­‰æ€§å¦‚ä½•è®¾è®¡ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šåˆ†å¸ƒå¼æœåŠ¡çš„æ¥å£å¹‚ç­‰æ€§å¦‚ä½•è®¾è®¡ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>åˆ†å¸ƒå¼æœåŠ¡çš„æ¥å£å¹‚ç­‰æ€§å¦‚ä½•è®¾è®¡ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>å—¯ï¼Œæˆ‘ä»¬å½“æ—¶æœ‰ä¸€ä¸ªxxé¡¹ç›®çš„ä¸‹å•æ“ä½œï¼Œé‡‡ç”¨çš„token+rediså®ç°çš„ï¼Œæµç¨‹æ˜¯è¿™æ ·çš„</p><p>ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ‰“å¼€äº†å•†å“è¯¦æƒ…é¡µé¢ï¼Œæˆ‘ä»¬ä¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨åå°ç”Ÿæˆä¸€ä¸ªå”¯ä¸€tokenå­˜å…¥redisï¼Œkeyå°±æ˜¯ç”¨æˆ·çš„idï¼Œvalueå°±æ˜¯è¿™ä¸ªtokenï¼ŒåŒæ—¶æŠŠè¿™ä¸ªtokenè¿”å›å‰ç«¯</p><p>ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œå½“ç”¨æˆ·ç‚¹å‡»äº†ä¸‹å•æ“ä½œä¼šåï¼Œä¼šæºå¸¦ä¹‹å‰çš„tokenï¼Œåå°å…ˆåˆ°redisè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå­˜åœ¨tokenï¼Œå¯ä»¥æ‰§è¡Œä¸šåŠ¡ï¼ŒåŒæ—¶åˆ é™¤tokenï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸å¤„ç†ä¸šåŠ¡ï¼Œå°±ä¿è¯äº†åŒä¸€ä¸ªtokenåªå¤„ç†ä¸€æ¬¡ä¸šåŠ¡ï¼Œå°±ä¿è¯äº†å¹‚ç­‰æ€§</p><h3 id="é¢è¯•å®˜ï¼šxxl-jobè·¯ç”±ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šxxl-jobè·¯ç”±ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šxxl-jobè·¯ç”±ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>xxl-jobè·¯ç”±ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>xxl-jobæä¾›äº†å¾ˆå¤šçš„è·¯ç”±ç­–ç•¥ï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„è¾ƒå¤šå°±æ˜¯ï¼šè½®è¯¢ã€æ•…éšœè½¬ç§»ã€åˆ†ç‰‡å¹¿æ’­â€¦</p><h3 id="é¢è¯•å®˜ï¼šxxl-jobä»»åŠ¡æ‰§è¡Œå¤±è´¥æ€ä¹ˆè§£å†³ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šxxl-jobä»»åŠ¡æ‰§è¡Œå¤±è´¥æ€ä¹ˆè§£å†³ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šxxl-jobä»»åŠ¡æ‰§è¡Œå¤±è´¥æ€ä¹ˆè§£å†³ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>xxl-jobä»»åŠ¡æ‰§è¡Œå¤±è´¥æ€ä¹ˆè§£å†³ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æœ‰è¿™ä¹ˆå‡ ä¸ªæ“ä½œ</p><p>ç¬¬ä¸€ï¼šè·¯ç”±ç­–ç•¥é€‰æ‹©æ•…éšœè½¬ç§»ï¼Œä¼˜å…ˆä½¿ç”¨å¥åº·çš„å®ä¾‹æ¥æ‰§è¡Œä»»åŠ¡</p><p>ç¬¬äºŒï¼Œå¦‚æœè¿˜æœ‰å¤±è´¥çš„ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºä»»åŠ¡æ—¶ï¼Œå¯ä»¥è®¾ç½®é‡è¯•æ¬¡æ•°</p><p>ç¬¬ä¸‰ï¼Œå¦‚æœè¿˜æœ‰å¤±è´¥çš„ï¼Œå°±å¯ä»¥æŸ¥çœ‹æ—¥å¿—æˆ–è€…é…ç½®é‚®ä»¶å‘Šè­¦æ¥é€šçŸ¥ç›¸å…³è´Ÿè´£äººè§£å†³</p><h3 id="é¢è¯•å®˜ï¼šå¦‚æœæœ‰å¤§æ•°æ®é‡çš„ä»»åŠ¡åŒæ—¶éƒ½éœ€è¦æ‰§è¡Œï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¦‚æœæœ‰å¤§æ•°æ®é‡çš„ä»»åŠ¡åŒæ—¶éƒ½éœ€è¦æ‰§è¡Œï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¦‚æœæœ‰å¤§æ•°æ®é‡çš„ä»»åŠ¡åŒæ—¶éƒ½éœ€è¦æ‰§è¡Œï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>å¦‚æœæœ‰å¤§æ•°æ®é‡çš„ä»»åŠ¡åŒæ—¶éƒ½éœ€è¦æ‰§è¡Œï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>æˆ‘ä»¬ä¼šè®©éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œå…±åŒå»æ‰§è¡Œè¿™äº›æ‰¹é‡çš„ä»»åŠ¡ï¼Œå…¶ä¸­ä»»åŠ¡çš„è·¯ç”±ç­–ç•¥æ˜¯åˆ†ç‰‡å¹¿æ’­</p><p>åœ¨ä»»åŠ¡æ‰§è¡Œçš„ä»£ç ä¸­å¯ä»¥è·å–åˆ†ç‰‡æ€»æ•°å’Œå½“å‰åˆ†ç‰‡ï¼ŒæŒ‰ç…§å–æ¨¡çš„æ–¹å¼åˆ†æ‘Šåˆ°å„ä¸ªå®ä¾‹æ‰§è¡Œå°±å¯ä»¥äº†</p></blockquote>]]></content>
    
    
    <summary type="html">å¾®æœåŠ¡ç›¸å…³é¢è¯•é¢˜</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="spring" scheme="https://www.jodio.cc/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>InterView(ä¸‰) -- æ¡†æ¶ç¯‡</title>
    <link href="https://www.jodio.cc/posts/new_frame.html"/>
    <id>https://www.jodio.cc/posts/new_frame.html</id>
    <published>2023-04-18T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¡†æ¶ç¯‡é¢è¯•é¢˜-å‚è€ƒå›ç­”"><a href="#æ¡†æ¶ç¯‡é¢è¯•é¢˜-å‚è€ƒå›ç­”" class="headerlink" title="æ¡†æ¶ç¯‡é¢è¯•é¢˜-å‚è€ƒå›ç­”"></a>æ¡†æ¶ç¯‡é¢è¯•é¢˜-å‚è€ƒå›ç­”</h2><blockquote><h3 id="é¢è¯•å®˜ï¼šSpringæ¡†æ¶ä¸­çš„å•ä¾‹beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šSpringæ¡†æ¶ä¸­çš„å•ä¾‹beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šSpringæ¡†æ¶ä¸­çš„å•ä¾‹beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringæ¡†æ¶ä¸­çš„å•ä¾‹beanæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼</p><p>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ˜¯è¿™æ ·çš„</p><p>å½“å¤šç”¨æˆ·åŒæ—¶è¯·æ±‚ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œå®¹å™¨ä¼šç»™æ¯ä¸€ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™æ˜¯å¤šä¸ªçº¿ç¨‹ä¼šå¹¶å‘æ‰§è¡Œè¯¥è¯·æ±‚å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ï¼ˆæˆå‘˜æ–¹æ³•ï¼‰ï¼Œå¦‚æœè¯¥å¤„ç†é€»è¾‘ä¸­æœ‰å¯¹è¯¥å•åˆ—çŠ¶æ€çš„ä¿®æ”¹ï¼ˆä½“ç°ä¸ºè¯¥å•ä¾‹çš„æˆå‘˜å±æ€§ï¼‰ï¼Œåˆ™å¿…é¡»è€ƒè™‘çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚</p><p>Springæ¡†æ¶å¹¶æ²¡æœ‰å¯¹å•ä¾‹beanè¿›è¡Œä»»ä½•å¤šçº¿ç¨‹çš„å°è£…å¤„ç†ã€‚å…³äºå•ä¾‹beançš„çº¿ç¨‹å®‰å…¨å’Œå¹¶å‘é—®é¢˜éœ€è¦å¼€å‘è€…è‡ªè¡Œå»æå®šã€‚</p><p>æ¯”å¦‚ï¼šæˆ‘ä»¬é€šå¸¸åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„Spring beanéƒ½æ˜¯ä¸å¯å¯å˜çš„çŠ¶æ€(æ¯”å¦‚Serviceç±»å’ŒDAOç±»)ï¼Œæ‰€ä»¥åœ¨æŸç§ç¨‹åº¦ä¸Šè¯´Springçš„å•ä¾‹beanæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>å¦‚æœä½ çš„beanæœ‰å¤šç§çŠ¶æ€çš„è¯ï¼ˆæ¯”å¦‚ View Modelå¯¹è±¡ï¼‰ï¼Œå°±éœ€è¦è‡ªè¡Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚æœ€æµ…æ˜¾çš„è§£å†³åŠæ³•å°±æ˜¯å°†å¤šæ€beançš„ä½œç”¨ç”±â€œ<strong>singleton</strong>â€å˜æ›´ä¸ºâ€œ<strong>prototype</strong>â€ã€‚</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯AOP"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯AOP" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯AOP"></a><strong>é¢è¯•å®˜</strong>ï¼šä»€ä¹ˆæ˜¯AOP</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>aopæ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œåœ¨springä¸­ç”¨äºå°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œä½†å´å¯¹å¤šä¸ªå¯¹è±¡äº§ç”Ÿå½±å“çš„å…¬å…±è¡Œä¸ºå’Œé€»è¾‘ï¼ŒæŠ½å–å…¬å…±æ¨¡å—å¤ç”¨ï¼Œé™ä½è€¦åˆï¼Œä¸€èˆ¬æ¯”å¦‚å¯ä»¥åšä¸ºå…¬å…±æ—¥å¿—ä¿å­˜ï¼Œäº‹åŠ¡å¤„ç†ç­‰</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°AOP"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°AOP" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°AOP"></a><strong>é¢è¯•å®˜</strong>ï¼šä½ ä»¬é¡¹ç›®ä¸­æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°AOP</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>æˆ‘ä»¬å½“æ—¶åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå°±æ˜¯ä½¿ç”¨aopæ¥è®°å½•äº†ç³»ç»Ÿçš„æ“ä½œæ—¥å¿—</p><p>ä¸»è¦æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œä½¿ç”¨aopä¸­çš„ç¯ç»•é€šçŸ¥+åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼å°±æ˜¯è¦æ‰¾åˆ°è¦è®°å½•æ—¥å¿—çš„æ–¹æ³•ï¼Œç„¶åé€šè¿‡ç¯ç»•é€šçŸ¥çš„å‚æ•°è·å–è¯·æ±‚æ–¹æ³•çš„å‚æ•°ï¼Œæ¯”å¦‚ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€æ³¨è§£ã€è¯·æ±‚æ–¹å¼ç­‰ï¼Œè·å–åˆ°è¿™äº›å‚æ•°ä»¥åï¼Œä¿å­˜åˆ°æ•°æ®åº“</p><h3 id="é¢è¯•å®˜ï¼šSpringä¸­çš„äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„"><a href="#é¢è¯•å®˜ï¼šSpringä¸­çš„äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="é¢è¯•å®˜ï¼šSpringä¸­çš„äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringä¸­çš„äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>springå®ç°çš„äº‹åŠ¡æœ¬è´¨å°±æ˜¯aopå®Œæˆï¼Œå¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆªï¼Œåœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å‰å¼€å¯äº‹åŠ¡ï¼Œåœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡ã€‚</p><h3 id="é¢è¯•å®˜ï¼šSpringä¸­äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›"><a href="#é¢è¯•å®˜ï¼šSpringä¸­äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›" class="headerlink" title="é¢è¯•å®˜ï¼šSpringä¸­äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringä¸­äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼è¿™ä¸ªåœ¨é¡¹ç›®ä¸­ä¹‹å‰é‡åˆ°è¿‡ï¼Œæˆ‘æƒ³æƒ³å•Š</p><p>ç¬¬ä¸€ä¸ªï¼Œå¦‚æœæ–¹æ³•ä¸Šå¼‚å¸¸æ•è·å¤„ç†ï¼Œè‡ªå·±å¤„ç†äº†å¼‚å¸¸ï¼Œæ²¡æœ‰æŠ›å‡ºï¼Œå°±ä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼Œæ‰€ä»¥ä¸€èˆ¬å¤„ç†äº†å¼‚å¸¸ä»¥åï¼Œåˆ«å¿˜äº†è·‘å‡ºå»å°±è¡Œäº†</p><p>ç¬¬äºŒä¸ªï¼Œå¦‚æœæ–¹æ³•æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œå¦‚æœæŠ¥é”™ä¹Ÿä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼Œæœ€ååœ¨springäº‹åŠ¡çš„æ³¨è§£ä¸Šï¼Œå°±æ˜¯@Transactionalä¸Šé…ç½®rollbackForå±æ€§ä¸ºExceptionï¼Œè¿™æ ·åˆ«ç®¡æ˜¯ä»€ä¹ˆå¼‚å¸¸ï¼Œéƒ½ä¼šå›æ»šäº‹åŠ¡</p><p>ç¬¬ä¸‰ï¼Œæˆ‘ä¹‹å‰è¿˜é‡åˆ°è¿‡ä¸€ä¸ªï¼Œå¦‚æœæ–¹æ³•ä¸Šä¸æ˜¯publicä¿®é¥°çš„ï¼Œä¹Ÿä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆ</p><p>å—¯ï¼Œå°±èƒ½æƒ³èµ·æ¥é‚£ä¹ˆå¤š</p><h3 id="é¢è¯•å®˜ï¼šSpringçš„beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#é¢è¯•å®˜ï¼šSpringçš„beançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="é¢è¯•å®˜ï¼šSpringçš„beançš„ç”Ÿå‘½å‘¨æœŸ"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringçš„beançš„ç”Ÿå‘½å‘¨æœŸ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼ï¼Œè¿™ä¸ªæ­¥éª¤è¿˜æ˜¯æŒºå¤šçš„ï¼Œæˆ‘ä¹‹å‰çœ‹è¿‡ä¸€äº›æºç ï¼Œå®ƒå¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·çš„</p><p>é¦–å…ˆä¼šé€šè¿‡ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ï¼Œå«åšBeanDefinitionè·å–beançš„å®šä¹‰ä¿¡æ¯ï¼Œè¿™é‡Œé¢å°±å°è£…äº†beançš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼Œç±»çš„å…¨è·¯å¾„ï¼Œæ˜¯å¦æ˜¯å»¶è¿ŸåŠ è½½ï¼Œæ˜¯å¦æ˜¯å•ä¾‹ç­‰ç­‰è¿™äº›ä¿¡æ¯</p><p>åœ¨åˆ›å»ºbeançš„æ—¶å€™ï¼Œç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–bean</p><p>ç¬¬äºŒæ­¥æ˜¯beançš„ä¾èµ–æ³¨å…¥ï¼Œæ¯”å¦‚ä¸€äº›setæ–¹æ³•æ³¨å…¥ï¼Œåƒå¹³æ—¶å¼€å‘ç”¨çš„@Autowireéƒ½æ˜¯è¿™ä¸€æ­¥å®Œæˆ</p><p>ç¬¬ä¸‰æ­¥æ˜¯å¤„ç†Awareæ¥å£ï¼Œå¦‚æœæŸä¸€ä¸ªbeanå®ç°äº†Awareæ¥å£å°±ä¼šé‡å†™æ–¹æ³•æ‰§è¡Œ</p><p>ç¬¬å››æ­¥æ˜¯beançš„åç½®å¤„ç†å™¨BeanPostProcessorï¼Œè¿™ä¸ªæ˜¯å‰ç½®å¤„ç†å™¨</p><p>ç¬¬äº”æ­¥æ˜¯åˆå§‹åŒ–æ–¹æ³•ï¼Œæ¯”å¦‚å®ç°äº†æ¥å£InitializingBeanæˆ–è€…è‡ªå®šä¹‰äº†æ–¹æ³•init-methodæ ‡ç­¾æˆ–@PostContruct</p><p>ç¬¬å…­æ­¥æ˜¯æ‰§è¡Œbeançš„åç½®å¤„ç†å™¨BeanPostProcessorï¼Œä¸»è¦æ˜¯å¯¹beanè¿›è¡Œå¢å¼ºï¼Œæœ‰å¯èƒ½åœ¨è¿™é‡Œäº§ç”Ÿä»£ç†å¯¹è±¡</p><p>æœ€åä¸€æ­¥æ˜¯é”€æ¯bean</p><h3 id="é¢è¯•å®˜ï¼šSpringä¸­çš„å¾ªç¯å¼•ç”¨"><a href="#é¢è¯•å®˜ï¼šSpringä¸­çš„å¾ªç¯å¼•ç”¨" class="headerlink" title="é¢è¯•å®˜ï¼šSpringä¸­çš„å¾ªç¯å¼•ç”¨"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringä¸­çš„å¾ªç¯å¼•ç”¨</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œå¥½çš„ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹</p><p>å¾ªç¯ä¾èµ–ï¼šå¾ªç¯ä¾èµ–å…¶å®å°±æ˜¯å¾ªç¯å¼•ç”¨,ä¹Ÿå°±æ˜¯ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„beanäº’ç›¸æŒæœ‰å¯¹æ–¹,æœ€ç»ˆå½¢æˆé—­ç¯ã€‚æ¯”å¦‚Aä¾èµ–äºB,Bä¾èµ–äºA</p><p>å¾ªç¯ä¾èµ–åœ¨springä¸­æ˜¯å…è®¸å­˜åœ¨ï¼Œspringæ¡†æ¶ä¾æ®ä¸‰çº§ç¼“å­˜å·²ç»è§£å†³äº†å¤§éƒ¨åˆ†çš„å¾ªç¯ä¾èµ–</p><p>â‘ ä¸€çº§ç¼“å­˜ï¼šå•ä¾‹æ± ï¼Œç¼“å­˜å·²ç»ç»å†äº†å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸï¼Œå·²ç»åˆå§‹åŒ–å®Œæˆçš„beanå¯¹è±¡</p><p>â‘¡äºŒçº§ç¼“å­˜ï¼šç¼“å­˜æ—©æœŸçš„beanå¯¹è±¡ï¼ˆç”Ÿå‘½å‘¨æœŸè¿˜æ²¡èµ°å®Œï¼‰</p><p>â‘¢ä¸‰çº§ç¼“å­˜ï¼šç¼“å­˜çš„æ˜¯ObjectFactoryï¼Œè¡¨ç¤ºå¯¹è±¡å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºæŸä¸ªå¯¹è±¡çš„</p><h3 id="é¢è¯•å®˜ï¼šé‚£å…·ä½“è§£å†³æµç¨‹æ¸…æ¥šå—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé‚£å…·ä½“è§£å†³æµç¨‹æ¸…æ¥šå—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£å…·ä½“è§£å†³æµç¨‹æ¸…æ¥šå—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šé‚£å…·ä½“è§£å†³æµç¨‹æ¸…æ¥šå—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>ç¬¬ä¸€ï¼Œå…ˆå®ä¾‹Aå¯¹è±¡ï¼ŒåŒæ—¶ä¼šåˆ›å»ºObjectFactoryå¯¹è±¡å­˜å…¥ä¸‰çº§ç¼“å­˜singletonFactories  </p><p>ç¬¬äºŒï¼ŒAåœ¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦Bå¯¹è±¡ï¼Œè¿™ä¸ªèµ°Bçš„åˆ›å»ºçš„é€»è¾‘</p><p>ç¬¬ä¸‰ï¼ŒBå®ä¾‹åŒ–å®Œæˆï¼Œä¹Ÿä¼šåˆ›å»ºObjectFactoryå¯¹è±¡å­˜å…¥ä¸‰çº§ç¼“å­˜singletonFactories  </p><p>ç¬¬å››ï¼ŒBéœ€è¦æ³¨å…¥Aï¼Œé€šè¿‡ä¸‰çº§ç¼“å­˜ä¸­è·å–ObjectFactoryæ¥ç”Ÿæˆä¸€ä¸ªAçš„å¯¹è±¡åŒæ—¶å­˜å…¥äºŒçº§ç¼“å­˜ï¼Œè¿™ä¸ªæ˜¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å¯èƒ½æ˜¯Açš„æ™®é€šå¯¹è±¡ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯Açš„ä»£ç†å¯¹è±¡ï¼Œéƒ½å¯ä»¥è®©ObjectFactoryæ¥ç”Ÿäº§å¯¹åº”çš„å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯ä¸‰çº§ç¼“å­˜çš„å…³é”®</p><p>ç¬¬äº”ï¼ŒBé€šè¿‡ä»é€šè¿‡äºŒçº§ç¼“å­˜earlySingletonObjects  è·å¾—åˆ°Açš„å¯¹è±¡åå¯ä»¥æ­£å¸¸æ³¨å…¥ï¼ŒBåˆ›å»ºæˆåŠŸï¼Œå­˜å…¥ä¸€çº§ç¼“å­˜singletonObjects  </p><p>ç¬¬å…­ï¼Œå›åˆ°Aå¯¹è±¡åˆå§‹åŒ–ï¼Œå› ä¸ºBå¯¹è±¡å·²ç»åˆ›å»ºå®Œæˆï¼Œåˆ™å¯ä»¥ç›´æ¥æ³¨å…¥Bï¼ŒAåˆ›å»ºæˆåŠŸå­˜å…¥ä¸€æ¬¡ç¼“å­˜singletonObjects </p><p>ç¬¬ä¸ƒï¼ŒäºŒçº§ç¼“å­˜ä¸­çš„ä¸´æ—¶å¯¹è±¡Aæ¸…é™¤ </p><h3 id="é¢è¯•å®˜ï¼šæ„é€ æ–¹æ³•å‡ºç°äº†å¾ªç¯ä¾èµ–æ€ä¹ˆè§£å†³ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šæ„é€ æ–¹æ³•å‡ºç°äº†å¾ªç¯ä¾èµ–æ€ä¹ˆè§£å†³ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šæ„é€ æ–¹æ³•å‡ºç°äº†å¾ªç¯ä¾èµ–æ€ä¹ˆè§£å†³ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šæ„é€ æ–¹æ³•å‡ºç°äº†å¾ªç¯ä¾èµ–æ€ä¹ˆè§£å†³ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>ç”±äºbeançš„ç”Ÿå‘½å‘¨æœŸä¸­æ„é€ å‡½æ•°æ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ï¼Œspringæ¡†æ¶å¹¶ä¸èƒ½è§£å†³æ„é€ å‡½æ•°çš„çš„ä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥ä½¿ç”¨@Lazyæ‡’åŠ è½½ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å¯¹è±¡å†è¿›è¡Œbeanå¯¹è±¡çš„åˆ›å»º</p><h3 id="é¢è¯•å®˜ï¼šSpringMVCçš„æ‰§è¡Œæµç¨‹çŸ¥é“å˜›"><a href="#é¢è¯•å®˜ï¼šSpringMVCçš„æ‰§è¡Œæµç¨‹çŸ¥é“å˜›" class="headerlink" title="é¢è¯•å®˜ï¼šSpringMVCçš„æ‰§è¡Œæµç¨‹çŸ¥é“å˜›"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringMVCçš„æ‰§è¡Œæµç¨‹çŸ¥é“å˜›</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªçŸ¥é“çš„ï¼Œå®ƒåˆ†äº†å¥½å¤šæ­¥éª¤</p><p>1ã€ç”¨æˆ·å‘é€å‡ºè¯·æ±‚åˆ°å‰ç«¯æ§åˆ¶å™¨DispatcherServletï¼Œè¿™æ˜¯ä¸€ä¸ªè°ƒåº¦ä¸­å¿ƒ</p><p>2ã€DispatcherServletæ”¶åˆ°è¯·æ±‚è°ƒç”¨HandlerMappingï¼ˆå¤„ç†å™¨æ˜ å°„å™¨ï¼‰ã€‚</p><p>3ã€HandlerMappingæ‰¾åˆ°å…·ä½“çš„å¤„ç†å™¨(å¯æŸ¥æ‰¾xmlé…ç½®æˆ–æ³¨è§£é…ç½®)ï¼Œç”Ÿæˆå¤„ç†å™¨å¯¹è±¡åŠå¤„ç†å™¨æ‹¦æˆªå™¨(å¦‚æœæœ‰)ï¼Œå†ä¸€èµ·è¿”å›ç»™DispatcherServletã€‚</p><p>4ã€DispatcherServletè°ƒç”¨HandlerAdapterï¼ˆå¤„ç†å™¨é€‚é…å™¨ï¼‰ã€‚</p><p>5ã€HandlerAdapterç»è¿‡é€‚é…è°ƒç”¨å…·ä½“çš„å¤„ç†å™¨ï¼ˆHandler/Controllerï¼‰ã€‚</p><p>6ã€Controlleræ‰§è¡Œå®Œæˆè¿”å›ModelAndViewå¯¹è±¡ã€‚</p><p>7ã€HandlerAdapterå°†Controlleræ‰§è¡Œç»“æœModelAndViewè¿”å›ç»™DispatcherServletã€‚</p><p>8ã€DispatcherServletå°†ModelAndViewä¼ ç»™ViewResloverï¼ˆè§†å›¾è§£æå™¨ï¼‰ã€‚</p><p>9ã€ViewResloverè§£æåè¿”å›å…·ä½“Viewï¼ˆè§†å›¾ï¼‰ã€‚</p><p>10ã€DispatcherServletæ ¹æ®Viewè¿›è¡Œæ¸²æŸ“è§†å›¾ï¼ˆå³å°†æ¨¡å‹æ•°æ®å¡«å……è‡³è§†å›¾ä¸­ï¼‰ã€‚</p><p>11ã€DispatcherServletå“åº”ç”¨æˆ·ã€‚</p><p>å½“ç„¶ç°åœ¨çš„å¼€å‘ï¼ŒåŸºæœ¬éƒ½æ˜¯å‰åç«¯åˆ†ç¦»çš„å¼€å‘çš„ï¼Œå¹¶æ²¡æœ‰è§†å›¾è¿™äº›ï¼Œä¸€èˆ¬éƒ½æ˜¯handlerä¸­ä½¿ç”¨Responseç›´æ¥ç»“æœè¿”å›</p><h3 id="é¢è¯•å®˜ï¼šSpringbootè‡ªåŠ¨é…ç½®åŸç†"><a href="#é¢è¯•å®˜ï¼šSpringbootè‡ªåŠ¨é…ç½®åŸç†" class="headerlink" title="é¢è¯•å®˜ï¼šSpringbootè‡ªåŠ¨é…ç½®åŸç†"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringbootè‡ªåŠ¨é…ç½®åŸç†</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œå¥½çš„ï¼Œå®ƒæ˜¯è¿™æ ·çš„ã€‚</p><p>åœ¨Spring Booté¡¹ç›®ä¸­çš„å¼•å¯¼ç±»ä¸Šæœ‰ä¸€ä¸ªæ³¨è§£@SpringBootApplicationï¼Œè¿™ä¸ªæ³¨è§£æ˜¯å¯¹ä¸‰ä¸ªæ³¨è§£è¿›è¡Œäº†å°è£…ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><p>@SpringBootConfiguration</p></li><li><p>@EnableAutoConfiguration</p></li><li><p>@ComponentScan</p></li></ul><p>å…¶ä¸­<code>@EnableAutoConfiguration</code>æ˜¯å®ç°è‡ªåŠ¨åŒ–é…ç½®çš„æ ¸å¿ƒæ³¨è§£ã€‚ </p><p>è¯¥æ³¨è§£é€šè¿‡<code>@Import</code>æ³¨è§£å¯¼å…¥å¯¹åº”çš„é…ç½®é€‰æ‹©å™¨ã€‚å…³é”®çš„æ˜¯å†…éƒ¨å°±æ˜¯è¯»å–äº†è¯¥é¡¹ç›®å’Œè¯¥é¡¹ç›®å¼•ç”¨çš„JaråŒ…çš„çš„classpathè·¯å¾„ä¸‹<strong>META-INF/spring.factories</strong>æ–‡ä»¶ä¸­çš„æ‰€é…ç½®çš„ç±»çš„å…¨ç±»åã€‚ </p><p>åœ¨è¿™äº›é…ç½®ç±»ä¸­æ‰€å®šä¹‰çš„Beanä¼šæ ¹æ®æ¡ä»¶æ³¨è§£æ‰€<strong>æŒ‡å®šçš„æ¡ä»¶æ¥å†³å®š</strong>æ˜¯å¦éœ€è¦å°†å…¶å¯¼å…¥åˆ°Springå®¹å™¨ä¸­ã€‚</p><p>ä¸€èˆ¬æ¡ä»¶åˆ¤æ–­ä¼šæœ‰åƒ<code>@ConditionalOnClass</code>è¿™æ ·çš„æ³¨è§£ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„classæ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™åŠ è½½è¯¥ç±»ï¼ŒæŠŠè¿™ä¸ªé…ç½®ç±»çš„æ‰€æœ‰çš„Beanæ”¾å…¥springå®¹å™¨ä¸­ä½¿ç”¨ã€‚</p><h3 id="é¢è¯•å®˜ï¼šSpring-çš„å¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šSpring-çš„å¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šSpring çš„å¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šSpring çš„å¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªå°±å¾ˆå¤šäº†</p><p>ç¬¬ä¸€ç±»æ˜¯ï¼šå£°æ˜beanï¼Œæœ‰@Componentã€@Serviceã€@Repositoryã€@Controller</p><p>ç¬¬äºŒç±»æ˜¯ï¼šä¾èµ–æ³¨å…¥ç›¸å…³çš„ï¼Œæœ‰@Autowiredã€@Qualifierã€@Resourse</p><p>ç¬¬ä¸‰ç±»æ˜¯ï¼šè®¾ç½®ä½œç”¨åŸŸ @Scope</p><p>ç¬¬å››ç±»æ˜¯ï¼šspringé…ç½®ç›¸å…³çš„ï¼Œæ¯”å¦‚@Configurationï¼Œ@ComponentScan å’Œ @Bean </p><p>ç¬¬äº”ç±»æ˜¯ï¼šè·Ÿaopç›¸å…³åšå¢å¼ºçš„æ³¨è§£  @Aspectï¼Œ@Beforeï¼Œ@Afterï¼Œ@Aroundï¼Œ@Pointcut</p><h3 id="é¢è¯•å®˜ï¼šSpringMVCå¸¸è§çš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šSpringMVCå¸¸è§çš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šSpringMVCå¸¸è§çš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringMVCå¸¸è§çš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªä¹Ÿå¾ˆå¤šçš„</p><p>æœ‰@RequestMappingï¼šç”¨äºæ˜ å°„è¯·æ±‚è·¯å¾„ï¼›</p><p>@RequestBodyï¼šæ³¨è§£å®ç°æ¥æ”¶httpè¯·æ±‚çš„jsonæ•°æ®ï¼Œå°†jsonè½¬æ¢ä¸ºjavaå¯¹è±¡ï¼›</p><p>@RequestParamï¼šæŒ‡å®šè¯·æ±‚å‚æ•°çš„åç§°ï¼›</p><p>@PathViriableï¼šä»è¯·æ±‚è·¯å¾„ä¸‹ä¸­è·å–è¯·æ±‚å‚æ•°(/user/{id})ï¼Œä¼ é€’ç»™æ–¹æ³•çš„å½¢å¼å‚æ•°ï¼›@ResponseBodyï¼šæ³¨è§£å®ç°å°†controlleræ–¹æ³•è¿”å›å¯¹è±¡è½¬åŒ–ä¸ºjsonå¯¹è±¡å“åº”ç»™å®¢æˆ·ç«¯ã€‚@RequestHeaderï¼šè·å–æŒ‡å®šçš„è¯·æ±‚å¤´æ•°æ®ï¼Œè¿˜æœ‰åƒ@PostMappingã€@GetMappingè¿™äº›ã€‚</p><h3 id="é¢è¯•å®˜ï¼šSpringbootå¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šSpringbootå¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šSpringbootå¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šSpringbootå¸¸è§æ³¨è§£æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~~</p><p>Spring Bootçš„æ ¸å¿ƒæ³¨è§£æ˜¯@SpringBootApplication , ä»–ç”±å‡ ä¸ªæ³¨è§£ç»„æˆ : </p><ul><li>@SpringBootConfigurationï¼š ç»„åˆäº†- @Configurationæ³¨è§£ï¼Œå®ç°é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ï¼›</li><li>@EnableAutoConfigurationï¼šæ‰“å¼€è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥å…³é—­æŸä¸ªè‡ªåŠ¨é…ç½®çš„é€‰é¡¹</li><li>@ComponentScanï¼šSpringç»„ä»¶æ‰«æ</li></ul><h3 id="é¢è¯•å®˜ï¼šMyBatisæ‰§è¡Œæµç¨‹"><a href="#é¢è¯•å®˜ï¼šMyBatisæ‰§è¡Œæµç¨‹" class="headerlink" title="é¢è¯•å®˜ï¼šMyBatisæ‰§è¡Œæµç¨‹"></a><strong>é¢è¯•å®˜</strong>ï¼šMyBatisæ‰§è¡Œæµç¨‹</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å¥½ï¼Œè¿™ä¸ªçŸ¥é“çš„ï¼Œä¸è¿‡æ­¥éª¤ä¹Ÿå¾ˆå¤š</p><p>â‘ è¯»å–MyBatisé…ç½®æ–‡ä»¶ï¼šmybatis-config.xmlåŠ è½½è¿è¡Œç¯å¢ƒå’Œæ˜ å°„æ–‡ä»¶</p><p>â‘¡æ„é€ ä¼šè¯å·¥å‚SqlSessionFactoryï¼Œä¸€ä¸ªé¡¹ç›®åªéœ€è¦ä¸€ä¸ªï¼Œå•ä¾‹çš„ï¼Œä¸€èˆ¬ç”±springè¿›è¡Œç®¡ç†</p><p>â‘¢ä¼šè¯å·¥å‚åˆ›å»ºSqlSessionå¯¹è±¡ï¼Œè¿™é‡Œé¢å°±å«äº†æ‰§è¡ŒSQLè¯­å¥çš„æ‰€æœ‰æ–¹æ³•</p><p>â‘£æ“ä½œæ•°æ®åº“çš„æ¥å£ï¼ŒExecutoræ‰§è¡Œå™¨ï¼ŒåŒæ—¶è´Ÿè´£æŸ¥è¯¢ç¼“å­˜çš„ç»´æŠ¤</p><p>â‘¤Executoræ¥å£çš„æ‰§è¡Œæ–¹æ³•ä¸­æœ‰ä¸€ä¸ªMappedStatementç±»å‹çš„å‚æ•°ï¼Œå°è£…äº†æ˜ å°„ä¿¡æ¯</p><p>â‘¥è¾“å…¥å‚æ•°æ˜ å°„</p><p>â‘¦è¾“å‡ºç»“æœæ˜ å°„</p><h3 id="é¢è¯•å®˜ï¼šMybatisæ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šMybatisæ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šMybatisæ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šMybatisæ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>æ˜¯æ”¯æŒçš„~</p><p>å»¶è¿ŸåŠ è½½çš„æ„æ€æ˜¯ï¼šå°±æ˜¯åœ¨éœ€è¦ç”¨åˆ°æ•°æ®æ—¶æ‰è¿›è¡ŒåŠ è½½ï¼Œä¸éœ€è¦ç”¨åˆ°æ•°æ®æ—¶å°±ä¸åŠ è½½æ•°æ®ã€‚</p><p>Mybatisæ”¯æŒä¸€å¯¹ä¸€å…³è”å¯¹è±¡å’Œä¸€å¯¹å¤šå…³è”é›†åˆå¯¹è±¡çš„å»¶è¿ŸåŠ è½½</p><p>åœ¨Mybatisé…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é…ç½®æ˜¯å¦å¯ç”¨å»¶è¿ŸåŠ è½½lazyLoadingEnabled=true|falseï¼Œé»˜è®¤æ˜¯å…³é—­çš„</p><h3 id="é¢è¯•å®˜ï¼šå»¶è¿ŸåŠ è½½çš„åº•å±‚åŸç†çŸ¥é“å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå»¶è¿ŸåŠ è½½çš„åº•å±‚åŸç†çŸ¥é“å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå»¶è¿ŸåŠ è½½çš„åº•å±‚åŸç†çŸ¥é“å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå»¶è¿ŸåŠ è½½çš„åº•å±‚åŸç†çŸ¥é“å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œæˆ‘æƒ³æƒ³å•Š</p><p>å»¶è¿ŸåŠ è½½åœ¨åº•å±‚ä¸»è¦ä½¿ç”¨çš„CGLIBåŠ¨æ€ä»£ç†å®Œæˆçš„</p><p>ç¬¬ä¸€æ˜¯ï¼Œä½¿ç”¨CGLIBåˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œçš„ç›®æ ‡å¯¹è±¡å°±æ˜¯å¼€å¯äº†å»¶è¿ŸåŠ è½½çš„mapper</p><p>ç¬¬äºŒä¸ªæ˜¯å½“è°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶ï¼Œè¿›å…¥æ‹¦æˆªå™¨invokeæ–¹æ³•ï¼Œå‘ç°ç›®æ ‡æ–¹æ³•æ˜¯nullå€¼ï¼Œå†æ‰§è¡ŒsqlæŸ¥è¯¢</p><p>ç¬¬ä¸‰ä¸ªæ˜¯è·å–æ•°æ®ä»¥åï¼Œè°ƒç”¨setæ–¹æ³•è®¾ç½®å±æ€§å€¼ï¼Œå†ç»§ç»­æŸ¥è¯¢ç›®æ ‡æ–¹æ³•ï¼Œå°±æœ‰å€¼äº†</p><h3 id="é¢è¯•å®˜ï¼šMybatisçš„ä¸€çº§ã€äºŒçº§ç¼“å­˜ç”¨è¿‡å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šMybatisçš„ä¸€çº§ã€äºŒçº§ç¼“å­˜ç”¨è¿‡å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šMybatisçš„ä¸€çº§ã€äºŒçº§ç¼“å­˜ç”¨è¿‡å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šMybatisçš„ä¸€çº§ã€äºŒçº§ç¼“å­˜ç”¨è¿‡å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~~ï¼Œç”¨è¿‡çš„~</p><p>mybatisçš„ä¸€çº§ç¼“å­˜: åŸºäº PerpetualCache çš„ HashMap æœ¬åœ°ç¼“å­˜ï¼Œå…¶å­˜å‚¨ä½œç”¨åŸŸä¸º Sessionï¼Œå½“Sessionè¿›è¡Œflushæˆ–closeä¹‹åï¼Œè¯¥Sessionä¸­çš„æ‰€æœ‰Cacheå°±å°†æ¸…ç©ºï¼Œé»˜è®¤æ‰“å¼€ä¸€çº§ç¼“å­˜</p><p>å…³äºäºŒçº§ç¼“å­˜éœ€è¦å•ç‹¬å¼€å¯</p><p>äºŒçº§ç¼“å­˜æ˜¯åŸºäºnamespaceå’Œmapperçš„ä½œç”¨åŸŸèµ·ä½œç”¨çš„ï¼Œä¸æ˜¯ä¾èµ–äºSQL sessionï¼Œé»˜è®¤ä¹Ÿæ˜¯é‡‡ç”¨ PerpetualCacheï¼ŒHashMap å­˜å‚¨ã€‚</p><p>å¦‚æœæƒ³è¦å¼€å¯äºŒçº§ç¼“å­˜éœ€è¦åœ¨å…¨å±€é…ç½®æ–‡ä»¶å’Œæ˜ å°„æ–‡ä»¶ä¸­å¼€å¯é…ç½®æ‰è¡Œã€‚</p><h3 id="é¢è¯•å®˜ï¼šMybatisçš„äºŒçº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™ä¼šæ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®"><a href="#é¢è¯•å®˜ï¼šMybatisçš„äºŒçº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™ä¼šæ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®" class="headerlink" title="é¢è¯•å®˜ï¼šMybatisçš„äºŒçº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™ä¼šæ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®"></a><strong>é¢è¯•å®˜</strong>ï¼šMybatisçš„äºŒçº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™ä¼šæ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼ï¼</p><p>å½“æŸä¸€ä¸ªä½œç”¨åŸŸ(ä¸€çº§ç¼“å­˜ Session/äºŒçº§ç¼“å­˜Namespaces)çš„è¿›è¡Œäº†æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œåï¼Œé»˜è®¤è¯¥ä½œç”¨åŸŸä¸‹æ‰€æœ‰ select ä¸­çš„ç¼“å­˜å°†è¢« clearã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">æ¡†æ¶ç›¸å…³çš„é¢è¯•é¢˜</summary>
    
    
    
    <category term="Java , frame" scheme="https://www.jodio.cc/categories/Java-frame/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="frame" scheme="https://www.jodio.cc/tags/frame/"/>
    
  </entry>
  
  <entry>
    <title>InterView(äºŒ) -- Mysqlç¯‡</title>
    <link href="https://www.jodio.cc/posts/new_mysql.html"/>
    <id>https://www.jodio.cc/posts/new_mysql.html</id>
    <published>2023-04-18T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MySQLé¢è¯•é¢˜"><a href="#MySQLé¢è¯•é¢˜" class="headerlink" title="MySQLé¢è¯•é¢˜"></a>MySQLé¢è¯•é¢˜</h2><blockquote><h3 id="é¢è¯•å®˜ï¼šMySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢"><a href="#é¢è¯•å®˜ï¼šMySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢" class="headerlink" title="é¢è¯•å®˜ï¼šMySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢?"></a><strong>é¢è¯•å®˜ï¼š</strong>MySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>å—¯~ï¼Œæˆ‘ä»¬å½“æ—¶åšå‹æµ‹çš„æ—¶å€™æœ‰çš„æ¥å£éå¸¸çš„æ…¢ï¼Œæ¥å£çš„å“åº”æ—¶é—´è¶…è¿‡äº†2ç§’ä»¥ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬å½“æ—¶çš„ç³»ç»Ÿéƒ¨ç½²äº†è¿ç»´çš„ç›‘æ§ç³»ç»ŸSkywalking ï¼Œåœ¨å±•ç¤ºçš„æŠ¥è¡¨ä¸­å¯ä»¥çœ‹åˆ°æ˜¯å“ªä¸€ä¸ªæ¥å£æ¯”è¾ƒæ…¢ï¼Œå¹¶ä¸”å¯ä»¥åˆ†æè¿™ä¸ªæ¥å£å“ªéƒ¨åˆ†æ¯”è¾ƒæ…¢ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°SQLçš„å…·ä½“çš„æ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥å¯ä»¥å®šä½æ˜¯å“ªä¸ªsqlå‡ºäº†é—®é¢˜</p><p>å¦‚æœï¼Œé¡¹ç›®ä¸­æ²¡æœ‰è¿™ç§è¿ç»´çš„ç›‘æ§ç³»ç»Ÿï¼Œå…¶å®åœ¨MySQLä¸­ä¹Ÿæä¾›äº†æ…¢æ—¥å¿—æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨MySQLçš„ç³»ç»Ÿé…ç½®æ–‡ä»¶ä¸­å¼€å¯è¿™ä¸ªæ…¢æ—¥å¿—çš„åŠŸèƒ½ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥è®¾ç½®SQLæ‰§è¡Œè¶…è¿‡å¤šå°‘æ—¶é—´æ¥è®°å½•åˆ°ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæˆ‘è®°å¾—ä¸Šä¸€ä¸ªé¡¹ç›®é…ç½®çš„æ˜¯2ç§’ï¼Œåªè¦SQLæ‰§è¡Œçš„æ—¶é—´è¶…è¿‡äº†2ç§’å°±ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ—¥å¿—æ–‡ä»¶æ‰¾åˆ°æ‰§è¡Œæ¯”è¾ƒæ…¢çš„SQLäº†ã€‚</p><h3 id="é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢-å¦‚ä½•åˆ†æå‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢-å¦‚ä½•åˆ†æå‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢, å¦‚ä½•åˆ†æå‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>é‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢, å¦‚ä½•åˆ†æå‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>å¦‚æœä¸€æ¡sqlæ‰§è¡Œå¾ˆæ…¢çš„è¯ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨mysqlè‡ªåŠ¨çš„æ‰§è¡Œè®¡åˆ’explainæ¥å»æŸ¥çœ‹è¿™æ¡sqlçš„æ‰§è¡Œæƒ…å†µï¼Œæ¯”å¦‚åœ¨è¿™é‡Œé¢å¯ä»¥é€šè¿‡keyå’Œkey_lenæ£€æŸ¥æ˜¯å¦å‘½ä¸­äº†ç´¢å¼•ï¼Œå¦‚æœæœ¬èº«å·²ç»æ·»åŠ äº†ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥åˆ¤æ–­ç´¢å¼•æ˜¯å¦æœ‰å¤±æ•ˆçš„æƒ…å†µï¼Œç¬¬äºŒä¸ªï¼Œå¯ä»¥é€šè¿‡typeå­—æ®µæŸ¥çœ‹sqlæ˜¯å¦æœ‰è¿›ä¸€æ­¥çš„ä¼˜åŒ–ç©ºé—´ï¼Œæ˜¯å¦å­˜åœ¨å…¨ç´¢å¼•æ‰«ææˆ–å…¨ç›˜æ‰«æï¼Œç¬¬ä¸‰ä¸ªå¯ä»¥é€šè¿‡extraå»ºè®®æ¥åˆ¤æ–­ï¼Œæ˜¯å¦å‡ºç°äº†å›è¡¨çš„æƒ…å†µï¼Œå¦‚æœå‡ºç°äº†ï¼Œå¯ä»¥å°è¯•æ·»åŠ ç´¢å¼•æˆ–ä¿®æ”¹è¿”å›å­—æ®µæ¥ä¿®å¤</p><h3 id="é¢è¯•å®˜ï¼šäº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰"><a href="#é¢è¯•å®˜ï¼šäº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰" class="headerlink" title="é¢è¯•å®˜ï¼šäº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰"></a><strong>é¢è¯•å®˜ï¼š</strong>äº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œç´¢å¼•åœ¨é¡¹ç›®ä¸­è¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œå®ƒæ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦æ˜¯ç”¨æ¥æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬ï¼ŒåŒæ—¶é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œä¹Ÿèƒ½é™ä½äº†CPUçš„æ¶ˆè€—</p><h3 id="é¢è¯•å®˜ï¼šç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æ„äº†è§£è¿‡å˜›"><a href="#é¢è¯•å®˜ï¼šç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æ„äº†è§£è¿‡å˜›" class="headerlink" title="é¢è¯•å®˜ï¼šç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æ„äº†è§£è¿‡å˜› ?"></a><strong>é¢è¯•å®˜ï¼š</strong>ç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æ„äº†è§£è¿‡å˜› ?</h3><p><strong>å€™é€‰äººï¼š</strong>MySQLçš„é»˜è®¤çš„å­˜å‚¨å¼•æ“InnoDBé‡‡ç”¨çš„B+æ ‘çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•ï¼Œé€‰æ‹©B+æ ‘çš„ä¸»è¦çš„åŸå› æ˜¯ï¼šç¬¬ä¸€é˜¶æ•°æ›´å¤šï¼Œè·¯å¾„æ›´çŸ­ï¼Œç¬¬äºŒä¸ªç£ç›˜è¯»å†™ä»£ä»·B+æ ‘æ›´ä½ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜å‚¨æŒ‡é’ˆï¼Œå¶å­é˜¶æ®µå­˜å‚¨æ•°æ®ï¼Œç¬¬ä¸‰æ˜¯B+æ ‘ä¾¿äºæ‰«åº“å’ŒåŒºé—´æŸ¥è¯¢ï¼Œå¶å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</p><h3 id="é¢è¯•å®˜ï¼šBæ ‘å’ŒB-æ ‘çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šBæ ‘å’ŒB-æ ‘çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šBæ ‘å’ŒB+æ ‘çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>Bæ ‘å’ŒB+æ ‘çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šç¬¬ä¸€ï¼šåœ¨Bæ ‘ä¸­ï¼Œéå¶å­èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹éƒ½ä¼šå­˜æ”¾æ•°æ®ï¼Œè€ŒB+æ ‘çš„æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå‡ºç°åœ¨å¶å­èŠ‚ç‚¹ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼ŒB+æ ‘æŸ¥æ‰¾æ•ˆç‡æ›´åŠ ç¨³å®š</p><p>ç¬¬äºŒï¼šåœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢çš„æ—¶å€™ï¼ŒB+æ ‘æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºB+æ ‘éƒ½åœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨ï¼Œå¹¶ä¸”å¶å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ä»€ä¹ˆæ˜¯éèšç°‡ç´¢å¼•"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ä»€ä¹ˆæ˜¯éèšç°‡ç´¢å¼•" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ä»€ä¹ˆæ˜¯éèšç°‡ç´¢å¼• ?"></a><strong>é¢è¯•å®˜ï¼š</strong>ä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ä»€ä¹ˆæ˜¯éèšç°‡ç´¢å¼• ?</h3><p><strong>å€™é€‰äººï¼š</strong></p><p>èšç°‡ç´¢å¼•ä¸»è¦æ˜¯æŒ‡æ•°æ®ä¸ç´¢å¼•æ”¾åˆ°ä¸€å—ï¼ŒB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¿å­˜äº†æ•´è¡Œæ•°æ®ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸»é”®åœ¨ä½œä¸ºèšç°‡ç´¢å¼•çš„</p><p>éèšç°‡ç´¢å¼•å€¼çš„æ˜¯æ•°æ®ä¸ç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼ŒB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¿å­˜å¯¹åº”çš„ä¸»é”®ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸€èˆ¬æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç´¢å¼•éƒ½æ˜¯éèšç°‡ç´¢å¼•</p><h3 id="é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢å˜›"><a href="#é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢å˜›" class="headerlink" title="é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢å˜› ?"></a><strong>é¢è¯•å®˜ï¼š</strong>çŸ¥é“ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢å˜› ?</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œå…¶å®è·Ÿåˆšæ‰ä»‹ç»çš„èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•æ˜¯æœ‰å…³ç³»çš„ï¼Œå›è¡¨çš„æ„æ€å°±æ˜¯é€šè¿‡äºŒçº§ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„ä¸»é”®å€¼ï¼Œç„¶åå†é€šè¿‡ä¸»é”®å€¼æ‰¾åˆ°èšé›†ç´¢å¼•ä¸­æ‰€å¯¹åº”çš„æ•´è¡Œæ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å›è¡¨</p><p>ã€<strong>å¤‡æ³¨</strong>ï¼šå¦‚æœé¢è¯•å®˜ç›´æ¥é—®å›è¡¨ï¼Œåˆ™éœ€è¦å…ˆä»‹ç»èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ã€‘</p><h3 id="é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆå«è¦†ç›–ç´¢å¼•å˜›"><a href="#é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆå«è¦†ç›–ç´¢å¼•å˜›" class="headerlink" title="é¢è¯•å®˜ï¼šçŸ¥é“ä»€ä¹ˆå«è¦†ç›–ç´¢å¼•å˜› ?"></a><strong>é¢è¯•å®˜ï¼š</strong>çŸ¥é“ä»€ä¹ˆå«è¦†ç›–ç´¢å¼•å˜› ?</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯~ï¼Œæ¸…æ¥šçš„</p><p>è¦†ç›–ç´¢å¼•æ˜¯æŒ‡selectæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†ç´¢å¼•ï¼Œåœ¨è¿”å›çš„åˆ—ï¼Œå¿…é¡»åœ¨ç´¢å¼•ä¸­å…¨éƒ¨èƒ½å¤Ÿæ‰¾åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨idæŸ¥è¯¢ï¼Œå®ƒä¼šç›´æ¥èµ°èšé›†ç´¢å¼•æŸ¥è¯¢ï¼Œä¸€æ¬¡ç´¢å¼•æ‰«æï¼Œç›´æ¥è¿”å›æ•°æ®ï¼Œæ€§èƒ½é«˜ã€‚</p><p>å¦‚æœæŒ‰ç…§äºŒçº§ç´¢å¼•æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œè¿”å›çš„åˆ—ä¸­æ²¡æœ‰åˆ›å»ºç´¢å¼•ï¼Œæœ‰å¯èƒ½ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢ï¼Œå°½é‡é¿å…ä½¿ç”¨select *ï¼Œå°½é‡åœ¨è¿”å›çš„åˆ—ä¸­éƒ½åŒ…å«æ·»åŠ ç´¢å¼•çš„å­—æ®µ</p><h3 id="é¢è¯•å®˜ï¼šMYSQLè¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç†"><a href="#é¢è¯•å®˜ï¼šMYSQLè¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç†" class="headerlink" title="é¢è¯•å®˜ï¼šMYSQLè¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç† ?"></a><strong>é¢è¯•å®˜ï¼š</strong>MYSQLè¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç† ?</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¶…å¤§åˆ†é¡µä¸€èˆ¬éƒ½æ˜¯åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†limitåˆ†é¡µæŸ¥è¯¢ï¼Œå¹¶ä¸”éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œè¿™ä¸ªæ—¶å€™æ•ˆç‡å°±å¾ˆä½ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¦†ç›–ç´¢å¼•å’Œå­æŸ¥è¯¢æ¥è§£å†³</p><p>å…ˆåˆ†é¡µæŸ¥è¯¢æ•°æ®çš„idå­—æ®µï¼Œç¡®å®šäº†idä¹‹åï¼Œå†ç”¨å­æŸ¥è¯¢æ¥è¿‡æ»¤ï¼ŒåªæŸ¥è¯¢è¿™ä¸ªidåˆ—è¡¨ä¸­çš„æ•°æ®å°±å¯ä»¥äº†</p><p>å› ä¸ºæŸ¥è¯¢idçš„æ—¶å€™ï¼Œèµ°çš„è¦†ç›–ç´¢å¼•ï¼Œæ‰€ä»¥æ•ˆç‡å¯ä»¥æå‡å¾ˆå¤š</p><h3 id="é¢è¯•å®˜ï¼šç´¢å¼•åˆ›å»ºåŸåˆ™æœ‰å“ªäº›ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šç´¢å¼•åˆ›å»ºåŸåˆ™æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šç´¢å¼•åˆ›å»ºåŸåˆ™æœ‰å“ªäº›ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>ç´¢å¼•åˆ›å»ºåŸåˆ™æœ‰å“ªäº›ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¿™ä¸ªæƒ…å†µæœ‰å¾ˆå¤šï¼Œä¸è¿‡éƒ½æœ‰ä¸€ä¸ªå¤§å‰æï¼Œå°±æ˜¯è¡¨ä¸­çš„æ•°æ®è¦è¶…è¿‡10ä¸‡ä»¥ä¸Šï¼Œæˆ‘ä»¬æ‰ä¼šåˆ›å»ºç´¢å¼•ï¼Œå¹¶ä¸”æ·»åŠ ç´¢å¼•çš„å­—æ®µæ˜¯æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„å­—æ®µï¼Œä¸€èˆ¬ä¹Ÿæ˜¯åƒä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œæ’åºå­—æ®µæˆ–åˆ†ç»„çš„å­—æ®µè¿™äº›ã€‚</p><p>è¿˜æœ‰å°±æ˜¯ï¼Œæˆ‘ä»¬é€šå¸¸åˆ›å»ºç´¢å¼•çš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨å¤åˆç´¢å¼•æ¥åˆ›å»ºï¼Œä¸€æ¡sqlçš„è¿”å›å€¼ï¼Œå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¦‚æœå­—æ®µçš„åŒºåˆ†åº¦ä¸é«˜çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæŠŠå®ƒæ”¾åœ¨ç»„åˆç´¢å¼•åé¢çš„å­—æ®µã€‚</p><p>å¦‚æœæŸä¸€ä¸ªå­—æ®µçš„å†…å®¹è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¼šè€ƒè™‘ä½¿ç”¨å‰ç¼€ç´¢å¼•æ¥ä½¿ç”¨ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰çš„å­—æ®µéƒ½è¦æ·»åŠ ç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•çš„æ•°é‡ä¹Ÿè¦æ§åˆ¶ï¼Œå› ä¸ºæ·»åŠ ç´¢å¼•ä¹Ÿä¼šå¯¼è‡´æ–°å¢æ”¹çš„é€Ÿåº¦å˜æ…¢ã€‚</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ ?"></a><strong>é¢è¯•å®˜ï¼š</strong>ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ ?</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¿™ä¸ªæƒ…å†µæ¯”è¾ƒå¤šï¼Œæˆ‘è¯´ä¸€äº›è‡ªå·±çš„ç»éªŒï¼Œä»¥å‰é‡åˆ°è¿‡çš„</p><p>æ¯”å¦‚ï¼Œç´¢å¼•åœ¨ä½¿ç”¨çš„æ—¶å€™æ²¡æœ‰éµå¾ªæœ€å·¦åŒ¹é…æ³•åˆ™ï¼Œç¬¬äºŒä¸ªæ˜¯ï¼Œæ¨¡ç³ŠæŸ¥è¯¢ï¼Œå¦‚æœ%å·åœ¨å‰é¢ä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚å¦‚æœåœ¨æ·»åŠ ç´¢å¼•çš„å­—æ®µä¸Šè¿›è¡Œäº†è¿ç®—æ“ä½œæˆ–è€…ç±»å‹è½¬æ¢ä¹Ÿéƒ½ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</p><p>æˆ‘ä»¬ä¹‹å‰è¿˜é‡åˆ°è¿‡ä¸€ä¸ªå°±æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†å¤åˆç´¢å¼•ï¼Œä¸­é—´ä½¿ç”¨äº†èŒƒå›´æŸ¥è¯¢ï¼Œå³è¾¹çš„æ¡ä»¶ç´¢å¼•ä¹Ÿä¼šå¤±æ•ˆ</p><p>æ‰€ä»¥ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæƒ³è¦åˆ¤æ–­å‡ºè¿™æ¡sqlæ˜¯å¦æœ‰ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨explainæ‰§è¡Œè®¡åˆ’æ¥åˆ†æ</p><h3 id="é¢è¯•å®˜ï¼šsqlçš„ä¼˜åŒ–çš„ç»éªŒ"><a href="#é¢è¯•å®˜ï¼šsqlçš„ä¼˜åŒ–çš„ç»éªŒ" class="headerlink" title="é¢è¯•å®˜ï¼šsqlçš„ä¼˜åŒ–çš„ç»éªŒ"></a><strong>é¢è¯•å®˜ï¼š</strong>sqlçš„ä¼˜åŒ–çš„ç»éªŒ</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¿™ä¸ªåœ¨é¡¹ç›®è¿˜æ˜¯æŒºå¸¸è§çš„ï¼Œå½“ç„¶å¦‚æœç›´è¯´sqlä¼˜åŒ–çš„è¯ï¼Œæˆ‘ä»¬ä¼šä»è¿™å‡ æ–¹é¢è€ƒè™‘ï¼Œæ¯”å¦‚</p><p>å»ºè¡¨çš„æ—¶å€™ã€ä½¿ç”¨ç´¢å¼•ã€sqlè¯­å¥çš„ç¼–å†™ã€ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å¦‚æœé‡æ¯”è¾ƒå¤§çš„è¯ï¼Œå¯ä»¥è€ƒè™‘åˆ†åº“åˆ†è¡¨</p><h3 id="é¢è¯•å®˜ï¼šåˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œä½ ä»¬æ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šåˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œä½ ä»¬æ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šåˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œä½ ä»¬æ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œä½ ä»¬æ˜¯å¦‚ä½•ä¼˜åŒ–çš„å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>è¿™ä¸ªæˆ‘ä»¬ä¸»è¦å‚è€ƒçš„é˜¿é‡Œå‡ºçš„é‚£ä¸ªå¼€å‘æ‰‹å†Œã€Šåµ©å±±ç‰ˆã€‹ï¼Œå°±æ¯”å¦‚ï¼Œåœ¨å®šä¹‰å­—æ®µçš„æ—¶å€™éœ€è¦ç»“åˆå­—æ®µçš„å†…å®¹æ¥é€‰æ‹©åˆé€‚çš„ç±»å‹ï¼Œå¦‚æœæ˜¯æ•°å€¼çš„è¯ï¼Œåƒtinyintã€int ã€bigintè¿™äº›ç±»å‹ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä¹Ÿæ˜¯ç»“åˆå­˜å‚¨çš„å†…å®¹æ¥é€‰æ‹©charå’Œvarcharæˆ–è€…textç±»å‹</p><h3 id="é¢è¯•å®˜ï¼šé‚£åœ¨ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé‚£åœ¨ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£åœ¨ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>é‚£åœ¨ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>ã€å‚è€ƒç´¢å¼•åˆ›å»ºåŸåˆ™    è¿›è¡Œæè¿°ã€‘</p><h3 id="é¢è¯•å®˜ï¼šä½ å¹³æ—¶å¯¹sqlè¯­å¥åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä½ å¹³æ—¶å¯¹sqlè¯­å¥åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä½ å¹³æ—¶å¯¹sqlè¯­å¥åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>ä½ å¹³æ—¶å¯¹sqlè¯­å¥åšäº†å“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¿™ä¸ªä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚SELECTè¯­å¥åŠ¡å¿…æŒ‡æ˜å­—æ®µåç§°ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨select * ï¼Œè¿˜æœ‰å°±æ˜¯è¦æ³¨æ„SQLè¯­å¥é¿å…é€ æˆç´¢å¼•å¤±æ•ˆçš„å†™æ³•ï¼›å¦‚æœæ˜¯èšåˆæŸ¥è¯¢ï¼Œå°½é‡ç”¨union allä»£æ›¿union ï¼Œunionä¼šå¤šä¸€æ¬¡è¿‡æ»¤ï¼Œæ•ˆç‡æ¯”è¾ƒä½ï¼›å¦‚æœæ˜¯è¡¨å…³è”çš„è¯ï¼Œå°½é‡ä½¿ç”¨innerjoin ï¼Œä¸è¦ä½¿ç”¨ç”¨left join right joinï¼Œå¦‚å¿…é¡»ä½¿ç”¨ ä¸€å®šè¦ä»¥å°è¡¨ä¸ºé©±åŠ¨</p><h3 id="é¢è¯•å®˜ï¼šäº‹åŠ¡çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥è¯¦ç»†è¯´ä¸€ä¸‹å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šäº‹åŠ¡çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥è¯¦ç»†è¯´ä¸€ä¸‹å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šäº‹åŠ¡çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥è¯¦ç»†è¯´ä¸€ä¸‹å—ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼š</strong>äº‹åŠ¡çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥è¯¦ç»†è¯´ä¸€ä¸‹å—ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯ï¼Œè¿™ä¸ªæ¯”è¾ƒæ¸…æ¥šï¼ŒACIDï¼Œåˆ†åˆ«æŒ‡çš„æ˜¯ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼›æˆ‘ä¸¾ä¸ªä¾‹å­ï¼š</p><p>Aå‘Bè½¬è´¦500ï¼Œè½¬è´¦æˆåŠŸï¼ŒAæ‰£é™¤500å…ƒï¼ŒBå¢åŠ 500å…ƒï¼ŒåŸå­æ“ä½œä½“ç°åœ¨è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥</p><p>åœ¨è½¬è´¦çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®è¦ä¸€è‡´ï¼ŒAæ‰£é™¤äº†500ï¼ŒBå¿…é¡»å¢åŠ 500</p><p>åœ¨è½¬è´¦çš„è¿‡ç¨‹ä¸­ï¼Œéš”ç¦»æ€§ä½“ç°åœ¨AåƒBè½¬è´¦ï¼Œä¸èƒ½å—å…¶ä»–äº‹åŠ¡å¹²æ‰°</p><p>åœ¨è½¬è´¦çš„è¿‡ç¨‹ä¸­ï¼ŒæŒä¹…æ€§ä½“ç°åœ¨äº‹åŠ¡æäº¤åï¼Œè¦æŠŠæ•°æ®æŒä¹…åŒ–ï¼ˆå¯ä»¥è¯´æ˜¯è½ç›˜æ“ä½œï¼‰</p><h3 id="é¢è¯•å®˜ï¼šå¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå¹¶å‘äº‹åŠ¡å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>æˆ‘ä»¬åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿›è¡Œæ˜¯ç»å¸¸å‘ç”Ÿçš„ï¼Œå¹¶å‘ä¹Ÿæ˜¯å¿…ç„¶çš„ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜</p><p>ç¬¬ä¸€æ˜¯è„è¯»ï¼Œ å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œå› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°çš„è¿™ä¸ªæ•°æ®æ˜¯â€œè„æ•°æ®â€ï¼Œä¾æ®â€œè„æ•°æ®â€æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚</p><p>ç¬¬äºŒæ˜¯ä¸å¯é‡å¤è¯»ï¼šæ¯”å¦‚åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚è¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚</p><p>ç¬¬ä¸‰æ˜¯å¹»è¯»ï¼ˆPhantom readï¼‰ï¼šå¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡ï¼ˆT2ï¼‰æ’å…¥äº†ä¸€äº›æ•°æ®æ—¶ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸ºå¹»è¯»ã€‚</p><h3 id="é¢è¯•å®˜ï¼šæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜å‘¢ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜å‘¢ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜å‘¢ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜å‘¢ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šè§£å†³æ–¹æ¡ˆæ˜¯å¯¹äº‹åŠ¡è¿›è¡Œéš”ç¦»</p><p>MySQLæ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼Œåˆ†åˆ«æœ‰ï¼š</p><p>ç¬¬ä¸€ä¸ªæ˜¯ï¼Œæœªæäº¤è¯»ï¼ˆread uncommittedï¼‰å®ƒè§£å†³ä¸äº†åˆšæ‰æå‡ºçš„æ‰€æœ‰é—®é¢˜ï¼Œä¸€èˆ¬é¡¹ç›®ä¸­ä¹Ÿä¸ç”¨è¿™ä¸ªã€‚ç¬¬äºŒä¸ªæ˜¯è¯»å·²æäº¤ï¼ˆread committedï¼‰å®ƒèƒ½è§£å†³è„è¯»çš„é—®é¢˜çš„ï¼Œä½†æ˜¯è§£å†³ä¸äº†ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚ç¬¬ä¸‰ä¸ªæ˜¯å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å®ƒèƒ½è§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯è§£å†³ä¸äº†å¹»è¯»ï¼Œè¿™ä¸ªä¹Ÿæ˜¯mysqlé»˜è®¤çš„éš”ç¦»çº§åˆ«ã€‚ç¬¬å››ä¸ªæ˜¯ä¸²è¡ŒåŒ–ï¼ˆserializableï¼‰å®ƒå¯ä»¥è§£å†³åˆšæ‰æå‡ºæ¥çš„æ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç”±äºè®©æ˜¯äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ€§èƒ½æ¯”è¾ƒä½ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨çš„éƒ½æ˜¯mysqlé»˜è®¤çš„éš”ç¦»çº§åˆ«:å¯é‡å¤è¯»</p><h3 id="é¢è¯•å®˜ï¼šundo-logå’Œredo-logçš„åŒºåˆ«"><a href="#é¢è¯•å®˜ï¼šundo-logå’Œredo-logçš„åŒºåˆ«" class="headerlink" title="é¢è¯•å®˜ï¼šundo logå’Œredo logçš„åŒºåˆ«"></a><strong>é¢è¯•å®˜</strong>ï¼šundo logå’Œredo logçš„åŒºåˆ«</h3><p><strong>å€™é€‰äºº</strong>ï¼šå¥½çš„ï¼Œå…¶ä¸­redo logæ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼ŒæœåŠ¡å®•æœºå¯ç”¨æ¥åŒæ­¥æ•°æ®ï¼Œè€Œundo log ä¸åŒï¼Œå®ƒä¸»è¦è®°å½•çš„æ˜¯é€»è¾‘æ—¥å¿—ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œé€šè¿‡é€†æ“ä½œæ¢å¤åŸæ¥çš„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ é™¤ä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨undo logæ—¥å¿—æ–‡ä»¶ä¸­æ–°å¢ä¸€æ¡deleteè¯­å¥ï¼Œå¦‚æœå‘ç”Ÿå›æ»šå°±æ‰§è¡Œé€†æ“ä½œï¼›</p><p>redo logä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œundo logä¿è¯äº†äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€è‡´æ€§</p><h3 id="é¢è¯•å®˜ï¼šäº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ-ä½ è§£é‡Šä¸€ä¸‹MVCC"><a href="#é¢è¯•å®˜ï¼šäº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ-ä½ è§£é‡Šä¸€ä¸‹MVCC" class="headerlink" title="é¢è¯•å®˜ï¼šäº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ(ä½ è§£é‡Šä¸€ä¸‹MVCC)"></a><strong>é¢è¯•å®˜</strong>ï¼šäº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ(ä½ è§£é‡Šä¸€ä¸‹MVCC)</h3><p><strong>å€™é€‰äºº</strong>ï¼šäº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”±é”å’Œmvccå®ç°çš„ã€‚</p><p>å…¶ä¸­mvccçš„æ„æ€æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚æŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå®ƒçš„åº•å±‚å®ç°ä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªæ˜¯éšè—å­—æ®µï¼Œç¬¬äºŒä¸ªæ˜¯undo logæ—¥å¿—ï¼Œç¬¬ä¸‰ä¸ªæ˜¯readViewè¯»è§†å›¾</p><p>éšè—å­—æ®µæ˜¯æŒ‡ï¼šåœ¨mysqlä¸­ç»™æ¯ä¸ªè¡¨éƒ½è®¾ç½®äº†éšè—å­—æ®µï¼Œæœ‰ä¸€ä¸ªæ˜¯trx_id(äº‹åŠ¡id)ï¼Œè®°å½•æ¯ä¸€æ¬¡æ“ä½œçš„äº‹åŠ¡idï¼Œæ˜¯è‡ªå¢çš„ï¼›å¦ä¸€ä¸ªå­—æ®µæ˜¯roll_pointer(å›æ»šæŒ‡é’ˆ)ï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„äº‹åŠ¡ç‰ˆæœ¬è®°å½•åœ°å€</p><p>undo logä¸»è¦çš„ä½œç”¨æ˜¯è®°å½•å›æ»šæ—¥å¿—ï¼Œå­˜å‚¨è€ç‰ˆæœ¬æ•°æ®ï¼Œåœ¨å†…éƒ¨ä¼šå½¢æˆä¸€ä¸ªç‰ˆæœ¬é“¾ï¼Œåœ¨å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ“ä½œæŸä¸€è¡Œè®°å½•ï¼Œè®°å½•ä¸åŒäº‹åŠ¡ä¿®æ”¹æ•°æ®çš„ç‰ˆæœ¬ï¼Œé€šè¿‡roll_pointeræŒ‡é’ˆå½¢æˆä¸€ä¸ªé“¾è¡¨</p><p>readViewè§£å†³çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢é€‰æ‹©ç‰ˆæœ¬çš„é—®é¢˜ï¼Œåœ¨å†…éƒ¨å®šä¹‰äº†ä¸€äº›åŒ¹é…è§„åˆ™å’Œå½“å‰çš„ä¸€äº›äº‹åŠ¡idåˆ¤æ–­è¯¥è®¿é—®é‚£ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸åŒçš„éš”ç¦»çº§åˆ«å¿«ç…§è¯»æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€ç»ˆçš„è®¿é—®çš„ç»“æœä¸ä¸€æ ·ã€‚å¦‚æœæ˜¯rcéš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œå¦‚æœæ˜¯rréš”ç¦»çº§åˆ«ä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨</p><h3 id="é¢è¯•å®˜ï¼šMySQLä¸»ä»åŒæ­¥åŸç†"><a href="#é¢è¯•å®˜ï¼šMySQLä¸»ä»åŒæ­¥åŸç†" class="headerlink" title="é¢è¯•å®˜ï¼šMySQLä¸»ä»åŒæ­¥åŸç†"></a><strong>é¢è¯•å®˜</strong>ï¼šMySQLä¸»ä»åŒæ­¥åŸç†</h3><p><strong>å€™é€‰äºº</strong>ï¼šMySQLä¸»ä»å¤åˆ¶çš„æ ¸å¿ƒå°±æ˜¯äºŒè¿›åˆ¶æ—¥å¿—(DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰è¯­å¥)ï¼Œå®ƒçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š</p><p>ç¬¬ä¸€ï¼šä¸»åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ä¸­ã€‚</p><p>ç¬¬äºŒï¼šä»åº“è¯»å–ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ï¼Œå†™å…¥åˆ°ä»åº“çš„ä¸­ç»§æ—¥å¿— Relay Log ã€‚</p><p>ç¬¬ä¸‰ï¼šä»åº“é‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åæ˜ å®ƒè‡ªå·±çš„æ•°æ®</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ç”¨è¿‡MySQLçš„åˆ†åº“åˆ†è¡¨å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ç”¨è¿‡MySQLçš„åˆ†åº“åˆ†è¡¨å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬é¡¹ç›®ç”¨è¿‡MySQLçš„åˆ†åº“åˆ†è¡¨å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šä½ ä»¬é¡¹ç›®ç”¨è¿‡MySQLçš„åˆ†åº“åˆ†è¡¨å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½æ˜¯å¾®æœåŠ¡å¼€å‘ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¯¹åº”äº†ä¸€ä¸ªæ•°æ®åº“ï¼Œæ˜¯æ ¹æ®ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†çš„ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯å‚ç›´æ‹†åˆ†ã€‚</p><h3 id="é¢è¯•å®˜ï¼šé‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªæ˜¯ä½¿ç”¨è¿‡çš„ï¼Œæˆ‘ä»¬å½“æ—¶çš„ä¸šåŠ¡æ˜¯(xxx)ï¼Œä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å•åº“ï¼Œåæ¥è¿™ä¸ªä¸šåŠ¡é€æ¸å‘å±•ï¼Œä¸šåŠ¡é‡ä¸Šæ¥çš„å¾ˆè¿…é€Ÿï¼Œå…¶ä¸­(xx)è¡¨å·²ç»å­˜æ”¾äº†è¶…è¿‡1000ä¸‡çš„æ•°æ®ï¼Œæˆ‘ä»¬åšäº†å¾ˆå¤šä¼˜åŒ–ä¹Ÿä¸å¥½ä½¿ï¼Œæ€§èƒ½ä¾ç„¶å¾ˆæ…¢ï¼Œæ‰€ä»¥å½“æ—¶å°±ä½¿ç”¨äº†æ°´å¹³åˆ†åº“ã€‚</p><p>æˆ‘ä»¬ä¸€å¼€å§‹å…ˆåšäº†3å°æœåŠ¡å™¨å¯¹åº”äº†3ä¸ªæ•°æ®åº“ï¼Œç”±äºåº“å¤šäº†ï¼Œéœ€è¦åˆ†ç‰‡ï¼Œæˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„mycatæ¥ä½œä¸ºæ•°æ®åº“çš„ä¸­é—´ä»¶ã€‚æ•°æ®éƒ½æ˜¯æŒ‰ç…§idï¼ˆè‡ªå¢ï¼‰å–æ¨¡çš„æ–¹å¼æ¥å­˜å–çš„ã€‚</p><p>å½“ç„¶ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œé‚£äº›æ—§æ•°æ®ï¼Œæˆ‘ä»¬åšäº†ä¸€äº›æ¸…æ´—çš„å·¥ä½œï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯æŒ‰ç…§idå–æ¨¡è§„åˆ™åˆ†åˆ«å­˜å‚¨åˆ°äº†å„ä¸ªæ•°æ®åº“ä¸­ï¼Œå¥½å¤„å°±æ˜¯å¯ä»¥è®©å„ä¸ªæ•°æ®åº“åˆ†æ‘Šå­˜å‚¨å’Œè¯»å–çš„å‹åŠ›ï¼Œè§£å†³äº†æˆ‘ä»¬å½“æ—¶æ€§èƒ½çš„é—®é¢˜</p></blockquote>]]></content>
    
    
    <summary type="html">å¯¹é¢è¯•æé—®mysqlçš„å›ç­”</summary>
    
    
    
    <category term="mysql" scheme="https://www.jodio.cc/categories/mysql/"/>
    
    
    <category term="mysql" scheme="https://www.jodio.cc/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>InterView(ä¸€) -- Redisç¯‡</title>
    <link href="https://www.jodio.cc/posts/new_redis.html"/>
    <id>https://www.jodio.cc/posts/new_redis.html</id>
    <published>2023-04-18T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Redisç›¸å…³é¢è¯•é¢˜"><a href="#Redisç›¸å…³é¢è¯•é¢˜" class="headerlink" title="Redisç›¸å…³é¢è¯•é¢˜"></a>Redisç›¸å…³é¢è¯•é¢˜</h2><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€-æ€ä¹ˆè§£å†³"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€-æ€ä¹ˆè§£å†³" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ ? æ€ä¹ˆè§£å†³ ?"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ ? æ€ä¹ˆè§£å†³ ?</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~~ï¼Œæˆ‘æƒ³ä¸€ä¸‹</p><p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®š<strong>ä¸å­˜åœ¨</strong>çš„æ•°æ®ï¼Œå¦‚æœä»å­˜å‚¨å±‚æŸ¥ä¸åˆ°æ•°æ®åˆ™ä¸å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ° DB å»æŸ¥è¯¢ï¼Œå¯èƒ½å¯¼è‡´ DB æŒ‚æ‰ã€‚è¿™ç§æƒ…å†µå¤§æ¦‚ç‡æ˜¯é­åˆ°äº†æ”»å‡»ã€‚</p><p>è§£å†³æ–¹æ¡ˆçš„è¯ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¼šç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥è§£å†³å®ƒ</p><h3 id="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œä½ èƒ½ä»‹ç»ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¥½çš„ï¼Œä½ èƒ½ä»‹ç»ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œä½ èƒ½ä»‹ç»ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå¥½çš„ï¼Œä½ èƒ½ä»‹ç»ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œæ˜¯è¿™æ ·~</p><p>å¸ƒéš†è¿‡æ»¤å™¨ä¸»è¦æ˜¯ç”¨äºæ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚æˆ‘ä»¬å½“æ—¶ä½¿ç”¨çš„æ˜¯redissonå®ç°çš„å¸ƒéš†è¿‡æ»¤å™¨ã€‚</p><p>å®ƒçš„åº•å±‚ä¸»è¦æ˜¯å…ˆå»åˆå§‹åŒ–ä¸€ä¸ªæ¯”è¾ƒå¤§æ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾çš„äºŒè¿›åˆ¶0æˆ–1ã€‚åœ¨ä¸€å¼€å§‹éƒ½æ˜¯0ï¼Œå½“ä¸€ä¸ªkeyæ¥äº†ä¹‹åç»è¿‡3æ¬¡hashè®¡ç®—ï¼Œæ¨¡äºæ•°ç»„é•¿åº¦æ‰¾åˆ°æ•°æ®çš„ä¸‹æ ‡ç„¶åæŠŠæ•°ç»„ä¸­åŸæ¥çš„0æ”¹ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œä¸‰ä¸ªæ•°ç»„çš„ä½ç½®å°±èƒ½æ ‡æ˜ä¸€ä¸ªkeyçš„å­˜åœ¨ã€‚æŸ¥æ‰¾çš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>å½“ç„¶æ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æœ‰å¯èƒ½ä¼šäº§ç”Ÿä¸€å®šçš„è¯¯åˆ¤ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥è®¾ç½®è¿™ä¸ªè¯¯åˆ¤ç‡ï¼Œå¤§æ¦‚ä¸ä¼šè¶…è¿‡5%ï¼Œå…¶å®è¿™ä¸ªè¯¯åˆ¤æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œè¦ä¸å°±å¾—å¢åŠ æ•°ç»„çš„é•¿åº¦ï¼Œå…¶å®å·²ç»ç®—æ˜¯å¾ˆåˆ’åˆ†äº†ï¼Œ5%ä»¥å†…çš„è¯¯åˆ¤ç‡ä¸€èˆ¬çš„é¡¹ç›®ä¹Ÿèƒ½æ¥å—ï¼Œä¸è‡³äºé«˜å¹¶å‘ä¸‹å‹å€’æ•°æ®åº“ã€‚</p><h3 id="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿-æ€ä¹ˆè§£å†³"><a href="#é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿-æ€ä¹ˆè§£å†³" class="headerlink" title="é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ ? æ€ä¹ˆè§£å†³ ?"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ ? æ€ä¹ˆè§£å†³ ?</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼ï¼</p><p>ç¼“å­˜å‡»ç©¿çš„æ„æ€æ˜¯å¯¹äºè®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyï¼Œç¼“å­˜åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½è¿™æ—¶é—´ç‚¹å¯¹è¿™ä¸ªKeyæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯ DB åŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠ DB å‹å®ã€‚</p><p>è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>ç¬¬ä¸€å¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼šå½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¸ç«‹å³å»load dbï¼Œå…ˆä½¿ç”¨å¦‚ Redis çš„ setnx å»è®¾ç½®ä¸€ä¸ªäº’æ–¥é”ï¼Œå½“æ“ä½œæˆåŠŸè¿”å›æ—¶å†è¿›è¡Œ load dbçš„æ“ä½œå¹¶å›è®¾ç¼“å­˜ï¼Œå¦åˆ™é‡è¯•getç¼“å­˜çš„æ–¹æ³•</p><p>ç¬¬äºŒç§æ–¹æ¡ˆå¯ä»¥è®¾ç½®å½“å‰keyé€»è¾‘è¿‡æœŸï¼Œå¤§æ¦‚æ˜¯æ€è·¯å¦‚ä¸‹ï¼š</p><p>â‘ ï¼šåœ¨è®¾ç½®keyçš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´å­—æ®µä¸€å—å­˜å…¥ç¼“å­˜ä¸­ï¼Œä¸ç»™å½“å‰keyè®¾ç½®è¿‡æœŸæ—¶é—´</p><p>â‘¡ï¼šå½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œä»rediså–å‡ºæ•°æ®ååˆ¤æ–­æ—¶é—´æ˜¯å¦è¿‡æœŸ</p><p>â‘¢ï¼šå¦‚æœè¿‡æœŸåˆ™å¼€é€šå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå½“å‰çº¿ç¨‹æ­£å¸¸è¿”å›æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¸æ˜¯æœ€æ–°</p><p>å½“ç„¶ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼š</p><p>å¦‚æœé€‰æ‹©æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œå»ºè®®ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œæ€§èƒ½ä¸Šå¯èƒ½æ²¡é‚£ä¹ˆé«˜ï¼Œé”éœ€è¦ç­‰ï¼Œä¹Ÿæœ‰å¯èƒ½äº§ç”Ÿæ­»é”çš„é—®é¢˜</p><p>å¦‚æœé€‰æ‹©keyçš„é€»è¾‘åˆ é™¤ï¼Œåˆ™ä¼˜å…ˆè€ƒè™‘çš„é«˜å¯ç”¨æ€§ï¼Œæ€§èƒ½æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯æ•°æ®åŒæ­¥è¿™å—åšä¸åˆ°å¼ºä¸€è‡´ã€‚</p><h3 id="é¢è¯•å®˜ï¼š-ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©-æ€ä¹ˆè§£å†³"><a href="#é¢è¯•å®˜ï¼š-ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©-æ€ä¹ˆè§£å†³" class="headerlink" title="é¢è¯•å®˜ï¼š**ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´© ? æ€ä¹ˆè§£å†³ ?"></a><strong>é¢è¯•å®˜</strong>ï¼š**ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´© ? æ€ä¹ˆè§£å†³ ?</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼ï¼</p><p>ç¼“å­˜é›ªå´©æ„æ€æ˜¯è®¾ç½®ç¼“å­˜æ—¶é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°DBï¼ŒDB ç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚ä¸ç¼“å­˜å‡»ç©¿çš„åŒºåˆ«ï¼šé›ªå´©æ˜¯å¾ˆå¤škeyï¼Œå‡»ç©¿æ˜¯æŸä¸€ä¸ªkeyç¼“å­˜ã€‚</p><p>è§£å†³æ–¹æ¡ˆä¸»è¦æ˜¯å¯ä»¥å°†ç¼“å­˜å¤±æ•ˆæ—¶é—´åˆ†æ•£å¼€ï¼Œæ¯”å¦‚å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœºï¼Œè¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶ã€‚</p><blockquote><h3 id="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰"><a href="#é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰" class="headerlink" title="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>redisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼å°±è¯´æˆ‘æœ€è¿‘åšçš„è¿™ä¸ªé¡¹ç›®ï¼Œé‡Œé¢æœ‰xxxxï¼ˆ<strong>æ ¹æ®è‡ªå·±çš„ç®€å†ä¸Šå†™</strong>ï¼‰çš„åŠŸèƒ½ï¼Œéœ€è¦è®©æ•°æ®åº“ä¸redisé«˜åº¦ä¿æŒä¸€è‡´ï¼Œå› ä¸ºè¦æ±‚æ—¶æ•ˆæ€§æ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„è¯»å†™é”ä¿è¯çš„å¼ºä¸€è‡´æ€§ã€‚</p><p>æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯redissonå®ç°çš„è¯»å†™é”ï¼Œåœ¨è¯»çš„æ—¶å€™æ·»åŠ å…±äº«é”ï¼Œå¯ä»¥ä¿è¯è¯»è¯»ä¸äº’æ–¥ï¼Œè¯»å†™äº’æ–¥ã€‚å½“æˆ‘ä»¬æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œæ·»åŠ æ’ä»–é”ï¼Œå®ƒæ˜¯è¯»å†™ï¼Œè¯»è¯»éƒ½äº’æ–¥ï¼Œè¿™æ ·å°±èƒ½ä¿è¯åœ¨å†™æ•°æ®çš„åŒæ—¶æ˜¯ä¸ä¼šè®©å…¶ä»–çº¿ç¨‹è¯»æ•°æ®çš„ï¼Œé¿å…äº†è„æ•°æ®ã€‚è¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯è¯»æ–¹æ³•å’Œå†™æ–¹æ³•ä¸Šéœ€è¦ä½¿ç”¨åŒä¸€æŠŠé”æ‰è¡Œã€‚</p><h3 id="é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªæ’ä»–é”æ˜¯å¦‚ä½•ä¿è¯è¯»å†™ã€è¯»è¯»äº’æ–¥çš„å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªæ’ä»–é”æ˜¯å¦‚ä½•ä¿è¯è¯»å†™ã€è¯»è¯»äº’æ–¥çš„å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£è¿™ä¸ªæ’ä»–é”æ˜¯å¦‚ä½•ä¿è¯è¯»å†™ã€è¯»è¯»äº’æ–¥çš„å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>é‚£è¿™ä¸ªæ’ä»–é”æ˜¯å¦‚ä½•ä¿è¯è¯»å†™ã€è¯»è¯»äº’æ–¥çš„å‘¢ï¼Ÿ</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šå…¶å®æ’ä»–é”åº•å±‚ä½¿ç”¨ä¹Ÿæ˜¯setnxï¼Œä¿è¯äº†åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œé”ä½çš„æ–¹æ³•</p><p><strong>é¢è¯•å®˜</strong>ï¼šä½ å¬è¯´è¿‡å»¶æ—¶åŒåˆ å—ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨å®ƒå‘¢ï¼Ÿ</p><p><strong>å€™é€‰äºº</strong>ï¼šå»¶è¿ŸåŒåˆ ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œæˆ‘ä»¬å…ˆæŠŠç¼“å­˜ä¸­çš„æ•°æ®åˆ é™¤ï¼Œç„¶åæ›´æ–°æ•°æ®åº“ï¼Œæœ€åå†å»¶æ—¶åˆ é™¤ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå…¶ä¸­è¿™ä¸ªå»¶æ—¶å¤šä¹…ä¸å¤ªå¥½ç¡®å®šï¼Œåœ¨å»¶æ—¶çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°è„æ•°æ®ï¼Œå¹¶ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥æ²¡æœ‰é‡‡ç”¨å®ƒã€‚</p><h3 id="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰-1"><a href="#é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰-1" class="headerlink" title="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>redisåšä¸ºç¼“å­˜ï¼Œmysqlçš„æ•°æ®å¦‚ä½•ä¸redisè¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿï¼ˆåŒå†™ä¸€è‡´æ€§ï¼‰</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼å°±è¯´æˆ‘æœ€è¿‘åšçš„è¿™ä¸ªé¡¹ç›®ï¼Œé‡Œé¢æœ‰xxxxï¼ˆ<strong>æ ¹æ®è‡ªå·±çš„ç®€å†ä¸Šå†™</strong>ï¼‰çš„åŠŸèƒ½ï¼Œæ•°æ®åŒæ­¥å¯ä»¥æœ‰ä¸€å®šçš„å»¶æ—¶ï¼ˆç¬¦åˆå¤§éƒ¨åˆ†ä¸šåŠ¡ï¼‰</p><p>æˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„é˜¿é‡Œçš„canalç»„ä»¶å®ç°æ•°æ®åŒæ­¥ï¼šä¸éœ€è¦æ›´æ”¹ä¸šåŠ¡ä»£ç ï¼Œéƒ¨ç½²ä¸€ä¸ªcanalæœåŠ¡ã€‚canalæœåŠ¡æŠŠè‡ªå·±ä¼ªè£…æˆmysqlçš„ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå½“mysqlæ•°æ®æ›´æ–°ä»¥åï¼Œcanalä¼šè¯»å–binlogæ•°æ®ï¼Œç„¶ååœ¨é€šè¿‡canalçš„å®¢æˆ·ç«¯è·å–åˆ°æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜å³å¯ã€‚</p><h3 id="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œæ•°æ®çš„æŒä¹…åŒ–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œæ•°æ®çš„æŒä¹…åŒ–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œæ•°æ®çš„æŒä¹…åŒ–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼šredisåšä¸ºç¼“å­˜ï¼Œæ•°æ®çš„æŒä¹…åŒ–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šåœ¨Redisä¸­æä¾›äº†ä¸¤ç§æ•°æ®æŒä¹…åŒ–çš„æ–¹å¼ï¼š1ã€RDB  2ã€AOF</p><h3 id="é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼š<strong>è¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šRDBæ˜¯ä¸€ä¸ªå¿«ç…§æ–‡ä»¶ï¼Œå®ƒæ˜¯æŠŠrediså†…å­˜å­˜å‚¨çš„æ•°æ®å†™åˆ°ç£ç›˜ä¸Šï¼Œå½“rediså®ä¾‹å®•æœºæ¢å¤æ•°æ®çš„æ—¶å€™ï¼Œæ–¹ä¾¿ä»RDBçš„å¿«ç…§æ–‡ä»¶ä¸­æ¢å¤æ•°æ®ã€‚</p><p>AOFçš„å«ä¹‰æ˜¯è¿½åŠ æ–‡ä»¶ï¼Œå½“redisæ“ä½œå†™å‘½ä»¤çš„æ—¶å€™ï¼Œéƒ½ä¼šå­˜å‚¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå½“rediså®ä¾‹å®•æœºæ¢å¤æ•°æ®çš„æ—¶å€™ï¼Œä¼šä»è¿™ä¸ªæ–‡ä»¶ä¸­å†æ¬¡æ‰§è¡Œä¸€éå‘½ä»¤æ¥æ¢å¤æ•°æ®</p><h3 id="é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æ–¹å¼ï¼Œå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æ–¹å¼ï¼Œå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æ–¹å¼ï¼Œå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜ï¼šè¿™ä¸¤ç§æ–¹å¼ï¼Œå“ªç§æ¢å¤çš„æ¯”è¾ƒå¿«å‘¢ï¼Ÿ</strong></h3><p><strong>å€™é€‰äºº</strong>ï¼šRDBå› ä¸ºæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ä¿å­˜çš„æ—¶å€™ä½“ç§¯ä¹Ÿæ˜¯æ¯”è¾ƒå°çš„ï¼Œå®ƒæ¢å¤çš„æ¯”è¾ƒå¿«ï¼Œä½†æ˜¯å®ƒæœ‰å¯èƒ½ä¼šä¸¢æ•°æ®ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨é¡¹ç›®ä¸­ä¹Ÿä¼šä½¿ç”¨AOFæ¥æ¢å¤æ•°æ®ï¼Œè™½ç„¶AOFæ¢å¤çš„é€Ÿåº¦æ…¢ä¸€äº›ï¼Œä½†æ˜¯å®ƒä¸¢æ•°æ®çš„é£é™©è¦å°å¾ˆå¤šï¼Œåœ¨AOFæ–‡ä»¶ä¸­å¯ä»¥è®¾ç½®åˆ·ç›˜ç­–ç•¥ï¼Œæˆ‘ä»¬å½“æ—¶è®¾ç½®çš„å°±æ˜¯æ¯ç§’æ‰¹é‡å†™å…¥ä¸€æ¬¡å‘½ä»¤</p><h3 id="é¢è¯•å®˜ï¼šRedisçš„æ•°æ®è¿‡æœŸç­–ç•¥æœ‰å“ªäº›"><a href="#é¢è¯•å®˜ï¼šRedisçš„æ•°æ®è¿‡æœŸç­–ç•¥æœ‰å“ªäº›" class="headerlink" title="é¢è¯•å®˜ï¼šRedisçš„æ•°æ®è¿‡æœŸç­–ç•¥æœ‰å“ªäº› ?"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisçš„æ•°æ®è¿‡æœŸç­–ç•¥æœ‰å“ªäº› ?</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~ï¼Œåœ¨redisä¸­æä¾›äº†ä¸¤ç§æ•°æ®è¿‡æœŸåˆ é™¤ç­–ç•¥</p><p>ç¬¬ä¸€ç§æ˜¯æƒ°æ€§åˆ é™¤ï¼Œåœ¨è®¾ç½®è¯¥keyè¿‡æœŸæ—¶é—´åï¼Œæˆ‘ä»¬ä¸å»ç®¡å®ƒï¼Œå½“éœ€è¦è¯¥keyæ—¶ï¼Œæˆ‘ä»¬åœ¨æ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸï¼Œæˆ‘ä»¬å°±åˆ æ‰å®ƒï¼Œåä¹‹è¿”å›è¯¥keyã€‚</p><p>ç¬¬äºŒç§æ˜¯ å®šæœŸåˆ é™¤ï¼Œå°±æ˜¯è¯´æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å°±å¯¹ä¸€äº›keyè¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢è¿‡æœŸçš„key</p><p>å®šæœŸæ¸…ç†çš„ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>SLOWæ¨¡å¼æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10hzï¼Œæ¯æ¬¡ä¸è¶…è¿‡25msï¼Œä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶redis.conf çš„ <strong>hz</strong> é€‰é¡¹æ¥è°ƒæ•´è¿™ä¸ªæ¬¡æ•°</li><li>FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œæ¯æ¬¡äº‹ä»¶å¾ªç¯ä¼šå°è¯•æ‰§è¡Œï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms</li></ul><p>Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼š<strong>æƒ°æ€§åˆ é™¤ + å®šæœŸåˆ é™¤</strong>ä¸¤ç§ç­–ç•¥è¿›è¡Œé…åˆä½¿ç”¨ã€‚</p><h3 id="é¢è¯•å®˜ï¼šRedisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›"><a href="#é¢è¯•å®˜ï¼šRedisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›" class="headerlink" title="é¢è¯•å®˜ï¼šRedisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æœ‰å“ªäº› ?"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æœ‰å“ªäº› ?</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªåœ¨redisä¸­æä¾›äº†å¾ˆå¤šç§ï¼Œé»˜è®¤æ˜¯noevictionï¼Œä¸åˆ é™¤ä»»ä½•æ•°æ®ï¼Œå†…éƒ¨ä¸è¶³ç›´æ¥æŠ¥é”™</p><p>æ˜¯å¯ä»¥åœ¨redisçš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®çš„ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä¸€ä¸ªæ˜¯LRUï¼Œå¦å¤–ä¸€ä¸ªæ˜¯LFU</p><p>LRUçš„æ„æ€å°±æ˜¯æœ€å°‘æœ€è¿‘ä½¿ç”¨ï¼Œç”¨å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§åˆ™æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><p>LFUçš„æ„æ€æ˜¯æœ€å°‘é¢‘ç‡ä½¿ç”¨ã€‚ä¼šç»Ÿè®¡æ¯ä¸ªkeyçš„è®¿é—®é¢‘ç‡ï¼Œå€¼è¶Šå°æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜</p><p>æˆ‘ä»¬åœ¨é¡¹ç›®è®¾ç½®çš„allkeys-lruï¼ŒæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ï¼ŒæŠŠä¸€äº›ç»å¸¸è®¿é—®çš„keyç•™åœ¨redisä¸­</p><p><strong>é¢è¯•å®˜</strong>ï¼šæ•°æ®åº“æœ‰1000ä¸‡æ•°æ® ,Redisåªèƒ½ç¼“å­˜20wæ•°æ®, å¦‚ä½•ä¿è¯Redisä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ® ?</p><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œæˆ‘æƒ³ä¸€ä¸‹~~</p><p>å¯ä»¥ä½¿ç”¨ allkeys-lru ï¼ˆæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ï¼‰æ·˜æ±°ç­–ç•¥ï¼Œé‚£ç•™ä¸‹æ¥çš„éƒ½æ˜¯ç»å¸¸è®¿é—®çš„çƒ­ç‚¹æ•°æ®</p><h3 id="é¢è¯•å®˜ï¼šRedisçš„å†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šRedisçš„å†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šRedisçš„å†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisçš„å†…å­˜ç”¨å®Œäº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~ï¼Œè¿™ä¸ªè¦çœ‹redisçš„æ•°æ®æ·˜æ±°ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Œå¦‚æœæ˜¯é»˜è®¤çš„é…ç½®ï¼Œrediså†…å­˜ç”¨å®Œä»¥ååˆ™ç›´æ¥æŠ¥é”™ã€‚æˆ‘ä»¬å½“æ—¶è®¾ç½®çš„ allkeys-lru ç­–ç•¥ã€‚æŠŠæœ€è¿‘æœ€å¸¸è®¿é—®çš„æ•°æ®ç•™åœ¨ç¼“å­˜ä¸­ã€‚</p><h3 id="é¢è¯•å®˜ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç°"><a href="#é¢è¯•å®˜ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç°" class="headerlink" title="é¢è¯•å®˜ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç° ?"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisåˆ†å¸ƒå¼é”å¦‚ä½•å®ç° ?</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼Œåœ¨redisä¸­æä¾›äº†ä¸€ä¸ªå‘½ä»¤setnx(SET if not exists)</p><p>ç”±äºredisçš„å•çº¿ç¨‹çš„ï¼Œç”¨äº†å‘½ä»¤ä¹‹åï¼Œåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹æŸä¸€ä¸ªkeyè®¾ç½®å€¼ï¼Œåœ¨æ²¡æœ‰è¿‡æœŸæˆ–åˆ é™¤keyçš„æ—¶å€™æ˜¯å…¶ä»–å®¢æˆ·ç«¯æ˜¯ä¸èƒ½è®¾ç½®è¿™ä¸ªkeyçš„</p><h3 id="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œé‚£ä½ å¦‚ä½•æ§åˆ¶Rediså®ç°åˆ†å¸ƒå¼é”æœ‰æ•ˆæ—¶é•¿å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¥½çš„ï¼Œé‚£ä½ å¦‚ä½•æ§åˆ¶Rediså®ç°åˆ†å¸ƒå¼é”æœ‰æ•ˆæ—¶é•¿å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œé‚£ä½ å¦‚ä½•æ§åˆ¶Rediså®ç°åˆ†å¸ƒå¼é”æœ‰æ•ˆæ—¶é•¿å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå¥½çš„ï¼Œé‚£ä½ å¦‚ä½•æ§åˆ¶Rediså®ç°åˆ†å¸ƒå¼é”æœ‰æ•ˆæ—¶é•¿å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼Œçš„ç¡®ï¼Œredisçš„setnxæŒ‡ä»¤ä¸å¥½æ§åˆ¶è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„redisçš„ä¸€ä¸ªæ¡†æ¶redissonå®ç°çš„ã€‚</p><p>åœ¨redissonä¸­éœ€è¦æ‰‹åŠ¨åŠ é”ï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶é”çš„å¤±æ•ˆæ—¶é—´å’Œç­‰å¾…æ—¶é—´ï¼Œå½“é”ä½çš„ä¸€ä¸ªä¸šåŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆçš„æ—¶å€™ï¼Œåœ¨redissonä¸­å¼•å…¥äº†ä¸€ä¸ªçœ‹é—¨ç‹—æœºåˆ¶ï¼Œå°±æ˜¯è¯´æ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥å½“å‰ä¸šåŠ¡æ˜¯å¦è¿˜æŒæœ‰é”ï¼Œå¦‚æœæŒæœ‰å°±å¢åŠ åŠ é”çš„æŒæœ‰æ—¶é—´ï¼Œå½“ä¸šåŠ¡æ‰§è¡Œå®Œæˆä¹‹åéœ€è¦ä½¿ç”¨é‡Šæ”¾é”å°±å¯ä»¥äº†</p><p>è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œåœ¨é«˜å¹¶å‘ä¸‹ï¼Œä¸€ä¸ªä¸šåŠ¡æœ‰å¯èƒ½ä¼šæ‰§è¡Œå¾ˆå¿«ï¼Œå…ˆå®¢æˆ·1æŒæœ‰é”çš„æ—¶å€™ï¼Œå®¢æˆ·2æ¥äº†ä»¥åå¹¶ä¸ä¼šé©¬ä¸Šæ‹’ç»ï¼Œå®ƒä¼šè‡ªæ—‹ä¸æ–­å°è¯•è·å–é”ï¼Œå¦‚æœå®¢æˆ·1é‡Šæ”¾ä¹‹åï¼Œå®¢æˆ·2å°±å¯ä»¥é©¬ä¸ŠæŒæœ‰é”ï¼Œæ€§èƒ½ä¹Ÿå¾—åˆ°äº†æå‡ã€‚</p><h3 id="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œredissonå®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å¯é‡å…¥çš„å—ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¥½çš„ï¼Œredissonå®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å¯é‡å…¥çš„å—ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œredissonå®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å¯é‡å…¥çš„å—ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå¥½çš„ï¼Œredissonå®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å¯é‡å…¥çš„å—ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼Œæ˜¯å¯ä»¥é‡å…¥çš„ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…æ­»é”çš„äº§ç”Ÿã€‚è¿™ä¸ªé‡å…¥å…¶å®åœ¨å†…éƒ¨å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”å°±ä¼šè®¡æ•°ï¼Œå¦‚æœé‡Šæ”¾é”å°±ä¼šåœ¨è®¡ç®—ä¸Šå‡ä¸€ã€‚åœ¨å­˜å‚¨æ•°æ®çš„æ—¶å€™é‡‡ç”¨çš„hashç»“æ„ï¼Œå¤§keyå¯ä»¥æŒ‰ç…§è‡ªå·±çš„ä¸šåŠ¡è¿›è¡Œå®šåˆ¶ï¼Œå…¶ä¸­å°keyæ˜¯å½“å‰çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œvalueæ˜¯å½“å‰çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°</p><h3 id="é¢è¯•å®˜ï¼šredissonå®ç°çš„åˆ†å¸ƒå¼é”èƒ½è§£å†³ä¸»ä»ä¸€è‡´æ€§çš„é—®é¢˜å—"><a href="#é¢è¯•å®˜ï¼šredissonå®ç°çš„åˆ†å¸ƒå¼é”èƒ½è§£å†³ä¸»ä»ä¸€è‡´æ€§çš„é—®é¢˜å—" class="headerlink" title="é¢è¯•å®˜ï¼šredissonå®ç°çš„åˆ†å¸ƒå¼é”èƒ½è§£å†³ä¸»ä»ä¸€è‡´æ€§çš„é—®é¢˜å—"></a><strong>é¢è¯•å®˜</strong>ï¼šredissonå®ç°çš„åˆ†å¸ƒå¼é”èƒ½è§£å†³ä¸»ä»ä¸€è‡´æ€§çš„é—®é¢˜å—</h3><p><strong>å€™é€‰äºº</strong>ï¼šè¿™ä¸ªæ˜¯ä¸èƒ½çš„ï¼Œæ¯”å¦‚ï¼Œå½“çº¿ç¨‹1åŠ é”æˆåŠŸåï¼ŒmasterèŠ‚ç‚¹æ•°æ®ä¼šå¼‚æ­¥å¤åˆ¶åˆ°slaveèŠ‚ç‚¹ï¼Œæ­¤æ—¶å½“å‰æŒæœ‰Redisé”çš„masterèŠ‚ç‚¹å®•æœºï¼ŒslaveèŠ‚ç‚¹è¢«æå‡ä¸ºæ–°çš„masterèŠ‚ç‚¹ï¼Œå‡å¦‚ç°åœ¨æ¥äº†ä¸€ä¸ªçº¿ç¨‹2ï¼Œå†æ¬¡åŠ é”ï¼Œä¼šåœ¨æ–°çš„masterèŠ‚ç‚¹ä¸ŠåŠ é”æˆåŠŸï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ä¸¤ä¸ªèŠ‚ç‚¹åŒæ—¶æŒæœ‰ä¸€æŠŠé”çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨redissonæä¾›çš„çº¢é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œä¸èƒ½åªåœ¨ä¸€ä¸ªrediså®ä¾‹ä¸Šåˆ›å»ºé”ï¼Œåº”è¯¥æ˜¯åœ¨å¤šä¸ªrediså®ä¾‹ä¸Šåˆ›å»ºé”ï¼Œå¹¶ä¸”è¦æ±‚åœ¨å¤§å¤šæ•°redisèŠ‚ç‚¹ä¸Šéƒ½æˆåŠŸåˆ›å»ºé”ï¼Œçº¢é”ä¸­è¦æ±‚æ˜¯redisçš„èŠ‚ç‚¹æ•°é‡è¦è¿‡åŠã€‚è¿™æ ·å°±èƒ½é¿å…çº¿ç¨‹1åŠ é”æˆåŠŸåmasterèŠ‚ç‚¹å®•æœºå¯¼è‡´çº¿ç¨‹2æˆåŠŸåŠ é”åˆ°æ–°çš„masterèŠ‚ç‚¹ä¸Šçš„é—®é¢˜äº†ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†çº¢é”ï¼Œå› ä¸ºéœ€è¦åŒæ—¶åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šéƒ½æ·»åŠ é”ï¼Œæ€§èƒ½å°±å˜çš„å¾ˆä½äº†ï¼Œå¹¶ä¸”è¿ç»´ç»´æŠ¤æˆæœ¬ä¹Ÿéå¸¸é«˜ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­ä¹Ÿä¸ä¼šç›´æ¥ä½¿ç”¨çº¢é”ï¼Œå¹¶ä¸”å®˜æ–¹ä¹Ÿæš‚æ—¶åºŸå¼ƒäº†è¿™ä¸ªçº¢é”</p><h3 id="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œå¦‚æœä¸šåŠ¡éè¦ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šå¥½çš„ï¼Œå¦‚æœä¸šåŠ¡éè¦ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šå¥½çš„ï¼Œå¦‚æœä¸šåŠ¡éè¦ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šå¥½çš„ï¼Œå¦‚æœä¸šåŠ¡éè¦ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äººï¼š</strong>å—¯~ï¼Œredisæœ¬èº«å°±æ˜¯æ”¯æŒé«˜å¯ç”¨çš„ï¼Œåšåˆ°å¼ºä¸€è‡´æ€§ï¼Œå°±éå¸¸å½±å“æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæœ‰å¼ºä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ï¼Œå»ºè®®ä½¿ç”¨zookeeperå®ç°çš„åˆ†å¸ƒå¼é”ï¼Œå®ƒæ˜¯å¯ä»¥ä¿è¯å¼ºä¸€è‡´æ€§çš„ã€‚</p><h3 id="é¢è¯•å®˜ï¼šRedisé›†ç¾¤æœ‰å“ªäº›æ–¹æ¡ˆ-çŸ¥é“å˜›"><a href="#é¢è¯•å®˜ï¼šRedisé›†ç¾¤æœ‰å“ªäº›æ–¹æ¡ˆ-çŸ¥é“å˜›" class="headerlink" title="é¢è¯•å®˜ï¼šRedisé›†ç¾¤æœ‰å“ªäº›æ–¹æ¡ˆ, çŸ¥é“å˜› ?"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisé›†ç¾¤æœ‰å“ªäº›æ–¹æ¡ˆ, çŸ¥é“å˜› ?</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯~~ï¼Œåœ¨Redisä¸­æä¾›çš„é›†ç¾¤æ–¹æ¡ˆæ€»å…±æœ‰ä¸‰ç§ï¼šä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€Redisåˆ†ç‰‡é›†ç¾¤</p><h3 id="é¢è¯•å®˜ï¼šé‚£ä½ æ¥ä»‹ç»ä¸€ä¸‹ä¸»ä»åŒæ­¥"><a href="#é¢è¯•å®˜ï¼šé‚£ä½ æ¥ä»‹ç»ä¸€ä¸‹ä¸»ä»åŒæ­¥" class="headerlink" title="é¢è¯•å®˜ï¼šé‚£ä½ æ¥ä»‹ç»ä¸€ä¸‹ä¸»ä»åŒæ­¥"></a><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä½ æ¥ä»‹ç»ä¸€ä¸‹ä¸»ä»åŒæ­¥</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼Œæ˜¯è¿™æ ·çš„ï¼Œå•èŠ‚ç‚¹Redisçš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜Redisçš„å¹¶å‘èƒ½åŠ›ï¼Œå¯ä»¥æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å†™æ•°æ®ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ•°æ®ï¼Œä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ä¹‹åï¼Œéœ€è¦æŠŠæ•°æ®åŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸­</p><h3 id="é¢è¯•å®˜ï¼šèƒ½è¯´ä¸€ä¸‹ï¼Œä¸»ä»åŒæ­¥æ•°æ®çš„æµç¨‹"><a href="#é¢è¯•å®˜ï¼šèƒ½è¯´ä¸€ä¸‹ï¼Œä¸»ä»åŒæ­¥æ•°æ®çš„æµç¨‹" class="headerlink" title="é¢è¯•å®˜ï¼šèƒ½è¯´ä¸€ä¸‹ï¼Œä¸»ä»åŒæ­¥æ•°æ®çš„æµç¨‹"></a><strong>é¢è¯•å®˜</strong>ï¼šèƒ½è¯´ä¸€ä¸‹ï¼Œä¸»ä»åŒæ­¥æ•°æ®çš„æµç¨‹</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯~~ï¼Œå¥½ï¼ä¸»ä»åŒæ­¥åˆ†ä¸ºäº†ä¸¤ä¸ªé˜¶æ®µï¼Œä¸€ä¸ªæ˜¯å…¨é‡åŒæ­¥ï¼Œä¸€ä¸ªæ˜¯å¢é‡åŒæ­¥</p><p>å…¨é‡åŒæ­¥æ˜¯æŒ‡ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡ä¸ä¸»èŠ‚ç‚¹å»ºç«‹è¿æ¥çš„æ—¶å€™ä½¿ç”¨å…¨é‡åŒæ­¥ï¼Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>ç¬¬ä¸€ï¼šä»èŠ‚ç‚¹è¯·æ±‚ä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œå…¶ä¸­ä»èŠ‚ç‚¹ä¼šæºå¸¦è‡ªå·±çš„replication idå’Œoffsetåç§»é‡ã€‚</p><p>ç¬¬äºŒï¼šä¸»èŠ‚ç‚¹åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œä¸»è¦åˆ¤æ–­çš„ä¾æ®å°±æ˜¯ï¼Œä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªreplication idï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œé‚£ä¸»èŠ‚ç‚¹å°±ä¼šæŠŠè‡ªå·±çš„replication idå’Œoffsetå‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè®©ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯ä¿æŒä¸€è‡´ã€‚</p><p>ç¬¬ä¸‰ï¼šåœ¨åŒæ—¶ä¸»èŠ‚ç‚¹ä¼šæ‰§è¡Œbgsaveï¼Œç”Ÿæˆrdbæ–‡ä»¶åï¼Œå‘é€ç»™ä»èŠ‚ç‚¹å»æ‰§è¡Œï¼Œä»èŠ‚ç‚¹å…ˆæŠŠè‡ªå·±çš„æ•°æ®æ¸…ç©ºï¼Œç„¶åæ‰§è¡Œä¸»èŠ‚ç‚¹å‘é€è¿‡æ¥çš„rdbæ–‡ä»¶ï¼Œè¿™æ ·å°±ä¿æŒäº†ä¸€è‡´</p><p>å½“ç„¶ï¼Œå¦‚æœåœ¨rdbç”Ÿæˆæ‰§è¡ŒæœŸé—´ï¼Œä¾ç„¶æœ‰è¯·æ±‚åˆ°äº†ä¸»èŠ‚ç‚¹ï¼Œè€Œä¸»èŠ‚ç‚¹ä¼šä»¥å‘½ä»¤çš„æ–¹å¼è®°å½•åˆ°ç¼“å†²åŒºï¼Œç¼“å†²åŒºæ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæœ€åæŠŠè¿™ä¸ªæ—¥å¿—æ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿™æ ·å°±èƒ½ä¿è¯ä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹å®Œå…¨ä¸€è‡´äº†ï¼ŒåæœŸå†åŒæ­¥æ•°æ®çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä¾èµ–äºè¿™ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯å…¨é‡åŒæ­¥</p><p>å¢é‡åŒæ­¥æŒ‡çš„æ˜¯ï¼Œå½“ä»èŠ‚ç‚¹æœåŠ¡é‡å¯ä¹‹åï¼Œæ•°æ®å°±ä¸ä¸€è‡´äº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œä»èŠ‚ç‚¹ä¼šè¯·æ±‚ä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œä¸»èŠ‚ç‚¹è¿˜æ˜¯åˆ¤æ–­ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œä¸æ˜¯ç¬¬ä¸€æ¬¡å°±è·å–ä»èŠ‚ç‚¹çš„offsetå€¼ï¼Œç„¶åä¸»èŠ‚ç‚¹ä»å‘½ä»¤æ—¥å¿—ä¸­è·å–offsetå€¼ä¹‹åçš„æ•°æ®ï¼Œå‘é€ç»™ä»èŠ‚ç‚¹è¿›è¡Œæ•°æ®åŒæ­¥</p><h3 id="é¢è¯•å®˜ï¼šæ€ä¹ˆä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨"><a href="#é¢è¯•å®˜ï¼šæ€ä¹ˆä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨" class="headerlink" title="é¢è¯•å®˜ï¼šæ€ä¹ˆä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨"></a><strong>é¢è¯•å®˜</strong>ï¼šæ€ä¹ˆä¿è¯Redisçš„é«˜å¹¶å‘é«˜å¯ç”¨</h3><p><strong>å€™é€‰äºº</strong>ï¼šé¦–å…ˆå¯ä»¥æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå†åŠ ä¸Šä½¿ç”¨redisä¸­çš„å“¨å…µæ¨¡å¼ï¼Œå“¨å…µæ¨¡å¼å¯ä»¥å®ç°ä¸»ä»é›†ç¾¤çš„è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œé‡Œé¢å°±åŒ…å«äº†å¯¹ä¸»ä»æœåŠ¡çš„ç›‘æ§ã€è‡ªåŠ¨æ•…éšœæ¢å¤ã€é€šçŸ¥ï¼›å¦‚æœmasteræ•…éšœï¼ŒSentinelä¼šå°†ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚å½“æ•…éšœå®ä¾‹æ¢å¤åä¹Ÿä»¥æ–°çš„masterä¸ºä¸»ï¼›åŒæ—¶Sentinelä¹Ÿå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯æ¨é€ç»™Redisçš„å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ä¸€èˆ¬é¡¹ç›®éƒ½ä¼šé‡‡ç”¨å“¨å…µçš„æ¨¡å¼æ¥ä¿è¯redisçš„é«˜å¹¶å‘é«˜å¯ç”¨</p><h3 id="é¢è¯•å®˜ï¼šä½ ä»¬ä½¿ç”¨redisæ˜¯å•ç‚¹è¿˜æ˜¯é›†ç¾¤ï¼Œå“ªç§é›†ç¾¤"><a href="#é¢è¯•å®˜ï¼šä½ ä»¬ä½¿ç”¨redisæ˜¯å•ç‚¹è¿˜æ˜¯é›†ç¾¤ï¼Œå“ªç§é›†ç¾¤" class="headerlink" title="é¢è¯•å®˜ï¼šä½ ä»¬ä½¿ç”¨redisæ˜¯å•ç‚¹è¿˜æ˜¯é›†ç¾¤ï¼Œå“ªç§é›†ç¾¤"></a><strong>é¢è¯•å®˜</strong>ï¼šä½ ä»¬ä½¿ç”¨redisæ˜¯å•ç‚¹è¿˜æ˜¯é›†ç¾¤ï¼Œå“ªç§é›†ç¾¤</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼ï¼Œæˆ‘ä»¬å½“æ—¶ä½¿ç”¨çš„æ˜¯ä¸»ä»ï¼ˆ1ä¸»1ä»ï¼‰åŠ å“¨å…µã€‚ä¸€èˆ¬å•èŠ‚ç‚¹ä¸è¶…è¿‡10Gå†…å­˜ï¼Œå¦‚æœRediså†…å­˜ä¸è¶³åˆ™å¯ä»¥ç»™ä¸åŒæœåŠ¡åˆ†é…ç‹¬ç«‹çš„Redisä¸»ä»èŠ‚ç‚¹ã€‚å°½é‡ä¸åšåˆ†ç‰‡é›†ç¾¤ã€‚å› ä¸ºé›†ç¾¤ç»´æŠ¤èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”é›†ç¾¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹å’Œæ•°æ®é€šä¿¡ä¼šæ¶ˆè€—å¤§é‡çš„ç½‘ç»œå¸¦å®½ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•ä½¿ç”¨luaè„šæœ¬å’Œäº‹åŠ¡</p><h3 id="é¢è¯•å®˜ï¼šredisé›†ç¾¤è„‘è£‚ï¼Œè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šredisé›†ç¾¤è„‘è£‚ï¼Œè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šredisé›†ç¾¤è„‘è£‚ï¼Œè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šredisé›†ç¾¤è„‘è£‚ï¼Œè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯ï¼ è¿™ä¸ªåœ¨é¡¹ç›®å¾ˆå°‘è§ï¼Œä¸è¿‡è„‘è£‚çš„é—®é¢˜æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬ç°åœ¨ç”¨çš„æ˜¯redisçš„å“¨å…µæ¨¡å¼é›†ç¾¤çš„</p><p>æœ‰çš„æ—¶å€™ç”±äºç½‘ç»œç­‰åŸå› å¯èƒ½ä¼šå‡ºç°è„‘è£‚çš„æƒ…å†µï¼Œå°±æ˜¯è¯´ï¼Œç”±äºredis masterèŠ‚ç‚¹å’Œredis salveèŠ‚ç‚¹å’Œsentinelå¤„äºä¸åŒçš„ç½‘ç»œåˆ†åŒºï¼Œä½¿å¾—sentinelæ²¡æœ‰èƒ½å¤Ÿå¿ƒè·³æ„ŸçŸ¥åˆ°masterï¼Œæ‰€ä»¥é€šè¿‡é€‰ä¸¾çš„æ–¹å¼æå‡äº†ä¸€ä¸ªsalveä¸ºmasterï¼Œè¿™æ ·å°±å­˜åœ¨äº†ä¸¤ä¸ªmasterï¼Œå°±åƒå¤§è„‘åˆ†è£‚äº†ä¸€æ ·ï¼Œè¿™æ ·ä¼šå¯¼è‡´å®¢æˆ·ç«¯è¿˜åœ¨old masteré‚£é‡Œå†™å…¥æ•°æ®ï¼Œæ–°èŠ‚ç‚¹æ— æ³•åŒæ­¥æ•°æ®ï¼Œå½“ç½‘ç»œæ¢å¤åï¼Œsentinelä¼šå°†old masteré™ä¸ºsalveï¼Œè¿™æ—¶å†ä»æ–°masteråŒæ­¥æ•°æ®ï¼Œè¿™ä¼šå¯¼è‡´old masterä¸­çš„å¤§é‡æ•°æ®ä¸¢å¤±ã€‚</p><p>å…³äºè§£å†³çš„è¯ï¼Œæˆ‘è®°å¾—åœ¨redisçš„é…ç½®ä¸­å¯ä»¥è®¾ç½®ï¼šç¬¬ä¸€å¯ä»¥è®¾ç½®æœ€å°‘çš„salveèŠ‚ç‚¹ä¸ªæ•°ï¼Œæ¯”å¦‚è®¾ç½®è‡³å°‘è¦æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹æ‰èƒ½åŒæ­¥æ•°æ®ï¼Œç¬¬äºŒä¸ªå¯ä»¥è®¾ç½®ä¸»ä»æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿæ—¶é—´ï¼Œè¾¾ä¸åˆ°è¦æ±‚å°±æ‹’ç»è¯·æ±‚ï¼Œå°±å¯ä»¥é¿å…å¤§é‡çš„æ•°æ®ä¸¢å¤±</p><h3 id="é¢è¯•å®˜ï¼šredisçš„åˆ†ç‰‡é›†ç¾¤æœ‰ä»€ä¹ˆä½œç”¨"><a href="#é¢è¯•å®˜ï¼šredisçš„åˆ†ç‰‡é›†ç¾¤æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="é¢è¯•å®˜ï¼šredisçš„åˆ†ç‰‡é›†ç¾¤æœ‰ä»€ä¹ˆä½œç”¨"></a><strong>é¢è¯•å®˜</strong>ï¼šredisçš„åˆ†ç‰‡é›†ç¾¤æœ‰ä»€ä¹ˆä½œç”¨</h3><p><strong>å€™é€‰äºº</strong>ï¼šåˆ†ç‰‡é›†ç¾¤ä¸»è¦è§£å†³çš„æ˜¯ï¼Œæµ·é‡æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œé›†ç¾¤ä¸­æœ‰å¤šä¸ªmasterï¼Œæ¯ä¸ªmasterä¿å­˜ä¸åŒæ•°æ®ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç»™æ¯ä¸ªmasterè®¾ç½®å¤šä¸ªslaveèŠ‚ç‚¹ï¼Œå°±å¯ä»¥ç»§ç»­å¢å¤§é›†ç¾¤çš„é«˜å¹¶å‘èƒ½åŠ›ã€‚åŒæ—¶æ¯ä¸ªmasterä¹‹é—´é€šè¿‡pingç›‘æµ‹å½¼æ­¤å¥åº·çŠ¶æ€ï¼Œå°±ç±»ä¼¼äºå“¨å…µæ¨¡å¼äº†ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è®¿é—®é›†ç¾¤ä»»æ„èŠ‚ç‚¹ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ°æ­£ç¡®èŠ‚ç‚¹</p><h3 id="é¢è¯•å®˜ï¼šRedisåˆ†ç‰‡é›†ç¾¤ä¸­æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨å’Œè¯»å–çš„ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šRedisåˆ†ç‰‡é›†ç¾¤ä¸­æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨å’Œè¯»å–çš„ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šRedisåˆ†ç‰‡é›†ç¾¤ä¸­æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨å’Œè¯»å–çš„ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisåˆ†ç‰‡é›†ç¾¤ä¸­æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨å’Œè¯»å–çš„ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯~ï¼Œåœ¨redisé›†ç¾¤ä¸­æ˜¯è¿™æ ·çš„</p><p>Redis é›†ç¾¤å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µï¼Œæœ‰ 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œé›†ç¾¤ä¸­æ¯ä¸ªä¸»èŠ‚ç‚¹ç»‘å®šäº†ä¸€å®šèŒƒå›´çš„å“ˆå¸Œæ§½èŒƒå›´ï¼Œ keyé€šè¿‡ CRC16 æ ¡éªŒåå¯¹ 16384 å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½ï¼Œé€šè¿‡æ§½æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œå­˜å‚¨ã€‚</p><p>å–å€¼çš„é€»è¾‘æ˜¯ä¸€æ ·çš„</p><h3 id="é¢è¯•å®˜ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼š</p><p>å—¯ï¼Œè¿™ä¸ªæœ‰å‡ ä¸ªåŸå› å§~~~</p><p>1ã€å®Œå…¨åŸºäºå†…å­˜çš„ï¼ŒCè¯­è¨€ç¼–å†™</p><p>2ã€é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯ç«äº‰æ¡ä»¶</p><p>3ã€ä½¿ç”¨å¤šè·¯I/Oå¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡IO</p><p>ä¾‹å¦‚ï¼šbgsave å’Œ bgrewriteaof  éƒ½æ˜¯åœ¨<strong>åå°</strong>æ‰§è¡Œæ“ä½œï¼Œä¸å½±å“ä¸»çº¿ç¨‹çš„æ­£å¸¸ä½¿ç”¨ï¼Œä¸ä¼šäº§ç”Ÿé˜»å¡</p><h3 id="é¢è¯•å®˜ï¼šèƒ½è§£é‡Šä¸€ä¸‹I-Oå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Ÿ"><a href="#é¢è¯•å®˜ï¼šèƒ½è§£é‡Šä¸€ä¸‹I-Oå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Ÿ" class="headerlink" title="é¢è¯•å®˜ï¼šèƒ½è§£é‡Šä¸€ä¸‹I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Ÿ"></a><strong>é¢è¯•å®˜</strong>ï¼šèƒ½è§£é‡Šä¸€ä¸‹I/Oå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Ÿ</h3><p><strong>å€™é€‰äºº</strong>ï¼šå—¯~~ï¼ŒI/Oå¤šè·¯å¤ç”¨æ˜¯æŒ‡åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ªSocket ï¼Œå¹¶åœ¨æŸä¸ªSocketå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚ç›®å‰çš„I/Oå¤šè·¯å¤ç”¨éƒ½æ˜¯é‡‡ç”¨çš„epollæ¨¡å¼å®ç°ï¼Œå®ƒä¼šåœ¨é€šçŸ¥ç”¨æˆ·è¿›ç¨‹Socketå°±ç»ªçš„åŒæ—¶ï¼ŒæŠŠå·²å°±ç»ªçš„Socketå†™å…¥ç”¨æˆ·ç©ºé—´ï¼Œä¸éœ€è¦æŒ¨ä¸ªéå†Socketæ¥åˆ¤æ–­æ˜¯å¦å°±ç»ªï¼Œæå‡äº†æ€§èƒ½ã€‚</p><p>å…¶ä¸­Redisçš„ç½‘ç»œæ¨¡å‹å°±æ˜¯ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ç»“åˆäº‹ä»¶çš„å¤„ç†å™¨æ¥åº”å¯¹å¤šä¸ªSocketè¯·æ±‚ï¼Œæ¯”å¦‚ï¼Œæä¾›äº†è¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼›</p><p>åœ¨Redis6.0ä¹‹åï¼Œä¸ºäº†æå‡æ›´å¥½çš„æ€§èƒ½ï¼Œåœ¨å‘½ä»¤å›å¤å¤„ç†å™¨ä½¿ç”¨äº†å¤šçº¿ç¨‹æ¥å¤„ç†å›å¤äº‹ä»¶ï¼Œåœ¨å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ä¸­ï¼Œå°†å‘½ä»¤çš„è½¬æ¢ä½¿ç”¨äº†å¤šçº¿ç¨‹ï¼Œå¢åŠ å‘½ä»¤è½¬æ¢é€Ÿåº¦ï¼Œåœ¨å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œä¾ç„¶æ˜¯å•çº¿ç¨‹</p></blockquote>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ redisçš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="redis" scheme="https://www.jodio.cc/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Gitä½¿ç”¨</title>
    <link href="https://www.jodio.cc/posts/git.html"/>
    <id>https://www.jodio.cc/posts/git.html</id>
    <published>2023-04-14T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><h2 id="é›†ä¸­å¼ä¸åˆ†å¸ƒå¼"><a href="#é›†ä¸­å¼ä¸åˆ†å¸ƒå¼" class="headerlink" title="é›†ä¸­å¼ä¸åˆ†å¸ƒå¼"></a>é›†ä¸­å¼ä¸åˆ†å¸ƒå¼</h2><p>Git å±äºåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œè€Œ SVN å±äºé›†ä¸­å¼ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208200656794.png"/> </div><br></p><p>é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶åªæœ‰ä¸­å¿ƒæœåŠ¡å™¨æ‹¥æœ‰ä¸€ä»½ä»£ç ï¼Œè€Œåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶æ¯ä¸ªäººçš„ç”µè„‘ä¸Šå°±æœ‰ä¸€ä»½å®Œæ•´çš„ä»£ç ã€‚</p><p>é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶æœ‰å®‰å…¨æ€§é—®é¢˜ï¼Œå½“ä¸­å¿ƒæœåŠ¡å™¨æŒ‚äº†æ‰€æœ‰äººéƒ½æ²¡åŠæ³•å·¥ä½œäº†ã€‚</p><p>é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶éœ€è¦è¿ç½‘æ‰èƒ½å·¥ä½œï¼Œå¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œé‚£ä¹ˆæäº¤ä¸€ä¸ªæ–‡ä»¶ä¼šæ…¢çš„æ— æ³•è®©äººå¿å—ã€‚è€Œåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ä¸éœ€è¦è¿ç½‘å°±èƒ½å·¥ä½œã€‚</p><p>åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶æ–°å»ºåˆ†æ”¯ã€åˆå¹¶åˆ†æ”¯æ“ä½œé€Ÿåº¦éå¸¸å¿«ï¼Œè€Œé›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶æ–°å»ºä¸€ä¸ªåˆ†æ”¯ç›¸å½“äºå¤åˆ¶ä¸€ä»½å®Œæ•´ä»£ç ã€‚</p><h2 id="ä¸­å¿ƒæœåŠ¡å™¨"><a href="#ä¸­å¿ƒæœåŠ¡å™¨" class="headerlink" title="ä¸­å¿ƒæœåŠ¡å™¨"></a>ä¸­å¿ƒæœåŠ¡å™¨</h2><p>ä¸­å¿ƒæœåŠ¡å™¨ç”¨æ¥äº¤æ¢æ¯ä¸ªç”¨æˆ·çš„ä¿®æ”¹ï¼Œæ²¡æœ‰ä¸­å¿ƒæœåŠ¡å™¨ä¹Ÿèƒ½å·¥ä½œï¼Œä½†æ˜¯ä¸­å¿ƒæœåŠ¡å™¨èƒ½å¤Ÿ 24 å°æ—¶ä¿æŒå¼€æœºçŠ¶æ€ï¼Œè¿™æ ·å°±èƒ½æ›´æ–¹ä¾¿çš„äº¤æ¢ä¿®æ”¹ã€‚</p><p>Github å°±æ˜¯ä¸€ä¸ªä¸­å¿ƒæœåŠ¡å™¨ã€‚</p><h2 id="å·¥ä½œæµ"><a href="#å·¥ä½œæµ" class="headerlink" title="å·¥ä½œæµ"></a>å·¥ä½œæµ</h2><p>æ–°å»ºä¸€ä¸ªä»“åº“ä¹‹åï¼Œå½“å‰ç›®å½•å°±æˆä¸ºäº†å·¥ä½œåŒºï¼Œå·¥ä½œåŒºä¸‹æœ‰ä¸€ä¸ªéšè—ç›®å½• .gitï¼Œå®ƒå±äº Git çš„ç‰ˆæœ¬åº“ã€‚</p><p>Git çš„ç‰ˆæœ¬åº“æœ‰ä¸€ä¸ªç§°ä¸º Stage çš„æš‚å­˜åŒºä»¥åŠæœ€åçš„ History ç‰ˆæœ¬åº“ï¼ŒHistory å­˜å‚¨æ‰€æœ‰åˆ†æ”¯ä¿¡æ¯ï¼Œä½¿ç”¨ä¸€ä¸ª HEAD æŒ‡é’ˆæŒ‡å‘å½“å‰åˆ†æ”¯ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208195941661.png"/> </div><br></p><ul><li>git add files æŠŠæ–‡ä»¶çš„ä¿®æ”¹æ·»åŠ åˆ°æš‚å­˜åŒº</li><li>git commit æŠŠæš‚å­˜åŒºçš„ä¿®æ”¹æäº¤åˆ°å½“å‰åˆ†æ”¯ï¼Œæäº¤ä¹‹åæš‚å­˜åŒºå°±è¢«æ¸…ç©ºäº†</li><li>git reset â€” files ä½¿ç”¨å½“å‰åˆ†æ”¯ä¸Šçš„ä¿®æ”¹è¦†ç›–æš‚å­˜åŒºï¼Œç”¨æ¥æ’¤é”€æœ€åä¸€æ¬¡ git add files</li><li>git checkout â€” files ä½¿ç”¨æš‚å­˜åŒºçš„ä¿®æ”¹è¦†ç›–å·¥ä½œç›®å½•ï¼Œç”¨æ¥æ’¤é”€æœ¬åœ°ä¿®æ”¹</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208200014395.png"/> </div><br></p><p>å¯ä»¥è·³è¿‡æš‚å­˜åŒºåŸŸç›´æ¥ä»åˆ†æ”¯ä¸­å–å‡ºä¿®æ”¹ï¼Œæˆ–è€…ç›´æ¥æäº¤ä¿®æ”¹åˆ°åˆ†æ”¯ä¸­ã€‚</p><ul><li>git commit -a ç›´æ¥æŠŠæ‰€æœ‰æ–‡ä»¶çš„ä¿®æ”¹æ·»åŠ åˆ°æš‚å­˜åŒºç„¶åæ‰§è¡Œæäº¤</li><li>git checkout HEAD â€” files å–å‡ºæœ€åä¸€æ¬¡ä¿®æ”¹ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œå›æ»šæ“ä½œ</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208200543923.png"/> </div><br></p><h2 id="åˆ†æ”¯å®ç°"><a href="#åˆ†æ”¯å®ç°" class="headerlink" title="åˆ†æ”¯å®ç°"></a>åˆ†æ”¯å®ç°</h2><p>ä½¿ç”¨æŒ‡é’ˆå°†æ¯ä¸ªæäº¤è¿æ¥æˆä¸€æ¡æ—¶é—´çº¿ï¼ŒHEAD æŒ‡é’ˆæŒ‡å‘å½“å‰åˆ†æ”¯æŒ‡é’ˆã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203219927.png"/> </div><br></p><p>æ–°å»ºåˆ†æ”¯æ˜¯æ–°å»ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ—¶é—´çº¿çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶è®© HEAD æŒ‡é’ˆæŒ‡å‘æ–°åˆ†æ”¯ï¼Œè¡¨ç¤ºæ–°åˆ†æ”¯æˆä¸ºå½“å‰åˆ†æ”¯ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203142527.png"/> </div><br></p><p>æ¯æ¬¡æäº¤åªä¼šè®©å½“å‰åˆ†æ”¯æŒ‡é’ˆå‘å‰ç§»åŠ¨ï¼Œè€Œå…¶å®ƒåˆ†æ”¯æŒ‡é’ˆä¸ä¼šç§»åŠ¨ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203112400.png"/> </div><br></p><p>åˆå¹¶åˆ†æ”¯ä¹Ÿåªéœ€è¦æ”¹å˜æŒ‡é’ˆå³å¯ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203010540.png"/> </div><br></p><h2 id="å†²çª"><a href="#å†²çª" class="headerlink" title="å†²çª"></a>å†²çª</h2><p>å½“ä¸¤ä¸ªåˆ†æ”¯éƒ½å¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„åŒä¸€è¡Œè¿›è¡Œäº†ä¿®æ”¹ï¼Œåœ¨åˆ†æ”¯åˆå¹¶æ—¶å°±ä¼šäº§ç”Ÿå†²çªã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203034705.png"/> </div><br></p><p>Git ä¼šä½¿ç”¨ \&lt;\&lt;\&lt;\&lt;\&lt;\&lt;\&lt; ï¼Œ======= ï¼Œ>>>>>>> æ ‡è®°å‡ºä¸åŒåˆ†æ”¯çš„å†…å®¹ï¼Œåªéœ€è¦æŠŠä¸åŒåˆ†æ”¯ä¸­å†²çªéƒ¨åˆ†ä¿®æ”¹æˆä¸€æ ·å°±èƒ½è§£å†³å†²çªã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">Creating a new branch is quick &amp; simple.</span><br><span class="line">=======</span><br><span class="line">Creating a new branch is quick AND simple.</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; feature1</span><br></pre></td></tr></table></figure><h2 id="Fast-forward"><a href="#Fast-forward" class="headerlink" title="Fast forward"></a>Fast forward</h2><p>â€œå¿«è¿›å¼åˆå¹¶â€ï¼ˆfast-farward mergeï¼‰ï¼Œä¼šç›´æ¥å°† master åˆ†æ”¯æŒ‡å‘åˆå¹¶çš„åˆ†æ”¯ï¼Œè¿™ç§æ¨¡å¼ä¸‹è¿›è¡Œåˆ†æ”¯åˆå¹¶ä¼šä¸¢å¤±åˆ†æ”¯ä¿¡æ¯ï¼Œä¹Ÿå°±ä¸èƒ½åœ¨åˆ†æ”¯å†å²ä¸Šçœ‹å‡ºåˆ†æ”¯ä¿¡æ¯ã€‚</p><p>å¯ä»¥åœ¨åˆå¹¶æ—¶åŠ ä¸Š â€”no-ff å‚æ•°æ¥ç¦ç”¨ Fast forward æ¨¡å¼ï¼Œå¹¶ä¸”åŠ ä¸Š -m å‚æ•°è®©åˆå¹¶æ—¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ commitã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git merge --no-ff -m &quot;merge with no-ff&quot; dev</span><br></pre></td></tr></table></figure><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208203639712.png"/> </div><br></p><h2 id="å‚¨è—ï¼ˆStashingï¼‰"><a href="#å‚¨è—ï¼ˆStashingï¼‰" class="headerlink" title="å‚¨è—ï¼ˆStashingï¼‰"></a>å‚¨è—ï¼ˆStashingï¼‰</h2><p>åœ¨ä¸€ä¸ªåˆ†æ”¯ä¸Šæ“ä½œä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰å°†ä¿®æ”¹æäº¤åˆ°åˆ†æ”¯ä¸Šï¼Œæ­¤æ—¶è¿›è¡Œåˆ‡æ¢åˆ†æ”¯ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªåˆ†æ”¯ä¸Šä¹Ÿèƒ½çœ‹åˆ°æ–°çš„ä¿®æ”¹ã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰åˆ†æ”¯éƒ½å…±ç”¨ä¸€ä¸ªå·¥ä½œåŒºçš„ç¼˜æ•…ã€‚</p><p>å¯ä»¥ä½¿ç”¨ git stash å°†å½“å‰åˆ†æ”¯çš„ä¿®æ”¹å‚¨è—èµ·æ¥ï¼Œæ­¤æ—¶å½“å‰å·¥ä½œåŒºçš„æ‰€æœ‰ä¿®æ”¹éƒ½ä¼šè¢«å­˜åˆ°æ ˆä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰å·¥ä½œåŒºæ˜¯å¹²å‡€çš„ï¼Œæ²¡æœ‰ä»»ä½•æœªæäº¤çš„ä¿®æ”¹ã€‚æ­¤æ—¶å°±å¯ä»¥å®‰å…¨çš„åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯ä¸Šäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git stash</span><br><span class="line">Saved working directory and index state \ &quot;WIP on master: 049d078 added the index file&quot;</span><br><span class="line">HEAD is now at 049d078 added the index file (To restore them type &quot;git stash apply&quot;)</span><br></pre></td></tr></table></figure><p>è¯¥åŠŸèƒ½å¯ä»¥ç”¨äº bug åˆ†æ”¯çš„å®ç°ã€‚å¦‚æœå½“å‰æ­£åœ¨ dev åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘ï¼Œä½†æ˜¯æ­¤æ—¶ master ä¸Šæœ‰ä¸ª bug éœ€è¦ä¿®å¤ï¼Œä½†æ˜¯ dev åˆ†æ”¯ä¸Šçš„å¼€å‘è¿˜æœªå®Œæˆï¼Œä¸æƒ³ç«‹å³æäº¤ã€‚åœ¨æ–°å»º bug åˆ†æ”¯å¹¶åˆ‡æ¢åˆ° bug åˆ†æ”¯ä¹‹å‰å°±éœ€è¦ä½¿ç”¨ git stash å°† dev åˆ†æ”¯çš„æœªæäº¤ä¿®æ”¹å‚¨è—èµ·æ¥ã€‚</p><h2 id="SSH-ä¼ è¾“è®¾ç½®"><a href="#SSH-ä¼ è¾“è®¾ç½®" class="headerlink" title="SSH ä¼ è¾“è®¾ç½®"></a>SSH ä¼ è¾“è®¾ç½®</h2><p>Git ä»“åº“å’Œ Github ä¸­å¿ƒä»“åº“ä¹‹é—´çš„ä¼ è¾“æ˜¯é€šè¿‡ SSH åŠ å¯†ã€‚</p><p>å¦‚æœå·¥ä½œåŒºä¸‹æ²¡æœ‰ .ssh ç›®å½•ï¼Œæˆ–è€…è¯¥ç›®å½•ä¸‹æ²¡æœ‰ id_rsa å’Œ id_rsa.pub è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»º SSH Keyï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åæŠŠå…¬é’¥ id_rsa.pub çš„å†…å®¹å¤åˆ¶åˆ° Github â€œAccount settingsâ€ çš„ SSH Keys ä¸­ã€‚</p><h2 id="gitignore-æ–‡ä»¶"><a href="#gitignore-æ–‡ä»¶" class="headerlink" title=".gitignore æ–‡ä»¶"></a>.gitignore æ–‡ä»¶</h2><p>å¿½ç•¥ä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ¯”å¦‚ç¼©ç•¥å›¾ï¼›</li><li>ç¼–è¯‘ç”Ÿæˆçš„ä¸­é—´æ–‡ä»¶ï¼Œæ¯”å¦‚ Java ç¼–è¯‘äº§ç”Ÿçš„ .class æ–‡ä»¶ï¼›</li><li>è‡ªå·±çš„æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å­˜æ”¾å£ä»¤çš„é…ç½®æ–‡ä»¶ã€‚</li></ul><p>ä¸éœ€è¦å…¨éƒ¨è‡ªå·±ç¼–å†™ï¼Œå¯ä»¥åˆ° <a href="https://github.com/github/gitignore">https://github.com/github/gitignore</a> ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚</p><h2 id="Git-å‘½ä»¤ä¸€è§ˆ"><a href="#Git-å‘½ä»¤ä¸€è§ˆ" class="headerlink" title="Git å‘½ä»¤ä¸€è§ˆ"></a>Git å‘½ä»¤ä¸€è§ˆ</h2><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7a29acce-f243-4914-9f00-f2988c528412.jpg" width=""> </div><br></p><p>æ¯”è¾ƒè¯¦ç»†çš„åœ°å€ï¼š<a href="http://www.cheat-sheets.org/saved-copy/git-cheat-sheet.pdf">http://www.cheat-sheets.org/saved-copy/git-cheat-sheet.pdf</a></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="http://rogerdudler.github.io/git-guide/index.zh.html">Git - ç®€æ˜æŒ‡å—</a></li><li><a href="http://marklodato.github.io/visual-git-guide/index-zh-cn.html">å›¾è§£ Git</a></li><li><a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000">å»–é›ªå³° : Git æ•™ç¨‹</a></li><li><a href="https://learngitbranching.js.org/">Learn Git Branching</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ redisçš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="git" scheme="https://www.jodio.cc/categories/git/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Redisç¼“å­˜</title>
    <link href="https://www.jodio.cc/posts/redis.html"/>
    <id>https://www.jodio.cc/posts/redis.html</id>
    <published>2023-04-14T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.130Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>Redis æ˜¯é€Ÿåº¦éå¸¸å¿«çš„éå…³ç³»å‹ï¼ˆNoSQLï¼‰å†…å­˜é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥å­˜å‚¨é”®å’Œäº”ç§ä¸åŒç±»å‹çš„å€¼ä¹‹é—´çš„æ˜ å°„ã€‚</p><p>é”®çš„ç±»å‹åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œå€¼æ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼šå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€æ•£åˆ—è¡¨ã€æœ‰åºé›†åˆã€‚</p><p>Redis æ”¯æŒå¾ˆå¤šç‰¹æ€§ï¼Œä¾‹å¦‚å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸­ï¼Œä½¿ç”¨å¤åˆ¶æ¥æ‰©å±•è¯»æ€§èƒ½ï¼Œä½¿ç”¨åˆ†ç‰‡æ¥æ‰©å±•å†™æ€§èƒ½ã€‚</p><h2 id="äºŒã€æ•°æ®ç±»å‹"><a href="#äºŒã€æ•°æ®ç±»å‹" class="headerlink" title="äºŒã€æ•°æ®ç±»å‹"></a>äºŒã€æ•°æ®ç±»å‹</h2><div class="table-container"><table><thead><tr><th style="text-align:center">æ•°æ®ç±»å‹</th><th style="text-align:center">å¯ä»¥å­˜å‚¨çš„å€¼</th><th style="text-align:center">æ“ä½œ</th></tr></thead><tbody><tr><td style="text-align:center">STRING</td><td style="text-align:center">å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°</td><td style="text-align:center">å¯¹æ•´ä¸ªå­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„å…¶ä¸­ä¸€éƒ¨åˆ†æ‰§è¡Œæ“ä½œ\&lt;/br> å¯¹æ•´æ•°å’Œæµ®ç‚¹æ•°æ‰§è¡Œè‡ªå¢æˆ–è€…è‡ªå‡æ“ä½œ</td></tr><tr><td style="text-align:center">LIST</td><td style="text-align:center">åˆ—è¡¨</td><td style="text-align:center">ä»ä¸¤ç«¯å‹å…¥æˆ–è€…å¼¹å‡ºå…ƒç´  \&lt;/br> å¯¹å•ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ è¿›è¡Œä¿®å‰ªï¼Œ\&lt;/br> åªä¿ç•™ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´ </td></tr><tr><td style="text-align:center">SET</td><td style="text-align:center">æ— åºé›†åˆ</td><td style="text-align:center">æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªå…ƒç´ \&lt;/br> æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­\&lt;/br> è®¡ç®—äº¤é›†ã€å¹¶é›†ã€å·®é›†\&lt;/br> ä»é›†åˆé‡Œé¢éšæœºè·å–å…ƒç´ </td></tr><tr><td style="text-align:center">HASH</td><td style="text-align:center">åŒ…å«é”®å€¼å¯¹çš„æ— åºæ•£åˆ—è¡¨</td><td style="text-align:center">æ·»åŠ ã€è·å–ã€ç§»é™¤å•ä¸ªé”®å€¼å¯¹\&lt;/br> è·å–æ‰€æœ‰é”®å€¼å¯¹\&lt;/br> æ£€æŸ¥æŸä¸ªé”®æ˜¯å¦å­˜åœ¨</td></tr><tr><td style="text-align:center">ZSET</td><td style="text-align:center">æœ‰åºé›†åˆ</td><td style="text-align:center">æ·»åŠ ã€è·å–ã€åˆ é™¤å…ƒç´ \&lt;/br> æ ¹æ®åˆ†å€¼èŒƒå›´æˆ–è€…æˆå‘˜æ¥è·å–å…ƒç´ \&lt;/br> è®¡ç®—ä¸€ä¸ªé”®çš„æ’å</td></tr></tbody></table></div><blockquote><p><a href="https://redislabs.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/">What Redis data structures look like</a></p></blockquote><h3 id="STRING"><a href="#STRING" class="headerlink" title="STRING"></a>STRING</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6019b2db-bc3e-4408-b6d8-96025f4481d6.png" width="400"/> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; set hello world</span><br><span class="line">OK</span><br><span class="line">&gt; get hello</span><br><span class="line">&quot;world&quot;</span><br><span class="line">&gt; del hello</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; get hello</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><h3 id="LIST"><a href="#LIST" class="headerlink" title="LIST"></a>LIST</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/fb327611-7e2b-4f2f-9f5b-38592d408f07.png" width="400"/> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; rpush list-key item</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; rpush list-key item2</span><br><span class="line">(integer) 2</span><br><span class="line">&gt; rpush list-key item</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">&gt; lrange list-key 0 -1</span><br><span class="line">1) &quot;item&quot;</span><br><span class="line">2) &quot;item2&quot;</span><br><span class="line">3) &quot;item&quot;</span><br><span class="line"></span><br><span class="line">&gt; lindex list-key 1</span><br><span class="line">&quot;item2&quot;</span><br><span class="line"></span><br><span class="line">&gt; lpop list-key</span><br><span class="line">&quot;item&quot;</span><br><span class="line"></span><br><span class="line">&gt; lrange list-key 0 -1</span><br><span class="line">1) &quot;item2&quot;</span><br><span class="line">2) &quot;item&quot;</span><br></pre></td></tr></table></figure><h3 id="SET"><a href="#SET" class="headerlink" title="SET"></a>SET</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cd5fbcff-3f35-43a6-8ffa-082a93ce0f0e.png" width="400"/> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; sadd set-key item</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; sadd set-key item2</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; sadd set-key item3</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; sadd set-key item</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; smembers set-key</span><br><span class="line">1) &quot;item&quot;</span><br><span class="line">2) &quot;item2&quot;</span><br><span class="line">3) &quot;item3&quot;</span><br><span class="line"></span><br><span class="line">&gt; sismember set-key item4</span><br><span class="line">(integer) 0</span><br><span class="line">&gt; sismember set-key item</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line">&gt; srem set-key item2</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; srem set-key item2</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; smembers set-key</span><br><span class="line">1) &quot;item&quot;</span><br><span class="line">2) &quot;item3&quot;</span><br></pre></td></tr></table></figure><h3 id="HASH"><a href="#HASH" class="headerlink" title="HASH"></a>HASH</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7bd202a7-93d4-4f3a-a878-af68ae25539a.png" width="400"/> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; hset hash-key sub-key1 value1</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; hset hash-key sub-key2 value2</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; hset hash-key sub-key1 value1</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; hgetall hash-key</span><br><span class="line">1) &quot;sub-key1&quot;</span><br><span class="line">2) &quot;value1&quot;</span><br><span class="line">3) &quot;sub-key2&quot;</span><br><span class="line">4) &quot;value2&quot;</span><br><span class="line"></span><br><span class="line">&gt; hdel hash-key sub-key2</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; hdel hash-key sub-key2</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; hget hash-key sub-key1</span><br><span class="line">&quot;value1&quot;</span><br><span class="line"></span><br><span class="line">&gt; hgetall hash-key</span><br><span class="line">1) &quot;sub-key1&quot;</span><br><span class="line">2) &quot;value1&quot;</span><br></pre></td></tr></table></figure><h3 id="ZSET"><a href="#ZSET" class="headerlink" title="ZSET"></a>ZSET</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1202b2d6-9469-4251-bd47-ca6034fb6116.png" width="400"/> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; zadd zset-key 728 member1</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd zset-key 982 member0</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zadd zset-key 982 member0</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; zrange zset-key 0 -1 withscores</span><br><span class="line">1) &quot;member1&quot;</span><br><span class="line">2) &quot;728&quot;</span><br><span class="line">3) &quot;member0&quot;</span><br><span class="line">4) &quot;982&quot;</span><br><span class="line"></span><br><span class="line">&gt; zrangebyscore zset-key 0 800 withscores</span><br><span class="line">1) &quot;member1&quot;</span><br><span class="line">2) &quot;728&quot;</span><br><span class="line"></span><br><span class="line">&gt; zrem zset-key member1</span><br><span class="line">(integer) 1</span><br><span class="line">&gt; zrem zset-key member1</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">&gt; zrange zset-key 0 -1 withscores</span><br><span class="line">1) &quot;member0&quot;</span><br><span class="line">2) &quot;982&quot;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€æ•°æ®ç»“æ„"><a href="#ä¸‰ã€æ•°æ®ç»“æ„" class="headerlink" title="ä¸‰ã€æ•°æ®ç»“æ„"></a>ä¸‰ã€æ•°æ®ç»“æ„</h2><h3 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h3><p>dictht æ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ç»“æ„ï¼Œä½¿ç”¨æ‹‰é“¾æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></span><br><span class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *key;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">void</span> *val;</span><br><span class="line">        <span class="type">uint64_t</span> u64;</span><br><span class="line">        <span class="type">int64_t</span> s64;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure><p>Redis çš„å­—å…¸ dict ä¸­åŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ dicthtï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è¿›è¡Œ rehash æ“ä½œã€‚åœ¨æ‰©å®¹æ—¶ï¼Œå°†å…¶ä¸­ä¸€ä¸ª dictht ä¸Šçš„é”®å€¼å¯¹ rehash åˆ°å¦ä¸€ä¸ª dictht ä¸Šé¢ï¼Œå®Œæˆä¹‹åé‡Šæ”¾ç©ºé—´å¹¶äº¤æ¢ä¸¤ä¸ª dictht çš„è§’è‰²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="type">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>rehash æ“ä½œä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆï¼Œè€Œæ˜¯é‡‡ç”¨æ¸è¿›æ–¹å¼ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…ä¸€æ¬¡æ€§æ‰§è¡Œè¿‡å¤šçš„ rehash æ“ä½œç»™æœåŠ¡å™¨å¸¦æ¥è¿‡å¤§çš„è´Ÿæ‹…ã€‚</p><p>æ¸è¿›å¼ rehash é€šè¿‡è®°å½• dict çš„ rehashidx å®Œæˆï¼Œå®ƒä» 0 å¼€å§‹ï¼Œç„¶åæ¯æ‰§è¡Œä¸€æ¬¡ rehash éƒ½ä¼šé€’å¢ã€‚ä¾‹å¦‚åœ¨ä¸€æ¬¡ rehash ä¸­ï¼Œè¦æŠŠ dict[0] rehash åˆ° dict[1]ï¼Œè¿™ä¸€æ¬¡ä¼šæŠŠ dict[0] ä¸Š table[rehashidx] çš„é”®å€¼å¯¹ rehash åˆ° dict[1] ä¸Šï¼Œdict[0] çš„ table[rehashidx] æŒ‡å‘ nullï¼Œå¹¶ä»¤ rehashidx++ã€‚</p><p>åœ¨ rehash æœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æ¸è¿›å¼ rehashã€‚</p><p>é‡‡ç”¨æ¸è¿›å¼ rehash ä¼šå¯¼è‡´å­—å…¸ä¸­çš„æ•°æ®åˆ†æ•£åœ¨ä¸¤ä¸ª dictht ä¸Šï¼Œå› æ­¤å¯¹å­—å…¸çš„æŸ¥æ‰¾æ“ä½œä¹Ÿéœ€è¦åˆ°å¯¹åº”çš„ dictht å»æ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Performs N steps of incremental rehashing. Returns 1 if there are still</span></span><br><span class="line"><span class="comment"> * keys to move from the old to the new hash table, otherwise 0 is returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that a rehashing step consists in moving a bucket (that may have more</span></span><br><span class="line"><span class="comment"> * than one key as we use chaining) from the old to the new hash table, however</span></span><br><span class="line"><span class="comment"> * since part of the hash table may be composed of empty spaces, it is not</span></span><br><span class="line"><span class="comment"> * guaranteed that this function will rehash even a single bucket, since it</span></span><br><span class="line"><span class="comment"> * will visit at max N*10 empty buckets in total, otherwise the amount of</span></span><br><span class="line"><span class="comment"> * work it does would be unbound and the function may block for a long time. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dictRehash</span><span class="params">(dict *d, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> empty_visits = n * <span class="number">10</span>; <span class="comment">/* Max number of empty buckets to visit. */</span></span><br><span class="line">    <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (n-- &amp;&amp; d-&gt;ht[<span class="number">0</span>].used != <span class="number">0</span>) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can&#x27;t overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">        assert(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="type">unsigned</span> <span class="type">long</span>) d-&gt;rehashidx);</span><br><span class="line">        <span class="keyword">while</span> (d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            d-&gt;rehashidx++;</span><br><span class="line">            <span class="keyword">if</span> (--empty_visits == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="keyword">while</span> (de) &#123;</span><br><span class="line">            <span class="type">uint64_t</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</span><br><span class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>].used--;</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].used++;</span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) &#123;</span><br><span class="line">        zfree(d-&gt;ht[<span class="number">0</span>].table);</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</span><br><span class="line">        _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</span><br><span class="line">        d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* More to rehash... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è·³è·ƒè¡¨"><a href="#è·³è·ƒè¡¨" class="headerlink" title="è·³è·ƒè¡¨"></a>è·³è·ƒè¡¨</h3><p>æ˜¯æœ‰åºé›†åˆçš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚</p><p>è·³è·ƒè¡¨æ˜¯åŸºäºå¤šæŒ‡é’ˆæœ‰åºé“¾è¡¨å®ç°çš„ï¼Œå¯ä»¥çœ‹æˆå¤šä¸ªæœ‰åºé“¾è¡¨ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/beba612e-dc5b-4fc2-869d-0b23408ac90a.png" width="600px"/> </div><br></p><p>åœ¨æŸ¥æ‰¾æ—¶ï¼Œä»ä¸Šå±‚æŒ‡é’ˆå¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒºé—´ä¹‹åå†åˆ°ä¸‹ä¸€å±‚å»æŸ¥æ‰¾ã€‚ä¸‹å›¾æ¼”ç¤ºäº†æŸ¥æ‰¾ 22 çš„è¿‡ç¨‹ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/0ea37ee2-c224-4c79-b895-e131c6805c40.png" width="600px"/> </div><br></p><p>ä¸çº¢é»‘æ ‘ç­‰å¹³è¡¡æ ‘ç›¸æ¯”ï¼Œè·³è·ƒè¡¨å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>æ’å…¥é€Ÿåº¦éå¸¸å¿«é€Ÿï¼Œå› ä¸ºä¸éœ€è¦è¿›è¡Œæ—‹è½¬ç­‰æ“ä½œæ¥ç»´æŠ¤å¹³è¡¡æ€§ï¼›</li><li>æ›´å®¹æ˜“å®ç°ï¼›</li><li>æ”¯æŒæ— é”æ“ä½œã€‚</li></ul><h2 id="å››ã€ä½¿ç”¨åœºæ™¯"><a href="#å››ã€ä½¿ç”¨åœºæ™¯" class="headerlink" title="å››ã€ä½¿ç”¨åœºæ™¯"></a>å››ã€ä½¿ç”¨åœºæ™¯</h2><h3 id="è®¡æ•°å™¨"><a href="#è®¡æ•°å™¨" class="headerlink" title="è®¡æ•°å™¨"></a>è®¡æ•°å™¨</h3><p>å¯ä»¥å¯¹ String è¿›è¡Œè‡ªå¢è‡ªå‡è¿ç®—ï¼Œä»è€Œå®ç°è®¡æ•°å™¨åŠŸèƒ½ã€‚</p><p>Redis è¿™ç§å†…å­˜å‹æ•°æ®åº“çš„è¯»å†™æ€§èƒ½éå¸¸é«˜ï¼Œå¾ˆé€‚åˆå­˜å‚¨é¢‘ç¹è¯»å†™çš„è®¡æ•°é‡ã€‚</p><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p>å°†çƒ­ç‚¹æ•°æ®æ”¾åˆ°å†…å­˜ä¸­ï¼Œè®¾ç½®å†…å­˜çš„æœ€å¤§ä½¿ç”¨é‡ä»¥åŠæ·˜æ±°ç­–ç•¥æ¥ä¿è¯ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚</p><h3 id="æŸ¥æ‰¾è¡¨"><a href="#æŸ¥æ‰¾è¡¨" class="headerlink" title="æŸ¥æ‰¾è¡¨"></a>æŸ¥æ‰¾è¡¨</h3><p>ä¾‹å¦‚ DNS è®°å½•å°±å¾ˆé€‚åˆä½¿ç”¨ Redis è¿›è¡Œå­˜å‚¨ã€‚</p><p>æŸ¥æ‰¾è¡¨å’Œç¼“å­˜ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åˆ©ç”¨äº† Redis å¿«é€Ÿçš„æŸ¥æ‰¾ç‰¹æ€§ã€‚ä½†æ˜¯æŸ¥æ‰¾è¡¨çš„å†…å®¹ä¸èƒ½å¤±æ•ˆï¼Œè€Œç¼“å­˜çš„å†…å®¹å¯ä»¥å¤±æ•ˆï¼Œå› ä¸ºç¼“å­˜ä¸ä½œä¸ºå¯é çš„æ•°æ®æ¥æºã€‚</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h3><p>List æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡ lpush å’Œ rpop å†™å…¥å’Œè¯»å–æ¶ˆæ¯</p><p>ä¸è¿‡æœ€å¥½ä½¿ç”¨ Kafkaã€RabbitMQ ç­‰æ¶ˆæ¯ä¸­é—´ä»¶ã€‚</p><h3 id="ä¼šè¯ç¼“å­˜"><a href="#ä¼šè¯ç¼“å­˜" class="headerlink" title="ä¼šè¯ç¼“å­˜"></a>ä¼šè¯ç¼“å­˜</h3><p>å¯ä»¥ä½¿ç”¨ Redis æ¥ç»Ÿä¸€å­˜å‚¨å¤šå°åº”ç”¨æœåŠ¡å™¨çš„ä¼šè¯ä¿¡æ¯ã€‚</p><p>å½“åº”ç”¨æœåŠ¡å™¨ä¸å†å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼Œä¹Ÿå°±ä¸å†å…·æœ‰çŠ¶æ€ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥è¯·æ±‚ä»»æ„ä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨ï¼Œä»è€Œæ›´å®¹æ˜“å®ç°é«˜å¯ç”¨æ€§ä»¥åŠå¯ä¼¸ç¼©æ€§ã€‚</p><h3 id="åˆ†å¸ƒå¼é”å®ç°"><a href="#åˆ†å¸ƒå¼é”å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”å®ç°"></a>åˆ†å¸ƒå¼é”å®ç°</h3><p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæ— æ³•ä½¿ç”¨å•æœºç¯å¢ƒä¸‹çš„é”æ¥å¯¹å¤šä¸ªèŠ‚ç‚¹ä¸Šçš„è¿›ç¨‹è¿›è¡ŒåŒæ­¥ã€‚</p><p>å¯ä»¥ä½¿ç”¨ Redis è‡ªå¸¦çš„ SETNX å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„ RedLock åˆ†å¸ƒå¼é”å®ç°ã€‚</p><h3 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h3><p>Set å¯ä»¥å®ç°äº¤é›†ã€å¹¶é›†ç­‰æ“ä½œï¼Œä»è€Œå®ç°å…±åŒå¥½å‹ç­‰åŠŸèƒ½ã€‚</p><p>ZSet å¯ä»¥å®ç°æœ‰åºæ€§æ“ä½œï¼Œä»è€Œå®ç°æ’è¡Œæ¦œç­‰åŠŸèƒ½ã€‚</p><h2 id="äº”ã€Redis-ä¸-Memcached"><a href="#äº”ã€Redis-ä¸-Memcached" class="headerlink" title="äº”ã€Redis ä¸ Memcached"></a>äº”ã€Redis ä¸ Memcached</h2><p>ä¸¤è€…éƒ½æ˜¯éå…³ç³»å‹å†…å­˜é”®å€¼æ•°æ®åº“ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸åŒï¼š</p><h3 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h3><p>Memcached ä»…æ”¯æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œè€Œ Redis æ”¯æŒäº”ç§ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ›´çµæ´»åœ°è§£å†³é—®é¢˜ã€‚</p><h3 id="æ•°æ®æŒä¹…åŒ–"><a href="#æ•°æ®æŒä¹…åŒ–" class="headerlink" title="æ•°æ®æŒä¹…åŒ–"></a>æ•°æ®æŒä¹…åŒ–</h3><p>Redis æ”¯æŒä¸¤ç§æŒä¹…åŒ–ç­–ç•¥ï¼šRDB å¿«ç…§å’Œ AOF æ—¥å¿—ï¼Œè€Œ Memcached ä¸æ”¯æŒæŒä¹…åŒ–ã€‚</p><h3 id="åˆ†å¸ƒå¼"><a href="#åˆ†å¸ƒå¼" class="headerlink" title="åˆ†å¸ƒå¼"></a>åˆ†å¸ƒå¼</h3><p>Memcached ä¸æ”¯æŒåˆ†å¸ƒå¼ï¼Œåªèƒ½é€šè¿‡åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œæ¥å®ç°åˆ†å¸ƒå¼å­˜å‚¨ï¼Œè¿™ç§æ–¹å¼åœ¨å­˜å‚¨å’ŒæŸ¥è¯¢æ—¶éƒ½éœ€è¦å…ˆåœ¨å®¢æˆ·ç«¯è®¡ç®—ä¸€æ¬¡æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ã€‚</p><p>Redis Cluster å®ç°äº†åˆ†å¸ƒå¼çš„æ”¯æŒã€‚</p><h3 id="å†…å­˜ç®¡ç†æœºåˆ¶"><a href="#å†…å­˜ç®¡ç†æœºåˆ¶" class="headerlink" title="å†…å­˜ç®¡ç†æœºåˆ¶"></a>å†…å­˜ç®¡ç†æœºåˆ¶</h3><ul><li><p>åœ¨ Redis ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½ä¸€ç›´å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥å°†ä¸€äº›å¾ˆä¹…æ²¡ç”¨çš„ value äº¤æ¢åˆ°ç£ç›˜ï¼Œè€Œ Memcached çš„æ•°æ®åˆ™ä¼šä¸€ç›´åœ¨å†…å­˜ä¸­ã€‚</p></li><li><p>Memcached å°†å†…å­˜åˆ†å‰²æˆç‰¹å®šé•¿åº¦çš„å—æ¥å­˜å‚¨æ•°æ®ï¼Œä»¥å®Œå…¨è§£å†³å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¼šä½¿å¾—å†…å­˜çš„åˆ©ç”¨ç‡ä¸é«˜ï¼Œä¾‹å¦‚å—çš„å¤§å°ä¸º 128 bytesï¼Œåªå­˜å‚¨ 100 bytes çš„æ•°æ®ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„ 28 bytes å°±æµªè´¹æ‰äº†ã€‚</p></li></ul><h2 id="å…­ã€é”®çš„è¿‡æœŸæ—¶é—´"><a href="#å…­ã€é”®çš„è¿‡æœŸæ—¶é—´" class="headerlink" title="å…­ã€é”®çš„è¿‡æœŸæ—¶é—´"></a>å…­ã€é”®çš„è¿‡æœŸæ—¶é—´</h2><p>Redis å¯ä»¥ä¸ºæ¯ä¸ªé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå½“é”®è¿‡æœŸæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ é™¤è¯¥é”®ã€‚</p><p>å¯¹äºæ•£åˆ—è¡¨è¿™ç§å®¹å™¨ï¼Œåªèƒ½ä¸ºæ•´ä¸ªé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ•´ä¸ªæ•£åˆ—è¡¨ï¼‰ï¼Œè€Œä¸èƒ½ä¸ºé”®é‡Œé¢çš„å•ä¸ªå…ƒç´ è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</p><h2 id="ä¸ƒã€æ•°æ®æ·˜æ±°ç­–ç•¥"><a href="#ä¸ƒã€æ•°æ®æ·˜æ±°ç­–ç•¥" class="headerlink" title="ä¸ƒã€æ•°æ®æ·˜æ±°ç­–ç•¥"></a>ä¸ƒã€æ•°æ®æ·˜æ±°ç­–ç•¥</h2><p>å¯ä»¥è®¾ç½®å†…å­˜æœ€å¤§ä½¿ç”¨é‡ï¼Œå½“å†…å­˜ä½¿ç”¨é‡è¶…å‡ºæ—¶ï¼Œä¼šæ–½è¡Œæ•°æ®æ·˜æ±°ç­–ç•¥ã€‚</p><p>Redis å…·ä½“æœ‰ 6 ç§æ·˜æ±°ç­–ç•¥ï¼š</p><div class="table-container"><table><thead><tr><th style="text-align:center">ç­–ç•¥</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">volatile-lru</td><td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</td></tr><tr><td style="text-align:center">volatile-ttl</td><td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</td></tr><tr><td style="text-align:center">volatile-random</td><td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</td></tr><tr><td style="text-align:center">allkeys-lru</td><td style="text-align:center">ä»æ‰€æœ‰æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</td></tr><tr><td style="text-align:center">allkeys-random</td><td style="text-align:center">ä»æ‰€æœ‰æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®è¿›è¡Œæ·˜æ±°</td></tr><tr><td style="text-align:center">noeviction</td><td style="text-align:center">ç¦æ­¢é©±é€æ•°æ®</td></tr></tbody></table></div><p>ä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œå‡ºäºå¯¹æ€§èƒ½å’Œå†…å­˜æ¶ˆè€—çš„è€ƒè™‘ï¼ŒRedis çš„æ·˜æ±°ç®—æ³•å®é™…å®ç°ä¸Šå¹¶éé’ˆå¯¹æ‰€æœ‰ keyï¼Œè€Œæ˜¯æŠ½æ ·ä¸€å°éƒ¨åˆ†å¹¶ä¸”ä»ä¸­é€‰å‡ºè¢«æ·˜æ±°çš„ keyã€‚</p><p>ä½¿ç”¨ Redis ç¼“å­˜æ•°æ®æ—¶ï¼Œä¸ºäº†æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œéœ€è¦ä¿è¯ç¼“å­˜æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®ã€‚å¯ä»¥å°†å†…å­˜æœ€å¤§ä½¿ç”¨é‡è®¾ç½®ä¸ºçƒ­ç‚¹æ•°æ®å ç”¨çš„å†…å­˜é‡ï¼Œç„¶åå¯ç”¨ allkeys-lru æ·˜æ±°ç­–ç•¥ï¼Œå°†æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚</p><p>Redis 4.0 å¼•å…¥äº† volatile-lfu å’Œ allkeys-lfu æ·˜æ±°ç­–ç•¥ï¼ŒLFU ç­–ç•¥é€šè¿‡ç»Ÿè®¡è®¿é—®é¢‘ç‡ï¼Œå°†è®¿é—®é¢‘ç‡æœ€å°‘çš„é”®å€¼å¯¹æ·˜æ±°ã€‚</p><h2 id="å…«ã€æŒä¹…åŒ–"><a href="#å…«ã€æŒä¹…åŒ–" class="headerlink" title="å…«ã€æŒä¹…åŒ–"></a>å…«ã€æŒä¹…åŒ–</h2><p>Redis æ˜¯å†…å­˜å‹æ•°æ®åº“ï¼Œä¸ºäº†ä¿è¯æ•°æ®åœ¨æ–­ç”µåä¸ä¼šä¸¢å¤±ï¼Œéœ€è¦å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šã€‚</p><h3 id="RDB-æŒä¹…åŒ–"><a href="#RDB-æŒä¹…åŒ–" class="headerlink" title="RDB æŒä¹…åŒ–"></a>RDB æŒä¹…åŒ–</h3><p>å°†æŸä¸ªæ—¶é—´ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½å­˜æ”¾åˆ°ç¡¬ç›˜ä¸Šã€‚</p><p>å¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶å®ƒæœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ã€‚</p><p>å¦‚æœç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œå°†ä¼šä¸¢å¤±æœ€åä¸€æ¬¡åˆ›å»ºå¿«ç…§ä¹‹åçš„æ•°æ®ã€‚</p><p>å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œä¿å­˜å¿«ç…§çš„æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p><h3 id="AOF-æŒä¹…åŒ–"><a href="#AOF-æŒä¹…åŒ–" class="headerlink" title="AOF æŒä¹…åŒ–"></a>AOF æŒä¹…åŒ–</h3><p>å°†å†™å‘½ä»¤æ·»åŠ åˆ° AOF æ–‡ä»¶ï¼ˆAppend Only Fileï¼‰çš„æœ«å°¾ã€‚</p><p>ä½¿ç”¨ AOF æŒä¹…åŒ–éœ€è¦è®¾ç½®åŒæ­¥é€‰é¡¹ï¼Œä»è€Œç¡®ä¿å†™å‘½ä»¤åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸Šçš„æ—¶æœºã€‚è¿™æ˜¯å› ä¸ºå¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥å¹¶ä¸ä¼šé©¬ä¸Šå°†å†…å®¹åŒæ­¥åˆ°ç£ç›˜ä¸Šï¼Œè€Œæ˜¯å…ˆå­˜å‚¨åˆ°ç¼“å†²åŒºï¼Œç„¶åç”±æ“ä½œç³»ç»Ÿå†³å®šä»€ä¹ˆæ—¶å€™åŒæ­¥åˆ°ç£ç›˜ã€‚æœ‰ä»¥ä¸‹åŒæ­¥é€‰é¡¹ï¼š</p><div class="table-container"><table><thead><tr><th style="text-align:center">é€‰é¡¹</th><th style="text-align:center">åŒæ­¥é¢‘ç‡</th></tr></thead><tbody><tr><td style="text-align:center">always</td><td style="text-align:center">æ¯ä¸ªå†™å‘½ä»¤éƒ½åŒæ­¥</td></tr><tr><td style="text-align:center">everysec</td><td style="text-align:center">æ¯ç§’åŒæ­¥ä¸€æ¬¡</td></tr><tr><td style="text-align:center">no</td><td style="text-align:center">è®©æ“ä½œç³»ç»Ÿæ¥å†³å®šä½•æ—¶åŒæ­¥</td></tr></tbody></table></div><ul><li>always é€‰é¡¹ä¼šä¸¥é‡å‡ä½æœåŠ¡å™¨çš„æ€§èƒ½ï¼›</li><li>everysec é€‰é¡¹æ¯”è¾ƒåˆé€‚ï¼Œå¯ä»¥ä¿è¯ç³»ç»Ÿå´©æºƒæ—¶åªä¼šä¸¢å¤±ä¸€ç§’å·¦å³çš„æ•°æ®ï¼Œå¹¶ä¸” Redis æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥å¯¹æœåŠ¡å™¨æ€§èƒ½å‡ ä¹æ²¡æœ‰ä»»ä½•å½±å“ï¼›</li><li>no é€‰é¡¹å¹¶ä¸èƒ½ç»™æœåŠ¡å™¨æ€§èƒ½å¸¦æ¥å¤šå¤§çš„æå‡ï¼Œè€Œä¸”ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿå´©æºƒæ—¶æ•°æ®ä¸¢å¤±çš„æ•°é‡ã€‚</li></ul><p>éšç€æœåŠ¡å™¨å†™è¯·æ±‚çš„å¢å¤šï¼ŒAOF æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ã€‚Redis æä¾›äº†ä¸€ç§å°† AOF é‡å†™çš„ç‰¹æ€§ï¼Œèƒ½å¤Ÿå»é™¤ AOF æ–‡ä»¶ä¸­çš„å†—ä½™å†™å‘½ä»¤ã€‚</p><h2 id="ä¹ã€äº‹åŠ¡"><a href="#ä¹ã€äº‹åŠ¡" class="headerlink" title="ä¹ã€äº‹åŠ¡"></a>ä¹ã€äº‹åŠ¡</h2><p>ä¸€ä¸ªäº‹åŠ¡åŒ…å«äº†å¤šä¸ªå‘½ä»¤ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œäº‹åŠ¡æœŸé—´ï¼Œä¸ä¼šæ”¹å»æ‰§è¡Œå…¶å®ƒå®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ã€‚</p><p>äº‹åŠ¡ä¸­çš„å¤šä¸ªå‘½ä»¤è¢«ä¸€æ¬¡æ€§å‘é€ç»™æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯ä¸€æ¡ä¸€æ¡å‘é€ï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸ºæµæ°´çº¿ï¼Œå®ƒå¯ä»¥å‡å°‘å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œé€šä¿¡æ¬¡æ•°ä»è€Œæå‡æ€§èƒ½ã€‚</p><p>Redis æœ€ç®€å•çš„äº‹åŠ¡å®ç°æ–¹å¼æ˜¯ä½¿ç”¨ MULTI å’Œ EXEC å‘½ä»¤å°†äº‹åŠ¡æ“ä½œåŒ…å›´èµ·æ¥ã€‚</p><h2 id="åã€äº‹ä»¶"><a href="#åã€äº‹ä»¶" class="headerlink" title="åã€äº‹ä»¶"></a>åã€äº‹ä»¶</h2><p>Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºã€‚</p><h3 id="æ–‡ä»¶äº‹ä»¶"><a href="#æ–‡ä»¶äº‹ä»¶" class="headerlink" title="æ–‡ä»¶äº‹ä»¶"></a>æ–‡ä»¶äº‹ä»¶</h3><p>æœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯æˆ–è€…å…¶å®ƒæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚</p><p>Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶å°†åˆ°è¾¾çš„äº‹ä»¶ä¼ é€ç»™æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œåˆ†æ´¾å™¨ä¼šæ ¹æ®å¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶ç±»å‹è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9ea86eb5-000a-4281-b948-7b567bd6f1d8.png" width=""/> </div><br></p><h3 id="æ—¶é—´äº‹ä»¶"><a href="#æ—¶é—´äº‹ä»¶" class="headerlink" title="æ—¶é—´äº‹ä»¶"></a>æ—¶é—´äº‹ä»¶</h3><p>æœåŠ¡å™¨æœ‰ä¸€äº›æ“ä½œéœ€è¦åœ¨ç»™å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œï¼Œæ—¶é—´äº‹ä»¶æ˜¯å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡ã€‚</p><p>æ—¶é—´äº‹ä»¶åˆåˆ†ä¸ºï¼š</p><ul><li>å®šæ—¶äº‹ä»¶ï¼šæ˜¯è®©ä¸€æ®µç¨‹åºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹å†…æ‰§è¡Œä¸€æ¬¡ï¼›</li><li>å‘¨æœŸæ€§äº‹ä»¶ï¼šæ˜¯è®©ä¸€æ®µç¨‹åºæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><p>Redis å°†æ‰€æœ‰æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ— åºé“¾è¡¨ä¸­ï¼Œé€šè¿‡éå†æ•´ä¸ªé“¾è¡¨æŸ¥æ‰¾å‡ºå·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><h3 id="äº‹ä»¶çš„è°ƒåº¦ä¸æ‰§è¡Œ"><a href="#äº‹ä»¶çš„è°ƒåº¦ä¸æ‰§è¡Œ" class="headerlink" title="äº‹ä»¶çš„è°ƒåº¦ä¸æ‰§è¡Œ"></a>äº‹ä»¶çš„è°ƒåº¦ä¸æ‰§è¡Œ</h3><p>æœåŠ¡å™¨éœ€è¦ä¸æ–­ç›‘å¬æ–‡ä»¶äº‹ä»¶çš„å¥—æ¥å­—æ‰èƒ½å¾—åˆ°å¾…å¤„ç†çš„æ–‡ä»¶äº‹ä»¶ï¼Œä½†æ˜¯ä¸èƒ½ä¸€ç›´ç›‘å¬ï¼Œå¦åˆ™æ—¶é—´äº‹ä»¶æ— æ³•åœ¨è§„å®šçš„æ—¶é—´å†…æ‰§è¡Œï¼Œå› æ­¤ç›‘å¬æ—¶é—´åº”è¯¥æ ¹æ®è·ç¦»ç°åœ¨æœ€è¿‘çš„æ—¶é—´äº‹ä»¶æ¥å†³å®šã€‚</p><p>äº‹ä»¶è°ƒåº¦ä¸æ‰§è¡Œç”± aeProcessEvents å‡½æ•°è´Ÿè´£ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">aeProcessEvents</span>():</span><br><span class="line">    <span class="comment"># è·å–åˆ°è¾¾æ—¶é—´ç¦»å½“å‰æ—¶é—´æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶</span></span><br><span class="line">    time_event = aeSearchNearestTimer()</span><br><span class="line">    <span class="comment"># è®¡ç®—æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶è·ç¦»åˆ°è¾¾è¿˜æœ‰å¤šå°‘æ¯«ç§’</span></span><br><span class="line">    remaind_ms = time_event.when - unix_ts_now()</span><br><span class="line">    <span class="comment"># å¦‚æœäº‹ä»¶å·²åˆ°è¾¾ï¼Œé‚£ä¹ˆ remaind_ms çš„å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œå°†å®ƒè®¾ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> remaind_ms &lt; <span class="number">0</span>:</span><br><span class="line">        remaind_ms = <span class="number">0</span></span><br><span class="line">    <span class="comment"># æ ¹æ® remaind_ms çš„å€¼ï¼Œåˆ›å»º timeval</span></span><br><span class="line">    timeval = create_timeval_with_ms(remaind_ms)</span><br><span class="line">    <span class="comment"># é˜»å¡å¹¶ç­‰å¾…æ–‡ä»¶äº‹ä»¶äº§ç”Ÿï¼Œæœ€å¤§é˜»å¡æ—¶é—´ç”±ä¼ å…¥çš„ timeval å†³å®š</span></span><br><span class="line">    aeApiPoll(timeval)</span><br><span class="line">    <span class="comment"># å¤„ç†æ‰€æœ‰å·²äº§ç”Ÿçš„æ–‡ä»¶äº‹ä»¶</span></span><br><span class="line">    procesFileEvents()</span><br><span class="line">    <span class="comment"># å¤„ç†æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶</span></span><br><span class="line">    processTimeEvents()</span><br></pre></td></tr></table></figure><p>å°† aeProcessEvents å‡½æ•°ç½®äºä¸€ä¸ªå¾ªç¯é‡Œé¢ï¼ŒåŠ ä¸Šåˆå§‹åŒ–å’Œæ¸…ç†å‡½æ•°ï¼Œå°±æ„æˆäº† Redis æœåŠ¡å™¨çš„ä¸»å‡½æ•°ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–æœåŠ¡å™¨</span></span><br><span class="line">    init_server()</span><br><span class="line">    <span class="comment"># ä¸€ç›´å¤„ç†äº‹ä»¶ï¼Œç›´åˆ°æœåŠ¡å™¨å…³é—­ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">while</span> server_is_not_shutdown():</span><br><span class="line">        aeProcessEvents()</span><br><span class="line">    <span class="comment"># æœåŠ¡å™¨å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†æ“ä½œ</span></span><br><span class="line">    clean_server()</span><br></pre></td></tr></table></figure><p>ä»äº‹ä»¶å¤„ç†çš„è§’åº¦æ¥çœ‹ï¼ŒæœåŠ¡å™¨è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c0a9fa91-da2e-4892-8c9f-80206a6f7047.png" width="350"/> </div><br></p><h2 id="åä¸€ã€å¤åˆ¶"><a href="#åä¸€ã€å¤åˆ¶" class="headerlink" title="åä¸€ã€å¤åˆ¶"></a>åä¸€ã€å¤åˆ¶</h2><p>é€šè¿‡ä½¿ç”¨ slaveof host port å‘½ä»¤æ¥è®©ä¸€ä¸ªæœåŠ¡å™¨æˆä¸ºå¦ä¸€ä¸ªæœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ã€‚</p><p>ä¸€ä¸ªä»æœåŠ¡å™¨åªèƒ½æœ‰ä¸€ä¸ªä¸»æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸æ”¯æŒä¸»ä¸»å¤åˆ¶ã€‚</p><h3 id="è¿æ¥è¿‡ç¨‹"><a href="#è¿æ¥è¿‡ç¨‹" class="headerlink" title="è¿æ¥è¿‡ç¨‹"></a>è¿æ¥è¿‡ç¨‹</h3><ol><li><p>ä¸»æœåŠ¡å™¨åˆ›å»ºå¿«ç…§æ–‡ä»¶ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨å‘é€æœŸé—´ä½¿ç”¨ç¼“å†²åŒºè®°å½•æ‰§è¡Œçš„å†™å‘½ä»¤ã€‚å¿«ç…§æ–‡ä»¶å‘é€å®Œæ¯•ä¹‹åï¼Œå¼€å§‹å‘ä»æœåŠ¡å™¨å‘é€å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤ï¼›</p></li><li><p>ä»æœåŠ¡å™¨ä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®ï¼Œè½½å…¥ä¸»æœåŠ¡å™¨å‘æ¥çš„å¿«ç…§æ–‡ä»¶ï¼Œä¹‹åä»æœåŠ¡å™¨å¼€å§‹æ¥å—ä¸»æœåŠ¡å™¨å‘æ¥çš„å†™å‘½ä»¤ï¼›</p></li><li><p>ä¸»æœåŠ¡å™¨æ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œå°±å‘ä»æœåŠ¡å™¨å‘é€ç›¸åŒçš„å†™å‘½ä»¤ã€‚</p></li></ol><h3 id="ä¸»ä»é“¾"><a href="#ä¸»ä»é“¾" class="headerlink" title="ä¸»ä»é“¾"></a>ä¸»ä»é“¾</h3><p>éšç€è´Ÿè½½ä¸æ–­ä¸Šå‡ï¼Œä¸»æœåŠ¡å™¨å¯èƒ½æ— æ³•å¾ˆå¿«åœ°æ›´æ–°æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œæˆ–è€…é‡æ–°è¿æ¥å’Œé‡æ–°åŒæ­¥ä»æœåŠ¡å™¨å°†å¯¼è‡´ç³»ç»Ÿè¶…è½½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸­é—´å±‚æ¥åˆ†æ‹…ä¸»æœåŠ¡å™¨çš„å¤åˆ¶å·¥ä½œã€‚ä¸­é—´å±‚çš„æœåŠ¡å™¨æ˜¯æœ€ä¸Šå±‚æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œåˆæ˜¯æœ€ä¸‹å±‚æœåŠ¡å™¨çš„ä¸»æœåŠ¡å™¨ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/395a9e83-b1a1-4a1d-b170-d081e7bb5bab.png" width="600"/> </div><br></p><h2 id="åäºŒã€Sentinel"><a href="#åäºŒã€Sentinel" class="headerlink" title="åäºŒã€Sentinel"></a>åäºŒã€Sentinel</h2><p>Sentinelï¼ˆå“¨å…µï¼‰å¯ä»¥ç›‘å¬é›†ç¾¤ä¸­çš„æœåŠ¡å™¨ï¼Œå¹¶åœ¨ä¸»æœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œè‡ªåŠ¨ä»ä»æœåŠ¡å™¨ä¸­é€‰ä¸¾å‡ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚</p><h2 id="åä¸‰ã€åˆ†ç‰‡"><a href="#åä¸‰ã€åˆ†ç‰‡" class="headerlink" title="åä¸‰ã€åˆ†ç‰‡"></a>åä¸‰ã€åˆ†ç‰‡</h2><p>åˆ†ç‰‡æ˜¯å°†æ•°æ®åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†çš„æ–¹æ³•ï¼Œå¯ä»¥å°†æ•°æ®å­˜å‚¨åˆ°å¤šå°æœºå™¨é‡Œé¢ï¼Œè¿™ç§æ–¹æ³•åœ¨è§£å†³æŸäº›é—®é¢˜æ—¶å¯ä»¥è·å¾—çº¿æ€§çº§åˆ«çš„æ€§èƒ½æå‡ã€‚</p><p>å‡è®¾æœ‰ 4 ä¸ª Redis å®ä¾‹ R0ï¼ŒR1ï¼ŒR2ï¼ŒR3ï¼Œè¿˜æœ‰å¾ˆå¤šè¡¨ç¤ºç”¨æˆ·çš„é”® user:1ï¼Œuser:2ï¼Œâ€¦ ï¼Œæœ‰ä¸åŒçš„æ–¹å¼æ¥é€‰æ‹©ä¸€ä¸ªæŒ‡å®šçš„é”®å­˜å‚¨åœ¨å“ªä¸ªå®ä¾‹ä¸­ã€‚</p><ul><li>æœ€ç®€å•çš„æ–¹å¼æ˜¯èŒƒå›´åˆ†ç‰‡ï¼Œä¾‹å¦‚ç”¨æˆ· id ä» 0~1000 çš„å­˜å‚¨åˆ°å®ä¾‹ R0 ä¸­ï¼Œç”¨æˆ· id ä» 1001~2000 çš„å­˜å‚¨åˆ°å®ä¾‹ R1 ä¸­ï¼Œç­‰ç­‰ã€‚ä½†æ˜¯è¿™æ ·éœ€è¦ç»´æŠ¤ä¸€å¼ æ˜ å°„èŒƒå›´è¡¨ï¼Œç»´æŠ¤æ“ä½œä»£ä»·å¾ˆé«˜ã€‚</li><li>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯å“ˆå¸Œåˆ†ç‰‡ï¼Œä½¿ç”¨ CRC32 å“ˆå¸Œå‡½æ•°å°†é”®è½¬æ¢ä¸ºä¸€ä¸ªæ•°å­—ï¼Œå†å¯¹å®ä¾‹æ•°é‡æ±‚æ¨¡å°±èƒ½çŸ¥é“åº”è¯¥å­˜å‚¨çš„å®ä¾‹ã€‚</li></ul><p>æ ¹æ®æ‰§è¡Œåˆ†ç‰‡çš„ä½ç½®ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç§åˆ†ç‰‡æ–¹å¼ï¼š</p><ul><li>å®¢æˆ·ç«¯åˆ†ç‰‡ï¼šå®¢æˆ·ç«¯ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç­‰ç®—æ³•å†³å®šé”®åº”å½“åˆ†å¸ƒåˆ°å“ªä¸ªèŠ‚ç‚¹ã€‚</li><li>ä»£ç†åˆ†ç‰‡ï¼šå°†å®¢æˆ·ç«¯è¯·æ±‚å‘é€åˆ°ä»£ç†ä¸Šï¼Œç”±ä»£ç†è½¬å‘è¯·æ±‚åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šã€‚</li><li>æœåŠ¡å™¨åˆ†ç‰‡ï¼šRedis Clusterã€‚</li></ul><h2 id="åå››ã€ä¸€ä¸ªç®€å•çš„è®ºå›ç³»ç»Ÿåˆ†æ"><a href="#åå››ã€ä¸€ä¸ªç®€å•çš„è®ºå›ç³»ç»Ÿåˆ†æ" class="headerlink" title="åå››ã€ä¸€ä¸ªç®€å•çš„è®ºå›ç³»ç»Ÿåˆ†æ"></a>åå››ã€ä¸€ä¸ªç®€å•çš„è®ºå›ç³»ç»Ÿåˆ†æ</h2><p>è¯¥è®ºå›ç³»ç»ŸåŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>å¯ä»¥å‘å¸ƒæ–‡ç« ï¼›</li><li>å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œç‚¹èµï¼›</li><li>åœ¨é¦–é¡µå¯ä»¥æŒ‰æ–‡ç« çš„å‘å¸ƒæ—¶é—´æˆ–è€…æ–‡ç« çš„ç‚¹èµæ•°è¿›è¡Œæ’åºæ˜¾ç¤ºã€‚</li></ul><h3 id="æ–‡ç« ä¿¡æ¯"><a href="#æ–‡ç« ä¿¡æ¯" class="headerlink" title="æ–‡ç« ä¿¡æ¯"></a>æ–‡ç« ä¿¡æ¯</h3><p>æ–‡ç« åŒ…æ‹¬æ ‡é¢˜ã€ä½œè€…ã€èµæ•°ç­‰ä¿¡æ¯ï¼Œåœ¨å…³ç³»å‹æ•°æ®åº“ä¸­å¾ˆå®¹æ˜“æ„å»ºä¸€å¼ è¡¨æ¥å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼Œåœ¨ Redis ä¸­å¯ä»¥ä½¿ç”¨ HASH æ¥å­˜å‚¨æ¯ç§ä¿¡æ¯ä»¥åŠå…¶å¯¹åº”çš„å€¼çš„æ˜ å°„ã€‚</p><p>Redis æ²¡æœ‰å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨è¿™ä¸€æ¦‚å¿µæ¥å°†åŒç§ç±»å‹çš„æ•°æ®å­˜æ”¾åœ¨ä¸€èµ·ï¼Œè€Œæ˜¯ä½¿ç”¨å‘½åç©ºé—´çš„æ–¹å¼æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚é”®åçš„å‰é¢éƒ¨åˆ†å­˜å‚¨å‘½åç©ºé—´ï¼Œåé¢éƒ¨åˆ†çš„å†…å®¹å­˜å‚¨ IDï¼Œé€šå¸¸ä½¿ç”¨ : æ¥è¿›è¡Œåˆ†éš”ã€‚ä¾‹å¦‚ä¸‹é¢çš„ HASH çš„é”®åä¸º article:92617ï¼Œå…¶ä¸­ article ä¸ºå‘½åç©ºé—´ï¼ŒID ä¸º 92617ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7c54de21-e2ff-402e-bc42-4037de1c1592.png" width="400"/> </div><br></p><h3 id="ç‚¹èµåŠŸèƒ½"><a href="#ç‚¹èµåŠŸèƒ½" class="headerlink" title="ç‚¹èµåŠŸèƒ½"></a>ç‚¹èµåŠŸèƒ½</h3><p>å½“æœ‰ç”¨æˆ·ä¸ºä¸€ç¯‡æ–‡ç« ç‚¹èµæ—¶ï¼Œé™¤äº†è¦å¯¹è¯¥æ–‡ç« çš„ votes å­—æ®µè¿›è¡ŒåŠ  1 æ“ä½œï¼Œè¿˜å¿…é¡»è®°å½•è¯¥ç”¨æˆ·å·²ç»å¯¹è¯¥æ–‡ç« è¿›è¡Œäº†ç‚¹èµï¼Œé˜²æ­¢ç”¨æˆ·ç‚¹èµæ¬¡æ•°è¶…è¿‡ 1ã€‚å¯ä»¥å»ºç«‹æ–‡ç« çš„å·²æŠ•ç¥¨ç”¨æˆ·é›†åˆæ¥è¿›è¡Œè®°å½•ã€‚</p><p>ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œè§„å®šä¸€ç¯‡æ–‡ç« å‘å¸ƒæ»¡ä¸€å‘¨ä¹‹åï¼Œå°±ä¸èƒ½å†å¯¹å®ƒè¿›è¡ŒæŠ•ç¥¨ï¼Œè€Œæ–‡ç« çš„å·²æŠ•ç¥¨é›†åˆä¹Ÿä¼šè¢«åˆ é™¤ï¼Œå¯ä»¥ä¸ºæ–‡ç« çš„å·²æŠ•ç¥¨é›†åˆè®¾ç½®ä¸€ä¸ªä¸€å‘¨çš„è¿‡æœŸæ—¶é—´å°±èƒ½å®ç°è¿™ä¸ªè§„å®šã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/485fdf34-ccf8-4185-97c6-17374ee719a0.png" width="400"/> </div><br></p><h3 id="å¯¹æ–‡ç« è¿›è¡Œæ’åº"><a href="#å¯¹æ–‡ç« è¿›è¡Œæ’åº" class="headerlink" title="å¯¹æ–‡ç« è¿›è¡Œæ’åº"></a>å¯¹æ–‡ç« è¿›è¡Œæ’åº</h3><p>ä¸ºäº†æŒ‰å‘å¸ƒæ—¶é—´å’Œç‚¹èµæ•°è¿›è¡Œæ’åºï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªæ–‡ç« å‘å¸ƒæ—¶é—´çš„æœ‰åºé›†åˆå’Œä¸€ä¸ªæ–‡ç« ç‚¹èµæ•°çš„æœ‰åºé›†åˆã€‚ï¼ˆä¸‹å›¾ä¸­çš„ score å°±æ˜¯è¿™é‡Œæ‰€è¯´çš„ç‚¹èµæ•°ï¼›ä¸‹é¢æ‰€ç¤ºçš„æœ‰åºé›†åˆåˆ†å€¼å¹¶ä¸ç›´æ¥æ˜¯æ—¶é—´å’Œç‚¹èµæ•°ï¼Œè€Œæ˜¯æ ¹æ®æ—¶é—´å’Œç‚¹èµæ•°é—´æ¥è®¡ç®—å‡ºæ¥çš„ï¼‰</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f7d170a3-e446-4a64-ac2d-cb95028f81a8.png" width="800"/> </div><br></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>Carlson J L. Redis in Action[J]. Media.johnwiley.com.au, 2013.</li><li><a href="http://redisbook.com/index.html">é»„å¥å®. Redis è®¾è®¡ä¸å®ç° [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2014.</a></li><li><a href="https://redislabs.com/ebook/foreword/">REDIS IN ACTION</a></li><li><a href="http://ticki.github.io/blog/skip-lists-done-right/">Skip Lists: Done Right</a></li><li><a href="http://www.cnblogs.com/loveincode/p/7411911.html">è®ºè¿° Redis å’Œ Memcached çš„å·®å¼‚</a></li><li><a href="http://wiki.jikexueyuan.com/project/redis-guide">Redis 3.0 ä¸­æ–‡ç‰ˆ- åˆ†ç‰‡</a></li><li><a href="http://www.scienjus.com/redis-use-case/">Redis åº”ç”¨åœºæ™¯</a></li><li><a href="https://redis.io/topics/lru-cache">Using Redis as an LRU cache</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ redisçš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="redis" scheme="https://www.jodio.cc/categories/redis/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç å¯è¯»æ€§</title>
    <link href="https://www.jodio.cc/posts/6f3e.html"/>
    <id>https://www.jodio.cc/posts/6f3e.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å¯è¯»æ€§çš„é‡è¦æ€§"><a href="#ä¸€ã€å¯è¯»æ€§çš„é‡è¦æ€§" class="headerlink" title="ä¸€ã€å¯è¯»æ€§çš„é‡è¦æ€§"></a>ä¸€ã€å¯è¯»æ€§çš„é‡è¦æ€§</h1><p>ç¼–ç¨‹æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´æ˜¯åœ¨é˜…è¯»ä»£ç ï¼Œä¸ä»…è¦é˜…è¯»è‡ªå·±çš„ä»£ç ï¼Œè€Œä¸”è¦é˜…è¯»åˆ«äººçš„ä»£ç ã€‚å› æ­¤ï¼Œå¯è¯»æ€§è‰¯å¥½çš„ä»£ç èƒ½å¤Ÿå¤§å¤§æé«˜ç¼–ç¨‹æ•ˆç‡ã€‚</p><p>å¯è¯»æ€§è‰¯å¥½çš„ä»£ç å¾€å¾€ä¼šè®©ä»£ç æ¶æ„æ›´å¥½ï¼Œå› ä¸ºç¨‹åºå‘˜æ›´æ„¿æ„å»ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç ï¼Œè€Œä¸”ä¹Ÿæ›´å®¹æ˜“ä¿®æ”¹ã€‚</p><p>åªæœ‰åœ¨æ ¸å¿ƒé¢†åŸŸä¸ºäº†æ•ˆç‡æ‰å¯ä»¥æ”¾å¼ƒå¯è¯»æ€§ï¼Œå¦åˆ™å¯è¯»æ€§æ˜¯ç¬¬ä¸€ä½ã€‚</p><h1 id="äºŒã€ç”¨åå­—è¡¨è¾¾ä»£ç å«ä¹‰"><a href="#äºŒã€ç”¨åå­—è¡¨è¾¾ä»£ç å«ä¹‰" class="headerlink" title="äºŒã€ç”¨åå­—è¡¨è¾¾ä»£ç å«ä¹‰"></a>äºŒã€ç”¨åå­—è¡¨è¾¾ä»£ç å«ä¹‰</h1><p>ä¸€äº›æ¯”è¾ƒæœ‰è¡¨è¾¾åŠ›çš„å•è¯ï¼š</p><div class="table-container"><table><thead><tr><th style="text-align:center">å•è¯</th><th>å¯æ›¿ä»£å•è¯</th></tr></thead><tbody><tr><td style="text-align:center">send</td><td>deliverã€dispatchã€announceã€distributeã€route</td></tr><tr><td style="text-align:center">find</td><td>searchã€extractã€locateã€recover</td></tr><tr><td style="text-align:center">start</td><td>launchã€createã€beginã€open</td></tr><tr><td style="text-align:center">make</td><td>createã€set upã€buildã€generateã€composeã€addã€new</td></tr></tbody></table></div><p>ä½¿ç”¨ iã€jã€k ä½œä¸ºå¾ªç¯è¿­ä»£å™¨çš„åå­—è¿‡äºç®€å•ï¼Œuser_iã€member_i è¿™ç§åå­—ä¼šæ›´æœ‰è¡¨è¾¾åŠ›ã€‚å› ä¸ºå¾ªç¯å±‚æ¬¡è¶Šå¤šï¼Œä»£ç è¶Šéš¾ç†è§£ï¼Œæœ‰è¡¨è¾¾åŠ›çš„è¿­ä»£å™¨åå­—å¯è¯»æ€§ä¼šæ›´é«˜ã€‚</p><p>ä¸ºåå­—æ·»åŠ å½¢å®¹è¯ç­‰ä¿¡æ¯èƒ½è®©åå­—æ›´å…·æœ‰è¡¨è¾¾åŠ›ï¼Œä½†æ˜¯åå­—ä¹Ÿä¼šå˜é•¿ã€‚åå­—é•¿çŸ­çš„å‡†åˆ™æ˜¯ï¼šä½œç”¨åŸŸè¶Šå¤§ï¼Œåå­—è¶Šé•¿ã€‚å› æ­¤åªæœ‰åœ¨çŸ­ä½œç”¨åŸŸæ‰èƒ½ä½¿ç”¨ä¸€äº›ç®€å•åå­—ã€‚</p><h1 id="ä¸‰ã€åå­—ä¸èƒ½å¸¦æ¥æ­§ä¹‰"><a href="#ä¸‰ã€åå­—ä¸èƒ½å¸¦æ¥æ­§ä¹‰" class="headerlink" title="ä¸‰ã€åå­—ä¸èƒ½å¸¦æ¥æ­§ä¹‰"></a>ä¸‰ã€åå­—ä¸èƒ½å¸¦æ¥æ­§ä¹‰</h1><p>èµ·å®Œåå­—è¦æ€è€ƒä¸€ä¸‹åˆ«äººä¼šå¯¹è¿™ä¸ªåå­—æœ‰ä½•è§£è¯»ï¼Œä¼šä¸ä¼šè¯¯è§£äº†åŸæœ¬æƒ³è¡¨è¾¾çš„å«ä¹‰ã€‚</p><p>å¸ƒå°”ç›¸å…³çš„å‘½ååŠ ä¸Š isã€canã€shouldã€has ç­‰å‰ç¼€ã€‚</p><ul><li>ç”¨ minã€max è¡¨ç¤ºæ•°é‡èŒƒå›´ï¼›</li><li><p>ç”¨ firstã€last è¡¨ç¤ºè®¿é—®ç©ºé—´çš„åŒ…å«èŒƒå›´ï¼›</p></li><li><p>beginã€end è¡¨ç¤ºè®¿é—®ç©ºé—´çš„æ’é™¤èŒƒå›´ï¼Œå³ end ä¸åŒ…å«å°¾éƒ¨ã€‚</p></li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191209003453268.png"/> </div><br></p><h1 id="å››ã€è‰¯å¥½çš„ä»£ç é£æ ¼"><a href="#å››ã€è‰¯å¥½çš„ä»£ç é£æ ¼" class="headerlink" title="å››ã€è‰¯å¥½çš„ä»£ç é£æ ¼"></a>å››ã€è‰¯å¥½çš„ä»£ç é£æ ¼</h1><p>é€‚å½“çš„ç©ºè¡Œå’Œç¼©è¿›ã€‚</p><p>æ’åˆ—æ•´é½çš„æ³¨é‡Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;   <span class="comment">// æ³¨é‡Š</span></span><br><span class="line"><span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">11</span>;  <span class="comment">// æ³¨é‡Š</span></span><br><span class="line"><span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">111</span>; <span class="comment">// æ³¨é‡Š</span></span><br></pre></td></tr></table></figure><p>è¯­å¥é¡ºåºä¸èƒ½éšæ„ï¼Œæ¯”å¦‚ä¸ html è¡¨å•ç›¸å…³è”çš„å˜é‡çš„èµ‹å€¼åº”è¯¥å’Œè¡¨å•åœ¨ html ä¸­çš„é¡ºåºä¸€è‡´ã€‚</p><h1 id="äº”ã€ä¸ºä½•ç¼–å†™æ³¨é‡Š"><a href="#äº”ã€ä¸ºä½•ç¼–å†™æ³¨é‡Š" class="headerlink" title="äº”ã€ä¸ºä½•ç¼–å†™æ³¨é‡Š"></a>äº”ã€ä¸ºä½•ç¼–å†™æ³¨é‡Š</h1><p>é˜…è¯»ä»£ç é¦–å…ˆä¼šæ³¨æ„åˆ°æ³¨é‡Šï¼Œå¦‚æœæ³¨é‡Šæ²¡å¤ªå¤§ä½œç”¨ï¼Œé‚£ä¹ˆå°±ä¼šæµªè´¹ä»£ç é˜…è¯»çš„æ—¶é—´ã€‚é‚£äº›èƒ½ç›´æ¥çœ‹å‡ºå«ä¹‰çš„ä»£ç ä¸éœ€è¦å†™æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯ä¸éœ€è¦ä¸ºæ¯ä¸ªæ–¹æ³•éƒ½åŠ ä¸Šæ³¨é‡Šï¼Œæ¯”å¦‚é‚£äº›ç®€å•çš„ getter å’Œ setter æ–¹æ³•ï¼Œä¸ºè¿™äº›æ–¹æ³•å†™æ³¨é‡Šåè€Œè®©ä»£ç å¯è¯»æ€§æ›´å·®ã€‚</p><p>ä¸èƒ½å› ä¸ºæœ‰æ³¨é‡Šå°±éšä¾¿èµ·ä¸ªåå­—ï¼Œè€Œæ˜¯äº‰å–èµ·ä¸ªå¥½åå­—è€Œä¸å†™æ³¨é‡Šã€‚</p><p>å¯ä»¥ç”¨æ³¨é‡Šæ¥è®°å½•é‡‡ç”¨å½“å‰è§£å†³åŠæ³•çš„æ€è€ƒè¿‡ç¨‹ï¼Œä»è€Œè®©è¯»è€…æ›´å®¹æ˜“ç†è§£ä»£ç ã€‚</p><p>æ³¨é‡Šç”¨æ¥æé†’ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚</p><p>ç”¨ TODO ç­‰åšæ ‡è®°ï¼š</p><div class="table-container"><table><thead><tr><th>æ ‡è®°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>TODO</td><td>å¾…åš</td></tr><tr><td>FIXME</td><td>å¾…ä¿®å¤</td></tr><tr><td>HACK</td><td>ç²—ç³™çš„è§£å†³æ–¹æ¡ˆ</td></tr><tr><td>XXX</td><td>å±é™©ï¼è¿™é‡Œæœ‰é‡è¦çš„é—®é¢˜</td></tr></tbody></table></div><h1 id="å…­ã€å¦‚ä½•ç¼–å†™æ³¨é‡Š"><a href="#å…­ã€å¦‚ä½•ç¼–å†™æ³¨é‡Š" class="headerlink" title="å…­ã€å¦‚ä½•ç¼–å†™æ³¨é‡Š"></a>å…­ã€å¦‚ä½•ç¼–å†™æ³¨é‡Š</h1><p>å°½é‡ç®€æ´æ˜äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The first String is student&#x27;s name</span></span><br><span class="line"><span class="comment">// The Second Integer is student&#x27;s score</span></span><br><span class="line">Map&lt;String, Integer&gt; scoreMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Student&#x27;s name -&gt; Student&#x27;s score</span></span><br><span class="line">Map&lt;String, Integer&gt; scoreMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><p>æ·»åŠ æµ‹è¯•ç”¨ä¾‹æ¥è¯´æ˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Example: add(1, 2), return 3</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸“ä¸šåè¯æ¥ç¼©çŸ­æ¦‚å¿µä¸Šçš„è§£é‡Šï¼Œæ¯”å¦‚ç”¨è®¾è®¡æ¨¡å¼åæ¥è¯´æ˜ä»£ç ã€‚</p><h1 id="ä¸ƒã€æé«˜æ§åˆ¶æµçš„å¯è¯»æ€§"><a href="#ä¸ƒã€æé«˜æ§åˆ¶æµçš„å¯è¯»æ€§" class="headerlink" title="ä¸ƒã€æé«˜æ§åˆ¶æµçš„å¯è¯»æ€§"></a>ä¸ƒã€æé«˜æ§åˆ¶æµçš„å¯è¯»æ€§</h1><p>æ¡ä»¶è¡¨è¾¾å¼ä¸­ï¼Œå·¦ä¾§æ˜¯å˜é‡ï¼Œå³ä¾§æ˜¯å¸¸æ•°ã€‚æ¯”å¦‚ä¸‹é¢ç¬¬ä¸€ä¸ªè¯­å¥æ­£ç¡®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len &lt; <span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> (<span class="number">10</span> &gt; len)</span><br></pre></td></tr></table></figure><p>åªæœ‰åœ¨é€»è¾‘ç®€å•çš„æƒ…å†µä¸‹ä½¿ç”¨ ? : ä¸‰ç›®è¿ç®—ç¬¦æ¥ä½¿ä»£ç æ›´ç´§å‡‘ï¼Œå¦åˆ™åº”è¯¥æ‹†åˆ†æˆ if / elseï¼›</p><p>do / while çš„æ¡ä»¶æ”¾åœ¨åé¢ï¼Œä¸å¤Ÿç®€å•æ˜äº†ï¼Œå¹¶ä¸”ä¼šæœ‰ä¸€äº›è¿·æƒ‘çš„åœ°æ–¹ï¼Œæœ€å¥½ä½¿ç”¨ while æ¥ä»£æ›¿ã€‚</p><p>å¦‚æœåªæœ‰ä¸€ä¸ª goto ç›®æ ‡ï¼Œé‚£ä¹ˆ goto å°šä¸”è¿˜èƒ½æ¥å—ï¼Œä½†æ˜¯è¿‡äºå¤æ‚çš„ goto ä¼šè®©ä»£ç å¯è¯»æ€§ç‰¹åˆ«å·®ï¼Œåº”è¯¥é¿å…ä½¿ç”¨ gotoã€‚</p><p>åœ¨åµŒå¥—çš„å¾ªç¯ä¸­ï¼Œç”¨ä¸€äº› return è¯­å¥å¾€å¾€èƒ½å‡å°‘åµŒå¥—çš„å±‚æ•°ã€‚</p><h1 id="å…«ã€æ‹†åˆ†é•¿è¡¨è¾¾å¼"><a href="#å…«ã€æ‹†åˆ†é•¿è¡¨è¾¾å¼" class="headerlink" title="å…«ã€æ‹†åˆ†é•¿è¡¨è¾¾å¼"></a>å…«ã€æ‹†åˆ†é•¿è¡¨è¾¾å¼</h1><p>é•¿è¡¨è¾¾å¼çš„å¯è¯»æ€§å¾ˆå·®ï¼Œå¯ä»¥å¼•å…¥ä¸€äº›è§£é‡Šå˜é‡ä»è€Œæ‹†åˆ†è¡¨è¾¾å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> line.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>].strip() == <span class="string">&quot;root&quot;</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username = line.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line"><span class="keyword">if</span> username == <span class="string">&quot;root&quot;</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ‘©æ ¹å®šç†ç®€åŒ–ä¸€äº›é€»è¾‘è¡¨è¾¾å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!a &amp;&amp; !b) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(a || b)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¹ã€å˜é‡ä¸å¯è¯»æ€§"><a href="#ä¹ã€å˜é‡ä¸å¯è¯»æ€§" class="headerlink" title="ä¹ã€å˜é‡ä¸å¯è¯»æ€§"></a>ä¹ã€å˜é‡ä¸å¯è¯»æ€§</h1><p><strong>å»é™¤æ§åˆ¶æµå˜é‡</strong>  ã€‚åœ¨å¾ªç¯ä¸­é€šè¿‡ä½¿ç”¨ break æˆ–è€… return å¯ä»¥å‡å°‘æ§åˆ¶æµå˜é‡çš„ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">done</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="comment">/* condition */</span> &amp;&amp; !done) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( ... ) &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="comment">/* condition */</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( ... ) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å‡å°å˜é‡ä½œç”¨åŸŸ</strong>  ã€‚ä½œç”¨åŸŸè¶Šå°ï¼Œè¶Šå®¹æ˜“å®šä½åˆ°å˜é‡æ‰€æœ‰ä½¿ç”¨çš„åœ°æ–¹ã€‚</p><p>JavaScript å¯ä»¥ç”¨é—­åŒ…å‡å°ä½œç”¨åŸŸã€‚ä»¥ä¸‹ä»£ç ä¸­ submit_form æ˜¯å‡½æ•°å˜é‡ï¼Œsubmitted å˜é‡æ§åˆ¶å‡½æ•°ä¸ä¼šè¢«æäº¤ä¸¤æ¬¡ã€‚ç¬¬ä¸€ä¸ªå®ç°ä¸­ submitted æ˜¯å…¨å±€å˜é‡ï¼Œç¬¬äºŒä¸ªå®ç°æŠŠ submitted æ”¾åˆ°åŒ¿åå‡½æ•°ä¸­ï¼Œä»è€Œé™åˆ¶äº†èµ·ä½œç”¨åŸŸèŒƒå›´ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">submitted = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> submit_form = <span class="keyword">function</span>(<span class="params">form_name</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (submitted) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    submitted = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> submit_form = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> submitted = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">form_name</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(submitted) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        submitted = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;());  <span class="comment">// () ä½¿å¾—å¤–å±‚åŒ¿åå‡½æ•°ç«‹å³æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>JavaScript ä¸­æ²¡æœ‰ç”¨ var å£°æ˜çš„å˜é‡éƒ½æ˜¯å…¨å±€å˜é‡ï¼Œè€Œå…¨å±€å˜é‡å¾ˆå®¹æ˜“é€ æˆè¿·æƒ‘ï¼Œå› æ­¤åº”å½“æ€»æ˜¯ç”¨ var æ¥å£°æ˜å˜é‡ã€‚</p><p>å˜é‡å®šä¹‰çš„ä½ç½®åº”å½“ç¦»å®ƒä½¿ç”¨çš„ä½ç½®æœ€è¿‘ã€‚</p><p><strong>å®ä¾‹è§£æ</strong>  </p><p>åœ¨ä¸€ä¸ªç½‘é¡µä¸­æœ‰ä»¥ä¸‹æ–‡æœ¬è¾“å…¥å­—æ®µï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;text&quot;</span> <span class="attr">id</span> = <span class="string">&quot;input1&quot;</span> <span class="attr">value</span> = <span class="string">&quot;a&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;text&quot;</span> <span class="attr">id</span> = <span class="string">&quot;input2&quot;</span> <span class="attr">value</span> = <span class="string">&quot;b&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;text&quot;</span> <span class="attr">id</span> = <span class="string">&quot;input3&quot;</span> <span class="attr">value</span> = <span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;text&quot;</span> <span class="attr">id</span> = <span class="string">&quot;input4&quot;</span> <span class="attr">value</span> = <span class="string">&quot;d&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨è¦æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å¹¶æŠŠå®ƒæ”¾åˆ°ç¬¬ä¸€ä¸ªç©ºçš„ input å­—æ®µä¸­ï¼Œåˆå§‹å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> setFirstEmptyInput = <span class="keyword">function</span>(<span class="params">new_alue</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> elem = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;input&#x27;</span> + i);</span><br><span class="line">    <span class="keyword">while</span> (elem != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (elem.<span class="property">value</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            found = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">        elem = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;input&#x27;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (found) elem.<span class="property">value</span> = new_value;</span><br><span class="line">    <span class="keyword">return</span> elem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå®ç°æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>found å¯ä»¥å»é™¤ï¼›</li><li>elem ä½œç”¨åŸŸè¿‡å¤§ï¼›</li><li>å¯ä»¥ç”¨ for å¾ªç¯ä»£æ›¿ while å¾ªç¯ï¼›</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> setFirstEmptyInput = <span class="keyword">function</span>(<span class="params">new_value</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; <span class="literal">true</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> elem = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;input&#x27;</span> + i);</span><br><span class="line">        <span class="keyword">if</span> (elem === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (elem.<span class="property">value</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            elem.<span class="property">value</span> = new_value;</span><br><span class="line">            <span class="keyword">return</span> elem;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="åã€æŠ½å–å‡½æ•°"><a href="#åã€æŠ½å–å‡½æ•°" class="headerlink" title="åã€æŠ½å–å‡½æ•°"></a>åã€æŠ½å–å‡½æ•°</h1><p>å·¥ç¨‹å­¦å°±æ˜¯æŠŠå¤§é—®é¢˜æ‹†åˆ†æˆå°é—®é¢˜å†æŠŠè¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ”¾å›ä¸€èµ·ã€‚</p><p>é¦–å…ˆåº”è¯¥æ˜ç¡®ä¸€ä¸ªå‡½æ•°çš„é«˜å±‚æ¬¡ç›®æ ‡ï¼Œç„¶åå¯¹äºä¸æ˜¯ç›´æ¥ä¸ºäº†è¿™ä¸ªç›®æ ‡å·¥ä½œçš„ä»£ç ï¼ŒæŠ½å–å‡ºæ¥æ”¾åˆ°ç‹¬ç«‹çš„å‡½æ•°ä¸­ã€‚</p><p>ä»‹ç»æ€§çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">findClostElement</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> clostIdx;</span><br><span class="line">    <span class="type">int</span> <span class="variable">clostDist</span> <span class="operator">=</span> Interger.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> ...;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> ...;</span><br><span class="line">        <span class="type">int</span> <span class="variable">z</span> <span class="operator">=</span> ...;</span><br><span class="line">        <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> x * y * z;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dist</span> <span class="operator">=</span> Math.sqrt(Math.pow(value, <span class="number">2</span>), Math.pow(arr[i], <span class="number">2</span>));</span><br><span class="line">        <span class="keyword">if</span> (dist &lt; clostDist) &#123;</span><br><span class="line">            clostIdx = i;</span><br><span class="line">            clostDist = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clostIdx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ä¸­å¾ªç¯éƒ¨åˆ†ä¸»è¦è®¡ç®—è·ç¦»ï¼Œè¿™éƒ¨åˆ†ä¸å±äºä»£ç é«˜å±‚æ¬¡ç›®æ ‡ï¼Œé«˜å±‚æ¬¡ç›®æ ‡æ˜¯å¯»æ‰¾æœ€å°è·ç¦»çš„å€¼ï¼Œå› æ­¤å¯ä»¥æŠŠè¿™éƒ¨åˆ†ä»£æ›¿æå–åˆ°ç‹¬ç«‹çš„å‡½æ•°ä¸­ã€‚è¿™æ ·åšä¹Ÿå¸¦æ¥ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æœ‰ï¼šå¯ä»¥å•ç‹¬è¿›è¡Œæµ‹è¯•ã€å¯ä»¥å¿«é€Ÿæ‰¾åˆ°ç¨‹åºé”™è¯¯å¹¶ä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findClostElement</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> clostIdx;</span><br><span class="line">    <span class="type">int</span> <span class="variable">clostDist</span> <span class="operator">=</span> Interger.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dist</span> <span class="operator">=</span> computDist(arr, i);</span><br><span class="line">        <span class="keyword">if</span> (dist &lt; clostDist) &#123;</span><br><span class="line">            clostIdx = i;</span><br><span class="line">            clostDist = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clostIdx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸æ˜¯å‡½æ•°æŠ½å–çš„è¶Šå¤šè¶Šå¥½ï¼Œå¦‚æœæŠ½å–è¿‡å¤šï¼Œåœ¨é˜…è¯»ä»£ç çš„æ—¶å€™å¯èƒ½éœ€è¦ä¸æ–­è·³æ¥è·³å»ã€‚åªæœ‰åœ¨å½“å‰å‡½æ•°ä¸éœ€è¦å»äº†è§£æŸä¸€å—ä»£ç ç»†èŠ‚è€Œèƒ½å¤Ÿè¡¨è¾¾å…¶å†…å®¹æ—¶ï¼ŒæŠŠè¿™å—ä»£ç æŠ½å–æˆå­å‡½æ•°æ‰æ˜¯å¥½çš„ã€‚</p><p>å‡½æ•°æŠ½å–ä¹Ÿç”¨äºå‡å°ä»£ç çš„å†—ä½™ã€‚</p><h1 id="åä¸€ã€ä¸€æ¬¡åªåšä¸€ä»¶äº‹"><a href="#åä¸€ã€ä¸€æ¬¡åªåšä¸€ä»¶äº‹" class="headerlink" title="åä¸€ã€ä¸€æ¬¡åªåšä¸€ä»¶äº‹"></a>åä¸€ã€ä¸€æ¬¡åªåšä¸€ä»¶äº‹</h1><p>åªåšä¸€ä»¶äº‹çš„ä»£ç å¾ˆå®¹æ˜“è®©äººçŸ¥é“å…¶è¦åšçš„äº‹ï¼›</p><p>åŸºæœ¬æµç¨‹ï¼šåˆ—å‡ºä»£ç æ‰€åšçš„æ‰€æœ‰ä»»åŠ¡ï¼›æŠŠæ¯ä¸ªä»»åŠ¡æ‹†åˆ†åˆ°ä¸åŒçš„å‡½æ•°ï¼Œæˆ–è€…ä¸åŒçš„æ®µè½ã€‚</p><h1 id="åäºŒã€ç”¨è‡ªç„¶è¯­è¨€è¡¨è¿°ä»£ç "><a href="#åäºŒã€ç”¨è‡ªç„¶è¯­è¨€è¡¨è¿°ä»£ç " class="headerlink" title="åäºŒã€ç”¨è‡ªç„¶è¯­è¨€è¡¨è¿°ä»£ç "></a>åäºŒã€ç”¨è‡ªç„¶è¯­è¨€è¡¨è¿°ä»£ç </h1><p>å…ˆç”¨è‡ªç„¶è¯­è¨€ä¹¦å†™ä»£ç é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¼ªä»£ç ï¼Œç„¶åå†å†™ä»£ç ï¼Œè¿™æ ·ä»£ç é€»è¾‘ä¼šæ›´æ¸…æ™°ã€‚</p><h1 id="åä¸‰ã€å‡å°‘ä»£ç é‡"><a href="#åä¸‰ã€å‡å°‘ä»£ç é‡" class="headerlink" title="åä¸‰ã€å‡å°‘ä»£ç é‡"></a>åä¸‰ã€å‡å°‘ä»£ç é‡</h1><p>ä¸è¦è¿‡åº¦è®¾è®¡ï¼Œç¼–ç è¿‡ç¨‹ä¼šæœ‰å¾ˆå¤šå˜åŒ–ï¼Œè¿‡åº¦è®¾è®¡çš„å†…å®¹åˆ°æœ€åå¾€å¾€æ˜¯æ— ç”¨çš„ã€‚</p><p>å¤šç”¨æ ‡å‡†åº“å®ç°ã€‚</p>]]></content>
    
    
    <summary type="html">è§„èŒƒä»£ç çš„å¯è¯»æ€§</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>æ­£åˆ™è¡¨è¾¾å¼</title>
    <link href="https://www.jodio.cc/posts/b5e3.html"/>
    <id>https://www.jodio.cc/posts/b5e3.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ­£åˆ™è¡¨è¾¾å¼"><a href="#æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼"></a>æ­£åˆ™è¡¨è¾¾å¼</h1><h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>æ­£åˆ™è¡¨è¾¾å¼ç”¨äºæ–‡æœ¬å†…å®¹çš„æŸ¥æ‰¾å’Œæ›¿æ¢ã€‚</p><p>æ­£åˆ™è¡¨è¾¾å¼å†…ç½®äºå…¶å®ƒè¯­è¨€æˆ–è€…è½¯ä»¶äº§å“ä¸­ï¼Œå®ƒæœ¬èº«ä¸æ˜¯ä¸€ç§è¯­è¨€æˆ–è€…è½¯ä»¶ã€‚</p><p><a href="https://regexr.com/">æ­£åˆ™è¡¨è¾¾å¼åœ¨çº¿å·¥å…·</a></p><h2 id="äºŒã€åŒ¹é…å•ä¸ªå­—ç¬¦"><a href="#äºŒã€åŒ¹é…å•ä¸ªå­—ç¬¦" class="headerlink" title="äºŒã€åŒ¹é…å•ä¸ªå­—ç¬¦"></a>äºŒã€åŒ¹é…å•ä¸ªå­—ç¬¦</h2><p><strong>.</strong>   å¯ä»¥ç”¨æ¥åŒ¹é…ä»»ä½•çš„å•ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯åœ¨ç»å¤§å¤šæ•°å®ç°é‡Œé¢ï¼Œä¸èƒ½åŒ¹é…æ¢è¡Œç¬¦ï¼›</p><p><strong>.</strong>   æ˜¯å…ƒå­—ç¬¦ï¼Œè¡¨ç¤ºå®ƒæœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼Œè€Œä¸æ˜¯å­—ç¬¦æœ¬èº«çš„å«ä¹‰ã€‚å¦‚æœéœ€è¦åŒ¹é… . ï¼Œé‚£ä¹ˆè¦ç”¨ \ è¿›è¡Œè½¬ä¹‰ï¼Œå³åœ¨ . å‰é¢åŠ ä¸Š \ ã€‚</p><p>æ­£åˆ™è¡¨è¾¾å¼ä¸€èˆ¬æ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼Œä½†ä¹Ÿæœ‰äº›å®ç°ä¸åŒºåˆ†ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C.C2018</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><p>My name is   <strong>CyC2018</strong>  .</p><h2 id="ä¸‰ã€åŒ¹é…ä¸€ç»„å­—ç¬¦"><a href="#ä¸‰ã€åŒ¹é…ä¸€ç»„å­—ç¬¦" class="headerlink" title="ä¸‰ã€åŒ¹é…ä¸€ç»„å­—ç¬¦"></a>ä¸‰ã€åŒ¹é…ä¸€ç»„å­—ç¬¦</h2><p><strong>[ ]</strong>   å®šä¹‰ä¸€ä¸ªå­—ç¬¦é›†åˆï¼›</p><p>0-9ã€a-z å®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦åŒºé—´ï¼ŒåŒºé—´ä½¿ç”¨ ASCII ç æ¥ç¡®å®šï¼Œå­—ç¬¦åŒºé—´åœ¨ [ ] ä¸­ä½¿ç”¨ã€‚</p><p><strong>-</strong>   åªæœ‰åœ¨ [ ] ä¹‹é—´æ‰æ˜¯å…ƒå­—ç¬¦ï¼Œåœ¨ [ ] ä¹‹å¤–å°±æ˜¯ä¸€ä¸ªæ™®é€šå­—ç¬¦ï¼›</p><p><strong>^</strong>   åœ¨ [ ] ä¸­æ˜¯å–éæ“ä½œã€‚</p><p><strong>åº”ç”¨</strong>  </p><p>åŒ¹é…ä»¥ abc ä¸ºå¼€å¤´ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªå­—æ¯ä¸ä¸ºæ•°å­—çš„å­—ç¬¦ä¸²ï¼š</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abc[^0-9]</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><ol><li><strong>abcd</strong>  </li><li>abc1</li><li>abc2</li></ol><h2 id="å››ã€ä½¿ç”¨å…ƒå­—ç¬¦"><a href="#å››ã€ä½¿ç”¨å…ƒå­—ç¬¦" class="headerlink" title="å››ã€ä½¿ç”¨å…ƒå­—ç¬¦"></a>å››ã€ä½¿ç”¨å…ƒå­—ç¬¦</h2><h3 id="åŒ¹é…ç©ºç™½å­—ç¬¦"><a href="#åŒ¹é…ç©ºç™½å­—ç¬¦" class="headerlink" title="åŒ¹é…ç©ºç™½å­—ç¬¦"></a>åŒ¹é…ç©ºç™½å­—ç¬¦</h3><div class="table-container"><table><thead><tr><th style="text-align:center">å…ƒå­—ç¬¦</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">[\b]</td><td style="text-align:center">å›é€€ï¼ˆåˆ é™¤ï¼‰ä¸€ä¸ªå­—ç¬¦</td></tr><tr><td style="text-align:center">\f</td><td style="text-align:center">æ¢é¡µç¬¦</td></tr><tr><td style="text-align:center">\n</td><td style="text-align:center">æ¢è¡Œç¬¦</td></tr><tr><td style="text-align:center">\r</td><td style="text-align:center">å›è½¦ç¬¦</td></tr><tr><td style="text-align:center">\t</td><td style="text-align:center">åˆ¶è¡¨ç¬¦</td></tr><tr><td style="text-align:center">\v</td><td style="text-align:center">å‚ç›´åˆ¶è¡¨ç¬¦</td></tr></tbody></table></div><p>\r\n æ˜¯ Windows ä¸­çš„æ–‡æœ¬è¡Œç»“æŸæ ‡ç­¾ï¼Œåœ¨ Unix/Linux åˆ™æ˜¯ \nã€‚</p><p>\r\n\r\n å¯ä»¥åŒ¹é… Windows ä¸‹çš„ç©ºç™½è¡Œï¼Œå› ä¸ºå®ƒåŒ¹é…ä¸¤ä¸ªè¿ç»­çš„è¡Œå°¾æ ‡ç­¾ï¼Œè€Œè¿™æ­£æ˜¯ä¸¤æ¡è®°å½•ä¹‹é—´çš„ç©ºç™½è¡Œï¼›</p><h3 id="åŒ¹é…ç‰¹å®šçš„å­—ç¬¦"><a href="#åŒ¹é…ç‰¹å®šçš„å­—ç¬¦" class="headerlink" title="åŒ¹é…ç‰¹å®šçš„å­—ç¬¦"></a>åŒ¹é…ç‰¹å®šçš„å­—ç¬¦</h3><h4 id="1-æ•°å­—å…ƒå­—ç¬¦"><a href="#1-æ•°å­—å…ƒå­—ç¬¦" class="headerlink" title="1. æ•°å­—å…ƒå­—ç¬¦"></a>1. æ•°å­—å…ƒå­—ç¬¦</h4><div class="table-container"><table><thead><tr><th style="text-align:center">å…ƒå­—ç¬¦</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">\d</td><td style="text-align:center">æ•°å­—å­—ç¬¦ï¼Œç­‰ä»·äº [0-9]</td></tr><tr><td style="text-align:center">\D</td><td style="text-align:center">éæ•°å­—å­—ç¬¦ï¼Œç­‰ä»·äº <sup><a href="#fn_0-9" id="reffn_0-9">0-9</a></sup></td></tr></tbody></table></div><h4 id="2-å­—æ¯æ•°å­—å…ƒå­—ç¬¦"><a href="#2-å­—æ¯æ•°å­—å…ƒå­—ç¬¦" class="headerlink" title="2. å­—æ¯æ•°å­—å…ƒå­—ç¬¦"></a>2. å­—æ¯æ•°å­—å…ƒå­—ç¬¦</h4><div class="table-container"><table><thead><tr><th style="text-align:center">å…ƒå­—ç¬¦</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">\w</td><td style="text-align:center">å¤§å°å†™å­—æ¯ï¼Œä¸‹åˆ’çº¿å’Œæ•°å­—ï¼Œç­‰ä»·äº [a-zA-Z0-9_]</td></tr><tr><td style="text-align:center">\W</td><td style="text-align:center">å¯¹ \w å–é</td></tr></tbody></table></div><h4 id="3-ç©ºç™½å­—ç¬¦å…ƒå­—ç¬¦"><a href="#3-ç©ºç™½å­—ç¬¦å…ƒå­—ç¬¦" class="headerlink" title="3. ç©ºç™½å­—ç¬¦å…ƒå­—ç¬¦"></a>3. ç©ºç™½å­—ç¬¦å…ƒå­—ç¬¦</h4><div class="table-container"><table><thead><tr><th style="text-align:center">å…ƒå­—ç¬¦</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">\s</td><td style="text-align:center">ä»»ä½•ä¸€ä¸ªç©ºç™½å­—ç¬¦ï¼Œç­‰ä»·äº [\f\n\r\t\v]</td></tr><tr><td style="text-align:center">\S</td><td style="text-align:center">å¯¹ \s å–é</td></tr></tbody></table></div><p>\x åŒ¹é…åå…­è¿›åˆ¶å­—ç¬¦ï¼Œ\0 åŒ¹é…å…«è¿›åˆ¶ï¼Œä¾‹å¦‚ \xA å¯¹åº”å€¼ä¸º 10 çš„ ASCII å­—ç¬¦ ï¼Œå³ \nã€‚</p><h2 id="äº”ã€é‡å¤åŒ¹é…"><a href="#äº”ã€é‡å¤åŒ¹é…" class="headerlink" title="äº”ã€é‡å¤åŒ¹é…"></a>äº”ã€é‡å¤åŒ¹é…</h2><ul><li><strong>+</strong>   åŒ¹é… 1 ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦</li><li><strong>\</strong>  * åŒ¹é… 0 ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦</li><li><strong>?</strong>   åŒ¹é… 0 ä¸ªæˆ–è€… 1 ä¸ªå­—ç¬¦</li></ul><p><strong>åº”ç”¨</strong>  </p><p>åŒ¹é…é‚®ç®±åœ°å€ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[\w.]+@\w+\.\w+</span><br></pre></td></tr></table></figure><p>[\w.] åŒ¹é…çš„æ˜¯å­—æ¯æ•°å­—æˆ–è€… . ï¼Œåœ¨å…¶åé¢åŠ ä¸Š + ï¼Œè¡¨ç¤ºåŒ¹é…å¤šæ¬¡ã€‚åœ¨å­—ç¬¦é›†åˆ [ ] é‡Œï¼Œ. ä¸æ˜¯å…ƒå­—ç¬¦ï¼›</p><p><strong>åŒ¹é…ç»“æœ</strong>  </p><p><strong>abc.def\&lt;span>@\&lt;/span>qq.com</strong>  </p><ul><li><strong>{n}</strong>   åŒ¹é… n ä¸ªå­—ç¬¦</li><li><strong>{m,n}</strong>   åŒ¹é… m~n ä¸ªå­—ç¬¦</li><li><strong>{m,}</strong>   è‡³å°‘åŒ¹é… m ä¸ªå­—ç¬¦</li></ul><p>* å’Œ + éƒ½æ˜¯è´ªå©ªå‹å…ƒå­—ç¬¦ï¼Œä¼šåŒ¹é…å°½å¯èƒ½å¤šçš„å†…å®¹ã€‚åœ¨åé¢åŠ  ? å¯ä»¥è½¬æ¢ä¸ºæ‡’æƒ°å‹å…ƒå­—ç¬¦ï¼Œä¾‹å¦‚ *?ã€+? å’Œ {m,n}? ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.+c</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><p><strong>abcabcabc</strong>  </p><p>ç”±äº + æ˜¯è´ªå©ªå‹çš„ï¼Œå› æ­¤ .+ ä¼šåŒ¹é…æ›´å¯èƒ½å¤šçš„å†…å®¹ï¼Œæ‰€ä»¥ä¼šæŠŠæ•´ä¸ª abcabcabc æ–‡æœ¬éƒ½åŒ¹é…ï¼Œè€Œä¸æ˜¯åªåŒ¹é…å‰é¢çš„ abc æ–‡æœ¬ã€‚ç”¨æ‡’æƒ°å‹å¯ä»¥å®ç°åŒ¹é…å‰é¢çš„ã€‚</p><h2 id="å…­ã€ä½ç½®åŒ¹é…"><a href="#å…­ã€ä½ç½®åŒ¹é…" class="headerlink" title="å…­ã€ä½ç½®åŒ¹é…"></a>å…­ã€ä½ç½®åŒ¹é…</h2><h3 id="å•è¯è¾¹ç•Œ"><a href="#å•è¯è¾¹ç•Œ" class="headerlink" title="å•è¯è¾¹ç•Œ"></a>å•è¯è¾¹ç•Œ</h3><p><strong>\b</strong>   å¯ä»¥åŒ¹é…ä¸€ä¸ªå•è¯çš„è¾¹ç•Œï¼Œè¾¹ç•Œæ˜¯æŒ‡ä½äº \w å’Œ \W ä¹‹é—´çš„ä½ç½®ï¼›<strong>\B</strong> åŒ¹é…ä¸€ä¸ªä¸æ˜¯å•è¯è¾¹ç•Œçš„ä½ç½®ã€‚</p><p>\b åªåŒ¹é…ä½ç½®ï¼Œä¸åŒ¹é…å­—ç¬¦ï¼Œå› æ­¤ \babc\b åŒ¹é…å‡ºæ¥çš„ç»“æœä¸º 3 ä¸ªå­—ç¬¦ã€‚</p><h3 id="å­—ç¬¦ä¸²è¾¹ç•Œ"><a href="#å­—ç¬¦ä¸²è¾¹ç•Œ" class="headerlink" title="å­—ç¬¦ä¸²è¾¹ç•Œ"></a>å­—ç¬¦ä¸²è¾¹ç•Œ</h3><p><strong>^</strong>   åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²çš„å¼€å¤´ï¼Œ<strong>$</strong> åŒ¹é…ç»“å°¾ã€‚</p><p>^ å…ƒå­—ç¬¦åœ¨å­—ç¬¦é›†åˆä¸­ç”¨ä½œæ±‚éï¼Œåœ¨å­—ç¬¦é›†åˆå¤–ç”¨ä½œåŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ã€‚</p><p>åˆ†è¡ŒåŒ¹é…æ¨¡å¼ï¼ˆmultilineï¼‰ä¸‹ï¼Œæ¢è¡Œè¢«å½“åšå­—ç¬¦ä¸²çš„è¾¹ç•Œã€‚</p><p><strong>åº”ç”¨</strong>  </p><p>åŒ¹é…ä»£ç ä¸­ä»¥ // å¼€å§‹çš„æ³¨é‡Šè¡Œ</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^\s*\/\/.*$</span><br></pre></td></tr></table></figure><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/600e9c75-5033-4dad-ae2b-930957db638e.png"/> </div><br></p><p><strong>åŒ¹é…ç»“æœ</strong>  </p><ol><li>public void fun() {</li><li>&nbsp;&nbsp;&nbsp;&nbsp;      <strong>// æ³¨é‡Š 1</strong>  </li><li>&nbsp;&nbsp;&nbsp;&nbsp;    int a = 1;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;    int b = 2;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;      <strong>// æ³¨é‡Š 2</strong>  </li><li>&nbsp;&nbsp;&nbsp;&nbsp;    int c = a + b;</li><li>}</li></ol><h2 id="ä¸ƒã€ä½¿ç”¨å­è¡¨è¾¾å¼"><a href="#ä¸ƒã€ä½¿ç”¨å­è¡¨è¾¾å¼" class="headerlink" title="ä¸ƒã€ä½¿ç”¨å­è¡¨è¾¾å¼"></a>ä¸ƒã€ä½¿ç”¨å­è¡¨è¾¾å¼</h2><p>ä½¿ç”¨   <strong>( )</strong>   å®šä¹‰ä¸€ä¸ªå­è¡¨è¾¾å¼ã€‚å­è¡¨è¾¾å¼çš„å†…å®¹å¯ä»¥å½“æˆä¸€ä¸ªç‹¬ç«‹å…ƒç´ ï¼Œå³å¯ä»¥å°†å®ƒçœ‹æˆä¸€ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ä½¿ç”¨ * ç­‰å…ƒå­—ç¬¦ã€‚</p><p>å­è¡¨è¾¾å¼å¯ä»¥åµŒå¥—ï¼Œä½†æ˜¯åµŒå¥—å±‚æ¬¡è¿‡æ·±ä¼šå˜å¾—å¾ˆéš¾ç†è§£ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(ab)&#123;2,&#125;</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><p><strong>ababab</strong>  </p><p><strong>|</strong>   æ˜¯æˆ–å…ƒå­—ç¬¦ï¼Œå®ƒæŠŠå·¦è¾¹å’Œå³è¾¹æ‰€æœ‰çš„éƒ¨åˆ†éƒ½çœ‹æˆå•ç‹¬çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸¤ä¸ªéƒ¨åˆ†åªè¦æœ‰ä¸€ä¸ªåŒ¹é…å°±è¡Œã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(19|20)\d&#123;2&#125;</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><ol><li><strong>1900</strong>  </li><li><strong>2010</strong>  </li><li>1020</li></ol><p><strong>åº”ç”¨</strong>  </p><p>åŒ¹é… IP åœ°å€ã€‚</p><p>IP åœ°å€ä¸­æ¯éƒ¨åˆ†éƒ½æ˜¯ 0-255 çš„æ•°å­—ï¼Œç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ—¶ä»¥ä¸‹æƒ…å†µæ˜¯åˆæ³•çš„ï¼š</p><ul><li>ä¸€ä½æ•°å­—</li><li>ä¸ä»¥ 0 å¼€å¤´çš„ä¸¤ä½æ•°å­—</li><li>1 å¼€å¤´çš„ä¸‰ä½æ•°</li><li>2 å¼€å¤´ï¼Œç¬¬ 2 ä½æ˜¯ 0-4 çš„ä¸‰ä½æ•°</li><li>25 å¼€å¤´ï¼Œç¬¬ 3 ä½æ˜¯ 0-5 çš„ä¸‰ä½æ•°</li></ul><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((25[0-5]|(2[0-4]\d)|(1\d&#123;2&#125;)|([1-9]\d)|(\d))\.)&#123;3&#125;(25[0-5]|(2[0-4]\d)|(1\d&#123;2&#125;)|([1-9]\d)|(\d))</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><ol><li><strong>192.168.0.1</strong>  </li><li>00.00.00.00</li><li>555.555.555.555</li></ol><h2 id="å…«ã€å›æº¯å¼•ç”¨"><a href="#å…«ã€å›æº¯å¼•ç”¨" class="headerlink" title="å…«ã€å›æº¯å¼•ç”¨"></a>å…«ã€å›æº¯å¼•ç”¨</h2><p>å›æº¯å¼•ç”¨ä½¿ç”¨   <strong>\n</strong>   æ¥å¼•ç”¨æŸä¸ªå­è¡¨è¾¾å¼ï¼Œå…¶ä¸­ n ä»£è¡¨çš„æ˜¯å­è¡¨è¾¾å¼çš„åºå·ï¼Œä» 1 å¼€å§‹ã€‚å®ƒå’Œå­è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹ä¸€è‡´ï¼Œæ¯”å¦‚å­è¡¨è¾¾å¼åŒ¹é…åˆ° abcï¼Œé‚£ä¹ˆå›æº¯å¼•ç”¨éƒ¨åˆ†ä¹Ÿéœ€è¦åŒ¹é… abc ã€‚</p><p><strong>åº”ç”¨</strong>  </p><p>åŒ¹é… HTML ä¸­åˆæ³•çš„æ ‡é¢˜å…ƒç´ ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><p>\1 å°†å›æº¯å¼•ç”¨å­è¡¨è¾¾å¼ (h[1-6]) åŒ¹é…çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»å’Œå­è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹ä¸€è‡´ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;(h[1-6])&gt;\w*?&lt;\/\1&gt;</span><br></pre></td></tr></table></figure><p><strong>åŒ¹é…ç»“æœ</strong>  </p><ol><li><strong>&lt;h1>x&lt;/h1></strong>  </li><li><strong>&lt;h2>x&lt;/h2></strong>  </li><li>&lt;h3>x&lt;/h1></li></ol><h3 id="æ›¿æ¢"><a href="#æ›¿æ¢" class="headerlink" title="æ›¿æ¢"></a>æ›¿æ¢</h3><p>éœ€è¦ç”¨åˆ°ä¸¤ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚</p><p><strong>åº”ç”¨</strong>  </p><p>ä¿®æ”¹ç”µè¯å·ç æ ¼å¼ã€‚</p><p><strong>æ–‡æœ¬</strong>  </p><p>313-555-1234</p><p><strong>æŸ¥æ‰¾æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(\d&#123;3&#125;)(-)(\d&#123;3&#125;)(-)(\d&#123;4&#125;)</span><br></pre></td></tr></table></figure><p><strong>æ›¿æ¢æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><p>åœ¨ç¬¬ä¸€ä¸ªå­è¡¨è¾¾å¼æŸ¥æ‰¾çš„ç»“æœåŠ ä¸Š () ï¼Œç„¶ååŠ ä¸€ä¸ªç©ºæ ¼ï¼Œåœ¨ç¬¬ä¸‰ä¸ªå’Œç¬¬äº”ä¸ªå­—è¡¨è¾¾å¼æŸ¥æ‰¾çš„ç»“æœä¸­é—´åŠ ä¸Š - è¿›è¡Œåˆ†éš”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">($1) $3-$5</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>  </p><p>(313) 555-1234</p><h3 id="å¤§å°å†™è½¬æ¢"><a href="#å¤§å°å†™è½¬æ¢" class="headerlink" title="å¤§å°å†™è½¬æ¢"></a>å¤§å°å†™è½¬æ¢</h3><div class="table-container"><table><thead><tr><th style="text-align:center">å…ƒå­—ç¬¦</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">\l</td><td style="text-align:center">æŠŠä¸‹ä¸ªå­—ç¬¦è½¬æ¢ä¸ºå°å†™</td></tr><tr><td style="text-align:center">\u</td><td style="text-align:center">æŠŠä¸‹ä¸ªå­—ç¬¦è½¬æ¢ä¸ºå¤§å†™</td></tr><tr><td style="text-align:center">\L</td><td style="text-align:center">æŠŠ\L å’Œ\E ä¹‹é—´çš„å­—ç¬¦å…¨éƒ¨è½¬æ¢ä¸ºå°å†™</td></tr><tr><td style="text-align:center">\U</td><td style="text-align:center">æŠŠ\U å’Œ\E ä¹‹é—´çš„å­—ç¬¦å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™</td></tr><tr><td style="text-align:center">\E</td><td style="text-align:center">ç»“æŸ\L æˆ–è€…\U</td></tr></tbody></table></div><p><strong>åº”ç”¨</strong>  </p><p>æŠŠæ–‡æœ¬çš„ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå­—ç¬¦è½¬æ¢ä¸ºå¤§å†™ã€‚</p><p><strong>æ–‡æœ¬</strong>  </p><p>abcd</p><p><strong>æŸ¥æ‰¾</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(\w)(\w&#123;2&#125;)(\w)</span><br></pre></td></tr></table></figure><p><strong>æ›¿æ¢</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$1\U$2\E$3</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>  </p><p>aBCd</p><h2 id="ä¹ã€å‰åæŸ¥æ‰¾"><a href="#ä¹ã€å‰åæŸ¥æ‰¾" class="headerlink" title="ä¹ã€å‰åæŸ¥æ‰¾"></a>ä¹ã€å‰åæŸ¥æ‰¾</h2><p>å‰åæŸ¥æ‰¾è§„å®šäº†åŒ¹é…çš„å†…å®¹é¦–å°¾åº”è¯¥åŒ¹é…çš„å†…å®¹ï¼Œä½†æ˜¯åˆä¸åŒ…å«é¦–å°¾åŒ¹é…çš„å†…å®¹ã€‚</p><p>å‘å‰æŸ¥æ‰¾ä½¿ç”¨   <strong>?=</strong>   å®šä¹‰ï¼Œå®ƒè§„å®šäº†å°¾éƒ¨åŒ¹é…çš„å†…å®¹ï¼Œè¿™ä¸ªåŒ¹é…çš„å†…å®¹åœ¨ ?= ä¹‹åå®šä¹‰ã€‚æ‰€è°“å‘å‰æŸ¥æ‰¾ï¼Œå°±æ˜¯è§„å®šäº†ä¸€ä¸ªåŒ¹é…çš„å†…å®¹ï¼Œç„¶åä»¥è¿™ä¸ªå†…å®¹ä¸ºå°¾éƒ¨å‘å‰é¢æŸ¥æ‰¾éœ€è¦åŒ¹é…çš„å†…å®¹ã€‚å‘ååŒ¹é…ç”¨ ?\&lt;= å®šä¹‰ï¼ˆæ³¨: JavaScript ä¸æ”¯æŒå‘ååŒ¹é…ï¼ŒJava å¯¹å…¶æ”¯æŒä¹Ÿä¸å®Œå–„ï¼‰ã€‚</p><p><strong>åº”ç”¨</strong>  </p><p>æŸ¥æ‰¾å‡ºé‚®ä»¶åœ°å€ @ å­—ç¬¦å‰é¢çš„éƒ¨åˆ†ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\w+(?=@)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>  </p><p><strong>abc</strong>  @qq.com</p><p>å¯¹å‘å‰å’Œå‘åæŸ¥æ‰¾å–éï¼Œåªè¦æŠŠ = æ›¿æ¢æˆ ! å³å¯ï¼Œæ¯”å¦‚ (?=) æ›¿æ¢æˆ (?!) ã€‚å–éæ“ä½œä½¿å¾—åŒ¹é…é‚£äº›é¦–å°¾ä¸ç¬¦åˆè¦æ±‚çš„å†…å®¹ã€‚</p><h2 id="åã€åµŒå…¥æ¡ä»¶"><a href="#åã€åµŒå…¥æ¡ä»¶" class="headerlink" title="åã€åµŒå…¥æ¡ä»¶"></a>åã€åµŒå…¥æ¡ä»¶</h2><h3 id="å›æº¯å¼•ç”¨æ¡ä»¶"><a href="#å›æº¯å¼•ç”¨æ¡ä»¶" class="headerlink" title="å›æº¯å¼•ç”¨æ¡ä»¶"></a>å›æº¯å¼•ç”¨æ¡ä»¶</h3><p>æ¡ä»¶ä¸ºæŸä¸ªå­è¡¨è¾¾å¼æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™éœ€è¦ç»§ç»­åŒ¹é…æ¡ä»¶è¡¨è¾¾å¼åé¢çš„å†…å®¹ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><p>å­è¡¨è¾¾å¼ (\() åŒ¹é…ä¸€ä¸ªå·¦æ‹¬å·ï¼Œå…¶åçš„ ? è¡¨ç¤ºåŒ¹é… 0 ä¸ªæˆ–è€… 1 ä¸ªã€‚ ?(1) ä¸ºæ¡ä»¶ï¼Œå½“å­è¡¨è¾¾å¼ 1 åŒ¹é…æ—¶æ¡ä»¶æˆç«‹ï¼Œéœ€è¦æ‰§è¡Œ ) åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯åŒ¹é…å³æ‹¬å·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(\()?abc(?(1)\))</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>  </p><ol><li><strong>(abc)</strong>  </li><li><strong>abc</strong>  </li><li>(abc</li></ol><h3 id="å‰åæŸ¥æ‰¾æ¡ä»¶"><a href="#å‰åæŸ¥æ‰¾æ¡ä»¶" class="headerlink" title="å‰åæŸ¥æ‰¾æ¡ä»¶"></a>å‰åæŸ¥æ‰¾æ¡ä»¶</h3><p>æ¡ä»¶ä¸ºå®šä¹‰çš„é¦–å°¾æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™ç»§ç»­æ‰§è¡Œåé¢çš„åŒ¹é…ã€‚æ³¨æ„ï¼Œé¦–å°¾ä¸åŒ…å«åœ¨åŒ¹é…çš„å†…å®¹ä¸­ã€‚</p><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong>  </p><p> ?(?=-) ä¸ºå‰å‘æŸ¥æ‰¾æ¡ä»¶ï¼Œåªæœ‰åœ¨ä»¥ - ä¸ºå‰å‘æŸ¥æ‰¾çš„ç»“å°¾èƒ½åŒ¹é… \d{5} ï¼Œæ‰ç»§ç»­åŒ¹é… -\d{4} ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d&#123;5&#125;(?(?=-)-\d&#123;4&#125;)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>  </p><ol><li><strong>11111</strong>  </li><li>22222-</li><li><strong>33333-4444</strong>  </li></ol>]]></content>
    
    
    <summary type="html">æ­£åˆ™è¡¨è¾¾å¼</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Javaè™šæ‹Ÿæœº</title>
    <link href="https://www.jodio.cc/posts/JVM.html"/>
    <id>https://www.jodio.cc/posts/JVM.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-è™šæ‹Ÿæœº"><a href="#Java-è™šæ‹Ÿæœº" class="headerlink" title="Java è™šæ‹Ÿæœº"></a>Java è™šæ‹Ÿæœº</h1><h2 id="ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"><a href="#ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ" class="headerlink" title="ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"></a>ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ</h2><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/5778d113-8e13-4c53-b5bf-801e58080b97.png" width="400px"> </div><br></p><h3 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h3><p>è®°å½•æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼ˆå¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•åˆ™ä¸ºç©ºï¼‰ã€‚</p><h3 id="Java-è™šæ‹Ÿæœºæ ˆ"><a href="#Java-è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="Java è™šæ‹Ÿæœºæ ˆ"></a>Java è™šæ‹Ÿæœºæ ˆ</h3><p>æ¯ä¸ª Java æ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± å¼•ç”¨ç­‰ä¿¡æ¯ã€‚ä»æ–¹æ³•è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8442519f-0b4d-48f4-8229-56f984363c69.png" width="400px"> </div><br></p><p>å¯ä»¥é€šè¿‡ -Xss è¿™ä¸ªè™šæ‹Ÿæœºå‚æ•°æ¥æŒ‡å®šæ¯ä¸ªçº¿ç¨‹çš„ Java è™šæ‹Ÿæœºæ ˆå†…å­˜å¤§å°ï¼Œåœ¨ JDK 1.4 ä¸­é»˜è®¤ä¸º 256Kï¼Œè€Œåœ¨ JDK 1.5+ é»˜è®¤ä¸º 1Mï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xss2M HackTheJava</span><br></pre></td></tr></table></figure><p>è¯¥åŒºåŸŸå¯èƒ½æŠ›å‡ºä»¥ä¸‹å¼‚å¸¸ï¼š</p><ul><li>å½“çº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦è¶…è¿‡æœ€å¤§å€¼ï¼Œä¼šæŠ›å‡º StackOverflowError å¼‚å¸¸ï¼›</li><li>æ ˆè¿›è¡ŒåŠ¨æ€æ‰©å±•æ—¶å¦‚æœæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜ï¼Œä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚</li></ul><h3 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h3><p>æœ¬åœ°æ–¹æ³•æ ˆä¸ Java è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åªä¸è¿‡æ˜¯æœ¬åœ°æ–¹æ³•æ ˆä¸ºæœ¬åœ°æ–¹æ³•æœåŠ¡ã€‚</p><p>æœ¬åœ°æ–¹æ³•ä¸€èˆ¬æ˜¯ç”¨å…¶å®ƒè¯­è¨€ï¼ˆCã€C++ æˆ–æ±‡ç¼–è¯­è¨€ç­‰ï¼‰ç¼–å†™çš„ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘ä¸ºåŸºäºæœ¬æœºç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„ç¨‹åºï¼Œå¯¹å¾…è¿™äº›æ–¹æ³•éœ€è¦ç‰¹åˆ«å¤„ç†ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/66a6899d-c6b0-4a47-8569-9d08f0baf86c.png" width="300px"> </div><br></p><h3 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h3><p>æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ï¼Œæ˜¯åƒåœ¾æ”¶é›†çš„ä¸»è¦åŒºåŸŸï¼ˆâ€GC å †â€ï¼‰ã€‚</p><p>ç°ä»£çš„åƒåœ¾æ”¶é›†å™¨åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œå…¶ä¸»è¦çš„æ€æƒ³æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„å¯¹è±¡é‡‡å–ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚å¯ä»¥å°†å †åˆ†æˆä¸¤å—ï¼š</p><ul><li>æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰</li><li>è€å¹´ä»£ï¼ˆOld Generationï¼‰</li></ul><p>å †ä¸éœ€è¦è¿ç»­å†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€å¢åŠ å…¶å†…å­˜ï¼Œå¢åŠ å¤±è´¥ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚</p><p>å¯ä»¥é€šè¿‡ -Xms å’Œ -Xmx è¿™ä¸¤ä¸ªè™šæ‹Ÿæœºå‚æ•°æ¥æŒ‡å®šä¸€ä¸ªç¨‹åºçš„å †å†…å­˜å¤§å°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®åˆå§‹å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è®¾ç½®æœ€å¤§å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xms1M -Xmx2M HackTheJava</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h3><p>ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚</p><p>å’Œå †ä¸€æ ·ä¸éœ€è¦è¿ç»­çš„å†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€æ‰©å±•ï¼ŒåŠ¨æ€æ‰©å±•å¤±è´¥ä¸€æ ·ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚</p><p>å¯¹è¿™å—åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶çš„ä¸»è¦ç›®æ ‡æ˜¯å¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹ç±»çš„å¸è½½ï¼Œä½†æ˜¯ä¸€èˆ¬æ¯”è¾ƒéš¾å®ç°ã€‚</p><p>HotSpot è™šæ‹ŸæœºæŠŠå®ƒå½“æˆæ°¸ä¹…ä»£æ¥è¿›è¡Œåƒåœ¾å›æ”¶ã€‚ä½†å¾ˆéš¾ç¡®å®šæ°¸ä¹…ä»£çš„å¤§å°ï¼Œå› ä¸ºå®ƒå—åˆ°å¾ˆå¤šå› ç´ å½±å“ï¼Œå¹¶ä¸”æ¯æ¬¡ Full GC ä¹‹åæ°¸ä¹…ä»£çš„å¤§å°éƒ½ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ç»å¸¸ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚ä¸ºäº†æ›´å®¹æ˜“ç®¡ç†æ–¹æ³•åŒºï¼Œä» JDK 1.8 å¼€å§‹ï¼Œç§»é™¤æ°¸ä¹…ä»£ï¼Œå¹¶æŠŠæ–¹æ³•åŒºç§»è‡³å…ƒç©ºé—´ï¼Œå®ƒä½äºæœ¬åœ°å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚</p><p>æ–¹æ³•åŒºæ˜¯ä¸€ä¸ª JVM è§„èŒƒï¼Œæ°¸ä¹…ä»£ä¸å…ƒç©ºé—´éƒ½æ˜¯å…¶ä¸€ç§å®ç°æ–¹å¼ã€‚åœ¨ JDK 1.8 ä¹‹åï¼ŒåŸæ¥æ°¸ä¹…ä»£çš„æ•°æ®è¢«åˆ†åˆ°äº†å †å’Œå…ƒç©ºé—´ä¸­ã€‚å…ƒç©ºé—´å­˜å‚¨ç±»çš„å…ƒä¿¡æ¯ï¼Œé™æ€å˜é‡å’Œå¸¸é‡æ± ç­‰æ”¾å…¥å †ä¸­ã€‚</p><h3 id="è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± "></a>è¿è¡Œæ—¶å¸¸é‡æ± </h3><p>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</p><p>Class æ–‡ä»¶ä¸­çš„å¸¸é‡æ± ï¼ˆç¼–è¯‘å™¨ç”Ÿæˆçš„å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼‰ä¼šåœ¨ç±»åŠ è½½åè¢«æ”¾å…¥è¿™ä¸ªåŒºåŸŸã€‚</p><p>é™¤äº†åœ¨ç¼–è¯‘æœŸç”Ÿæˆçš„å¸¸é‡ï¼Œè¿˜å…è®¸åŠ¨æ€ç”Ÿæˆï¼Œä¾‹å¦‚ String ç±»çš„ intern()ã€‚</p><h3 id="ç›´æ¥å†…å­˜"><a href="#ç›´æ¥å†…å­˜" class="headerlink" title="ç›´æ¥å†…å­˜"></a>ç›´æ¥å†…å­˜</h3><p>åœ¨ JDK 1.4 ä¸­æ–°å¼•å…¥äº† NIO ç±»ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ Java å †é‡Œçš„ DirectByteBuffer å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨å †å†…å­˜å’Œå †å¤–å†…å­˜æ¥å›æ‹·è´æ•°æ®ã€‚</p><h2 id="äºŒã€åƒåœ¾æ”¶é›†"><a href="#äºŒã€åƒåœ¾æ”¶é›†" class="headerlink" title="äºŒã€åƒåœ¾æ”¶é›†"></a>äºŒã€åƒåœ¾æ”¶é›†</h2><p>åƒåœ¾æ”¶é›†ä¸»è¦æ˜¯é’ˆå¯¹å †å’Œæ–¹æ³•åŒºè¿›è¡Œã€‚ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆè¿™ä¸‰ä¸ªåŒºåŸŸå±äºçº¿ç¨‹ç§æœ‰çš„ï¼Œåªå­˜åœ¨äºçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçº¿ç¨‹ç»“æŸä¹‹åå°±ä¼šæ¶ˆå¤±ï¼Œå› æ­¤ä¸éœ€è¦å¯¹è¿™ä¸‰ä¸ªåŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p><h3 id="åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶"><a href="#åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶" class="headerlink" title="åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶"></a>åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶</h3><h4 id="1-å¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#1-å¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="1. å¼•ç”¨è®¡æ•°ç®—æ³•"></a>1. å¼•ç”¨è®¡æ•°ç®—æ³•</h4><p>ä¸ºå¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“å¯¹è±¡å¢åŠ ä¸€ä¸ªå¼•ç”¨æ—¶è®¡æ•°å™¨åŠ  1ï¼Œå¼•ç”¨å¤±æ•ˆæ—¶è®¡æ•°å™¨å‡ 1ã€‚å¼•ç”¨è®¡æ•°ä¸º 0 çš„å¯¹è±¡å¯è¢«å›æ”¶ã€‚</p><p>åœ¨ä¸¤ä¸ªå¯¹è±¡å‡ºç°å¾ªç¯å¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶å¼•ç”¨è®¡æ•°å™¨æ°¸è¿œä¸ä¸º 0ï¼Œå¯¼è‡´æ— æ³•å¯¹å®ƒä»¬è¿›è¡Œå›æ”¶ã€‚æ­£æ˜¯å› ä¸ºå¾ªç¯å¼•ç”¨çš„å­˜åœ¨ï¼Œå› æ­¤ Java è™šæ‹Ÿæœºä¸ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Test</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">        <span class="type">Test</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">        a.instance = b;</span><br><span class="line">        b.instance = a;</span><br><span class="line">        a = <span class="literal">null</span>;</span><br><span class="line">        b = <span class="literal">null</span>;</span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œa ä¸ b å¼•ç”¨çš„å¯¹è±¡å®ä¾‹äº’ç›¸æŒæœ‰äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œå› æ­¤å½“æˆ‘ä»¬æŠŠå¯¹ a å¯¹è±¡ä¸ b å¯¹è±¡çš„å¼•ç”¨å»é™¤ä¹‹åï¼Œç”±äºä¸¤ä¸ªå¯¹è±¡è¿˜å­˜åœ¨äº’ç›¸ä¹‹é—´çš„å¼•ç”¨ï¼Œå¯¼è‡´ä¸¤ä¸ª Test å¯¹è±¡æ— æ³•è¢«å›æ”¶ã€‚</p><h4 id="2-å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#2-å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="2. å¯è¾¾æ€§åˆ†æç®—æ³•"></a>2. å¯è¾¾æ€§åˆ†æç®—æ³•</h4><p>ä»¥ GC Roots ä¸ºèµ·å§‹ç‚¹è¿›è¡Œæœç´¢ï¼Œå¯è¾¾çš„å¯¹è±¡éƒ½æ˜¯å­˜æ´»çš„ï¼Œä¸å¯è¾¾çš„å¯¹è±¡å¯è¢«å›æ”¶ã€‚</p><p>Java è™šæ‹Ÿæœºä½¿ç”¨è¯¥ç®—æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶ï¼ŒGC Roots ä¸€èˆ¬åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨ä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNI ä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/83d909d2-3858-4fe1-8ff4-16471db0b180.png" width="350px"> </div><br></p><h4 id="3-æ–¹æ³•åŒºçš„å›æ”¶"><a href="#3-æ–¹æ³•åŒºçš„å›æ”¶" class="headerlink" title="3. æ–¹æ³•åŒºçš„å›æ”¶"></a>3. æ–¹æ³•åŒºçš„å›æ”¶</h4><p>å› ä¸ºæ–¹æ³•åŒºä¸»è¦å­˜æ”¾æ°¸ä¹…ä»£å¯¹è±¡ï¼Œè€Œæ°¸ä¹…ä»£å¯¹è±¡çš„å›æ”¶ç‡æ¯”æ–°ç”Ÿä»£ä½å¾ˆå¤šï¼Œæ‰€ä»¥åœ¨æ–¹æ³•åŒºä¸Šè¿›è¡Œå›æ”¶æ€§ä»·æ¯”ä¸é«˜ã€‚</p><p>ä¸»è¦æ˜¯å¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹ç±»çš„å¸è½½ã€‚</p><p>ä¸ºäº†é¿å…å†…å­˜æº¢å‡ºï¼Œåœ¨å¤§é‡ä½¿ç”¨åå°„å’ŒåŠ¨æ€ä»£ç†çš„åœºæ™¯éƒ½éœ€è¦è™šæ‹Ÿæœºå…·å¤‡ç±»å¸è½½åŠŸèƒ½ã€‚</p><p>ç±»çš„å¸è½½æ¡ä»¶å¾ˆå¤šï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼Œå¹¶ä¸”æ»¡è¶³äº†æ¡ä»¶ä¹Ÿä¸ä¸€å®šä¼šè¢«å¸è½½ï¼š</p><ul><li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œæ­¤æ—¶å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚</li><li>åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚</li><li>è¯¥ç±»å¯¹åº”çš„ Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œä¹Ÿå°±æ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»æ–¹æ³•ã€‚</li></ul><h4 id="4-finalize"><a href="#4-finalize" class="headerlink" title="4. finalize()"></a>4. finalize()</h4><p>ç±»ä¼¼ C++ çš„ææ„å‡½æ•°ï¼Œç”¨äºå…³é—­å¤–éƒ¨èµ„æºã€‚ä½†æ˜¯ try-finally ç­‰æ–¹å¼å¯ä»¥åšå¾—æ›´å¥½ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•è¿è¡Œä»£ä»·å¾ˆé«˜ï¼Œä¸ç¡®å®šæ€§å¤§ï¼Œæ— æ³•ä¿è¯å„ä¸ªå¯¹è±¡çš„è°ƒç”¨é¡ºåºï¼Œå› æ­¤æœ€å¥½ä¸è¦ä½¿ç”¨ã€‚</p><p>å½“ä¸€ä¸ªå¯¹è±¡å¯è¢«å›æ”¶æ—¶ï¼Œå¦‚æœéœ€è¦æ‰§è¡Œè¯¥å¯¹è±¡çš„ finalize() æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨è¯¥æ–¹æ³•ä¸­è®©å¯¹è±¡é‡æ–°è¢«å¼•ç”¨ï¼Œä»è€Œå®ç°è‡ªæ•‘ã€‚è‡ªæ•‘åªèƒ½è¿›è¡Œä¸€æ¬¡ï¼Œå¦‚æœå›æ”¶çš„å¯¹è±¡ä¹‹å‰è°ƒç”¨äº† finalize() æ–¹æ³•è‡ªæ•‘ï¼Œåé¢å›æ”¶æ—¶ä¸ä¼šå†è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><h3 id="å¼•ç”¨ç±»å‹"><a href="#å¼•ç”¨ç±»å‹" class="headerlink" title="å¼•ç”¨ç±»å‹"></a>å¼•ç”¨ç±»å‹</h3><p>æ— è®ºæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ç®—æ³•åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†æç®—æ³•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è¾¾ï¼Œåˆ¤å®šå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶éƒ½ä¸å¼•ç”¨æœ‰å…³ã€‚</p><p>Java æä¾›äº†å››ç§å¼ºåº¦ä¸åŒçš„å¼•ç”¨ç±»å‹ã€‚</p><h4 id="1-å¼ºå¼•ç”¨"><a href="#1-å¼ºå¼•ç”¨" class="headerlink" title="1. å¼ºå¼•ç”¨"></a>1. å¼ºå¼•ç”¨</h4><p>è¢«å¼ºå¼•ç”¨å…³è”çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ã€‚</p><p>ä½¿ç”¨ new ä¸€ä¸ªæ–°å¯¹è±¡çš„æ–¹å¼æ¥åˆ›å»ºå¼ºå¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></table></figure><h4 id="2-è½¯å¼•ç”¨"><a href="#2-è½¯å¼•ç”¨" class="headerlink" title="2. è½¯å¼•ç”¨"></a>2. è½¯å¼•ç”¨</h4><p>è¢«è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åªæœ‰åœ¨å†…å­˜ä¸å¤Ÿçš„æƒ…å†µä¸‹æ‰ä¼šè¢«å›æ”¶ã€‚</p><p>ä½¿ç”¨ SoftReference ç±»æ¥åˆ›å»ºè½¯å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">SoftReference&lt;Object&gt; sf = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="literal">null</span>;  <span class="comment">// ä½¿å¯¹è±¡åªè¢«è½¯å¼•ç”¨å…³è”</span></span><br></pre></td></tr></table></figure><h4 id="3-å¼±å¼•ç”¨"><a href="#3-å¼±å¼•ç”¨" class="headerlink" title="3. å¼±å¼•ç”¨"></a>3. å¼±å¼•ç”¨</h4><p>è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ä¸€å®šä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªèƒ½å­˜æ´»åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶å‘ç”Ÿä¹‹å‰ã€‚</p><p>ä½¿ç”¨ WeakReference ç±»æ¥åˆ›å»ºå¼±å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">WeakReference&lt;Object&gt; wf = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><h4 id="4-è™šå¼•ç”¨"><a href="#4-è™šå¼•ç”¨" class="headerlink" title="4. è™šå¼•ç”¨"></a>4. è™šå¼•ç”¨</h4><p>åˆç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´é€ æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ã€‚</p><p>ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨çš„å”¯ä¸€ç›®çš„æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</p><p>ä½¿ç”¨ PhantomReference æ¥åˆ›å»ºè™šå¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">PhantomReference&lt;Object&gt; pf = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;Object&gt;(obj, <span class="literal">null</span>);</span><br><span class="line">obj = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><h3 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h3><h4 id="1-æ ‡è®°-æ¸…é™¤"><a href="#1-æ ‡è®°-æ¸…é™¤" class="headerlink" title="1. æ ‡è®° - æ¸…é™¤"></a>1. æ ‡è®° - æ¸…é™¤</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/005b481b-502b-4e3f-985d-d043c2b330aa.png" width="400px"> </div><br></p><p>åœ¨æ ‡è®°é˜¶æ®µï¼Œç¨‹åºä¼šæ£€æŸ¥æ¯ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºæ´»åŠ¨å¯¹è±¡ï¼Œå¦‚æœæ˜¯æ´»åŠ¨å¯¹è±¡ï¼Œåˆ™ç¨‹åºä¼šåœ¨å¯¹è±¡å¤´éƒ¨æ‰“ä¸Šæ ‡è®°ã€‚</p><p>åœ¨æ¸…é™¤é˜¶æ®µï¼Œä¼šè¿›è¡Œå¯¹è±¡å›æ”¶å¹¶å–æ¶ˆæ ‡å¿—ä½ï¼Œå¦å¤–ï¼Œè¿˜ä¼šåˆ¤æ–­å›æ”¶åçš„åˆ†å—ä¸å‰ä¸€ä¸ªç©ºé—²åˆ†å—æ˜¯å¦è¿ç»­ï¼Œè‹¥è¿ç»­ï¼Œä¼šåˆå¹¶è¿™ä¸¤ä¸ªåˆ†å—ã€‚å›æ”¶å¯¹è±¡å°±æ˜¯æŠŠå¯¹è±¡ä½œä¸ºåˆ†å—ï¼Œè¿æ¥åˆ°è¢«ç§°ä¸º â€œç©ºé—²é“¾è¡¨â€ çš„å•å‘é“¾è¡¨ï¼Œä¹‹åè¿›è¡Œåˆ†é…æ—¶åªéœ€è¦éå†è¿™ä¸ªç©ºé—²é“¾è¡¨ï¼Œå°±å¯ä»¥æ‰¾åˆ°åˆ†å—ã€‚</p><p>åœ¨åˆ†é…æ—¶ï¼Œç¨‹åºä¼šæœç´¢ç©ºé—²é“¾è¡¨å¯»æ‰¾ç©ºé—´å¤§äºç­‰äºæ–°å¯¹è±¡å¤§å° size çš„å— blockã€‚å¦‚æœå®ƒæ‰¾åˆ°çš„å—ç­‰äº sizeï¼Œä¼šç›´æ¥è¿”å›è¿™ä¸ªåˆ†å—ï¼›å¦‚æœæ‰¾åˆ°çš„å—å¤§äº sizeï¼Œä¼šå°†å—åˆ†å‰²æˆå¤§å°ä¸º size ä¸ (block - size) çš„ä¸¤éƒ¨åˆ†ï¼Œè¿”å›å¤§å°ä¸º size çš„åˆ†å—ï¼Œå¹¶æŠŠå¤§å°ä¸º (block - size) çš„å—è¿”å›ç»™ç©ºé—²é“¾è¡¨ã€‚</p><p>ä¸è¶³ï¼š</p><ul><li>æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹æ•ˆç‡éƒ½ä¸é«˜ï¼›</li><li>ä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´æ— æ³•ç»™å¤§å¯¹è±¡åˆ†é…å†…å­˜ã€‚</li></ul><h4 id="2-æ ‡è®°-æ•´ç†"><a href="#2-æ ‡è®°-æ•´ç†" class="headerlink" title="2. æ ‡è®° - æ•´ç†"></a>2. æ ‡è®° - æ•´ç†</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ccd773a5-ad38-4022-895c-7ac318f31437.png" width="400px"> </div><br></p><p>è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚</p><p>ä¼˜ç‚¹:</p><ul><li>ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</li></ul><p>ä¸è¶³:</p><ul><li>éœ€è¦ç§»åŠ¨å¤§é‡å¯¹è±¡ï¼Œå¤„ç†æ•ˆç‡æ¯”è¾ƒä½ã€‚</li></ul><h4 id="3-å¤åˆ¶"><a href="#3-å¤åˆ¶" class="headerlink" title="3. å¤åˆ¶"></a>3. å¤åˆ¶</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/b2b77b9e-958c-4016-8ae5-9c6edd83871e.png" width="400px"> </div><br></p><p>å°†å†…å­˜åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œå½“è¿™ä¸€å—å†…å­˜ç”¨å®Œäº†å°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´è¿›è¡Œä¸€æ¬¡æ¸…ç†ã€‚</p><p>ä¸»è¦ä¸è¶³æ˜¯åªä½¿ç”¨äº†å†…å­˜çš„ä¸€åŠã€‚</p><p>ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½é‡‡ç”¨è¿™ç§æ”¶é›†ç®—æ³•å›æ”¶æ–°ç”Ÿä»£ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œè€Œæ˜¯ä¸€å—è¾ƒå¤§çš„ Eden ç©ºé—´å’Œä¸¤å—è¾ƒå°çš„ Survivor ç©ºé—´ï¼Œæ¯æ¬¡ä½¿ç”¨ Eden å’Œå…¶ä¸­ä¸€å— Survivorã€‚åœ¨å›æ”¶æ—¶ï¼Œå°† Eden å’Œ Survivor ä¸­è¿˜å­˜æ´»ç€çš„å¯¹è±¡å…¨éƒ¨å¤åˆ¶åˆ°å¦ä¸€å— Survivor ä¸Šï¼Œæœ€åæ¸…ç† Eden å’Œä½¿ç”¨è¿‡çš„é‚£ä¸€å— Survivorã€‚</p><p>HotSpot è™šæ‹Ÿæœºçš„ Eden å’Œ Survivor å¤§å°æ¯”ä¾‹é»˜è®¤ä¸º 8:1ï¼Œä¿è¯äº†å†…å­˜çš„åˆ©ç”¨ç‡è¾¾åˆ° 90%ã€‚å¦‚æœæ¯æ¬¡å›æ”¶æœ‰å¤šäº 10% çš„å¯¹è±¡å­˜æ´»ï¼Œé‚£ä¹ˆä¸€å— Survivor å°±ä¸å¤Ÿç”¨äº†ï¼Œæ­¤æ—¶éœ€è¦ä¾èµ–äºè€å¹´ä»£è¿›è¡Œç©ºé—´åˆ†é…æ‹…ä¿ï¼Œä¹Ÿå°±æ˜¯å€Ÿç”¨è€å¹´ä»£çš„ç©ºé—´å­˜å‚¨æ”¾ä¸ä¸‹çš„å¯¹è±¡ã€‚</p><h4 id="4-åˆ†ä»£æ”¶é›†"><a href="#4-åˆ†ä»£æ”¶é›†" class="headerlink" title="4. åˆ†ä»£æ”¶é›†"></a>4. åˆ†ä»£æ”¶é›†</h4><p>ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºé‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œå®ƒæ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ï¼Œä¸åŒå—é‡‡ç”¨é€‚å½“çš„æ”¶é›†ç®—æ³•ã€‚</p><p>ä¸€èˆ¬å°†å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚</p><ul><li>æ–°ç”Ÿä»£ä½¿ç”¨ï¼šå¤åˆ¶ç®—æ³•</li><li>è€å¹´ä»£ä½¿ç”¨ï¼šæ ‡è®° - æ¸…é™¤ æˆ–è€… æ ‡è®° - æ•´ç† ç®—æ³•</li></ul><h3 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c625baa0-dde6-449e-93df-c3a67f2f430f.jpg" width=""/> </div><br></p><p>ä»¥ä¸Šæ˜¯ HotSpot è™šæ‹Ÿæœºä¸­çš„ 7 ä¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œè¿çº¿è¡¨ç¤ºåƒåœ¾æ”¶é›†å™¨å¯ä»¥é…åˆä½¿ç”¨ã€‚</p><ul><li>å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹ï¼šå•çº¿ç¨‹æŒ‡çš„æ˜¯åƒåœ¾æ”¶é›†å™¨åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œå¤šçº¿ç¨‹ä½¿ç”¨å¤šä¸ªçº¿ç¨‹ï¼›</li><li>ä¸²è¡Œä¸å¹¶è¡Œï¼šä¸²è¡ŒæŒ‡çš„æ˜¯åƒåœ¾æ”¶é›†å™¨ä¸ç”¨æˆ·ç¨‹åºäº¤æ›¿æ‰§è¡Œï¼Œè¿™æ„å‘³ç€åœ¨æ‰§è¡Œåƒåœ¾æ”¶é›†çš„æ—¶å€™éœ€è¦åœé¡¿ç”¨æˆ·ç¨‹åºï¼›å¹¶è¡ŒæŒ‡çš„æ˜¯åƒåœ¾æ”¶é›†å™¨å’Œç”¨æˆ·ç¨‹åºåŒæ—¶æ‰§è¡Œã€‚é™¤äº† CMS å’Œ G1 ä¹‹å¤–ï¼Œå…¶å®ƒåƒåœ¾æ”¶é›†å™¨éƒ½æ˜¯ä»¥ä¸²è¡Œçš„æ–¹å¼æ‰§è¡Œã€‚</li></ul><h4 id="1-Serial-æ”¶é›†å™¨"><a href="#1-Serial-æ”¶é›†å™¨" class="headerlink" title="1. Serial æ”¶é›†å™¨"></a>1. Serial æ”¶é›†å™¨</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/22fda4ae-4dd5-489d-ab10-9ebfdad22ae0.jpg" width=""/> </div><br></p><p>Serial ç¿»è¯‘ä¸ºä¸²è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¥ä¸²è¡Œçš„æ–¹å¼æ‰§è¡Œã€‚</p><p>å®ƒæ˜¯å•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œåªä¼šä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œã€‚</p><p>å®ƒçš„ä¼˜ç‚¹æ˜¯ç®€å•é«˜æ•ˆï¼Œåœ¨å•ä¸ª CPU ç¯å¢ƒä¸‹ï¼Œç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œå› æ­¤æ‹¥æœ‰æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚</p><p>å®ƒæ˜¯ Client åœºæ™¯ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œå› ä¸ºåœ¨è¯¥åœºæ™¯ä¸‹å†…å­˜ä¸€èˆ¬æ¥è¯´ä¸ä¼šå¾ˆå¤§ã€‚å®ƒæ”¶é›†ä¸€ä¸¤ç™¾å…†åƒåœ¾çš„åœé¡¿æ—¶é—´å¯ä»¥æ§åˆ¶åœ¨ä¸€ç™¾å¤šæ¯«ç§’ä»¥å†…ï¼Œåªè¦ä¸æ˜¯å¤ªé¢‘ç¹ï¼Œè¿™ç‚¹åœé¡¿æ—¶é—´æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p><h4 id="2-ParNew-æ”¶é›†å™¨"><a href="#2-ParNew-æ”¶é›†å™¨" class="headerlink" title="2. ParNew æ”¶é›†å™¨"></a>2. ParNew æ”¶é›†å™¨</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/81538cd5-1bcf-4e31-86e5-e198df1e013b.jpg" width=""/> </div><br></p><p>å®ƒæ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚</p><p>å®ƒæ˜¯ Server åœºæ™¯ä¸‹é»˜è®¤çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œé™¤äº†æ€§èƒ½åŸå› å¤–ï¼Œä¸»è¦æ˜¯å› ä¸ºé™¤äº† Serial æ”¶é›†å™¨ï¼Œåªæœ‰å®ƒèƒ½ä¸ CMS æ”¶é›†å™¨é…åˆä½¿ç”¨ã€‚</p><h4 id="3-Parallel-Scavenge-æ”¶é›†å™¨"><a href="#3-Parallel-Scavenge-æ”¶é›†å™¨" class="headerlink" title="3. Parallel Scavenge æ”¶é›†å™¨"></a>3. Parallel Scavenge æ”¶é›†å™¨</h4><p>ä¸ ParNew ä¸€æ ·æ˜¯å¤šçº¿ç¨‹æ”¶é›†å™¨ã€‚</p><p>å…¶å®ƒæ”¶é›†å™¨ç›®æ ‡æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼Œè€Œå®ƒçš„ç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œå› æ­¤å®ƒè¢«ç§°ä¸ºâ€œååé‡ä¼˜å…ˆâ€æ”¶é›†å™¨ã€‚è¿™é‡Œçš„ååé‡æŒ‡ CPU ç”¨äºè¿è¡Œç”¨æˆ·ç¨‹åºçš„æ—¶é—´å æ€»æ—¶é—´çš„æ¯”å€¼ã€‚</p><p>åœé¡¿æ—¶é—´è¶ŠçŸ­å°±è¶Šé€‚åˆéœ€è¦ä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒã€‚è€Œé«˜ååé‡åˆ™å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨ CPU æ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œé€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚</p><p>ç¼©çŸ­åœé¡¿æ—¶é—´æ˜¯ä»¥ç‰ºç‰²ååé‡å’Œæ–°ç”Ÿä»£ç©ºé—´æ¥æ¢å–çš„ï¼šæ–°ç”Ÿä»£ç©ºé—´å˜å°ï¼Œåƒåœ¾å›æ”¶å˜å¾—é¢‘ç¹ï¼Œå¯¼è‡´ååé‡ä¸‹é™ã€‚</p><p>å¯ä»¥é€šè¿‡ä¸€ä¸ªå¼€å…³å‚æ•°æ‰“å¼€ GC è‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥ï¼ˆGC Ergonomicsï¼‰ï¼Œå°±ä¸éœ€è¦æ‰‹å·¥æŒ‡å®šæ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-Xmnï¼‰ã€Eden å’Œ Survivor åŒºçš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£å¯¹è±¡å¹´é¾„ç­‰ç»†èŠ‚å‚æ•°äº†ã€‚è™šæ‹Ÿæœºä¼šæ ¹æ®å½“å‰ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°ä»¥æä¾›æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–è€…æœ€å¤§çš„ååé‡ã€‚</p><h4 id="4-Serial-Old-æ”¶é›†å™¨"><a href="#4-Serial-Old-æ”¶é›†å™¨" class="headerlink" title="4. Serial Old æ”¶é›†å™¨"></a>4. Serial Old æ”¶é›†å™¨</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/08f32fd3-f736-4a67-81ca-295b2a7972f2.jpg" width=""/> </div><br></p><p>æ˜¯ Serial æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯ç»™ Client åœºæ™¯ä¸‹çš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚å¦‚æœç”¨åœ¨ Server åœºæ™¯ä¸‹ï¼Œå®ƒæœ‰ä¸¤å¤§ç”¨é€”ï¼š</p><ul><li>åœ¨ JDK 1.5 ä»¥åŠä¹‹å‰ç‰ˆæœ¬ï¼ˆParallel Old è¯ç”Ÿä»¥å‰ï¼‰ä¸­ä¸ Parallel Scavenge æ”¶é›†å™¨æ­é…ä½¿ç”¨ã€‚</li><li>ä½œä¸º CMS æ”¶é›†å™¨çš„åå¤‡é¢„æ¡ˆï¼Œåœ¨å¹¶å‘æ”¶é›†å‘ç”Ÿ Concurrent Mode Failure æ—¶ä½¿ç”¨ã€‚</li></ul><h4 id="5-Parallel-Old-æ”¶é›†å™¨"><a href="#5-Parallel-Old-æ”¶é›†å™¨" class="headerlink" title="5. Parallel Old æ”¶é›†å™¨"></a>5. Parallel Old æ”¶é›†å™¨</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/278fe431-af88-4a95-a895-9c3b80117de3.jpg" width=""/> </div><br></p><p>æ˜¯ Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚</p><p>åœ¨æ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºæ•æ„Ÿçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge åŠ  Parallel Old æ”¶é›†å™¨ã€‚</p><h4 id="6-CMS-æ”¶é›†å™¨"><a href="#6-CMS-æ”¶é›†å™¨" class="headerlink" title="6. CMS æ”¶é›†å™¨"></a>6. CMS æ”¶é›†å™¨</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/62e77997-6957-4b68-8d12-bfd609bb2c68.jpg" width=""/> </div><br></p><p>CMSï¼ˆConcurrent Mark Sweepï¼‰ï¼ŒMark Sweep æŒ‡çš„æ˜¯æ ‡è®° - æ¸…é™¤ç®—æ³•ã€‚</p><p>åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæµç¨‹ï¼š</p><ul><li>åˆå§‹æ ‡è®°ï¼šä»…ä»…åªæ˜¯æ ‡è®°ä¸€ä¸‹ GC Roots èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œéœ€è¦åœé¡¿ã€‚</li><li>å¹¶å‘æ ‡è®°ï¼šè¿›è¡Œ GC Roots Tracing çš„è¿‡ç¨‹ï¼Œå®ƒåœ¨æ•´ä¸ªå›æ”¶è¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿ï¼Œä¸éœ€è¦åœé¡¿ã€‚</li><li>é‡æ–°æ ‡è®°ï¼šä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œéœ€è¦åœé¡¿ã€‚</li><li>å¹¶å‘æ¸…é™¤ï¼šä¸éœ€è¦åœé¡¿ã€‚</li></ul><p>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œæ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦è¿›è¡Œåœé¡¿ã€‚</p><p>å…·æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š</p><ul><li>ååé‡ä½ï¼šä½åœé¡¿æ—¶é—´æ˜¯ä»¥ç‰ºç‰²ååé‡ä¸ºä»£ä»·çš„ï¼Œå¯¼è‡´ CPU åˆ©ç”¨ç‡ä¸å¤Ÿé«˜ã€‚</li><li>æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼Œå¯èƒ½å‡ºç° Concurrent Mode Failureã€‚æµ®åŠ¨åƒåœ¾æ˜¯æŒ‡å¹¶å‘æ¸…é™¤é˜¶æ®µç”±äºç”¨æˆ·çº¿ç¨‹ç»§ç»­è¿è¡Œè€Œäº§ç”Ÿçš„åƒåœ¾ï¼Œè¿™éƒ¨åˆ†åƒåœ¾åªèƒ½åˆ°ä¸‹ä¸€æ¬¡ GC æ—¶æ‰èƒ½è¿›è¡Œå›æ”¶ã€‚ç”±äºæµ®åŠ¨åƒåœ¾çš„å­˜åœ¨ï¼Œå› æ­¤éœ€è¦é¢„ç•™å‡ºä¸€éƒ¨åˆ†å†…å­˜ï¼Œæ„å‘³ç€ CMS æ”¶é›†ä¸èƒ½åƒå…¶å®ƒæ”¶é›†å™¨é‚£æ ·ç­‰å¾…è€å¹´ä»£å¿«æ»¡çš„æ—¶å€™å†å›æ”¶ã€‚å¦‚æœé¢„ç•™çš„å†…å­˜ä¸å¤Ÿå­˜æ”¾æµ®åŠ¨åƒåœ¾ï¼Œå°±ä¼šå‡ºç° Concurrent Mode Failureï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†ä¸´æ—¶å¯ç”¨ Serial Old æ¥æ›¿ä»£ CMSã€‚</li><li>æ ‡è®° - æ¸…é™¤ç®—æ³•å¯¼è‡´çš„ç©ºé—´ç¢ç‰‡ï¼Œå¾€å¾€å‡ºç°è€å¹´ä»£ç©ºé—´å‰©ä½™ï¼Œä½†æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§è¿ç»­ç©ºé—´æ¥åˆ†é…å½“å‰å¯¹è±¡ï¼Œä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡ Full GCã€‚</li></ul><h4 id="7-G1-æ”¶é›†å™¨"><a href="#7-G1-æ”¶é›†å™¨" class="headerlink" title="7. G1 æ”¶é›†å™¨"></a>7. G1 æ”¶é›†å™¨</h4><p>G1ï¼ˆGarbage-Firstï¼‰ï¼Œå®ƒæ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨å¤š CPU å’Œå¤§å†…å­˜çš„åœºæ™¯ä¸‹æœ‰å¾ˆå¥½çš„æ€§èƒ½ã€‚HotSpot å¼€å‘å›¢é˜Ÿèµ‹äºˆå®ƒçš„ä½¿å‘½æ˜¯æœªæ¥å¯ä»¥æ›¿æ¢æ‰ CMS æ”¶é›†å™¨ã€‚</p><p>å †è¢«åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œå…¶å®ƒæ”¶é›†å™¨è¿›è¡Œæ”¶é›†çš„èŒƒå›´éƒ½æ˜¯æ•´ä¸ªæ–°ç”Ÿä»£æˆ–è€…è€å¹´ä»£ï¼Œè€Œ G1 å¯ä»¥ç›´æ¥å¯¹æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸€èµ·å›æ”¶ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/4cf711a8-7ab2-4152-b85c-d5c226733807.png" width="600"/> </div><br></p><p>G1 æŠŠå †åˆ’åˆ†æˆå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†ç‰©ç†éš”ç¦»ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9bbddeeb-e939-41f0-8e8e-2b1a0aa7e0a7.png" width="600"/> </div><br></p><p>é€šè¿‡å¼•å…¥ Region çš„æ¦‚å¿µï¼Œä»è€Œå°†åŸæ¥çš„ä¸€æ•´å—å†…å­˜ç©ºé—´åˆ’åˆ†æˆå¤šä¸ªçš„å°ç©ºé—´ï¼Œä½¿å¾—æ¯ä¸ªå°ç©ºé—´å¯ä»¥å•ç‹¬è¿›è¡Œåƒåœ¾å›æ”¶ã€‚è¿™ç§åˆ’åˆ†æ–¹æ³•å¸¦æ¥äº†å¾ˆå¤§çš„çµæ´»æ€§ï¼Œä½¿å¾—å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹æˆä¸ºå¯èƒ½ã€‚é€šè¿‡è®°å½•æ¯ä¸ª Region åƒåœ¾å›æ”¶æ—¶é—´ä»¥åŠå›æ”¶æ‰€è·å¾—çš„ç©ºé—´ï¼ˆè¿™ä¸¤ä¸ªå€¼æ˜¯é€šè¿‡è¿‡å»å›æ”¶çš„ç»éªŒè·å¾—ï¼‰ï¼Œå¹¶ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„ Regionã€‚</p><p>æ¯ä¸ª Region éƒ½æœ‰ä¸€ä¸ª Remembered Setï¼Œç”¨æ¥è®°å½•è¯¥ Region å¯¹è±¡çš„å¼•ç”¨å¯¹è±¡æ‰€åœ¨çš„ Regionã€‚é€šè¿‡ä½¿ç”¨ Remembered Setï¼Œåœ¨åšå¯è¾¾æ€§åˆ†æçš„æ—¶å€™å°±å¯ä»¥é¿å…å…¨å †æ‰«æã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f99ee771-c56f-47fb-9148-c0036695b5fe.jpg" width=""/> </div><br></p><p>å¦‚æœä¸è®¡ç®—ç»´æŠ¤ Remembered Set çš„æ“ä½œï¼ŒG1 æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´å¯åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆå§‹æ ‡è®°</li><li>å¹¶å‘æ ‡è®°</li><li>æœ€ç»ˆæ ‡è®°ï¼šä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†æ ‡è®°è®°å½•ï¼Œè™šæ‹Ÿæœºå°†è¿™æ®µæ—¶é—´å¯¹è±¡å˜åŒ–è®°å½•åœ¨çº¿ç¨‹çš„ Remembered Set Logs é‡Œé¢ï¼Œæœ€ç»ˆæ ‡è®°é˜¶æ®µéœ€è¦æŠŠ Remembered Set Logs çš„æ•°æ®åˆå¹¶åˆ° Remembered Set ä¸­ã€‚è¿™é˜¶æ®µéœ€è¦åœé¡¿çº¿ç¨‹ï¼Œä½†æ˜¯å¯å¹¶è¡Œæ‰§è¡Œã€‚</li><li>ç­›é€‰å›æ”¶ï¼šé¦–å…ˆå¯¹å„ä¸ª Region ä¸­çš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œæ ¹æ®ç”¨æˆ·æ‰€æœŸæœ›çš„ GC åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚æ­¤é˜¶æ®µå…¶å®ä¹Ÿå¯ä»¥åšåˆ°ä¸ç”¨æˆ·ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Œä½†æ˜¯å› ä¸ºåªå›æ”¶ä¸€éƒ¨åˆ† Regionï¼Œæ—¶é—´æ˜¯ç”¨æˆ·å¯æ§åˆ¶çš„ï¼Œè€Œä¸”åœé¡¿ç”¨æˆ·çº¿ç¨‹å°†å¤§å¹…åº¦æé«˜æ”¶é›†æ•ˆç‡ã€‚</li></ul><p>å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>ç©ºé—´æ•´åˆï¼šæ•´ä½“æ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®° - æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼Œä»å±€éƒ¨ï¼ˆä¸¤ä¸ª Region ä¹‹é—´ï¼‰ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œå¤åˆ¶â€ç®—æ³•å®ç°çš„ï¼Œè¿™æ„å‘³ç€è¿è¡ŒæœŸé—´ä¸ä¼šäº§ç”Ÿå†…å­˜ç©ºé—´ç¢ç‰‡ã€‚</li><li>å¯é¢„æµ‹çš„åœé¡¿ï¼šèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸º M æ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨ GC ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡ N æ¯«ç§’ã€‚</li></ul><h2 id="ä¸‰ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"><a href="#ä¸‰ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥" class="headerlink" title="ä¸‰ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"></a>ä¸‰ã€å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥</h2><h3 id="Minor-GC-å’Œ-Full-GC"><a href="#Minor-GC-å’Œ-Full-GC" class="headerlink" title="Minor GC å’Œ Full GC"></a>Minor GC å’Œ Full GC</h3><ul><li><p>Minor GCï¼šå›æ”¶æ–°ç”Ÿä»£ï¼Œå› ä¸ºæ–°ç”Ÿä»£å¯¹è±¡å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œå› æ­¤ Minor GC ä¼šé¢‘ç¹æ‰§è¡Œï¼Œæ‰§è¡Œçš„é€Ÿåº¦ä¸€èˆ¬ä¹Ÿä¼šæ¯”è¾ƒå¿«ã€‚</p></li><li><p>Full GCï¼šå›æ”¶è€å¹´ä»£å’Œæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£å¯¹è±¡å…¶å­˜æ´»æ—¶é—´é•¿ï¼Œå› æ­¤ Full GC å¾ˆå°‘æ‰§è¡Œï¼Œæ‰§è¡Œé€Ÿåº¦ä¼šæ¯” Minor GC æ…¢å¾ˆå¤šã€‚</p></li></ul><h3 id="å†…å­˜åˆ†é…ç­–ç•¥"><a href="#å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="å†…å­˜åˆ†é…ç­–ç•¥"></a>å†…å­˜åˆ†é…ç­–ç•¥</h3><h4 id="1-å¯¹è±¡ä¼˜å…ˆåœ¨-Eden-åˆ†é…"><a href="#1-å¯¹è±¡ä¼˜å…ˆåœ¨-Eden-åˆ†é…" class="headerlink" title="1. å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…"></a>1. å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…</h4><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ Eden ä¸Šåˆ†é…ï¼Œå½“ Eden ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œå‘èµ· Minor GCã€‚</p><h4 id="2-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"><a href="#2-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£" class="headerlink" title="2. å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"></a>2. å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</h4><p>å¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼Œæœ€å…¸å‹çš„å¤§å¯¹è±¡æ˜¯é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²ä»¥åŠæ•°ç»„ã€‚</p><p>ç»å¸¸å‡ºç°å¤§å¯¹è±¡ä¼šæå‰è§¦å‘åƒåœ¾æ”¶é›†ä»¥è·å–è¶³å¤Ÿçš„è¿ç»­ç©ºé—´åˆ†é…ç»™å¤§å¯¹è±¡ã€‚</p><p>-XX:PretenureSizeThresholdï¼Œå¤§äºæ­¤å€¼çš„å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ï¼Œé¿å…åœ¨ Eden å’Œ Survivor ä¹‹é—´çš„å¤§é‡å†…å­˜å¤åˆ¶ã€‚</p><h4 id="3-é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£"><a href="#3-é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£" class="headerlink" title="3. é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£"></a>3. é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£</h4><p>ä¸ºå¯¹è±¡å®šä¹‰å¹´é¾„è®¡æ•°å™¨ï¼Œå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ Minor GC ä¾ç„¶å­˜æ´»ï¼Œå°†ç§»åŠ¨åˆ° Survivor ä¸­ï¼Œå¹´é¾„å°±å¢åŠ  1 å²ï¼Œå¢åŠ åˆ°ä¸€å®šå¹´é¾„åˆ™ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p><p>-XX:MaxTenuringThreshold ç”¨æ¥å®šä¹‰å¹´é¾„çš„é˜ˆå€¼ã€‚</p><h4 id="4-åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"><a href="#4-åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š" class="headerlink" title="4. åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"></a>4. åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š</h4><p>è™šæ‹Ÿæœºå¹¶ä¸æ˜¯æ°¸è¿œè¦æ±‚å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ° MaxTenuringThreshold æ‰èƒ½æ™‹å‡è€å¹´ä»£ï¼Œå¦‚æœåœ¨ Survivor ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äº Survivor ç©ºé—´çš„ä¸€åŠï¼Œåˆ™å¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— éœ€ç­‰åˆ° MaxTenuringThreshold ä¸­è¦æ±‚çš„å¹´é¾„ã€‚</p><h4 id="5-ç©ºé—´åˆ†é…æ‹…ä¿"><a href="#5-ç©ºé—´åˆ†é…æ‹…ä¿" class="headerlink" title="5. ç©ºé—´åˆ†é…æ‹…ä¿"></a>5. ç©ºé—´åˆ†é…æ‹…ä¿</h4><p>åœ¨å‘ç”Ÿ Minor GC ä¹‹å‰ï¼Œè™šæ‹Ÿæœºå…ˆæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œå¦‚æœæ¡ä»¶æˆç«‹çš„è¯ï¼Œé‚£ä¹ˆ Minor GC å¯ä»¥ç¡®è®¤æ˜¯å®‰å…¨çš„ã€‚</p><p>å¦‚æœä¸æˆç«‹çš„è¯è™šæ‹Ÿæœºä¼šæŸ¥çœ‹ HandlePromotionFailure çš„å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ï¼Œå¦‚æœå…è®¸é‚£ä¹ˆå°±ä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœå¤§äºï¼Œå°†å°è¯•ç€è¿›è¡Œä¸€æ¬¡ Minor GCï¼›å¦‚æœå°äºï¼Œæˆ–è€… HandlePromotionFailure çš„å€¼ä¸å…è®¸å†’é™©ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œä¸€æ¬¡ Full GCã€‚</p><h3 id="Full-GC-çš„è§¦å‘æ¡ä»¶"><a href="#Full-GC-çš„è§¦å‘æ¡ä»¶" class="headerlink" title="Full GC çš„è§¦å‘æ¡ä»¶"></a>Full GC çš„è§¦å‘æ¡ä»¶</h3><p>å¯¹äº Minor GCï¼Œå…¶è§¦å‘æ¡ä»¶éå¸¸ç®€å•ï¼Œå½“ Eden ç©ºé—´æ»¡æ—¶ï¼Œå°±å°†è§¦å‘ä¸€æ¬¡ Minor GCã€‚è€Œ Full GC åˆ™ç›¸å¯¹å¤æ‚ï¼Œæœ‰ä»¥ä¸‹æ¡ä»¶ï¼š</p><h4 id="1-è°ƒç”¨-System-gc"><a href="#1-è°ƒç”¨-System-gc" class="headerlink" title="1. è°ƒç”¨ System.gc()"></a>1. è°ƒç”¨ System.gc()</h4><p>åªæ˜¯å»ºè®®è™šæ‹Ÿæœºæ‰§è¡Œ Full GCï¼Œä½†æ˜¯è™šæ‹Ÿæœºä¸ä¸€å®šçœŸæ­£å»æ‰§è¡Œã€‚ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯è®©è™šæ‹Ÿæœºç®¡ç†å†…å­˜ã€‚</p><h4 id="2-è€å¹´ä»£ç©ºé—´ä¸è¶³"><a href="#2-è€å¹´ä»£ç©ºé—´ä¸è¶³" class="headerlink" title="2. è€å¹´ä»£ç©ºé—´ä¸è¶³"></a>2. è€å¹´ä»£ç©ºé—´ä¸è¶³</h4><p>è€å¹´ä»£ç©ºé—´ä¸è¶³çš„å¸¸è§åœºæ™¯ä¸ºå‰æ–‡æ‰€è®²çš„å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ç­‰ã€‚</p><p>ä¸ºäº†é¿å…ä»¥ä¸ŠåŸå› å¼•èµ·çš„ Full GCï¼Œåº”å½“å°½é‡ä¸è¦åˆ›å»ºè¿‡å¤§çš„å¯¹è±¡ä»¥åŠæ•°ç»„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥é€šè¿‡ -Xmn è™šæ‹Ÿæœºå‚æ•°è°ƒå¤§æ–°ç”Ÿä»£çš„å¤§å°ï¼Œè®©å¯¹è±¡å°½é‡åœ¨æ–°ç”Ÿä»£è¢«å›æ”¶æ‰ï¼Œä¸è¿›å…¥è€å¹´ä»£ã€‚è¿˜å¯ä»¥é€šè¿‡ -XX:MaxTenuringThreshold è°ƒå¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„å¹´é¾„ï¼Œè®©å¯¹è±¡åœ¨æ–°ç”Ÿä»£å¤šå­˜æ´»ä¸€æ®µæ—¶é—´ã€‚</p><h4 id="3-ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥"><a href="#3-ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥" class="headerlink" title="3. ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥"></a>3. ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥</h4><p>ä½¿ç”¨å¤åˆ¶ç®—æ³•çš„ Minor GC éœ€è¦è€å¹´ä»£çš„å†…å­˜ç©ºé—´ä½œæ‹…ä¿ï¼Œå¦‚æœæ‹…ä¿å¤±è´¥ä¼šæ‰§è¡Œä¸€æ¬¡ Full GCã€‚å…·ä½“å†…å®¹è¯·å‚è€ƒä¸Šé¢çš„ç¬¬ 5 å°èŠ‚ã€‚</p><h4 id="4-JDK-1-7-åŠä»¥å‰çš„æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³"><a href="#4-JDK-1-7-åŠä»¥å‰çš„æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³" class="headerlink" title="4. JDK 1.7 åŠä»¥å‰çš„æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³"></a>4. JDK 1.7 åŠä»¥å‰çš„æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³</h4><p>åœ¨ JDK 1.7 åŠä»¥å‰ï¼ŒHotSpot è™šæ‹Ÿæœºä¸­çš„æ–¹æ³•åŒºæ˜¯ç”¨æ°¸ä¹…ä»£å®ç°çš„ï¼Œæ°¸ä¹…ä»£ä¸­å­˜æ”¾çš„ä¸ºä¸€äº› Class çš„ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ç­‰æ•°æ®ã€‚</p><p>å½“ç³»ç»Ÿä¸­è¦åŠ è½½çš„ç±»ã€åå°„çš„ç±»å’Œè°ƒç”¨çš„æ–¹æ³•è¾ƒå¤šæ—¶ï¼Œæ°¸ä¹…ä»£å¯èƒ½ä¼šè¢«å æ»¡ï¼Œåœ¨æœªé…ç½®ä¸ºé‡‡ç”¨ CMS GC çš„æƒ…å†µä¸‹ä¹Ÿä¼šæ‰§è¡Œ Full GCã€‚å¦‚æœç»è¿‡ Full GC ä»ç„¶å›æ”¶ä¸äº†ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºä¼šæŠ›å‡º java.lang.OutOfMemoryErrorã€‚</p><p>ä¸ºé¿å…ä»¥ä¸ŠåŸå› å¼•èµ·çš„ Full GCï¼Œå¯é‡‡ç”¨çš„æ–¹æ³•ä¸ºå¢å¤§æ°¸ä¹…ä»£ç©ºé—´æˆ–è½¬ä¸ºä½¿ç”¨ CMS GCã€‚</p><h4 id="5-Concurrent-Mode-Failure"><a href="#5-Concurrent-Mode-Failure" class="headerlink" title="5. Concurrent Mode Failure"></a>5. Concurrent Mode Failure</h4><p>æ‰§è¡Œ CMS GC çš„è¿‡ç¨‹ä¸­åŒæ—¶æœ‰å¯¹è±¡è¦æ”¾å…¥è€å¹´ä»£ï¼Œè€Œæ­¤æ—¶è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼ˆå¯èƒ½æ˜¯ GC è¿‡ç¨‹ä¸­æµ®åŠ¨åƒåœ¾è¿‡å¤šå¯¼è‡´æš‚æ—¶æ€§çš„ç©ºé—´ä¸è¶³ï¼‰ï¼Œä¾¿ä¼šæŠ¥ Concurrent Mode Failure é”™è¯¯ï¼Œå¹¶è§¦å‘ Full GCã€‚</p><h2 id="å››ã€ç±»åŠ è½½æœºåˆ¶"><a href="#å››ã€ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="å››ã€ç±»åŠ è½½æœºåˆ¶"></a>å››ã€ç±»åŠ è½½æœºåˆ¶</h2><p>ç±»æ˜¯åœ¨è¿è¡ŒæœŸé—´ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶åŠ¨æ€åŠ è½½çš„ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç±»ã€‚å› ä¸ºå¦‚æœä¸€æ¬¡æ€§åŠ è½½ï¼Œé‚£ä¹ˆä¼šå ç”¨å¾ˆå¤šçš„å†…å­˜ã€‚</p><h3 id="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ç±»çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></a>ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/335fe19c-4a76-45ab-9320-88c90d6a0d7e.png" width="600px"> </div><br></p><p>åŒ…æ‹¬ä»¥ä¸‹ 7 ä¸ªé˜¶æ®µï¼š</p><ul><li><strong>åŠ è½½ï¼ˆLoadingï¼‰</strong>  </li><li><strong>éªŒè¯ï¼ˆVerificationï¼‰</strong>  </li><li><strong>å‡†å¤‡ï¼ˆPreparationï¼‰</strong>  </li><li><strong>è§£æï¼ˆResolutionï¼‰</strong>  </li><li><strong>åˆå§‹åŒ–ï¼ˆInitializationï¼‰</strong>  </li><li>ä½¿ç”¨ï¼ˆUsingï¼‰</li><li>å¸è½½ï¼ˆUnloadingï¼‰</li></ul><h3 id="ç±»åŠ è½½è¿‡ç¨‹"><a href="#ç±»åŠ è½½è¿‡ç¨‹" class="headerlink" title="ç±»åŠ è½½è¿‡ç¨‹"></a>ç±»åŠ è½½è¿‡ç¨‹</h3><p>åŒ…å«äº†åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–è¿™ 5 ä¸ªé˜¶æ®µã€‚</p><h4 id="1-åŠ è½½"><a href="#1-åŠ è½½" class="headerlink" title="1. åŠ è½½"></a>1. åŠ è½½</h4><p>åŠ è½½æ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ³¨æ„ä¸è¦æ··æ·†ã€‚</p><p>åŠ è½½è¿‡ç¨‹å®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š</p><ul><li>é€šè¿‡ç±»çš„å®Œå…¨é™å®šåç§°è·å–å®šä¹‰è¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚</li><li>å°†è¯¥å­—èŠ‚æµè¡¨ç¤ºçš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å­˜å‚¨ç»“æ„ã€‚</li><li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ Class å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºä¸­è¯¥ç±»å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</li></ul><p>å…¶ä¸­äºŒè¿›åˆ¶å­—èŠ‚æµå¯ä»¥ä»ä»¥ä¸‹æ–¹å¼ä¸­è·å–ï¼š</p><ul><li>ä» ZIP åŒ…è¯»å–ï¼Œæˆä¸º JARã€EARã€WAR æ ¼å¼çš„åŸºç¡€ã€‚</li><li>ä»ç½‘ç»œä¸­è·å–ï¼Œæœ€å…¸å‹çš„åº”ç”¨æ˜¯ Appletã€‚</li><li>è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä¾‹å¦‚åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œåœ¨ java.lang.reflect.Proxy ä½¿ç”¨ ProxyGenerator.generateProxyClass çš„ä»£ç†ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚</li><li>ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œä¾‹å¦‚ç”± JSP æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ Class ç±»ã€‚</li></ul><h4 id="2-éªŒè¯"><a href="#2-éªŒè¯" class="headerlink" title="2. éªŒè¯"></a>2. éªŒè¯</h4><p>ç¡®ä¿ Class æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚</p><h4 id="3-å‡†å¤‡"><a href="#3-å‡†å¤‡" class="headerlink" title="3. å‡†å¤‡"></a>3. å‡†å¤‡</h4><p>ç±»å˜é‡æ˜¯è¢« static ä¿®é¥°çš„å˜é‡ï¼Œå‡†å¤‡é˜¶æ®µä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼ï¼Œä½¿ç”¨çš„æ˜¯æ–¹æ³•åŒºçš„å†…å­˜ã€‚</p><p>å®ä¾‹å˜é‡ä¸ä¼šåœ¨è¿™é˜¶æ®µåˆ†é…å†…å­˜ï¼Œå®ƒä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·è¢«åˆ†é…åœ¨å †ä¸­ã€‚åº”è¯¥æ³¨æ„åˆ°ï¼Œå®ä¾‹åŒ–ä¸æ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç±»åŠ è½½å‘ç”Ÿåœ¨æ‰€æœ‰å®ä¾‹åŒ–æ“ä½œä¹‹å‰ï¼Œå¹¶ä¸”ç±»åŠ è½½åªè¿›è¡Œä¸€æ¬¡ï¼Œå®ä¾‹åŒ–å¯ä»¥è¿›è¡Œå¤šæ¬¡ã€‚</p><p>åˆå§‹å€¼ä¸€èˆ¬ä¸º 0 å€¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç±»å˜é‡ value è¢«åˆå§‹åŒ–ä¸º 0 è€Œä¸æ˜¯ 123ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœç±»å˜é‡æ˜¯å¸¸é‡ï¼Œé‚£ä¹ˆå®ƒå°†åˆå§‹åŒ–ä¸ºè¡¨è¾¾å¼æ‰€å®šä¹‰çš„å€¼è€Œä¸æ˜¯ 0ã€‚ä¾‹å¦‚ä¸‹é¢çš„å¸¸é‡ value è¢«åˆå§‹åŒ–ä¸º 123 è€Œä¸æ˜¯ 0ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">123</span>;</span><br></pre></td></tr></table></figure><h4 id="4-è§£æ"><a href="#4-è§£æ" class="headerlink" title="4. è§£æ"></a>4. è§£æ</h4><p>å°†å¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</p><p>å…¶ä¸­è§£æè¿‡ç¨‹åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ Java çš„åŠ¨æ€ç»‘å®šã€‚</p><h4 id="5-åˆå§‹åŒ–"><a href="#5-åˆå§‹åŒ–" class="headerlink" title="5. åˆå§‹åŒ–"></a>5. åˆå§‹åŒ–</h4><p><div data="modify -->"></div><br>åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç ã€‚åˆå§‹åŒ–é˜¶æ®µæ˜¯è™šæ‹Ÿæœºæ‰§è¡Œç±»æ„é€ å™¨ &lt;clinit>() æ–¹æ³•çš„è¿‡ç¨‹ã€‚åœ¨å‡†å¤‡é˜¶æ®µï¼Œç±»å˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼ï¼Œè€Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæ ¹æ®ç¨‹åºå‘˜é€šè¿‡ç¨‹åºåˆ¶å®šçš„ä¸»è§‚è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶å®ƒèµ„æºã€‚</p><p>&lt;clinit>() æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„ï¼Œç¼–è¯‘å™¨æ”¶é›†çš„é¡ºåºç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºå†³å®šã€‚ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œé™æ€è¯­å¥å—åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨å®ƒä¹‹å‰çš„ç±»å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„ç±»å˜é‡åªèƒ½èµ‹å€¼ï¼Œä¸èƒ½è®¿é—®ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">0</span>;                <span class="comment">// ç»™å˜é‡èµ‹å€¼å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡</span></span><br><span class="line">        System.out.print(i);  <span class="comment">// è¿™å¥ç¼–è¯‘å™¨ä¼šæç¤ºâ€œéæ³•å‘å‰å¼•ç”¨â€</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºçˆ¶ç±»çš„ &lt;clinit>() æ–¹æ³•å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ„å‘³ç€çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€è¯­å¥å—çš„æ‰§è¡Œè¦ä¼˜å…ˆäºå­ç±»ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">A</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        A = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sub</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">B</span> <span class="operator">=</span> A;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">     System.out.println(Sub.B);  <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£ä¸­ä¸å¯ä»¥ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†ä»ç„¶æœ‰ç±»å˜é‡åˆå§‹åŒ–çš„èµ‹å€¼æ“ä½œï¼Œå› æ­¤æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ &lt;clinit>() æ–¹æ³•ã€‚ä½†æ¥å£ä¸ç±»ä¸åŒçš„æ˜¯ï¼Œæ‰§è¡Œæ¥å£çš„ &lt;clinit>() æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œçˆ¶æ¥å£çš„ &lt;clinit>() æ–¹æ³•ã€‚åªæœ‰å½“çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šåˆå§‹åŒ–ã€‚å¦å¤–ï¼Œæ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¸€æ ·ä¸ä¼šæ‰§è¡Œæ¥å£çš„ &lt;clinit>() æ–¹æ³•ã€‚</p><p>è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„ &lt;clinit>() æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¢«æ­£ç¡®çš„åŠ é”å’ŒåŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸ªç±»çš„ &lt;clinit>() æ–¹æ³•ï¼Œå…¶å®ƒçº¿ç¨‹éƒ½ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ &lt;clinit>() æ–¹æ³•å®Œæ¯•ã€‚å¦‚æœåœ¨ä¸€ä¸ªç±»çš„ &lt;clinit>() æ–¹æ³•ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œå°±å¯èƒ½é€ æˆå¤šä¸ªçº¿ç¨‹é˜»å¡ï¼Œåœ¨å®é™…è¿‡ç¨‹ä¸­æ­¤ç§é˜»å¡å¾ˆéšè”½ã€‚</p><h3 id="ç±»åˆå§‹åŒ–æ—¶æœº"><a href="#ç±»åˆå§‹åŒ–æ—¶æœº" class="headerlink" title="ç±»åˆå§‹åŒ–æ—¶æœº"></a>ç±»åˆå§‹åŒ–æ—¶æœº</h3><h4 id="1-ä¸»åŠ¨å¼•ç”¨"><a href="#1-ä¸»åŠ¨å¼•ç”¨" class="headerlink" title="1. ä¸»åŠ¨å¼•ç”¨"></a>1. ä¸»åŠ¨å¼•ç”¨</h4><p>è™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶æ²¡æœ‰å¼ºåˆ¶çº¦æŸä½•æ—¶è¿›è¡ŒåŠ è½½ï¼Œä½†æ˜¯è§„èŒƒä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰ä¸‹åˆ—äº”ç§æƒ…å†µå¿…é¡»å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡éƒ½ä¼šéšä¹‹å‘ç”Ÿï¼‰ï¼š</p><ul><li><p>é‡åˆ° newã€getstaticã€putstaticã€invokestatic è¿™å››æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™å¿…é¡»å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚æœ€å¸¸è§çš„ç”Ÿæˆè¿™ 4 æ¡æŒ‡ä»¤çš„åœºæ™¯æ˜¯ï¼šä½¿ç”¨ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼›è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆè¢« final ä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰çš„æ—¶å€™ï¼›ä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚</p></li><li><p>ä½¿ç”¨ java.lang.reflect åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</p></li><li><p>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</p></li><li><p>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å« main() æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ï¼›</p></li><li><p>å½“ä½¿ç”¨ JDK 1.7 çš„åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ª java.lang.invoke.MethodHandle å®ä¾‹æœ€åçš„è§£æç»“æœä¸º REF_getStatic, REF_putStatic, REF_invokeStatic çš„æ–¹æ³•å¥æŸ„ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•å¥æŸ„æ‰€å¯¹åº”çš„ç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ï¼›</p></li></ul><h4 id="2-è¢«åŠ¨å¼•ç”¨"><a href="#2-è¢«åŠ¨å¼•ç”¨" class="headerlink" title="2. è¢«åŠ¨å¼•ç”¨"></a>2. è¢«åŠ¨å¼•ç”¨</h4><p>ä»¥ä¸Š 5 ç§åœºæ™¯ä¸­çš„è¡Œä¸ºç§°ä¸ºå¯¹ä¸€ä¸ªç±»è¿›è¡Œä¸»åŠ¨å¼•ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰å¼•ç”¨ç±»çš„æ–¹å¼éƒ½ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•ç”¨ã€‚è¢«åŠ¨å¼•ç”¨çš„å¸¸è§ä¾‹å­åŒ…æ‹¬ï¼š</p><ul><li>é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ–ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(SubClass.value);  <span class="comment">// value å­—æ®µåœ¨ SuperClass ä¸­å®šä¹‰</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–ã€‚è¯¥è¿‡ç¨‹ä¼šå¯¹æ•°ç»„ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œæ•°ç»„ç±»æ˜¯ä¸€ä¸ªç”±è™šæ‹Ÿæœºè‡ªåŠ¨ç”Ÿæˆçš„ã€ç›´æ¥ç»§æ‰¿è‡ª Object çš„å­ç±»ï¼Œå…¶ä¸­åŒ…å«äº†æ•°ç»„çš„å±æ€§å’Œæ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SuperClass[] sca = <span class="keyword">new</span> <span class="title class_">SuperClass</span>[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><ul><li>å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ConstClass.HELLOWORLD);</span><br></pre></td></tr></table></figure><h3 id="ç±»ä¸ç±»åŠ è½½å™¨"><a href="#ç±»ä¸ç±»åŠ è½½å™¨" class="headerlink" title="ç±»ä¸ç±»åŠ è½½å™¨"></a>ç±»ä¸ç±»åŠ è½½å™¨</h3><p>ä¸¤ä¸ªç±»ç›¸ç­‰ï¼Œéœ€è¦ç±»æœ¬èº«ç›¸ç­‰ï¼Œå¹¶ä¸”ä½¿ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸€ä¸ªç±»åŠ è½½å™¨éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´ã€‚</p><p>è¿™é‡Œçš„ç›¸ç­‰ï¼ŒåŒ…æ‹¬ç±»çš„ Class å¯¹è±¡çš„ equals() æ–¹æ³•ã€isAssignableFrom() æ–¹æ³•ã€isInstance() æ–¹æ³•çš„è¿”å›ç»“æœä¸º trueï¼Œä¹ŸåŒ…æ‹¬ä½¿ç”¨ instanceof å…³é”®å­—åšå¯¹è±¡æ‰€å±å…³ç³»åˆ¤å®šç»“æœä¸º trueã€‚</p><h3 id="ç±»åŠ è½½å™¨åˆ†ç±»"><a href="#ç±»åŠ è½½å™¨åˆ†ç±»" class="headerlink" title="ç±»åŠ è½½å™¨åˆ†ç±»"></a>ç±»åŠ è½½å™¨åˆ†ç±»</h3><p>ä» Java è™šæ‹Ÿæœºçš„è§’åº¦æ¥è®²ï¼Œåªå­˜åœ¨ä»¥ä¸‹ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š</p><ul><li><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼Œä½¿ç”¨ C++ å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼›</p></li><li><p>æ‰€æœ‰å…¶å®ƒç±»çš„åŠ è½½å™¨ï¼Œä½¿ç”¨ Java å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºï¼Œç»§æ‰¿è‡ªæŠ½è±¡ç±» java.lang.ClassLoaderã€‚</p></li></ul><p>ä» Java å¼€å‘äººå‘˜çš„è§’åº¦çœ‹ï¼Œç±»åŠ è½½å™¨å¯ä»¥åˆ’åˆ†å¾—æ›´ç»†è‡´ä¸€äº›ï¼š</p><ul><li><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰æ­¤ç±»åŠ è½½å™¨è´Ÿè´£å°†å­˜æ”¾åœ¨ &lt;JRE_HOME>\lib ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« -Xbootclasspath å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ï¼ˆä»…æŒ‰ç…§æ–‡ä»¶åè¯†åˆ«ï¼Œå¦‚ rt.jarï¼Œåå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨ lib ç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ï¼‰ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢« Java ç¨‹åºç›´æ¥å¼•ç”¨ï¼Œç”¨æˆ·åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œç›´æ¥ä½¿ç”¨ null ä»£æ›¿å³å¯ã€‚</p></li><li><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰è¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ç”± ExtClassLoaderï¼ˆsun.misc.Launcher$ExtClassLoaderï¼‰å®ç°çš„ã€‚å®ƒè´Ÿè´£å°† &lt;JAVA_HOME>/lib/ext æˆ–è€…è¢« java.ext.dir ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šè·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚</p></li><li><p>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰è¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ç”± AppClassLoaderï¼ˆsun.misc.Launcher$AppClassLoaderï¼‰å®ç°çš„ã€‚ç”±äºè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ ClassLoader ä¸­çš„ getSystemClassLoader() æ–¹æ³•çš„è¿”å›å€¼ï¼Œå› æ­¤ä¸€èˆ¬ç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</p></li></ul><h3 id="åŒäº²å§”æ´¾æ¨¡å‹"><a href="#åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹"></a>åŒäº²å§”æ´¾æ¨¡å‹</h3><p>åº”ç”¨ç¨‹åºæ˜¯ç”±ä¸‰ç§ç±»åŠ è½½å™¨äº’ç›¸é…åˆä»è€Œå®ç°ç±»åŠ è½½ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥åŠ å…¥è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»ï¼Œç§°ä¸ºåŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰ã€‚è¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶å®ƒçš„ç±»åŠ è½½å™¨éƒ½è¦æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™é‡Œçš„çˆ¶å­å…³ç³»ä¸€èˆ¬é€šè¿‡ç»„åˆå…³ç³»ï¼ˆCompositionï¼‰æ¥å®ç°ï¼Œè€Œä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼ˆInheritanceï¼‰ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/0dd2d40a-5b2b-4d45-b176-e75a4cd4bdbf.png" width="500px"> </div><br></p><h4 id="1-å·¥ä½œè¿‡ç¨‹"><a href="#1-å·¥ä½œè¿‡ç¨‹" class="headerlink" title="1. å·¥ä½œè¿‡ç¨‹"></a>1. å·¥ä½œè¿‡ç¨‹</h4><p>ä¸€ä¸ªç±»åŠ è½½å™¨é¦–å…ˆå°†ç±»åŠ è½½è¯·æ±‚è½¬å‘åˆ°çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ—¶æ‰å°è¯•è‡ªå·±åŠ è½½ã€‚</p><h4 id="2-å¥½å¤„"><a href="#2-å¥½å¤„" class="headerlink" title="2. å¥½å¤„"></a>2. å¥½å¤„</h4><p>ä½¿å¾— Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·æœ‰ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œä»è€Œä½¿å¾—åŸºç¡€ç±»å¾—åˆ°ç»Ÿä¸€ã€‚</p><p>ä¾‹å¦‚ java.lang.Object å­˜æ”¾åœ¨ rt.jar ä¸­ï¼Œå¦‚æœç¼–å†™å¦å¤–ä¸€ä¸ª java.lang.Object å¹¶æ”¾åˆ° ClassPath ä¸­ï¼Œç¨‹åºå¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚ç”±äºåŒäº²å§”æ´¾æ¨¡å‹çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨ rt.jar ä¸­çš„ Object æ¯”åœ¨ ClassPath ä¸­çš„ Object ä¼˜å…ˆçº§æ›´é«˜ï¼Œè¿™æ˜¯å› ä¸º rt.jar ä¸­çš„ Object ä½¿ç”¨çš„æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè€Œ ClassPath ä¸­çš„ Object ä½¿ç”¨çš„æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚rt.jar ä¸­çš„ Object ä¼˜å…ˆçº§æ›´é«˜ï¼Œé‚£ä¹ˆç¨‹åºä¸­æ‰€æœ‰çš„ Object éƒ½æ˜¯è¿™ä¸ª Objectã€‚</p><h4 id="3-å®ç°"><a href="#3-å®ç°" class="headerlink" title="3. å®ç°"></a>3. å®ç°</h4><p>ä»¥ä¸‹æ˜¯æŠ½è±¡ç±» java.lang.ClassLoader çš„ä»£ç ç‰‡æ®µï¼Œå…¶ä¸­çš„ loadClass() æ–¹æ³•è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼šå…ˆæ£€æŸ¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®©çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ã€‚å½“çˆ¶ç±»åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æŠ›å‡º ClassNotFoundExceptionï¼Œæ­¤æ—¶å°è¯•è‡ªå·±å»åŠ è½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°</h3><p>ä»¥ä¸‹ä»£ç ä¸­çš„ FileSystemClassLoader æ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œç»§æ‰¿è‡ª java.lang.ClassLoaderï¼Œç”¨äºåŠ è½½æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç±»ã€‚å®ƒé¦–å…ˆæ ¹æ®ç±»çš„å…¨ååœ¨æ–‡ä»¶ç³»ç»Ÿä¸ŠæŸ¥æ‰¾ç±»çš„å­—èŠ‚ä»£ç æ–‡ä»¶ï¼ˆ.class æ–‡ä»¶ï¼‰ï¼Œç„¶åè¯»å–è¯¥æ–‡ä»¶å†…å®¹ï¼Œæœ€åé€šè¿‡ defineClass() æ–¹æ³•æ¥æŠŠè¿™äº›å­—èŠ‚ä»£ç è½¬æ¢æˆ java.lang.Class ç±»çš„å®ä¾‹ã€‚</p><p>java.lang.ClassLoader çš„ loadClass() å®ç°äº†åŒäº²å§”æ´¾æ¨¡å‹çš„é€»è¾‘ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬ä¸å»é‡å†™å®ƒï¼Œä½†æ˜¯éœ€è¦é‡å†™ findClass() æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSystemClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String rootDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileSystemClassLoader</span><span class="params">(String rootDir)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rootDir = rootDir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">byte</span>[] classData = getClassData(name);</span><br><span class="line">        <span class="keyword">if</span> (classData == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] getClassData(String className) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> classNameToPath(className);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">ins</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">4096</span>;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferSize];</span><br><span class="line">            <span class="type">int</span> bytesNumRead;</span><br><span class="line">            <span class="keyword">while</span> ((bytesNumRead = ins.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, bytesNumRead);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">classNameToPath</span><span class="params">(String className)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rootDir + File.separatorChar</span><br><span class="line">                + className.replace(<span class="string">&#x27;.&#x27;</span>, File.separatorChar) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>å‘¨å¿—æ˜. æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2011.</li><li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4">Chapter 2. The Structure of the Java Virtual Machine</a></li><li><a href="https://www.slideshare.net/benewu/jvm-memory">Jvm memory</a><br><a href="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html">Getting Started with the G1 Garbage Collector</a></li><li><a href="http://electrofriends.com/articles/jni/jni-part1-java-native-interface/">JNI Part1: Java Native Interface Introduction and â€œHello Worldâ€ application</a></li><li><a href="https://hackthejava.wordpress.com/2015/01/09/memory-architecture-by-jvmruntime-data-areas/">Memory Architecture Of JVM(Runtime Data Areas)</a></li><li><a href="https://www.programcreek.com/2013/04/jvm-run-time-data-areas/">JVM Run-Time Data Areas</a></li><li><a href="http://www.drdobbs.com/architecture-and-design/android-on-x86-java-native-interface-and/240166271">Android on x86: Java Native Interface and the Android Native Development Kit</a></li><li><a href="https://crowhawk.github.io/2017/08/10/jvm_2/">æ·±å…¥ç†è§£ JVM(2)â€”â€”GC ç®—æ³•ä¸å†…å­˜åˆ†é…ç­–ç•¥</a></li><li><a href="https://crowhawk.github.io/2017/08/15/jvm_3/">æ·±å…¥ç†è§£ JVM(3)â€”â€”7 ç§åƒåœ¾æ”¶é›†å™¨</a></li><li><a href="http://blog.jamesdbloom.com/JVMInternals.html">JVM Internals</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-classloader/index.html#code6">æ·±å…¥æ¢è®¨ Java ç±»åŠ è½½å™¨</a></li><li><a href="http://www.baeldung.com/java-weakhashmap">Guide to WeakHashMap in Java</a></li><li><a href="https://alvinalexander.com/java/jwarehouse/apache-tomcat-6.0.16/java/org/apache/el/util/ConcurrentCache.java.shtml">Tomcat example source code file (ConcurrentCache.java)</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ javaè™šæ‹Ÿæœºçš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="JVM" scheme="https://www.jodio.cc/categories/JVM/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="Spring boot" scheme="https://www.jodio.cc/tags/Spring-boot/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹</title>
    <link href="https://www.jodio.cc/posts/2529.html"/>
    <id>https://www.jodio.cc/posts/2529.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-å¹¶å‘"><a href="#Java-å¹¶å‘" class="headerlink" title="Java å¹¶å‘"></a>Java å¹¶å‘</h1><h2 id="ä¸€ã€ä½¿ç”¨çº¿ç¨‹"><a href="#ä¸€ã€ä½¿ç”¨çº¿ç¨‹" class="headerlink" title="ä¸€ã€ä½¿ç”¨çº¿ç¨‹"></a>ä¸€ã€ä½¿ç”¨çº¿ç¨‹</h2><p>æœ‰ä¸‰ç§ä½¿ç”¨çº¿ç¨‹çš„æ–¹æ³•ï¼š</p><ul><li>å®ç° Runnable æ¥å£ï¼›</li><li>å®ç° Callable æ¥å£ï¼›</li><li>ç»§æ‰¿ Thread ç±»ã€‚</li></ul><p>å®ç° Runnable å’Œ Callable æ¥å£çš„ç±»åªèƒ½å½“åšä¸€ä¸ªå¯ä»¥åœ¨çº¿ç¨‹ä¸­è¿è¡Œçš„ä»»åŠ¡ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„çº¿ç¨‹ï¼Œå› æ­¤æœ€åè¿˜éœ€è¦é€šè¿‡ Thread æ¥è°ƒç”¨ã€‚å¯ä»¥ç†è§£ä¸ºä»»åŠ¡æ˜¯é€šè¿‡çº¿ç¨‹é©±åŠ¨ä»è€Œæ‰§è¡Œçš„ã€‚</p><h3 id="å®ç°-Runnable-æ¥å£"><a href="#å®ç°-Runnable-æ¥å£" class="headerlink" title="å®ç° Runnable æ¥å£"></a>å®ç° Runnable æ¥å£</h3><p>éœ€è¦å®ç°æ¥å£ä¸­çš„ run() æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Runnable å®ä¾‹å†åˆ›å»ºä¸€ä¸ª Thread å®ä¾‹ï¼Œç„¶åè°ƒç”¨ Thread å®ä¾‹çš„ start() æ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyRunnable</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRunnable</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(instance);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®ç°-Callable-æ¥å£"><a href="#å®ç°-Callable-æ¥å£" class="headerlink" title="å®ç° Callable æ¥å£"></a>å®ç° Callable æ¥å£</h3><p>ä¸ Runnable ç›¸æ¯”ï¼ŒCallable å¯ä»¥æœ‰è¿”å›å€¼ï¼Œè¿”å›å€¼é€šè¿‡ FutureTask è¿›è¡Œå°è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">MyCallable</span> <span class="variable">mc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCallable</span>();</span><br><span class="line">    FutureTask&lt;Integer&gt; ft = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(mc);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ft);</span><br><span class="line">    thread.start();</span><br><span class="line">    System.out.println(ft.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»§æ‰¿-Thread-ç±»"><a href="#ç»§æ‰¿-Thread-ç±»" class="headerlink" title="ç»§æ‰¿ Thread ç±»"></a>ç»§æ‰¿ Thread ç±»</h3><p>åŒæ ·ä¹Ÿæ˜¯éœ€è¦å®ç° run() æ–¹æ³•ï¼Œå› ä¸º Thread ç±»ä¹Ÿå®ç°äº† Runable æ¥å£ã€‚</p><p>å½“è°ƒç”¨ start() æ–¹æ³•å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œè™šæ‹Ÿæœºä¼šå°†è¯¥çº¿ç¨‹æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¢«è°ƒåº¦æ—¶ä¼šæ‰§è¡Œè¯¥çº¿ç¨‹çš„ run() æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyThread</span> <span class="variable">mt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">    mt.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®ç°æ¥å£-VS-ç»§æ‰¿-Thread"><a href="#å®ç°æ¥å£-VS-ç»§æ‰¿-Thread" class="headerlink" title="å®ç°æ¥å£ VS ç»§æ‰¿ Thread"></a>å®ç°æ¥å£ VS ç»§æ‰¿ Thread</h3><p>å®ç°æ¥å£ä¼šæ›´å¥½ä¸€äº›ï¼Œå› ä¸ºï¼š</p><ul><li>Java ä¸æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå› æ­¤ç»§æ‰¿äº† Thread ç±»å°±æ— æ³•ç»§æ‰¿å…¶å®ƒç±»ï¼Œä½†æ˜¯å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼›</li><li>ç±»å¯èƒ½åªè¦æ±‚å¯æ‰§è¡Œå°±è¡Œï¼Œç»§æ‰¿æ•´ä¸ª Thread ç±»å¼€é”€è¿‡å¤§ã€‚</li></ul><h2 id="äºŒã€åŸºç¡€çº¿ç¨‹æœºåˆ¶"><a href="#äºŒã€åŸºç¡€çº¿ç¨‹æœºåˆ¶" class="headerlink" title="äºŒã€åŸºç¡€çº¿ç¨‹æœºåˆ¶"></a>äºŒã€åŸºç¡€çº¿ç¨‹æœºåˆ¶</h2><h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>Executor ç®¡ç†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œè€Œæ— éœ€ç¨‹åºå‘˜æ˜¾å¼åœ°ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™é‡Œçš„å¼‚æ­¥æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œäº’ä¸å¹²æ‰°ï¼Œä¸éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œã€‚</p><p>ä¸»è¦æœ‰ä¸‰ç§ Executorï¼š</p><ul><li>CachedThreadPoolï¼šä¸€ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼›</li><li>FixedThreadPoolï¼šæ‰€æœ‰ä»»åŠ¡åªèƒ½ä½¿ç”¨å›ºå®šå¤§å°çš„çº¿ç¨‹ï¼›</li><li>SingleThreadExecutorï¼šç›¸å½“äºå¤§å°ä¸º 1 çš„ FixedThreadPoolã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        executorService.execute(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Daemon"><a href="#Daemon" class="headerlink" title="Daemon"></a>Daemon</h3><p>å®ˆæŠ¤çº¿ç¨‹æ˜¯ç¨‹åºè¿è¡Œæ—¶åœ¨åå°æä¾›æœåŠ¡çš„çº¿ç¨‹ï¼Œä¸å±äºç¨‹åºä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚</p><p>å½“æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿå°±ç»ˆæ­¢ï¼ŒåŒæ—¶ä¼šæ€æ­»æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹ã€‚</p><p>main() å±äºéå®ˆæŠ¤çº¿ç¨‹ã€‚</p><p>åœ¨çº¿ç¨‹å¯åŠ¨ä¹‹å‰ä½¿ç”¨ setDaemon() æ–¹æ³•å¯ä»¥å°†ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>());</span><br><span class="line">    thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h3><p>Thread.sleep(millisec) æ–¹æ³•ä¼šä¼‘çœ å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œmillisec å•ä½ä¸ºæ¯«ç§’ã€‚</p><p>sleep() å¯èƒ½ä¼šæŠ›å‡º InterruptedExceptionï¼Œå› ä¸ºå¼‚å¸¸ä¸èƒ½è·¨çº¿ç¨‹ä¼ æ’­å› main() ä¸­ï¼Œå› æ­¤å¿…é¡»åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†ã€‚çº¿ç¨‹ä¸­æŠ›å‡ºçš„å…¶å®ƒå¼‚å¸¸ä¹ŸåŒæ ·éœ€è¦åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="yield"><a href="#yield" class="headerlink" title="yield()"></a>yield()</h3><p>å¯¹é™æ€æ–¹æ³• Thread.yield() çš„è°ƒç”¨å£°æ˜äº†å½“å‰çº¿ç¨‹å·²ç»å®Œæˆäº†ç”Ÿå‘½å‘¨æœŸä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå¯ä»¥åˆ‡æ¢ç»™å…¶å®ƒçº¿ç¨‹æ¥æ‰§è¡Œã€‚è¯¥æ–¹æ³•åªæ˜¯å¯¹çº¿ç¨‹è°ƒåº¦å™¨çš„ä¸€ä¸ªå»ºè®®ï¼Œè€Œä¸”ä¹Ÿåªæ˜¯å»ºè®®å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å…¶å®ƒçº¿ç¨‹å¯ä»¥è¿è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    Thread.<span class="keyword">yield</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸­æ–­"><a href="#ä¸‰ã€ä¸­æ–­" class="headerlink" title="ä¸‰ã€ä¸­æ–­"></a>ä¸‰ã€ä¸­æ–­</h2><p>ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šè‡ªåŠ¨ç»“æŸï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šæå‰ç»“æŸã€‚</p><h3 id="InterruptedException"><a href="#InterruptedException" class="headerlink" title="InterruptedException"></a>InterruptedException</h3><p>é€šè¿‡è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„ interrupt() æ¥ä¸­æ–­è¯¥çº¿ç¨‹ï¼Œå¦‚æœè¯¥çº¿ç¨‹å¤„äºé˜»å¡ã€é™æœŸç­‰å¾…æˆ–è€…æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸè¯¥çº¿ç¨‹ã€‚ä½†æ˜¯ä¸èƒ½ä¸­æ–­ I/O é˜»å¡å’Œ synchronized é”é˜»å¡ã€‚</p><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œåœ¨ main() ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹åå†ä¸­æ–­å®ƒï¼Œç”±äºçº¿ç¨‹ä¸­è°ƒç”¨äº† Thread.sleep() æ–¹æ³•ï¼Œå› æ­¤ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸçº¿ç¨‹ï¼Œä¸æ‰§è¡Œä¹‹åçš„è¯­å¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterruptExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread1</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread run&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread1</span>();</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread1.interrupt();</span><br><span class="line">    System.out.println(<span class="string">&quot;Main run&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Main run</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">    at java.lang.Thread.sleep(Native Method)</span><br><span class="line">    at InterruptExample.lambda$main$0(InterruptExample.java:5)</span><br><span class="line">    at InterruptExample$$Lambda$1/713338599.run(Unknown Source)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure><h3 id="interrupted"><a href="#interrupted" class="headerlink" title="interrupted()"></a>interrupted()</h3><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹çš„ run() æ–¹æ³•æ‰§è¡Œä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰§è¡Œ sleep() ç­‰ä¼šæŠ›å‡º InterruptedException çš„æ“ä½œï¼Œé‚£ä¹ˆè°ƒç”¨çº¿ç¨‹çš„ interrupt() æ–¹æ³•å°±æ— æ³•ä½¿çº¿ç¨‹æå‰ç»“æŸã€‚</p><p>ä½†æ˜¯è°ƒç”¨ interrupt() æ–¹æ³•ä¼šè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ï¼Œæ­¤æ—¶è°ƒç”¨ interrupted() æ–¹æ³•ä¼šè¿”å› trueã€‚å› æ­¤å¯ä»¥åœ¨å¾ªç¯ä½“ä¸­ä½¿ç”¨ interrupted() æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼Œä»è€Œæå‰ç»“æŸçº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterruptExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread2</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!interrupted()) &#123;</span><br><span class="line">                <span class="comment">// ..</span></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread end&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread2</span>();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread end</span><br></pre></td></tr></table></figure><h3 id="Executor-çš„ä¸­æ–­æ“ä½œ"><a href="#Executor-çš„ä¸­æ–­æ“ä½œ" class="headerlink" title="Executor çš„ä¸­æ–­æ“ä½œ"></a>Executor çš„ä¸­æ–­æ“ä½œ</h3><p>è°ƒç”¨ Executor çš„ shutdown() æ–¹æ³•ä¼šç­‰å¾…çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åå†å…³é—­ï¼Œä½†æ˜¯å¦‚æœè°ƒç”¨çš„æ˜¯ shutdownNow() æ–¹æ³•ï¼Œåˆ™ç›¸å½“äºè°ƒç”¨æ¯ä¸ªçº¿ç¨‹çš„ interrupt() æ–¹æ³•ã€‚</p><p>ä»¥ä¸‹ä½¿ç”¨ Lambda åˆ›å»ºçº¿ç¨‹ï¼Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread run&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    executorService.shutdownNow();</span><br><span class="line">    System.out.println(<span class="string">&quot;Main run&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Main run</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">    at java.lang.Thread.sleep(Native Method)</span><br><span class="line">    at ExecutorInterruptExample.lambda$main$0(ExecutorInterruptExample.java:9)</span><br><span class="line">    at ExecutorInterruptExample$$Lambda$1/1160460865.run(Unknown Source)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæƒ³ä¸­æ–­ Executor ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ submit() æ–¹æ³•æ¥æäº¤ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª Future\&lt;?> å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„ cancel(true) æ–¹æ³•å°±å¯ä»¥ä¸­æ–­çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;?&gt; future = executorService.submit(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;);</span><br><span class="line">future.cancel(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="å››ã€äº’æ–¥åŒæ­¥"><a href="#å››ã€äº’æ–¥åŒæ­¥" class="headerlink" title="å››ã€äº’æ–¥åŒæ­¥"></a>å››ã€äº’æ–¥åŒæ­¥</h2><p>Java æä¾›äº†ä¸¤ç§é”æœºåˆ¶æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ï¼Œç¬¬ä¸€ä¸ªæ˜¯ JVM å®ç°çš„ synchronizedï¼Œè€Œå¦ä¸€ä¸ªæ˜¯ JDK å®ç°çš„ ReentrantLockã€‚</p><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p><strong>1. åŒæ­¥ä¸€ä¸ªä»£ç å—</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒåªä½œç”¨äºåŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœè°ƒç”¨ä¸¤ä¸ªå¯¹è±¡ä¸Šçš„åŒæ­¥ä»£ç å—ï¼Œå°±ä¸ä¼šè¿›è¡ŒåŒæ­¥ã€‚</p><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œä½¿ç”¨ ExecutorService æ‰§è¡Œäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œç”±äºè°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„åŒæ­¥ä»£ç å—ï¼Œå› æ­¤è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼šè¿›è¡ŒåŒæ­¥ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åŒæ­¥è¯­å¥å—æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±å¿…é¡»ç­‰å¾…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                System.out.print(i + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SynchronizedExample</span> <span class="variable">e1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedExample</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; e1.func1());</span><br><span class="line">    executorService.execute(() -&gt; e1.func1());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸åŒå¯¹è±¡çš„åŒæ­¥ä»£ç å—ï¼Œå› æ­¤è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¸éœ€è¦åŒæ­¥ã€‚ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¸¤ä¸ªçº¿ç¨‹äº¤å‰æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SynchronizedExample</span> <span class="variable">e1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedExample</span>();</span><br><span class="line">    <span class="type">SynchronizedExample</span> <span class="variable">e2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedExample</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; e1.func1());</span><br><span class="line">    executorService.execute(() -&gt; e2.func1());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9</span><br></pre></td></tr></table></figure><p><strong>2. åŒæ­¥ä¸€ä¸ªæ–¹æ³•</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">func</span> <span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒå’ŒåŒæ­¥ä»£ç å—ä¸€æ ·ï¼Œä½œç”¨äºåŒä¸€ä¸ªå¯¹è±¡ã€‚</p><p><strong>3. åŒæ­¥ä¸€ä¸ªç±»</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (SynchronizedExample.class) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œç”¨äºæ•´ä¸ªç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡ä¸Šçš„è¿™ç§åŒæ­¥è¯­å¥ï¼Œä¹Ÿä¼šè¿›è¡ŒåŒæ­¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SynchronizedExample.class) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                System.out.print(i + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SynchronizedExample</span> <span class="variable">e1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedExample</span>();</span><br><span class="line">    <span class="type">SynchronizedExample</span> <span class="variable">e2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronizedExample</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; e1.func2());</span><br><span class="line">    executorService.execute(() -&gt; e2.func2());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><p><strong>4. åŒæ­¥ä¸€ä¸ªé™æ€æ–¹æ³•</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fun</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œç”¨äºæ•´ä¸ªç±»ã€‚</p><h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>ReentrantLock æ˜¯ java.util.concurrentï¼ˆJ.U.Cï¼‰åŒ…ä¸­çš„é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                System.out.print(i + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// ç¡®ä¿é‡Šæ”¾é”ï¼Œä»è€Œé¿å…å‘ç”Ÿæ­»é”ã€‚</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">LockExample</span> <span class="variable">lockExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LockExample</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; lockExample.func());</span><br><span class="line">    executorService.execute(() -&gt; lockExample.func());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><h3 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h3><p><strong>1. é”çš„å®ç°</strong>  </p><p>synchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„ã€‚</p><p><strong>2. æ€§èƒ½</strong>  </p><p>æ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä¾‹å¦‚è‡ªæ—‹é”ç­‰ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒã€‚</p><p><strong>3. ç­‰å¾…å¯ä¸­æ–­</strong>  </p><p>å½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚</p><p>ReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œã€‚</p><p><strong>4. å…¬å¹³é”</strong>  </p><p>å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ã€‚</p><p>synchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„ï¼ŒReentrantLock é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯å…¬å¹³çš„ã€‚</p><p><strong>5. é”ç»‘å®šå¤šä¸ªæ¡ä»¶</strong>  </p><p>ä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ã€‚</p><h3 id="ä½¿ç”¨é€‰æ‹©"><a href="#ä½¿ç”¨é€‰æ‹©" class="headerlink" title="ä½¿ç”¨é€‰æ‹©"></a>ä½¿ç”¨é€‰æ‹©</h3><p>é™¤ééœ€è¦ä½¿ç”¨ ReentrantLock çš„é«˜çº§åŠŸèƒ½ï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨ synchronizedã€‚è¿™æ˜¯å› ä¸º synchronized æ˜¯ JVM å®ç°çš„ä¸€ç§é”æœºåˆ¶ï¼ŒJVM åŸç”Ÿåœ°æ”¯æŒå®ƒï¼Œè€Œ ReentrantLock ä¸æ˜¯æ‰€æœ‰çš„ JDK ç‰ˆæœ¬éƒ½æ”¯æŒã€‚å¹¶ä¸”ä½¿ç”¨ synchronized ä¸ç”¨æ‹…å¿ƒæ²¡æœ‰é‡Šæ”¾é”è€Œå¯¼è‡´æ­»é”é—®é¢˜ï¼Œå› ä¸º JVM ä¼šç¡®ä¿é”çš„é‡Šæ”¾ã€‚</p><h2 id="äº”ã€çº¿ç¨‹ä¹‹é—´çš„åä½œ"><a href="#äº”ã€çº¿ç¨‹ä¹‹é—´çš„åä½œ" class="headerlink" title="äº”ã€çº¿ç¨‹ä¹‹é—´çš„åä½œ"></a>äº”ã€çº¿ç¨‹ä¹‹é—´çš„åä½œ</h2><p>å½“å¤šä¸ªçº¿ç¨‹å¯ä»¥ä¸€èµ·å·¥ä½œå»è§£å†³æŸä¸ªé—®é¢˜æ—¶ï¼Œå¦‚æœæŸäº›éƒ¨åˆ†å¿…é¡»åœ¨å…¶å®ƒéƒ¨åˆ†ä¹‹å‰å®Œæˆï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œåè°ƒã€‚</p><h3 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h3><p>åœ¨çº¿ç¨‹ä¸­è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œè€Œä¸æ˜¯å¿™ç­‰å¾…ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹ç»“æŸã€‚</p><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œè™½ç„¶ b çº¿ç¨‹å…ˆå¯åŠ¨ï¼Œä½†æ˜¯å› ä¸ºåœ¨ b çº¿ç¨‹ä¸­è°ƒç”¨äº† a çº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œb çº¿ç¨‹ä¼šç­‰å¾… a çº¿ç¨‹ç»“æŸæ‰ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤æœ€åèƒ½å¤Ÿä¿è¯ a çº¿ç¨‹çš„è¾“å‡ºå…ˆäº b çº¿ç¨‹çš„è¾“å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JoinExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> A a;</span><br><span class="line"></span><br><span class="line">        B(A a) &#123;</span><br><span class="line">            <span class="built_in">this</span>.a = a;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                a.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>(a);</span><br><span class="line">        b.start();</span><br><span class="line">        a.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">JoinExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JoinExample</span>();</span><br><span class="line">    example.test();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br></pre></td></tr></table></figure><h3 id="wait-notify-notifyAll"><a href="#wait-notify-notifyAll" class="headerlink" title="wait() notify() notifyAll()"></a>wait() notify() notifyAll()</h3><p>è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚</p><p>å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚</p><p>åªèƒ½ç”¨åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥æ§åˆ¶å—ä¸­ä½¿ç”¨ï¼Œå¦åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡º IllegalMonitorStateExceptionã€‚</p><p>ä½¿ç”¨ wait() æŒ‚èµ·æœŸé—´ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾é”ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾é”ï¼Œé‚£ä¹ˆå…¶å®ƒçº¿ç¨‹å°±æ— æ³•è¿›å…¥å¯¹è±¡çš„åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥æ§åˆ¶å—ä¸­ï¼Œé‚£ä¹ˆå°±æ— æ³•æ‰§è¡Œ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ï¼Œé€ æˆæ­»é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WaitNotifyExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="type">WaitNotifyExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WaitNotifyExample</span>();</span><br><span class="line">    executorService.execute(() -&gt; example.after());</span><br><span class="line">    executorService.execute(() -&gt; example.before());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">before</span><br><span class="line">after</span><br></pre></td></tr></table></figure><p><strong>wait() å’Œ sleep() çš„åŒºåˆ«</strong>  </p><ul><li>wait() æ˜¯ Object çš„æ–¹æ³•ï¼Œè€Œ sleep() æ˜¯ Thread çš„é™æ€æ–¹æ³•ï¼›</li><li>wait() ä¼šé‡Šæ”¾é”ï¼Œsleep() ä¸ä¼šã€‚</li></ul><h3 id="await-signal-signalAll"><a href="#await-signal-signalAll" class="headerlink" title="await() signal() signalAll()"></a>await() signal() signalAll()</h3><p>java.util.concurrent ç±»åº“ä¸­æä¾›äº† Condition ç±»æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åè°ƒï¼Œå¯ä»¥åœ¨ Condition ä¸Šè°ƒç”¨ await() æ–¹æ³•ä½¿çº¿ç¨‹ç­‰å¾…ï¼Œå…¶å®ƒçº¿ç¨‹è°ƒç”¨ signal() æˆ– signalAll() æ–¹æ³•å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚</p><p>ç›¸æ¯”äº wait() è¿™ç§ç­‰å¾…æ–¹å¼ï¼Œawait() å¯ä»¥æŒ‡å®šç­‰å¾…çš„æ¡ä»¶ï¼Œå› æ­¤æ›´åŠ çµæ´»ã€‚</p><p>ä½¿ç”¨ Lock æ¥è·å–ä¸€ä¸ª Condition å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwaitSignalExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            condition.await();</span><br><span class="line">            System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="type">AwaitSignalExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignalExample</span>();</span><br><span class="line">    executorService.execute(() -&gt; example.after());</span><br><span class="line">    executorService.execute(() -&gt; example.before());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">before</span><br><span class="line">after</span><br></pre></td></tr></table></figure><h2 id="å…­ã€çº¿ç¨‹çŠ¶æ€"><a href="#å…­ã€çº¿ç¨‹çŠ¶æ€" class="headerlink" title="å…­ã€çº¿ç¨‹çŠ¶æ€"></a>å…­ã€çº¿ç¨‹çŠ¶æ€</h2><p>ä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„äºä¸€ç§çŠ¶æ€ï¼Œå¹¶ä¸”è¿™é‡Œçš„çº¿ç¨‹çŠ¶æ€ç‰¹æŒ‡ Java è™šæ‹Ÿæœºçš„çº¿ç¨‹çŠ¶æ€ï¼Œä¸èƒ½åæ˜ çº¿ç¨‹åœ¨ç‰¹å®šæ“ä½œç³»ç»Ÿä¸‹çš„çŠ¶æ€ã€‚</p><h3 id="æ–°å»ºï¼ˆNEWï¼‰"><a href="#æ–°å»ºï¼ˆNEWï¼‰" class="headerlink" title="æ–°å»ºï¼ˆNEWï¼‰"></a>æ–°å»ºï¼ˆNEWï¼‰</h3><p>åˆ›å»ºåå°šæœªå¯åŠ¨ã€‚</p><h3 id="å¯è¿è¡Œï¼ˆRUNABLEï¼‰"><a href="#å¯è¿è¡Œï¼ˆRUNABLEï¼‰" class="headerlink" title="å¯è¿è¡Œï¼ˆRUNABLEï¼‰"></a>å¯è¿è¡Œï¼ˆRUNABLEï¼‰</h3><p>æ­£åœ¨ Java è™šæ‹Ÿæœºä¸­è¿è¡Œã€‚ä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œå®ƒå¯èƒ½å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå¯èƒ½ç­‰å¾…èµ„æºè°ƒåº¦ï¼ˆä¾‹å¦‚å¤„ç†å™¨èµ„æºï¼‰ï¼Œèµ„æºè°ƒåº¦å®Œæˆå°±è¿›å…¥è¿è¡ŒçŠ¶æ€ã€‚æ‰€ä»¥è¯¥çŠ¶æ€çš„å¯è¿è¡Œæ˜¯æŒ‡å¯ä»¥è¢«è¿è¡Œï¼Œå…·ä½“æœ‰æ²¡æœ‰è¿è¡Œè¦çœ‹åº•å±‚æ“ä½œç³»ç»Ÿçš„èµ„æºè°ƒåº¦ã€‚</p><h3 id="é˜»å¡ï¼ˆBLOCKEDï¼‰"><a href="#é˜»å¡ï¼ˆBLOCKEDï¼‰" class="headerlink" title="é˜»å¡ï¼ˆBLOCKEDï¼‰"></a>é˜»å¡ï¼ˆBLOCKEDï¼‰</h3><p>è¯·æ±‚è·å– monitor lock ä»è€Œè¿›å…¥ synchronized å‡½æ•°æˆ–è€…ä»£ç å—ï¼Œä½†æ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»å ç”¨äº†è¯¥ monitor lockï¼Œæ‰€ä»¥å‡ºäºé˜»å¡çŠ¶æ€ã€‚è¦ç»“æŸè¯¥çŠ¶æ€è¿›å…¥ä»è€Œ RUNABLE éœ€è¦å…¶ä»–çº¿ç¨‹é‡Šæ”¾ monitor lockã€‚</p><h3 id="æ— é™æœŸç­‰å¾…ï¼ˆWAITINGï¼‰"><a href="#æ— é™æœŸç­‰å¾…ï¼ˆWAITINGï¼‰" class="headerlink" title="æ— é™æœŸç­‰å¾…ï¼ˆWAITINGï¼‰"></a>æ— é™æœŸç­‰å¾…ï¼ˆWAITINGï¼‰</h3><p>ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ã€‚</p><p>é˜»å¡å’Œç­‰å¾…çš„åŒºåˆ«åœ¨äºï¼Œé˜»å¡æ˜¯è¢«åŠ¨çš„ï¼Œå®ƒæ˜¯åœ¨ç­‰å¾…è·å– monitor lockã€‚è€Œç­‰å¾…æ˜¯ä¸»åŠ¨çš„ï¼Œé€šè¿‡è°ƒç”¨  Object.wait() ç­‰æ–¹æ³•è¿›å…¥ã€‚</p><div class="table-container"><table><thead><tr><th>è¿›å…¥æ–¹æ³•</th><th>é€€å‡ºæ–¹æ³•</th></tr></thead><tbody><tr><td>æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Object.wait() æ–¹æ³•</td><td>Object.notify() / Object.notifyAll()</td></tr><tr><td>æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Thread.join() æ–¹æ³•</td><td>è¢«è°ƒç”¨çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</td></tr><tr><td>LockSupport.park() æ–¹æ³•</td><td>LockSupport.unpark(Thread)</td></tr></tbody></table></div><h3 id="é™æœŸç­‰å¾…ï¼ˆTIMED-WAITINGï¼‰"><a href="#é™æœŸç­‰å¾…ï¼ˆTIMED-WAITINGï¼‰" class="headerlink" title="é™æœŸç­‰å¾…ï¼ˆTIMED_WAITINGï¼‰"></a>é™æœŸç­‰å¾…ï¼ˆTIMED_WAITINGï¼‰</h3><p>æ— éœ€ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ï¼Œåœ¨ä¸€å®šæ—¶é—´ä¹‹åä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å”¤é†’ã€‚</p><div class="table-container"><table><thead><tr><th>è¿›å…¥æ–¹æ³•</th><th>é€€å‡ºæ–¹æ³•</th></tr></thead><tbody><tr><td>Thread.sleep() æ–¹æ³•</td><td>æ—¶é—´ç»“æŸ</td></tr><tr><td>è®¾ç½®äº† Timeout å‚æ•°çš„ Object.wait() æ–¹æ³•</td><td>æ—¶é—´ç»“æŸ / Object.notify() / Object.notifyAll()</td></tr><tr><td>è®¾ç½®äº† Timeout å‚æ•°çš„ Thread.join() æ–¹æ³•</td><td>æ—¶é—´ç»“æŸ / è¢«è°ƒç”¨çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</td></tr><tr><td>LockSupport.parkNanos() æ–¹æ³•</td><td>LockSupport.unpark(Thread)</td></tr><tr><td>LockSupport.parkUntil() æ–¹æ³•</td><td>LockSupport.unpark(Thread)</td></tr></tbody></table></div><p>è°ƒç”¨ Thread.sleep() æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…çŠ¶æ€æ—¶ï¼Œå¸¸å¸¸ç”¨â€œä½¿ä¸€ä¸ªçº¿ç¨‹ç¡çœ â€è¿›è¡Œæè¿°ã€‚è°ƒç”¨ Object.wait() æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…æˆ–è€…æ— é™æœŸç­‰å¾…æ—¶ï¼Œå¸¸å¸¸ç”¨â€œæŒ‚èµ·ä¸€ä¸ªçº¿ç¨‹â€è¿›è¡Œæè¿°ã€‚ç¡çœ å’ŒæŒ‚èµ·æ˜¯ç”¨æ¥æè¿°è¡Œä¸ºï¼Œè€Œé˜»å¡å’Œç­‰å¾…ç”¨æ¥æè¿°çŠ¶æ€ã€‚</p><h3 id="æ­»äº¡ï¼ˆTERMINATEDï¼‰"><a href="#æ­»äº¡ï¼ˆTERMINATEDï¼‰" class="headerlink" title="æ­»äº¡ï¼ˆTERMINATEDï¼‰"></a>æ­»äº¡ï¼ˆTERMINATEDï¼‰</h3><p>å¯ä»¥æ˜¯çº¿ç¨‹ç»“æŸä»»åŠ¡ä¹‹åè‡ªå·±ç»“æŸï¼Œæˆ–è€…äº§ç”Ÿäº†å¼‚å¸¸è€Œç»“æŸã€‚</p><p><a href="https://docs.oracle.com/javase/9/docs/api/java/lang/Thread.State.html">Java SE 9 Enum Thread.State</a></p><h2 id="ä¸ƒã€J-U-C-AQS"><a href="#ä¸ƒã€J-U-C-AQS" class="headerlink" title="ä¸ƒã€J.U.C - AQS"></a>ä¸ƒã€J.U.C - AQS</h2><p>java.util.concurrentï¼ˆJ.U.Cï¼‰å¤§å¤§æé«˜äº†å¹¶å‘æ€§èƒ½ï¼ŒAQS è¢«è®¤ä¸ºæ˜¯ J.U.C çš„æ ¸å¿ƒã€‚</p><h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><p>ç”¨æ¥æ§åˆ¶ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ç­‰å¾…å¤šä¸ªçº¿ç¨‹ã€‚</p><p>ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ cntï¼Œæ¯æ¬¡è°ƒç”¨ countDown() æ–¹æ³•ä¼šè®©è®¡æ•°å™¨çš„å€¼å‡ 1ï¼Œå‡åˆ° 0 çš„æ—¶å€™ï¼Œé‚£äº›å› ä¸ºè°ƒç”¨ await() æ–¹æ³•è€Œåœ¨ç­‰å¾…çš„çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ba078291-791e-4378-b6d1-ece76c2f0b14.png" width="300px"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountdownLatchExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">totalThread</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(totalThread);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalThread; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;run..&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run..run..run..run..run..run..run..run..run..run..end</span><br></pre></td></tr></table></figure><h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><p>ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œåªæœ‰å½“å¤šä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾æ—¶ï¼Œè¿™äº›çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p><p>å’Œ CountdownLatch ç›¸ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ç»´æŠ¤è®¡æ•°å™¨æ¥å®ç°çš„ã€‚çº¿ç¨‹æ‰§è¡Œ await() æ–¹æ³•ä¹‹åè®¡æ•°å™¨ä¼šå‡ 1ï¼Œå¹¶è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0ï¼Œæ‰€æœ‰è°ƒç”¨ await() æ–¹æ³•è€Œåœ¨ç­‰å¾…çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>CyclicBarrier å’Œ CountdownLatch çš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼ŒCyclicBarrier çš„è®¡æ•°å™¨é€šè¿‡è°ƒç”¨ reset() æ–¹æ³•å¯ä»¥å¾ªç¯ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ‰å«åšå¾ªç¯å±éšœã€‚</p><p>CyclicBarrier æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ parties æŒ‡ç¤ºè®¡æ•°å™¨çš„åˆå§‹å€¼ï¼ŒbarrierAction åœ¨æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœçš„æ—¶å€™ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrier</span><span class="params">(<span class="type">int</span> parties, Runnable barrierAction)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="built_in">this</span>.parties = parties;</span><br><span class="line">    <span class="built_in">this</span>.count = parties;</span><br><span class="line">    <span class="built_in">this</span>.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrier</span><span class="params">(<span class="type">int</span> parties)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(parties, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f71af66b-0d54-4399-a44b-f47b58321984.png" width="300px"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CyclicBarrierExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">totalThread</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">cyclicBarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(totalThread);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalThread; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;before..&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cyclicBarrier.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(<span class="string">&quot;after..&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">before..before..before..before..before..before..before..before..before..before..after..after..after..after..after..after..after..after..after..after..</span><br></pre></td></tr></table></figure><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>Semaphore ç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­çš„ä¿¡å·é‡ï¼Œå¯ä»¥æ§åˆ¶å¯¹äº’æ–¥èµ„æºçš„è®¿é—®çº¿ç¨‹æ•°ã€‚</p><p>ä»¥ä¸‹ä»£ç æ¨¡æ‹Ÿäº†å¯¹æŸä¸ªæœåŠ¡çš„å¹¶å‘è¯·æ±‚ï¼Œæ¯æ¬¡åªèƒ½æœ‰ 3 ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®ï¼Œè¯·æ±‚æ€»æ•°ä¸º 10ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">clientCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">totalRequestCount</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(clientCount);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalRequestCount; i++) &#123;</span><br><span class="line">            executorService.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    System.out.print(semaphore.availablePermits() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 1 2 2 2 2 2 1 2 2</span><br></pre></td></tr></table></figure><h2 id="å…«ã€J-U-C-å…¶å®ƒç»„ä»¶"><a href="#å…«ã€J-U-C-å…¶å®ƒç»„ä»¶" class="headerlink" title="å…«ã€J.U.C - å…¶å®ƒç»„ä»¶"></a>å…«ã€J.U.C - å…¶å®ƒç»„ä»¶</h2><h3 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h3><p>åœ¨ä»‹ç» Callable æ—¶æˆ‘ä»¬çŸ¥é“å®ƒå¯ä»¥æœ‰è¿”å›å€¼ï¼Œè¿”å›å€¼é€šè¿‡ Future\<V\> è¿›è¡Œå°è£…ã€‚FutureTask å®ç°äº† RunnableFuture æ¥å£ï¼Œè¯¥æ¥å£ç»§æ‰¿è‡ª Runnable å’Œ Future\<V\> æ¥å£ï¼Œè¿™ä½¿å¾— FutureTask æ—¢å¯ä»¥å½“åšä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥æœ‰è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTask</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">RunnableFuture</span>&lt;V&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Runnable</span>, Future&lt;V&gt;</span><br></pre></td></tr></table></figure><p>FutureTask å¯ç”¨äºå¼‚æ­¥è·å–æ‰§è¡Œç»“æœæˆ–å–æ¶ˆæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚å½“ä¸€ä¸ªè®¡ç®—ä»»åŠ¡éœ€è¦æ‰§è¡Œå¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ FutureTask æ¥å°è£…è¿™ä¸ªä»»åŠ¡ï¼Œä¸»çº¿ç¨‹åœ¨å®Œæˆè‡ªå·±çš„ä»»åŠ¡ä¹‹åå†å»è·å–ç»“æœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTaskExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        FutureTask&lt;Integer&gt; futureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;Integer&gt;(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                    result += i;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">computeThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(futureTask);</span><br><span class="line">        computeThread.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">otherThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;other task is running...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        otherThread.start();</span><br><span class="line">        System.out.println(futureTask.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">other task is running...</span><br><span class="line">4950</span><br></pre></td></tr></table></figure><h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>java.util.concurrent.BlockingQueue æ¥å£æœ‰ä»¥ä¸‹é˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼š</p><ul><li><strong>FIFO é˜Ÿåˆ—</strong>  ï¼šLinkedBlockingQueueã€ArrayBlockingQueueï¼ˆå›ºå®šé•¿åº¦ï¼‰</li><li><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>  ï¼šPriorityBlockingQueue</li></ul><p>æä¾›äº†é˜»å¡çš„ take() å’Œ put() æ–¹æ³•ï¼šå¦‚æœé˜Ÿåˆ—ä¸ºç©º take() å°†é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å†…å®¹ï¼›å¦‚æœé˜Ÿåˆ—ä¸ºæ»¡ put() å°†é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—²ä½ç½®ã€‚</p><p><strong>ä½¿ç”¨ BlockingQueue å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                queue.put(<span class="string">&quot;product&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(<span class="string">&quot;produce..&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">product</span> <span class="operator">=</span> queue.take();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(<span class="string">&quot;consume..&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line">        producer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>();</span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line">        producer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">produce..produce..consume..consume..produce..consume..produce..consume..produce..consume..</span><br></pre></td></tr></table></figure><h3 id="ForkJoin"><a href="#ForkJoin" class="headerlink" title="ForkJoin"></a>ForkJoin</h3><p>ä¸»è¦ç”¨äºå¹¶è¡Œè®¡ç®—ä¸­ï¼Œå’Œ MapReduce åŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯æŠŠå¤§çš„è®¡ç®—ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œè®¡ç®—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForkJoinExample</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> first;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> last;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ForkJoinExample</span><span class="params">(<span class="type">int</span> first, <span class="type">int</span> last)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.first = first;</span><br><span class="line">        <span class="built_in">this</span>.last = last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (last - first &lt;= threshold) &#123;</span><br><span class="line">            <span class="comment">// ä»»åŠ¡è¶³å¤Ÿå°åˆ™ç›´æ¥è®¡ç®—</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> first; i &lt;= last; i++) &#123;</span><br><span class="line">                result += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ‹†åˆ†æˆå°ä»»åŠ¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">middle</span> <span class="operator">=</span> first + (last - first) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">ForkJoinExample</span> <span class="variable">leftTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinExample</span>(first, middle);</span><br><span class="line">            <span class="type">ForkJoinExample</span> <span class="variable">rightTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinExample</span>(middle + <span class="number">1</span>, last);</span><br><span class="line">            leftTask.fork();</span><br><span class="line">            rightTask.fork();</span><br><span class="line">            result = leftTask.join() + rightTask.join();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ForkJoinExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinExample</span>(<span class="number">1</span>, <span class="number">10000</span>);</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">    <span class="type">Future</span> <span class="variable">result</span> <span class="operator">=</span> forkJoinPool.submit(example);</span><br><span class="line">    System.out.println(result.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ForkJoin ä½¿ç”¨ ForkJoinPool æ¥å¯åŠ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡å–å†³äº CPU æ ¸æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForkJoinPool</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span></span><br></pre></td></tr></table></figure><p>ForkJoinPool å®ç°äº†å·¥ä½œçªƒå–ç®—æ³•æ¥æé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶å®ƒçº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚çªƒå–çš„ä»»åŠ¡å¿…é¡»æ˜¯æœ€æ™šçš„ä»»åŠ¡ï¼Œé¿å…å’Œé˜Ÿåˆ—æ‰€å±çº¿ç¨‹å‘ç”Ÿç«äº‰ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼ŒThread2 ä» Thread1 çš„é˜Ÿåˆ—ä¸­æ‹¿å‡ºæœ€æ™šçš„ Task1 ä»»åŠ¡ï¼ŒThread1 ä¼šæ‹¿å‡º Task2 æ¥æ‰§è¡Œï¼Œè¿™æ ·å°±é¿å…å‘ç”Ÿç«äº‰ã€‚ä½†æ˜¯å¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶è¿˜æ˜¯ä¼šå‘ç”Ÿç«äº‰ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e42f188f-f4a9-4e6f-88fc-45f4682072fb.png" width="300px"> </div><br></p><h2 id="ä¹ã€çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹"><a href="#ä¹ã€çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹" class="headerlink" title="ä¹ã€çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹"></a>ä¹ã€çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹</h2><p>å¦‚æœå¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«æ•°æ®è¿›è¡Œè®¿é—®è€Œä¸é‡‡å–åŒæ­¥æ“ä½œçš„è¯ï¼Œé‚£ä¹ˆæ“ä½œçš„ç»“æœæ˜¯ä¸ä¸€è‡´çš„ã€‚</p><p>ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº† 1000 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ cnt æ‰§è¡Œè‡ªå¢æ“ä½œï¼Œæ“ä½œç»“æŸä¹‹åå®ƒçš„å€¼æœ‰å¯èƒ½å°äº 1000ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadUnsafeExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        cnt++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">ThreadUnsafeExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadUnsafeExample</span>();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadSize);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadSize; i++) &#123;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            example.add();</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    System.out.println(example.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">997</span><br></pre></td></tr></table></figure><h2 id="åã€Java-å†…å­˜æ¨¡å‹"><a href="#åã€Java-å†…å­˜æ¨¡å‹" class="headerlink" title="åã€Java å†…å­˜æ¨¡å‹"></a>åã€Java å†…å­˜æ¨¡å‹</h2><p>Java å†…å­˜æ¨¡å‹è¯•å›¾å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®© Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚</p><h3 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"><a href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜" class="headerlink" title="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"></a>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h3><p>å¤„ç†å™¨ä¸Šçš„å¯„å­˜å™¨çš„è¯»å†™çš„é€Ÿåº¦æ¯”å†…å­˜å¿«å‡ ä¸ªæ•°é‡çº§ï¼Œä¸ºäº†è§£å†³è¿™ç§é€Ÿåº¦çŸ›ç›¾ï¼Œåœ¨å®ƒä»¬ä¹‹é—´åŠ å…¥äº†é«˜é€Ÿç¼“å­˜ã€‚</p><p>åŠ å…¥é«˜é€Ÿç¼“å­˜å¸¦æ¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§ã€‚å¦‚æœå¤šä¸ªç¼“å­˜å…±äº«åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆå¤šä¸ªç¼“å­˜çš„æ•°æ®å¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œéœ€è¦ä¸€äº›åè®®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/942ca0d2-9d5c-45a4-89cb-5fd89b61913f.png" width="600px"> </div><br></p><p>æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜å­˜å‚¨åœ¨é«˜é€Ÿç¼“å­˜æˆ–è€…å¯„å­˜å™¨ä¸­ï¼Œä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ã€‚</p><p>çº¿ç¨‹åªèƒ½ç›´æ¥æ“ä½œå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„å˜é‡å€¼ä¼ é€’éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/15851555-5abc-497d-ad34-efed10f43a6b.png" width="600px"> </div><br></p><h3 id="å†…å­˜é—´äº¤äº’æ“ä½œ"><a href="#å†…å­˜é—´äº¤äº’æ“ä½œ" class="headerlink" title="å†…å­˜é—´äº¤äº’æ“ä½œ"></a>å†…å­˜é—´äº¤äº’æ“ä½œ</h3><p>Java å†…å­˜æ¨¡å‹å®šä¹‰äº† 8 ä¸ªæ“ä½œæ¥å®Œæˆä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„äº¤äº’æ“ä½œã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8b7ebbad-9604-4375-84e3-f412099d170c.png" width="450px"> </div><br></p><ul><li>readï¼šæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜ä¸­</li><li>loadï¼šåœ¨ read ä¹‹åæ‰§è¡Œï¼ŒæŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­</li><li>useï¼šæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“</li><li>assignï¼šæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡</li><li>storeï¼šæŠŠå·¥ä½œå†…å­˜çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­</li><li>writeï¼šåœ¨ store ä¹‹åæ‰§è¡Œï¼ŒæŠŠ store å¾—åˆ°çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­</li><li>lockï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡</li><li>unlock</li></ul><h3 id="å†…å­˜æ¨¡å‹ä¸‰å¤§ç‰¹æ€§"><a href="#å†…å­˜æ¨¡å‹ä¸‰å¤§ç‰¹æ€§" class="headerlink" title="å†…å­˜æ¨¡å‹ä¸‰å¤§ç‰¹æ€§"></a>å†…å­˜æ¨¡å‹ä¸‰å¤§ç‰¹æ€§</h3><h4 id="1-åŸå­æ€§"><a href="#1-åŸå­æ€§" class="headerlink" title="1. åŸå­æ€§"></a>1. åŸå­æ€§</h4><p>Java å†…å­˜æ¨¡å‹ä¿è¯äº† readã€loadã€useã€assignã€storeã€writeã€lock å’Œ unlock æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œä¾‹å¦‚å¯¹ä¸€ä¸ª int ç±»å‹çš„å˜é‡æ‰§è¡Œ assign èµ‹å€¼æ“ä½œï¼Œè¿™ä¸ªæ“ä½œå°±æ˜¯åŸå­æ€§çš„ã€‚ä½†æ˜¯ Java å†…å­˜æ¨¡å‹å…è®¸è™šæ‹Ÿæœºå°†æ²¡æœ‰è¢« volatile ä¿®é¥°çš„ 64 ä½æ•°æ®ï¼ˆlongï¼Œdoubleï¼‰çš„è¯»å†™æ“ä½œåˆ’åˆ†ä¸ºä¸¤æ¬¡ 32 ä½çš„æ“ä½œæ¥è¿›è¡Œï¼Œå³ loadã€storeã€read å’Œ write æ“ä½œå¯ä»¥ä¸å…·å¤‡åŸå­æ€§ã€‚</p><p>æœ‰ä¸€ä¸ªé”™è¯¯è®¤è¯†å°±æ˜¯ï¼Œint ç­‰åŸå­æ€§çš„ç±»å‹åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å‰é¢çš„çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œcnt å±äº int ç±»å‹å˜é‡ï¼Œ1000 ä¸ªçº¿ç¨‹å¯¹å®ƒè¿›è¡Œè‡ªå¢æ“ä½œä¹‹åï¼Œå¾—åˆ°çš„å€¼ä¸º 997 è€Œä¸æ˜¯ 1000ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿è®¨è®ºï¼Œå°†å†…å­˜é—´çš„äº¤äº’æ“ä½œç®€åŒ–ä¸º 3 ä¸ªï¼šloadã€assignã€storeã€‚</p><p>ä¸‹å›¾æ¼”ç¤ºäº†ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ cnt è¿›è¡Œæ“ä½œï¼Œloadã€assignã€store è¿™ä¸€ç³»åˆ—æ“ä½œæ•´ä½“ä¸Šçœ‹ä¸å…·å¤‡åŸå­æ€§ï¼Œé‚£ä¹ˆåœ¨ T1 ä¿®æ”¹ cnt å¹¶ä¸”è¿˜æ²¡æœ‰å°†ä¿®æ”¹åçš„å€¼å†™å…¥ä¸»å†…å­˜ï¼ŒT2 ä¾ç„¶å¯ä»¥è¯»å…¥æ—§å€¼ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹è™½ç„¶æ‰§è¡Œäº†ä¸¤æ¬¡è‡ªå¢è¿ç®—ï¼Œä½†æ˜¯ä¸»å†…å­˜ä¸­ cnt çš„å€¼æœ€åä¸º 1 è€Œä¸æ˜¯ 2ã€‚å› æ­¤å¯¹ int ç±»å‹è¯»å†™æ“ä½œæ»¡è¶³åŸå­æ€§åªæ˜¯è¯´æ˜ loadã€assignã€store è¿™äº›å•ä¸ªæ“ä½œå…·å¤‡åŸå­æ€§ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2797a609-68db-4d7b-8701-41ac9a34b14f.jpg" width="300px"> </div><br></p><p>AtomicInteger èƒ½ä¿è¯å¤šä¸ªçº¿ç¨‹ä¿®æ”¹çš„åŸå­æ€§ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/dd563037-fcaa-4bd8-83b6-b39d93a12c77.jpg" width="300px"> </div><br></p><p>ä½¿ç”¨ AtomicInteger é‡å†™ä¹‹å‰çº¿ç¨‹ä¸å®‰å…¨çš„ä»£ç ä¹‹åå¾—åˆ°ä»¥ä¸‹çº¿ç¨‹å®‰å…¨å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        cnt.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cnt.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">AtomicExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicExample</span>(); <span class="comment">// åªä¿®æ”¹è¿™æ¡è¯­å¥</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadSize);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadSize; i++) &#123;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            example.add();</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    System.out.println(example.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000</span><br></pre></td></tr></table></figure><p>é™¤äº†ä½¿ç”¨åŸå­ç±»ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ synchronized äº’æ–¥é”æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚å®ƒå¯¹åº”çš„å†…å­˜é—´äº¤äº’æ“ä½œä¸ºï¼šlock å’Œ unlockï¼Œåœ¨è™šæ‹Ÿæœºå®ç°ä¸Šå¯¹åº”çš„å­—èŠ‚ç æŒ‡ä»¤ä¸º monitorenter å’Œ monitorexitã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicSynchronizedExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        cnt++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">AtomicSynchronizedExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicSynchronizedExample</span>();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadSize);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadSize; i++) &#123;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            example.add();</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    System.out.println(example.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000</span><br></pre></td></tr></table></figure><h4 id="2-å¯è§æ€§"><a href="#2-å¯è§æ€§" class="headerlink" title="2. å¯è§æ€§"></a>2. å¯è§æ€§</h4><p>å¯è§æ€§æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚Java å†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼æ¥å®ç°å¯è§æ€§çš„ã€‚</p><p>ä¸»è¦æœ‰ä¸‰ç§å®ç°å¯è§æ€§çš„æ–¹å¼ï¼š</p><ul><li>volatile</li><li>synchronizedï¼Œå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»æŠŠå˜é‡å€¼åŒæ­¥å›ä¸»å†…å­˜ã€‚</li><li>finalï¼Œè¢« final å…³é”®å­—ä¿®é¥°çš„å­—æ®µåœ¨æ„é€ å™¨ä¸­ä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰å‘ç”Ÿ this é€ƒé€¸ï¼ˆå…¶å®ƒçº¿ç¨‹é€šè¿‡ this å¼•ç”¨è®¿é—®åˆ°åˆå§‹åŒ–äº†ä¸€åŠçš„å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆå…¶å®ƒçº¿ç¨‹å°±èƒ½çœ‹è§ final å­—æ®µçš„å€¼ã€‚</li></ul><p>å¯¹å‰é¢çš„çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹ä¸­çš„ cnt å˜é‡ä½¿ç”¨ volatile ä¿®é¥°ï¼Œä¸èƒ½è§£å†³çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼Œå› ä¸º volatile å¹¶ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚</p><h4 id="3-æœ‰åºæ€§"><a href="#3-æœ‰åºæ€§" class="headerlink" title="3. æœ‰åºæ€§"></a>3. æœ‰åºæ€§</h4><p>æœ‰åºæ€§æ˜¯æŒ‡ï¼šåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æœ‰åºçš„ã€‚åœ¨ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ï¼Œæ— åºæ˜¯å› ä¸ºå‘ç”Ÿäº†æŒ‡ä»¤é‡æ’åºã€‚åœ¨ Java å†…å­˜æ¨¡å‹ä¸­ï¼Œå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œé‡æ’åºè¿‡ç¨‹ä¸ä¼šå½±å“åˆ°å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œï¼Œå´ä¼šå½±å“åˆ°å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚</p><p>volatile å…³é”®å­—é€šè¿‡æ·»åŠ å†…å­˜å±éšœçš„æ–¹å¼æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œå³é‡æ’åºæ—¶ä¸èƒ½æŠŠåé¢çš„æŒ‡ä»¤æ”¾åˆ°å†…å­˜å±éšœä¹‹å‰ã€‚</p><p>ä¹Ÿå¯ä»¥é€šè¿‡ synchronized æ¥ä¿è¯æœ‰åºæ€§ï¼Œå®ƒä¿è¯æ¯ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ã€‚</p><h3 id="å…ˆè¡Œå‘ç”ŸåŸåˆ™"><a href="#å…ˆè¡Œå‘ç”ŸåŸåˆ™" class="headerlink" title="å…ˆè¡Œå‘ç”ŸåŸåˆ™"></a>å…ˆè¡Œå‘ç”ŸåŸåˆ™</h3><p>ä¸Šé¢æåˆ°äº†å¯ä»¥ç”¨ volatile å’Œ synchronized æ¥ä¿è¯æœ‰åºæ€§ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJVM è¿˜è§„å®šäº†å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼Œè®©ä¸€ä¸ªæ“ä½œæ— éœ€æ§åˆ¶å°±èƒ½å…ˆäºå¦ä¸€ä¸ªæ“ä½œå®Œæˆã€‚</p><h4 id="1-å•ä¸€çº¿ç¨‹åŸåˆ™"><a href="#1-å•ä¸€çº¿ç¨‹åŸåˆ™" class="headerlink" title="1. å•ä¸€çº¿ç¨‹åŸåˆ™"></a>1. å•ä¸€çº¿ç¨‹åŸåˆ™</h4><blockquote><p>Single Thread rule</p></blockquote><p>åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œåœ¨ç¨‹åºå‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„æ“ä½œã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/874b3ff7-7c5c-4e7a-b8ab-a82a3e038d20.png" width="180px"> </div><br></p><h4 id="2-ç®¡ç¨‹é”å®šè§„åˆ™"><a href="#2-ç®¡ç¨‹é”å®šè§„åˆ™" class="headerlink" title="2. ç®¡ç¨‹é”å®šè§„åˆ™"></a>2. ç®¡ç¨‹é”å®šè§„åˆ™</h4><blockquote><p>Monitor Lock Rule</p></blockquote><p>ä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8996a537-7c4a-4ec8-a3b7-7ef1798eae26.png" width="350px"> </div><br></p><h4 id="3-volatile-å˜é‡è§„åˆ™"><a href="#3-volatile-å˜é‡è§„åˆ™" class="headerlink" title="3. volatile å˜é‡è§„åˆ™"></a>3. volatile å˜é‡è§„åˆ™</h4><blockquote><p>Volatile Variable Rule</p></blockquote><p>å¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/942f33c9-8ad9-4987-836f-007de4c21de0.png" width="400px"> </div><br></p><h4 id="4-çº¿ç¨‹å¯åŠ¨è§„åˆ™"><a href="#4-çº¿ç¨‹å¯åŠ¨è§„åˆ™" class="headerlink" title="4. çº¿ç¨‹å¯åŠ¨è§„åˆ™"></a>4. çº¿ç¨‹å¯åŠ¨è§„åˆ™</h4><blockquote><p>Thread Start Rule</p></blockquote><p>Thread å¯¹è±¡çš„ start() æ–¹æ³•è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6270c216-7ec0-4db7-94de-0003bce37cd2.png" width="380px"> </div><br></p><h4 id="5-çº¿ç¨‹åŠ å…¥è§„åˆ™"><a href="#5-çº¿ç¨‹åŠ å…¥è§„åˆ™" class="headerlink" title="5. çº¿ç¨‹åŠ å…¥è§„åˆ™"></a>5. çº¿ç¨‹åŠ å…¥è§„åˆ™</h4><blockquote><p>Thread Join Rule</p></blockquote><p>Thread å¯¹è±¡çš„ç»“æŸå…ˆè¡Œå‘ç”Ÿäº join() æ–¹æ³•è¿”å›ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/233f8d89-31d7-413f-9c02-042f19c46ba1.png" width="400px"> </div><br></p><h4 id="6-çº¿ç¨‹ä¸­æ–­è§„åˆ™"><a href="#6-çº¿ç¨‹ä¸­æ–­è§„åˆ™" class="headerlink" title="6. çº¿ç¨‹ä¸­æ–­è§„åˆ™"></a>6. çº¿ç¨‹ä¸­æ–­è§„åˆ™</h4><blockquote><p>Thread Interruption Rule</p></blockquote><p>å¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ interrupted() æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</p><h4 id="7-å¯¹è±¡ç»ˆç»“è§„åˆ™"><a href="#7-å¯¹è±¡ç»ˆç»“è§„åˆ™" class="headerlink" title="7. å¯¹è±¡ç»ˆç»“è§„åˆ™"></a>7. å¯¹è±¡ç»ˆç»“è§„åˆ™</h4><blockquote><p>Finalizer Rule</p></blockquote><p>ä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹ã€‚</p><h4 id="8-ä¼ é€’æ€§"><a href="#8-ä¼ é€’æ€§" class="headerlink" title="8. ä¼ é€’æ€§"></a>8. ä¼ é€’æ€§</h4><blockquote><p>Transitivity</p></blockquote><p>å¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£ä¹ˆæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cã€‚</p><h2 id="åä¸€ã€çº¿ç¨‹å®‰å…¨"><a href="#åä¸€ã€çº¿ç¨‹å®‰å…¨" class="headerlink" title="åä¸€ã€çº¿ç¨‹å®‰å…¨"></a>åä¸€ã€çº¿ç¨‹å®‰å…¨</h2><p>å¤šä¸ªçº¿ç¨‹ä¸ç®¡ä»¥ä½•ç§æ–¹å¼è®¿é—®æŸä¸ªç±»ï¼Œå¹¶ä¸”åœ¨ä¸»è°ƒä»£ç ä¸­ä¸éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œéƒ½èƒ½è¡¨ç°æ­£ç¡®çš„è¡Œä¸ºã€‚</p><p>çº¿ç¨‹å®‰å…¨æœ‰ä»¥ä¸‹å‡ ç§å®ç°æ–¹å¼ï¼š</p><h3 id="ä¸å¯å˜"><a href="#ä¸å¯å˜" class="headerlink" title="ä¸å¯å˜"></a>ä¸å¯å˜</h3><p>ä¸å¯å˜ï¼ˆImmutableï¼‰çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦å†é‡‡å–ä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåº”å½“å°½é‡ä½¿å¯¹è±¡æˆä¸ºä¸å¯å˜ï¼Œæ¥æ»¡è¶³çº¿ç¨‹å®‰å…¨ã€‚</p><p>ä¸å¯å˜çš„ç±»å‹ï¼š</p><ul><li>final å…³é”®å­—ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹</li><li>String</li><li>æšä¸¾ç±»å‹</li><li>Number éƒ¨åˆ†å­ç±»ï¼Œå¦‚ Long å’Œ Double ç­‰æ•°å€¼åŒ…è£…ç±»å‹ï¼ŒBigInteger å’Œ BigDecimal ç­‰å¤§æ•°æ®ç±»å‹ã€‚ä½†åŒä¸º Number çš„åŸå­ç±» AtomicInteger å’Œ AtomicLong åˆ™æ˜¯å¯å˜çš„ã€‚</li></ul><p>å¯¹äºé›†åˆç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Collections.unmodifiableXXX() æ–¹æ³•æ¥è·å–ä¸€ä¸ªä¸å¯å˜çš„é›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImmutableExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Map&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;String, Integer&gt; unmodifiableMap = Collections.unmodifiableMap(map);</span><br><span class="line">        unmodifiableMap.put(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException</span><br><span class="line">    at java.util.Collections$UnmodifiableMap.put(Collections.java:1457)</span><br><span class="line">    at ImmutableExample.main(ImmutableExample.java:9)</span><br></pre></td></tr></table></figure><p>Collections.unmodifiableXXX() å…ˆå¯¹åŸå§‹çš„é›†åˆè¿›è¡Œæ‹·è´ï¼Œéœ€è¦å¯¹é›†åˆè¿›è¡Œä¿®æ”¹çš„æ–¹æ³•éƒ½ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº’æ–¥åŒæ­¥"><a href="#äº’æ–¥åŒæ­¥" class="headerlink" title="äº’æ–¥åŒæ­¥"></a>äº’æ–¥åŒæ­¥</h3><p>synchronized å’Œ ReentrantLockã€‚</p><h3 id="éé˜»å¡åŒæ­¥"><a href="#éé˜»å¡åŒæ­¥" class="headerlink" title="éé˜»å¡åŒæ­¥"></a>éé˜»å¡åŒæ­¥</h3><p>äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿç§°ä¸ºé˜»å¡åŒæ­¥ã€‚</p><p>äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ï¼ˆè¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”ï¼‰ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚</p><p>éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥ï¼šå…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼Œå¦åˆ™é‡‡å–è¡¥å¿æªæ–½ï¼ˆä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰ã€‚è¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šå®ç°éƒ½ä¸éœ€è¦å°†çº¿ç¨‹é˜»å¡ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚</p><h4 id="1-CAS"><a href="#1-CAS" class="headerlink" title="1. CAS"></a>1. CAS</h4><p>ä¹è§‚é”éœ€è¦æ“ä½œå’Œå†²çªæ£€æµ‹è¿™ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§ï¼Œè¿™é‡Œå°±ä¸èƒ½å†ä½¿ç”¨äº’æ–¥åŒæ­¥æ¥ä¿è¯äº†ï¼Œåªèƒ½é ç¡¬ä»¶æ¥å®Œæˆã€‚ç¡¬ä»¶æ”¯æŒçš„åŸå­æ€§æ“ä½œæœ€å…¸å‹çš„æ˜¯ï¼šæ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompare-and-Swapï¼ŒCASï¼‰ã€‚CAS æŒ‡ä»¤éœ€è¦æœ‰ 3 ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åœ°å€ Vã€æ—§çš„é¢„æœŸå€¼ A å’Œæ–°å€¼ Bã€‚å½“æ‰§è¡Œæ“ä½œæ—¶ï¼Œåªæœ‰å½“ V çš„å€¼ç­‰äº Aï¼Œæ‰å°† V çš„å€¼æ›´æ–°ä¸º Bã€‚</p><h4 id="2-AtomicInteger"><a href="#2-AtomicInteger" class="headerlink" title="2. AtomicInteger"></a>2. AtomicInteger</h4><p>J.U.C åŒ…é‡Œé¢çš„æ•´æ•°åŸå­ç±» AtomicInteger çš„æ–¹æ³•è°ƒç”¨äº† Unsafe ç±»çš„ CAS æ“ä½œã€‚</p><p>ä»¥ä¸‹ä»£ç ä½¿ç”¨äº† AtomicInteger æ‰§è¡Œäº†è‡ªå¢çš„æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">    cnt.incrementAndGet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ä»£ç æ˜¯ incrementAndGet() çš„æºç ï¼Œå®ƒè°ƒç”¨äº† Unsafe çš„ getAndAddInt() ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ä»£ç æ˜¯ getAndAddInt() æºç ï¼Œvar1 æŒ‡ç¤ºå¯¹è±¡å†…å­˜åœ°å€ï¼Œvar2 æŒ‡ç¤ºè¯¥å­—æ®µç›¸å¯¹å¯¹è±¡å†…å­˜åœ°å€çš„åç§»ï¼Œvar4 æŒ‡ç¤ºæ“ä½œéœ€è¦åŠ çš„æ•°å€¼ï¼Œè¿™é‡Œä¸º 1ã€‚é€šè¿‡ getIntVolatile(var1, var2) å¾—åˆ°æ—§çš„é¢„æœŸå€¼ï¼Œé€šè¿‡è°ƒç”¨ compareAndSwapInt() æ¥è¿›è¡Œ CAS æ¯”è¾ƒï¼Œå¦‚æœè¯¥å­—æ®µå†…å­˜åœ°å€ä¸­çš„å€¼ç­‰äº var5ï¼Œé‚£ä¹ˆå°±æ›´æ–°å†…å­˜åœ°å€ä¸º var1+var2 çš„å˜é‡ä¸º var5+var4ã€‚</p><p>å¯ä»¥çœ‹åˆ° getAndAddInt() åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå‘ç”Ÿå†²çªçš„åšæ³•æ˜¯ä¸æ–­çš„è¿›è¡Œé‡è¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">    <span class="type">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-ABA"><a href="#3-ABA" class="headerlink" title="3. ABA"></a>3. ABA</h4><p>å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ã€‚</p><p>J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±» AtomicStampedReference æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆã€‚</p><h3 id="æ— åŒæ­¥æ–¹æ¡ˆ"><a href="#æ— åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="æ— åŒæ­¥æ–¹æ¡ˆ"></a>æ— åŒæ­¥æ–¹æ¡ˆ</h3><p>è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸æ˜¯ä¸€å®šå°±è¦è¿›è¡ŒåŒæ­¥ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£å®ƒè‡ªç„¶å°±æ— é¡»ä»»ä½•åŒæ­¥æªæ–½å»ä¿è¯æ­£ç¡®æ€§ã€‚</p><h4 id="1-æ ˆå°é—­"><a href="#1-æ ˆå°é—­" class="headerlink" title="1. æ ˆå°é—­"></a>1. æ ˆå°é—­</h4><p>å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªæ–¹æ³•çš„å±€éƒ¨å˜é‡æ—¶ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå±€éƒ¨å˜é‡å­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆä¸­ï¼Œå±äºçº¿ç¨‹ç§æœ‰çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackClosedExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add100</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(cnt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">StackClosedExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StackClosedExample</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    executorService.execute(() -&gt; example.add100());</span><br><span class="line">    executorService.execute(() -&gt; example.add100());</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100</span><br><span class="line">100</span><br></pre></td></tr></table></figure><h4 id="2-çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread-Local-Storageï¼‰"><a href="#2-çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread-Local-Storageï¼‰" class="headerlink" title="2. çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread Local Storageï¼‰"></a>2. çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread Local Storageï¼‰</h4><p>å¦‚æœä¸€æ®µä»£ç ä¸­æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹è¿™äº›å…±äº«æ•°æ®çš„ä»£ç æ˜¯å¦èƒ½ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œè¿™æ ·ï¼Œæ— é¡»åŒæ­¥ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚</p><p>ç¬¦åˆè¿™ç§ç‰¹ç‚¹çš„åº”ç”¨å¹¶ä¸å°‘è§ï¼Œå¤§éƒ¨åˆ†ä½¿ç”¨æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶æ„æ¨¡å¼ï¼ˆå¦‚â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å¼ï¼‰éƒ½ä¼šå°†äº§å“çš„æ¶ˆè´¹è¿‡ç¨‹å°½é‡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¶ˆè´¹å®Œã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹å°±æ˜¯ç»å…¸ Web äº¤äº’æ¨¡å‹ä¸­çš„â€œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹â€ï¼ˆThread-per-Requestï¼‰çš„å¤„ç†æ–¹å¼ï¼Œè¿™ç§å¤„ç†æ–¹å¼çš„å¹¿æ³›åº”ç”¨ä½¿å¾—å¾ˆå¤š Web æœåŠ¡ç«¯åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><p>å¯ä»¥ä½¿ç”¨ java.lang.ThreadLocal ç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨åŠŸèƒ½ã€‚</p><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œthread1 ä¸­è®¾ç½® threadLocal ä¸º 1ï¼Œè€Œ thread2 è®¾ç½® threadLocal ä¸º 2ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œthread1 è¯»å– threadLocal ä¾ç„¶æ˜¯ 1ï¼Œä¸å— thread2 çš„å½±å“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(threadLocal.get());</span><br><span class="line">            threadLocal.remove();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">2</span>);</span><br><span class="line">            threadLocal.remove();</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ç†è§£ ThreadLocalï¼Œå…ˆçœ‹ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalExample1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadLocal</span> <span class="variable">threadLocal1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">        <span class="type">ThreadLocal</span> <span class="variable">threadLocal2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal1.set(<span class="number">1</span>);</span><br><span class="line">            threadLocal2.set(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal1.set(<span class="number">2</span>);</span><br><span class="line">            threadLocal2.set(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒæ‰€å¯¹åº”çš„åº•å±‚ç»“æ„å›¾ä¸ºï¼š</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6782674c-1bfe-4879-af39-e9d722a95d39.png" width="500px"> </div><br></p><p>æ¯ä¸ª Thread éƒ½æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMap å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></span><br><span class="line"><span class="comment"> * by the ThreadLocal class. */</span></span><br><span class="line">ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨ä¸€ä¸ª ThreadLocal çš„ set(T value) æ–¹æ³•æ—¶ï¼Œå…ˆå¾—åˆ°å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åå°† ThreadLocal->value é”®å€¼å¯¹æ’å…¥åˆ°è¯¥ Map ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get() æ–¹æ³•ç±»ä¼¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ThreadLocal ä»ç†è®ºä¸Šè®²å¹¶ä¸æ˜¯ç”¨æ¥è§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜çš„ï¼Œå› ä¸ºæ ¹æœ¬ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ã€‚</p><p>åœ¨ä¸€äº›åœºæ™¯ (å°¤å…¶æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ) ä¸‹ï¼Œç”±äº ThreadLocal.ThreadLocalMap çš„åº•å±‚æ•°æ®ç»“æ„å¯¼è‡´ ThreadLocal æœ‰å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œåº”è¯¥å°½å¯èƒ½åœ¨æ¯æ¬¡ä½¿ç”¨ ThreadLocal åæ‰‹åŠ¨è°ƒç”¨ remove()ï¼Œä»¥é¿å…å‡ºç° ThreadLocal ç»å…¸çš„å†…å­˜æ³„æ¼ç”šè‡³æ˜¯é€ æˆè‡ªèº«ä¸šåŠ¡æ··ä¹±çš„é£é™©ã€‚</p><h4 id="3-å¯é‡å…¥ä»£ç ï¼ˆReentrant-Codeï¼‰"><a href="#3-å¯é‡å…¥ä»£ç ï¼ˆReentrant-Codeï¼‰" class="headerlink" title="3. å¯é‡å…¥ä»£ç ï¼ˆReentrant Codeï¼‰"></a>3. å¯é‡å…¥ä»£ç ï¼ˆReentrant Codeï¼‰</h4><p>è¿™ç§ä»£ç ä¹Ÿå«åšçº¯ä»£ç ï¼ˆPure Codeï¼‰ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼ˆåŒ…æ‹¬é€’å½’è°ƒç”¨å®ƒæœ¬èº«ï¼‰ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚</p><p>å¯é‡å…¥ä»£ç æœ‰ä¸€äº›å…±åŒçš„ç‰¹å¾ï¼Œä¾‹å¦‚ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½ç”±å‚æ•°ä¸­ä¼ å…¥ã€ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚</p><h2 id="åäºŒã€é”ä¼˜åŒ–"><a href="#åäºŒã€é”ä¼˜åŒ–" class="headerlink" title="åäºŒã€é”ä¼˜åŒ–"></a>åäºŒã€é”ä¼˜åŒ–</h2><p>è¿™é‡Œçš„é”ä¼˜åŒ–ä¸»è¦æ˜¯æŒ‡ JVM å¯¹ synchronized çš„ä¼˜åŒ–ã€‚</p><h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>äº’æ–¥åŒæ­¥è¿›å…¥é˜»å¡çŠ¶æ€çš„å¼€é”€éƒ½å¾ˆå¤§ï¼Œåº”è¯¥å°½é‡é¿å…ã€‚åœ¨è®¸å¤šåº”ç”¨ä¸­ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ã€‚è‡ªæ—‹é”çš„æ€æƒ³æ˜¯è®©ä¸€ä¸ªçº¿ç¨‹åœ¨è¯·æ±‚ä¸€ä¸ªå…±äº«æ•°æ®çš„é”æ—¶æ‰§è¡Œå¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…èƒ½è·å¾—é”ï¼Œå°±å¯ä»¥é¿å…è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p><p>è‡ªæ—‹é”è™½ç„¶èƒ½é¿å…è¿›å…¥é˜»å¡çŠ¶æ€ä»è€Œå‡å°‘å¼€é”€ï¼Œä½†æ˜¯å®ƒéœ€è¦è¿›è¡Œå¿™å¾ªç¯æ“ä½œå ç”¨ CPU æ—¶é—´ï¼Œå®ƒåªé€‚ç”¨äºå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€å¾ˆçŸ­çš„åœºæ™¯ã€‚</p><p>åœ¨ JDK 1.6 ä¸­å¼•å…¥äº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ã€‚è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ¬¡æ•°ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ¬¡æ•°åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚</p><h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h3><p>é”æ¶ˆé™¤æ˜¯æŒ‡å¯¹äºè¢«æ£€æµ‹å‡ºä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p><p>é”æ¶ˆé™¤ä¸»è¦æ˜¯é€šè¿‡é€ƒé€¸åˆ†ææ¥æ”¯æŒï¼Œå¦‚æœå †ä¸Šçš„å…±äº«æ•°æ®ä¸å¯èƒ½é€ƒé€¸å‡ºå»è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå®ƒä»¬å½“æˆç§æœ‰æ•°æ®å¯¹å¾…ï¼Œä¹Ÿå°±å¯ä»¥å°†å®ƒä»¬çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p><p>å¯¹äºä¸€äº›çœ‹èµ·æ¥æ²¡æœ‰åŠ é”çš„ä»£ç ï¼Œå…¶å®éšå¼çš„åŠ äº†å¾ˆå¤šé”ã€‚ä¾‹å¦‚ä¸‹é¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä»£ç å°±éšå¼åŠ äº†é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s1 + s2 + s3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>String æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šå¯¹ String çš„æ‹¼æ¥è‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨ JDK 1.5 ä¹‹å‰ï¼Œä¼šè½¬åŒ–ä¸º StringBuffer å¯¹è±¡çš„è¿ç»­ append() æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    sb.append(s3);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª append() æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—ã€‚è™šæ‹Ÿæœºè§‚å¯Ÿå˜é‡ sbï¼Œå¾ˆå¿«å°±ä¼šå‘ç°å®ƒçš„åŠ¨æ€ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨ concatString() æ–¹æ³•å†…éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsb çš„æ‰€æœ‰å¼•ç”¨æ°¸è¿œä¸ä¼šé€ƒé€¸åˆ° concatString() æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å®ƒï¼Œå› æ­¤å¯ä»¥è¿›è¡Œæ¶ˆé™¤ã€‚</p><h3 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h3><p>å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œé¢‘ç¹çš„åŠ é”æ“ä½œå°±ä¼šå¯¼è‡´æ€§èƒ½æŸè€—ã€‚</p><p>ä¸Šä¸€èŠ‚çš„ç¤ºä¾‹ä»£ç ä¸­è¿ç»­çš„ append() æ–¹æ³•å°±å±äºè¿™ç±»æƒ…å†µã€‚å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°ç”±è¿™æ ·çš„ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ã€‚å¯¹äºä¸Šä¸€èŠ‚çš„ç¤ºä¾‹ä»£ç å°±æ˜¯æ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append() æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append() æ“ä½œä¹‹åï¼Œè¿™æ ·åªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><h3 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h3><p>JDK 1.6 å¼•å…¥äº†åå‘é”å’Œè½»é‡çº§é”ï¼Œä»è€Œè®©é”æ‹¥æœ‰äº†å››ä¸ªçŠ¶æ€ï¼šæ— é”çŠ¶æ€ï¼ˆunlockedï¼‰ã€åå‘é”çŠ¶æ€ï¼ˆbiasbleï¼‰ã€è½»é‡çº§é”çŠ¶æ€ï¼ˆlightweight lockedï¼‰å’Œé‡é‡çº§é”çŠ¶æ€ï¼ˆinflatedï¼‰ã€‚</p><p>ä»¥ä¸‹æ˜¯ HotSpot è™šæ‹Ÿæœºå¯¹è±¡å¤´çš„å†…å­˜å¸ƒå±€ï¼Œè¿™äº›æ•°æ®è¢«ç§°ä¸º Mark Wordã€‚å…¶ä¸­ tag bits å¯¹åº”äº†äº”ä¸ªçŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€åœ¨å³ä¾§çš„ state è¡¨æ ¼ä¸­ç»™å‡ºã€‚é™¤äº† marked for gc çŠ¶æ€ï¼Œå…¶å®ƒå››ä¸ªçŠ¶æ€å·²ç»åœ¨å‰é¢ä»‹ç»è¿‡äº†ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/bb6a49be-00f2-4f27-a0ce-4ed764bc605c.png" width="500"/> </div><br></p><p>ä¸‹å›¾å·¦ä¾§æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆï¼Œå…¶ä¸­æœ‰ä¸€éƒ¨åˆ†ç§°ä¸º Lock Record çš„åŒºåŸŸï¼Œè¿™æ˜¯åœ¨è½»é‡çº§é”è¿è¡Œè¿‡ç¨‹åˆ›å»ºçš„ï¼Œç”¨äºå­˜æ”¾é”å¯¹è±¡çš„ Mark Wordã€‚è€Œå³ä¾§å°±æ˜¯ä¸€ä¸ªé”å¯¹è±¡ï¼ŒåŒ…å«äº† Mark Word å’Œå…¶å®ƒä¿¡æ¯ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/051e436c-0e46-4c59-8f67-52d89d656182.png" width="500"/> </div><br></p><p>è½»é‡çº§é”æ˜¯ç›¸å¯¹äºä¼ ç»Ÿçš„é‡é‡çº§é”è€Œè¨€ï¼Œå®ƒä½¿ç”¨ CAS æ“ä½œæ¥é¿å…é‡é‡çº§é”ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€ã€‚å¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„ï¼Œå› æ­¤ä¹Ÿå°±ä¸éœ€è¦éƒ½ä½¿ç”¨äº’æ–¥é‡è¿›è¡ŒåŒæ­¥ï¼Œå¯ä»¥å…ˆé‡‡ç”¨ CAS æ“ä½œè¿›è¡ŒåŒæ­¥ï¼Œå¦‚æœ CAS å¤±è´¥äº†å†æ”¹ç”¨äº’æ–¥é‡è¿›è¡ŒåŒæ­¥ã€‚</p><p>å½“å°è¯•è·å–ä¸€ä¸ªé”å¯¹è±¡æ—¶ï¼Œå¦‚æœé”å¯¹è±¡æ ‡è®°ä¸º 0 01ï¼Œè¯´æ˜é”å¯¹è±¡çš„é”æœªé”å®šï¼ˆunlockedï¼‰çŠ¶æ€ã€‚æ­¤æ—¶è™šæ‹Ÿæœºåœ¨å½“å‰çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»º Lock Recordï¼Œç„¶åä½¿ç”¨ CAS æ“ä½œå°†å¯¹è±¡çš„ Mark Word æ›´æ–°ä¸º Lock Record æŒ‡é’ˆã€‚å¦‚æœ CAS æ“ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±è·å–äº†è¯¥å¯¹è±¡ä¸Šçš„é”ï¼Œå¹¶ä¸”å¯¹è±¡çš„ Mark Word çš„é”æ ‡è®°å˜ä¸º 00ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºè½»é‡çº§é”çŠ¶æ€ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/baaa681f-7c52-4198-a5ae-303b9386cf47.png" width="400"/> </div><br></p><p>å¦‚æœ CAS æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„ Mark Word æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆï¼Œå¦‚æœæ˜¯çš„è¯è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªé”å¯¹è±¡ï¼Œé‚£å°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜è¿™ä¸ªé”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹çº¿ç¨‹æŠ¢å äº†ã€‚å¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œè¦è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚</p><h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>åå‘é”çš„æ€æƒ³æ˜¯åå‘äºè®©ç¬¬ä¸€ä¸ªè·å–é”å¯¹è±¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨ä¹‹åè·å–è¯¥é”å°±ä¸å†éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œï¼Œç”šè‡³è¿ CAS æ“ä½œä¹Ÿä¸å†éœ€è¦ã€‚</p><p>å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å¾—çš„æ—¶å€™ï¼Œè¿›å…¥åå‘çŠ¶æ€ï¼Œæ ‡è®°ä¸º 1 01ã€‚åŒæ—¶ä½¿ç”¨ CAS æ“ä½œå°†çº¿ç¨‹ ID è®°å½•åˆ° Mark Word ä¸­ï¼Œå¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œè¿™ä¸ªçº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œã€‚</p><p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”å¯¹è±¡æ—¶ï¼Œåå‘çŠ¶æ€å°±å®£å‘Šç»“æŸï¼Œæ­¤æ—¶æ’¤é”€åå‘ï¼ˆRevoke Biasï¼‰åæ¢å¤åˆ°æœªé”å®šçŠ¶æ€æˆ–è€…è½»é‡çº§é”çŠ¶æ€ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/390c913b-5f31-444f-bbdb-2b88b688e7ce.jpg" width="600"/> </div><br></p><h2 id="åä¸‰ã€å¤šçº¿ç¨‹å¼€å‘è‰¯å¥½çš„å®è·µ"><a href="#åä¸‰ã€å¤šçº¿ç¨‹å¼€å‘è‰¯å¥½çš„å®è·µ" class="headerlink" title="åä¸‰ã€å¤šçº¿ç¨‹å¼€å‘è‰¯å¥½çš„å®è·µ"></a>åä¸‰ã€å¤šçº¿ç¨‹å¼€å‘è‰¯å¥½çš„å®è·µ</h2><ul><li><p>ç»™çº¿ç¨‹èµ·ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿æ‰¾ Bugã€‚</p></li><li><p>ç¼©å°åŒæ­¥èŒƒå›´ï¼Œä»è€Œå‡å°‘é”äº‰ç”¨ã€‚ä¾‹å¦‚å¯¹äº synchronizedï¼Œåº”è¯¥å°½é‡ä½¿ç”¨åŒæ­¥å—è€Œä¸æ˜¯åŒæ­¥æ–¹æ³•ã€‚</p></li><li><p>å¤šç”¨åŒæ­¥å·¥å…·å°‘ç”¨ wait() å’Œ notify()ã€‚é¦–å…ˆï¼ŒCountDownLatch, CyclicBarrier, Semaphore å’Œ Exchanger è¿™äº›åŒæ­¥ç±»ç®€åŒ–äº†ç¼–ç æ“ä½œï¼Œè€Œç”¨ wait() å’Œ notify() å¾ˆéš¾å®ç°å¤æ‚æ§åˆ¶æµï¼›å…¶æ¬¡ï¼Œè¿™äº›åŒæ­¥ç±»æ˜¯ç”±æœ€å¥½çš„ä¼ä¸šç¼–å†™å’Œç»´æŠ¤ï¼Œåœ¨åç»­çš„ JDK ä¸­è¿˜ä¼šä¸æ–­ä¼˜åŒ–å’Œå®Œå–„ã€‚</p></li><li><p>ä½¿ç”¨ BlockingQueue å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ã€‚</p></li><li><p>å¤šç”¨å¹¶å‘é›†åˆå°‘ç”¨åŒæ­¥é›†åˆï¼Œä¾‹å¦‚åº”è¯¥ä½¿ç”¨ ConcurrentHashMap è€Œä¸æ˜¯ Hashtableã€‚</p></li><li><p>ä½¿ç”¨æœ¬åœ°å˜é‡å’Œä¸å¯å˜ç±»æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p></li><li><p>ä½¿ç”¨çº¿ç¨‹æ± è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ˜¯å› ä¸ºåˆ›å»ºçº¿ç¨‹ä»£ä»·å¾ˆé«˜ï¼Œçº¿ç¨‹æ± å¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨æœ‰é™çš„çº¿ç¨‹æ¥å¯åŠ¨ä»»åŠ¡ã€‚</p></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>BruceEckel. Java ç¼–ç¨‹æ€æƒ³: ç¬¬ 4 ç‰ˆ [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2007.</li><li>å‘¨å¿—æ˜. æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2011.</li><li><a href="https://docs.oracle.com/javase/specs/jvms/se6/html/Threads.doc.html">Threads and Locks</a></li><li><a href="http://ifeve.com/thread-signaling/#missed_signal">çº¿ç¨‹é€šä¿¡</a></li><li><a href="http://www.importnew.com/12773.html">Java çº¿ç¨‹é¢è¯•é¢˜ Top 50</a></li><li><a href="http://tutorials.jenkov.com/java-util-concurrent/blockingqueue.html">BlockingQueue</a></li><li><a href="https://stackoverflow.com/questions/11265289/thread-state-java">thread state java</a></li><li><a href="http://wiki.expertiza.ncsu.edu/index.php/CSC_456_Spring_2012/ch7_MN">CSC 456 Spring 2012/ch7 MN</a></li><li><a href="https://www.logicbig.com/tutorials/core-java-tutorial/java-multi-threading/happens-before.html">Java - Understanding Happens-before relationship</a></li><li><a href="https://www.slideshare.net/novathinker/6-thread-synchronization">6ì¥ Thread Synchronization</a></li><li><a href="https://stackoverflow.com/questions/1202444/how-is-javas-threadlocal-implemented-under-the-hood/15653015">How is Javaâ€™s ThreadLocal implemented under the hood?</a></li><li><a href="https://sites.google.com/site/webdevelopart/21-compile/06-java/javase/concurrent?tmpl=%2Fsystem%2Fapp%2Ftemplates%2Fprint%2F&amp;showPrintDialog=1">Concurrent</a></li><li><a href="http://www.javacreed.com/java-fork-join-example/" title="Java Fork Join Example">JAVA FORK JOIN EXAMPLE</a></li><li><a href="http://ifeve.com/talk-concurrency-forkjoin/">èŠèŠå¹¶å‘ï¼ˆå…«ï¼‰â€”â€”Fork/Join æ¡†æ¶ä»‹ç»</a></li><li><a href="http://www.oracle.com/technetwork/java/javase/tech/biasedlocking-oopsla2006-preso-150106.pdf">Eliminating SynchronizationRelated Atomic Operations with Biased Locking and Bulk Rebiasing</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹javaå¹¶å‘ç¼–ç¨‹çš„å­¦ä¹ </summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="Thread" scheme="https://www.jodio.cc/tags/Thread/"/>
    
  </entry>
  
  <entry>
    <title>Java å®¹å™¨</title>
    <link href="https://www.jodio.cc/posts/8e2e.html"/>
    <id>https://www.jodio.cc/posts/8e2e.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-å®¹å™¨"><a href="#Java-å®¹å™¨" class="headerlink" title="Java å®¹å™¨"></a>Java å®¹å™¨</h1><h2 id="ä¸€ã€æ¦‚è§ˆ"><a href="#ä¸€ã€æ¦‚è§ˆ" class="headerlink" title="ä¸€ã€æ¦‚è§ˆ"></a>ä¸€ã€æ¦‚è§ˆ</h2><p>å®¹å™¨ä¸»è¦åŒ…æ‹¬ Collection å’Œ Map ä¸¤ç§ï¼ŒCollection å­˜å‚¨ç€å¯¹è±¡çš„é›†åˆï¼Œè€Œ Map å­˜å‚¨ç€é”®å€¼å¯¹ï¼ˆä¸¤ä¸ªå¯¹è±¡ï¼‰çš„æ˜ å°„è¡¨ã€‚</p><h3 id="Collection"><a href="#Collection" class="headerlink" title="Collection"></a>Collection</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208220948084.png"/> </div><br></p><h4 id="1-Set"><a href="#1-Set" class="headerlink" title="1. Set"></a>1. Set</h4><ul><li><p>TreeSetï¼šåŸºäºçº¢é»‘æ ‘å®ç°ï¼Œæ”¯æŒæœ‰åºæ€§æ“ä½œï¼Œä¾‹å¦‚æ ¹æ®ä¸€ä¸ªèŒƒå›´æŸ¥æ‰¾å…ƒç´ çš„æ“ä½œã€‚ä½†æ˜¯æŸ¥æ‰¾æ•ˆç‡ä¸å¦‚ HashSetï¼ŒHashSet æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼ŒTreeSet åˆ™ä¸º O(logN)ã€‚</p></li><li><p>HashSetï¼šåŸºäºå“ˆå¸Œè¡¨å®ç°ï¼Œæ”¯æŒå¿«é€ŸæŸ¥æ‰¾ï¼Œä½†ä¸æ”¯æŒæœ‰åºæ€§æ“ä½œã€‚å¹¶ä¸”å¤±å»äº†å…ƒç´ çš„æ’å…¥é¡ºåºä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ Iterator éå† HashSet å¾—åˆ°çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ã€‚</p></li><li><p>LinkedHashSetï¼šå…·æœ‰ HashSet çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œå¹¶ä¸”å†…éƒ¨ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºã€‚</p></li></ul><h4 id="2-List"><a href="#2-List" class="headerlink" title="2. List"></a>2. List</h4><ul><li><p>ArrayListï¼šåŸºäºåŠ¨æ€æ•°ç»„å®ç°ï¼Œæ”¯æŒéšæœºè®¿é—®ã€‚</p></li><li><p>Vectorï¼šå’Œ ArrayList ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></li><li><p>LinkedListï¼šåŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œåªèƒ½é¡ºåºè®¿é—®ï¼Œä½†æ˜¯å¯ä»¥å¿«é€Ÿåœ°åœ¨é“¾è¡¨ä¸­é—´æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒLinkedList è¿˜å¯ä»¥ç”¨ä½œæ ˆã€é˜Ÿåˆ—å’ŒåŒå‘é˜Ÿåˆ—ã€‚</p></li></ul><h4 id="3-Queue"><a href="#3-Queue" class="headerlink" title="3. Queue"></a>3. Queue</h4><ul><li><p>LinkedListï¼šå¯ä»¥ç”¨å®ƒæ¥å®ç°åŒå‘é˜Ÿåˆ—ã€‚</p></li><li><p>PriorityQueueï¼šåŸºäºå †ç»“æ„å®ç°ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚</p></li></ul><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20201101234335837.png"/> </div><br></p><ul><li><p>TreeMapï¼šåŸºäºçº¢é»‘æ ‘å®ç°ã€‚</p></li><li><p>HashMapï¼šåŸºäºå“ˆå¸Œè¡¨å®ç°ã€‚</p></li><li><p>HashTableï¼šå’Œ HashMap ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥ HashTable ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å®ƒæ˜¯é—ç•™ç±»ï¼Œä¸åº”è¯¥å»ä½¿ç”¨å®ƒï¼Œè€Œæ˜¯ä½¿ç”¨ ConcurrentHashMap æ¥æ”¯æŒçº¿ç¨‹å®‰å…¨ï¼ŒConcurrentHashMap çš„æ•ˆç‡ä¼šæ›´é«˜ï¼Œå› ä¸º ConcurrentHashMap å¼•å…¥äº†åˆ†æ®µé”ã€‚</p></li><li><p>LinkedHashMapï¼šä½¿ç”¨åŒå‘é“¾è¡¨æ¥ç»´æŠ¤å…ƒç´ çš„é¡ºåºï¼Œé¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰é¡ºåºã€‚</p></li></ul><h2 id="äºŒã€å®¹å™¨ä¸­çš„è®¾è®¡æ¨¡å¼"><a href="#äºŒã€å®¹å™¨ä¸­çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="äºŒã€å®¹å™¨ä¸­çš„è®¾è®¡æ¨¡å¼"></a>äºŒã€å®¹å™¨ä¸­çš„è®¾è®¡æ¨¡å¼</h2><h3 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h3><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208225301973.png"/> </div><br></p><p>Collection ç»§æ‰¿äº† Iterable æ¥å£ï¼Œå…¶ä¸­çš„ iterator() æ–¹æ³•èƒ½å¤Ÿäº§ç”Ÿä¸€ä¸ª Iterator å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¿­ä»£éå† Collection ä¸­çš„å…ƒç´ ã€‚</p><p>ä» JDK 1.5 ä¹‹åå¯ä»¥ä½¿ç”¨ foreach æ–¹æ³•æ¥éå†å®ç°äº† Iterable æ¥å£çš„èšåˆå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (String item : list) &#123;</span><br><span class="line">    System.out.println(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h3><p>java.util.Arrays#asList() å¯ä»¥æŠŠæ•°ç»„ç±»å‹è½¬æ¢ä¸º List ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">asList</span><span class="params">(T... a)</span></span><br></pre></td></tr></table></figure><p>åº”è¯¥æ³¨æ„çš„æ˜¯ asList() çš„å‚æ•°ä¸ºæ³›å‹çš„å˜é•¿å‚æ•°ï¼Œä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹æ•°ç»„ä½œä¸ºå‚æ•°ï¼Œåªèƒ½ä½¿ç”¨ç›¸åº”çš„åŒ…è£…ç±»å‹æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> Arrays.asList(arr);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è°ƒç”¨ asList()ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€æºç åˆ†æ"><a href="#ä¸‰ã€æºç åˆ†æ" class="headerlink" title="ä¸‰ã€æºç åˆ†æ"></a>ä¸‰ã€æºç åˆ†æ</h2><p>å¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œä»¥ä¸‹æºç åˆ†æåŸºäº JDK 1.8ã€‚</p><p>åœ¨ IDEA ä¸­ double shift è°ƒå‡º Search EveryWhereï¼ŒæŸ¥æ‰¾æºç æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¹‹åå°±å¯ä»¥é˜…è¯»æºç ã€‚</p><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><h4 id="1-æ¦‚è§ˆ"><a href="#1-æ¦‚è§ˆ" class="headerlink" title="1. æ¦‚è§ˆ"></a>1. æ¦‚è§ˆ</h4><p>å› ä¸º ArrayList æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ã€‚RandomAccess æ¥å£æ ‡è¯†ç€è¯¥ç±»æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractList</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</span><br></pre></td></tr></table></figure><p>æ•°ç»„çš„é»˜è®¤å¤§å°ä¸º 10ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208232221265.png"/> </div><br></p><h4 id="2-æ‰©å®¹"><a href="#2-æ‰©å®¹" class="headerlink" title="2. æ‰©å®¹"></a>2. æ‰©å®¹</h4><p>æ·»åŠ å…ƒç´ æ—¶ä½¿ç”¨ ensureCapacityInternal() æ–¹æ³•æ¥ä¿è¯å®¹é‡è¶³å¤Ÿï¼Œå¦‚æœä¸å¤Ÿæ—¶ï¼Œéœ€è¦ä½¿ç”¨ grow() æ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œæ–°å®¹é‡çš„å¤§å°ä¸º <code>oldCapacity + (oldCapacity &gt;&gt; 1)</code>ï¼Œå³ oldCapacity+oldCapacity/2ã€‚å…¶ä¸­ oldCapacity &gt;&gt; 1 éœ€è¦å–æ•´ï¼Œæ‰€ä»¥æ–°å®¹é‡å¤§çº¦æ˜¯æ—§å®¹é‡çš„ 1.5 å€å·¦å³ã€‚ï¼ˆoldCapacity ä¸ºå¶æ•°å°±æ˜¯ 1.5 å€ï¼Œä¸ºå¥‡æ•°å°±æ˜¯ 1.5 å€-0.5ï¼‰</p><p>æ‰©å®¹æ“ä½œéœ€è¦è°ƒç”¨ <code>Arrays.copyOf()</code> æŠŠåŸæ•°ç»„æ•´ä¸ªå¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œè¿™ä¸ªæ“ä½œä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤æœ€å¥½åœ¨åˆ›å»º ArrayList å¯¹è±¡æ—¶å°±æŒ‡å®šå¤§æ¦‚çš„å®¹é‡å¤§å°ï¼Œå‡å°‘æ‰©å®¹æ“ä½œçš„æ¬¡æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureCapacityInternal</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    ensureExplicitCapacity(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureExplicitCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-åˆ é™¤å…ƒç´ "><a href="#3-åˆ é™¤å…ƒç´ " class="headerlink" title="3. åˆ é™¤å…ƒç´ "></a>3. åˆ é™¤å…ƒç´ </h4><p>éœ€è¦è°ƒç”¨ System.arraycopy() å°† index+1 åé¢çš„å…ƒç´ éƒ½å¤åˆ¶åˆ° index ä½ç½®ä¸Šï¼Œè¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¯ä»¥çœ‹åˆ° ArrayList åˆ é™¤å…ƒç´ çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">E</span> <span class="variable">oldValue</span> <span class="operator">=</span> elementData(index);</span><br><span class="line">    <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index, numMoved);</span><br><span class="line">    elementData[--size] = <span class="literal">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-åºåˆ—åŒ–"><a href="#4-åºåˆ—åŒ–" class="headerlink" title="4. åºåˆ—åŒ–"></a>4. åºåˆ—åŒ–</h4><p>ArrayList åŸºäºæ•°ç»„å®ç°ï¼Œå¹¶ä¸”å…·æœ‰åŠ¨æ€æ‰©å®¹ç‰¹æ€§ï¼Œå› æ­¤ä¿å­˜å…ƒç´ çš„æ•°ç»„ä¸ä¸€å®šéƒ½ä¼šè¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦å…¨éƒ¨è¿›è¡Œåºåˆ—åŒ–ã€‚</p><p>ä¿å­˜å…ƒç´ çš„æ•°ç»„ elementData ä½¿ç”¨ transient ä¿®é¥°ï¼Œè¯¥å…³é”®å­—å£°æ˜æ•°ç»„é»˜è®¤ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Object[] elementData; <span class="comment">// non-private to simplify nested class access</span></span><br></pre></td></tr></table></figure><p>ArrayList å®ç°äº† writeObject() å’Œ readObject() æ¥æ§åˆ¶åªåºåˆ—åŒ–æ•°ç»„ä¸­æœ‰å…ƒç´ å¡«å……é‚£éƒ¨åˆ†å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    elementData = EMPTY_ELEMENTDATA;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in capacity</span></span><br><span class="line">    s.readInt(); <span class="comment">// ignored</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// be like clone(), allocate array based upon size not capacity</span></span><br><span class="line">        ensureCapacityInternal(size);</span><br><span class="line"></span><br><span class="line">        Object[] a = elementData;</span><br><span class="line">        <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">            a[i] = s.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException&#123;</span><br><span class="line">    <span class="comment">// Write out element count, and any hidden stuff</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount;</span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out size as capacity for behavioural compatibility with clone()</span></span><br><span class="line">    s.writeInt(size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        s.writeObject(elementData[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (modCount != expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—åŒ–æ—¶éœ€è¦ä½¿ç”¨ ObjectOutputStream çš„ writeObject() å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµå¹¶è¾“å‡ºã€‚è€Œ writeObject() æ–¹æ³•åœ¨ä¼ å…¥çš„å¯¹è±¡å­˜åœ¨ writeObject() çš„æ—¶å€™ä¼šå»åå°„è°ƒç”¨è¯¥å¯¹è±¡çš„ writeObject() æ¥å®ç°åºåˆ—åŒ–ã€‚ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ ObjectInputStream çš„ readObject() æ–¹æ³•ï¼ŒåŸç†ç±»ä¼¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">oos.writeObject(list);</span><br></pre></td></tr></table></figure><h4 id="5-Fail-Fast"><a href="#5-Fail-Fast" class="headerlink" title="5. Fail-Fast"></a>5. Fail-Fast</h4><p>modCount ç”¨æ¥è®°å½• ArrayList ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°ã€‚ç»“æ„å‘ç”Ÿå˜åŒ–æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ‰€æœ‰æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…åªæ˜¯è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–ã€‚</p><p>åœ¨è¿›è¡Œåºåˆ—åŒ–æˆ–è€…è¿­ä»£ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒæ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†éœ€è¦æŠ›å‡º ConcurrentModificationExceptionã€‚ä»£ç å‚è€ƒä¸ŠèŠ‚åºåˆ—åŒ–ä¸­çš„ writeObject() æ–¹æ³•ã€‚</p><h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><h4 id="1-åŒæ­¥"><a href="#1-åŒæ­¥" class="headerlink" title="1. åŒæ­¥"></a>1. åŒæ­¥</h4><p>å®ƒçš„å®ç°ä¸ ArrayList ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨äº† synchronized è¿›è¡ŒåŒæ­¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    ensureCapacityHelper(elementCount + <span class="number">1</span>);</span><br><span class="line">    elementData[elementCount++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= elementCount)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ArrayIndexOutOfBoundsException</span>(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-æ‰©å®¹-1"><a href="#2-æ‰©å®¹-1" class="headerlink" title="2. æ‰©å®¹"></a>2. æ‰©å®¹</h4><p>Vector çš„æ„é€ å‡½æ•°å¯ä»¥ä¼ å…¥ capacityIncrement å‚æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨æ‰©å®¹æ—¶ä½¿å®¹é‡ capacity å¢é•¿ capacityIncrementã€‚å¦‚æœè¿™ä¸ªå‚æ•°çš„å€¼å°äºç­‰äº 0ï¼Œæ‰©å®¹æ—¶æ¯æ¬¡éƒ½ä»¤ capacity ä¸ºåŸæ¥çš„ä¸¤å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Vector</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">int</span> capacityIncrement)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal Capacity: &quot;</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="built_in">this</span>.elementData = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity];</span><br><span class="line">    <span class="built_in">this</span>.capacityIncrement = capacityIncrement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + ((capacityIncrement &gt; <span class="number">0</span>) ?</span><br><span class="line">                                     capacityIncrement : oldCapacity);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ²¡æœ‰ capacityIncrement çš„æ„é€ å‡½æ•°æ—¶ï¼ŒcapacityIncrement å€¼è¢«è®¾ç½®ä¸º 0ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹ Vector æ¯æ¬¡æ‰©å®¹æ—¶å®¹é‡éƒ½ä¼šç¿»å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Vector</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(initialCapacity, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Vector</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-ä¸-ArrayList-çš„æ¯”è¾ƒ"><a href="#3-ä¸-ArrayList-çš„æ¯”è¾ƒ" class="headerlink" title="3. ä¸ ArrayList çš„æ¯”è¾ƒ"></a>3. ä¸ ArrayList çš„æ¯”è¾ƒ</h4><ul><li>Vector æ˜¯åŒæ­¥çš„ï¼Œå› æ­¤å¼€é”€å°±æ¯” ArrayList è¦å¤§ï¼Œè®¿é—®é€Ÿåº¦æ›´æ…¢ã€‚æœ€å¥½ä½¿ç”¨ ArrayList è€Œä¸æ˜¯ Vectorï¼Œå› ä¸ºåŒæ­¥æ“ä½œå®Œå…¨å¯ä»¥ç”±ç¨‹åºå‘˜è‡ªå·±æ¥æ§åˆ¶ï¼›</li><li>Vector æ¯æ¬¡æ‰©å®¹è¯·æ±‚å…¶å¤§å°çš„ 2 å€ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®å¢é•¿çš„å®¹é‡ï¼‰ï¼Œè€Œ ArrayList æ˜¯ 1.5 å€ã€‚</li></ul><h4 id="4-æ›¿ä»£æ–¹æ¡ˆ"><a href="#4-æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="4. æ›¿ä»£æ–¹æ¡ˆ"></a>4. æ›¿ä»£æ–¹æ¡ˆ</h4><p>å¯ä»¥ä½¿ç”¨ <code>Collections.synchronizedList();</code> å¾—åˆ°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ ArrayListã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; synList = Collections.synchronizedList(list);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ concurrent å¹¶å‘åŒ…ä¸‹çš„ CopyOnWriteArrayList ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h3><h4 id="1-è¯»å†™åˆ†ç¦»"><a href="#1-è¯»å†™åˆ†ç¦»" class="headerlink" title="1. è¯»å†™åˆ†ç¦»"></a>1. è¯»å†™åˆ†ç¦»</h4><p>å†™æ“ä½œåœ¨ä¸€ä¸ªå¤åˆ¶çš„æ•°ç»„ä¸Šè¿›è¡Œï¼Œè¯»æ“ä½œè¿˜æ˜¯åœ¨åŸå§‹æ•°ç»„ä¸­è¿›è¡Œï¼Œè¯»å†™åˆ†ç¦»ï¼Œäº’ä¸å½±å“ã€‚</p><p>å†™æ“ä½œéœ€è¦åŠ é”ï¼Œé˜²æ­¢å¹¶å‘å†™å…¥æ—¶å¯¼è‡´å†™å…¥æ•°æ®ä¸¢å¤±ã€‚</p><p>å†™æ“ä½œç»“æŸä¹‹åéœ€è¦æŠŠåŸå§‹æ•°ç»„æŒ‡å‘æ–°çš„å¤åˆ¶æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setArray</span><span class="params">(Object[] a)</span> &#123;</span><br><span class="line">    array = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">get</span><span class="params">(Object[] a, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-é€‚ç”¨åœºæ™¯"><a href="#2-é€‚ç”¨åœºæ™¯" class="headerlink" title="2. é€‚ç”¨åœºæ™¯"></a>2. é€‚ç”¨åœºæ™¯</h4><p>CopyOnWriteArrayList åœ¨å†™æ“ä½œçš„åŒæ—¶å…è®¸è¯»æ“ä½œï¼Œå¤§å¤§æé«˜äº†è¯»æ“ä½œçš„æ€§èƒ½ï¼Œå› æ­¤å¾ˆé€‚åˆè¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯ã€‚</p><p>ä½†æ˜¯ CopyOnWriteArrayList æœ‰å…¶ç¼ºé™·ï¼š</p><ul><li>å†…å­˜å ç”¨ï¼šåœ¨å†™æ“ä½œæ—¶éœ€è¦å¤åˆ¶ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œä½¿å¾—å†…å­˜å ç”¨ä¸ºåŸæ¥çš„ä¸¤å€å·¦å³ï¼›</li><li>æ•°æ®ä¸ä¸€è‡´ï¼šè¯»æ“ä½œä¸èƒ½è¯»å–å®æ—¶æ€§çš„æ•°æ®ï¼Œå› ä¸ºéƒ¨åˆ†å†™æ“ä½œçš„æ•°æ®è¿˜æœªåŒæ­¥åˆ°è¯»æ•°ç»„ä¸­ã€‚</li></ul><p>æ‰€ä»¥ CopyOnWriteArrayList ä¸é€‚åˆå†…å­˜æ•æ„Ÿä»¥åŠå¯¹å®æ—¶æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ã€‚</p><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><h4 id="1-æ¦‚è§ˆ-1"><a href="#1-æ¦‚è§ˆ-1" class="headerlink" title="1. æ¦‚è§ˆ"></a>1. æ¦‚è§ˆ</h4><p>åŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œä½¿ç”¨ Node å­˜å‚¨é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªé“¾è¡¨å­˜å‚¨äº† first å’Œ last æŒ‡é’ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; first;</span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; last;</span><br></pre></td></tr></table></figure><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208233940066.png"/> </div><br></p><h4 id="2-ä¸-ArrayList-çš„æ¯”è¾ƒ"><a href="#2-ä¸-ArrayList-çš„æ¯”è¾ƒ" class="headerlink" title="2. ä¸ ArrayList çš„æ¯”è¾ƒ"></a>2. ä¸ ArrayList çš„æ¯”è¾ƒ</h4><p>ArrayList åŸºäºåŠ¨æ€æ•°ç»„å®ç°ï¼ŒLinkedList åŸºäºåŒå‘é“¾è¡¨å®ç°ã€‚ArrayList å’Œ LinkedList çš„åŒºåˆ«å¯ä»¥å½’ç»“ä¸ºæ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«ï¼š</p><ul><li>æ•°ç»„æ”¯æŒéšæœºè®¿é—®ï¼Œä½†æ’å…¥åˆ é™¤çš„ä»£ä»·å¾ˆé«˜ï¼Œéœ€è¦ç§»åŠ¨å¤§é‡å…ƒç´ ï¼›</li><li>é“¾è¡¨ä¸æ”¯æŒéšæœºè®¿é—®ï¼Œä½†æ’å…¥åˆ é™¤åªéœ€è¦æ”¹å˜æŒ‡é’ˆã€‚</li></ul><h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œä»¥ä¸‹æºç åˆ†æä»¥ JDK 1.7 ä¸ºä¸»ã€‚</p><h4 id="1-å­˜å‚¨ç»“æ„"><a href="#1-å­˜å‚¨ç»“æ„" class="headerlink" title="1. å­˜å‚¨ç»“æ„"></a>1. å­˜å‚¨ç»“æ„</h4><p>å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª Entry ç±»å‹çš„æ•°ç»„ tableã€‚Entry å­˜å‚¨ç€é”®å€¼å¯¹ã€‚å®ƒåŒ…å«äº†å››ä¸ªå­—æ®µï¼Œä» next å­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹å‡º Entry æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚å³æ•°ç»„ä¸­çš„æ¯ä¸ªä½ç½®è¢«å½“æˆä¸€ä¸ªæ¡¶ï¼Œä¸€ä¸ªæ¡¶å­˜æ”¾ä¸€ä¸ªé“¾è¡¨ã€‚HashMap ä½¿ç”¨æ‹‰é“¾æ³•æ¥è§£å†³å†²çªï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­å­˜æ”¾å“ˆå¸Œå€¼å’Œæ•£åˆ—æ¡¶å–æ¨¡è¿ç®—ç»“æœç›¸åŒçš„ Entryã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208234948205.png"/> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Entry[] table;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="type">int</span> hash;</span><br><span class="line"></span><br><span class="line">    Entry(<span class="type">int</span> h, K k, V v, Entry&lt;K,V&gt; n) &#123;</span><br><span class="line">        value = v;</span><br><span class="line">        next = n;</span><br><span class="line">        key = k;</span><br><span class="line">        hash = h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">        <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map.Entry))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> (Map.Entry)o;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">k1</span> <span class="operator">=</span> getKey();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">k2</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">        <span class="keyword">if</span> (k1 == k2 || (k1 != <span class="literal">null</span> &amp;&amp; k1.equals(k2))) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> getValue();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (v1 == v2 || (v1 != <span class="literal">null</span> &amp;&amp; v1.equals(v2)))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(getKey()) ^ Objects.hashCode(getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-æ‹‰é“¾æ³•çš„å·¥ä½œåŸç†"><a href="#2-æ‹‰é“¾æ³•çš„å·¥ä½œåŸç†" class="headerlink" title="2. æ‹‰é“¾æ³•çš„å·¥ä½œåŸç†"></a>2. æ‹‰é“¾æ³•çš„å·¥ä½œåŸç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;K1&quot;</span>, <span class="string">&quot;V1&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;K2&quot;</span>, <span class="string">&quot;V2&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;K3&quot;</span>, <span class="string">&quot;V3&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>æ–°å»ºä¸€ä¸ª HashMapï¼Œé»˜è®¤å¤§å°ä¸º 16ï¼›</li><li>æ’å…¥ &lt;K1,V1> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K1 çš„ hashCode ä¸º 115ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ 115%16=3ã€‚</li><li>æ’å…¥ &lt;K2,V2> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K2 çš„ hashCode ä¸º 118ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ 118%16=6ã€‚</li><li>æ’å…¥ &lt;K3,V3> é”®å€¼å¯¹ï¼Œå…ˆè®¡ç®— K3 çš„ hashCode ä¸º 118ï¼Œä½¿ç”¨é™¤ç•™ä½™æ•°æ³•å¾—åˆ°æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ 118%16=6ï¼Œæ’åœ¨ &lt;K2,V2> å‰é¢ã€‚</li></ul><p>åº”è¯¥æ³¨æ„åˆ°é“¾è¡¨çš„æ’å…¥æ˜¯ä»¥å¤´æ’æ³•æ–¹å¼è¿›è¡Œçš„ï¼Œä¾‹å¦‚ä¸Šé¢çš„ &lt;K3,V3> ä¸æ˜¯æ’åœ¨ &lt;K2,V2> åé¢ï¼Œè€Œæ˜¯æ’å…¥åœ¨é“¾è¡¨å¤´éƒ¨ã€‚</p><p>æŸ¥æ‰¾éœ€è¦åˆ†æˆä¸¤æ­¥è¿›è¡Œï¼š</p><ul><li>è®¡ç®—é”®å€¼å¯¹æ‰€åœ¨çš„æ¡¶ï¼›</li><li>åœ¨é“¾è¡¨ä¸Šé¡ºåºæŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶å’Œé“¾è¡¨çš„é•¿åº¦æˆæ­£æ¯”ã€‚</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208235258643.png"/> </div><br></p><h4 id="3-put-æ“ä½œ"><a href="#3-put-æ“ä½œ" class="headerlink" title="3. put æ“ä½œ"></a>3. put æ“ä½œ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é”®ä¸º null å•ç‹¬å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="comment">// ç¡®å®šæ¡¶ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line">    <span class="comment">// å…ˆæ‰¾å‡ºæ˜¯å¦å·²ç»å­˜åœ¨é”®ä¸º key çš„é”®å€¼å¯¹ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±æ›´æ–°è¿™ä¸ªé”®å€¼å¯¹çš„å€¼ä¸º value</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// æ’å…¥æ–°é”®å€¼å¯¹</span></span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashMap å…è®¸æ’å…¥é”®ä¸º null çš„é”®å€¼å¯¹ã€‚ä½†æ˜¯å› ä¸ºæ— æ³•è°ƒç”¨ null çš„ hashCode() æ–¹æ³•ï¼Œä¹Ÿå°±æ— æ³•ç¡®å®šè¯¥é”®å€¼å¯¹çš„æ¡¶ä¸‹æ ‡ï¼Œåªèƒ½é€šè¿‡å¼ºåˆ¶æŒ‡å®šä¸€ä¸ªæ¡¶ä¸‹æ ‡æ¥å­˜æ”¾ã€‚HashMap ä½¿ç”¨ç¬¬ 0 ä¸ªæ¡¶å­˜æ”¾é”®ä¸º null çš„é”®å€¼å¯¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">putForNullKey</span><span class="params">(V value)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="literal">null</span>, value, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨é“¾è¡¨çš„å¤´æ’æ³•ï¼Œä¹Ÿå°±æ˜¯æ–°çš„é”®å€¼å¯¹æ’åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯é“¾è¡¨çš„å°¾éƒ¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="literal">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">        hash = (<span class="literal">null</span> != key) ? hash(key) : <span class="number">0</span>;</span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    <span class="comment">// å¤´æ’æ³•ï¼Œé“¾è¡¨å¤´éƒ¨æŒ‡å‘æ–°çš„é”®å€¼å¯¹</span></span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Entry(<span class="type">int</span> h, K k, V v, Entry&lt;K,V&gt; n) &#123;</span><br><span class="line">    value = v;</span><br><span class="line">    next = n;</span><br><span class="line">    key = k;</span><br><span class="line">    hash = h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-ç¡®å®šæ¡¶ä¸‹æ ‡"><a href="#4-ç¡®å®šæ¡¶ä¸‹æ ‡" class="headerlink" title="4. ç¡®å®šæ¡¶ä¸‹æ ‡"></a>4. ç¡®å®šæ¡¶ä¸‹æ ‡</h4><p>å¾ˆå¤šæ“ä½œéƒ½éœ€è¦å…ˆç¡®å®šä¸€ä¸ªé”®å€¼å¯¹æ‰€åœ¨çš„æ¡¶ä¸‹æ ‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br></pre></td></tr></table></figure><p><strong>4.1 è®¡ç®— hash å€¼</strong>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hashSeed;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4.2 å–æ¨¡</strong>  </p><p>ä»¤ x = 1\&lt;\&lt;4ï¼Œå³ x ä¸º 2 çš„ 4 æ¬¡æ–¹ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x   : 00010000</span><br><span class="line">x-1 : 00001111</span><br></pre></td></tr></table></figure><p>ä»¤ä¸€ä¸ªæ•° y ä¸ x-1 åšä¸è¿ç®—ï¼Œå¯ä»¥å»é™¤ y ä½çº§è¡¨ç¤ºçš„ç¬¬ 4 ä½ä»¥ä¸Šæ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y       : 10110010</span><br><span class="line">x-1     : 00001111</span><br><span class="line">y&amp;(x-1) : 00000010</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ€§è´¨å’Œ y å¯¹ x å–æ¨¡æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y   : 10110010</span><br><span class="line">x   : 00010000</span><br><span class="line">y%x : 00000010</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œä½è¿ç®—çš„ä»£ä»·æ¯”æ±‚æ¨¡è¿ç®—å°çš„å¤šï¼Œå› æ­¤åœ¨è¿›è¡Œè¿™ç§è®¡ç®—æ—¶ç”¨ä½è¿ç®—çš„è¯èƒ½å¸¦æ¥æ›´é«˜çš„æ€§èƒ½ã€‚</p><p>ç¡®å®šæ¡¶ä¸‹æ ‡çš„æœ€åä¸€æ­¥æ˜¯å°† key çš„ hash å€¼å¯¹æ¡¶ä¸ªæ•°å–æ¨¡ï¼šhash%capacityï¼Œå¦‚æœèƒ½ä¿è¯ capacity ä¸º 2 çš„ n æ¬¡æ–¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¿™ä¸ªæ“ä½œè½¬æ¢ä¸ºä½è¿ç®—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">indexFor</span><span class="params">(<span class="type">int</span> h, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-æ‰©å®¹-åŸºæœ¬åŸç†"><a href="#5-æ‰©å®¹-åŸºæœ¬åŸç†" class="headerlink" title="5. æ‰©å®¹-åŸºæœ¬åŸç†"></a>5. æ‰©å®¹-åŸºæœ¬åŸç†</h4><p>è®¾ HashMap çš„ table é•¿åº¦ä¸º Mï¼Œéœ€è¦å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡ä¸º Nï¼Œå¦‚æœå“ˆå¸Œå‡½æ•°æ»¡è¶³å‡åŒ€æ€§çš„è¦æ±‚ï¼Œé‚£ä¹ˆæ¯æ¡é“¾è¡¨çš„é•¿åº¦å¤§çº¦ä¸º N/Mï¼Œå› æ­¤æŸ¥æ‰¾çš„å¤æ‚åº¦ä¸º O(N/M)ã€‚</p><p>ä¸ºäº†è®©æŸ¥æ‰¾çš„æˆæœ¬é™ä½ï¼Œåº”è¯¥ä½¿ N/M å°½å¯èƒ½å°ï¼Œå› æ­¤éœ€è¦ä¿è¯ M å°½å¯èƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯è¯´ table è¦å°½å¯èƒ½å¤§ã€‚HashMap é‡‡ç”¨åŠ¨æ€æ‰©å®¹æ¥æ ¹æ®å½“å‰çš„ N å€¼æ¥è°ƒæ•´ M å€¼ï¼Œä½¿å¾—ç©ºé—´æ•ˆç‡å’Œæ—¶é—´æ•ˆç‡éƒ½èƒ½å¾—åˆ°ä¿è¯ã€‚</p><p>å’Œæ‰©å®¹ç›¸å…³çš„å‚æ•°ä¸»è¦æœ‰ï¼šcapacityã€sizeã€threshold å’Œ load_factorã€‚</p><div class="table-container"><table><thead><tr><th style="text-align:center">å‚æ•°</th><th style="text-align:left">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center">capacity</td><td style="text-align:left">table çš„å®¹é‡å¤§å°ï¼Œé»˜è®¤ä¸º 16ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ capacity å¿…é¡»ä¿è¯ä¸º 2 çš„ n æ¬¡æ–¹ã€‚</td></tr><tr><td style="text-align:center">size</td><td style="text-align:left">é”®å€¼å¯¹æ•°é‡ã€‚</td></tr><tr><td style="text-align:center">threshold</td><td style="text-align:left">size çš„ä¸´ç•Œå€¼ï¼Œå½“ size å¤§äºç­‰äº threshold å°±å¿…é¡»è¿›è¡Œæ‰©å®¹æ“ä½œã€‚</td></tr><tr><td style="text-align:center">loadFactor</td><td style="text-align:left">è£…è½½å› å­ï¼Œtable èƒ½å¤Ÿä½¿ç”¨çš„æ¯”ä¾‹ï¼Œthreshold = (int)(capacity* loadFactor)ã€‚</td></tr></tbody></table></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">float</span> loadFactor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> modCount;</span><br></pre></td></tr></table></figure><p>ä»ä¸‹é¢çš„æ·»åŠ å…ƒç´ ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“éœ€è¦æ‰©å®¹æ—¶ï¼Œä»¤ capacity ä¸ºåŸæ¥çš„ä¸¤å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰©å®¹ä½¿ç”¨ resize() å®ç°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰©å®¹æ“ä½œåŒæ ·éœ€è¦æŠŠ oldTable çš„æ‰€æœ‰é”®å€¼å¯¹é‡æ–°æ’å…¥ newTable ä¸­ï¼Œå› æ­¤è¿™ä¸€æ­¥æ˜¯å¾ˆè´¹æ—¶çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">resize</span><span class="params">(<span class="type">int</span> newCapacity)</span> &#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> <span class="title class_">Entry</span>[newCapacity];</span><br><span class="line">    transfer(newTable);</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="type">int</span>)(newCapacity * loadFactor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable)</span> &#123;</span><br><span class="line">    Entry[] src = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; src.length; j++) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; e = src[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            src[j] = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);</span><br><span class="line">                e.next = newTable[i];</span><br><span class="line">                newTable[i] = e;</span><br><span class="line">                e = next;</span><br><span class="line">            &#125; <span class="keyword">while</span> (e != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-æ‰©å®¹-é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡"><a href="#6-æ‰©å®¹-é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡" class="headerlink" title="6. æ‰©å®¹-é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡"></a>6. æ‰©å®¹-é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡</h4><p>åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œéœ€è¦æŠŠé”®å€¼å¯¹é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡ï¼Œä»è€Œæ”¾åˆ°å¯¹åº”çš„æ¡¶ä¸Šã€‚åœ¨å‰é¢æåˆ°ï¼ŒHashMap ä½¿ç”¨ hash%capacity æ¥ç¡®å®šæ¡¶ä¸‹æ ‡ã€‚HashMap capacity ä¸º 2 çš„ n æ¬¡æ–¹è¿™ä¸€ç‰¹ç‚¹èƒ½å¤Ÿæå¤§é™ä½é‡æ–°è®¡ç®—æ¡¶ä¸‹æ ‡æ“ä½œçš„å¤æ‚åº¦ã€‚</p><p>å‡è®¾åŸæ•°ç»„é•¿åº¦ capacity ä¸º 16ï¼Œæ‰©å®¹ä¹‹å new capacity ä¸º 32ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">capacity     : 00010000</span><br><span class="line">new capacity : 00100000</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€ä¸ª Keyï¼Œå®ƒçš„å“ˆå¸Œå€¼ hash åœ¨ç¬¬ 5 ä½ï¼š</p><ul><li>ä¸º 0ï¼Œé‚£ä¹ˆ hash%00010000 = hash%00100000ï¼Œæ¡¶ä½ç½®å’ŒåŸæ¥ä¸€è‡´ï¼›</li><li>ä¸º 1ï¼Œhash%00010000 = hash%00100000 + 16ï¼Œæ¡¶ä½ç½®æ˜¯åŸä½ç½® + 16ã€‚</li></ul><h4 id="7-è®¡ç®—æ•°ç»„å®¹é‡"><a href="#7-è®¡ç®—æ•°ç»„å®¹é‡" class="headerlink" title="7. è®¡ç®—æ•°ç»„å®¹é‡"></a>7. è®¡ç®—æ•°ç»„å®¹é‡</h4><p>HashMap æ„é€ å‡½æ•°å…è®¸ç”¨æˆ·ä¼ å…¥çš„å®¹é‡ä¸æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œå› ä¸ºå®ƒå¯ä»¥è‡ªåŠ¨åœ°å°†ä¼ å…¥çš„å®¹é‡è½¬æ¢ä¸º 2 çš„ n æ¬¡æ–¹ã€‚</p><p>å…ˆè€ƒè™‘å¦‚ä½•æ±‚ä¸€ä¸ªæ•°çš„æ©ç ï¼Œå¯¹äº 10010000ï¼Œå®ƒçš„æ©ç ä¸º 11111111ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å¾—åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mask |= mask &gt;&gt; 1    11011000</span><br><span class="line">mask |= mask &gt;&gt; 2    11111110</span><br><span class="line">mask |= mask &gt;&gt; 4    11111111</span><br></pre></td></tr></table></figure><p>mask+1 æ˜¯å¤§äºåŸå§‹æ•°å­—çš„æœ€å°çš„ 2 çš„ n æ¬¡æ–¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num     10010000</span><br><span class="line">mask+1 100000000</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ HashMap ä¸­è®¡ç®—æ•°ç»„å®¹é‡çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-é“¾è¡¨è½¬çº¢é»‘æ ‘"><a href="#8-é“¾è¡¨è½¬çº¢é»‘æ ‘" class="headerlink" title="8. é“¾è¡¨è½¬çº¢é»‘æ ‘"></a>8. é“¾è¡¨è½¬çº¢é»‘æ ‘</h4><p>ä» JDK 1.8 å¼€å§‹ï¼Œä¸€ä¸ªæ¡¶å­˜å‚¨çš„é“¾è¡¨é•¿åº¦å¤§äºç­‰äº 8 æ—¶ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚</p><h4 id="9-ä¸-Hashtable-çš„æ¯”è¾ƒ"><a href="#9-ä¸-Hashtable-çš„æ¯”è¾ƒ" class="headerlink" title="9. ä¸ Hashtable çš„æ¯”è¾ƒ"></a>9. ä¸ Hashtable çš„æ¯”è¾ƒ</h4><ul><li>Hashtable ä½¿ç”¨ synchronized æ¥è¿›è¡ŒåŒæ­¥ã€‚</li><li>HashMap å¯ä»¥æ’å…¥é”®ä¸º null çš„ Entryã€‚</li><li>HashMap çš„è¿­ä»£å™¨æ˜¯ fail-fast è¿­ä»£å™¨ã€‚</li><li>HashMap ä¸èƒ½ä¿è¯éšç€æ—¶é—´çš„æ¨ç§» Map ä¸­çš„å…ƒç´ æ¬¡åºæ˜¯ä¸å˜çš„ã€‚</li></ul><h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><h4 id="1-å­˜å‚¨ç»“æ„-1"><a href="#1-å­˜å‚¨ç»“æ„-1" class="headerlink" title="1. å­˜å‚¨ç»“æ„"></a>1. å­˜å‚¨ç»“æ„</h4><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191209001038024.png"/> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HashEntry</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V value;</span><br><span class="line">    <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConcurrentHashMap å’Œ HashMap å®ç°ä¸Šç±»ä¼¼ï¼Œæœ€ä¸»è¦çš„å·®åˆ«æ˜¯ ConcurrentHashMap é‡‡ç”¨äº†åˆ†æ®µé”ï¼ˆSegmentï¼‰ï¼Œæ¯ä¸ªåˆ†æ®µé”ç»´æŠ¤ç€å‡ ä¸ªæ¡¶ï¼ˆHashEntryï¼‰ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ä¸åŒåˆ†æ®µé”ä¸Šçš„æ¡¶ï¼Œä»è€Œä½¿å…¶å¹¶å‘åº¦æ›´é«˜ï¼ˆå¹¶å‘åº¦å°±æ˜¯ Segment çš„ä¸ªæ•°ï¼‰ã€‚</p><p>Segment ç»§æ‰¿è‡ª ReentrantLockã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Segment</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">2249069246763182397L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SCAN_RETRIES</span> <span class="operator">=</span></span><br><span class="line">        Runtime.getRuntime().availableProcessors() &gt; <span class="number">1</span> ? <span class="number">64</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> modCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> threshold;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span> loadFactor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Segment&lt;K,V&gt;[] segments;</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„å¹¶å‘çº§åˆ«ä¸º 16ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤åˆ›å»º 16 ä¸ª Segmentã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CONCURRENCY_LEVEL</span> <span class="operator">=</span> <span class="number">16</span>;</span><br></pre></td></tr></table></figure><h4 id="2-size-æ“ä½œ"><a href="#2-size-æ“ä½œ" class="headerlink" title="2. size æ“ä½œ"></a>2. size æ“ä½œ</h4><p>æ¯ä¸ª Segment ç»´æŠ¤äº†ä¸€ä¸ª count å˜é‡æ¥ç»Ÿè®¡è¯¥ Segment ä¸­çš„é”®å€¼å¯¹ä¸ªæ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The number of elements. Accessed only either within locks</span></span><br><span class="line"><span class="comment"> * or among other volatile reads that maintain visibility.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> count;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œ size æ“ä½œæ—¶ï¼Œéœ€è¦éå†æ‰€æœ‰ Segment ç„¶åæŠŠ count ç´¯è®¡èµ·æ¥ã€‚</p><p>ConcurrentHashMap åœ¨æ‰§è¡Œ size æ“ä½œæ—¶å…ˆå°è¯•ä¸åŠ é”ï¼Œå¦‚æœè¿ç»­ä¸¤æ¬¡ä¸åŠ é”æ“ä½œå¾—åˆ°çš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºè¿™ä¸ªç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p><p>å°è¯•æ¬¡æ•°ä½¿ç”¨ RETRIES_BEFORE_LOCK å®šä¹‰ï¼Œè¯¥å€¼ä¸º 2ï¼Œretries åˆå§‹å€¼ä¸º -1ï¼Œå› æ­¤å°è¯•æ¬¡æ•°ä¸º 3ã€‚</p><p>å¦‚æœå°è¯•çš„æ¬¡æ•°è¶…è¿‡ 3 æ¬¡ï¼Œå°±éœ€è¦å¯¹æ¯ä¸ª Segment åŠ é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Number of unsynchronized retries in size and containsValue</span></span><br><span class="line"><span class="comment"> * methods before resorting to locking. This is used to avoid</span></span><br><span class="line"><span class="comment"> * unbounded retries if tables undergo continuous modification</span></span><br><span class="line"><span class="comment"> * which would make it impossible to obtain an accurate result.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RETRIES_BEFORE_LOCK</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Try a few times to get accurate count. On failure due to</span></span><br><span class="line">    <span class="comment">// continuous async changes in table, resort to locking.</span></span><br><span class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="built_in">this</span>.segments;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">boolean</span> overflow; <span class="comment">// true if size overflows 32 bits</span></span><br><span class="line">    <span class="type">long</span> sum;         <span class="comment">// sum of modCounts</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">last</span> <span class="operator">=</span> <span class="number">0L</span>;   <span class="comment">// previous sum</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">retries</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// first iteration isn&#x27;t retry</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è¶…è¿‡å°è¯•æ¬¡æ•°ï¼Œåˆ™å¯¹æ¯ä¸ª Segment åŠ é”</span></span><br><span class="line">            <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                    ensureSegment(j).lock(); <span class="comment">// force creation</span></span><br><span class="line">            &#125;</span><br><span class="line">            sum = <span class="number">0L</span>;</span><br><span class="line">            size = <span class="number">0</span>;</span><br><span class="line">            overflow = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j) &#123;</span><br><span class="line">                Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">                <span class="keyword">if</span> (seg != <span class="literal">null</span>) &#123;</span><br><span class="line">                    sum += seg.modCount;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> seg.count;</span><br><span class="line">                    <span class="keyword">if</span> (c &lt; <span class="number">0</span> || (size += c) &lt; <span class="number">0</span>)</span><br><span class="line">                        overflow = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿ç»­ä¸¤æ¬¡å¾—åˆ°çš„ç»“æœä¸€è‡´ï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªç»“æœæ˜¯æ­£ç¡®çš„</span></span><br><span class="line">            <span class="keyword">if</span> (sum == last)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            last = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                segmentAt(segments, j).unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-JDK-1-8-çš„æ”¹åŠ¨"><a href="#3-JDK-1-8-çš„æ”¹åŠ¨" class="headerlink" title="3. JDK 1.8 çš„æ”¹åŠ¨"></a>3. JDK 1.8 çš„æ”¹åŠ¨</h4><p>JDK 1.7 ä½¿ç”¨åˆ†æ®µé”æœºåˆ¶æ¥å®ç°å¹¶å‘æ›´æ–°æ“ä½œï¼Œæ ¸å¿ƒç±»ä¸º Segmentï¼Œå®ƒç»§æ‰¿è‡ªé‡å…¥é” ReentrantLockï¼Œå¹¶å‘åº¦ä¸ Segment æ•°é‡ç›¸ç­‰ã€‚</p><p>JDK 1.8 ä½¿ç”¨äº† CAS æ“ä½œæ¥æ”¯æŒæ›´é«˜çš„å¹¶å‘åº¦ï¼Œåœ¨ CAS æ“ä½œå¤±è´¥æ—¶ä½¿ç”¨å†…ç½®é” synchronizedã€‚</p><p>å¹¶ä¸” JDK 1.8 çš„å®ç°ä¹Ÿåœ¨é“¾è¡¨è¿‡é•¿æ—¶ä¼šè½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚</p><h3 id="LinkedHashMap"><a href="#LinkedHashMap" class="headerlink" title="LinkedHashMap"></a>LinkedHashMap</h3><h4 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h4><p>ç»§æ‰¿è‡ª HashMapï¼Œå› æ­¤å…·æœ‰å’Œ HashMap ä¸€æ ·çš„å¿«é€ŸæŸ¥æ‰¾ç‰¹æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedHashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”¨æ¥ç»´æŠ¤æ’å…¥é¡ºåºæˆ–è€… LRU é¡ºåºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The head (eldest) of the doubly linked list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The tail (youngest) of the doubly linked list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; tail;</span><br></pre></td></tr></table></figure><p>accessOrder å†³å®šäº†é¡ºåºï¼Œé»˜è®¤ä¸º falseï¼Œæ­¤æ—¶ç»´æŠ¤çš„æ˜¯æ’å…¥é¡ºåºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> accessOrder;</span><br></pre></td></tr></table></figure><p>LinkedHashMap æœ€é‡è¦çš„æ˜¯ä»¥ä¸‹ç”¨äºç»´æŠ¤é¡ºåºçš„å‡½æ•°ï¼Œå®ƒä»¬ä¼šåœ¨ putã€get ç­‰æ–¹æ³•ä¸­è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; p)</span> &#123; &#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">afterNodeInsertion</span><span class="params">(<span class="type">boolean</span> evict)</span> &#123; &#125;</span><br></pre></td></tr></table></figure><h4 id="afterNodeAccess"><a href="#afterNodeAccess" class="headerlink" title="afterNodeAccess()"></a>afterNodeAccess()</h4><p>å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«è®¿é—®æ—¶ï¼Œå¦‚æœ accessOrder ä¸º trueï¼Œåˆ™ä¼šå°†è¯¥èŠ‚ç‚¹ç§»åˆ°é“¾è¡¨å°¾éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´æŒ‡å®šä¸º LRU é¡ºåºä¹‹åï¼Œåœ¨æ¯æ¬¡è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šå°†è¿™ä¸ªèŠ‚ç‚¹ç§»åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œä¿è¯é“¾è¡¨å°¾éƒ¨æ˜¯æœ€è¿‘è®¿é—®çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé“¾è¡¨é¦–éƒ¨å°±æ˜¯æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> &#123; <span class="comment">// move node to last</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</span><br><span class="line">    <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;</span><br><span class="line">        LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">            (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</span><br><span class="line">        p.after = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">null</span>)</span><br><span class="line">            head = a;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            b.after = a;</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="literal">null</span>)</span><br><span class="line">            a.before = b;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            last = b;</span><br><span class="line">        <span class="keyword">if</span> (last == <span class="literal">null</span>)</span><br><span class="line">            head = p;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            p.before = last;</span><br><span class="line">            last.after = p;</span><br><span class="line">        &#125;</span><br><span class="line">        tail = p;</span><br><span class="line">        ++modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="afterNodeInsertion"><a href="#afterNodeInsertion" class="headerlink" title="afterNodeInsertion()"></a>afterNodeInsertion()</h4><p>åœ¨ put ç­‰æ“ä½œä¹‹åæ‰§è¡Œï¼Œå½“ removeEldestEntry() æ–¹æ³•è¿”å› true æ—¶ä¼šç§»é™¤æœ€æ™šçš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨é¦–éƒ¨èŠ‚ç‚¹ firstã€‚</p><p>evict åªæœ‰åœ¨æ„å»º Map çš„æ—¶å€™æ‰ä¸º falseï¼Œåœ¨è¿™é‡Œä¸º trueã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterNodeInsertion</span><span class="params">(<span class="type">boolean</span> evict)</span> &#123; <span class="comment">// possibly remove eldest</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</span><br><span class="line">    <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="literal">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> first.key;</span><br><span class="line">        removeNode(hash(key), key, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>removeEldestEntry() é»˜è®¤ä¸º falseï¼Œå¦‚æœéœ€è¦è®©å®ƒä¸º trueï¼Œéœ€è¦ç»§æ‰¿ LinkedHashMap å¹¶ä¸”è¦†ç›–è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œè¿™åœ¨å®ç° LRU çš„ç¼“å­˜ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œé€šè¿‡ç§»é™¤æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯ç¼“å­˜ç©ºé—´è¶³å¤Ÿï¼Œå¹¶ä¸”ç¼“å­˜çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="LRU-ç¼“å­˜"><a href="#LRU-ç¼“å­˜" class="headerlink" title="LRU ç¼“å­˜"></a>LRU ç¼“å­˜</h4><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ LinkedHashMap å®ç°çš„ä¸€ä¸ª LRU ç¼“å­˜ï¼š</p><ul><li>è®¾å®šæœ€å¤§ç¼“å­˜ç©ºé—´ MAX_ENTRIES  ä¸º 3ï¼›</li><li>ä½¿ç”¨ LinkedHashMap çš„æ„é€ å‡½æ•°å°† accessOrder è®¾ç½®ä¸º trueï¼Œå¼€å¯ LRU é¡ºåºï¼›</li><li>è¦†ç›– removeEldestEntry() æ–¹æ³•å®ç°ï¼Œåœ¨èŠ‚ç‚¹å¤šäº MAX_ENTRIES å°±ä¼šå°†æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®ç§»é™¤ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">LinkedHashMap</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ENTRIES</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">removeEldestEntry</span><span class="params">(Map.Entry eldest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size() &gt; MAX_ENTRIES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LRUCache() &#123;</span><br><span class="line">        <span class="built_in">super</span>(MAX_ENTRIES, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    LRUCache&lt;Integer, String&gt; cache = <span class="keyword">new</span> <span class="title class_">LRUCache</span>&lt;&gt;();</span><br><span class="line">    cache.put(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">    cache.put(<span class="number">2</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">    cache.put(<span class="number">3</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line">    cache.get(<span class="number">1</span>);</span><br><span class="line">    cache.put(<span class="number">4</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">    System.out.println(cache.keySet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[3, 1, 4]</span><br></pre></td></tr></table></figure><h3 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h3><h4 id="å­˜å‚¨ç»“æ„-1"><a href="#å­˜å‚¨ç»“æ„-1" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h4><p>WeakHashMap çš„ Entry ç»§æ‰¿è‡ª WeakReferenceï¼Œè¢« WeakReference å…³è”çš„å¯¹è±¡åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶ä¼šè¢«å›æ”¶ã€‚</p><p>WeakHashMap ä¸»è¦ç”¨æ¥å®ç°ç¼“å­˜ï¼Œé€šè¿‡ä½¿ç”¨ WeakHashMap æ¥å¼•ç”¨ç¼“å­˜å¯¹è±¡ï¼Œç”± JVM å¯¹è¿™éƒ¨åˆ†ç¼“å­˜è¿›è¡Œå›æ”¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;Object&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt;</span><br></pre></td></tr></table></figure><h4 id="ConcurrentCache"><a href="#ConcurrentCache" class="headerlink" title="ConcurrentCache"></a>ConcurrentCache</h4><p>Tomcat ä¸­çš„ ConcurrentCache ä½¿ç”¨äº† WeakHashMap æ¥å®ç°ç¼“å­˜åŠŸèƒ½ã€‚</p><p>ConcurrentCache é‡‡å–çš„æ˜¯åˆ†ä»£ç¼“å­˜ï¼š</p><ul><li>ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡æ”¾å…¥ eden ä¸­ï¼Œeden ä½¿ç”¨ ConcurrentHashMap å®ç°ï¼Œä¸ç”¨æ‹…å¿ƒä¼šè¢«å›æ”¶ï¼ˆä¼Šç”¸å›­ï¼‰ï¼›</li><li>ä¸å¸¸ç”¨çš„å¯¹è±¡æ”¾å…¥ longtermï¼Œlongterm ä½¿ç”¨ WeakHashMap å®ç°ï¼Œè¿™äº›è€å¯¹è±¡ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚</li><li>å½“è°ƒç”¨  get() æ–¹æ³•æ—¶ï¼Œä¼šå…ˆä» eden åŒºè·å–ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯å†åˆ° longterm è·å–ï¼Œå½“ä» longterm è·å–åˆ°å°±æŠŠå¯¹è±¡æ”¾å…¥ eden ä¸­ï¼Œä»è€Œä¿è¯ç»å¸¸è¢«è®¿é—®çš„èŠ‚ç‚¹ä¸å®¹æ˜“è¢«å›æ”¶ã€‚</li><li>å½“è°ƒç”¨ put() æ–¹æ³•æ—¶ï¼Œå¦‚æœ eden çš„å¤§å°è¶…è¿‡äº† sizeï¼Œé‚£ä¹ˆå°±å°† eden ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ”¾å…¥ longterm ä¸­ï¼Œåˆ©ç”¨è™šæ‹Ÿæœºå›æ”¶æ‰ä¸€éƒ¨åˆ†ä¸ç»å¸¸ä½¿ç”¨çš„å¯¹è±¡ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ConcurrentCache</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; eden;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; longterm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConcurrentCache</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        <span class="built_in">this</span>.eden = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(size);</span><br><span class="line">        <span class="built_in">this</span>.longterm = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K k)</span> &#123;</span><br><span class="line">        <span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> <span class="built_in">this</span>.eden.get(k);</span><br><span class="line">        <span class="keyword">if</span> (v == <span class="literal">null</span>) &#123;</span><br><span class="line">            v = <span class="built_in">this</span>.longterm.get(k);</span><br><span class="line">            <span class="keyword">if</span> (v != <span class="literal">null</span>)</span><br><span class="line">                <span class="built_in">this</span>.eden.put(k, v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K k, V v)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.eden.size() &gt;= size) &#123;</span><br><span class="line">            <span class="built_in">this</span>.longterm.putAll(<span class="built_in">this</span>.eden);</span><br><span class="line">            <span class="built_in">this</span>.eden.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.eden.put(k, v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>Eckel B. Java ç¼–ç¨‹æ€æƒ³ [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2002.</li><li><a href="https://www.w3resource.com/java-tutorial/java-collections.php">Java Collection Framework</a></li><li><a href="https://openhome.cc/Gossip/DesignPattern/IteratorPattern.htm">Iterator æ¨¡å¼</a></li><li><a href="https://tech.meituan.com/java_hashmap.html">Java 8 ç³»åˆ—ä¹‹é‡æ–°è®¤è¯† HashMap</a></li><li><a href="http://javarevisited.blogspot.hk/2010/10/difference-between-hashmap-and.html">What is difference between HashMap and Hashtable in Java?</a></li><li><a href="http://www.zhangchangle.com/2018/02/07/Java%E9%9B%86%E5%90%88%E4%B9%8BHashMap/">Java é›†åˆä¹‹ HashMap</a></li><li><a href="http://www.programering.com/a/MDO3QDNwATM.html">The principle of ConcurrentHashMap analysis</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/java-lo-concurrenthashmap/">æ¢ç´¢ ConcurrentHashMap é«˜å¹¶å‘æ€§çš„å®ç°æœºåˆ¶</a></li><li><a href="https://www.jianshu.com/p/75adf47958a7">HashMap ç›¸å…³é¢è¯•é¢˜åŠå…¶è§£ç­”</a></li><li><a href="http://wiki.jikexueyuan.com/project/java-enhancement/java-thirtysix.html">Java é›†åˆç»†èŠ‚ï¼ˆäºŒï¼‰ï¼šasList çš„ç¼ºé™·</a></li><li><a href="http://javaconceptoftheday.com/java-collection-framework-linkedlist-class/">Java Collection Framework â€“ The LinkedList Class</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ java å®¹å™¨çš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="Map" scheme="https://www.jodio.cc/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>Java NIOçš„æ“ä½œ</title>
    <link href="https://www.jodio.cc/posts/ee9c.html"/>
    <id>https://www.jodio.cc/posts/ee9c.html</id>
    <published>2023-04-08T20:11:12.000Z</published>
    <updated>2023-04-21T02:16:29.126Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-IO"><a href="#Java-IO" class="headerlink" title="Java IO"></a>Java IO</h1><h2 id="ä¸€ã€æ¦‚è§ˆ"><a href="#ä¸€ã€æ¦‚è§ˆ" class="headerlink" title="ä¸€ã€æ¦‚è§ˆ"></a>ä¸€ã€æ¦‚è§ˆ</h2><p>Java çš„ I/O å¤§æ¦‚å¯ä»¥åˆ†æˆä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li>ç£ç›˜æ“ä½œï¼šFile</li><li>å­—èŠ‚æ“ä½œï¼šInputStream å’Œ OutputStream</li><li>å­—ç¬¦æ“ä½œï¼šReader å’Œ Writer</li><li>å¯¹è±¡æ“ä½œï¼šSerializable</li><li>ç½‘ç»œæ“ä½œï¼šSocket</li><li>æ–°çš„è¾“å…¥/è¾“å‡ºï¼šNIO</li></ul><h2 id="äºŒã€ç£ç›˜æ“ä½œ"><a href="#äºŒã€ç£ç›˜æ“ä½œ" class="headerlink" title="äºŒã€ç£ç›˜æ“ä½œ"></a>äºŒã€ç£ç›˜æ“ä½œ</h2><p>File ç±»å¯ä»¥ç”¨äºè¡¨ç¤ºæ–‡ä»¶å’Œç›®å½•çš„ä¿¡æ¯ï¼Œä½†æ˜¯å®ƒä¸è¡¨ç¤ºæ–‡ä»¶çš„å†…å®¹ã€‚</p><p>é€’å½’åœ°åˆ—å‡ºä¸€ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">listAllFiles</span><span class="params">(File dir)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">null</span> || !dir.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dir.isFile()) &#123;</span><br><span class="line">        System.out.println(dir.getName());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (File file : dir.listFiles()) &#123;</span><br><span class="line">        listAllFiles(file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» Java7 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ Paths å’Œ Files ä»£æ›¿ Fileã€‚</p><h2 id="ä¸‰ã€å­—èŠ‚æ“ä½œ"><a href="#ä¸‰ã€å­—èŠ‚æ“ä½œ" class="headerlink" title="ä¸‰ã€å­—èŠ‚æ“ä½œ"></a>ä¸‰ã€å­—èŠ‚æ“ä½œ</h2><h3 id="å®ç°æ–‡ä»¶å¤åˆ¶"><a href="#å®ç°æ–‡ä»¶å¤åˆ¶" class="headerlink" title="å®ç°æ–‡ä»¶å¤åˆ¶"></a>å®ç°æ–‡ä»¶å¤åˆ¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(String src, String dist)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dist);</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">20</span> * <span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> cnt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read() æœ€å¤šè¯»å– buffer.length ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="comment">// è¿”å›çš„æ˜¯å®é™…è¯»å–çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">// è¿”å› -1 çš„æ—¶å€™è¡¨ç¤ºè¯»åˆ° eofï¼Œå³æ–‡ä»¶å°¾</span></span><br><span class="line">    <span class="keyword">while</span> ((cnt = in.read(buffer, <span class="number">0</span>, buffer.length)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        out.write(buffer, <span class="number">0</span>, cnt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in.close();</span><br><span class="line">    out.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è£…é¥°è€…æ¨¡å¼"><a href="#è£…é¥°è€…æ¨¡å¼" class="headerlink" title="è£…é¥°è€…æ¨¡å¼"></a>è£…é¥°è€…æ¨¡å¼</h3><p>Java I/O ä½¿ç”¨äº†è£…é¥°è€…æ¨¡å¼æ¥å®ç°ã€‚ä»¥ InputStream ä¸ºä¾‹ï¼Œ</p><ul><li>InputStream æ˜¯æŠ½è±¡ç»„ä»¶ï¼›</li><li>FileInputStream æ˜¯ InputStream çš„å­ç±»ï¼Œå±äºå…·ä½“ç»„ä»¶ï¼Œæä¾›äº†å­—èŠ‚æµçš„è¾“å…¥æ“ä½œï¼›</li><li>FilterInputStream å±äºæŠ½è±¡è£…é¥°è€…ï¼Œè£…é¥°è€…ç”¨äºè£…é¥°ç»„ä»¶ï¼Œä¸ºç»„ä»¶æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ BufferedInputStream ä¸º FileInputStream æä¾›ç¼“å­˜çš„åŠŸèƒ½ã€‚</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9709694b-db05-4cce-8d2f-1c8b09f4d921.png" width="650px"> </div><br></p><p>å®ä¾‹åŒ–ä¸€ä¸ªå…·æœ‰ç¼“å­˜åŠŸèƒ½çš„å­—èŠ‚æµå¯¹è±¡æ—¶ï¼Œåªéœ€è¦åœ¨ FileInputStream å¯¹è±¡ä¸Šå†å¥—ä¸€å±‚ BufferedInputStream å¯¹è±¡å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath);</span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(fileInputStream);</span><br></pre></td></tr></table></figure><p>DataInputStream è£…é¥°è€…æä¾›äº†å¯¹æ›´å¤šæ•°æ®ç±»å‹è¿›è¡Œè¾“å…¥çš„æ“ä½œï¼Œæ¯”å¦‚ intã€double ç­‰åŸºæœ¬ç±»å‹ã€‚</p><h2 id="å››ã€å­—ç¬¦æ“ä½œ"><a href="#å››ã€å­—ç¬¦æ“ä½œ" class="headerlink" title="å››ã€å­—ç¬¦æ“ä½œ"></a>å››ã€å­—ç¬¦æ“ä½œ</h2><h3 id="ç¼–ç ä¸è§£ç "><a href="#ç¼–ç ä¸è§£ç " class="headerlink" title="ç¼–ç ä¸è§£ç "></a>ç¼–ç ä¸è§£ç </h3><p>ç¼–ç å°±æ˜¯æŠŠå­—ç¬¦è½¬æ¢ä¸ºå­—èŠ‚ï¼Œè€Œè§£ç æ˜¯æŠŠå­—èŠ‚é‡æ–°ç»„åˆæˆå­—ç¬¦ã€‚</p><p>å¦‚æœç¼–ç å’Œè§£ç è¿‡ç¨‹ä½¿ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼é‚£ä¹ˆå°±å‡ºç°äº†ä¹±ç ã€‚</p><ul><li>GBK ç¼–ç ä¸­ï¼Œä¸­æ–‡å­—ç¬¦å  2 ä¸ªå­—èŠ‚ï¼Œè‹±æ–‡å­—ç¬¦å  1 ä¸ªå­—èŠ‚ï¼›</li><li>UTF-8 ç¼–ç ä¸­ï¼Œä¸­æ–‡å­—ç¬¦å  3 ä¸ªå­—èŠ‚ï¼Œè‹±æ–‡å­—ç¬¦å  1 ä¸ªå­—èŠ‚ï¼›</li><li>UTF-16be ç¼–ç ä¸­ï¼Œä¸­æ–‡å­—ç¬¦å’Œè‹±æ–‡å­—ç¬¦éƒ½å  2 ä¸ªå­—èŠ‚ã€‚</li></ul><p>UTF-16be ä¸­çš„ be æŒ‡çš„æ˜¯ Big Endianï¼Œä¹Ÿå°±æ˜¯å¤§ç«¯ã€‚ç›¸åº”åœ°ä¹Ÿæœ‰ UTF-16leï¼Œle æŒ‡çš„æ˜¯ Little Endianï¼Œä¹Ÿå°±æ˜¯å°ç«¯ã€‚</p><p>Java çš„å†…å­˜ç¼–ç ä½¿ç”¨åŒå­—èŠ‚ç¼–ç  UTF-16beï¼Œè¿™ä¸æ˜¯æŒ‡ Java åªæ”¯æŒè¿™ä¸€ç§ç¼–ç æ–¹å¼ï¼Œè€Œæ˜¯è¯´ char è¿™ç§ç±»å‹ä½¿ç”¨ UTF-16be è¿›è¡Œç¼–ç ã€‚char ç±»å‹å  16 ä½ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼ŒJava ä½¿ç”¨è¿™ç§åŒå­—èŠ‚ç¼–ç æ˜¯ä¸ºäº†è®©ä¸€ä¸ªä¸­æ–‡æˆ–è€…ä¸€ä¸ªè‹±æ–‡éƒ½èƒ½ä½¿ç”¨ä¸€ä¸ª char æ¥å­˜å‚¨ã€‚</p><h3 id="String-çš„ç¼–ç æ–¹å¼"><a href="#String-çš„ç¼–ç æ–¹å¼" class="headerlink" title="String çš„ç¼–ç æ–¹å¼"></a>String çš„ç¼–ç æ–¹å¼</h3><p>String å¯ä»¥çœ‹æˆä¸€ä¸ªå­—ç¬¦åºåˆ—ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªç¼–ç æ–¹å¼å°†å®ƒç¼–ç ä¸ºå­—èŠ‚åºåˆ—ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªç¼–ç æ–¹å¼å°†ä¸€ä¸ªå­—èŠ‚åºåˆ—è§£ç ä¸º Stringã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">&quot;ä¸­æ–‡&quot;</span>;</span><br><span class="line"><span class="type">byte</span>[] bytes = str1.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">System.out.println(str2);</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨æ— å‚æ•° getBytes() æ–¹æ³•æ—¶ï¼Œé»˜è®¤çš„ç¼–ç æ–¹å¼ä¸æ˜¯ UTF-16beã€‚åŒå­—èŠ‚ç¼–ç çš„å¥½å¤„æ˜¯å¯ä»¥ä½¿ç”¨ä¸€ä¸ª char å­˜å‚¨ä¸­æ–‡å’Œè‹±æ–‡ï¼Œè€Œå°† String è½¬ä¸º bytes[] å­—èŠ‚æ•°ç»„å°±ä¸å†éœ€è¦è¿™ä¸ªå¥½å¤„ï¼Œå› æ­¤ä¹Ÿå°±ä¸å†éœ€è¦åŒå­—èŠ‚ç¼–ç ã€‚getBytes() çš„é»˜è®¤ç¼–ç æ–¹å¼ä¸å¹³å°æœ‰å…³ï¼Œä¸€èˆ¬ä¸º UTF-8ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = str1.getBytes();</span><br></pre></td></tr></table></figure><h3 id="Reader-ä¸-Writer"><a href="#Reader-ä¸-Writer" class="headerlink" title="Reader ä¸ Writer"></a>Reader ä¸ Writer</h3><p>ä¸ç®¡æ˜¯ç£ç›˜è¿˜æ˜¯ç½‘ç»œä¼ è¾“ï¼Œæœ€å°çš„å­˜å‚¨å•å…ƒéƒ½æ˜¯å­—èŠ‚ï¼Œè€Œä¸æ˜¯å­—ç¬¦ã€‚ä½†æ˜¯åœ¨ç¨‹åºä¸­æ“ä½œçš„é€šå¸¸æ˜¯å­—ç¬¦å½¢å¼çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦æä¾›å¯¹å­—ç¬¦è¿›è¡Œæ“ä½œçš„æ–¹æ³•ã€‚</p><ul><li>InputStreamReader å®ç°ä»å­—èŠ‚æµè§£ç æˆå­—ç¬¦æµï¼›</li><li>OutputStreamWriter å®ç°å­—ç¬¦æµç¼–ç æˆä¸ºå­—èŠ‚æµã€‚</li></ul><h3 id="å®ç°é€è¡Œè¾“å‡ºæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹"><a href="#å®ç°é€è¡Œè¾“å‡ºæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹" class="headerlink" title="å®ç°é€è¡Œè¾“å‡ºæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹"></a>å®ç°é€è¡Œè¾“å‡ºæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">readFileContent</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(filePath);</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fileReader);</span><br><span class="line"></span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è£…é¥°è€…æ¨¡å¼ä½¿å¾— BufferedReader ç»„åˆäº†ä¸€ä¸ª Reader å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// åœ¨è°ƒç”¨ BufferedReader çš„ close() æ–¹æ³•æ—¶ä¼šå»è°ƒç”¨ Reader çš„ close() æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å› æ­¤åªè¦ä¸€ä¸ª close() è°ƒç”¨å³å¯</span></span><br><span class="line">    bufferedReader.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€å¯¹è±¡æ“ä½œ"><a href="#äº”ã€å¯¹è±¡æ“ä½œ" class="headerlink" title="äº”ã€å¯¹è±¡æ“ä½œ"></a>äº”ã€å¯¹è±¡æ“ä½œ</h2><h3 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h3><p>åºåˆ—åŒ–å°±æ˜¯å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆå­—èŠ‚åºåˆ—ï¼Œæ–¹ä¾¿å­˜å‚¨å’Œä¼ è¾“ã€‚</p><ul><li>åºåˆ—åŒ–ï¼šObjectOutputStream.writeObject()</li><li>ååºåˆ—åŒ–ï¼šObjectInputStream.readObject()</li></ul><p>ä¸ä¼šå¯¹é™æ€å˜é‡è¿›è¡Œåºåˆ—åŒ–ï¼Œå› ä¸ºåºåˆ—åŒ–åªæ˜¯ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œé™æ€å˜é‡å±äºç±»çš„çŠ¶æ€ã€‚</p><h3 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h3><p>åºåˆ—åŒ–çš„ç±»éœ€è¦å®ç° Serializable æ¥å£ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œæ²¡æœ‰ä»»ä½•æ–¹æ³•éœ€è¦å®ç°ï¼Œä½†æ˜¯å¦‚æœä¸å»å®ç°å®ƒçš„è¯è€Œè¿›è¡Œåºåˆ—åŒ–ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">A</span> <span class="variable">a1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>(<span class="number">123</span>, <span class="string">&quot;abc&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">objectFile</span> <span class="operator">=</span> <span class="string">&quot;file/a1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(objectFile));</span><br><span class="line">    objectOutputStream.writeObject(a1);</span><br><span class="line">    objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(objectFile));</span><br><span class="line">    <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> (A) objectInputStream.readObject();</span><br><span class="line">    objectInputStream.close();</span><br><span class="line">    System.out.println(a2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> String y;</span><br><span class="line"></span><br><span class="line">    A(<span class="type">int</span> x, String y) &#123;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;x = &quot;</span> + x + <span class="string">&quot;  &quot;</span> + <span class="string">&quot;y = &quot;</span> + y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="transient"><a href="#transient" class="headerlink" title="transient"></a>transient</h3><p>transient å…³é”®å­—å¯ä»¥ä½¿ä¸€äº›å±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚</p><p>ArrayList ä¸­å­˜å‚¨æ•°æ®çš„æ•°ç»„ elementData æ˜¯ç”¨ transient ä¿®é¥°çš„ï¼Œå› ä¸ºè¿™ä¸ªæ•°ç»„æ˜¯åŠ¨æ€æ‰©å±•çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç©ºé—´éƒ½è¢«ä½¿ç”¨ï¼Œå› æ­¤å°±ä¸éœ€è¦æ‰€æœ‰çš„å†…å®¹éƒ½è¢«åºåˆ—åŒ–ã€‚é€šè¿‡é‡å†™åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•ï¼Œä½¿å¾—å¯ä»¥åªåºåˆ—åŒ–æ•°ç»„ä¸­æœ‰å†…å®¹çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Object[] elementData;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€ç½‘ç»œæ“ä½œ"><a href="#å…­ã€ç½‘ç»œæ“ä½œ" class="headerlink" title="å…­ã€ç½‘ç»œæ“ä½œ"></a>å…­ã€ç½‘ç»œæ“ä½œ</h2><p>Java ä¸­çš„ç½‘ç»œæ”¯æŒï¼š</p><ul><li>InetAddressï¼šç”¨äºè¡¨ç¤ºç½‘ç»œä¸Šçš„ç¡¬ä»¶èµ„æºï¼Œå³ IP åœ°å€ï¼›</li><li>URLï¼šç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼›</li><li>Socketsï¼šä½¿ç”¨ TCP åè®®å®ç°ç½‘ç»œé€šä¿¡ï¼›</li><li>Datagramï¼šä½¿ç”¨ UDP åè®®å®ç°ç½‘ç»œé€šä¿¡ã€‚</li></ul><h3 id="InetAddress"><a href="#InetAddress" class="headerlink" title="InetAddress"></a>InetAddress</h3><p>æ²¡æœ‰å…¬æœ‰çš„æ„é€ å‡½æ•°ï¼Œåªèƒ½é€šè¿‡é™æ€æ–¹æ³•æ¥åˆ›å»ºå®ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InetAddress.getByName(String host);</span><br><span class="line">InetAddress.getByAddress(<span class="type">byte</span>[] address);</span><br></pre></td></tr></table></figure><h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><p>å¯ä»¥ç›´æ¥ä» URL ä¸­è¯»å–å­—èŠ‚æµæ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å­—èŠ‚æµ */</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> url.openStream();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å­—ç¬¦æµ */</span></span><br><span class="line">    <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æä¾›ç¼“å­˜åŠŸèƒ½ */</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(isr);</span><br><span class="line"></span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    br.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Sockets"><a href="#Sockets" class="headerlink" title="Sockets"></a>Sockets</h3><ul><li>ServerSocketï¼šæœåŠ¡å™¨ç«¯ç±»</li><li>Socketï¼šå®¢æˆ·ç«¯ç±»</li><li>æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šè¿‡ InputStream å’Œ OutputStream è¿›è¡Œè¾“å…¥è¾“å‡ºã€‚</li></ul><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1e6affc4-18e5-4596-96ef-fb84c63bf88a.png" width="550px"> </div><br></p><h3 id="Datagram"><a href="#Datagram" class="headerlink" title="Datagram"></a>Datagram</h3><ul><li>DatagramSocketï¼šé€šä¿¡ç±»</li><li>DatagramPacketï¼šæ•°æ®åŒ…ç±»</li></ul><h2 id="ä¸ƒã€NIO"><a href="#ä¸ƒã€NIO" class="headerlink" title="ä¸ƒã€NIO"></a>ä¸ƒã€NIO</h2><p>æ–°çš„è¾“å…¥/è¾“å‡º (NIO) åº“æ˜¯åœ¨ JDK 1.4 ä¸­å¼•å…¥çš„ï¼Œå¼¥è¡¥äº†åŸæ¥çš„ I/O çš„ä¸è¶³ï¼Œæä¾›äº†é«˜é€Ÿçš„ã€é¢å‘å—çš„ I/Oã€‚</p><h3 id="æµä¸å—"><a href="#æµä¸å—" class="headerlink" title="æµä¸å—"></a>æµä¸å—</h3><p>I/O ä¸ NIO æœ€é‡è¦çš„åŒºåˆ«æ˜¯æ•°æ®æ‰“åŒ…å’Œä¼ è¾“çš„æ–¹å¼ï¼ŒI/O ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œ NIO ä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ã€‚</p><p>é¢å‘æµçš„ I/O ä¸€æ¬¡å¤„ç†ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼šä¸€ä¸ªè¾“å…¥æµäº§ç”Ÿä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œä¸€ä¸ªè¾“å‡ºæµæ¶ˆè´¹ä¸€ä¸ªå­—èŠ‚æ•°æ®ã€‚ä¸ºæµå¼æ•°æ®åˆ›å»ºè¿‡æ»¤å™¨éå¸¸å®¹æ˜“ï¼Œé“¾æ¥å‡ ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥ä¾¿æ¯ä¸ªè¿‡æ»¤å™¨åªè´Ÿè´£å¤æ‚å¤„ç†æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚ä¸åˆ©çš„ä¸€é¢æ˜¯ï¼Œé¢å‘æµçš„ I/O é€šå¸¸ç›¸å½“æ…¢ã€‚</p><p>é¢å‘å—çš„ I/O ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ•°æ®å—ï¼ŒæŒ‰å—å¤„ç†æ•°æ®æ¯”æŒ‰æµå¤„ç†æ•°æ®è¦å¿«å¾—å¤šã€‚ä½†æ˜¯é¢å‘å—çš„ I/O ç¼ºå°‘ä¸€äº›é¢å‘æµçš„ I/O æ‰€å…·æœ‰çš„ä¼˜é›…æ€§å’Œç®€å•æ€§ã€‚</p><p>I/O åŒ…å’Œ NIO å·²ç»å¾ˆå¥½åœ°é›†æˆäº†ï¼Œjava.io.* å·²ç»ä»¥ NIO ä¸ºåŸºç¡€é‡æ–°å®ç°äº†ï¼Œæ‰€ä»¥ç°åœ¨å®ƒå¯ä»¥åˆ©ç”¨ NIO çš„ä¸€äº›ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œjava.io.* åŒ…ä¸­çš„ä¸€äº›ç±»åŒ…å«ä»¥å—çš„å½¢å¼è¯»å†™æ•°æ®çš„æ–¹æ³•ï¼Œè¿™ä½¿å¾—å³ä½¿åœ¨é¢å‘æµçš„ç³»ç»Ÿä¸­ï¼Œå¤„ç†é€Ÿåº¦ä¹Ÿä¼šæ›´å¿«ã€‚</p><h3 id="é€šé“ä¸ç¼“å†²åŒº"><a href="#é€šé“ä¸ç¼“å†²åŒº" class="headerlink" title="é€šé“ä¸ç¼“å†²åŒº"></a>é€šé“ä¸ç¼“å†²åŒº</h3><h4 id="1-é€šé“"><a href="#1-é€šé“" class="headerlink" title="1. é€šé“"></a>1. é€šé“</h4><p>é€šé“ Channel æ˜¯å¯¹åŸ I/O åŒ…ä¸­çš„æµçš„æ¨¡æ‹Ÿï¼Œå¯ä»¥é€šè¿‡å®ƒè¯»å–å’Œå†™å…¥æ•°æ®ã€‚</p><p>é€šé“ä¸æµçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œæµåªèƒ½åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šç§»åŠ¨(ä¸€ä¸ªæµå¿…é¡»æ˜¯ InputStream æˆ–è€… OutputStream çš„å­ç±»)ï¼Œè€Œé€šé“æ˜¯åŒå‘çš„ï¼Œå¯ä»¥ç”¨äºè¯»ã€å†™æˆ–è€…åŒæ—¶ç”¨äºè¯»å†™ã€‚</p><p>é€šé“åŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š</p><ul><li>FileChannelï¼šä»æ–‡ä»¶ä¸­è¯»å†™æ•°æ®ï¼›</li><li>DatagramChannelï¼šé€šè¿‡ UDP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›</li><li>SocketChannelï¼šé€šè¿‡ TCP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›</li><li>ServerSocketChannelï¼šå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„ TCP è¿æ¥ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ª SocketChannelã€‚</li></ul><h4 id="2-ç¼“å†²åŒº"><a href="#2-ç¼“å†²åŒº" class="headerlink" title="2. ç¼“å†²åŒº"></a>2. ç¼“å†²åŒº</h4><p>å‘é€ç»™ä¸€ä¸ªé€šé“çš„æ‰€æœ‰æ•°æ®éƒ½å¿…é¡»é¦–å…ˆæ”¾åˆ°ç¼“å†²åŒºä¸­ï¼ŒåŒæ ·åœ°ï¼Œä»é€šé“ä¸­è¯»å–çš„ä»»ä½•æ•°æ®éƒ½è¦å…ˆè¯»åˆ°ç¼“å†²åŒºä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šç›´æ¥å¯¹é€šé“è¿›è¡Œè¯»å†™æ•°æ®ï¼Œè€Œæ˜¯è¦å…ˆç»è¿‡ç¼“å†²åŒºã€‚</p><p>ç¼“å†²åŒºå®è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚ç¼“å†²åŒºæä¾›äº†å¯¹æ•°æ®çš„ç»“æ„åŒ–è®¿é—®ï¼Œè€Œä¸”è¿˜å¯ä»¥è·Ÿè¸ªç³»ç»Ÿçš„è¯»/å†™è¿›ç¨‹ã€‚</p><p>ç¼“å†²åŒºåŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š</p><ul><li>ByteBuffer</li><li>CharBuffer</li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li></ul><h3 id="ç¼“å†²åŒºçŠ¶æ€å˜é‡"><a href="#ç¼“å†²åŒºçŠ¶æ€å˜é‡" class="headerlink" title="ç¼“å†²åŒºçŠ¶æ€å˜é‡"></a>ç¼“å†²åŒºçŠ¶æ€å˜é‡</h3><ul><li>capacityï¼šæœ€å¤§å®¹é‡ï¼›</li><li>positionï¼šå½“å‰å·²ç»è¯»å†™çš„å­—èŠ‚æ•°ï¼›</li><li>limitï¼šè¿˜å¯ä»¥è¯»å†™çš„å­—èŠ‚æ•°ã€‚</li></ul><p>çŠ¶æ€å˜é‡çš„æ”¹å˜è¿‡ç¨‹ä¸¾ä¾‹ï¼š</p><p>â‘  æ–°å»ºä¸€ä¸ªå¤§å°ä¸º 8 ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºï¼Œæ­¤æ—¶ position ä¸º 0ï¼Œè€Œ limit = capacity = 8ã€‚capacity å˜é‡ä¸ä¼šæ”¹å˜ï¼Œä¸‹é¢çš„è®¨è®ºä¼šå¿½ç•¥å®ƒã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1bea398f-17a7-4f67-a90b-9e2d243eaa9a.png"/> </div><br></p><p>â‘¡ ä»è¾“å…¥é€šé“ä¸­è¯»å– 5 ä¸ªå­—èŠ‚æ•°æ®å†™å…¥ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ position ä¸º 5ï¼Œlimit ä¿æŒä¸å˜ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/80804f52-8815-4096-b506-48eef3eed5c6.png"/> </div><br></p><p>â‘¢ åœ¨å°†ç¼“å†²åŒºçš„æ•°æ®å†™åˆ°è¾“å‡ºé€šé“ä¹‹å‰ï¼Œéœ€è¦å…ˆè°ƒç”¨ flip() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°† limit è®¾ç½®ä¸ºå½“å‰ positionï¼Œå¹¶å°† position è®¾ç½®ä¸º 0ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/952e06bd-5a65-4cab-82e4-dd1536462f38.png"/> </div><br></p><p>â‘£ ä»ç¼“å†²åŒºä¸­å– 4 ä¸ªå­—èŠ‚åˆ°è¾“å‡ºç¼“å†²ä¸­ï¼Œæ­¤æ—¶ position è®¾ä¸º 4ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/b5bdcbe2-b958-4aef-9151-6ad963cb28b4.png"/> </div><br></p><p>â‘¤ æœ€åéœ€è¦è°ƒç”¨ clear() æ–¹æ³•æ¥æ¸…ç©ºç¼“å†²åŒºï¼Œæ­¤æ—¶ position å’Œ limit éƒ½è¢«è®¾ç½®ä¸ºæœ€åˆä½ç½®ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/67bf5487-c45d-49b6-b9c0-a058d8c68902.png"/> </div><br></p><h3 id="æ–‡ä»¶-NIO-å®ä¾‹"><a href="#æ–‡ä»¶-NIO-å®ä¾‹" class="headerlink" title="æ–‡ä»¶ NIO å®ä¾‹"></a>æ–‡ä»¶ NIO å®ä¾‹</h3><p>ä»¥ä¸‹å±•ç¤ºäº†ä½¿ç”¨ NIO å¿«é€Ÿå¤åˆ¶æ–‡ä»¶çš„å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fastCopy</span><span class="params">(String src, String dist)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å¾—æºæ–‡ä»¶çš„è¾“å…¥å­—èŠ‚æµ */</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–è¾“å…¥å­—èŠ‚æµçš„æ–‡ä»¶é€šé“ */</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">fcin</span> <span class="operator">=</span> fin.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–ç›®æ ‡æ–‡ä»¶çš„è¾“å‡ºå­—èŠ‚æµ */</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dist);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–è¾“å‡ºå­—èŠ‚æµçš„æ–‡ä»¶é€šé“ */</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">fcout</span> <span class="operator">=</span> fout.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¸ºç¼“å†²åŒºåˆ†é… 1024 ä¸ªå­—èŠ‚ */</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ä»è¾“å…¥é€šé“ä¸­è¯»å–æ•°æ®åˆ°ç¼“å†²åŒºä¸­ */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> fcin.read(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read() è¿”å› -1 è¡¨ç¤º EOF */</span></span><br><span class="line">        <span class="keyword">if</span> (r == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åˆ‡æ¢è¯»å†™ */</span></span><br><span class="line">        buffer.flip();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æŠŠç¼“å†²åŒºçš„å†…å®¹å†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­ */</span></span><br><span class="line">        fcout.write(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ¸…ç©ºç¼“å†²åŒº */</span></span><br><span class="line">        buffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€‰æ‹©å™¨"><a href="#é€‰æ‹©å™¨" class="headerlink" title="é€‰æ‹©å™¨"></a>é€‰æ‹©å™¨</h3><p>NIO å¸¸å¸¸è¢«å«åšéé˜»å¡ IOï¼Œä¸»è¦æ˜¯å› ä¸º NIO åœ¨ç½‘ç»œé€šä¿¡ä¸­çš„éé˜»å¡ç‰¹æ€§è¢«å¹¿æ³›ä½¿ç”¨ã€‚</p><p>NIO å®ç°äº† IO å¤šè·¯å¤ç”¨ä¸­çš„ Reactor æ¨¡å‹ï¼Œä¸€ä¸ªçº¿ç¨‹ Thread ä½¿ç”¨ä¸€ä¸ªé€‰æ‹©å™¨ Selector é€šè¿‡è½®è¯¢çš„æ–¹å¼å»ç›‘å¬å¤šä¸ªé€šé“ Channel ä¸Šçš„äº‹ä»¶ï¼Œä»è€Œè®©ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å¤„ç†å¤šä¸ªäº‹ä»¶ã€‚</p><p>é€šè¿‡é…ç½®ç›‘å¬çš„é€šé“ Channel ä¸ºéé˜»å¡ï¼Œé‚£ä¹ˆå½“ Channel ä¸Šçš„ IO äº‹ä»¶è¿˜æœªåˆ°è¾¾æ—¶ï¼Œå°±ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ä¸€ç›´ç­‰å¾…ï¼Œè€Œæ˜¯ç»§ç»­è½®è¯¢å…¶å®ƒ Channelï¼Œæ‰¾åˆ° IO äº‹ä»¶å·²ç»åˆ°è¾¾çš„ Channel æ‰§è¡Œã€‚</p><p>å› ä¸ºåˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹çš„å¼€é”€å¾ˆå¤§ï¼Œå› æ­¤ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªäº‹ä»¶è€Œä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªäº‹ä»¶ï¼Œå¯¹äº IO å¯†é›†å‹çš„åº”ç”¨å…·æœ‰å¾ˆå¥½åœ°æ€§èƒ½ã€‚</p><p>åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰å¥—æ¥å­— Channel æ‰èƒ½é…ç½®ä¸ºéé˜»å¡ï¼Œè€Œ FileChannel ä¸èƒ½ï¼Œä¸º FileChannel é…ç½®éé˜»å¡ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚</p><p><div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/093f9e57-429c-413a-83ee-c689ba596cef.png" width="350px"> </div><br></p><h4 id="1-åˆ›å»ºé€‰æ‹©å™¨"><a href="#1-åˆ›å»ºé€‰æ‹©å™¨" class="headerlink" title="1. åˆ›å»ºé€‰æ‹©å™¨"></a>1. åˆ›å»ºé€‰æ‹©å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br></pre></td></tr></table></figure><h4 id="2-å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š"><a href="#2-å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š" class="headerlink" title="2. å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š"></a>2. å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">ssChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">ssChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">ssChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br></pre></td></tr></table></figure><p>é€šé“å¿…é¡»é…ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¦åˆ™ä½¿ç”¨é€‰æ‹©å™¨å°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†ï¼Œå› ä¸ºå¦‚æœé€šé“åœ¨æŸä¸ªäº‹ä»¶ä¸Šè¢«é˜»å¡ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¸èƒ½å“åº”å…¶å®ƒäº‹ä»¶ï¼Œå¿…é¡»ç­‰å¾…è¿™ä¸ªäº‹ä»¶å¤„ç†å®Œæ¯•æ‰èƒ½å»å¤„ç†å…¶å®ƒäº‹ä»¶ï¼Œæ˜¾ç„¶è¿™å’Œé€‰æ‹©å™¨çš„ä½œç”¨èƒŒé“è€Œé©°ã€‚</p><p>åœ¨å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šè¦æ³¨å†Œçš„å…·ä½“äº‹ä»¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li>SelectionKey.OP_CONNECT</li><li>SelectionKey.OP_ACCEPT</li><li>SelectionKey.OP_READ</li><li>SelectionKey.OP_WRITE</li></ul><p>å®ƒä»¬åœ¨ SelectionKey çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_READ</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_WRITE</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_CONNECT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_ACCEPT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¯ä¸ªäº‹ä»¶å¯ä»¥è¢«å½“æˆä¸€ä¸ªä½åŸŸï¼Œä»è€Œç»„æˆäº‹ä»¶é›†æ•´æ•°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">interestSet</span> <span class="operator">=</span> SelectionKey.OP_READ | SelectionKey.OP_WRITE;</span><br></pre></td></tr></table></figure><h4 id="3-ç›‘å¬äº‹ä»¶"><a href="#3-ç›‘å¬äº‹ä»¶" class="headerlink" title="3. ç›‘å¬äº‹ä»¶"></a>3. ç›‘å¬äº‹ä»¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> selector.select();</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ select() æ¥ç›‘å¬åˆ°è¾¾çš„äº‹ä»¶ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰è‡³å°‘ä¸€ä¸ªäº‹ä»¶åˆ°è¾¾ã€‚</p><h4 id="4-è·å–åˆ°è¾¾çš„äº‹ä»¶"><a href="#4-è·å–åˆ°è¾¾çš„äº‹ä»¶" class="headerlink" title="4. è·å–åˆ°è¾¾çš„äº‹ä»¶"></a>4. è·å–åˆ°è¾¾çš„äº‹ä»¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">Iterator&lt;SelectionKey&gt; keyIterator = keys.iterator();</span><br><span class="line"><span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line">    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    keyIterator.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-äº‹ä»¶å¾ªç¯"><a href="#5-äº‹ä»¶å¾ªç¯" class="headerlink" title="5. äº‹ä»¶å¾ªç¯"></a>5. äº‹ä»¶å¾ªç¯</h4><p>å› ä¸ºä¸€æ¬¡ select() è°ƒç”¨ä¸èƒ½å¤„ç†å®Œæ‰€æœ‰çš„äº‹ä»¶ï¼Œå¹¶ä¸”æœåŠ¡å™¨ç«¯æœ‰å¯èƒ½éœ€è¦ä¸€ç›´ç›‘å¬äº‹ä»¶ï¼Œå› æ­¤æœåŠ¡å™¨ç«¯å¤„ç†äº‹ä»¶çš„ä»£ç ä¸€èˆ¬ä¼šæ”¾åœ¨ä¸€ä¸ªæ­»å¾ªç¯å†…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> selector.select();</span><br><span class="line">    Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">    Iterator&lt;SelectionKey&gt; keyIterator = keys.iterator();</span><br><span class="line">    <span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        keyIterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¥—æ¥å­—-NIO-å®ä¾‹"><a href="#å¥—æ¥å­—-NIO-å®ä¾‹" class="headerlink" title="å¥—æ¥å­— NIO å®ä¾‹"></a>å¥—æ¥å­— NIO å®ä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">ssChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        ssChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        ssChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> ssChannel.socket();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">        serverSocket.bind(address);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; keyIterator = keys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">ServerSocketChannel</span> <span class="variable">ssChannel1</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æœåŠ¡å™¨ä¼šä¸ºæ¯ä¸ªæ–°è¿æ¥åˆ›å»ºä¸€ä¸ª SocketChannel</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">sChannel</span> <span class="operator">=</span> ssChannel1.accept();</span><br><span class="line">                    sChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿™ä¸ªæ–°è¿æ¥ä¸»è¦ç”¨äºä»å®¢æˆ·ç«¯è¯»å–æ•°æ®</span></span><br><span class="line">                    sChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">sChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                    System.out.println(readDataFromSocketChannel(sChannel));</span><br><span class="line">                    sChannel.close();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                keyIterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">readDataFromSocketChannel</span><span class="params">(SocketChannel sChannel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            buffer.clear();</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> sChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (n == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> buffer.limit();</span><br><span class="line">            <span class="type">char</span>[] dst = <span class="keyword">new</span> <span class="title class_">char</span>[limit];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; limit; i++) &#123;</span><br><span class="line">                dst[i] = (<span class="type">char</span>) buffer.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">            data.append(dst);</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">        out.write(s.getBytes());</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…å­˜æ˜ å°„æ–‡ä»¶"><a href="#å†…å­˜æ˜ å°„æ–‡ä»¶" class="headerlink" title="å†…å­˜æ˜ å°„æ–‡ä»¶"></a>å†…å­˜æ˜ å°„æ–‡ä»¶</h3><p>å†…å­˜æ˜ å°„æ–‡ä»¶ I/O æ˜¯ä¸€ç§è¯»å’Œå†™æ–‡ä»¶æ•°æ®çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ¯”å¸¸è§„çš„åŸºäºæµæˆ–è€…åŸºäºé€šé“çš„ I/O å¿«å¾—å¤šã€‚</p><p>å‘å†…å­˜æ˜ å°„æ–‡ä»¶å†™å…¥å¯èƒ½æ˜¯å±é™©çš„ï¼Œåªæ˜¯æ”¹å˜æ•°ç»„çš„å•ä¸ªå…ƒç´ è¿™æ ·çš„ç®€å•æ“ä½œï¼Œå°±å¯èƒ½ä¼šç›´æ¥ä¿®æ”¹ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚ä¿®æ”¹æ•°æ®ä¸å°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜æ˜¯æ²¡æœ‰åˆ†å¼€çš„ã€‚</p><p>ä¸‹é¢ä»£ç è¡Œå°†æ–‡ä»¶çš„å‰ 1024 ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œmap() æ–¹æ³•è¿”å›ä¸€ä¸ª MappedByteBufferï¼Œå®ƒæ˜¯ ByteBuffer çš„å­ç±»ã€‚å› æ­¤ï¼Œå¯ä»¥åƒä½¿ç”¨å…¶ä»–ä»»ä½• ByteBuffer ä¸€æ ·ä½¿ç”¨æ–°æ˜ å°„çš„ç¼“å†²åŒºï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨éœ€è¦æ—¶è´Ÿè´£æ‰§è¡Œæ˜ å°„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MappedByteBuffer</span> <span class="variable">mbb</span> <span class="operator">=</span> fc.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, <span class="number">1024</span>);</span><br></pre></td></tr></table></figure><h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><p>NIO ä¸æ™®é€š I/O çš„åŒºåˆ«ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>NIO æ˜¯éé˜»å¡çš„ï¼›</li><li>NIO é¢å‘å—ï¼ŒI/O é¢å‘æµã€‚</li></ul><h2 id="å…«ã€å‚è€ƒèµ„æ–™"><a href="#å…«ã€å‚è€ƒèµ„æ–™" class="headerlink" title="å…«ã€å‚è€ƒèµ„æ–™"></a>å…«ã€å‚è€ƒèµ„æ–™</h2><ul><li>Eckel B, åŸƒå…‹å°”, æ˜Šé¹, ç­‰. Java ç¼–ç¨‹æ€æƒ³ [M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2002.</li><li><a href="https://www.ibm.com/developerworks/cn/education/java/j-nio/j-nio.html">IBM: NIO å…¥é—¨</a></li><li><a href="http://tutorials.jenkov.com/java-nio/index.html">Java NIO Tutorial</a></li><li><a href="https://tech.meituan.com/nio.html">Java NIO æµ…æ</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/index.html">IBM: æ·±å…¥åˆ†æ Java I/O çš„å·¥ä½œæœºåˆ¶</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/index.html">IBM: æ·±å…¥åˆ†æ Java ä¸­çš„ä¸­æ–‡ç¼–ç é—®é¢˜</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-serial/index.html">IBM: Java åºåˆ—åŒ–çš„é«˜çº§è®¤è¯†</a></li><li><a href="http://blog.csdn.net/shimiso/article/details/24990499">NIO ä¸ä¼ ç»Ÿ IO çš„åŒºåˆ«</a></li><li><a href="http://stg-tud.github.io/sedc/Lecture/ws13-14/5.3-Decorator.html#mode=document">Decorator Design Pattern</a></li><li><a href="http://labojava.blogspot.com/2012/12/socket-multicast.html">Socket Multicast</a></li></ul>]]></content>
    
    
    <summary type="html">å¯¹å­¦ä¹ java IOçš„ä¸€äº›çŸ¥è¯†ç¬”è®°</summary>
    
    
    
    <category term="Java" scheme="https://www.jodio.cc/categories/Java/"/>
    
    
    <category term="java" scheme="https://www.jodio.cc/tags/java/"/>
    
    <category term="NIO" scheme="https://www.jodio.cc/tags/NIO/"/>
    
  </entry>
  
</feed>
